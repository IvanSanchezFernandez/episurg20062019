
# Epilepsy surgery








## 1. Preparation of software for analysis




Install needed packages
```{r}
# install.packages("dplyr")
library(dplyr)

# install.packages("dbplyr")
library(dbplyr)

# install.packages("tidyr")
library(tidyr)

# install.packages("RSQLite")
library(RSQLite)

# install.packages("tibble")
library(tibble)

# install.packages("haven")
library(haven)

# install.packages("lubridate")
library(lubridate)

# install.packages("gmodels")
library(gmodels)

# install.packages("bazar")
library(bazar)

# install.packages("ggplot2")
library(ggplot2)

# install.packages("plotly")
library(plotly)

# install.packages("maps")
library(maps)
```








## 2. Data ingestion




Create the connection to the database
```{r}
# Create the connection to the MarketScan database
MarketScan <- DBI::dbConnect(RSQLite::SQLite(), "E:\\MarketScan\\MarketScan.db")
src_dbi(MarketScan)
```




Create the link to the relevant tables
```{r}
# Year 2006
ms_i_2006 <- tbl(MarketScan, "ms_i_2006")
ms_s_2006 <- tbl(MarketScan, "ms_s_2006")
ms_d_2006 <- tbl(MarketScan, "ms_d_2006")
ms_o_2006 <- tbl(MarketScan, "ms_o_2006")
ms_a_2006 <- tbl(MarketScan, "ms_a_2006")
ms_t_2006 <- tbl(MarketScan, "ms_t_2006")
redbook_2006 <- tbl(MarketScan, "redbook_2006")

# Year 2007
ms_i_2007 <- tbl(MarketScan, "ms_i_2007")
ms_s_2007 <- tbl(MarketScan, "ms_s_2007")
ms_d_2007 <- tbl(MarketScan, "ms_d_2007")
ms_o_2007 <- tbl(MarketScan, "ms_o_2007")
ms_a_2007 <- tbl(MarketScan, "ms_a_2007")
ms_t_2007 <- tbl(MarketScan, "ms_t_2007")
redbook_2007 <- tbl(MarketScan, "redbook_2007")

# Year 2008
ms_i_2008 <- tbl(MarketScan, "ms_i_2008")
ms_s_2008 <- tbl(MarketScan, "ms_s_2008")
ms_d_2008 <- tbl(MarketScan, "ms_d_2008")
ms_o_2008 <- tbl(MarketScan, "ms_o_2008")
ms_a_2008 <- tbl(MarketScan, "ms_a_2008")
ms_t_2008 <- tbl(MarketScan, "ms_t_2008")
redbook_2008 <- tbl(MarketScan, "redbook_2008")

# Year 2009
ms_i_2009 <- tbl(MarketScan, "ms_i_2009")
ms_s_2009 <- tbl(MarketScan, "ms_s_2009")
ms_d_2009 <- tbl(MarketScan, "ms_d_2009")
ms_o_2009 <- tbl(MarketScan, "ms_o_2009")
ms_a_2009 <- tbl(MarketScan, "ms_a_2009")
ms_t_2009 <- tbl(MarketScan, "ms_t_2009")
redbook_2009 <- tbl(MarketScan, "redbook_2009")

# Year 2010
ms_i_2010 <- tbl(MarketScan, "ms_i_2010")
ms_s_2010 <- tbl(MarketScan, "ms_s_2010")
ms_d_2010 <- tbl(MarketScan, "ms_d_2010")
ms_o_2010 <- tbl(MarketScan, "ms_o_2010")
ms_a_2010 <- tbl(MarketScan, "ms_a_2010")
ms_t_2010 <- tbl(MarketScan, "ms_t_2010")
redbook_2010 <- tbl(MarketScan, "redbook_2010")

# Year 2011
ms_i_2011 <- tbl(MarketScan, "ms_i_2011")
ms_s_2011 <- tbl(MarketScan, "ms_s_2011")
ms_d_2011 <- tbl(MarketScan, "ms_d_2011")
ms_o_2011 <- tbl(MarketScan, "ms_o_2011")
ms_a_2011 <- tbl(MarketScan, "ms_a_2011")
ms_t_2011 <- tbl(MarketScan, "ms_t_2011")
redbook_2011 <- tbl(MarketScan, "redbook_2011")

# Year 2012
ms_i_2012 <- tbl(MarketScan, "ms_i_2012")
ms_s_2012 <- tbl(MarketScan, "ms_s_2012")
ms_d_2012 <- tbl(MarketScan, "ms_d_2012")
ms_o_2012 <- tbl(MarketScan, "ms_o_2012")
ms_a_2012 <- tbl(MarketScan, "ms_a_2012")
ms_t_2012 <- tbl(MarketScan, "ms_t_2012")
redbook_2012 <- tbl(MarketScan, "redbook_2012")

# Year 2013
ms_i_2013 <- tbl(MarketScan, "ms_i_2013")
ms_s_2013 <- tbl(MarketScan, "ms_s_2013")
ms_d_2013 <- tbl(MarketScan, "ms_d_2013")
ms_o_2013 <- tbl(MarketScan, "ms_o_2013")
ms_a_2013 <- tbl(MarketScan, "ms_a_2013")
ms_t_2013 <- tbl(MarketScan, "ms_t_2013")
redbook_2013 <- tbl(MarketScan, "redbook_2013")

# Year 2014
ms_i_2014 <- tbl(MarketScan, "ms_i_2014")
ms_s_2014 <- tbl(MarketScan, "ms_s_2014")
ms_d_2014 <- tbl(MarketScan, "ms_d_2014")
ms_o_2014 <- tbl(MarketScan, "ms_o_2014")
ms_a_2014 <- tbl(MarketScan, "ms_a_2014")
ms_t_2014 <- tbl(MarketScan, "ms_t_2014")
redbook_2014 <- tbl(MarketScan, "redbook_2014")

# Year 2015
ms_i_2015 <- tbl(MarketScan, "ms_i_2015")
ms_s_2015 <- tbl(MarketScan, "ms_s_2015")
ms_d_2015 <- tbl(MarketScan, "ms_d_2015")
ms_o_2015 <- tbl(MarketScan, "ms_o_2015")
ms_a_2015 <- tbl(MarketScan, "ms_a_2015")
ms_t_2015 <- tbl(MarketScan, "ms_t_2015")
redbook_2015 <- tbl(MarketScan, "redbook_2015")

# Year 2016
ms_i_2016 <- tbl(MarketScan, "ms_i_2016")
ms_s_2016 <- tbl(MarketScan, "ms_s_2016")
ms_d_2016 <- tbl(MarketScan, "ms_d_2016")
ms_o_2016 <- tbl(MarketScan, "ms_o_2016")
ms_a_2016 <- tbl(MarketScan, "ms_a_2016")
ms_t_2016 <- tbl(MarketScan, "ms_t_2016")
redbook_2016 <- tbl(MarketScan, "redbook_2016")

# Year 2017
ms_i_2017 <- tbl(MarketScan, "ms_i_2017")
ms_s_2017 <- tbl(MarketScan, "ms_s_2017")
ms_d_2017 <- tbl(MarketScan, "ms_d_2017")
ms_o_2017 <- tbl(MarketScan, "ms_o_2017")
ms_a_2017 <- tbl(MarketScan, "ms_a_2017")
ms_t_2017 <- tbl(MarketScan, "ms_t_2017")
redbook_2017 <- tbl(MarketScan, "redbook_2017")

# Year 2018
ms_i_2018 <- tbl(MarketScan, "ms_i_2018")
ms_s_2018 <- tbl(MarketScan, "ms_s_2018")
ms_d_2018 <- tbl(MarketScan, "ms_d_2018")
ms_o_2018 <- tbl(MarketScan, "ms_o_2018")
ms_a_2018 <- tbl(MarketScan, "ms_a_2018")
ms_t_2018 <- tbl(MarketScan, "ms_t_2018")
redbook_2018 <- tbl(MarketScan, "redbook_2018")

# Year 2019
ms_i_2019 <- tbl(MarketScan, "ms_i_2019")
ms_s_2019 <- tbl(MarketScan, "ms_s_2019")
ms_d_2019 <- tbl(MarketScan, "ms_d_2019")
ms_o_2019 <- tbl(MarketScan, "ms_o_2019")
ms_a_2019 <- tbl(MarketScan, "ms_a_2019")
ms_t_2019 <- tbl(MarketScan, "ms_t_2019")
redbook_2019 <- tbl(MarketScan, "redbook_2019")
```








## 3. Identification of patients



Identify patients with epilepsy
```{r}
# Codes for patients with epilepsy
codes_epilepsy_ICD9 <- c("345", "3450", "34500", "34501", "3451", "34510", "34511", "3454", "34540", "34541", "3455", "34550", "34551", "3456", "34560", "34561", "3457", "34570", "34571", "3458", "34580", "34581", "3459", "34590", "34591")

codes_epilepsy_ICD10 <- c("G40", "G400", "G4000", "G40001", "G40009", "G4001", "G40011", "G40019", "G401", "G4010", "G40101", "G40109", "G4011", "G40111", "G40119", "G402", "G4020", "G40201", "G40209", "G4021", "G40211", "G40219", "G403", "G4030", "G40301", "G40309", "G4031", "G40311", "G40319", "G40A", "G40A0", "G40A01", "G40A09", "G40A1", "G40A11", "G40A19", "G40B", "G40B0", "G40B01", "G40B09", "G40B1", "G40B11", "G40B19", "G404", "G4040", "G40401", "G40409", "G4041", "G40411", "G40419", "G408", "G4080", "G40801", "G40802", "G40803", "G40804", "G4081", "G40811", "G40812", "G40813", "G40814", "G4082", "G40821", "G40822", "G40823", "G40824", "G4083", "G40833", "G40834", "G409", "G4090", "G40901", "G40909", "G4091", "G40911", "G40919")


# Patients with epilepsy
#################################2006#################################
epilepsy_2006_i <- ms_i_2006 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2006_o <- ms_o_2006 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2007#################################
epilepsy_2007_i <- ms_i_2007 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2007_o <- ms_o_2007 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2008#################################
epilepsy_2008_i <- ms_i_2008 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2008_o <- ms_o_2008 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2009#################################
epilepsy_2009_i <- ms_i_2009 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2009_o <- ms_o_2009 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2010#################################
epilepsy_2010_i <- ms_i_2010 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2010_o <- ms_o_2010 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2011#################################
epilepsy_2011_i <- ms_i_2011 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2011_o <- ms_o_2011 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2012#################################
epilepsy_2012_i <- ms_i_2012 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2012_o <- ms_o_2012 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2013#################################
epilepsy_2013_i <- ms_i_2013 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2013_o <- ms_o_2013 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2014#################################
epilepsy_2014_i <- ms_i_2014 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2014_o <- ms_o_2014 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2015#################################
epilepsy_2015_i <- ms_i_2015 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9 |
                                      DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
                                      DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
                                      DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
                                      DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
                                      DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
                                      DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
                                      DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
                                      DX15 %in% codes_epilepsy_ICD10
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2015_o <- ms_o_2015 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2016#################################
epilepsy_2016_i <- ms_i_2016 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
                                      DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
                                      DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
                                      DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
                                      DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
                                      DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
                                      DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
                                      DX15 %in% codes_epilepsy_ICD10
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2016_o <- ms_o_2016 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2017#################################
epilepsy_2017_i <- ms_i_2017 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
                                      DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
                                      DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
                                      DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
                                      DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
                                      DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
                                      DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
                                      DX15 %in% codes_epilepsy_ICD10
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2017_o <- ms_o_2017 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>%
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2018#################################
epilepsy_2018_i <- ms_i_2018 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
                                      DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
                                      DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
                                      DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
                                      DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
                                      DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
                                      DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
                                      DX15 %in% codes_epilepsy_ICD10
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2018_o <- ms_o_2018 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2019#################################
epilepsy_2019_i <- ms_i_2019 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
                                      DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
                                      DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
                                      DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
                                      DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
                                      DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
                                      DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
                                      DX15 %in% codes_epilepsy_ICD10
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2019_o <- ms_o_2019 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


# Epilepsy (at least 2 different codes for epilepsy separated by at least 180 days)
epilepsy <- bind_rows(epilepsy_2006_i, epilepsy_2006_o, epilepsy_2007_i, epilepsy_2007_o, epilepsy_2008_i, epilepsy_2008_o, epilepsy_2009_i, epilepsy_2009_o, epilepsy_2010_i, epilepsy_2010_o, epilepsy_2011_i, epilepsy_2011_o, epilepsy_2012_i, epilepsy_2012_o, epilepsy_2013_i, epilepsy_2013_o, epilepsy_2014_i, epilepsy_2014_o, epilepsy_2015_i, epilepsy_2015_o, epilepsy_2016_i, epilepsy_2016_o, epilepsy_2017_i, epilepsy_2017_o, epilepsy_2018_i, epilepsy_2018_o, epilepsy_2019_i, epilepsy_2019_o) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  mutate(maximum_days_between_epilepsy_diagnoses=max(SVCDATE)-min(SVCDATE)) %>% 
  filter(maximum_days_between_epilepsy_diagnoses>180)

epilepsy_n <- epilepsy %>% distinct(ENROLID) %>% nrow()
epilepsy_n

epilepsy_first_diagnosis <- epilepsy %>% arrange(ENROLID, SVCDATE) %>% distinct(ENROLID, .keep_all=TRUE) %>% select(ENROLID, SVCDATE) %>% rename(first_diagnosis_epilepsy=SVCDATE)
```




Identify patients with focal epilepsy
```{r}
# Codes for patients with focal epilepsy
codes_focal_epilepsy_ICD9 <- c("3454", "34540", "34541", "3455", "34550", "34551", "3457", "34570", "34571")

codes_focal_epilepsy_ICD10 <- c("G400", "G4000", "G40001", "G40009", "G4001", "G40011", "G40019", "G401", "G4010", "G40101", "G40109", "G4011", "G40111", "G40119", "G402", "G4020", "G40201", "G40209", "G4021", "G40211", "G40219")


# Patients with focal epilepsy
#################################2006#################################
focal_epilepsy_2006_i <- ms_i_2006 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_focal_epilepsy_ICD9 |
                                      DX3 %in% codes_focal_epilepsy_ICD9 | 
                                      DX4 %in% codes_focal_epilepsy_ICD9 |
                                      DX5 %in% codes_focal_epilepsy_ICD9 | 
                                      DX6 %in% codes_focal_epilepsy_ICD9 |
                                      DX7 %in% codes_focal_epilepsy_ICD9 | 
                                      DX8 %in% codes_focal_epilepsy_ICD9 |
                                      DX9 %in% codes_focal_epilepsy_ICD9 | 
                                      DX10 %in% codes_focal_epilepsy_ICD9 |
                                      DX11%in% codes_focal_epilepsy_ICD9 | 
                                      DX12 %in% codes_focal_epilepsy_ICD9 |
                                      DX13 %in% codes_focal_epilepsy_ICD9 | 
                                      DX14 %in% codes_focal_epilepsy_ICD9 |
                                      DX15 %in% codes_focal_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

focal_epilepsy_2006_o <- ms_o_2006 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_focal_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2007#################################
focal_epilepsy_2007_i <- ms_i_2007 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_focal_epilepsy_ICD9 |
                                      DX3 %in% codes_focal_epilepsy_ICD9 | 
                                      DX4 %in% codes_focal_epilepsy_ICD9 |
                                      DX5 %in% codes_focal_epilepsy_ICD9 | 
                                      DX6 %in% codes_focal_epilepsy_ICD9 |
                                      DX7 %in% codes_focal_epilepsy_ICD9 | 
                                      DX8 %in% codes_focal_epilepsy_ICD9 |
                                      DX9 %in% codes_focal_epilepsy_ICD9 | 
                                      DX10 %in% codes_focal_epilepsy_ICD9 |
                                      DX11%in% codes_focal_epilepsy_ICD9 | 
                                      DX12 %in% codes_focal_epilepsy_ICD9 |
                                      DX13 %in% codes_focal_epilepsy_ICD9 | 
                                      DX14 %in% codes_focal_epilepsy_ICD9 |
                                      DX15 %in% codes_focal_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

focal_epilepsy_2007_o <- ms_o_2007 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_focal_epilepsy_ICD9 | 
                                     DX2 %in% codes_focal_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2008#################################
focal_epilepsy_2008_i <- ms_i_2008 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_focal_epilepsy_ICD9 |
                                      DX3 %in% codes_focal_epilepsy_ICD9 | 
                                      DX4 %in% codes_focal_epilepsy_ICD9 |
                                      DX5 %in% codes_focal_epilepsy_ICD9 | 
                                      DX6 %in% codes_focal_epilepsy_ICD9 |
                                      DX7 %in% codes_focal_epilepsy_ICD9 | 
                                      DX8 %in% codes_focal_epilepsy_ICD9 |
                                      DX9 %in% codes_focal_epilepsy_ICD9 | 
                                      DX10 %in% codes_focal_epilepsy_ICD9 |
                                      DX11%in% codes_focal_epilepsy_ICD9 | 
                                      DX12 %in% codes_focal_epilepsy_ICD9 |
                                      DX13 %in% codes_focal_epilepsy_ICD9 | 
                                      DX14 %in% codes_focal_epilepsy_ICD9 |
                                      DX15 %in% codes_focal_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

focal_epilepsy_2008_o <- ms_o_2008 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_focal_epilepsy_ICD9 | 
                                     DX2 %in% codes_focal_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2009#################################
focal_epilepsy_2009_i <- ms_i_2009 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_focal_epilepsy_ICD9 |
                                      DX3 %in% codes_focal_epilepsy_ICD9 | 
                                      DX4 %in% codes_focal_epilepsy_ICD9 |
                                      DX5 %in% codes_focal_epilepsy_ICD9 | 
                                      DX6 %in% codes_focal_epilepsy_ICD9 |
                                      DX7 %in% codes_focal_epilepsy_ICD9 | 
                                      DX8 %in% codes_focal_epilepsy_ICD9 |
                                      DX9 %in% codes_focal_epilepsy_ICD9 |
                                      DX10 %in% codes_focal_epilepsy_ICD9 |
                                      DX11%in% codes_focal_epilepsy_ICD9 | 
                                      DX12 %in% codes_focal_epilepsy_ICD9 |
                                      DX13 %in% codes_focal_epilepsy_ICD9 | 
                                      DX14 %in% codes_focal_epilepsy_ICD9 |
                                      DX15 %in% codes_focal_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

focal_epilepsy_2009_o <- ms_o_2009 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_focal_epilepsy_ICD9 | 
                                     DX2 %in% codes_focal_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2010#################################
focal_epilepsy_2010_i <- ms_i_2010 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_focal_epilepsy_ICD9 |
                                      DX3 %in% codes_focal_epilepsy_ICD9 | 
                                      DX4 %in% codes_focal_epilepsy_ICD9 |
                                      DX5 %in% codes_focal_epilepsy_ICD9 | 
                                      DX6 %in% codes_focal_epilepsy_ICD9 |
                                      DX7 %in% codes_focal_epilepsy_ICD9 | 
                                      DX8 %in% codes_focal_epilepsy_ICD9 |
                                      DX9 %in% codes_focal_epilepsy_ICD9 | 
                                      DX10 %in% codes_focal_epilepsy_ICD9 |
                                      DX11%in% codes_focal_epilepsy_ICD9 | 
                                      DX12 %in% codes_focal_epilepsy_ICD9 |
                                      DX13 %in% codes_focal_epilepsy_ICD9 | 
                                      DX14 %in% codes_focal_epilepsy_ICD9 |
                                      DX15 %in% codes_focal_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

focal_epilepsy_2010_o <- ms_o_2010 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_focal_epilepsy_ICD9 | 
                                     DX2 %in% codes_focal_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2011#################################
focal_epilepsy_2011_i <- ms_i_2011 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_focal_epilepsy_ICD9 |
                                      DX3 %in% codes_focal_epilepsy_ICD9 | 
                                      DX4 %in% codes_focal_epilepsy_ICD9 |
                                      DX5 %in% codes_focal_epilepsy_ICD9 | 
                                      DX6 %in% codes_focal_epilepsy_ICD9 |
                                      DX7 %in% codes_focal_epilepsy_ICD9 | 
                                      DX8 %in% codes_focal_epilepsy_ICD9 |
                                      DX9 %in% codes_focal_epilepsy_ICD9 | 
                                      DX10 %in% codes_focal_epilepsy_ICD9 |
                                      DX11%in% codes_focal_epilepsy_ICD9 | 
                                      DX12 %in% codes_focal_epilepsy_ICD9 |
                                      DX13 %in% codes_focal_epilepsy_ICD9 | 
                                      DX14 %in% codes_focal_epilepsy_ICD9 |
                                      DX15 %in% codes_focal_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

focal_epilepsy_2011_o <- ms_o_2011 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_focal_epilepsy_ICD9 | 
                                     DX2 %in% codes_focal_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2012#################################
focal_epilepsy_2012_i <- ms_i_2012 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_focal_epilepsy_ICD9 |
                                      DX3 %in% codes_focal_epilepsy_ICD9 | 
                                      DX4 %in% codes_focal_epilepsy_ICD9 |
                                      DX5 %in% codes_focal_epilepsy_ICD9 | 
                                      DX6 %in% codes_focal_epilepsy_ICD9 |
                                      DX7 %in% codes_focal_epilepsy_ICD9 |
                                      DX8 %in% codes_focal_epilepsy_ICD9 |
                                      DX9 %in% codes_focal_epilepsy_ICD9 | 
                                      DX10 %in% codes_focal_epilepsy_ICD9 |
                                      DX11%in% codes_focal_epilepsy_ICD9 | 
                                      DX12 %in% codes_focal_epilepsy_ICD9 |
                                      DX13 %in% codes_focal_epilepsy_ICD9 | 
                                      DX14 %in% codes_focal_epilepsy_ICD9 |
                                      DX15 %in% codes_focal_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

focal_epilepsy_2012_o <- ms_o_2012 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_focal_epilepsy_ICD9 | 
                                     DX2 %in% codes_focal_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2013#################################
focal_epilepsy_2013_i <- ms_i_2013 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_focal_epilepsy_ICD9 |
                                      DX3 %in% codes_focal_epilepsy_ICD9 | 
                                      DX4 %in% codes_focal_epilepsy_ICD9 |
                                      DX5 %in% codes_focal_epilepsy_ICD9 | 
                                      DX6 %in% codes_focal_epilepsy_ICD9 |
                                      DX7 %in% codes_focal_epilepsy_ICD9 | 
                                      DX8 %in% codes_focal_epilepsy_ICD9 |
                                      DX9 %in% codes_focal_epilepsy_ICD9 | 
                                      DX10 %in% codes_focal_epilepsy_ICD9 |
                                      DX11%in% codes_focal_epilepsy_ICD9 | 
                                      DX12 %in% codes_focal_epilepsy_ICD9 |
                                      DX13 %in% codes_focal_epilepsy_ICD9 | 
                                      DX14 %in% codes_focal_epilepsy_ICD9 |
                                      DX15 %in% codes_focal_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

focal_epilepsy_2013_o <- ms_o_2013 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_focal_epilepsy_ICD9 | 
                                     DX2 %in% codes_focal_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2014#################################
focal_epilepsy_2014_i <- ms_i_2014 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_focal_epilepsy_ICD9 |
                                      DX3 %in% codes_focal_epilepsy_ICD9 | 
                                      DX4 %in% codes_focal_epilepsy_ICD9 |
                                      DX5 %in% codes_focal_epilepsy_ICD9 | 
                                      DX6 %in% codes_focal_epilepsy_ICD9 |
                                      DX7 %in% codes_focal_epilepsy_ICD9 | 
                                      DX8 %in% codes_focal_epilepsy_ICD9 |
                                      DX9 %in% codes_focal_epilepsy_ICD9 | 
                                      DX10 %in% codes_focal_epilepsy_ICD9 |
                                      DX11%in% codes_focal_epilepsy_ICD9 | 
                                      DX12 %in% codes_focal_epilepsy_ICD9 |
                                      DX13 %in% codes_focal_epilepsy_ICD9 | 
                                      DX14 %in% codes_focal_epilepsy_ICD9 |
                                      DX15 %in% codes_focal_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

focal_epilepsy_2014_o <- ms_o_2014 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_focal_epilepsy_ICD9 | 
                                     DX2 %in% codes_focal_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2015#################################
focal_epilepsy_2015_i <- ms_i_2015 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_focal_epilepsy_ICD9 |
                                      DX3 %in% codes_focal_epilepsy_ICD9 | 
                                      DX4 %in% codes_focal_epilepsy_ICD9 |
                                      DX5 %in% codes_focal_epilepsy_ICD9 | 
                                      DX6 %in% codes_focal_epilepsy_ICD9 |
                                      DX7 %in% codes_focal_epilepsy_ICD9 | 
                                      DX8 %in% codes_focal_epilepsy_ICD9 |
                                      DX9 %in% codes_focal_epilepsy_ICD9 | 
                                      DX10 %in% codes_focal_epilepsy_ICD9 |
                                      DX11%in% codes_focal_epilepsy_ICD9 | 
                                      DX12 %in% codes_focal_epilepsy_ICD9 |
                                      DX13 %in% codes_focal_epilepsy_ICD9 | 
                                      DX14 %in% codes_focal_epilepsy_ICD9 |
                                      DX15 %in% codes_focal_epilepsy_ICD9 |
                                      DX1 %in% codes_focal_epilepsy_ICD10 | 
                                      DX2 %in% codes_focal_epilepsy_ICD10 |
                                      DX3 %in% codes_focal_epilepsy_ICD10 | 
                                      DX4 %in% codes_focal_epilepsy_ICD10 |
                                      DX5 %in% codes_focal_epilepsy_ICD10 | 
                                      DX6 %in% codes_focal_epilepsy_ICD10 |
                                      DX7 %in% codes_focal_epilepsy_ICD10 | 
                                      DX8 %in% codes_focal_epilepsy_ICD10 |
                                      DX9 %in% codes_focal_epilepsy_ICD10 | 
                                      DX10 %in% codes_focal_epilepsy_ICD10 |
                                      DX11%in% codes_focal_epilepsy_ICD10 | 
                                      DX12 %in% codes_focal_epilepsy_ICD10 |
                                      DX13 %in% codes_focal_epilepsy_ICD10 | 
                                      DX14 %in% codes_focal_epilepsy_ICD10 |
                                      DX15 %in% codes_focal_epilepsy_ICD10
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

focal_epilepsy_2015_o <- ms_o_2015 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_focal_epilepsy_ICD9 | 
                                     DX2 %in% codes_focal_epilepsy_ICD9 |
                                     DX1 %in% codes_focal_epilepsy_ICD10 | 
                                     DX2 %in% codes_focal_epilepsy_ICD10
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2016#################################
focal_epilepsy_2016_i <- ms_i_2016 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_focal_epilepsy_ICD10 | 
                                      DX2 %in% codes_focal_epilepsy_ICD10 |
                                      DX3 %in% codes_focal_epilepsy_ICD10 | 
                                      DX4 %in% codes_focal_epilepsy_ICD10 |
                                      DX5 %in% codes_focal_epilepsy_ICD10 | 
                                      DX6 %in% codes_focal_epilepsy_ICD10 |
                                      DX7 %in% codes_focal_epilepsy_ICD10 | 
                                      DX8 %in% codes_focal_epilepsy_ICD10 |
                                      DX9 %in% codes_focal_epilepsy_ICD10 | 
                                      DX10 %in% codes_focal_epilepsy_ICD10 |
                                      DX11%in% codes_focal_epilepsy_ICD10 | 
                                      DX12 %in% codes_focal_epilepsy_ICD10 |
                                      DX13 %in% codes_focal_epilepsy_ICD10 | 
                                      DX14 %in% codes_focal_epilepsy_ICD10 |
                                      DX15 %in% codes_focal_epilepsy_ICD10
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

focal_epilepsy_2016_o <- ms_o_2016 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_focal_epilepsy_ICD10 | 
                                     DX2 %in% codes_focal_epilepsy_ICD10
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2017#################################
focal_epilepsy_2017_i <- ms_i_2017 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_focal_epilepsy_ICD10 | 
                                      DX2 %in% codes_focal_epilepsy_ICD10 |
                                      DX3 %in% codes_focal_epilepsy_ICD10 | 
                                      DX4 %in% codes_focal_epilepsy_ICD10 |
                                      DX5 %in% codes_focal_epilepsy_ICD10 | 
                                      DX6 %in% codes_focal_epilepsy_ICD10 |
                                      DX7 %in% codes_focal_epilepsy_ICD10 | 
                                      DX8 %in% codes_focal_epilepsy_ICD10 |
                                      DX9 %in% codes_focal_epilepsy_ICD10 | 
                                      DX10 %in% codes_focal_epilepsy_ICD10 |
                                      DX11%in% codes_focal_epilepsy_ICD10 | 
                                      DX12 %in% codes_focal_epilepsy_ICD10 |
                                      DX13 %in% codes_focal_epilepsy_ICD10 | 
                                      DX14 %in% codes_focal_epilepsy_ICD10 |
                                      DX15 %in% codes_focal_epilepsy_ICD10
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

focal_epilepsy_2017_o <- ms_o_2017 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_focal_epilepsy_ICD10 | 
                                     DX2 %in% codes_focal_epilepsy_ICD10
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>%
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2018#################################
focal_epilepsy_2018_i <- ms_i_2018 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_focal_epilepsy_ICD10 | 
                                      DX2 %in% codes_focal_epilepsy_ICD10 |
                                      DX3 %in% codes_focal_epilepsy_ICD10 | 
                                      DX4 %in% codes_focal_epilepsy_ICD10 |
                                      DX5 %in% codes_focal_epilepsy_ICD10 | 
                                      DX6 %in% codes_focal_epilepsy_ICD10 |
                                      DX7 %in% codes_focal_epilepsy_ICD10 | 
                                      DX8 %in% codes_focal_epilepsy_ICD10 |
                                      DX9 %in% codes_focal_epilepsy_ICD10 | 
                                      DX10 %in% codes_focal_epilepsy_ICD10 |
                                      DX11%in% codes_focal_epilepsy_ICD10 | 
                                      DX12 %in% codes_focal_epilepsy_ICD10 |
                                      DX13 %in% codes_focal_epilepsy_ICD10 | 
                                      DX14 %in% codes_focal_epilepsy_ICD10 |
                                      DX15 %in% codes_focal_epilepsy_ICD10
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

focal_epilepsy_2018_o <- ms_o_2018 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_focal_epilepsy_ICD10 | 
                                     DX2 %in% codes_focal_epilepsy_ICD10
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2019#################################
focal_epilepsy_2019_i <- ms_i_2019 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_focal_epilepsy_ICD10 | 
                                      DX2 %in% codes_focal_epilepsy_ICD10 |
                                      DX3 %in% codes_focal_epilepsy_ICD10 | 
                                      DX4 %in% codes_focal_epilepsy_ICD10 |
                                      DX5 %in% codes_focal_epilepsy_ICD10 | 
                                      DX6 %in% codes_focal_epilepsy_ICD10 |
                                      DX7 %in% codes_focal_epilepsy_ICD10 | 
                                      DX8 %in% codes_focal_epilepsy_ICD10 |
                                      DX9 %in% codes_focal_epilepsy_ICD10 | 
                                      DX10 %in% codes_focal_epilepsy_ICD10 |
                                      DX11%in% codes_focal_epilepsy_ICD10 | 
                                      DX12 %in% codes_focal_epilepsy_ICD10 |
                                      DX13 %in% codes_focal_epilepsy_ICD10 | 
                                      DX14 %in% codes_focal_epilepsy_ICD10 |
                                      DX15 %in% codes_focal_epilepsy_ICD10
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

focal_epilepsy_2019_o <- ms_o_2019 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_focal_epilepsy_ICD10 | 
                                     DX2 %in% codes_focal_epilepsy_ICD10
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


# Focal epilepsy (at least 2 different codes for focal epilepsy separated by at least 180 days)
focal_epilepsy <- bind_rows(focal_epilepsy_2006_i, focal_epilepsy_2006_o, focal_epilepsy_2007_i, focal_epilepsy_2007_o, focal_epilepsy_2008_i, focal_epilepsy_2008_o, focal_epilepsy_2009_i, focal_epilepsy_2009_o, focal_epilepsy_2010_i, focal_epilepsy_2010_o, focal_epilepsy_2011_i, focal_epilepsy_2011_o, focal_epilepsy_2012_i, focal_epilepsy_2012_o, focal_epilepsy_2013_i, focal_epilepsy_2013_o, focal_epilepsy_2014_i, focal_epilepsy_2014_o, focal_epilepsy_2015_i, focal_epilepsy_2015_o, focal_epilepsy_2016_i, focal_epilepsy_2016_o, focal_epilepsy_2017_i, focal_epilepsy_2017_o, focal_epilepsy_2018_i, focal_epilepsy_2018_o, focal_epilepsy_2019_i, focal_epilepsy_2019_o) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  mutate(maximum_days_between_focal_epilepsy_diagnoses=max(SVCDATE)-min(SVCDATE)) %>% 
  filter(maximum_days_between_focal_epilepsy_diagnoses>180)

focal_epilepsy_n <- focal_epilepsy %>% distinct(ENROLID) %>% nrow()
focal_epilepsy_n
```




Identify patients with refractory epilepsy
```{r}

# Codes for patients with refractory epilepsy
codes_refractory_epilepsy_ICD9 <- c("34501", "34511", "34541", "34551", "34561", "34571", "34581", "34591")

codes_refractory_epilepsy_ICD10 <- c("G4001", "G40011", "G40019", "G4011", "G40.111", "G40119", "G4021", "G40211", "G40219", "G4031", "G40311", "G40319", "G40A1", "G40A11", "G40A19", "G40B1", "G40B11", "G40B19", "G4041", "G40411", "G40419", "G40803", "G40804", "G40813", "G40814", "G40823", "G40824", "G40833", "G40834", "G4091", "G40911", "G40919")


# Patients with refractory epilepsy
#################################2006#################################
refractory_epilepsy_2006_i <- ms_i_2006 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX4 %in% codes_refractory_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX6 %in% codes_refractory_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX8 %in% codes_refractory_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX10 %in% codes_refractory_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_epilepsy_ICD9 | 
                                      DX12 %in% codes_refractory_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX14 %in% codes_refractory_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2006_o <- ms_o_2006 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2007#################################
refractory_epilepsy_2007_i <- ms_i_2007 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX4 %in% codes_refractory_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX6 %in% codes_refractory_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX8 %in% codes_refractory_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX10 %in% codes_refractory_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_epilepsy_ICD9 | 
                                      DX12 %in% codes_refractory_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX14 %in% codes_refractory_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2007_o <- ms_o_2007 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | 
                                     DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2008#################################
refractory_epilepsy_2008_i <- ms_i_2008 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX4 %in% codes_refractory_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX6 %in% codes_refractory_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX8 %in% codes_refractory_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX10 %in% codes_refractory_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_epilepsy_ICD9 | 
                                      DX12 %in% codes_refractory_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX14 %in% codes_refractory_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2008_o <- ms_o_2008 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | 
                                     DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2009#################################
refractory_epilepsy_2009_i <- ms_i_2009 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX4 %in% codes_refractory_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX6 %in% codes_refractory_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX8 %in% codes_refractory_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_epilepsy_ICD9 |
                                      DX10 %in% codes_refractory_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_epilepsy_ICD9 | 
                                      DX12 %in% codes_refractory_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX14 %in% codes_refractory_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2009_o <- ms_o_2009 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | 
                                     DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2010#################################
refractory_epilepsy_2010_i <- ms_i_2010 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX4 %in% codes_refractory_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX6 %in% codes_refractory_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX8 %in% codes_refractory_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX10 %in% codes_refractory_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_epilepsy_ICD9 | 
                                      DX12 %in% codes_refractory_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX14 %in% codes_refractory_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2010_o <- ms_o_2010 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | 
                                     DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2011#################################
refractory_epilepsy_2011_i <- ms_i_2011 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX4 %in% codes_refractory_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX6 %in% codes_refractory_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX8 %in% codes_refractory_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX10 %in% codes_refractory_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_epilepsy_ICD9 | 
                                      DX12 %in% codes_refractory_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX14 %in% codes_refractory_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2011_o <- ms_o_2011 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | 
                                     DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2012#################################
refractory_epilepsy_2012_i <- ms_i_2012 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX4 %in% codes_refractory_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX6 %in% codes_refractory_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_epilepsy_ICD9 |
                                      DX8 %in% codes_refractory_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX10 %in% codes_refractory_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_epilepsy_ICD9 | 
                                      DX12 %in% codes_refractory_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX14 %in% codes_refractory_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2012_o <- ms_o_2012 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | 
                                     DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2013#################################
refractory_epilepsy_2013_i <- ms_i_2013 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX4 %in% codes_refractory_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX6 %in% codes_refractory_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX8 %in% codes_refractory_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX10 %in% codes_refractory_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_epilepsy_ICD9 | 
                                      DX12 %in% codes_refractory_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX14 %in% codes_refractory_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2013_o <- ms_o_2013 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | 
                                     DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2014#################################
refractory_epilepsy_2014_i <- ms_i_2014 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX4 %in% codes_refractory_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX6 %in% codes_refractory_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX8 %in% codes_refractory_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX10 %in% codes_refractory_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_epilepsy_ICD9 | 
                                      DX12 %in% codes_refractory_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX14 %in% codes_refractory_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2014_o <- ms_o_2014 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | 
                                     DX2 %in% codes_refractory_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2015#################################
refractory_epilepsy_2015_i <- ms_i_2015 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX4 %in% codes_refractory_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX6 %in% codes_refractory_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX8 %in% codes_refractory_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX10 %in% codes_refractory_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_epilepsy_ICD9 | 
                                      DX12 %in% codes_refractory_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_epilepsy_ICD9 | 
                                      DX14 %in% codes_refractory_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_epilepsy_ICD9 |
                                      DX1 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX2 %in% codes_refractory_epilepsy_ICD10 |
                                      DX3 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX4 %in% codes_refractory_epilepsy_ICD10 |
                                      DX5 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX6 %in% codes_refractory_epilepsy_ICD10 |
                                      DX7 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX8 %in% codes_refractory_epilepsy_ICD10 |
                                      DX9 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX10 %in% codes_refractory_epilepsy_ICD10 |
                                      DX11%in% codes_refractory_epilepsy_ICD10 | 
                                      DX12 %in% codes_refractory_epilepsy_ICD10 |
                                      DX13 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX14 %in% codes_refractory_epilepsy_ICD10 |
                                      DX15 %in% codes_refractory_epilepsy_ICD10
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2015_o <- ms_o_2015 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD9 | 
                                     DX2 %in% codes_refractory_epilepsy_ICD9 |
                                     DX1 %in% codes_refractory_epilepsy_ICD10 | 
                                     DX2 %in% codes_refractory_epilepsy_ICD10
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2016#################################
refractory_epilepsy_2016_i <- ms_i_2016 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX2 %in% codes_refractory_epilepsy_ICD10 |
                                      DX3 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX4 %in% codes_refractory_epilepsy_ICD10 |
                                      DX5 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX6 %in% codes_refractory_epilepsy_ICD10 |
                                      DX7 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX8 %in% codes_refractory_epilepsy_ICD10 |
                                      DX9 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX10 %in% codes_refractory_epilepsy_ICD10 |
                                      DX11%in% codes_refractory_epilepsy_ICD10 | 
                                      DX12 %in% codes_refractory_epilepsy_ICD10 |
                                      DX13 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX14 %in% codes_refractory_epilepsy_ICD10 |
                                      DX15 %in% codes_refractory_epilepsy_ICD10
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2016_o <- ms_o_2016 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD10 | 
                                     DX2 %in% codes_refractory_epilepsy_ICD10
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2017#################################
refractory_epilepsy_2017_i <- ms_i_2017 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX2 %in% codes_refractory_epilepsy_ICD10 |
                                      DX3 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX4 %in% codes_refractory_epilepsy_ICD10 |
                                      DX5 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX6 %in% codes_refractory_epilepsy_ICD10 |
                                      DX7 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX8 %in% codes_refractory_epilepsy_ICD10 |
                                      DX9 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX10 %in% codes_refractory_epilepsy_ICD10 |
                                      DX11%in% codes_refractory_epilepsy_ICD10 | 
                                      DX12 %in% codes_refractory_epilepsy_ICD10 |
                                      DX13 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX14 %in% codes_refractory_epilepsy_ICD10 |
                                      DX15 %in% codes_refractory_epilepsy_ICD10
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2017_o <- ms_o_2017 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD10 | 
                                     DX2 %in% codes_refractory_epilepsy_ICD10
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>%
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2018#################################
refractory_epilepsy_2018_i <- ms_i_2018 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX2 %in% codes_refractory_epilepsy_ICD10 |
                                      DX3 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX4 %in% codes_refractory_epilepsy_ICD10 |
                                      DX5 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX6 %in% codes_refractory_epilepsy_ICD10 |
                                      DX7 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX8 %in% codes_refractory_epilepsy_ICD10 |
                                      DX9 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX10 %in% codes_refractory_epilepsy_ICD10 |
                                      DX11%in% codes_refractory_epilepsy_ICD10 | 
                                      DX12 %in% codes_refractory_epilepsy_ICD10 |
                                      DX13 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX14 %in% codes_refractory_epilepsy_ICD10 |
                                      DX15 %in% codes_refractory_epilepsy_ICD10
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2018_o <- ms_o_2018 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD10 | 
                                     DX2 %in% codes_refractory_epilepsy_ICD10
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2019#################################
refractory_epilepsy_2019_i <- ms_i_2019 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX2 %in% codes_refractory_epilepsy_ICD10 |
                                      DX3 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX4 %in% codes_refractory_epilepsy_ICD10 |
                                      DX5 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX6 %in% codes_refractory_epilepsy_ICD10 |
                                      DX7 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX8 %in% codes_refractory_epilepsy_ICD10 |
                                      DX9 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX10 %in% codes_refractory_epilepsy_ICD10 |
                                      DX11%in% codes_refractory_epilepsy_ICD10 | 
                                      DX12 %in% codes_refractory_epilepsy_ICD10 |
                                      DX13 %in% codes_refractory_epilepsy_ICD10 | 
                                      DX14 %in% codes_refractory_epilepsy_ICD10 |
                                      DX15 %in% codes_refractory_epilepsy_ICD10
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_epilepsy_2019_o <- ms_o_2019 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_epilepsy_ICD10 | 
                                     DX2 %in% codes_refractory_epilepsy_ICD10
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


# Refractory epilepsy (at least 2 different codes for refractory epilepsy separated by at least 180 days)
refractory_epilepsy <- bind_rows(refractory_epilepsy_2006_i, refractory_epilepsy_2006_o, refractory_epilepsy_2007_i, refractory_epilepsy_2007_o, refractory_epilepsy_2008_i, refractory_epilepsy_2008_o, refractory_epilepsy_2009_i, refractory_epilepsy_2009_o, refractory_epilepsy_2010_i, refractory_epilepsy_2010_o, refractory_epilepsy_2011_i, refractory_epilepsy_2011_o, refractory_epilepsy_2012_i, refractory_epilepsy_2012_o,  refractory_epilepsy_2013_i, refractory_epilepsy_2013_o, refractory_epilepsy_2014_i, refractory_epilepsy_2014_o, refractory_epilepsy_2015_i, refractory_epilepsy_2015_o, refractory_epilepsy_2016_i, refractory_epilepsy_2016_o, refractory_epilepsy_2017_i, refractory_epilepsy_2017_o, refractory_epilepsy_2018_i, refractory_epilepsy_2018_o, refractory_epilepsy_2019_i, refractory_epilepsy_2019_o) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  mutate(maximum_days_between_refractory_epilepsy_diagnoses=max(SVCDATE)-min(SVCDATE)) %>% 
  filter(maximum_days_between_refractory_epilepsy_diagnoses>180)

refractory_epilepsy_n <- refractory_epilepsy %>% distinct(ENROLID) %>% nrow()
refractory_epilepsy_n
```




Identify patients with refractory focal epilepsy
```{r}
# Codes for patients with refractory focal epilepsy
codes_refractory_focal_epilepsy_ICD9 <- c("34541", "34551", "34571")

codes_refractory_focal_epilepsy_ICD10 <- c("G4001", "G40011", "G40019", "G4011", "G40111", "G40119", "G4021", "G40211", "G40219")
  

# Patients with refractory focal epilepsy
#################################2006#################################
refractory_focal_epilepsy_2006_i <- ms_i_2006 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX4 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX6 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX8 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX10 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX12 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX14 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_focal_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_focal_epilepsy_2006_o <- ms_o_2006 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_focal_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2007#################################
refractory_focal_epilepsy_2007_i <- ms_i_2007 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX4 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX6 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX8 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX10 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX12 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX14 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_focal_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_focal_epilepsy_2007_o <- ms_o_2007 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                     DX2 %in% codes_refractory_focal_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2008#################################
refractory_focal_epilepsy_2008_i <- ms_i_2008 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX4 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX6 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX8 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX10 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX12 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX14 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_focal_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_focal_epilepsy_2008_o <- ms_o_2008 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                     DX2 %in% codes_refractory_focal_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2009#################################
refractory_focal_epilepsy_2009_i <- ms_i_2009 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX4 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX6 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX8 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX10 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX12 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX14 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_focal_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_focal_epilepsy_2009_o <- ms_o_2009 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                     DX2 %in% codes_refractory_focal_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2010#################################
refractory_focal_epilepsy_2010_i <- ms_i_2010 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX4 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX6 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX8 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX10 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX12 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX14 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_focal_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_focal_epilepsy_2010_o <- ms_o_2010 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                     DX2 %in% codes_refractory_focal_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2011#################################
refractory_focal_epilepsy_2011_i <- ms_i_2011 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX4 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX6 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX8 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX10 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX12 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX14 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_focal_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_focal_epilepsy_2011_o <- ms_o_2011 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                     DX2 %in% codes_refractory_focal_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2012#################################
refractory_focal_epilepsy_2012_i <- ms_i_2012 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX4 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX6 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX8 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX10 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX12 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX14 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_focal_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_focal_epilepsy_2012_o <- ms_o_2012 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                     DX2 %in% codes_refractory_focal_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2013#################################
refractory_focal_epilepsy_2013_i <- ms_i_2013 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX4 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX6 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX8 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX10 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX12 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX14 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_focal_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_focal_epilepsy_2013_o <- ms_o_2013 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                     DX2 %in% codes_refractory_focal_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2014#################################
refractory_focal_epilepsy_2014_i <- ms_i_2014 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX4 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX6 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX8 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX10 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX12 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX14 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_focal_epilepsy_ICD9
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_focal_epilepsy_2014_o <- ms_o_2014 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                     DX2 %in% codes_refractory_focal_epilepsy_ICD9
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2015#################################
refractory_focal_epilepsy_2015_i <- ms_i_2015 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX2 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX3 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX4 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX5 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX6 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX7 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX8 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX9 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX10 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX11%in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX12 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX13 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                      DX14 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX15 %in% codes_refractory_focal_epilepsy_ICD9 |
                                      DX1 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX2 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX3 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX4 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX5 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX6 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX7 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX8 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX9 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX10 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX11%in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX12 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX13 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX14 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX15 %in% codes_refractory_focal_epilepsy_ICD10
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_focal_epilepsy_2015_o <- ms_o_2015 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_focal_epilepsy_ICD9 | 
                                     DX2 %in% codes_refractory_focal_epilepsy_ICD9 |
                                     DX1 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                     DX2 %in% codes_refractory_focal_epilepsy_ICD10
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2016#################################
refractory_focal_epilepsy_2016_i <- ms_i_2016 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX2 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX3 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX4 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX5 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX6 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX7 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX8 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX9 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX10 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX11%in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX12 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX13 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX14 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX15 %in% codes_refractory_focal_epilepsy_ICD10
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_focal_epilepsy_2016_o <- ms_o_2016 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                     DX2 %in% codes_refractory_focal_epilepsy_ICD10
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2017#################################
refractory_focal_epilepsy_2017_i <- ms_i_2017 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX2 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX3 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX4 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX5 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX6 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX7 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX8 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX9 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX10 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX11%in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX12 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX13 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX14 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX15 %in% codes_refractory_focal_epilepsy_ICD10
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_focal_epilepsy_2017_o <- ms_o_2017 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                     DX2 %in% codes_refractory_focal_epilepsy_ICD10
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>%
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2018#################################
refractory_focal_epilepsy_2018_i <- ms_i_2018 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX2 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX3 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX4 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX5 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX6 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX7 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX8 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX9 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX10 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX11%in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX12 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX13 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX14 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX15 %in% codes_refractory_focal_epilepsy_ICD10
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_focal_epilepsy_2018_o <- ms_o_2018 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                     DX2 %in% codes_refractory_focal_epilepsy_ICD10
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2019#################################
refractory_focal_epilepsy_2019_i <- ms_i_2019 %>% select(ENROLID, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX2 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX3 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX4 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX5 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX6 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX7 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX8 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX9 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX10 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX11%in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX12 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX13 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                      DX14 %in% codes_refractory_focal_epilepsy_ICD10 |
                                      DX15 %in% codes_refractory_focal_epilepsy_ICD10
                                      ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

refractory_focal_epilepsy_2019_o <- ms_o_2019 %>% select(ENROLID, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_refractory_focal_epilepsy_ICD10 | 
                                     DX2 %in% codes_refractory_focal_epilepsy_ICD10
                                     ) %>% mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


# Refractory focal epilepsy (at least 2 different codes for refractory focal epilepsy separated by at least 180 days)
refractory_focal_epilepsy <- bind_rows(refractory_focal_epilepsy_2006_i, refractory_focal_epilepsy_2006_o, refractory_focal_epilepsy_2007_i, refractory_focal_epilepsy_2007_o, refractory_focal_epilepsy_2008_i, refractory_focal_epilepsy_2008_o, refractory_focal_epilepsy_2009_i, refractory_focal_epilepsy_2009_o, refractory_focal_epilepsy_2010_i, refractory_focal_epilepsy_2010_o, refractory_focal_epilepsy_2011_i, refractory_focal_epilepsy_2011_o, refractory_focal_epilepsy_2012_i, refractory_focal_epilepsy_2012_o, refractory_focal_epilepsy_2013_i, refractory_focal_epilepsy_2013_o, refractory_focal_epilepsy_2014_i, refractory_focal_epilepsy_2014_o, refractory_focal_epilepsy_2015_i, refractory_focal_epilepsy_2015_o, refractory_focal_epilepsy_2016_i, refractory_focal_epilepsy_2016_o, refractory_focal_epilepsy_2017_i, refractory_focal_epilepsy_2017_o, refractory_focal_epilepsy_2018_i, refractory_focal_epilepsy_2018_o, refractory_focal_epilepsy_2019_i, refractory_focal_epilepsy_2019_o) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  mutate(maximum_days_between_refractory_focal_epilepsy_diagnoses=max(SVCDATE)-min(SVCDATE)) %>% 
  filter(maximum_days_between_refractory_focal_epilepsy_diagnoses>180)

refractory_focal_epilepsy_n <- refractory_focal_epilepsy %>% distinct(ENROLID) %>% nrow()
refractory_focal_epilepsy_n
```




Follow-up period
```{r}
# Follow-up per year
follow_up_2006 <- ms_t_2006 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(c(MSA, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  select(ENROLID, MSA, EGEOLOC, DTSTART, DTEND, MEMDAYS) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))

follow_up_2007 <- ms_t_2007 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(c(MSA, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  select(ENROLID, MSA, EGEOLOC, DTSTART, DTEND, MEMDAYS) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))

follow_up_2008 <- ms_t_2008 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(c(MSA, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  select(ENROLID, MSA, EGEOLOC, DTSTART, DTEND, MEMDAYS) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))

follow_up_2009 <- ms_t_2009 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(c(MSA, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  select(ENROLID, MSA, EGEOLOC, DTSTART, DTEND, MEMDAYS) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))

follow_up_2010 <- ms_t_2010 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(c(MSA, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  select(ENROLID, MSA, EGEOLOC, DTSTART, DTEND, MEMDAYS) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))

follow_up_2011 <- ms_t_2011 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(c(MSA, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  select(ENROLID, MSA, EGEOLOC, DTSTART, DTEND, MEMDAYS) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))

follow_up_2012 <- ms_t_2012 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(c(MSA, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  select(ENROLID, MSA, EGEOLOC, DTSTART, DTEND, MEMDAYS) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))

follow_up_2013 <- ms_t_2013 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(c(MSA, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  select(ENROLID, MSA, EGEOLOC, DTSTART, DTEND, MEMDAYS) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))

follow_up_2014 <- ms_t_2014 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(c(MSA, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  select(ENROLID, MSA, EGEOLOC, DTSTART, DTEND, MEMDAYS) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))

follow_up_2015 <- ms_t_2015 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(c(MSA, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  select(ENROLID, MSA, EGEOLOC, DTSTART, DTEND, MEMDAYS) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))

follow_up_2016 <- ms_t_2016 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(c(MSA, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  select(ENROLID, MSA, EGEOLOC, DTSTART, DTEND, MEMDAYS) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))

follow_up_2017 <- ms_t_2017 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(c(MSA, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  select(ENROLID, MSA, EGEOLOC, DTSTART, DTEND, MEMDAYS) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))

follow_up_2018 <- ms_t_2018 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(c(MSA, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  select(ENROLID, MSA, EGEOLOC, DTSTART, DTEND, MEMDAYS) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))

follow_up_2019 <- ms_t_2019 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(c(MSA, EGEOLOC, MEMDAYS), as.numeric)) %>% 
  select(ENROLID, MSA, EGEOLOC, DTSTART, DTEND, MEMDAYS) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))


follow_up <- bind_rows(follow_up_2006, follow_up_2007, follow_up_2008, follow_up_2009,
                       follow_up_2010, follow_up_2011, follow_up_2012, follow_up_2013,
                       follow_up_2014, follow_up_2015, follow_up_2016, follow_up_2017,
                       follow_up_2018, follow_up_2019) %>% 
  collect()
```




Identify patients with resective epilepsy surgery
```{r}
# Codes for patients with resective epilepsy surgery
codes_resective_epilepsy_surgery <- c("61534", "61536", "61537", "61538", "61539", "61540", "61566")
  

#################################2006#################################
resective_epilepsy_surgery2006_i <- ms_i_2006 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_resective_epilepsy_surgery |
  PROC1 %in% codes_resective_epilepsy_surgery |
  PROC2 %in% codes_resective_epilepsy_surgery |
  PROC3 %in% codes_resective_epilepsy_surgery |
  PROC4 %in% codes_resective_epilepsy_surgery |
  PROC5 %in% codes_resective_epilepsy_surgery |
  PROC6 %in% codes_resective_epilepsy_surgery |
  PROC7 %in% codes_resective_epilepsy_surgery |
  PROC8 %in% codes_resective_epilepsy_surgery |
  PROC9 %in% codes_resective_epilepsy_surgery |
  PROC10 %in% codes_resective_epilepsy_surgery |
  PROC11 %in% codes_resective_epilepsy_surgery |
  PROC12 %in% codes_resective_epilepsy_surgery |
  PROC13 %in% codes_resective_epilepsy_surgery |  
  PROC14 %in% codes_resective_epilepsy_surgery |
  PROC15 %in% codes_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

resective_epilepsy_surgery2006_o <- ms_o_2006 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2007#################################
resective_epilepsy_surgery2007_i <- ms_i_2007 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_resective_epilepsy_surgery |
  PROC1 %in% codes_resective_epilepsy_surgery |
  PROC2 %in% codes_resective_epilepsy_surgery |
  PROC3 %in% codes_resective_epilepsy_surgery |
  PROC4 %in% codes_resective_epilepsy_surgery |
  PROC5 %in% codes_resective_epilepsy_surgery |
  PROC6 %in% codes_resective_epilepsy_surgery |
  PROC7 %in% codes_resective_epilepsy_surgery |
  PROC8 %in% codes_resective_epilepsy_surgery |
  PROC9 %in% codes_resective_epilepsy_surgery |
  PROC10 %in% codes_resective_epilepsy_surgery |
  PROC11 %in% codes_resective_epilepsy_surgery |
  PROC12 %in% codes_resective_epilepsy_surgery |
  PROC13 %in% codes_resective_epilepsy_surgery |  
  PROC14 %in% codes_resective_epilepsy_surgery |
  PROC15 %in% codes_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

resective_epilepsy_surgery2007_o <- ms_o_2007 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2008#################################
resective_epilepsy_surgery2008_i <- ms_i_2008 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_resective_epilepsy_surgery |
  PROC1 %in% codes_resective_epilepsy_surgery |
  PROC2 %in% codes_resective_epilepsy_surgery |
  PROC3 %in% codes_resective_epilepsy_surgery |
  PROC4 %in% codes_resective_epilepsy_surgery |
  PROC5 %in% codes_resective_epilepsy_surgery |
  PROC6 %in% codes_resective_epilepsy_surgery |
  PROC7 %in% codes_resective_epilepsy_surgery |
  PROC8 %in% codes_resective_epilepsy_surgery |
  PROC9 %in% codes_resective_epilepsy_surgery |
  PROC10 %in% codes_resective_epilepsy_surgery |
  PROC11 %in% codes_resective_epilepsy_surgery |
  PROC12 %in% codes_resective_epilepsy_surgery |
  PROC13 %in% codes_resective_epilepsy_surgery |  
  PROC14 %in% codes_resective_epilepsy_surgery |
  PROC15 %in% codes_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

resective_epilepsy_surgery2008_o <- ms_o_2008 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2009#################################
resective_epilepsy_surgery2009_i <- ms_i_2009 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_resective_epilepsy_surgery |
  PROC1 %in% codes_resective_epilepsy_surgery |
  PROC2 %in% codes_resective_epilepsy_surgery |
  PROC3 %in% codes_resective_epilepsy_surgery |
  PROC4 %in% codes_resective_epilepsy_surgery |
  PROC5 %in% codes_resective_epilepsy_surgery |
  PROC6 %in% codes_resective_epilepsy_surgery |
  PROC7 %in% codes_resective_epilepsy_surgery |
  PROC8 %in% codes_resective_epilepsy_surgery |
  PROC9 %in% codes_resective_epilepsy_surgery |
  PROC10 %in% codes_resective_epilepsy_surgery |
  PROC11 %in% codes_resective_epilepsy_surgery |
  PROC12 %in% codes_resective_epilepsy_surgery |
  PROC13 %in% codes_resective_epilepsy_surgery |  
  PROC14 %in% codes_resective_epilepsy_surgery |
  PROC15 %in% codes_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

resective_epilepsy_surgery2009_o <- ms_o_2009 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2010#################################
resective_epilepsy_surgery2010_i <- ms_i_2010 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_resective_epilepsy_surgery |
  PROC1 %in% codes_resective_epilepsy_surgery |
  PROC2 %in% codes_resective_epilepsy_surgery |
  PROC3 %in% codes_resective_epilepsy_surgery |
  PROC4 %in% codes_resective_epilepsy_surgery |
  PROC5 %in% codes_resective_epilepsy_surgery |
  PROC6 %in% codes_resective_epilepsy_surgery |
  PROC7 %in% codes_resective_epilepsy_surgery |
  PROC8 %in% codes_resective_epilepsy_surgery |
  PROC9 %in% codes_resective_epilepsy_surgery |
  PROC10 %in% codes_resective_epilepsy_surgery |
  PROC11 %in% codes_resective_epilepsy_surgery |
  PROC12 %in% codes_resective_epilepsy_surgery |
  PROC13 %in% codes_resective_epilepsy_surgery |  
  PROC14 %in% codes_resective_epilepsy_surgery |
  PROC15 %in% codes_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

resective_epilepsy_surgery2010_o <- ms_o_2010 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2011#################################
resective_epilepsy_surgery2011_i <- ms_i_2011 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_resective_epilepsy_surgery |
  PROC1 %in% codes_resective_epilepsy_surgery |
  PROC2 %in% codes_resective_epilepsy_surgery |
  PROC3 %in% codes_resective_epilepsy_surgery |
  PROC4 %in% codes_resective_epilepsy_surgery |
  PROC5 %in% codes_resective_epilepsy_surgery |
  PROC6 %in% codes_resective_epilepsy_surgery |
  PROC7 %in% codes_resective_epilepsy_surgery |
  PROC8 %in% codes_resective_epilepsy_surgery |
  PROC9 %in% codes_resective_epilepsy_surgery |
  PROC10 %in% codes_resective_epilepsy_surgery |
  PROC11 %in% codes_resective_epilepsy_surgery |
  PROC12 %in% codes_resective_epilepsy_surgery |
  PROC13 %in% codes_resective_epilepsy_surgery |  
  PROC14 %in% codes_resective_epilepsy_surgery |
  PROC15 %in% codes_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

resective_epilepsy_surgery2011_o <- ms_o_2011 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2012#################################
resective_epilepsy_surgery2012_i <- ms_i_2012 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_resective_epilepsy_surgery |
  PROC1 %in% codes_resective_epilepsy_surgery |
  PROC2 %in% codes_resective_epilepsy_surgery |
  PROC3 %in% codes_resective_epilepsy_surgery |
  PROC4 %in% codes_resective_epilepsy_surgery |
  PROC5 %in% codes_resective_epilepsy_surgery |
  PROC6 %in% codes_resective_epilepsy_surgery |
  PROC7 %in% codes_resective_epilepsy_surgery |
  PROC8 %in% codes_resective_epilepsy_surgery |
  PROC9 %in% codes_resective_epilepsy_surgery |
  PROC10 %in% codes_resective_epilepsy_surgery |
  PROC11 %in% codes_resective_epilepsy_surgery |
  PROC12 %in% codes_resective_epilepsy_surgery |
  PROC13 %in% codes_resective_epilepsy_surgery |  
  PROC14 %in% codes_resective_epilepsy_surgery |
  PROC15 %in% codes_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

resective_epilepsy_surgery2012_o <- ms_o_2012 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2013#################################
resective_epilepsy_surgery2013_i <- ms_i_2013 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_resective_epilepsy_surgery |
  PROC1 %in% codes_resective_epilepsy_surgery |
  PROC2 %in% codes_resective_epilepsy_surgery |
  PROC3 %in% codes_resective_epilepsy_surgery |
  PROC4 %in% codes_resective_epilepsy_surgery |
  PROC5 %in% codes_resective_epilepsy_surgery |
  PROC6 %in% codes_resective_epilepsy_surgery |
  PROC7 %in% codes_resective_epilepsy_surgery |
  PROC8 %in% codes_resective_epilepsy_surgery |
  PROC9 %in% codes_resective_epilepsy_surgery |
  PROC10 %in% codes_resective_epilepsy_surgery |
  PROC11 %in% codes_resective_epilepsy_surgery |
  PROC12 %in% codes_resective_epilepsy_surgery |
  PROC13 %in% codes_resective_epilepsy_surgery |  
  PROC14 %in% codes_resective_epilepsy_surgery |
  PROC15 %in% codes_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

resective_epilepsy_surgery2013_o <- ms_o_2013 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2014#################################
resective_epilepsy_surgery2014_i <- ms_i_2014 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_resective_epilepsy_surgery |
  PROC1 %in% codes_resective_epilepsy_surgery |
  PROC2 %in% codes_resective_epilepsy_surgery |
  PROC3 %in% codes_resective_epilepsy_surgery |
  PROC4 %in% codes_resective_epilepsy_surgery |
  PROC5 %in% codes_resective_epilepsy_surgery |
  PROC6 %in% codes_resective_epilepsy_surgery |
  PROC7 %in% codes_resective_epilepsy_surgery |
  PROC8 %in% codes_resective_epilepsy_surgery |
  PROC9 %in% codes_resective_epilepsy_surgery |
  PROC10 %in% codes_resective_epilepsy_surgery |
  PROC11 %in% codes_resective_epilepsy_surgery |
  PROC12 %in% codes_resective_epilepsy_surgery |
  PROC13 %in% codes_resective_epilepsy_surgery |  
  PROC14 %in% codes_resective_epilepsy_surgery |
  PROC15 %in% codes_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

resective_epilepsy_surgery2014_o <- ms_o_2014 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2015#################################
resective_epilepsy_surgery2015_i <- ms_i_2015 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_resective_epilepsy_surgery |
  PROC1 %in% codes_resective_epilepsy_surgery |
  PROC2 %in% codes_resective_epilepsy_surgery |
  PROC3 %in% codes_resective_epilepsy_surgery |
  PROC4 %in% codes_resective_epilepsy_surgery |
  PROC5 %in% codes_resective_epilepsy_surgery |
  PROC6 %in% codes_resective_epilepsy_surgery |
  PROC7 %in% codes_resective_epilepsy_surgery |
  PROC8 %in% codes_resective_epilepsy_surgery |
  PROC9 %in% codes_resective_epilepsy_surgery |
  PROC10 %in% codes_resective_epilepsy_surgery |
  PROC11 %in% codes_resective_epilepsy_surgery |
  PROC12 %in% codes_resective_epilepsy_surgery |
  PROC13 %in% codes_resective_epilepsy_surgery |  
  PROC14 %in% codes_resective_epilepsy_surgery |
  PROC15 %in% codes_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

resective_epilepsy_surgery2015_o <- ms_o_2015 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2016#################################
resective_epilepsy_surgery2016_i <- ms_i_2016 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_resective_epilepsy_surgery |
  PROC1 %in% codes_resective_epilepsy_surgery |
  PROC2 %in% codes_resective_epilepsy_surgery |
  PROC3 %in% codes_resective_epilepsy_surgery |
  PROC4 %in% codes_resective_epilepsy_surgery |
  PROC5 %in% codes_resective_epilepsy_surgery |
  PROC6 %in% codes_resective_epilepsy_surgery |
  PROC7 %in% codes_resective_epilepsy_surgery |
  PROC8 %in% codes_resective_epilepsy_surgery |
  PROC9 %in% codes_resective_epilepsy_surgery |
  PROC10 %in% codes_resective_epilepsy_surgery |
  PROC11 %in% codes_resective_epilepsy_surgery |
  PROC12 %in% codes_resective_epilepsy_surgery |
  PROC13 %in% codes_resective_epilepsy_surgery |  
  PROC14 %in% codes_resective_epilepsy_surgery |
  PROC15 %in% codes_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

resective_epilepsy_surgery2016_o <- ms_o_2016 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2017#################################
resective_epilepsy_surgery2017_i <- ms_i_2017 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_resective_epilepsy_surgery |
  PROC1 %in% codes_resective_epilepsy_surgery |
  PROC2 %in% codes_resective_epilepsy_surgery |
  PROC3 %in% codes_resective_epilepsy_surgery |
  PROC4 %in% codes_resective_epilepsy_surgery |
  PROC5 %in% codes_resective_epilepsy_surgery |
  PROC6 %in% codes_resective_epilepsy_surgery |
  PROC7 %in% codes_resective_epilepsy_surgery |
  PROC8 %in% codes_resective_epilepsy_surgery |
  PROC9 %in% codes_resective_epilepsy_surgery |
  PROC10 %in% codes_resective_epilepsy_surgery |
  PROC11 %in% codes_resective_epilepsy_surgery |
  PROC12 %in% codes_resective_epilepsy_surgery |
  PROC13 %in% codes_resective_epilepsy_surgery |  
  PROC14 %in% codes_resective_epilepsy_surgery |
  PROC15 %in% codes_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

resective_epilepsy_surgery2017_o <- ms_o_2017 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2018#################################
resective_epilepsy_surgery2018_i <- ms_i_2018 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_resective_epilepsy_surgery |
  PROC1 %in% codes_resective_epilepsy_surgery |
  PROC2 %in% codes_resective_epilepsy_surgery |
  PROC3 %in% codes_resective_epilepsy_surgery |
  PROC4 %in% codes_resective_epilepsy_surgery |
  PROC5 %in% codes_resective_epilepsy_surgery |
  PROC6 %in% codes_resective_epilepsy_surgery |
  PROC7 %in% codes_resective_epilepsy_surgery |
  PROC8 %in% codes_resective_epilepsy_surgery |
  PROC9 %in% codes_resective_epilepsy_surgery |
  PROC10 %in% codes_resective_epilepsy_surgery |
  PROC11 %in% codes_resective_epilepsy_surgery |
  PROC12 %in% codes_resective_epilepsy_surgery |
  PROC13 %in% codes_resective_epilepsy_surgery |  
  PROC14 %in% codes_resective_epilepsy_surgery |
  PROC15 %in% codes_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

resective_epilepsy_surgery2018_o <- ms_o_2018 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2019#################################
resective_epilepsy_surgery2019_i <- ms_i_2019 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_resective_epilepsy_surgery |
  PROC1 %in% codes_resective_epilepsy_surgery |
  PROC2 %in% codes_resective_epilepsy_surgery |
  PROC3 %in% codes_resective_epilepsy_surgery |
  PROC4 %in% codes_resective_epilepsy_surgery |
  PROC5 %in% codes_resective_epilepsy_surgery |
  PROC6 %in% codes_resective_epilepsy_surgery |
  PROC7 %in% codes_resective_epilepsy_surgery |
  PROC8 %in% codes_resective_epilepsy_surgery |
  PROC9 %in% codes_resective_epilepsy_surgery |
  PROC10 %in% codes_resective_epilepsy_surgery |
  PROC11 %in% codes_resective_epilepsy_surgery |
  PROC12 %in% codes_resective_epilepsy_surgery |
  PROC13 %in% codes_resective_epilepsy_surgery |  
  PROC14 %in% codes_resective_epilepsy_surgery |
  PROC15 %in% codes_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

resective_epilepsy_surgery2019_o <- ms_o_2019 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


# Resective epilepsy surgery
resective_epilepsy_surgery <- bind_rows(resective_epilepsy_surgery2006_i, resective_epilepsy_surgery2006_o, resective_epilepsy_surgery2007_i, resective_epilepsy_surgery2007_o, resective_epilepsy_surgery2008_i, resective_epilepsy_surgery2008_o, resective_epilepsy_surgery2009_i, resective_epilepsy_surgery2009_o, resective_epilepsy_surgery2010_i, resective_epilepsy_surgery2010_o, resective_epilepsy_surgery2011_i, resective_epilepsy_surgery2011_o, resective_epilepsy_surgery2012_i, resective_epilepsy_surgery2012_o, resective_epilepsy_surgery2013_i, resective_epilepsy_surgery2013_o, resective_epilepsy_surgery2014_i, resective_epilepsy_surgery2014_o, resective_epilepsy_surgery2015_i, resective_epilepsy_surgery2015_o, resective_epilepsy_surgery2016_i, resective_epilepsy_surgery2016_o, resective_epilepsy_surgery2017_i, resective_epilepsy_surgery2017_o, resective_epilepsy_surgery2018_i, resective_epilepsy_surgery2018_o, resective_epilepsy_surgery2019_i, resective_epilepsy_surgery2019_o) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  arrange(SVCDATE, .by_group=TRUE) %>% 
  mutate(difference_between_surgeries=SVCDATE - lag(SVCDATE, 1))

# Individual resective epilepsy surgeries
surgeries_resective_epilepsy_surgery_n <- resective_epilepsy_surgery %>% distinct(ENROLID, SVCDATE) %>% nrow()
surgeries_resective_epilepsy_surgery_n 

# Individual patients with resective epilepsy surgery
patients_resective_epilepsy_surgery_n <- resective_epilepsy_surgery %>% distinct(ENROLID) %>% nrow()
patients_resective_epilepsy_surgery_n 

# Tally of patients with more than one resective epilepsy surgery
tally_resective_epilepsy_surgery <- resective_epilepsy_surgery %>% group_by(ENROLID) %>% tally(name="number_surgeries")  %>% group_by(number_surgeries) %>% tally(name="number_patients")
tally_resective_epilepsy_surgery

# Period between individual surgeries in patients with repeated surgeries
period_between_resective_epilepsy_surgeries <- summary(as.numeric(resective_epilepsy_surgery$difference_between_surgeries))
period_between_resective_epilepsy_surgeries
```




Identify patients with temporal resective epilepsy surgery
```{r}
# Codes for patients with temporal resective epilepsy surgery
codes_temporal_resective_epilepsy_surgery <- c("61537", "61538", "61566")


#################################2006#################################
temporal_resective_epilepsy_surgery2006_i <- ms_i_2006 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_temporal_resective_epilepsy_surgery |
  PROC1 %in% codes_temporal_resective_epilepsy_surgery |
  PROC2 %in% codes_temporal_resective_epilepsy_surgery |
  PROC3 %in% codes_temporal_resective_epilepsy_surgery |
  PROC4 %in% codes_temporal_resective_epilepsy_surgery |
  PROC5 %in% codes_temporal_resective_epilepsy_surgery |
  PROC6 %in% codes_temporal_resective_epilepsy_surgery |
  PROC7 %in% codes_temporal_resective_epilepsy_surgery |
  PROC8 %in% codes_temporal_resective_epilepsy_surgery |
  PROC9 %in% codes_temporal_resective_epilepsy_surgery |
  PROC10 %in% codes_temporal_resective_epilepsy_surgery |
  PROC11 %in% codes_temporal_resective_epilepsy_surgery |
  PROC12 %in% codes_temporal_resective_epilepsy_surgery |
  PROC13 %in% codes_temporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_temporal_resective_epilepsy_surgery |
  PROC15 %in% codes_temporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

temporal_resective_epilepsy_surgery2006_o <- ms_o_2006 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_temporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2007#################################
temporal_resective_epilepsy_surgery2007_i <- ms_i_2007 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_temporal_resective_epilepsy_surgery |
  PROC1 %in% codes_temporal_resective_epilepsy_surgery |
  PROC2 %in% codes_temporal_resective_epilepsy_surgery |
  PROC3 %in% codes_temporal_resective_epilepsy_surgery |
  PROC4 %in% codes_temporal_resective_epilepsy_surgery |
  PROC5 %in% codes_temporal_resective_epilepsy_surgery |
  PROC6 %in% codes_temporal_resective_epilepsy_surgery |
  PROC7 %in% codes_temporal_resective_epilepsy_surgery |
  PROC8 %in% codes_temporal_resective_epilepsy_surgery |
  PROC9 %in% codes_temporal_resective_epilepsy_surgery |
  PROC10 %in% codes_temporal_resective_epilepsy_surgery |
  PROC11 %in% codes_temporal_resective_epilepsy_surgery |
  PROC12 %in% codes_temporal_resective_epilepsy_surgery |
  PROC13 %in% codes_temporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_temporal_resective_epilepsy_surgery |
  PROC15 %in% codes_temporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

temporal_resective_epilepsy_surgery2007_o <- ms_o_2007 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_temporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2008#################################
temporal_resective_epilepsy_surgery2008_i <- ms_i_2008 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_temporal_resective_epilepsy_surgery |
  PROC1 %in% codes_temporal_resective_epilepsy_surgery |
  PROC2 %in% codes_temporal_resective_epilepsy_surgery |
  PROC3 %in% codes_temporal_resective_epilepsy_surgery |
  PROC4 %in% codes_temporal_resective_epilepsy_surgery |
  PROC5 %in% codes_temporal_resective_epilepsy_surgery |
  PROC6 %in% codes_temporal_resective_epilepsy_surgery |
  PROC7 %in% codes_temporal_resective_epilepsy_surgery |
  PROC8 %in% codes_temporal_resective_epilepsy_surgery |
  PROC9 %in% codes_temporal_resective_epilepsy_surgery |
  PROC10 %in% codes_temporal_resective_epilepsy_surgery |
  PROC11 %in% codes_temporal_resective_epilepsy_surgery |
  PROC12 %in% codes_temporal_resective_epilepsy_surgery |
  PROC13 %in% codes_temporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_temporal_resective_epilepsy_surgery |
  PROC15 %in% codes_temporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

temporal_resective_epilepsy_surgery2008_o <- ms_o_2008 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_temporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2009#################################
temporal_resective_epilepsy_surgery2009_i <- ms_i_2009 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_temporal_resective_epilepsy_surgery |
  PROC1 %in% codes_temporal_resective_epilepsy_surgery |
  PROC2 %in% codes_temporal_resective_epilepsy_surgery |
  PROC3 %in% codes_temporal_resective_epilepsy_surgery |
  PROC4 %in% codes_temporal_resective_epilepsy_surgery |
  PROC5 %in% codes_temporal_resective_epilepsy_surgery |
  PROC6 %in% codes_temporal_resective_epilepsy_surgery |
  PROC7 %in% codes_temporal_resective_epilepsy_surgery |
  PROC8 %in% codes_temporal_resective_epilepsy_surgery |
  PROC9 %in% codes_temporal_resective_epilepsy_surgery |
  PROC10 %in% codes_temporal_resective_epilepsy_surgery |
  PROC11 %in% codes_temporal_resective_epilepsy_surgery |
  PROC12 %in% codes_temporal_resective_epilepsy_surgery |
  PROC13 %in% codes_temporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_temporal_resective_epilepsy_surgery |
  PROC15 %in% codes_temporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

temporal_resective_epilepsy_surgery2009_o <- ms_o_2009 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_temporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2010#################################
temporal_resective_epilepsy_surgery2010_i <- ms_i_2010 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_temporal_resective_epilepsy_surgery |
  PROC1 %in% codes_temporal_resective_epilepsy_surgery |
  PROC2 %in% codes_temporal_resective_epilepsy_surgery |
  PROC3 %in% codes_temporal_resective_epilepsy_surgery |
  PROC4 %in% codes_temporal_resective_epilepsy_surgery |
  PROC5 %in% codes_temporal_resective_epilepsy_surgery |
  PROC6 %in% codes_temporal_resective_epilepsy_surgery |
  PROC7 %in% codes_temporal_resective_epilepsy_surgery |
  PROC8 %in% codes_temporal_resective_epilepsy_surgery |
  PROC9 %in% codes_temporal_resective_epilepsy_surgery |
  PROC10 %in% codes_temporal_resective_epilepsy_surgery |
  PROC11 %in% codes_temporal_resective_epilepsy_surgery |
  PROC12 %in% codes_temporal_resective_epilepsy_surgery |
  PROC13 %in% codes_temporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_temporal_resective_epilepsy_surgery |
  PROC15 %in% codes_temporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

temporal_resective_epilepsy_surgery2010_o <- ms_o_2010 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_temporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2011#################################
temporal_resective_epilepsy_surgery2011_i <- ms_i_2011 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_temporal_resective_epilepsy_surgery |
  PROC1 %in% codes_temporal_resective_epilepsy_surgery |
  PROC2 %in% codes_temporal_resective_epilepsy_surgery |
  PROC3 %in% codes_temporal_resective_epilepsy_surgery |
  PROC4 %in% codes_temporal_resective_epilepsy_surgery |
  PROC5 %in% codes_temporal_resective_epilepsy_surgery |
  PROC6 %in% codes_temporal_resective_epilepsy_surgery |
  PROC7 %in% codes_temporal_resective_epilepsy_surgery |
  PROC8 %in% codes_temporal_resective_epilepsy_surgery |
  PROC9 %in% codes_temporal_resective_epilepsy_surgery |
  PROC10 %in% codes_temporal_resective_epilepsy_surgery |
  PROC11 %in% codes_temporal_resective_epilepsy_surgery |
  PROC12 %in% codes_temporal_resective_epilepsy_surgery |
  PROC13 %in% codes_temporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_temporal_resective_epilepsy_surgery |
  PROC15 %in% codes_temporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

temporal_resective_epilepsy_surgery2011_o <- ms_o_2011 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_temporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2012#################################
temporal_resective_epilepsy_surgery2012_i <- ms_i_2012 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_temporal_resective_epilepsy_surgery |
  PROC1 %in% codes_temporal_resective_epilepsy_surgery |
  PROC2 %in% codes_temporal_resective_epilepsy_surgery |
  PROC3 %in% codes_temporal_resective_epilepsy_surgery |
  PROC4 %in% codes_temporal_resective_epilepsy_surgery |
  PROC5 %in% codes_temporal_resective_epilepsy_surgery |
  PROC6 %in% codes_temporal_resective_epilepsy_surgery |
  PROC7 %in% codes_temporal_resective_epilepsy_surgery |
  PROC8 %in% codes_temporal_resective_epilepsy_surgery |
  PROC9 %in% codes_temporal_resective_epilepsy_surgery |
  PROC10 %in% codes_temporal_resective_epilepsy_surgery |
  PROC11 %in% codes_temporal_resective_epilepsy_surgery |
  PROC12 %in% codes_temporal_resective_epilepsy_surgery |
  PROC13 %in% codes_temporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_temporal_resective_epilepsy_surgery |
  PROC15 %in% codes_temporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

temporal_resective_epilepsy_surgery2012_o <- ms_o_2012 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_temporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2013#################################
temporal_resective_epilepsy_surgery2013_i <- ms_i_2013 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_temporal_resective_epilepsy_surgery |
  PROC1 %in% codes_temporal_resective_epilepsy_surgery |
  PROC2 %in% codes_temporal_resective_epilepsy_surgery |
  PROC3 %in% codes_temporal_resective_epilepsy_surgery |
  PROC4 %in% codes_temporal_resective_epilepsy_surgery |
  PROC5 %in% codes_temporal_resective_epilepsy_surgery |
  PROC6 %in% codes_temporal_resective_epilepsy_surgery |
  PROC7 %in% codes_temporal_resective_epilepsy_surgery |
  PROC8 %in% codes_temporal_resective_epilepsy_surgery |
  PROC9 %in% codes_temporal_resective_epilepsy_surgery |
  PROC10 %in% codes_temporal_resective_epilepsy_surgery |
  PROC11 %in% codes_temporal_resective_epilepsy_surgery |
  PROC12 %in% codes_temporal_resective_epilepsy_surgery |
  PROC13 %in% codes_temporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_temporal_resective_epilepsy_surgery |
  PROC15 %in% codes_temporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

temporal_resective_epilepsy_surgery2013_o <- ms_o_2013 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_temporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2014#################################
temporal_resective_epilepsy_surgery2014_i <- ms_i_2014 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_temporal_resective_epilepsy_surgery |
  PROC1 %in% codes_temporal_resective_epilepsy_surgery |
  PROC2 %in% codes_temporal_resective_epilepsy_surgery |
  PROC3 %in% codes_temporal_resective_epilepsy_surgery |
  PROC4 %in% codes_temporal_resective_epilepsy_surgery |
  PROC5 %in% codes_temporal_resective_epilepsy_surgery |
  PROC6 %in% codes_temporal_resective_epilepsy_surgery |
  PROC7 %in% codes_temporal_resective_epilepsy_surgery |
  PROC8 %in% codes_temporal_resective_epilepsy_surgery |
  PROC9 %in% codes_temporal_resective_epilepsy_surgery |
  PROC10 %in% codes_temporal_resective_epilepsy_surgery |
  PROC11 %in% codes_temporal_resective_epilepsy_surgery |
  PROC12 %in% codes_temporal_resective_epilepsy_surgery |
  PROC13 %in% codes_temporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_temporal_resective_epilepsy_surgery |
  PROC15 %in% codes_temporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

temporal_resective_epilepsy_surgery2014_o <- ms_o_2014 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_temporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2015#################################
temporal_resective_epilepsy_surgery2015_i <- ms_i_2015 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_temporal_resective_epilepsy_surgery |
  PROC1 %in% codes_temporal_resective_epilepsy_surgery |
  PROC2 %in% codes_temporal_resective_epilepsy_surgery |
  PROC3 %in% codes_temporal_resective_epilepsy_surgery |
  PROC4 %in% codes_temporal_resective_epilepsy_surgery |
  PROC5 %in% codes_temporal_resective_epilepsy_surgery |
  PROC6 %in% codes_temporal_resective_epilepsy_surgery |
  PROC7 %in% codes_temporal_resective_epilepsy_surgery |
  PROC8 %in% codes_temporal_resective_epilepsy_surgery |
  PROC9 %in% codes_temporal_resective_epilepsy_surgery |
  PROC10 %in% codes_temporal_resective_epilepsy_surgery |
  PROC11 %in% codes_temporal_resective_epilepsy_surgery |
  PROC12 %in% codes_temporal_resective_epilepsy_surgery |
  PROC13 %in% codes_temporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_temporal_resective_epilepsy_surgery |
  PROC15 %in% codes_temporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

temporal_resective_epilepsy_surgery2015_o <- ms_o_2015 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_temporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2016#################################
temporal_resective_epilepsy_surgery2016_i <- ms_i_2016 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_temporal_resective_epilepsy_surgery |
  PROC1 %in% codes_temporal_resective_epilepsy_surgery |
  PROC2 %in% codes_temporal_resective_epilepsy_surgery |
  PROC3 %in% codes_temporal_resective_epilepsy_surgery |
  PROC4 %in% codes_temporal_resective_epilepsy_surgery |
  PROC5 %in% codes_temporal_resective_epilepsy_surgery |
  PROC6 %in% codes_temporal_resective_epilepsy_surgery |
  PROC7 %in% codes_temporal_resective_epilepsy_surgery |
  PROC8 %in% codes_temporal_resective_epilepsy_surgery |
  PROC9 %in% codes_temporal_resective_epilepsy_surgery |
  PROC10 %in% codes_temporal_resective_epilepsy_surgery |
  PROC11 %in% codes_temporal_resective_epilepsy_surgery |
  PROC12 %in% codes_temporal_resective_epilepsy_surgery |
  PROC13 %in% codes_temporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_temporal_resective_epilepsy_surgery |
  PROC15 %in% codes_temporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

temporal_resective_epilepsy_surgery2016_o <- ms_o_2016 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_temporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2017#################################
temporal_resective_epilepsy_surgery2017_i <- ms_i_2017 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_temporal_resective_epilepsy_surgery |
  PROC1 %in% codes_temporal_resective_epilepsy_surgery |
  PROC2 %in% codes_temporal_resective_epilepsy_surgery |
  PROC3 %in% codes_temporal_resective_epilepsy_surgery |
  PROC4 %in% codes_temporal_resective_epilepsy_surgery |
  PROC5 %in% codes_temporal_resective_epilepsy_surgery |
  PROC6 %in% codes_temporal_resective_epilepsy_surgery |
  PROC7 %in% codes_temporal_resective_epilepsy_surgery |
  PROC8 %in% codes_temporal_resective_epilepsy_surgery |
  PROC9 %in% codes_temporal_resective_epilepsy_surgery |
  PROC10 %in% codes_temporal_resective_epilepsy_surgery |
  PROC11 %in% codes_temporal_resective_epilepsy_surgery |
  PROC12 %in% codes_temporal_resective_epilepsy_surgery |
  PROC13 %in% codes_temporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_temporal_resective_epilepsy_surgery |
  PROC15 %in% codes_temporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

temporal_resective_epilepsy_surgery2017_o <- ms_o_2017 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_temporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2018#################################
temporal_resective_epilepsy_surgery2018_i <- ms_i_2018 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_temporal_resective_epilepsy_surgery |
  PROC1 %in% codes_temporal_resective_epilepsy_surgery |
  PROC2 %in% codes_temporal_resective_epilepsy_surgery |
  PROC3 %in% codes_temporal_resective_epilepsy_surgery |
  PROC4 %in% codes_temporal_resective_epilepsy_surgery |
  PROC5 %in% codes_temporal_resective_epilepsy_surgery |
  PROC6 %in% codes_temporal_resective_epilepsy_surgery |
  PROC7 %in% codes_temporal_resective_epilepsy_surgery |
  PROC8 %in% codes_temporal_resective_epilepsy_surgery |
  PROC9 %in% codes_temporal_resective_epilepsy_surgery |
  PROC10 %in% codes_temporal_resective_epilepsy_surgery |
  PROC11 %in% codes_temporal_resective_epilepsy_surgery |
  PROC12 %in% codes_temporal_resective_epilepsy_surgery |
  PROC13 %in% codes_temporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_temporal_resective_epilepsy_surgery |
  PROC15 %in% codes_temporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

temporal_resective_epilepsy_surgery2018_o <- ms_o_2018 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_temporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2019#################################
temporal_resective_epilepsy_surgery2019_i <- ms_i_2019 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_temporal_resective_epilepsy_surgery |
  PROC1 %in% codes_temporal_resective_epilepsy_surgery |
  PROC2 %in% codes_temporal_resective_epilepsy_surgery |
  PROC3 %in% codes_temporal_resective_epilepsy_surgery |
  PROC4 %in% codes_temporal_resective_epilepsy_surgery |
  PROC5 %in% codes_temporal_resective_epilepsy_surgery |
  PROC6 %in% codes_temporal_resective_epilepsy_surgery |
  PROC7 %in% codes_temporal_resective_epilepsy_surgery |
  PROC8 %in% codes_temporal_resective_epilepsy_surgery |
  PROC9 %in% codes_temporal_resective_epilepsy_surgery |
  PROC10 %in% codes_temporal_resective_epilepsy_surgery |
  PROC11 %in% codes_temporal_resective_epilepsy_surgery |
  PROC12 %in% codes_temporal_resective_epilepsy_surgery |
  PROC13 %in% codes_temporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_temporal_resective_epilepsy_surgery |
  PROC15 %in% codes_temporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

temporal_resective_epilepsy_surgery2019_o <- ms_o_2019 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_temporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


# Temporal resective epilepsy surgery
temporal_resective_epilepsy_surgery <- bind_rows(temporal_resective_epilepsy_surgery2006_i, temporal_resective_epilepsy_surgery2006_o, temporal_resective_epilepsy_surgery2007_i, temporal_resective_epilepsy_surgery2007_o, temporal_resective_epilepsy_surgery2008_i, temporal_resective_epilepsy_surgery2008_o, temporal_resective_epilepsy_surgery2009_i, temporal_resective_epilepsy_surgery2009_o, temporal_resective_epilepsy_surgery2010_i, temporal_resective_epilepsy_surgery2010_o, temporal_resective_epilepsy_surgery2011_i, temporal_resective_epilepsy_surgery2011_o, temporal_resective_epilepsy_surgery2012_i, temporal_resective_epilepsy_surgery2012_o, temporal_resective_epilepsy_surgery2013_i, temporal_resective_epilepsy_surgery2013_o, temporal_resective_epilepsy_surgery2014_i, temporal_resective_epilepsy_surgery2014_o, temporal_resective_epilepsy_surgery2015_i, temporal_resective_epilepsy_surgery2015_o, temporal_resective_epilepsy_surgery2016_i, temporal_resective_epilepsy_surgery2016_o, temporal_resective_epilepsy_surgery2017_i, temporal_resective_epilepsy_surgery2017_o, temporal_resective_epilepsy_surgery2018_i, temporal_resective_epilepsy_surgery2018_o, temporal_resective_epilepsy_surgery2019_i, temporal_resective_epilepsy_surgery2019_o) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  arrange(SVCDATE, .by_group=TRUE) %>% 
  mutate(difference_between_surgeries=SVCDATE - lag(SVCDATE, 1))

# Individual temporal resective epilepsy surgeries
surgeries_temporal_resective_epilepsy_surgery_n <- temporal_resective_epilepsy_surgery %>% distinct(ENROLID, SVCDATE) %>% nrow()
surgeries_temporal_resective_epilepsy_surgery_n 

# Individual patients with temporal resective epilepsy surgery
patients_temporal_resective_epilepsy_surgery_n <- temporal_resective_epilepsy_surgery %>% distinct(ENROLID) %>% nrow()
patients_temporal_resective_epilepsy_surgery_n 

# Tally of patients with more than one temporal resective epilepsy surgery
tally_temporal_resective_epilepsy_surgery <- temporal_resective_epilepsy_surgery %>% group_by(ENROLID) %>% tally(name="number_surgeries")  %>% group_by(number_surgeries) %>% tally(name="number_patients")
tally_temporal_resective_epilepsy_surgery

# Period between individual surgeries in patients with repeated surgeries
period_between_temporal_resective_epilepsy_surgeries <- summary(as.numeric(temporal_resective_epilepsy_surgery$difference_between_surgeries))
period_between_temporal_resective_epilepsy_surgeries
```




Identify patients with extratemporal resective epilepsy surgery
```{r}
# Codes for patients with extratemporal resective epilepsy surgery
codes_extratemporal_resective_epilepsy_surgery <- c("61539", "61540")


#################################2006#################################
extratemporal_resective_epilepsy_surgery2006_i <- ms_i_2006 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC1 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC2 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC3 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC4 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC5 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC6 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC7 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC8 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC9 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC10 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC11 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC12 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC13 %in% codes_extratemporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC15 %in% codes_extratemporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

extratemporal_resective_epilepsy_surgery2006_o <- ms_o_2006 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_extratemporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2007#################################
extratemporal_resective_epilepsy_surgery2007_i <- ms_i_2007 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC1 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC2 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC3 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC4 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC5 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC6 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC7 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC8 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC9 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC10 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC11 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC12 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC13 %in% codes_extratemporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC15 %in% codes_extratemporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

extratemporal_resective_epilepsy_surgery2007_o <- ms_o_2007 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_extratemporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2008#################################
extratemporal_resective_epilepsy_surgery2008_i <- ms_i_2008 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC1 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC2 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC3 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC4 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC5 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC6 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC7 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC8 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC9 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC10 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC11 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC12 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC13 %in% codes_extratemporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC15 %in% codes_extratemporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

extratemporal_resective_epilepsy_surgery2008_o <- ms_o_2008 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_extratemporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2009#################################
extratemporal_resective_epilepsy_surgery2009_i <- ms_i_2009 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC1 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC2 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC3 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC4 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC5 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC6 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC7 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC8 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC9 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC10 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC11 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC12 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC13 %in% codes_extratemporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC15 %in% codes_extratemporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

extratemporal_resective_epilepsy_surgery2009_o <- ms_o_2009 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_extratemporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2010#################################
extratemporal_resective_epilepsy_surgery2010_i <- ms_i_2010 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC1 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC2 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC3 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC4 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC5 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC6 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC7 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC8 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC9 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC10 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC11 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC12 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC13 %in% codes_extratemporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC15 %in% codes_extratemporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

extratemporal_resective_epilepsy_surgery2010_o <- ms_o_2010 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_extratemporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2011#################################
extratemporal_resective_epilepsy_surgery2011_i <- ms_i_2011 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC1 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC2 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC3 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC4 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC5 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC6 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC7 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC8 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC9 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC10 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC11 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC12 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC13 %in% codes_extratemporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC15 %in% codes_extratemporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

extratemporal_resective_epilepsy_surgery2011_o <- ms_o_2011 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_extratemporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2012#################################
extratemporal_resective_epilepsy_surgery2012_i <- ms_i_2012 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC1 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC2 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC3 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC4 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC5 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC6 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC7 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC8 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC9 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC10 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC11 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC12 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC13 %in% codes_extratemporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC15 %in% codes_extratemporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

extratemporal_resective_epilepsy_surgery2012_o <- ms_o_2012 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_extratemporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2013#################################
extratemporal_resective_epilepsy_surgery2013_i <- ms_i_2013 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC1 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC2 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC3 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC4 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC5 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC6 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC7 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC8 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC9 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC10 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC11 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC12 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC13 %in% codes_extratemporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC15 %in% codes_extratemporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

extratemporal_resective_epilepsy_surgery2013_o <- ms_o_2013 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_extratemporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2014#################################
extratemporal_resective_epilepsy_surgery2014_i <- ms_i_2014 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC1 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC2 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC3 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC4 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC5 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC6 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC7 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC8 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC9 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC10 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC11 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC12 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC13 %in% codes_extratemporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC15 %in% codes_extratemporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

extratemporal_resective_epilepsy_surgery2014_o <- ms_o_2014 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_extratemporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2015#################################
extratemporal_resective_epilepsy_surgery2015_i <- ms_i_2015 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC1 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC2 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC3 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC4 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC5 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC6 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC7 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC8 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC9 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC10 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC11 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC12 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC13 %in% codes_extratemporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC15 %in% codes_extratemporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

extratemporal_resective_epilepsy_surgery2015_o <- ms_o_2015 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_extratemporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2016#################################
extratemporal_resective_epilepsy_surgery2016_i <- ms_i_2016 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC1 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC2 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC3 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC4 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC5 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC6 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC7 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC8 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC9 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC10 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC11 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC12 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC13 %in% codes_extratemporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC15 %in% codes_extratemporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

extratemporal_resective_epilepsy_surgery2016_o <- ms_o_2016 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_extratemporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2017#################################
extratemporal_resective_epilepsy_surgery2017_i <- ms_i_2017 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC1 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC2 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC3 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC4 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC5 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC6 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC7 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC8 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC9 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC10 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC11 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC12 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC13 %in% codes_extratemporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC15 %in% codes_extratemporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

extratemporal_resective_epilepsy_surgery2017_o <- ms_o_2017 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_extratemporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2018#################################
extratemporal_resective_epilepsy_surgery2018_i <- ms_i_2018 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC1 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC2 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC3 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC4 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC5 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC6 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC7 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC8 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC9 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC10 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC11 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC12 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC13 %in% codes_extratemporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC15 %in% codes_extratemporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

extratemporal_resective_epilepsy_surgery2018_o <- ms_o_2018 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_extratemporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2019#################################
extratemporal_resective_epilepsy_surgery2019_i <- ms_i_2019 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC1 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC2 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC3 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC4 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC5 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC6 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC7 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC8 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC9 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC10 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC11 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC12 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC13 %in% codes_extratemporal_resective_epilepsy_surgery |  
  PROC14 %in% codes_extratemporal_resective_epilepsy_surgery |
  PROC15 %in% codes_extratemporal_resective_epilepsy_surgery
  ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

extratemporal_resective_epilepsy_surgery2019_o <- ms_o_2019 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_extratemporal_resective_epilepsy_surgery
                                     ) %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


# Extratemporal resective epilepsy surgery
extratemporal_resective_epilepsy_surgery <- bind_rows(extratemporal_resective_epilepsy_surgery2006_i, extratemporal_resective_epilepsy_surgery2006_o, extratemporal_resective_epilepsy_surgery2007_i, extratemporal_resective_epilepsy_surgery2007_o, extratemporal_resective_epilepsy_surgery2008_i, extratemporal_resective_epilepsy_surgery2008_o, extratemporal_resective_epilepsy_surgery2009_i, extratemporal_resective_epilepsy_surgery2009_o, extratemporal_resective_epilepsy_surgery2010_i, extratemporal_resective_epilepsy_surgery2010_o, extratemporal_resective_epilepsy_surgery2011_i, extratemporal_resective_epilepsy_surgery2011_o, extratemporal_resective_epilepsy_surgery2012_i, extratemporal_resective_epilepsy_surgery2012_o, extratemporal_resective_epilepsy_surgery2013_i, extratemporal_resective_epilepsy_surgery2013_o, extratemporal_resective_epilepsy_surgery2014_i, extratemporal_resective_epilepsy_surgery2014_o, extratemporal_resective_epilepsy_surgery2015_i, extratemporal_resective_epilepsy_surgery2015_o, extratemporal_resective_epilepsy_surgery2016_i, extratemporal_resective_epilepsy_surgery2016_o, extratemporal_resective_epilepsy_surgery2017_i, extratemporal_resective_epilepsy_surgery2017_o, extratemporal_resective_epilepsy_surgery2018_i, extratemporal_resective_epilepsy_surgery2018_o, extratemporal_resective_epilepsy_surgery2019_i, extratemporal_resective_epilepsy_surgery2019_o) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  arrange(SVCDATE, .by_group=TRUE) %>% 
  mutate(difference_between_surgeries=SVCDATE - lag(SVCDATE, 1))

# Individual extratemporal resective epilepsy surgeries
surgeries_extratemporal_resective_epilepsy_surgery_n <- extratemporal_resective_epilepsy_surgery %>% distinct(ENROLID, SVCDATE) %>% nrow()
surgeries_extratemporal_resective_epilepsy_surgery_n 

# Individual patients with extratemporal resective epilepsy surgery
patients_extratemporal_resective_epilepsy_surgery_n <- extratemporal_resective_epilepsy_surgery %>% distinct(ENROLID) %>% nrow()
patients_extratemporal_resective_epilepsy_surgery_n 

# Tally of patients with more than one extratemporal resective epilepsy surgery
tally_extratemporal_resective_epilepsy_surgery <- extratemporal_resective_epilepsy_surgery %>% group_by(ENROLID) %>% tally(name="number_surgeries")  %>% group_by(number_surgeries) %>% tally(name="number_patients")
tally_extratemporal_resective_epilepsy_surgery

# Period between individual surgeries in patients with repeated surgeries
period_between_extratemporal_resective_epilepsy_surgeries <- summary(as.numeric(extratemporal_resective_epilepsy_surgery$difference_between_surgeries))
period_between_extratemporal_resective_epilepsy_surgeries
```




Total numbers of patients with temporal and extratemporal resective epilepsy surgery
```{r}
patients_temporal_no_extratemporal_resective_epilepsy_surgery_n <-  temporal_resective_epilepsy_surgery$ENROLID[!(temporal_resective_epilepsy_surgery$ENROLID %in% extratemporal_resective_epilepsy_surgery$ENROLID)] %>% unique() %>% length()
patients_temporal_no_extratemporal_resective_epilepsy_surgery_n

patients_extratemporal_no_temporal_resective_epilepsy_surgery_n <-  extratemporal_resective_epilepsy_surgery$ENROLID[!(temporal_resective_epilepsy_surgery$ENROLID %in% extratemporal_resective_epilepsy_surgery$ENROLID)] %>% unique() %>% length()
patients_extratemporal_no_temporal_resective_epilepsy_surgery_n

patients_temporal_and_extratemporal_resective_epilepsy_surgery_n <- temporal_resective_epilepsy_surgery$ENROLID[temporal_resective_epilepsy_surgery$ENROLID %in% extratemporal_resective_epilepsy_surgery$ENROLID] %>% unique() %>% length()
patients_temporal_and_extratemporal_resective_epilepsy_surgery_n
```




Identify patients with corpus callosotomy
```{r}
# Codes for patients with corpus callosotomy
codes_corpus_callosotomy <- c("61541")


#################################2006#################################
corpus_callosotomy2006_i <- ms_i_2006 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_corpus_callosotomy |
  PROC1 %in% codes_corpus_callosotomy |
  PROC2 %in% codes_corpus_callosotomy |
  PROC3 %in% codes_corpus_callosotomy |
  PROC4 %in% codes_corpus_callosotomy |
  PROC5 %in% codes_corpus_callosotomy |
  PROC6 %in% codes_corpus_callosotomy |
  PROC7 %in% codes_corpus_callosotomy |
  PROC8 %in% codes_corpus_callosotomy |
  PROC9 %in% codes_corpus_callosotomy |
  PROC10 %in% codes_corpus_callosotomy |
  PROC11 %in% codes_corpus_callosotomy |
  PROC12 %in% codes_corpus_callosotomy |
  PROC13 %in% codes_corpus_callosotomy |  
  PROC14 %in% codes_corpus_callosotomy |
  PROC15 %in% codes_corpus_callosotomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

corpus_callosotomy2006_o <- ms_o_2006 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_corpus_callosotomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2007#################################
corpus_callosotomy2007_i <- ms_i_2007 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_corpus_callosotomy |
  PROC1 %in% codes_corpus_callosotomy |
  PROC2 %in% codes_corpus_callosotomy |
  PROC3 %in% codes_corpus_callosotomy |
  PROC4 %in% codes_corpus_callosotomy |
  PROC5 %in% codes_corpus_callosotomy |
  PROC6 %in% codes_corpus_callosotomy |
  PROC7 %in% codes_corpus_callosotomy |
  PROC8 %in% codes_corpus_callosotomy |
  PROC9 %in% codes_corpus_callosotomy |
  PROC10 %in% codes_corpus_callosotomy |
  PROC11 %in% codes_corpus_callosotomy |
  PROC12 %in% codes_corpus_callosotomy |
  PROC13 %in% codes_corpus_callosotomy |  
  PROC14 %in% codes_corpus_callosotomy |
  PROC15 %in% codes_corpus_callosotomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

corpus_callosotomy2007_o <- ms_o_2007 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_corpus_callosotomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2008#################################
corpus_callosotomy2008_i <- ms_i_2008 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_corpus_callosotomy |
  PROC1 %in% codes_corpus_callosotomy |
  PROC2 %in% codes_corpus_callosotomy |
  PROC3 %in% codes_corpus_callosotomy |
  PROC4 %in% codes_corpus_callosotomy |
  PROC5 %in% codes_corpus_callosotomy |
  PROC6 %in% codes_corpus_callosotomy |
  PROC7 %in% codes_corpus_callosotomy |
  PROC8 %in% codes_corpus_callosotomy |
  PROC9 %in% codes_corpus_callosotomy |
  PROC10 %in% codes_corpus_callosotomy |
  PROC11 %in% codes_corpus_callosotomy |
  PROC12 %in% codes_corpus_callosotomy |
  PROC13 %in% codes_corpus_callosotomy |  
  PROC14 %in% codes_corpus_callosotomy |
  PROC15 %in% codes_corpus_callosotomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

corpus_callosotomy2008_o <- ms_o_2008 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_corpus_callosotomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2009#################################
corpus_callosotomy2009_i <- ms_i_2009 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_corpus_callosotomy |
  PROC1 %in% codes_corpus_callosotomy |
  PROC2 %in% codes_corpus_callosotomy |
  PROC3 %in% codes_corpus_callosotomy |
  PROC4 %in% codes_corpus_callosotomy |
  PROC5 %in% codes_corpus_callosotomy |
  PROC6 %in% codes_corpus_callosotomy |
  PROC7 %in% codes_corpus_callosotomy |
  PROC8 %in% codes_corpus_callosotomy |
  PROC9 %in% codes_corpus_callosotomy |
  PROC10 %in% codes_corpus_callosotomy |
  PROC11 %in% codes_corpus_callosotomy |
  PROC12 %in% codes_corpus_callosotomy |
  PROC13 %in% codes_corpus_callosotomy |  
  PROC14 %in% codes_corpus_callosotomy |
  PROC15 %in% codes_corpus_callosotomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

corpus_callosotomy2009_o <- ms_o_2009 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_corpus_callosotomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2010#################################
corpus_callosotomy2010_i <- ms_i_2010 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_corpus_callosotomy |
  PROC1 %in% codes_corpus_callosotomy |
  PROC2 %in% codes_corpus_callosotomy |
  PROC3 %in% codes_corpus_callosotomy |
  PROC4 %in% codes_corpus_callosotomy |
  PROC5 %in% codes_corpus_callosotomy |
  PROC6 %in% codes_corpus_callosotomy |
  PROC7 %in% codes_corpus_callosotomy |
  PROC8 %in% codes_corpus_callosotomy |
  PROC9 %in% codes_corpus_callosotomy |
  PROC10 %in% codes_corpus_callosotomy |
  PROC11 %in% codes_corpus_callosotomy |
  PROC12 %in% codes_corpus_callosotomy |
  PROC13 %in% codes_corpus_callosotomy |  
  PROC14 %in% codes_corpus_callosotomy |
  PROC15 %in% codes_corpus_callosotomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

corpus_callosotomy2010_o <- ms_o_2010 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_corpus_callosotomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2011#################################
corpus_callosotomy2011_i <- ms_i_2011 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_corpus_callosotomy |
  PROC1 %in% codes_corpus_callosotomy |
  PROC2 %in% codes_corpus_callosotomy |
  PROC3 %in% codes_corpus_callosotomy |
  PROC4 %in% codes_corpus_callosotomy |
  PROC5 %in% codes_corpus_callosotomy |
  PROC6 %in% codes_corpus_callosotomy |
  PROC7 %in% codes_corpus_callosotomy |
  PROC8 %in% codes_corpus_callosotomy |
  PROC9 %in% codes_corpus_callosotomy |
  PROC10 %in% codes_corpus_callosotomy |
  PROC11 %in% codes_corpus_callosotomy |
  PROC12 %in% codes_corpus_callosotomy |
  PROC13 %in% codes_corpus_callosotomy |  
  PROC14 %in% codes_corpus_callosotomy |
  PROC15 %in% codes_corpus_callosotomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

corpus_callosotomy2011_o <- ms_o_2011 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_corpus_callosotomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2012#################################
corpus_callosotomy2012_i <- ms_i_2012 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_corpus_callosotomy |
  PROC1 %in% codes_corpus_callosotomy |
  PROC2 %in% codes_corpus_callosotomy |
  PROC3 %in% codes_corpus_callosotomy |
  PROC4 %in% codes_corpus_callosotomy |
  PROC5 %in% codes_corpus_callosotomy |
  PROC6 %in% codes_corpus_callosotomy |
  PROC7 %in% codes_corpus_callosotomy |
  PROC8 %in% codes_corpus_callosotomy |
  PROC9 %in% codes_corpus_callosotomy |
  PROC10 %in% codes_corpus_callosotomy |
  PROC11 %in% codes_corpus_callosotomy |
  PROC12 %in% codes_corpus_callosotomy |
  PROC13 %in% codes_corpus_callosotomy |  
  PROC14 %in% codes_corpus_callosotomy |
  PROC15 %in% codes_corpus_callosotomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

corpus_callosotomy2012_o <- ms_o_2012 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_corpus_callosotomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2013#################################
corpus_callosotomy2013_i <- ms_i_2013 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_corpus_callosotomy |
  PROC1 %in% codes_corpus_callosotomy |
  PROC2 %in% codes_corpus_callosotomy |
  PROC3 %in% codes_corpus_callosotomy |
  PROC4 %in% codes_corpus_callosotomy |
  PROC5 %in% codes_corpus_callosotomy |
  PROC6 %in% codes_corpus_callosotomy |
  PROC7 %in% codes_corpus_callosotomy |
  PROC8 %in% codes_corpus_callosotomy |
  PROC9 %in% codes_corpus_callosotomy |
  PROC10 %in% codes_corpus_callosotomy |
  PROC11 %in% codes_corpus_callosotomy |
  PROC12 %in% codes_corpus_callosotomy |
  PROC13 %in% codes_corpus_callosotomy |  
  PROC14 %in% codes_corpus_callosotomy |
  PROC15 %in% codes_corpus_callosotomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

corpus_callosotomy2013_o <- ms_o_2013 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_corpus_callosotomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2014#################################
corpus_callosotomy2014_i <- ms_i_2014 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_corpus_callosotomy |
  PROC1 %in% codes_corpus_callosotomy |
  PROC2 %in% codes_corpus_callosotomy |
  PROC3 %in% codes_corpus_callosotomy |
  PROC4 %in% codes_corpus_callosotomy |
  PROC5 %in% codes_corpus_callosotomy |
  PROC6 %in% codes_corpus_callosotomy |
  PROC7 %in% codes_corpus_callosotomy |
  PROC8 %in% codes_corpus_callosotomy |
  PROC9 %in% codes_corpus_callosotomy |
  PROC10 %in% codes_corpus_callosotomy |
  PROC11 %in% codes_corpus_callosotomy |
  PROC12 %in% codes_corpus_callosotomy |
  PROC13 %in% codes_corpus_callosotomy |  
  PROC14 %in% codes_corpus_callosotomy |
  PROC15 %in% codes_corpus_callosotomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

corpus_callosotomy2014_o <- ms_o_2014 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_corpus_callosotomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2015#################################
corpus_callosotomy2015_i <- ms_i_2015 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_corpus_callosotomy |
  PROC1 %in% codes_corpus_callosotomy |
  PROC2 %in% codes_corpus_callosotomy |
  PROC3 %in% codes_corpus_callosotomy |
  PROC4 %in% codes_corpus_callosotomy |
  PROC5 %in% codes_corpus_callosotomy |
  PROC6 %in% codes_corpus_callosotomy |
  PROC7 %in% codes_corpus_callosotomy |
  PROC8 %in% codes_corpus_callosotomy |
  PROC9 %in% codes_corpus_callosotomy |
  PROC10 %in% codes_corpus_callosotomy |
  PROC11 %in% codes_corpus_callosotomy |
  PROC12 %in% codes_corpus_callosotomy |
  PROC13 %in% codes_corpus_callosotomy |  
  PROC14 %in% codes_corpus_callosotomy |
  PROC15 %in% codes_corpus_callosotomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

corpus_callosotomy2015_o <- ms_o_2015 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_corpus_callosotomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2016#################################
corpus_callosotomy2016_i <- ms_i_2016 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_corpus_callosotomy |
  PROC1 %in% codes_corpus_callosotomy |
  PROC2 %in% codes_corpus_callosotomy |
  PROC3 %in% codes_corpus_callosotomy |
  PROC4 %in% codes_corpus_callosotomy |
  PROC5 %in% codes_corpus_callosotomy |
  PROC6 %in% codes_corpus_callosotomy |
  PROC7 %in% codes_corpus_callosotomy |
  PROC8 %in% codes_corpus_callosotomy |
  PROC9 %in% codes_corpus_callosotomy |
  PROC10 %in% codes_corpus_callosotomy |
  PROC11 %in% codes_corpus_callosotomy |
  PROC12 %in% codes_corpus_callosotomy |
  PROC13 %in% codes_corpus_callosotomy |  
  PROC14 %in% codes_corpus_callosotomy |
  PROC15 %in% codes_corpus_callosotomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

corpus_callosotomy2016_o <- ms_o_2016 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_corpus_callosotomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2017#################################
corpus_callosotomy2017_i <- ms_i_2017 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_corpus_callosotomy |
  PROC1 %in% codes_corpus_callosotomy |
  PROC2 %in% codes_corpus_callosotomy |
  PROC3 %in% codes_corpus_callosotomy |
  PROC4 %in% codes_corpus_callosotomy |
  PROC5 %in% codes_corpus_callosotomy |
  PROC6 %in% codes_corpus_callosotomy |
  PROC7 %in% codes_corpus_callosotomy |
  PROC8 %in% codes_corpus_callosotomy |
  PROC9 %in% codes_corpus_callosotomy |
  PROC10 %in% codes_corpus_callosotomy |
  PROC11 %in% codes_corpus_callosotomy |
  PROC12 %in% codes_corpus_callosotomy |
  PROC13 %in% codes_corpus_callosotomy |  
  PROC14 %in% codes_corpus_callosotomy |
  PROC15 %in% codes_corpus_callosotomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

corpus_callosotomy2017_o <- ms_o_2017 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_corpus_callosotomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2018#################################
corpus_callosotomy2018_i <- ms_i_2018 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_corpus_callosotomy |
  PROC1 %in% codes_corpus_callosotomy |
  PROC2 %in% codes_corpus_callosotomy |
  PROC3 %in% codes_corpus_callosotomy |
  PROC4 %in% codes_corpus_callosotomy |
  PROC5 %in% codes_corpus_callosotomy |
  PROC6 %in% codes_corpus_callosotomy |
  PROC7 %in% codes_corpus_callosotomy |
  PROC8 %in% codes_corpus_callosotomy |
  PROC9 %in% codes_corpus_callosotomy |
  PROC10 %in% codes_corpus_callosotomy |
  PROC11 %in% codes_corpus_callosotomy |
  PROC12 %in% codes_corpus_callosotomy |
  PROC13 %in% codes_corpus_callosotomy |  
  PROC14 %in% codes_corpus_callosotomy |
  PROC15 %in% codes_corpus_callosotomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

corpus_callosotomy2018_o <- ms_o_2018 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_corpus_callosotomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2019#################################
corpus_callosotomy2019_i <- ms_i_2019 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_corpus_callosotomy |
  PROC1 %in% codes_corpus_callosotomy |
  PROC2 %in% codes_corpus_callosotomy |
  PROC3 %in% codes_corpus_callosotomy |
  PROC4 %in% codes_corpus_callosotomy |
  PROC5 %in% codes_corpus_callosotomy |
  PROC6 %in% codes_corpus_callosotomy |
  PROC7 %in% codes_corpus_callosotomy |
  PROC8 %in% codes_corpus_callosotomy |
  PROC9 %in% codes_corpus_callosotomy |
  PROC10 %in% codes_corpus_callosotomy |
  PROC11 %in% codes_corpus_callosotomy |
  PROC12 %in% codes_corpus_callosotomy |
  PROC13 %in% codes_corpus_callosotomy |  
  PROC14 %in% codes_corpus_callosotomy |
  PROC15 %in% codes_corpus_callosotomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

corpus_callosotomy2019_o <- ms_o_2019 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_corpus_callosotomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


# Corpus callosotomy
corpus_callosotomy <- bind_rows(corpus_callosotomy2006_i, corpus_callosotomy2006_o, corpus_callosotomy2007_i, corpus_callosotomy2007_o, corpus_callosotomy2008_i, corpus_callosotomy2008_o, corpus_callosotomy2009_i, corpus_callosotomy2009_o, corpus_callosotomy2010_i, corpus_callosotomy2010_o, corpus_callosotomy2011_i, corpus_callosotomy2011_o, corpus_callosotomy2012_i, corpus_callosotomy2012_o, corpus_callosotomy2013_i, corpus_callosotomy2013_o, corpus_callosotomy2014_i, corpus_callosotomy2014_o, corpus_callosotomy2015_i, corpus_callosotomy2015_o, corpus_callosotomy2016_i, corpus_callosotomy2016_o, corpus_callosotomy2017_i, corpus_callosotomy2017_o, corpus_callosotomy2018_i, corpus_callosotomy2018_o, corpus_callosotomy2019_i, corpus_callosotomy2019_o) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  arrange(SVCDATE, .by_group=TRUE) %>% 
  mutate(difference_between_surgeries=SVCDATE - lag(SVCDATE, 1))

# Individual corpus callosotomies
surgeries_corpus_callosotomy_n <- corpus_callosotomy %>% distinct(ENROLID, SVCDATE) %>% nrow()
surgeries_corpus_callosotomy_n 

# Individual patients with corpus callosotomies
patients_corpus_callosotomy_n <- corpus_callosotomy %>% distinct(ENROLID) %>% nrow()
patients_corpus_callosotomy_n 

# Tally of patients with more than one corpus callosotomy
tally_corpus_callosotomy <- corpus_callosotomy %>% group_by(ENROLID) %>% tally(name="number_surgeries")  %>% group_by(number_surgeries) %>% tally(name="number_patients")
tally_corpus_callosotomy

# Period between individual surgeries in patients with repeated surgeries
period_between_corpus_callosotomies <- summary(as.numeric(corpus_callosotomy$difference_between_surgeries))
period_between_corpus_callosotomies
```




 Identify patients with hemispherectomy
```{r}
# Codes for patients with hemispherectomy
codes_hemispherectomy <- c("61542", "61543")


#################################2006#################################
hemispherectomy2006_i <- ms_i_2006 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_hemispherectomy |
  PROC1 %in% codes_hemispherectomy |
  PROC2 %in% codes_hemispherectomy |
  PROC3 %in% codes_hemispherectomy |
  PROC4 %in% codes_hemispherectomy |
  PROC5 %in% codes_hemispherectomy |
  PROC6 %in% codes_hemispherectomy |
  PROC7 %in% codes_hemispherectomy |
  PROC8 %in% codes_hemispherectomy |
  PROC9 %in% codes_hemispherectomy |
  PROC10 %in% codes_hemispherectomy |
  PROC11 %in% codes_hemispherectomy |
  PROC12 %in% codes_hemispherectomy |
  PROC13 %in% codes_hemispherectomy |  
  PROC14 %in% codes_hemispherectomy |
  PROC15 %in% codes_hemispherectomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

hemispherectomy2006_o <- ms_o_2006 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_hemispherectomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2007#################################
hemispherectomy2007_i <- ms_i_2007 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_hemispherectomy |
  PROC1 %in% codes_hemispherectomy |
  PROC2 %in% codes_hemispherectomy |
  PROC3 %in% codes_hemispherectomy |
  PROC4 %in% codes_hemispherectomy |
  PROC5 %in% codes_hemispherectomy |
  PROC6 %in% codes_hemispherectomy |
  PROC7 %in% codes_hemispherectomy |
  PROC8 %in% codes_hemispherectomy |
  PROC9 %in% codes_hemispherectomy |
  PROC10 %in% codes_hemispherectomy |
  PROC11 %in% codes_hemispherectomy |
  PROC12 %in% codes_hemispherectomy |
  PROC13 %in% codes_hemispherectomy |  
  PROC14 %in% codes_hemispherectomy |
  PROC15 %in% codes_hemispherectomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

hemispherectomy2007_o <- ms_o_2007 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_hemispherectomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2008#################################
hemispherectomy2008_i <- ms_i_2008 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_hemispherectomy |
  PROC1 %in% codes_hemispherectomy |
  PROC2 %in% codes_hemispherectomy |
  PROC3 %in% codes_hemispherectomy |
  PROC4 %in% codes_hemispherectomy |
  PROC5 %in% codes_hemispherectomy |
  PROC6 %in% codes_hemispherectomy |
  PROC7 %in% codes_hemispherectomy |
  PROC8 %in% codes_hemispherectomy |
  PROC9 %in% codes_hemispherectomy |
  PROC10 %in% codes_hemispherectomy |
  PROC11 %in% codes_hemispherectomy |
  PROC12 %in% codes_hemispherectomy |
  PROC13 %in% codes_hemispherectomy |  
  PROC14 %in% codes_hemispherectomy |
  PROC15 %in% codes_hemispherectomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

hemispherectomy2008_o <- ms_o_2008 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_hemispherectomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2009#################################
hemispherectomy2009_i <- ms_i_2009 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_hemispherectomy |
  PROC1 %in% codes_hemispherectomy |
  PROC2 %in% codes_hemispherectomy |
  PROC3 %in% codes_hemispherectomy |
  PROC4 %in% codes_hemispherectomy |
  PROC5 %in% codes_hemispherectomy |
  PROC6 %in% codes_hemispherectomy |
  PROC7 %in% codes_hemispherectomy |
  PROC8 %in% codes_hemispherectomy |
  PROC9 %in% codes_hemispherectomy |
  PROC10 %in% codes_hemispherectomy |
  PROC11 %in% codes_hemispherectomy |
  PROC12 %in% codes_hemispherectomy |
  PROC13 %in% codes_hemispherectomy |  
  PROC14 %in% codes_hemispherectomy |
  PROC15 %in% codes_hemispherectomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

hemispherectomy2009_o <- ms_o_2009 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_hemispherectomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2010#################################
hemispherectomy2010_i <- ms_i_2010 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_hemispherectomy |
  PROC1 %in% codes_hemispherectomy |
  PROC2 %in% codes_hemispherectomy |
  PROC3 %in% codes_hemispherectomy |
  PROC4 %in% codes_hemispherectomy |
  PROC5 %in% codes_hemispherectomy |
  PROC6 %in% codes_hemispherectomy |
  PROC7 %in% codes_hemispherectomy |
  PROC8 %in% codes_hemispherectomy |
  PROC9 %in% codes_hemispherectomy |
  PROC10 %in% codes_hemispherectomy |
  PROC11 %in% codes_hemispherectomy |
  PROC12 %in% codes_hemispherectomy |
  PROC13 %in% codes_hemispherectomy |  
  PROC14 %in% codes_hemispherectomy |
  PROC15 %in% codes_hemispherectomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

hemispherectomy2010_o <- ms_o_2010 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_hemispherectomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2011#################################
hemispherectomy2011_i <- ms_i_2011 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_hemispherectomy |
  PROC1 %in% codes_hemispherectomy |
  PROC2 %in% codes_hemispherectomy |
  PROC3 %in% codes_hemispherectomy |
  PROC4 %in% codes_hemispherectomy |
  PROC5 %in% codes_hemispherectomy |
  PROC6 %in% codes_hemispherectomy |
  PROC7 %in% codes_hemispherectomy |
  PROC8 %in% codes_hemispherectomy |
  PROC9 %in% codes_hemispherectomy |
  PROC10 %in% codes_hemispherectomy |
  PROC11 %in% codes_hemispherectomy |
  PROC12 %in% codes_hemispherectomy |
  PROC13 %in% codes_hemispherectomy |  
  PROC14 %in% codes_hemispherectomy |
  PROC15 %in% codes_hemispherectomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

hemispherectomy2011_o <- ms_o_2011 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_hemispherectomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2012#################################
hemispherectomy2012_i <- ms_i_2012 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_hemispherectomy |
  PROC1 %in% codes_hemispherectomy |
  PROC2 %in% codes_hemispherectomy |
  PROC3 %in% codes_hemispherectomy |
  PROC4 %in% codes_hemispherectomy |
  PROC5 %in% codes_hemispherectomy |
  PROC6 %in% codes_hemispherectomy |
  PROC7 %in% codes_hemispherectomy |
  PROC8 %in% codes_hemispherectomy |
  PROC9 %in% codes_hemispherectomy |
  PROC10 %in% codes_hemispherectomy |
  PROC11 %in% codes_hemispherectomy |
  PROC12 %in% codes_hemispherectomy |
  PROC13 %in% codes_hemispherectomy |  
  PROC14 %in% codes_hemispherectomy |
  PROC15 %in% codes_hemispherectomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

hemispherectomy2012_o <- ms_o_2012 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_hemispherectomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2013#################################
hemispherectomy2013_i <- ms_i_2013 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_hemispherectomy |
  PROC1 %in% codes_hemispherectomy |
  PROC2 %in% codes_hemispherectomy |
  PROC3 %in% codes_hemispherectomy |
  PROC4 %in% codes_hemispherectomy |
  PROC5 %in% codes_hemispherectomy |
  PROC6 %in% codes_hemispherectomy |
  PROC7 %in% codes_hemispherectomy |
  PROC8 %in% codes_hemispherectomy |
  PROC9 %in% codes_hemispherectomy |
  PROC10 %in% codes_hemispherectomy |
  PROC11 %in% codes_hemispherectomy |
  PROC12 %in% codes_hemispherectomy |
  PROC13 %in% codes_hemispherectomy |  
  PROC14 %in% codes_hemispherectomy |
  PROC15 %in% codes_hemispherectomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

hemispherectomy2013_o <- ms_o_2013 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_hemispherectomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2014#################################
hemispherectomy2014_i <- ms_i_2014 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_hemispherectomy |
  PROC1 %in% codes_hemispherectomy |
  PROC2 %in% codes_hemispherectomy |
  PROC3 %in% codes_hemispherectomy |
  PROC4 %in% codes_hemispherectomy |
  PROC5 %in% codes_hemispherectomy |
  PROC6 %in% codes_hemispherectomy |
  PROC7 %in% codes_hemispherectomy |
  PROC8 %in% codes_hemispherectomy |
  PROC9 %in% codes_hemispherectomy |
  PROC10 %in% codes_hemispherectomy |
  PROC11 %in% codes_hemispherectomy |
  PROC12 %in% codes_hemispherectomy |
  PROC13 %in% codes_hemispherectomy |  
  PROC14 %in% codes_hemispherectomy |
  PROC15 %in% codes_hemispherectomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

hemispherectomy2014_o <- ms_o_2014 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_hemispherectomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2015#################################
hemispherectomy2015_i <- ms_i_2015 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_hemispherectomy |
  PROC1 %in% codes_hemispherectomy |
  PROC2 %in% codes_hemispherectomy |
  PROC3 %in% codes_hemispherectomy |
  PROC4 %in% codes_hemispherectomy |
  PROC5 %in% codes_hemispherectomy |
  PROC6 %in% codes_hemispherectomy |
  PROC7 %in% codes_hemispherectomy |
  PROC8 %in% codes_hemispherectomy |
  PROC9 %in% codes_hemispherectomy |
  PROC10 %in% codes_hemispherectomy |
  PROC11 %in% codes_hemispherectomy |
  PROC12 %in% codes_hemispherectomy |
  PROC13 %in% codes_hemispherectomy |  
  PROC14 %in% codes_hemispherectomy |
  PROC15 %in% codes_hemispherectomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

hemispherectomy2015_o <- ms_o_2015 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_hemispherectomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2016#################################
hemispherectomy2016_i <- ms_i_2016 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_hemispherectomy |
  PROC1 %in% codes_hemispherectomy |
  PROC2 %in% codes_hemispherectomy |
  PROC3 %in% codes_hemispherectomy |
  PROC4 %in% codes_hemispherectomy |
  PROC5 %in% codes_hemispherectomy |
  PROC6 %in% codes_hemispherectomy |
  PROC7 %in% codes_hemispherectomy |
  PROC8 %in% codes_hemispherectomy |
  PROC9 %in% codes_hemispherectomy |
  PROC10 %in% codes_hemispherectomy |
  PROC11 %in% codes_hemispherectomy |
  PROC12 %in% codes_hemispherectomy |
  PROC13 %in% codes_hemispherectomy |  
  PROC14 %in% codes_hemispherectomy |
  PROC15 %in% codes_hemispherectomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

hemispherectomy2016_o <- ms_o_2016 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_hemispherectomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2017#################################
hemispherectomy2017_i <- ms_i_2017 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_hemispherectomy |
  PROC1 %in% codes_hemispherectomy |
  PROC2 %in% codes_hemispherectomy |
  PROC3 %in% codes_hemispherectomy |
  PROC4 %in% codes_hemispherectomy |
  PROC5 %in% codes_hemispherectomy |
  PROC6 %in% codes_hemispherectomy |
  PROC7 %in% codes_hemispherectomy |
  PROC8 %in% codes_hemispherectomy |
  PROC9 %in% codes_hemispherectomy |
  PROC10 %in% codes_hemispherectomy |
  PROC11 %in% codes_hemispherectomy |
  PROC12 %in% codes_hemispherectomy |
  PROC13 %in% codes_hemispherectomy |  
  PROC14 %in% codes_hemispherectomy |
  PROC15 %in% codes_hemispherectomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

hemispherectomy2017_o <- ms_o_2017 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_hemispherectomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2018#################################
hemispherectomy2018_i <- ms_i_2018 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_hemispherectomy |
  PROC1 %in% codes_hemispherectomy |
  PROC2 %in% codes_hemispherectomy |
  PROC3 %in% codes_hemispherectomy |
  PROC4 %in% codes_hemispherectomy |
  PROC5 %in% codes_hemispherectomy |
  PROC6 %in% codes_hemispherectomy |
  PROC7 %in% codes_hemispherectomy |
  PROC8 %in% codes_hemispherectomy |
  PROC9 %in% codes_hemispherectomy |
  PROC10 %in% codes_hemispherectomy |
  PROC11 %in% codes_hemispherectomy |
  PROC12 %in% codes_hemispherectomy |
  PROC13 %in% codes_hemispherectomy |  
  PROC14 %in% codes_hemispherectomy |
  PROC15 %in% codes_hemispherectomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

hemispherectomy2018_o <- ms_o_2018 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_hemispherectomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2019#################################
hemispherectomy2019_i <- ms_i_2019 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_hemispherectomy |
  PROC1 %in% codes_hemispherectomy |
  PROC2 %in% codes_hemispherectomy |
  PROC3 %in% codes_hemispherectomy |
  PROC4 %in% codes_hemispherectomy |
  PROC5 %in% codes_hemispherectomy |
  PROC6 %in% codes_hemispherectomy |
  PROC7 %in% codes_hemispherectomy |
  PROC8 %in% codes_hemispherectomy |
  PROC9 %in% codes_hemispherectomy |
  PROC10 %in% codes_hemispherectomy |
  PROC11 %in% codes_hemispherectomy |
  PROC12 %in% codes_hemispherectomy |
  PROC13 %in% codes_hemispherectomy |  
  PROC14 %in% codes_hemispherectomy |
  PROC15 %in% codes_hemispherectomy
  ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

hemispherectomy2019_o <- ms_o_2019 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_hemispherectomy
                                     ) %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


# Hemispherectomy
hemispherectomy <- bind_rows(hemispherectomy2006_i, hemispherectomy2006_o, hemispherectomy2007_i, hemispherectomy2007_o, hemispherectomy2008_i, hemispherectomy2008_o, hemispherectomy2009_i, hemispherectomy2009_o, hemispherectomy2010_i, hemispherectomy2010_o, hemispherectomy2011_i, hemispherectomy2011_o, hemispherectomy2012_i, hemispherectomy2012_o, hemispherectomy2013_i, hemispherectomy2013_o, hemispherectomy2014_i, hemispherectomy2014_o, hemispherectomy2015_i, hemispherectomy2015_o, hemispherectomy2016_i, hemispherectomy2016_o, hemispherectomy2017_i, hemispherectomy2017_o, hemispherectomy2018_i, hemispherectomy2018_o, hemispherectomy2019_i, hemispherectomy2019_o) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  arrange(SVCDATE, .by_group=TRUE) %>% 
  mutate(difference_between_surgeries=SVCDATE - lag(SVCDATE, 1))

# Individual hemispherectomies
surgeries_hemispherectomy_n <- hemispherectomy %>% distinct(ENROLID, SVCDATE) %>% nrow()
surgeries_hemispherectomy_n 

# Individual patients with hemispherectomy
patients_hemispherectomy_n <- hemispherectomy %>% distinct(ENROLID) %>% nrow()
patients_hemispherectomy_n 

# Tally of patients with more than one hemispherectomy
tally_hemispherectomy <- hemispherectomy %>% group_by(ENROLID) %>% tally(name="number_surgeries")  %>% group_by(number_surgeries) %>% tally(name="number_patients")
tally_hemispherectomy

# Period between individual surgeries in patients with repeated surgeries
period_between_hemispherectomies <- summary(as.numeric(hemispherectomy$difference_between_surgeries))
period_between_hemispherectomies
```




Total numbers of patients with more than one type of epilepsy surgery
```{r}
patients_resective_epilepsy_surgery_and_hemispherectomy_n <-  resective_epilepsy_surgery$ENROLID[resective_epilepsy_surgery$ENROLID %in% hemispherectomy$ENROLID] %>% unique() %>% length()
patients_resective_epilepsy_surgery_and_hemispherectomy_n

patients_resective_epilepsy_surgery_and_corpus_callosotomy_n <-  resective_epilepsy_surgery$ENROLID[resective_epilepsy_surgery$ENROLID %in% corpus_callosotomy$ENROLID] %>% unique() %>% length()
patients_resective_epilepsy_surgery_and_corpus_callosotomy_n

patients_hemispherectomy_and_corpus_callosotomy_n <- hemispherectomy$ENROLID[hemispherectomy$ENROLID %in% corpus_callosotomy$ENROLID] %>% unique() %>% length()
patients_hemispherectomy_and_corpus_callosotomy_n

patients_resective_epilepsy_surgery_and_hemispherectomy_and_corpus_callosotomy_n <- Reduce(intersect, list(resective_epilepsy_surgery$ENROLID, hemispherectomy$ENROLID, corpus_callosotomy$ENROLID)) %>% unique() %>% length()
patients_resective_epilepsy_surgery_and_hemispherectomy_and_corpus_callosotomy_n
```




Identify patients with subdural long-term monitoring
```{r}
# Codes for patients with subdural long-term monitoring
codes_subdural_EEG <- c("61531", "61533", "61535")


#################################2006#################################
subdural_EEG2006_i <- ms_i_2006 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_subdural_EEG |
  PROC1 %in% codes_subdural_EEG |
  PROC2 %in% codes_subdural_EEG |
  PROC3 %in% codes_subdural_EEG |
  PROC4 %in% codes_subdural_EEG |
  PROC5 %in% codes_subdural_EEG |
  PROC6 %in% codes_subdural_EEG |
  PROC7 %in% codes_subdural_EEG |
  PROC8 %in% codes_subdural_EEG |
  PROC9 %in% codes_subdural_EEG |
  PROC10 %in% codes_subdural_EEG |
  PROC11 %in% codes_subdural_EEG |
  PROC12 %in% codes_subdural_EEG |
  PROC13 %in% codes_subdural_EEG |  
  PROC14 %in% codes_subdural_EEG |
  PROC15 %in% codes_subdural_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

subdural_EEG2006_o <- ms_o_2006 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_subdural_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2007#################################
subdural_EEG2007_i <- ms_i_2007 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_subdural_EEG |
  PROC1 %in% codes_subdural_EEG |
  PROC2 %in% codes_subdural_EEG |
  PROC3 %in% codes_subdural_EEG |
  PROC4 %in% codes_subdural_EEG |
  PROC5 %in% codes_subdural_EEG |
  PROC6 %in% codes_subdural_EEG |
  PROC7 %in% codes_subdural_EEG |
  PROC8 %in% codes_subdural_EEG |
  PROC9 %in% codes_subdural_EEG |
  PROC10 %in% codes_subdural_EEG |
  PROC11 %in% codes_subdural_EEG |
  PROC12 %in% codes_subdural_EEG |
  PROC13 %in% codes_subdural_EEG |  
  PROC14 %in% codes_subdural_EEG |
  PROC15 %in% codes_subdural_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

subdural_EEG2007_o <- ms_o_2007 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_subdural_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2008#################################
subdural_EEG2008_i <- ms_i_2008 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_subdural_EEG |
  PROC1 %in% codes_subdural_EEG |
  PROC2 %in% codes_subdural_EEG |
  PROC3 %in% codes_subdural_EEG |
  PROC4 %in% codes_subdural_EEG |
  PROC5 %in% codes_subdural_EEG |
  PROC6 %in% codes_subdural_EEG |
  PROC7 %in% codes_subdural_EEG |
  PROC8 %in% codes_subdural_EEG |
  PROC9 %in% codes_subdural_EEG |
  PROC10 %in% codes_subdural_EEG |
  PROC11 %in% codes_subdural_EEG |
  PROC12 %in% codes_subdural_EEG |
  PROC13 %in% codes_subdural_EEG |  
  PROC14 %in% codes_subdural_EEG |
  PROC15 %in% codes_subdural_EEG
  ) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

subdural_EEG2008_o <- ms_o_2008 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_subdural_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2009#################################
subdural_EEG2009_i <- ms_i_2009 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_subdural_EEG |
  PROC1 %in% codes_subdural_EEG |
  PROC2 %in% codes_subdural_EEG |
  PROC3 %in% codes_subdural_EEG |
  PROC4 %in% codes_subdural_EEG |
  PROC5 %in% codes_subdural_EEG |
  PROC6 %in% codes_subdural_EEG |
  PROC7 %in% codes_subdural_EEG |
  PROC8 %in% codes_subdural_EEG |
  PROC9 %in% codes_subdural_EEG |
  PROC10 %in% codes_subdural_EEG |
  PROC11 %in% codes_subdural_EEG |
  PROC12 %in% codes_subdural_EEG |
  PROC13 %in% codes_subdural_EEG |  
  PROC14 %in% codes_subdural_EEG |
  PROC15 %in% codes_subdural_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

subdural_EEG2009_o <- ms_o_2009 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_subdural_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2010#################################
subdural_EEG2010_i <- ms_i_2010 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_subdural_EEG |
  PROC1 %in% codes_subdural_EEG |
  PROC2 %in% codes_subdural_EEG |
  PROC3 %in% codes_subdural_EEG |
  PROC4 %in% codes_subdural_EEG |
  PROC5 %in% codes_subdural_EEG |
  PROC6 %in% codes_subdural_EEG |
  PROC7 %in% codes_subdural_EEG |
  PROC8 %in% codes_subdural_EEG |
  PROC9 %in% codes_subdural_EEG |
  PROC10 %in% codes_subdural_EEG |
  PROC11 %in% codes_subdural_EEG |
  PROC12 %in% codes_subdural_EEG |
  PROC13 %in% codes_subdural_EEG |  
  PROC14 %in% codes_subdural_EEG |
  PROC15 %in% codes_subdural_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

subdural_EEG2010_o <- ms_o_2010 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_subdural_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2011#################################
subdural_EEG2011_i <- ms_i_2011 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_subdural_EEG |
  PROC1 %in% codes_subdural_EEG |
  PROC2 %in% codes_subdural_EEG |
  PROC3 %in% codes_subdural_EEG |
  PROC4 %in% codes_subdural_EEG |
  PROC5 %in% codes_subdural_EEG |
  PROC6 %in% codes_subdural_EEG |
  PROC7 %in% codes_subdural_EEG |
  PROC8 %in% codes_subdural_EEG |
  PROC9 %in% codes_subdural_EEG |
  PROC10 %in% codes_subdural_EEG |
  PROC11 %in% codes_subdural_EEG |
  PROC12 %in% codes_subdural_EEG |
  PROC13 %in% codes_subdural_EEG |  
  PROC14 %in% codes_subdural_EEG |
  PROC15 %in% codes_subdural_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

subdural_EEG2011_o <- ms_o_2011 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_subdural_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2012#################################
subdural_EEG2012_i <- ms_i_2012 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_subdural_EEG |
  PROC1 %in% codes_subdural_EEG |
  PROC2 %in% codes_subdural_EEG |
  PROC3 %in% codes_subdural_EEG |
  PROC4 %in% codes_subdural_EEG |
  PROC5 %in% codes_subdural_EEG |
  PROC6 %in% codes_subdural_EEG |
  PROC7 %in% codes_subdural_EEG |
  PROC8 %in% codes_subdural_EEG |
  PROC9 %in% codes_subdural_EEG |
  PROC10 %in% codes_subdural_EEG |
  PROC11 %in% codes_subdural_EEG |
  PROC12 %in% codes_subdural_EEG |
  PROC13 %in% codes_subdural_EEG |  
  PROC14 %in% codes_subdural_EEG |
  PROC15 %in% codes_subdural_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

subdural_EEG2012_o <- ms_o_2012 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_subdural_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2013#################################
subdural_EEG2013_i <- ms_i_2013 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_subdural_EEG |
  PROC1 %in% codes_subdural_EEG |
  PROC2 %in% codes_subdural_EEG |
  PROC3 %in% codes_subdural_EEG |
  PROC4 %in% codes_subdural_EEG |
  PROC5 %in% codes_subdural_EEG |
  PROC6 %in% codes_subdural_EEG |
  PROC7 %in% codes_subdural_EEG |
  PROC8 %in% codes_subdural_EEG |
  PROC9 %in% codes_subdural_EEG |
  PROC10 %in% codes_subdural_EEG |
  PROC11 %in% codes_subdural_EEG |
  PROC12 %in% codes_subdural_EEG |
  PROC13 %in% codes_subdural_EEG |  
  PROC14 %in% codes_subdural_EEG |
  PROC15 %in% codes_subdural_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

subdural_EEG2013_o <- ms_o_2013 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_subdural_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2014#################################
subdural_EEG2014_i <- ms_i_2014 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_subdural_EEG |
  PROC1 %in% codes_subdural_EEG |
  PROC2 %in% codes_subdural_EEG |
  PROC3 %in% codes_subdural_EEG |
  PROC4 %in% codes_subdural_EEG |
  PROC5 %in% codes_subdural_EEG |
  PROC6 %in% codes_subdural_EEG |
  PROC7 %in% codes_subdural_EEG |
  PROC8 %in% codes_subdural_EEG |
  PROC9 %in% codes_subdural_EEG |
  PROC10 %in% codes_subdural_EEG |
  PROC11 %in% codes_subdural_EEG |
  PROC12 %in% codes_subdural_EEG |
  PROC13 %in% codes_subdural_EEG |  
  PROC14 %in% codes_subdural_EEG |
  PROC15 %in% codes_subdural_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

subdural_EEG2014_o <- ms_o_2014 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_subdural_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2015#################################
subdural_EEG2015_i <- ms_i_2015 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_subdural_EEG |
  PROC1 %in% codes_subdural_EEG |
  PROC2 %in% codes_subdural_EEG |
  PROC3 %in% codes_subdural_EEG |
  PROC4 %in% codes_subdural_EEG |
  PROC5 %in% codes_subdural_EEG |
  PROC6 %in% codes_subdural_EEG |
  PROC7 %in% codes_subdural_EEG |
  PROC8 %in% codes_subdural_EEG |
  PROC9 %in% codes_subdural_EEG |
  PROC10 %in% codes_subdural_EEG |
  PROC11 %in% codes_subdural_EEG |
  PROC12 %in% codes_subdural_EEG |
  PROC13 %in% codes_subdural_EEG |  
  PROC14 %in% codes_subdural_EEG |
  PROC15 %in% codes_subdural_EEG
  ) %>%  
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

subdural_EEG2015_o <- ms_o_2015 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_subdural_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2016#################################
subdural_EEG2016_i <- ms_i_2016 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_subdural_EEG |
  PROC1 %in% codes_subdural_EEG |
  PROC2 %in% codes_subdural_EEG |
  PROC3 %in% codes_subdural_EEG |
  PROC4 %in% codes_subdural_EEG |
  PROC5 %in% codes_subdural_EEG |
  PROC6 %in% codes_subdural_EEG |
  PROC7 %in% codes_subdural_EEG |
  PROC8 %in% codes_subdural_EEG |
  PROC9 %in% codes_subdural_EEG |
  PROC10 %in% codes_subdural_EEG |
  PROC11 %in% codes_subdural_EEG |
  PROC12 %in% codes_subdural_EEG |
  PROC13 %in% codes_subdural_EEG |  
  PROC14 %in% codes_subdural_EEG |
  PROC15 %in% codes_subdural_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

subdural_EEG2016_o <- ms_o_2016 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_subdural_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2017#################################
subdural_EEG2017_i <- ms_i_2017 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_subdural_EEG |
  PROC1 %in% codes_subdural_EEG |
  PROC2 %in% codes_subdural_EEG |
  PROC3 %in% codes_subdural_EEG |
  PROC4 %in% codes_subdural_EEG |
  PROC5 %in% codes_subdural_EEG |
  PROC6 %in% codes_subdural_EEG |
  PROC7 %in% codes_subdural_EEG |
  PROC8 %in% codes_subdural_EEG |
  PROC9 %in% codes_subdural_EEG |
  PROC10 %in% codes_subdural_EEG |
  PROC11 %in% codes_subdural_EEG |
  PROC12 %in% codes_subdural_EEG |
  PROC13 %in% codes_subdural_EEG |  
  PROC14 %in% codes_subdural_EEG |
  PROC15 %in% codes_subdural_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

subdural_EEG2017_o <- ms_o_2017 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_subdural_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2018#################################
subdural_EEG2018_i <- ms_i_2018 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_subdural_EEG |
  PROC1 %in% codes_subdural_EEG |
  PROC2 %in% codes_subdural_EEG |
  PROC3 %in% codes_subdural_EEG |
  PROC4 %in% codes_subdural_EEG |
  PROC5 %in% codes_subdural_EEG |
  PROC6 %in% codes_subdural_EEG |
  PROC7 %in% codes_subdural_EEG |
  PROC8 %in% codes_subdural_EEG |
  PROC9 %in% codes_subdural_EEG |
  PROC10 %in% codes_subdural_EEG |
  PROC11 %in% codes_subdural_EEG |
  PROC12 %in% codes_subdural_EEG |
  PROC13 %in% codes_subdural_EEG |  
  PROC14 %in% codes_subdural_EEG |
  PROC15 %in% codes_subdural_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

subdural_EEG2018_o <- ms_o_2018 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_subdural_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2019#################################
subdural_EEG2019_i <- ms_i_2019 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_subdural_EEG |
  PROC1 %in% codes_subdural_EEG |
  PROC2 %in% codes_subdural_EEG |
  PROC3 %in% codes_subdural_EEG |
  PROC4 %in% codes_subdural_EEG |
  PROC5 %in% codes_subdural_EEG |
  PROC6 %in% codes_subdural_EEG |
  PROC7 %in% codes_subdural_EEG |
  PROC8 %in% codes_subdural_EEG |
  PROC9 %in% codes_subdural_EEG |
  PROC10 %in% codes_subdural_EEG |
  PROC11 %in% codes_subdural_EEG |
  PROC12 %in% codes_subdural_EEG |
  PROC13 %in% codes_subdural_EEG |  
  PROC14 %in% codes_subdural_EEG |
  PROC15 %in% codes_subdural_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

subdural_EEG2019_o <- ms_o_2019 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_subdural_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


# Long-term EEG monitoring
subdural_EEG <- bind_rows(subdural_EEG2006_i, subdural_EEG2006_o, subdural_EEG2007_i, subdural_EEG2007_o, subdural_EEG2008_i, subdural_EEG2008_o, subdural_EEG2009_i, subdural_EEG2009_o, subdural_EEG2010_i, subdural_EEG2010_o, subdural_EEG2011_i, subdural_EEG2011_o, subdural_EEG2012_i, subdural_EEG2012_o, subdural_EEG2013_i, subdural_EEG2013_o, subdural_EEG2014_i, subdural_EEG2014_o, subdural_EEG2015_i, subdural_EEG2015_o, subdural_EEG2016_i, subdural_EEG2016_o, subdural_EEG2017_i, subdural_EEG2017_o, subdural_EEG2018_i, subdural_EEG2018_o, subdural_EEG2019_i, subdural_EEG2019_o) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  arrange(SVCDATE, .by_group=TRUE) %>% 
  mutate(difference_between_monitorings=SVCDATE - lag(SVCDATE, 1))

# Individual long-term subdural EEG monitoring
monitoring_subdural_EEG_n <- subdural_EEG %>% distinct(ENROLID, SVCDATE) %>% nrow()
monitoring_subdural_EEG_n 

# Individual patients with long-term subdural EEG monitoring
patients_subdural_EEG_n <- subdural_EEG %>% distinct(ENROLID) %>% nrow()
patients_subdural_EEG_n 

# Tally of patients with more than one long-term subdural EEG monitoring
tally_subdural_EEG <- subdural_EEG %>% group_by(ENROLID) %>% tally(name="number_monitorings")  %>% group_by(number_monitorings) %>% tally(name="number_patients")
tally_subdural_EEG

# Period between individual long-term subdural EEG monitorings in patients with repeated monitorings
period_between_subdural_EEGs <- summary(as.numeric(subdural_EEG$difference_between_monitorings))
period_between_subdural_EEGs
```




Identify patients with stereo-EEG monitoring
```{r}
# Codes for patients with stereo-EEG monitoring
codes_stereo_EEG <- c("61760")


#################################2006#################################
stereo_EEG2006_i <- ms_i_2006 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_stereo_EEG |
  PROC1 %in% codes_stereo_EEG |
  PROC2 %in% codes_stereo_EEG |
  PROC3 %in% codes_stereo_EEG |
  PROC4 %in% codes_stereo_EEG |
  PROC5 %in% codes_stereo_EEG |
  PROC6 %in% codes_stereo_EEG |
  PROC7 %in% codes_stereo_EEG |
  PROC8 %in% codes_stereo_EEG |
  PROC9 %in% codes_stereo_EEG |
  PROC10 %in% codes_stereo_EEG |
  PROC11 %in% codes_stereo_EEG |
  PROC12 %in% codes_stereo_EEG |
  PROC13 %in% codes_stereo_EEG |  
  PROC14 %in% codes_stereo_EEG |
  PROC15 %in% codes_stereo_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

stereo_EEG2006_o <- ms_o_2006 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_stereo_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2007#################################
stereo_EEG2007_i <- ms_i_2007 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_stereo_EEG |
  PROC1 %in% codes_stereo_EEG |
  PROC2 %in% codes_stereo_EEG |
  PROC3 %in% codes_stereo_EEG |
  PROC4 %in% codes_stereo_EEG |
  PROC5 %in% codes_stereo_EEG |
  PROC6 %in% codes_stereo_EEG |
  PROC7 %in% codes_stereo_EEG |
  PROC8 %in% codes_stereo_EEG |
  PROC9 %in% codes_stereo_EEG |
  PROC10 %in% codes_stereo_EEG |
  PROC11 %in% codes_stereo_EEG |
  PROC12 %in% codes_stereo_EEG |
  PROC13 %in% codes_stereo_EEG |  
  PROC14 %in% codes_stereo_EEG |
  PROC15 %in% codes_stereo_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

stereo_EEG2007_o <- ms_o_2007 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_stereo_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2008#################################
stereo_EEG2008_i <- ms_i_2008 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_stereo_EEG |
  PROC1 %in% codes_stereo_EEG |
  PROC2 %in% codes_stereo_EEG |
  PROC3 %in% codes_stereo_EEG |
  PROC4 %in% codes_stereo_EEG |
  PROC5 %in% codes_stereo_EEG |
  PROC6 %in% codes_stereo_EEG |
  PROC7 %in% codes_stereo_EEG |
  PROC8 %in% codes_stereo_EEG |
  PROC9 %in% codes_stereo_EEG |
  PROC10 %in% codes_stereo_EEG |
  PROC11 %in% codes_stereo_EEG |
  PROC12 %in% codes_stereo_EEG |
  PROC13 %in% codes_stereo_EEG |  
  PROC14 %in% codes_stereo_EEG |
  PROC15 %in% codes_stereo_EEG
  ) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

stereo_EEG2008_o <- ms_o_2008 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_stereo_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2009#################################
stereo_EEG2009_i <- ms_i_2009 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_stereo_EEG |
  PROC1 %in% codes_stereo_EEG |
  PROC2 %in% codes_stereo_EEG |
  PROC3 %in% codes_stereo_EEG |
  PROC4 %in% codes_stereo_EEG |
  PROC5 %in% codes_stereo_EEG |
  PROC6 %in% codes_stereo_EEG |
  PROC7 %in% codes_stereo_EEG |
  PROC8 %in% codes_stereo_EEG |
  PROC9 %in% codes_stereo_EEG |
  PROC10 %in% codes_stereo_EEG |
  PROC11 %in% codes_stereo_EEG |
  PROC12 %in% codes_stereo_EEG |
  PROC13 %in% codes_stereo_EEG |  
  PROC14 %in% codes_stereo_EEG |
  PROC15 %in% codes_stereo_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

stereo_EEG2009_o <- ms_o_2009 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_stereo_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2010#################################
stereo_EEG2010_i <- ms_i_2010 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_stereo_EEG |
  PROC1 %in% codes_stereo_EEG |
  PROC2 %in% codes_stereo_EEG |
  PROC3 %in% codes_stereo_EEG |
  PROC4 %in% codes_stereo_EEG |
  PROC5 %in% codes_stereo_EEG |
  PROC6 %in% codes_stereo_EEG |
  PROC7 %in% codes_stereo_EEG |
  PROC8 %in% codes_stereo_EEG |
  PROC9 %in% codes_stereo_EEG |
  PROC10 %in% codes_stereo_EEG |
  PROC11 %in% codes_stereo_EEG |
  PROC12 %in% codes_stereo_EEG |
  PROC13 %in% codes_stereo_EEG |  
  PROC14 %in% codes_stereo_EEG |
  PROC15 %in% codes_stereo_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

stereo_EEG2010_o <- ms_o_2010 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_stereo_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2011#################################
stereo_EEG2011_i <- ms_i_2011 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_stereo_EEG |
  PROC1 %in% codes_stereo_EEG |
  PROC2 %in% codes_stereo_EEG |
  PROC3 %in% codes_stereo_EEG |
  PROC4 %in% codes_stereo_EEG |
  PROC5 %in% codes_stereo_EEG |
  PROC6 %in% codes_stereo_EEG |
  PROC7 %in% codes_stereo_EEG |
  PROC8 %in% codes_stereo_EEG |
  PROC9 %in% codes_stereo_EEG |
  PROC10 %in% codes_stereo_EEG |
  PROC11 %in% codes_stereo_EEG |
  PROC12 %in% codes_stereo_EEG |
  PROC13 %in% codes_stereo_EEG |  
  PROC14 %in% codes_stereo_EEG |
  PROC15 %in% codes_stereo_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

stereo_EEG2011_o <- ms_o_2011 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_stereo_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2012#################################
stereo_EEG2012_i <- ms_i_2012 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_stereo_EEG |
  PROC1 %in% codes_stereo_EEG |
  PROC2 %in% codes_stereo_EEG |
  PROC3 %in% codes_stereo_EEG |
  PROC4 %in% codes_stereo_EEG |
  PROC5 %in% codes_stereo_EEG |
  PROC6 %in% codes_stereo_EEG |
  PROC7 %in% codes_stereo_EEG |
  PROC8 %in% codes_stereo_EEG |
  PROC9 %in% codes_stereo_EEG |
  PROC10 %in% codes_stereo_EEG |
  PROC11 %in% codes_stereo_EEG |
  PROC12 %in% codes_stereo_EEG |
  PROC13 %in% codes_stereo_EEG |  
  PROC14 %in% codes_stereo_EEG |
  PROC15 %in% codes_stereo_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

stereo_EEG2012_o <- ms_o_2012 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_stereo_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2013#################################
stereo_EEG2013_i <- ms_i_2013 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_stereo_EEG |
  PROC1 %in% codes_stereo_EEG |
  PROC2 %in% codes_stereo_EEG |
  PROC3 %in% codes_stereo_EEG |
  PROC4 %in% codes_stereo_EEG |
  PROC5 %in% codes_stereo_EEG |
  PROC6 %in% codes_stereo_EEG |
  PROC7 %in% codes_stereo_EEG |
  PROC8 %in% codes_stereo_EEG |
  PROC9 %in% codes_stereo_EEG |
  PROC10 %in% codes_stereo_EEG |
  PROC11 %in% codes_stereo_EEG |
  PROC12 %in% codes_stereo_EEG |
  PROC13 %in% codes_stereo_EEG |  
  PROC14 %in% codes_stereo_EEG |
  PROC15 %in% codes_stereo_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

stereo_EEG2013_o <- ms_o_2013 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_stereo_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2014#################################
stereo_EEG2014_i <- ms_i_2014 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_stereo_EEG |
  PROC1 %in% codes_stereo_EEG |
  PROC2 %in% codes_stereo_EEG |
  PROC3 %in% codes_stereo_EEG |
  PROC4 %in% codes_stereo_EEG |
  PROC5 %in% codes_stereo_EEG |
  PROC6 %in% codes_stereo_EEG |
  PROC7 %in% codes_stereo_EEG |
  PROC8 %in% codes_stereo_EEG |
  PROC9 %in% codes_stereo_EEG |
  PROC10 %in% codes_stereo_EEG |
  PROC11 %in% codes_stereo_EEG |
  PROC12 %in% codes_stereo_EEG |
  PROC13 %in% codes_stereo_EEG |  
  PROC14 %in% codes_stereo_EEG |
  PROC15 %in% codes_stereo_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

stereo_EEG2014_o <- ms_o_2014 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_stereo_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2015#################################
stereo_EEG2015_i <- ms_i_2015 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_stereo_EEG |
  PROC1 %in% codes_stereo_EEG |
  PROC2 %in% codes_stereo_EEG |
  PROC3 %in% codes_stereo_EEG |
  PROC4 %in% codes_stereo_EEG |
  PROC5 %in% codes_stereo_EEG |
  PROC6 %in% codes_stereo_EEG |
  PROC7 %in% codes_stereo_EEG |
  PROC8 %in% codes_stereo_EEG |
  PROC9 %in% codes_stereo_EEG |
  PROC10 %in% codes_stereo_EEG |
  PROC11 %in% codes_stereo_EEG |
  PROC12 %in% codes_stereo_EEG |
  PROC13 %in% codes_stereo_EEG |  
  PROC14 %in% codes_stereo_EEG |
  PROC15 %in% codes_stereo_EEG
  ) %>%  
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

stereo_EEG2015_o <- ms_o_2015 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_stereo_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2016#################################
stereo_EEG2016_i <- ms_i_2016 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_stereo_EEG |
  PROC1 %in% codes_stereo_EEG |
  PROC2 %in% codes_stereo_EEG |
  PROC3 %in% codes_stereo_EEG |
  PROC4 %in% codes_stereo_EEG |
  PROC5 %in% codes_stereo_EEG |
  PROC6 %in% codes_stereo_EEG |
  PROC7 %in% codes_stereo_EEG |
  PROC8 %in% codes_stereo_EEG |
  PROC9 %in% codes_stereo_EEG |
  PROC10 %in% codes_stereo_EEG |
  PROC11 %in% codes_stereo_EEG |
  PROC12 %in% codes_stereo_EEG |
  PROC13 %in% codes_stereo_EEG |  
  PROC14 %in% codes_stereo_EEG |
  PROC15 %in% codes_stereo_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

stereo_EEG2016_o <- ms_o_2016 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_stereo_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2017#################################
stereo_EEG2017_i <- ms_i_2017 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_stereo_EEG |
  PROC1 %in% codes_stereo_EEG |
  PROC2 %in% codes_stereo_EEG |
  PROC3 %in% codes_stereo_EEG |
  PROC4 %in% codes_stereo_EEG |
  PROC5 %in% codes_stereo_EEG |
  PROC6 %in% codes_stereo_EEG |
  PROC7 %in% codes_stereo_EEG |
  PROC8 %in% codes_stereo_EEG |
  PROC9 %in% codes_stereo_EEG |
  PROC10 %in% codes_stereo_EEG |
  PROC11 %in% codes_stereo_EEG |
  PROC12 %in% codes_stereo_EEG |
  PROC13 %in% codes_stereo_EEG |  
  PROC14 %in% codes_stereo_EEG |
  PROC15 %in% codes_stereo_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

stereo_EEG2017_o <- ms_o_2017 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_stereo_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2018#################################
stereo_EEG2018_i <- ms_i_2018 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_stereo_EEG |
  PROC1 %in% codes_stereo_EEG |
  PROC2 %in% codes_stereo_EEG |
  PROC3 %in% codes_stereo_EEG |
  PROC4 %in% codes_stereo_EEG |
  PROC5 %in% codes_stereo_EEG |
  PROC6 %in% codes_stereo_EEG |
  PROC7 %in% codes_stereo_EEG |
  PROC8 %in% codes_stereo_EEG |
  PROC9 %in% codes_stereo_EEG |
  PROC10 %in% codes_stereo_EEG |
  PROC11 %in% codes_stereo_EEG |
  PROC12 %in% codes_stereo_EEG |
  PROC13 %in% codes_stereo_EEG |  
  PROC14 %in% codes_stereo_EEG |
  PROC15 %in% codes_stereo_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

stereo_EEG2018_o <- ms_o_2018 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_stereo_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2019#################################
stereo_EEG2019_i <- ms_i_2019 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_stereo_EEG |
  PROC1 %in% codes_stereo_EEG |
  PROC2 %in% codes_stereo_EEG |
  PROC3 %in% codes_stereo_EEG |
  PROC4 %in% codes_stereo_EEG |
  PROC5 %in% codes_stereo_EEG |
  PROC6 %in% codes_stereo_EEG |
  PROC7 %in% codes_stereo_EEG |
  PROC8 %in% codes_stereo_EEG |
  PROC9 %in% codes_stereo_EEG |
  PROC10 %in% codes_stereo_EEG |
  PROC11 %in% codes_stereo_EEG |
  PROC12 %in% codes_stereo_EEG |
  PROC13 %in% codes_stereo_EEG |  
  PROC14 %in% codes_stereo_EEG |
  PROC15 %in% codes_stereo_EEG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

stereo_EEG2019_o <- ms_o_2019 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_stereo_EEG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


# Stereo-EEG monitoring
stereo_EEG <- bind_rows(stereo_EEG2006_i, stereo_EEG2006_o, stereo_EEG2007_i, stereo_EEG2007_o, stereo_EEG2008_i, stereo_EEG2008_o, stereo_EEG2009_i, stereo_EEG2009_o, stereo_EEG2010_i, stereo_EEG2010_o, stereo_EEG2011_i, stereo_EEG2011_o, stereo_EEG2012_i, stereo_EEG2012_o, stereo_EEG2013_i, stereo_EEG2013_o, stereo_EEG2014_i, stereo_EEG2014_o, stereo_EEG2015_i, stereo_EEG2015_o, stereo_EEG2016_i, stereo_EEG2016_o, stereo_EEG2017_i, stereo_EEG2017_o, stereo_EEG2018_i, stereo_EEG2018_o, stereo_EEG2019_i, stereo_EEG2019_o) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  arrange(SVCDATE, .by_group=TRUE) %>% 
  mutate(difference_between_monitorings=SVCDATE - lag(SVCDATE, 1))

# Individual stereo-EEG monitoring
monitoring_stereo_EEG_n <- stereo_EEG %>% distinct(ENROLID, SVCDATE) %>% nrow()
monitoring_stereo_EEG_n 

# Individual patients with stereo-EEG monitoring
patients_stereo_EEG_n <- stereo_EEG %>% distinct(ENROLID) %>% nrow()
patients_stereo_EEG_n 

# Tally of patients with more than one stereo-EEG monitoring
tally_stereo_EEG <- stereo_EEG %>% group_by(ENROLID) %>% tally(name="number_monitorings")  %>% group_by(number_monitorings) %>% tally(name="number_patients")
tally_stereo_EEG

# Period between individual stereo-EEG monitorings in patients with repeated monitorings
period_between_stereo_EEGs <- summary(as.numeric(stereo_EEG$difference_between_monitorings))
period_between_stereo_EEGs
```




Identify patients with functional_mapping
```{r}
# Codes for patients with functional_mapping
codes_functional_mapping <- c("95961", "95962")


#################################2006#################################
functional_mapping2006_i <- ms_i_2006 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_functional_mapping |
  PROC1 %in% codes_functional_mapping |
  PROC2 %in% codes_functional_mapping |
  PROC3 %in% codes_functional_mapping |
  PROC4 %in% codes_functional_mapping |
  PROC5 %in% codes_functional_mapping |
  PROC6 %in% codes_functional_mapping |
  PROC7 %in% codes_functional_mapping |
  PROC8 %in% codes_functional_mapping |
  PROC9 %in% codes_functional_mapping |
  PROC10 %in% codes_functional_mapping |
  PROC11 %in% codes_functional_mapping |
  PROC12 %in% codes_functional_mapping |
  PROC13 %in% codes_functional_mapping |  
  PROC14 %in% codes_functional_mapping |
  PROC15 %in% codes_functional_mapping
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

functional_mapping2006_o <- ms_o_2006 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_functional_mapping
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2007#################################
functional_mapping2007_i <- ms_i_2007 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_functional_mapping |
  PROC1 %in% codes_functional_mapping |
  PROC2 %in% codes_functional_mapping |
  PROC3 %in% codes_functional_mapping |
  PROC4 %in% codes_functional_mapping |
  PROC5 %in% codes_functional_mapping |
  PROC6 %in% codes_functional_mapping |
  PROC7 %in% codes_functional_mapping |
  PROC8 %in% codes_functional_mapping |
  PROC9 %in% codes_functional_mapping |
  PROC10 %in% codes_functional_mapping |
  PROC11 %in% codes_functional_mapping |
  PROC12 %in% codes_functional_mapping |
  PROC13 %in% codes_functional_mapping |  
  PROC14 %in% codes_functional_mapping |
  PROC15 %in% codes_functional_mapping
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

functional_mapping2007_o <- ms_o_2007 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_functional_mapping
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2008#################################
functional_mapping2008_i <- ms_i_2008 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_functional_mapping |
  PROC1 %in% codes_functional_mapping |
  PROC2 %in% codes_functional_mapping |
  PROC3 %in% codes_functional_mapping |
  PROC4 %in% codes_functional_mapping |
  PROC5 %in% codes_functional_mapping |
  PROC6 %in% codes_functional_mapping |
  PROC7 %in% codes_functional_mapping |
  PROC8 %in% codes_functional_mapping |
  PROC9 %in% codes_functional_mapping |
  PROC10 %in% codes_functional_mapping |
  PROC11 %in% codes_functional_mapping |
  PROC12 %in% codes_functional_mapping |
  PROC13 %in% codes_functional_mapping |  
  PROC14 %in% codes_functional_mapping |
  PROC15 %in% codes_functional_mapping
  ) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

functional_mapping2008_o <- ms_o_2008 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_functional_mapping
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2009#################################
functional_mapping2009_i <- ms_i_2009 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_functional_mapping |
  PROC1 %in% codes_functional_mapping |
  PROC2 %in% codes_functional_mapping |
  PROC3 %in% codes_functional_mapping |
  PROC4 %in% codes_functional_mapping |
  PROC5 %in% codes_functional_mapping |
  PROC6 %in% codes_functional_mapping |
  PROC7 %in% codes_functional_mapping |
  PROC8 %in% codes_functional_mapping |
  PROC9 %in% codes_functional_mapping |
  PROC10 %in% codes_functional_mapping |
  PROC11 %in% codes_functional_mapping |
  PROC12 %in% codes_functional_mapping |
  PROC13 %in% codes_functional_mapping |  
  PROC14 %in% codes_functional_mapping |
  PROC15 %in% codes_functional_mapping
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

functional_mapping2009_o <- ms_o_2009 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_functional_mapping
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2010#################################
functional_mapping2010_i <- ms_i_2010 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_functional_mapping |
  PROC1 %in% codes_functional_mapping |
  PROC2 %in% codes_functional_mapping |
  PROC3 %in% codes_functional_mapping |
  PROC4 %in% codes_functional_mapping |
  PROC5 %in% codes_functional_mapping |
  PROC6 %in% codes_functional_mapping |
  PROC7 %in% codes_functional_mapping |
  PROC8 %in% codes_functional_mapping |
  PROC9 %in% codes_functional_mapping |
  PROC10 %in% codes_functional_mapping |
  PROC11 %in% codes_functional_mapping |
  PROC12 %in% codes_functional_mapping |
  PROC13 %in% codes_functional_mapping |  
  PROC14 %in% codes_functional_mapping |
  PROC15 %in% codes_functional_mapping
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

functional_mapping2010_o <- ms_o_2010 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_functional_mapping
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2011#################################
functional_mapping2011_i <- ms_i_2011 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_functional_mapping |
  PROC1 %in% codes_functional_mapping |
  PROC2 %in% codes_functional_mapping |
  PROC3 %in% codes_functional_mapping |
  PROC4 %in% codes_functional_mapping |
  PROC5 %in% codes_functional_mapping |
  PROC6 %in% codes_functional_mapping |
  PROC7 %in% codes_functional_mapping |
  PROC8 %in% codes_functional_mapping |
  PROC9 %in% codes_functional_mapping |
  PROC10 %in% codes_functional_mapping |
  PROC11 %in% codes_functional_mapping |
  PROC12 %in% codes_functional_mapping |
  PROC13 %in% codes_functional_mapping |  
  PROC14 %in% codes_functional_mapping |
  PROC15 %in% codes_functional_mapping
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

functional_mapping2011_o <- ms_o_2011 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_functional_mapping
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2012#################################
functional_mapping2012_i <- ms_i_2012 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_functional_mapping |
  PROC1 %in% codes_functional_mapping |
  PROC2 %in% codes_functional_mapping |
  PROC3 %in% codes_functional_mapping |
  PROC4 %in% codes_functional_mapping |
  PROC5 %in% codes_functional_mapping |
  PROC6 %in% codes_functional_mapping |
  PROC7 %in% codes_functional_mapping |
  PROC8 %in% codes_functional_mapping |
  PROC9 %in% codes_functional_mapping |
  PROC10 %in% codes_functional_mapping |
  PROC11 %in% codes_functional_mapping |
  PROC12 %in% codes_functional_mapping |
  PROC13 %in% codes_functional_mapping |  
  PROC14 %in% codes_functional_mapping |
  PROC15 %in% codes_functional_mapping
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

functional_mapping2012_o <- ms_o_2012 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_functional_mapping
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2013#################################
functional_mapping2013_i <- ms_i_2013 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_functional_mapping |
  PROC1 %in% codes_functional_mapping |
  PROC2 %in% codes_functional_mapping |
  PROC3 %in% codes_functional_mapping |
  PROC4 %in% codes_functional_mapping |
  PROC5 %in% codes_functional_mapping |
  PROC6 %in% codes_functional_mapping |
  PROC7 %in% codes_functional_mapping |
  PROC8 %in% codes_functional_mapping |
  PROC9 %in% codes_functional_mapping |
  PROC10 %in% codes_functional_mapping |
  PROC11 %in% codes_functional_mapping |
  PROC12 %in% codes_functional_mapping |
  PROC13 %in% codes_functional_mapping |  
  PROC14 %in% codes_functional_mapping |
  PROC15 %in% codes_functional_mapping
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

functional_mapping2013_o <- ms_o_2013 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_functional_mapping
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2014#################################
functional_mapping2014_i <- ms_i_2014 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_functional_mapping |
  PROC1 %in% codes_functional_mapping |
  PROC2 %in% codes_functional_mapping |
  PROC3 %in% codes_functional_mapping |
  PROC4 %in% codes_functional_mapping |
  PROC5 %in% codes_functional_mapping |
  PROC6 %in% codes_functional_mapping |
  PROC7 %in% codes_functional_mapping |
  PROC8 %in% codes_functional_mapping |
  PROC9 %in% codes_functional_mapping |
  PROC10 %in% codes_functional_mapping |
  PROC11 %in% codes_functional_mapping |
  PROC12 %in% codes_functional_mapping |
  PROC13 %in% codes_functional_mapping |  
  PROC14 %in% codes_functional_mapping |
  PROC15 %in% codes_functional_mapping
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

functional_mapping2014_o <- ms_o_2014 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_functional_mapping
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2015#################################
functional_mapping2015_i <- ms_i_2015 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_functional_mapping |
  PROC1 %in% codes_functional_mapping |
  PROC2 %in% codes_functional_mapping |
  PROC3 %in% codes_functional_mapping |
  PROC4 %in% codes_functional_mapping |
  PROC5 %in% codes_functional_mapping |
  PROC6 %in% codes_functional_mapping |
  PROC7 %in% codes_functional_mapping |
  PROC8 %in% codes_functional_mapping |
  PROC9 %in% codes_functional_mapping |
  PROC10 %in% codes_functional_mapping |
  PROC11 %in% codes_functional_mapping |
  PROC12 %in% codes_functional_mapping |
  PROC13 %in% codes_functional_mapping |  
  PROC14 %in% codes_functional_mapping |
  PROC15 %in% codes_functional_mapping
  ) %>%  
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

functional_mapping2015_o <- ms_o_2015 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_functional_mapping
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2016#################################
functional_mapping2016_i <- ms_i_2016 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_functional_mapping |
  PROC1 %in% codes_functional_mapping |
  PROC2 %in% codes_functional_mapping |
  PROC3 %in% codes_functional_mapping |
  PROC4 %in% codes_functional_mapping |
  PROC5 %in% codes_functional_mapping |
  PROC6 %in% codes_functional_mapping |
  PROC7 %in% codes_functional_mapping |
  PROC8 %in% codes_functional_mapping |
  PROC9 %in% codes_functional_mapping |
  PROC10 %in% codes_functional_mapping |
  PROC11 %in% codes_functional_mapping |
  PROC12 %in% codes_functional_mapping |
  PROC13 %in% codes_functional_mapping |  
  PROC14 %in% codes_functional_mapping |
  PROC15 %in% codes_functional_mapping
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

functional_mapping2016_o <- ms_o_2016 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_functional_mapping
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2017#################################
functional_mapping2017_i <- ms_i_2017 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_functional_mapping |
  PROC1 %in% codes_functional_mapping |
  PROC2 %in% codes_functional_mapping |
  PROC3 %in% codes_functional_mapping |
  PROC4 %in% codes_functional_mapping |
  PROC5 %in% codes_functional_mapping |
  PROC6 %in% codes_functional_mapping |
  PROC7 %in% codes_functional_mapping |
  PROC8 %in% codes_functional_mapping |
  PROC9 %in% codes_functional_mapping |
  PROC10 %in% codes_functional_mapping |
  PROC11 %in% codes_functional_mapping |
  PROC12 %in% codes_functional_mapping |
  PROC13 %in% codes_functional_mapping |  
  PROC14 %in% codes_functional_mapping |
  PROC15 %in% codes_functional_mapping
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

functional_mapping2017_o <- ms_o_2017 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_functional_mapping
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2018#################################
functional_mapping2018_i <- ms_i_2018 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_functional_mapping |
  PROC1 %in% codes_functional_mapping |
  PROC2 %in% codes_functional_mapping |
  PROC3 %in% codes_functional_mapping |
  PROC4 %in% codes_functional_mapping |
  PROC5 %in% codes_functional_mapping |
  PROC6 %in% codes_functional_mapping |
  PROC7 %in% codes_functional_mapping |
  PROC8 %in% codes_functional_mapping |
  PROC9 %in% codes_functional_mapping |
  PROC10 %in% codes_functional_mapping |
  PROC11 %in% codes_functional_mapping |
  PROC12 %in% codes_functional_mapping |
  PROC13 %in% codes_functional_mapping |  
  PROC14 %in% codes_functional_mapping |
  PROC15 %in% codes_functional_mapping
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

functional_mapping2018_o <- ms_o_2018 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_functional_mapping
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2019#################################
functional_mapping2019_i <- ms_i_2019 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_functional_mapping |
  PROC1 %in% codes_functional_mapping |
  PROC2 %in% codes_functional_mapping |
  PROC3 %in% codes_functional_mapping |
  PROC4 %in% codes_functional_mapping |
  PROC5 %in% codes_functional_mapping |
  PROC6 %in% codes_functional_mapping |
  PROC7 %in% codes_functional_mapping |
  PROC8 %in% codes_functional_mapping |
  PROC9 %in% codes_functional_mapping |
  PROC10 %in% codes_functional_mapping |
  PROC11 %in% codes_functional_mapping |
  PROC12 %in% codes_functional_mapping |
  PROC13 %in% codes_functional_mapping |  
  PROC14 %in% codes_functional_mapping |
  PROC15 %in% codes_functional_mapping
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

functional_mapping2019_o <- ms_o_2019 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_functional_mapping
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


# Functional mapping
functional_mapping <- bind_rows(functional_mapping2006_i, functional_mapping2006_o, functional_mapping2007_i, functional_mapping2007_o, functional_mapping2008_i, functional_mapping2008_o, functional_mapping2009_i, functional_mapping2009_o, functional_mapping2010_i, functional_mapping2010_o, functional_mapping2011_i, functional_mapping2011_o, functional_mapping2012_i, functional_mapping2012_o, functional_mapping2013_i, functional_mapping2013_o, functional_mapping2014_i, functional_mapping2014_o, functional_mapping2015_i, functional_mapping2015_o, functional_mapping2016_i, functional_mapping2016_o, functional_mapping2017_i, functional_mapping2017_o, functional_mapping2018_i, functional_mapping2018_o, functional_mapping2019_i, functional_mapping2019_o) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  arrange(SVCDATE, .by_group=TRUE) %>% 
  mutate(difference_between_procedures=SVCDATE - lag(SVCDATE, 1))

# Individual functional mapping
procedure_functional_mapping_n <- functional_mapping %>% distinct(ENROLID, SVCDATE) %>% nrow()
procedure_functional_mapping_n 

# Individual patients with functional mapping
patients_functional_mapping_n <- functional_mapping %>% distinct(ENROLID) %>% nrow()
patients_functional_mapping_n 

# Tally of patients with more than one functional mapping
tally_functional_mapping <- functional_mapping %>% group_by(ENROLID) %>% tally(name="number_procedures")  %>% group_by(number_procedures) %>% tally(name="number_patients")
tally_functional_mapping

# Period between individual functional mappings in patients with repeated procedures
period_between_functional_mappings <- summary(as.numeric(functional_mapping$difference_between_procedures))
period_between_functional_mappings
```




Identify patients with intraoperative ECoG
```{r}
# Codes for patients with intraoperative ECoG
codes_ECoG <- c("95829")


#################################2006#################################
ECoG2006_i <- ms_i_2006 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_ECoG |
  PROC1 %in% codes_ECoG |
  PROC2 %in% codes_ECoG |
  PROC3 %in% codes_ECoG |
  PROC4 %in% codes_ECoG |
  PROC5 %in% codes_ECoG |
  PROC6 %in% codes_ECoG |
  PROC7 %in% codes_ECoG |
  PROC8 %in% codes_ECoG |
  PROC9 %in% codes_ECoG |
  PROC10 %in% codes_ECoG |
  PROC11 %in% codes_ECoG |
  PROC12 %in% codes_ECoG |
  PROC13 %in% codes_ECoG |  
  PROC14 %in% codes_ECoG |
  PROC15 %in% codes_ECoG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

ECoG2006_o <- ms_o_2006 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_ECoG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2007#################################
ECoG2007_i <- ms_i_2007 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_ECoG |
  PROC1 %in% codes_ECoG |
  PROC2 %in% codes_ECoG |
  PROC3 %in% codes_ECoG |
  PROC4 %in% codes_ECoG |
  PROC5 %in% codes_ECoG |
  PROC6 %in% codes_ECoG |
  PROC7 %in% codes_ECoG |
  PROC8 %in% codes_ECoG |
  PROC9 %in% codes_ECoG |
  PROC10 %in% codes_ECoG |
  PROC11 %in% codes_ECoG |
  PROC12 %in% codes_ECoG |
  PROC13 %in% codes_ECoG |  
  PROC14 %in% codes_ECoG |
  PROC15 %in% codes_ECoG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

ECoG2007_o <- ms_o_2007 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_ECoG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2008#################################
ECoG2008_i <- ms_i_2008 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_ECoG |
  PROC1 %in% codes_ECoG |
  PROC2 %in% codes_ECoG |
  PROC3 %in% codes_ECoG |
  PROC4 %in% codes_ECoG |
  PROC5 %in% codes_ECoG |
  PROC6 %in% codes_ECoG |
  PROC7 %in% codes_ECoG |
  PROC8 %in% codes_ECoG |
  PROC9 %in% codes_ECoG |
  PROC10 %in% codes_ECoG |
  PROC11 %in% codes_ECoG |
  PROC12 %in% codes_ECoG |
  PROC13 %in% codes_ECoG |  
  PROC14 %in% codes_ECoG |
  PROC15 %in% codes_ECoG
  ) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

ECoG2008_o <- ms_o_2008 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_ECoG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2009#################################
ECoG2009_i <- ms_i_2009 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_ECoG |
  PROC1 %in% codes_ECoG |
  PROC2 %in% codes_ECoG |
  PROC3 %in% codes_ECoG |
  PROC4 %in% codes_ECoG |
  PROC5 %in% codes_ECoG |
  PROC6 %in% codes_ECoG |
  PROC7 %in% codes_ECoG |
  PROC8 %in% codes_ECoG |
  PROC9 %in% codes_ECoG |
  PROC10 %in% codes_ECoG |
  PROC11 %in% codes_ECoG |
  PROC12 %in% codes_ECoG |
  PROC13 %in% codes_ECoG |  
  PROC14 %in% codes_ECoG |
  PROC15 %in% codes_ECoG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

ECoG2009_o <- ms_o_2009 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_ECoG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2010#################################
ECoG2010_i <- ms_i_2010 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_ECoG |
  PROC1 %in% codes_ECoG |
  PROC2 %in% codes_ECoG |
  PROC3 %in% codes_ECoG |
  PROC4 %in% codes_ECoG |
  PROC5 %in% codes_ECoG |
  PROC6 %in% codes_ECoG |
  PROC7 %in% codes_ECoG |
  PROC8 %in% codes_ECoG |
  PROC9 %in% codes_ECoG |
  PROC10 %in% codes_ECoG |
  PROC11 %in% codes_ECoG |
  PROC12 %in% codes_ECoG |
  PROC13 %in% codes_ECoG |  
  PROC14 %in% codes_ECoG |
  PROC15 %in% codes_ECoG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

ECoG2010_o <- ms_o_2010 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_ECoG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2011#################################
ECoG2011_i <- ms_i_2011 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_ECoG |
  PROC1 %in% codes_ECoG |
  PROC2 %in% codes_ECoG |
  PROC3 %in% codes_ECoG |
  PROC4 %in% codes_ECoG |
  PROC5 %in% codes_ECoG |
  PROC6 %in% codes_ECoG |
  PROC7 %in% codes_ECoG |
  PROC8 %in% codes_ECoG |
  PROC9 %in% codes_ECoG |
  PROC10 %in% codes_ECoG |
  PROC11 %in% codes_ECoG |
  PROC12 %in% codes_ECoG |
  PROC13 %in% codes_ECoG |  
  PROC14 %in% codes_ECoG |
  PROC15 %in% codes_ECoG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

ECoG2011_o <- ms_o_2011 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_ECoG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2012#################################
ECoG2012_i <- ms_i_2012 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_ECoG |
  PROC1 %in% codes_ECoG |
  PROC2 %in% codes_ECoG |
  PROC3 %in% codes_ECoG |
  PROC4 %in% codes_ECoG |
  PROC5 %in% codes_ECoG |
  PROC6 %in% codes_ECoG |
  PROC7 %in% codes_ECoG |
  PROC8 %in% codes_ECoG |
  PROC9 %in% codes_ECoG |
  PROC10 %in% codes_ECoG |
  PROC11 %in% codes_ECoG |
  PROC12 %in% codes_ECoG |
  PROC13 %in% codes_ECoG |  
  PROC14 %in% codes_ECoG |
  PROC15 %in% codes_ECoG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

ECoG2012_o <- ms_o_2012 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_ECoG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2013#################################
ECoG2013_i <- ms_i_2013 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_ECoG |
  PROC1 %in% codes_ECoG |
  PROC2 %in% codes_ECoG |
  PROC3 %in% codes_ECoG |
  PROC4 %in% codes_ECoG |
  PROC5 %in% codes_ECoG |
  PROC6 %in% codes_ECoG |
  PROC7 %in% codes_ECoG |
  PROC8 %in% codes_ECoG |
  PROC9 %in% codes_ECoG |
  PROC10 %in% codes_ECoG |
  PROC11 %in% codes_ECoG |
  PROC12 %in% codes_ECoG |
  PROC13 %in% codes_ECoG |  
  PROC14 %in% codes_ECoG |
  PROC15 %in% codes_ECoG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

ECoG2013_o <- ms_o_2013 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_ECoG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2014#################################
ECoG2014_i <- ms_i_2014 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_ECoG |
  PROC1 %in% codes_ECoG |
  PROC2 %in% codes_ECoG |
  PROC3 %in% codes_ECoG |
  PROC4 %in% codes_ECoG |
  PROC5 %in% codes_ECoG |
  PROC6 %in% codes_ECoG |
  PROC7 %in% codes_ECoG |
  PROC8 %in% codes_ECoG |
  PROC9 %in% codes_ECoG |
  PROC10 %in% codes_ECoG |
  PROC11 %in% codes_ECoG |
  PROC12 %in% codes_ECoG |
  PROC13 %in% codes_ECoG |  
  PROC14 %in% codes_ECoG |
  PROC15 %in% codes_ECoG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

ECoG2014_o <- ms_o_2014 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_ECoG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2015#################################
ECoG2015_i <- ms_i_2015 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_ECoG |
  PROC1 %in% codes_ECoG |
  PROC2 %in% codes_ECoG |
  PROC3 %in% codes_ECoG |
  PROC4 %in% codes_ECoG |
  PROC5 %in% codes_ECoG |
  PROC6 %in% codes_ECoG |
  PROC7 %in% codes_ECoG |
  PROC8 %in% codes_ECoG |
  PROC9 %in% codes_ECoG |
  PROC10 %in% codes_ECoG |
  PROC11 %in% codes_ECoG |
  PROC12 %in% codes_ECoG |
  PROC13 %in% codes_ECoG |  
  PROC14 %in% codes_ECoG |
  PROC15 %in% codes_ECoG
  ) %>%  
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

ECoG2015_o <- ms_o_2015 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_ECoG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2016#################################
ECoG2016_i <- ms_i_2016 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_ECoG |
  PROC1 %in% codes_ECoG |
  PROC2 %in% codes_ECoG |
  PROC3 %in% codes_ECoG |
  PROC4 %in% codes_ECoG |
  PROC5 %in% codes_ECoG |
  PROC6 %in% codes_ECoG |
  PROC7 %in% codes_ECoG |
  PROC8 %in% codes_ECoG |
  PROC9 %in% codes_ECoG |
  PROC10 %in% codes_ECoG |
  PROC11 %in% codes_ECoG |
  PROC12 %in% codes_ECoG |
  PROC13 %in% codes_ECoG |  
  PROC14 %in% codes_ECoG |
  PROC15 %in% codes_ECoG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

ECoG2016_o <- ms_o_2016 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_ECoG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2017#################################
ECoG2017_i <- ms_i_2017 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_ECoG |
  PROC1 %in% codes_ECoG |
  PROC2 %in% codes_ECoG |
  PROC3 %in% codes_ECoG |
  PROC4 %in% codes_ECoG |
  PROC5 %in% codes_ECoG |
  PROC6 %in% codes_ECoG |
  PROC7 %in% codes_ECoG |
  PROC8 %in% codes_ECoG |
  PROC9 %in% codes_ECoG |
  PROC10 %in% codes_ECoG |
  PROC11 %in% codes_ECoG |
  PROC12 %in% codes_ECoG |
  PROC13 %in% codes_ECoG |  
  PROC14 %in% codes_ECoG |
  PROC15 %in% codes_ECoG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

ECoG2017_o <- ms_o_2017 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_ECoG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2018#################################
ECoG2018_i <- ms_i_2018 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_ECoG |
  PROC1 %in% codes_ECoG |
  PROC2 %in% codes_ECoG |
  PROC3 %in% codes_ECoG |
  PROC4 %in% codes_ECoG |
  PROC5 %in% codes_ECoG |
  PROC6 %in% codes_ECoG |
  PROC7 %in% codes_ECoG |
  PROC8 %in% codes_ECoG |
  PROC9 %in% codes_ECoG |
  PROC10 %in% codes_ECoG |
  PROC11 %in% codes_ECoG |
  PROC12 %in% codes_ECoG |
  PROC13 %in% codes_ECoG |  
  PROC14 %in% codes_ECoG |
  PROC15 %in% codes_ECoG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

ECoG2018_o <- ms_o_2018 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_ECoG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2019#################################
ECoG2019_i <- ms_i_2019 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_ECoG |
  PROC1 %in% codes_ECoG |
  PROC2 %in% codes_ECoG |
  PROC3 %in% codes_ECoG |
  PROC4 %in% codes_ECoG |
  PROC5 %in% codes_ECoG |
  PROC6 %in% codes_ECoG |
  PROC7 %in% codes_ECoG |
  PROC8 %in% codes_ECoG |
  PROC9 %in% codes_ECoG |
  PROC10 %in% codes_ECoG |
  PROC11 %in% codes_ECoG |
  PROC12 %in% codes_ECoG |
  PROC13 %in% codes_ECoG |  
  PROC14 %in% codes_ECoG |
  PROC15 %in% codes_ECoG
  ) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

ECoG2019_o <- ms_o_2019 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_ECoG
                                     ) %>% 
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


# Intraoperative ECoG
ECoG <- bind_rows(ECoG2006_i, ECoG2006_o, ECoG2007_i, ECoG2007_o, ECoG2008_i, ECoG2008_o, ECoG2009_i, ECoG2009_o, ECoG2010_i, ECoG2010_o, ECoG2011_i, ECoG2011_o, ECoG2012_i, ECoG2012_o, ECoG2013_i, ECoG2013_o, ECoG2014_i, ECoG2014_o, ECoG2015_i, ECoG2015_o, ECoG2016_i, ECoG2016_o, ECoG2017_i, ECoG2017_o, ECoG2018_i, ECoG2018_o, ECoG2019_i, ECoG2019_o) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  arrange(SVCDATE, .by_group=TRUE) %>% 
  mutate(difference_between_monitorings=SVCDATE - lag(SVCDATE, 1))

# Individual intraoperative ECoG
monitoring_ECoG_n <- ECoG %>% distinct(ENROLID, SVCDATE) %>% nrow()
monitoring_ECoG_n 

# Individual patients with intraoperative ECoG
patients_ECoG_n <- ECoG %>% distinct(ENROLID) %>% nrow()
patients_ECoG_n 

# Tally of patients with more than one intraoperative ECoG
tally_ECoG <- ECoG %>% group_by(ENROLID) %>% tally(name="number_monitorings")  %>% group_by(number_monitorings) %>% tally(name="number_patients")
tally_ECoG

# Period between individual intraoperative ECoGs in patients with repeated monitorings
period_between_ECoGs <- summary(as.numeric(ECoG$difference_between_monitorings))
period_between_ECoGs
```




Identify patients with brain PET
```{r}
# Codes for patients with brain PET
codes_PET <- c("78608")


#################################2006#################################
PET2006_i <- ms_i_2006 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_PET |
  PROC1 %in% codes_PET |
  PROC2 %in% codes_PET |
  PROC3 %in% codes_PET |
  PROC4 %in% codes_PET |
  PROC5 %in% codes_PET |
  PROC6 %in% codes_PET |
  PROC7 %in% codes_PET |
  PROC8 %in% codes_PET |
  PROC9 %in% codes_PET |
  PROC10 %in% codes_PET |
  PROC11 %in% codes_PET |
  PROC12 %in% codes_PET |
  PROC13 %in% codes_PET |  
  PROC14 %in% codes_PET |
  PROC15 %in% codes_PET
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

PET2006_o <- ms_o_2006 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_PET
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2007#################################
PET2007_i <- ms_i_2007 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_PET |
  PROC1 %in% codes_PET |
  PROC2 %in% codes_PET |
  PROC3 %in% codes_PET |
  PROC4 %in% codes_PET |
  PROC5 %in% codes_PET |
  PROC6 %in% codes_PET |
  PROC7 %in% codes_PET |
  PROC8 %in% codes_PET |
  PROC9 %in% codes_PET |
  PROC10 %in% codes_PET |
  PROC11 %in% codes_PET |
  PROC12 %in% codes_PET |
  PROC13 %in% codes_PET |  
  PROC14 %in% codes_PET |
  PROC15 %in% codes_PET
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

PET2007_o <- ms_o_2007 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_PET
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2008#################################
PET2008_i <- ms_i_2008 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_PET |
  PROC1 %in% codes_PET |
  PROC2 %in% codes_PET |
  PROC3 %in% codes_PET |
  PROC4 %in% codes_PET |
  PROC5 %in% codes_PET |
  PROC6 %in% codes_PET |
  PROC7 %in% codes_PET |
  PROC8 %in% codes_PET |
  PROC9 %in% codes_PET |
  PROC10 %in% codes_PET |
  PROC11 %in% codes_PET |
  PROC12 %in% codes_PET |
  PROC13 %in% codes_PET |  
  PROC14 %in% codes_PET |
  PROC15 %in% codes_PET
  ) %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

PET2008_o <- ms_o_2008 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_PET
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2009#################################
PET2009_i <- ms_i_2009 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_PET |
  PROC1 %in% codes_PET |
  PROC2 %in% codes_PET |
  PROC3 %in% codes_PET |
  PROC4 %in% codes_PET |
  PROC5 %in% codes_PET |
  PROC6 %in% codes_PET |
  PROC7 %in% codes_PET |
  PROC8 %in% codes_PET |
  PROC9 %in% codes_PET |
  PROC10 %in% codes_PET |
  PROC11 %in% codes_PET |
  PROC12 %in% codes_PET |
  PROC13 %in% codes_PET |  
  PROC14 %in% codes_PET |
  PROC15 %in% codes_PET
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

PET2009_o <- ms_o_2009 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_PET
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2010#################################
PET2010_i <- ms_i_2010 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_PET |
  PROC1 %in% codes_PET |
  PROC2 %in% codes_PET |
  PROC3 %in% codes_PET |
  PROC4 %in% codes_PET |
  PROC5 %in% codes_PET |
  PROC6 %in% codes_PET |
  PROC7 %in% codes_PET |
  PROC8 %in% codes_PET |
  PROC9 %in% codes_PET |
  PROC10 %in% codes_PET |
  PROC11 %in% codes_PET |
  PROC12 %in% codes_PET |
  PROC13 %in% codes_PET |  
  PROC14 %in% codes_PET |
  PROC15 %in% codes_PET
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

PET2010_o <- ms_o_2010 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_PET
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2011#################################
PET2011_i <- ms_i_2011 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_PET |
  PROC1 %in% codes_PET |
  PROC2 %in% codes_PET |
  PROC3 %in% codes_PET |
  PROC4 %in% codes_PET |
  PROC5 %in% codes_PET |
  PROC6 %in% codes_PET |
  PROC7 %in% codes_PET |
  PROC8 %in% codes_PET |
  PROC9 %in% codes_PET |
  PROC10 %in% codes_PET |
  PROC11 %in% codes_PET |
  PROC12 %in% codes_PET |
  PROC13 %in% codes_PET |  
  PROC14 %in% codes_PET |
  PROC15 %in% codes_PET
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

PET2011_o <- ms_o_2011 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_PET
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2012#################################
PET2012_i <- ms_i_2012 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_PET |
  PROC1 %in% codes_PET |
  PROC2 %in% codes_PET |
  PROC3 %in% codes_PET |
  PROC4 %in% codes_PET |
  PROC5 %in% codes_PET |
  PROC6 %in% codes_PET |
  PROC7 %in% codes_PET |
  PROC8 %in% codes_PET |
  PROC9 %in% codes_PET |
  PROC10 %in% codes_PET |
  PROC11 %in% codes_PET |
  PROC12 %in% codes_PET |
  PROC13 %in% codes_PET |  
  PROC14 %in% codes_PET |
  PROC15 %in% codes_PET
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

PET2012_o <- ms_o_2012 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_PET
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2013#################################
PET2013_i <- ms_i_2013 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_PET |
  PROC1 %in% codes_PET |
  PROC2 %in% codes_PET |
  PROC3 %in% codes_PET |
  PROC4 %in% codes_PET |
  PROC5 %in% codes_PET |
  PROC6 %in% codes_PET |
  PROC7 %in% codes_PET |
  PROC8 %in% codes_PET |
  PROC9 %in% codes_PET |
  PROC10 %in% codes_PET |
  PROC11 %in% codes_PET |
  PROC12 %in% codes_PET |
  PROC13 %in% codes_PET |  
  PROC14 %in% codes_PET |
  PROC15 %in% codes_PET
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

PET2013_o <- ms_o_2013 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_PET
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2014#################################
PET2014_i <- ms_i_2014 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_PET |
  PROC1 %in% codes_PET |
  PROC2 %in% codes_PET |
  PROC3 %in% codes_PET |
  PROC4 %in% codes_PET |
  PROC5 %in% codes_PET |
  PROC6 %in% codes_PET |
  PROC7 %in% codes_PET |
  PROC8 %in% codes_PET |
  PROC9 %in% codes_PET |
  PROC10 %in% codes_PET |
  PROC11 %in% codes_PET |
  PROC12 %in% codes_PET |
  PROC13 %in% codes_PET |  
  PROC14 %in% codes_PET |
  PROC15 %in% codes_PET
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

PET2014_o <- ms_o_2014 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_PET
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2015#################################
PET2015_i <- ms_i_2015 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_PET |
  PROC1 %in% codes_PET |
  PROC2 %in% codes_PET |
  PROC3 %in% codes_PET |
  PROC4 %in% codes_PET |
  PROC5 %in% codes_PET |
  PROC6 %in% codes_PET |
  PROC7 %in% codes_PET |
  PROC8 %in% codes_PET |
  PROC9 %in% codes_PET |
  PROC10 %in% codes_PET |
  PROC11 %in% codes_PET |
  PROC12 %in% codes_PET |
  PROC13 %in% codes_PET |  
  PROC14 %in% codes_PET |
  PROC15 %in% codes_PET
  ) %>%  
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

PET2015_o <- ms_o_2015 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_PET
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2016#################################
PET2016_i <- ms_i_2016 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_PET |
  PROC1 %in% codes_PET |
  PROC2 %in% codes_PET |
  PROC3 %in% codes_PET |
  PROC4 %in% codes_PET |
  PROC5 %in% codes_PET |
  PROC6 %in% codes_PET |
  PROC7 %in% codes_PET |
  PROC8 %in% codes_PET |
  PROC9 %in% codes_PET |
  PROC10 %in% codes_PET |
  PROC11 %in% codes_PET |
  PROC12 %in% codes_PET |
  PROC13 %in% codes_PET |  
  PROC14 %in% codes_PET |
  PROC15 %in% codes_PET
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

PET2016_o <- ms_o_2016 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_PET
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2017#################################
PET2017_i <- ms_i_2017 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_PET |
  PROC1 %in% codes_PET |
  PROC2 %in% codes_PET |
  PROC3 %in% codes_PET |
  PROC4 %in% codes_PET |
  PROC5 %in% codes_PET |
  PROC6 %in% codes_PET |
  PROC7 %in% codes_PET |
  PROC8 %in% codes_PET |
  PROC9 %in% codes_PET |
  PROC10 %in% codes_PET |
  PROC11 %in% codes_PET |
  PROC12 %in% codes_PET |
  PROC13 %in% codes_PET |  
  PROC14 %in% codes_PET |
  PROC15 %in% codes_PET
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

PET2017_o <- ms_o_2017 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_PET
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2018#################################
PET2018_i <- ms_i_2018 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_PET |
  PROC1 %in% codes_PET |
  PROC2 %in% codes_PET |
  PROC3 %in% codes_PET |
  PROC4 %in% codes_PET |
  PROC5 %in% codes_PET |
  PROC6 %in% codes_PET |
  PROC7 %in% codes_PET |
  PROC8 %in% codes_PET |
  PROC9 %in% codes_PET |
  PROC10 %in% codes_PET |
  PROC11 %in% codes_PET |
  PROC12 %in% codes_PET |
  PROC13 %in% codes_PET |  
  PROC14 %in% codes_PET |
  PROC15 %in% codes_PET
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

PET2018_o <- ms_o_2018 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_PET
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2019#################################
PET2019_i <- ms_i_2019 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_PET |
  PROC1 %in% codes_PET |
  PROC2 %in% codes_PET |
  PROC3 %in% codes_PET |
  PROC4 %in% codes_PET |
  PROC5 %in% codes_PET |
  PROC6 %in% codes_PET |
  PROC7 %in% codes_PET |
  PROC8 %in% codes_PET |
  PROC9 %in% codes_PET |
  PROC10 %in% codes_PET |
  PROC11 %in% codes_PET |
  PROC12 %in% codes_PET |
  PROC13 %in% codes_PET |  
  PROC14 %in% codes_PET |
  PROC15 %in% codes_PET
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

PET2019_o <- ms_o_2019 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_PET
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


# Brain PET
PET <- bind_rows(PET2006_i, PET2006_o, PET2007_i, PET2007_o, PET2008_i, PET2008_o, PET2009_i, PET2009_o, PET2010_i, PET2010_o, PET2011_i, PET2011_o, PET2012_i, PET2012_o, PET2013_i, PET2013_o, PET2014_i, PET2014_o, PET2015_i, PET2015_o, PET2016_i, PET2016_o, PET2017_i, PET2017_o, PET2018_i, PET2018_o, PET2019_i, PET2019_o) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  arrange(SVCDATE, .by_group=TRUE) %>% 
  mutate(difference_between_procedures=SVCDATE - lag(SVCDATE, 1))

# Individual brain PET
procedure_PET_n <- PET %>% distinct(ENROLID, SVCDATE) %>% nrow()
procedure_PET_n 

# Individual patients with brain PET
patients_PET_n <- PET %>% distinct(ENROLID) %>% nrow()
patients_PET_n 

# Tally of patients with more than one brain PET
tally_PET <- PET %>% group_by(ENROLID) %>% tally(name="number_procedures")  %>% group_by(number_procedures) %>% tally(name="number_patients")
tally_PET

# Period between individual brain PETs in patients with repeated procedures
period_between_PETs <- summary(as.numeric(PET$difference_between_procedures))
period_between_PETs
```




Identify patients with brain SPECT
```{r}
# Codes for patients with brain SPECT
codes_SPECT <- c("78607")


#################################2006#################################
SPECT2006_i <- ms_i_2006 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_SPECT |
  PROC1 %in% codes_SPECT |
  PROC2 %in% codes_SPECT |
  PROC3 %in% codes_SPECT |
  PROC4 %in% codes_SPECT |
  PROC5 %in% codes_SPECT |
  PROC6 %in% codes_SPECT |
  PROC7 %in% codes_SPECT |
  PROC8 %in% codes_SPECT |
  PROC9 %in% codes_SPECT |
  PROC10 %in% codes_SPECT |
  PROC11 %in% codes_SPECT |
  PROC12 %in% codes_SPECT |
  PROC13 %in% codes_SPECT |  
  PROC14 %in% codes_SPECT |
  PROC15 %in% codes_SPECT
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

SPECT2006_o <- ms_o_2006 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_SPECT
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2007#################################
SPECT2007_i <- ms_i_2007 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_SPECT |
  PROC1 %in% codes_SPECT |
  PROC2 %in% codes_SPECT |
  PROC3 %in% codes_SPECT |
  PROC4 %in% codes_SPECT |
  PROC5 %in% codes_SPECT |
  PROC6 %in% codes_SPECT |
  PROC7 %in% codes_SPECT |
  PROC8 %in% codes_SPECT |
  PROC9 %in% codes_SPECT |
  PROC10 %in% codes_SPECT |
  PROC11 %in% codes_SPECT |
  PROC12 %in% codes_SPECT |
  PROC13 %in% codes_SPECT |  
  PROC14 %in% codes_SPECT |
  PROC15 %in% codes_SPECT
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

SPECT2007_o <- ms_o_2007 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_SPECT
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2008#################################
SPECT2008_i <- ms_i_2008 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_SPECT |
  PROC1 %in% codes_SPECT |
  PROC2 %in% codes_SPECT |
  PROC3 %in% codes_SPECT |
  PROC4 %in% codes_SPECT |
  PROC5 %in% codes_SPECT |
  PROC6 %in% codes_SPECT |
  PROC7 %in% codes_SPECT |
  PROC8 %in% codes_SPECT |
  PROC9 %in% codes_SPECT |
  PROC10 %in% codes_SPECT |
  PROC11 %in% codes_SPECT |
  PROC12 %in% codes_SPECT |
  PROC13 %in% codes_SPECT |  
  PROC14 %in% codes_SPECT |
  PROC15 %in% codes_SPECT
  ) %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

SPECT2008_o <- ms_o_2008 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_SPECT
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2009#################################
SPECT2009_i <- ms_i_2009 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_SPECT |
  PROC1 %in% codes_SPECT |
  PROC2 %in% codes_SPECT |
  PROC3 %in% codes_SPECT |
  PROC4 %in% codes_SPECT |
  PROC5 %in% codes_SPECT |
  PROC6 %in% codes_SPECT |
  PROC7 %in% codes_SPECT |
  PROC8 %in% codes_SPECT |
  PROC9 %in% codes_SPECT |
  PROC10 %in% codes_SPECT |
  PROC11 %in% codes_SPECT |
  PROC12 %in% codes_SPECT |
  PROC13 %in% codes_SPECT |  
  PROC14 %in% codes_SPECT |
  PROC15 %in% codes_SPECT
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

SPECT2009_o <- ms_o_2009 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_SPECT
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2010#################################
SPECT2010_i <- ms_i_2010 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_SPECT |
  PROC1 %in% codes_SPECT |
  PROC2 %in% codes_SPECT |
  PROC3 %in% codes_SPECT |
  PROC4 %in% codes_SPECT |
  PROC5 %in% codes_SPECT |
  PROC6 %in% codes_SPECT |
  PROC7 %in% codes_SPECT |
  PROC8 %in% codes_SPECT |
  PROC9 %in% codes_SPECT |
  PROC10 %in% codes_SPECT |
  PROC11 %in% codes_SPECT |
  PROC12 %in% codes_SPECT |
  PROC13 %in% codes_SPECT |  
  PROC14 %in% codes_SPECT |
  PROC15 %in% codes_SPECT
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

SPECT2010_o <- ms_o_2010 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_SPECT
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2011#################################
SPECT2011_i <- ms_i_2011 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_SPECT |
  PROC1 %in% codes_SPECT |
  PROC2 %in% codes_SPECT |
  PROC3 %in% codes_SPECT |
  PROC4 %in% codes_SPECT |
  PROC5 %in% codes_SPECT |
  PROC6 %in% codes_SPECT |
  PROC7 %in% codes_SPECT |
  PROC8 %in% codes_SPECT |
  PROC9 %in% codes_SPECT |
  PROC10 %in% codes_SPECT |
  PROC11 %in% codes_SPECT |
  PROC12 %in% codes_SPECT |
  PROC13 %in% codes_SPECT |  
  PROC14 %in% codes_SPECT |
  PROC15 %in% codes_SPECT
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

SPECT2011_o <- ms_o_2011 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_SPECT
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2012#################################
SPECT2012_i <- ms_i_2012 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_SPECT |
  PROC1 %in% codes_SPECT |
  PROC2 %in% codes_SPECT |
  PROC3 %in% codes_SPECT |
  PROC4 %in% codes_SPECT |
  PROC5 %in% codes_SPECT |
  PROC6 %in% codes_SPECT |
  PROC7 %in% codes_SPECT |
  PROC8 %in% codes_SPECT |
  PROC9 %in% codes_SPECT |
  PROC10 %in% codes_SPECT |
  PROC11 %in% codes_SPECT |
  PROC12 %in% codes_SPECT |
  PROC13 %in% codes_SPECT |  
  PROC14 %in% codes_SPECT |
  PROC15 %in% codes_SPECT
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

SPECT2012_o <- ms_o_2012 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_SPECT
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2013#################################
SPECT2013_i <- ms_i_2013 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_SPECT |
  PROC1 %in% codes_SPECT |
  PROC2 %in% codes_SPECT |
  PROC3 %in% codes_SPECT |
  PROC4 %in% codes_SPECT |
  PROC5 %in% codes_SPECT |
  PROC6 %in% codes_SPECT |
  PROC7 %in% codes_SPECT |
  PROC8 %in% codes_SPECT |
  PROC9 %in% codes_SPECT |
  PROC10 %in% codes_SPECT |
  PROC11 %in% codes_SPECT |
  PROC12 %in% codes_SPECT |
  PROC13 %in% codes_SPECT |  
  PROC14 %in% codes_SPECT |
  PROC15 %in% codes_SPECT
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

SPECT2013_o <- ms_o_2013 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_SPECT
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2014#################################
SPECT2014_i <- ms_i_2014 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_SPECT |
  PROC1 %in% codes_SPECT |
  PROC2 %in% codes_SPECT |
  PROC3 %in% codes_SPECT |
  PROC4 %in% codes_SPECT |
  PROC5 %in% codes_SPECT |
  PROC6 %in% codes_SPECT |
  PROC7 %in% codes_SPECT |
  PROC8 %in% codes_SPECT |
  PROC9 %in% codes_SPECT |
  PROC10 %in% codes_SPECT |
  PROC11 %in% codes_SPECT |
  PROC12 %in% codes_SPECT |
  PROC13 %in% codes_SPECT |  
  PROC14 %in% codes_SPECT |
  PROC15 %in% codes_SPECT
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

SPECT2014_o <- ms_o_2014 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_SPECT
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2015#################################
SPECT2015_i <- ms_i_2015 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_SPECT |
  PROC1 %in% codes_SPECT |
  PROC2 %in% codes_SPECT |
  PROC3 %in% codes_SPECT |
  PROC4 %in% codes_SPECT |
  PROC5 %in% codes_SPECT |
  PROC6 %in% codes_SPECT |
  PROC7 %in% codes_SPECT |
  PROC8 %in% codes_SPECT |
  PROC9 %in% codes_SPECT |
  PROC10 %in% codes_SPECT |
  PROC11 %in% codes_SPECT |
  PROC12 %in% codes_SPECT |
  PROC13 %in% codes_SPECT |  
  PROC14 %in% codes_SPECT |
  PROC15 %in% codes_SPECT
  ) %>%  
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

SPECT2015_o <- ms_o_2015 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_SPECT
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2016#################################
SPECT2016_i <- ms_i_2016 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_SPECT |
  PROC1 %in% codes_SPECT |
  PROC2 %in% codes_SPECT |
  PROC3 %in% codes_SPECT |
  PROC4 %in% codes_SPECT |
  PROC5 %in% codes_SPECT |
  PROC6 %in% codes_SPECT |
  PROC7 %in% codes_SPECT |
  PROC8 %in% codes_SPECT |
  PROC9 %in% codes_SPECT |
  PROC10 %in% codes_SPECT |
  PROC11 %in% codes_SPECT |
  PROC12 %in% codes_SPECT |
  PROC13 %in% codes_SPECT |  
  PROC14 %in% codes_SPECT |
  PROC15 %in% codes_SPECT
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

SPECT2016_o <- ms_o_2016 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_SPECT
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2017#################################
SPECT2017_i <- ms_i_2017 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_SPECT |
  PROC1 %in% codes_SPECT |
  PROC2 %in% codes_SPECT |
  PROC3 %in% codes_SPECT |
  PROC4 %in% codes_SPECT |
  PROC5 %in% codes_SPECT |
  PROC6 %in% codes_SPECT |
  PROC7 %in% codes_SPECT |
  PROC8 %in% codes_SPECT |
  PROC9 %in% codes_SPECT |
  PROC10 %in% codes_SPECT |
  PROC11 %in% codes_SPECT |
  PROC12 %in% codes_SPECT |
  PROC13 %in% codes_SPECT |  
  PROC14 %in% codes_SPECT |
  PROC15 %in% codes_SPECT
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

SPECT2017_o <- ms_o_2017 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_SPECT
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2018#################################
SPECT2018_i <- ms_i_2018 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_SPECT |
  PROC1 %in% codes_SPECT |
  PROC2 %in% codes_SPECT |
  PROC3 %in% codes_SPECT |
  PROC4 %in% codes_SPECT |
  PROC5 %in% codes_SPECT |
  PROC6 %in% codes_SPECT |
  PROC7 %in% codes_SPECT |
  PROC8 %in% codes_SPECT |
  PROC9 %in% codes_SPECT |
  PROC10 %in% codes_SPECT |
  PROC11 %in% codes_SPECT |
  PROC12 %in% codes_SPECT |
  PROC13 %in% codes_SPECT |  
  PROC14 %in% codes_SPECT |
  PROC15 %in% codes_SPECT
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

SPECT2018_o <- ms_o_2018 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_SPECT
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2019#################################
SPECT2019_i <- ms_i_2019 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_SPECT |
  PROC1 %in% codes_SPECT |
  PROC2 %in% codes_SPECT |
  PROC3 %in% codes_SPECT |
  PROC4 %in% codes_SPECT |
  PROC5 %in% codes_SPECT |
  PROC6 %in% codes_SPECT |
  PROC7 %in% codes_SPECT |
  PROC8 %in% codes_SPECT |
  PROC9 %in% codes_SPECT |
  PROC10 %in% codes_SPECT |
  PROC11 %in% codes_SPECT |
  PROC12 %in% codes_SPECT |
  PROC13 %in% codes_SPECT |  
  PROC14 %in% codes_SPECT |
  PROC15 %in% codes_SPECT
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

SPECT2019_o <- ms_o_2019 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_SPECT
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


# Brain SPECT
SPECT <- bind_rows(SPECT2006_i, SPECT2006_o, SPECT2007_i, SPECT2007_o, SPECT2008_i, SPECT2008_o, SPECT2009_i, SPECT2009_o, SPECT2010_i, SPECT2010_o, SPECT2011_i, SPECT2011_o, SPECT2012_i, SPECT2012_o, SPECT2013_i, SPECT2013_o, SPECT2014_i, SPECT2014_o, SPECT2015_i, SPECT2015_o, SPECT2016_i, SPECT2016_o, SPECT2017_i, SPECT2017_o, SPECT2018_i, SPECT2018_o, SPECT2019_i, SPECT2019_o) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  arrange(SVCDATE, .by_group=TRUE) %>% 
  mutate(difference_between_procedures=SVCDATE - lag(SVCDATE, 1))

# Individual brain SPECT
procedure_SPECT_n <- SPECT %>% distinct(ENROLID, SVCDATE) %>% nrow()
procedure_SPECT_n 

# Individual patients with brain SPECT
patients_SPECT_n <- SPECT %>% distinct(ENROLID) %>% nrow()
patients_SPECT_n 

# Tally of patients with more than one brain SPECT
tally_SPECT <- SPECT %>% group_by(ENROLID) %>% tally(name="number_procedures")  %>% group_by(number_procedures) %>% tally(name="number_patients")
tally_SPECT

# Period between individual brain SPECTs in patients with repeated procedures
period_between_SPECTs <- summary(as.numeric(SPECT$difference_between_procedures))
period_between_SPECTs
```




Identify patients with brain MEG
```{r}
# Codes for patients with brain MEG
codes_MEG <- c("95965", "95966", "95967")


#################################2006#################################
MEG2006_i <- ms_i_2006 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_MEG |
  PROC1 %in% codes_MEG |
  PROC2 %in% codes_MEG |
  PROC3 %in% codes_MEG |
  PROC4 %in% codes_MEG |
  PROC5 %in% codes_MEG |
  PROC6 %in% codes_MEG |
  PROC7 %in% codes_MEG |
  PROC8 %in% codes_MEG |
  PROC9 %in% codes_MEG |
  PROC10 %in% codes_MEG |
  PROC11 %in% codes_MEG |
  PROC12 %in% codes_MEG |
  PROC13 %in% codes_MEG |  
  PROC14 %in% codes_MEG |
  PROC15 %in% codes_MEG
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

MEG2006_o <- ms_o_2006 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_MEG
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2007#################################
MEG2007_i <- ms_i_2007 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_MEG |
  PROC1 %in% codes_MEG |
  PROC2 %in% codes_MEG |
  PROC3 %in% codes_MEG |
  PROC4 %in% codes_MEG |
  PROC5 %in% codes_MEG |
  PROC6 %in% codes_MEG |
  PROC7 %in% codes_MEG |
  PROC8 %in% codes_MEG |
  PROC9 %in% codes_MEG |
  PROC10 %in% codes_MEG |
  PROC11 %in% codes_MEG |
  PROC12 %in% codes_MEG |
  PROC13 %in% codes_MEG |  
  PROC14 %in% codes_MEG |
  PROC15 %in% codes_MEG
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

MEG2007_o <- ms_o_2007 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_MEG
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2008#################################
MEG2008_i <- ms_i_2008 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_MEG |
  PROC1 %in% codes_MEG |
  PROC2 %in% codes_MEG |
  PROC3 %in% codes_MEG |
  PROC4 %in% codes_MEG |
  PROC5 %in% codes_MEG |
  PROC6 %in% codes_MEG |
  PROC7 %in% codes_MEG |
  PROC8 %in% codes_MEG |
  PROC9 %in% codes_MEG |
  PROC10 %in% codes_MEG |
  PROC11 %in% codes_MEG |
  PROC12 %in% codes_MEG |
  PROC13 %in% codes_MEG |  
  PROC14 %in% codes_MEG |
  PROC15 %in% codes_MEG
  ) %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

MEG2008_o <- ms_o_2008 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_MEG
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2009#################################
MEG2009_i <- ms_i_2009 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_MEG |
  PROC1 %in% codes_MEG |
  PROC2 %in% codes_MEG |
  PROC3 %in% codes_MEG |
  PROC4 %in% codes_MEG |
  PROC5 %in% codes_MEG |
  PROC6 %in% codes_MEG |
  PROC7 %in% codes_MEG |
  PROC8 %in% codes_MEG |
  PROC9 %in% codes_MEG |
  PROC10 %in% codes_MEG |
  PROC11 %in% codes_MEG |
  PROC12 %in% codes_MEG |
  PROC13 %in% codes_MEG |  
  PROC14 %in% codes_MEG |
  PROC15 %in% codes_MEG
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

MEG2009_o <- ms_o_2009 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_MEG
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2010#################################
MEG2010_i <- ms_i_2010 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_MEG |
  PROC1 %in% codes_MEG |
  PROC2 %in% codes_MEG |
  PROC3 %in% codes_MEG |
  PROC4 %in% codes_MEG |
  PROC5 %in% codes_MEG |
  PROC6 %in% codes_MEG |
  PROC7 %in% codes_MEG |
  PROC8 %in% codes_MEG |
  PROC9 %in% codes_MEG |
  PROC10 %in% codes_MEG |
  PROC11 %in% codes_MEG |
  PROC12 %in% codes_MEG |
  PROC13 %in% codes_MEG |  
  PROC14 %in% codes_MEG |
  PROC15 %in% codes_MEG
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

MEG2010_o <- ms_o_2010 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_MEG
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2011#################################
MEG2011_i <- ms_i_2011 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_MEG |
  PROC1 %in% codes_MEG |
  PROC2 %in% codes_MEG |
  PROC3 %in% codes_MEG |
  PROC4 %in% codes_MEG |
  PROC5 %in% codes_MEG |
  PROC6 %in% codes_MEG |
  PROC7 %in% codes_MEG |
  PROC8 %in% codes_MEG |
  PROC9 %in% codes_MEG |
  PROC10 %in% codes_MEG |
  PROC11 %in% codes_MEG |
  PROC12 %in% codes_MEG |
  PROC13 %in% codes_MEG |  
  PROC14 %in% codes_MEG |
  PROC15 %in% codes_MEG
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

MEG2011_o <- ms_o_2011 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_MEG
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2012#################################
MEG2012_i <- ms_i_2012 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_MEG |
  PROC1 %in% codes_MEG |
  PROC2 %in% codes_MEG |
  PROC3 %in% codes_MEG |
  PROC4 %in% codes_MEG |
  PROC5 %in% codes_MEG |
  PROC6 %in% codes_MEG |
  PROC7 %in% codes_MEG |
  PROC8 %in% codes_MEG |
  PROC9 %in% codes_MEG |
  PROC10 %in% codes_MEG |
  PROC11 %in% codes_MEG |
  PROC12 %in% codes_MEG |
  PROC13 %in% codes_MEG |  
  PROC14 %in% codes_MEG |
  PROC15 %in% codes_MEG
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

MEG2012_o <- ms_o_2012 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_MEG
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2013#################################
MEG2013_i <- ms_i_2013 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_MEG |
  PROC1 %in% codes_MEG |
  PROC2 %in% codes_MEG |
  PROC3 %in% codes_MEG |
  PROC4 %in% codes_MEG |
  PROC5 %in% codes_MEG |
  PROC6 %in% codes_MEG |
  PROC7 %in% codes_MEG |
  PROC8 %in% codes_MEG |
  PROC9 %in% codes_MEG |
  PROC10 %in% codes_MEG |
  PROC11 %in% codes_MEG |
  PROC12 %in% codes_MEG |
  PROC13 %in% codes_MEG |  
  PROC14 %in% codes_MEG |
  PROC15 %in% codes_MEG
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

MEG2013_o <- ms_o_2013 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_MEG
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2014#################################
MEG2014_i <- ms_i_2014 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_MEG |
  PROC1 %in% codes_MEG |
  PROC2 %in% codes_MEG |
  PROC3 %in% codes_MEG |
  PROC4 %in% codes_MEG |
  PROC5 %in% codes_MEG |
  PROC6 %in% codes_MEG |
  PROC7 %in% codes_MEG |
  PROC8 %in% codes_MEG |
  PROC9 %in% codes_MEG |
  PROC10 %in% codes_MEG |
  PROC11 %in% codes_MEG |
  PROC12 %in% codes_MEG |
  PROC13 %in% codes_MEG |  
  PROC14 %in% codes_MEG |
  PROC15 %in% codes_MEG
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

MEG2014_o <- ms_o_2014 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_MEG
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2015#################################
MEG2015_i <- ms_i_2015 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_MEG |
  PROC1 %in% codes_MEG |
  PROC2 %in% codes_MEG |
  PROC3 %in% codes_MEG |
  PROC4 %in% codes_MEG |
  PROC5 %in% codes_MEG |
  PROC6 %in% codes_MEG |
  PROC7 %in% codes_MEG |
  PROC8 %in% codes_MEG |
  PROC9 %in% codes_MEG |
  PROC10 %in% codes_MEG |
  PROC11 %in% codes_MEG |
  PROC12 %in% codes_MEG |
  PROC13 %in% codes_MEG |  
  PROC14 %in% codes_MEG |
  PROC15 %in% codes_MEG
  ) %>%  
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

MEG2015_o <- ms_o_2015 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_MEG
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2016#################################
MEG2016_i <- ms_i_2016 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_MEG |
  PROC1 %in% codes_MEG |
  PROC2 %in% codes_MEG |
  PROC3 %in% codes_MEG |
  PROC4 %in% codes_MEG |
  PROC5 %in% codes_MEG |
  PROC6 %in% codes_MEG |
  PROC7 %in% codes_MEG |
  PROC8 %in% codes_MEG |
  PROC9 %in% codes_MEG |
  PROC10 %in% codes_MEG |
  PROC11 %in% codes_MEG |
  PROC12 %in% codes_MEG |
  PROC13 %in% codes_MEG |  
  PROC14 %in% codes_MEG |
  PROC15 %in% codes_MEG
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

MEG2016_o <- ms_o_2016 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_MEG
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2017#################################
MEG2017_i <- ms_i_2017 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_MEG |
  PROC1 %in% codes_MEG |
  PROC2 %in% codes_MEG |
  PROC3 %in% codes_MEG |
  PROC4 %in% codes_MEG |
  PROC5 %in% codes_MEG |
  PROC6 %in% codes_MEG |
  PROC7 %in% codes_MEG |
  PROC8 %in% codes_MEG |
  PROC9 %in% codes_MEG |
  PROC10 %in% codes_MEG |
  PROC11 %in% codes_MEG |
  PROC12 %in% codes_MEG |
  PROC13 %in% codes_MEG |  
  PROC14 %in% codes_MEG |
  PROC15 %in% codes_MEG
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

MEG2017_o <- ms_o_2017 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_MEG
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2018#################################
MEG2018_i <- ms_i_2018 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_MEG |
  PROC1 %in% codes_MEG |
  PROC2 %in% codes_MEG |
  PROC3 %in% codes_MEG |
  PROC4 %in% codes_MEG |
  PROC5 %in% codes_MEG |
  PROC6 %in% codes_MEG |
  PROC7 %in% codes_MEG |
  PROC8 %in% codes_MEG |
  PROC9 %in% codes_MEG |
  PROC10 %in% codes_MEG |
  PROC11 %in% codes_MEG |
  PROC12 %in% codes_MEG |
  PROC13 %in% codes_MEG |  
  PROC14 %in% codes_MEG |
  PROC15 %in% codes_MEG
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

MEG2018_o <- ms_o_2018 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_MEG
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2019#################################
MEG2019_i <- ms_i_2019 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_MEG |
  PROC1 %in% codes_MEG |
  PROC2 %in% codes_MEG |
  PROC3 %in% codes_MEG |
  PROC4 %in% codes_MEG |
  PROC5 %in% codes_MEG |
  PROC6 %in% codes_MEG |
  PROC7 %in% codes_MEG |
  PROC8 %in% codes_MEG |
  PROC9 %in% codes_MEG |
  PROC10 %in% codes_MEG |
  PROC11 %in% codes_MEG |
  PROC12 %in% codes_MEG |
  PROC13 %in% codes_MEG |  
  PROC14 %in% codes_MEG |
  PROC15 %in% codes_MEG
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

MEG2019_o <- ms_o_2019 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_MEG
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


# Brain MEG
MEG <- bind_rows(MEG2006_i, MEG2006_o, MEG2007_i, MEG2007_o, MEG2008_i, MEG2008_o, MEG2009_i, MEG2009_o, MEG2010_i, MEG2010_o, MEG2011_i, MEG2011_o, MEG2012_i, MEG2012_o, MEG2013_i, MEG2013_o, MEG2014_i, MEG2014_o, MEG2015_i, MEG2015_o, MEG2016_i, MEG2016_o, MEG2017_i, MEG2017_o, MEG2018_i, MEG2018_o, MEG2019_i, MEG2019_o) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  arrange(SVCDATE, .by_group=TRUE) %>% 
  mutate(difference_between_procedures=SVCDATE - lag(SVCDATE, 1))

# Individual brain MEG
procedure_MEG_n <- MEG %>% distinct(ENROLID, SVCDATE) %>% nrow()
procedure_MEG_n 

# Individual patients with brain MEG
patients_MEG_n <- MEG %>% distinct(ENROLID) %>% nrow()
patients_MEG_n 

# Tally of patients with more than one brain MEG
tally_MEG <- MEG %>% group_by(ENROLID) %>% tally(name="number_procedures")  %>% group_by(number_procedures) %>% tally(name="number_patients")
tally_MEG

# Period between individual brain MEGs in patients with repeated procedures
period_between_MEGs <- summary(as.numeric(MEG$difference_between_procedures))
period_between_MEGs
```




Identify patients with Wada test
```{r}
# Codes for patients with Wada test
codes_Wada <- c("95958")


#################################2006#################################
Wada2006_i <- ms_i_2006 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_Wada |
  PROC1 %in% codes_Wada |
  PROC2 %in% codes_Wada |
  PROC3 %in% codes_Wada |
  PROC4 %in% codes_Wada |
  PROC5 %in% codes_Wada |
  PROC6 %in% codes_Wada |
  PROC7 %in% codes_Wada |
  PROC8 %in% codes_Wada |
  PROC9 %in% codes_Wada |
  PROC10 %in% codes_Wada |
  PROC11 %in% codes_Wada |
  PROC12 %in% codes_Wada |
  PROC13 %in% codes_Wada |  
  PROC14 %in% codes_Wada |
  PROC15 %in% codes_Wada
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

Wada2006_o <- ms_o_2006 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_Wada
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2007#################################
Wada2007_i <- ms_i_2007 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_Wada |
  PROC1 %in% codes_Wada |
  PROC2 %in% codes_Wada |
  PROC3 %in% codes_Wada |
  PROC4 %in% codes_Wada |
  PROC5 %in% codes_Wada |
  PROC6 %in% codes_Wada |
  PROC7 %in% codes_Wada |
  PROC8 %in% codes_Wada |
  PROC9 %in% codes_Wada |
  PROC10 %in% codes_Wada |
  PROC11 %in% codes_Wada |
  PROC12 %in% codes_Wada |
  PROC13 %in% codes_Wada |  
  PROC14 %in% codes_Wada |
  PROC15 %in% codes_Wada
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

Wada2007_o <- ms_o_2007 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_Wada
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2008#################################
Wada2008_i <- ms_i_2008 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_Wada |
  PROC1 %in% codes_Wada |
  PROC2 %in% codes_Wada |
  PROC3 %in% codes_Wada |
  PROC4 %in% codes_Wada |
  PROC5 %in% codes_Wada |
  PROC6 %in% codes_Wada |
  PROC7 %in% codes_Wada |
  PROC8 %in% codes_Wada |
  PROC9 %in% codes_Wada |
  PROC10 %in% codes_Wada |
  PROC11 %in% codes_Wada |
  PROC12 %in% codes_Wada |
  PROC13 %in% codes_Wada |  
  PROC14 %in% codes_Wada |
  PROC15 %in% codes_Wada
  ) %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

Wada2008_o <- ms_o_2008 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_Wada
                                     ) %>%
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2009#################################
Wada2009_i <- ms_i_2009 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_Wada |
  PROC1 %in% codes_Wada |
  PROC2 %in% codes_Wada |
  PROC3 %in% codes_Wada |
  PROC4 %in% codes_Wada |
  PROC5 %in% codes_Wada |
  PROC6 %in% codes_Wada |
  PROC7 %in% codes_Wada |
  PROC8 %in% codes_Wada |
  PROC9 %in% codes_Wada |
  PROC10 %in% codes_Wada |
  PROC11 %in% codes_Wada |
  PROC12 %in% codes_Wada |
  PROC13 %in% codes_Wada |  
  PROC14 %in% codes_Wada |
  PROC15 %in% codes_Wada
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

Wada2009_o <- ms_o_2009 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_Wada
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2010#################################
Wada2010_i <- ms_i_2010 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_Wada |
  PROC1 %in% codes_Wada |
  PROC2 %in% codes_Wada |
  PROC3 %in% codes_Wada |
  PROC4 %in% codes_Wada |
  PROC5 %in% codes_Wada |
  PROC6 %in% codes_Wada |
  PROC7 %in% codes_Wada |
  PROC8 %in% codes_Wada |
  PROC9 %in% codes_Wada |
  PROC10 %in% codes_Wada |
  PROC11 %in% codes_Wada |
  PROC12 %in% codes_Wada |
  PROC13 %in% codes_Wada |  
  PROC14 %in% codes_Wada |
  PROC15 %in% codes_Wada
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

Wada2010_o <- ms_o_2010 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_Wada
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2011#################################
Wada2011_i <- ms_i_2011 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_Wada |
  PROC1 %in% codes_Wada |
  PROC2 %in% codes_Wada |
  PROC3 %in% codes_Wada |
  PROC4 %in% codes_Wada |
  PROC5 %in% codes_Wada |
  PROC6 %in% codes_Wada |
  PROC7 %in% codes_Wada |
  PROC8 %in% codes_Wada |
  PROC9 %in% codes_Wada |
  PROC10 %in% codes_Wada |
  PROC11 %in% codes_Wada |
  PROC12 %in% codes_Wada |
  PROC13 %in% codes_Wada |  
  PROC14 %in% codes_Wada |
  PROC15 %in% codes_Wada
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

Wada2011_o <- ms_o_2011 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_Wada
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2012#################################
Wada2012_i <- ms_i_2012 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_Wada |
  PROC1 %in% codes_Wada |
  PROC2 %in% codes_Wada |
  PROC3 %in% codes_Wada |
  PROC4 %in% codes_Wada |
  PROC5 %in% codes_Wada |
  PROC6 %in% codes_Wada |
  PROC7 %in% codes_Wada |
  PROC8 %in% codes_Wada |
  PROC9 %in% codes_Wada |
  PROC10 %in% codes_Wada |
  PROC11 %in% codes_Wada |
  PROC12 %in% codes_Wada |
  PROC13 %in% codes_Wada |  
  PROC14 %in% codes_Wada |
  PROC15 %in% codes_Wada
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

Wada2012_o <- ms_o_2012 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_Wada
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2013#################################
Wada2013_i <- ms_i_2013 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_Wada |
  PROC1 %in% codes_Wada |
  PROC2 %in% codes_Wada |
  PROC3 %in% codes_Wada |
  PROC4 %in% codes_Wada |
  PROC5 %in% codes_Wada |
  PROC6 %in% codes_Wada |
  PROC7 %in% codes_Wada |
  PROC8 %in% codes_Wada |
  PROC9 %in% codes_Wada |
  PROC10 %in% codes_Wada |
  PROC11 %in% codes_Wada |
  PROC12 %in% codes_Wada |
  PROC13 %in% codes_Wada |  
  PROC14 %in% codes_Wada |
  PROC15 %in% codes_Wada
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

Wada2013_o <- ms_o_2013 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_Wada
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2014#################################
Wada2014_i <- ms_i_2014 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_Wada |
  PROC1 %in% codes_Wada |
  PROC2 %in% codes_Wada |
  PROC3 %in% codes_Wada |
  PROC4 %in% codes_Wada |
  PROC5 %in% codes_Wada |
  PROC6 %in% codes_Wada |
  PROC7 %in% codes_Wada |
  PROC8 %in% codes_Wada |
  PROC9 %in% codes_Wada |
  PROC10 %in% codes_Wada |
  PROC11 %in% codes_Wada |
  PROC12 %in% codes_Wada |
  PROC13 %in% codes_Wada |  
  PROC14 %in% codes_Wada |
  PROC15 %in% codes_Wada
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

Wada2014_o <- ms_o_2014 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_Wada
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2015#################################
Wada2015_i <- ms_i_2015 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_Wada |
  PROC1 %in% codes_Wada |
  PROC2 %in% codes_Wada |
  PROC3 %in% codes_Wada |
  PROC4 %in% codes_Wada |
  PROC5 %in% codes_Wada |
  PROC6 %in% codes_Wada |
  PROC7 %in% codes_Wada |
  PROC8 %in% codes_Wada |
  PROC9 %in% codes_Wada |
  PROC10 %in% codes_Wada |
  PROC11 %in% codes_Wada |
  PROC12 %in% codes_Wada |
  PROC13 %in% codes_Wada |  
  PROC14 %in% codes_Wada |
  PROC15 %in% codes_Wada
  ) %>%  
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

Wada2015_o <- ms_o_2015 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_Wada
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2016#################################
Wada2016_i <- ms_i_2016 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_Wada |
  PROC1 %in% codes_Wada |
  PROC2 %in% codes_Wada |
  PROC3 %in% codes_Wada |
  PROC4 %in% codes_Wada |
  PROC5 %in% codes_Wada |
  PROC6 %in% codes_Wada |
  PROC7 %in% codes_Wada |
  PROC8 %in% codes_Wada |
  PROC9 %in% codes_Wada |
  PROC10 %in% codes_Wada |
  PROC11 %in% codes_Wada |
  PROC12 %in% codes_Wada |
  PROC13 %in% codes_Wada |  
  PROC14 %in% codes_Wada |
  PROC15 %in% codes_Wada
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

Wada2016_o <- ms_o_2016 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_Wada
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2017#################################
Wada2017_i <- ms_i_2017 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_Wada |
  PROC1 %in% codes_Wada |
  PROC2 %in% codes_Wada |
  PROC3 %in% codes_Wada |
  PROC4 %in% codes_Wada |
  PROC5 %in% codes_Wada |
  PROC6 %in% codes_Wada |
  PROC7 %in% codes_Wada |
  PROC8 %in% codes_Wada |
  PROC9 %in% codes_Wada |
  PROC10 %in% codes_Wada |
  PROC11 %in% codes_Wada |
  PROC12 %in% codes_Wada |
  PROC13 %in% codes_Wada |  
  PROC14 %in% codes_Wada |
  PROC15 %in% codes_Wada
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

Wada2017_o <- ms_o_2017 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_Wada
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2018#################################
Wada2018_i <- ms_i_2018 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_Wada |
  PROC1 %in% codes_Wada |
  PROC2 %in% codes_Wada |
  PROC3 %in% codes_Wada |
  PROC4 %in% codes_Wada |
  PROC5 %in% codes_Wada |
  PROC6 %in% codes_Wada |
  PROC7 %in% codes_Wada |
  PROC8 %in% codes_Wada |
  PROC9 %in% codes_Wada |
  PROC10 %in% codes_Wada |
  PROC11 %in% codes_Wada |
  PROC12 %in% codes_Wada |
  PROC13 %in% codes_Wada |  
  PROC14 %in% codes_Wada |
  PROC15 %in% codes_Wada
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

Wada2018_o <- ms_o_2018 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_Wada
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2019#################################
Wada2019_i <- ms_i_2019 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_Wada |
  PROC1 %in% codes_Wada |
  PROC2 %in% codes_Wada |
  PROC3 %in% codes_Wada |
  PROC4 %in% codes_Wada |
  PROC5 %in% codes_Wada |
  PROC6 %in% codes_Wada |
  PROC7 %in% codes_Wada |
  PROC8 %in% codes_Wada |
  PROC9 %in% codes_Wada |
  PROC10 %in% codes_Wada |
  PROC11 %in% codes_Wada |
  PROC12 %in% codes_Wada |
  PROC13 %in% codes_Wada |  
  PROC14 %in% codes_Wada |
  PROC15 %in% codes_Wada
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

Wada2019_o <- ms_o_2019 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_Wada
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


# Wada test
Wada <- bind_rows(Wada2006_i, Wada2006_o, Wada2007_i, Wada2007_o, Wada2008_i, Wada2008_o, Wada2009_i, Wada2009_o, Wada2010_i, Wada2010_o, Wada2011_i, Wada2011_o, Wada2012_i, Wada2012_o, Wada2013_i, Wada2013_o, Wada2014_i, Wada2014_o, Wada2015_i, Wada2015_o, Wada2016_i, Wada2016_o, Wada2017_i, Wada2017_o, Wada2018_i, Wada2018_o, Wada2019_i, Wada2019_o) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  arrange(SVCDATE, .by_group=TRUE) %>% 
  mutate(difference_between_procedures=SVCDATE - lag(SVCDATE, 1))

# Individual Wada test
procedure_Wada_n <- Wada %>% distinct(ENROLID, SVCDATE) %>% nrow()
procedure_Wada_n 

# Individual patients with Wada test
patients_Wada_n <- Wada %>% distinct(ENROLID) %>% nrow()
patients_Wada_n 

# Tally of patients with more than one Wada test
tally_Wada <- Wada %>% group_by(ENROLID) %>% tally(name="number_procedures")  %>% group_by(number_procedures) %>% tally(name="number_patients")
tally_Wada

# Period between individual Wada tests in patients with repeated procedures
period_between_Wadas <- summary(as.numeric(Wada$difference_between_procedures))
period_between_Wadas
```




Identify patients with fMRI
```{r}
# Codes for patients with fMRI
codes_fMRI <- c("70554", "70555", "96020")


#################################2006#################################
fMRI2006_i <- ms_i_2006 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_fMRI |
  PROC1 %in% codes_fMRI |
  PROC2 %in% codes_fMRI |
  PROC3 %in% codes_fMRI |
  PROC4 %in% codes_fMRI |
  PROC5 %in% codes_fMRI |
  PROC6 %in% codes_fMRI |
  PROC7 %in% codes_fMRI |
  PROC8 %in% codes_fMRI |
  PROC9 %in% codes_fMRI |
  PROC10 %in% codes_fMRI |
  PROC11 %in% codes_fMRI |
  PROC12 %in% codes_fMRI |
  PROC13 %in% codes_fMRI |  
  PROC14 %in% codes_fMRI |
  PROC15 %in% codes_fMRI
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

fMRI2006_o <- ms_o_2006 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_fMRI
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2007#################################
fMRI2007_i <- ms_i_2007 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_fMRI |
  PROC1 %in% codes_fMRI |
  PROC2 %in% codes_fMRI |
  PROC3 %in% codes_fMRI |
  PROC4 %in% codes_fMRI |
  PROC5 %in% codes_fMRI |
  PROC6 %in% codes_fMRI |
  PROC7 %in% codes_fMRI |
  PROC8 %in% codes_fMRI |
  PROC9 %in% codes_fMRI |
  PROC10 %in% codes_fMRI |
  PROC11 %in% codes_fMRI |
  PROC12 %in% codes_fMRI |
  PROC13 %in% codes_fMRI |  
  PROC14 %in% codes_fMRI |
  PROC15 %in% codes_fMRI
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

fMRI2007_o <- ms_o_2007 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_fMRI
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2008#################################
fMRI2008_i <- ms_i_2008 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_fMRI |
  PROC1 %in% codes_fMRI |
  PROC2 %in% codes_fMRI |
  PROC3 %in% codes_fMRI |
  PROC4 %in% codes_fMRI |
  PROC5 %in% codes_fMRI |
  PROC6 %in% codes_fMRI |
  PROC7 %in% codes_fMRI |
  PROC8 %in% codes_fMRI |
  PROC9 %in% codes_fMRI |
  PROC10 %in% codes_fMRI |
  PROC11 %in% codes_fMRI |
  PROC12 %in% codes_fMRI |
  PROC13 %in% codes_fMRI |  
  PROC14 %in% codes_fMRI |
  PROC15 %in% codes_fMRI
  ) %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

fMRI2008_o <- ms_o_2008 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_fMRI
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2009#################################
fMRI2009_i <- ms_i_2009 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_fMRI |
  PROC1 %in% codes_fMRI |
  PROC2 %in% codes_fMRI |
  PROC3 %in% codes_fMRI |
  PROC4 %in% codes_fMRI |
  PROC5 %in% codes_fMRI |
  PROC6 %in% codes_fMRI |
  PROC7 %in% codes_fMRI |
  PROC8 %in% codes_fMRI |
  PROC9 %in% codes_fMRI |
  PROC10 %in% codes_fMRI |
  PROC11 %in% codes_fMRI |
  PROC12 %in% codes_fMRI |
  PROC13 %in% codes_fMRI |  
  PROC14 %in% codes_fMRI |
  PROC15 %in% codes_fMRI
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

fMRI2009_o <- ms_o_2009 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_fMRI
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2010#################################
fMRI2010_i <- ms_i_2010 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_fMRI |
  PROC1 %in% codes_fMRI |
  PROC2 %in% codes_fMRI |
  PROC3 %in% codes_fMRI |
  PROC4 %in% codes_fMRI |
  PROC5 %in% codes_fMRI |
  PROC6 %in% codes_fMRI |
  PROC7 %in% codes_fMRI |
  PROC8 %in% codes_fMRI |
  PROC9 %in% codes_fMRI |
  PROC10 %in% codes_fMRI |
  PROC11 %in% codes_fMRI |
  PROC12 %in% codes_fMRI |
  PROC13 %in% codes_fMRI |  
  PROC14 %in% codes_fMRI |
  PROC15 %in% codes_fMRI
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

fMRI2010_o <- ms_o_2010 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_fMRI
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2011#################################
fMRI2011_i <- ms_i_2011 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_fMRI |
  PROC1 %in% codes_fMRI |
  PROC2 %in% codes_fMRI |
  PROC3 %in% codes_fMRI |
  PROC4 %in% codes_fMRI |
  PROC5 %in% codes_fMRI |
  PROC6 %in% codes_fMRI |
  PROC7 %in% codes_fMRI |
  PROC8 %in% codes_fMRI |
  PROC9 %in% codes_fMRI |
  PROC10 %in% codes_fMRI |
  PROC11 %in% codes_fMRI |
  PROC12 %in% codes_fMRI |
  PROC13 %in% codes_fMRI |  
  PROC14 %in% codes_fMRI |
  PROC15 %in% codes_fMRI
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

fMRI2011_o <- ms_o_2011 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_fMRI
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2012#################################
fMRI2012_i <- ms_i_2012 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_fMRI |
  PROC1 %in% codes_fMRI |
  PROC2 %in% codes_fMRI |
  PROC3 %in% codes_fMRI |
  PROC4 %in% codes_fMRI |
  PROC5 %in% codes_fMRI |
  PROC6 %in% codes_fMRI |
  PROC7 %in% codes_fMRI |
  PROC8 %in% codes_fMRI |
  PROC9 %in% codes_fMRI |
  PROC10 %in% codes_fMRI |
  PROC11 %in% codes_fMRI |
  PROC12 %in% codes_fMRI |
  PROC13 %in% codes_fMRI |  
  PROC14 %in% codes_fMRI |
  PROC15 %in% codes_fMRI
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

fMRI2012_o <- ms_o_2012 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_fMRI
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2013#################################
fMRI2013_i <- ms_i_2013 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_fMRI |
  PROC1 %in% codes_fMRI |
  PROC2 %in% codes_fMRI |
  PROC3 %in% codes_fMRI |
  PROC4 %in% codes_fMRI |
  PROC5 %in% codes_fMRI |
  PROC6 %in% codes_fMRI |
  PROC7 %in% codes_fMRI |
  PROC8 %in% codes_fMRI |
  PROC9 %in% codes_fMRI |
  PROC10 %in% codes_fMRI |
  PROC11 %in% codes_fMRI |
  PROC12 %in% codes_fMRI |
  PROC13 %in% codes_fMRI |  
  PROC14 %in% codes_fMRI |
  PROC15 %in% codes_fMRI
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

fMRI2013_o <- ms_o_2013 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_fMRI
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2014#################################
fMRI2014_i <- ms_i_2014 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_fMRI |
  PROC1 %in% codes_fMRI |
  PROC2 %in% codes_fMRI |
  PROC3 %in% codes_fMRI |
  PROC4 %in% codes_fMRI |
  PROC5 %in% codes_fMRI |
  PROC6 %in% codes_fMRI |
  PROC7 %in% codes_fMRI |
  PROC8 %in% codes_fMRI |
  PROC9 %in% codes_fMRI |
  PROC10 %in% codes_fMRI |
  PROC11 %in% codes_fMRI |
  PROC12 %in% codes_fMRI |
  PROC13 %in% codes_fMRI |  
  PROC14 %in% codes_fMRI |
  PROC15 %in% codes_fMRI
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

fMRI2014_o <- ms_o_2014 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_fMRI
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2015#################################
fMRI2015_i <- ms_i_2015 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_fMRI |
  PROC1 %in% codes_fMRI |
  PROC2 %in% codes_fMRI |
  PROC3 %in% codes_fMRI |
  PROC4 %in% codes_fMRI |
  PROC5 %in% codes_fMRI |
  PROC6 %in% codes_fMRI |
  PROC7 %in% codes_fMRI |
  PROC8 %in% codes_fMRI |
  PROC9 %in% codes_fMRI |
  PROC10 %in% codes_fMRI |
  PROC11 %in% codes_fMRI |
  PROC12 %in% codes_fMRI |
  PROC13 %in% codes_fMRI |  
  PROC14 %in% codes_fMRI |
  PROC15 %in% codes_fMRI
  ) %>%  
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

fMRI2015_o <- ms_o_2015 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_fMRI
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2016#################################
fMRI2016_i <- ms_i_2016 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_fMRI |
  PROC1 %in% codes_fMRI |
  PROC2 %in% codes_fMRI |
  PROC3 %in% codes_fMRI |
  PROC4 %in% codes_fMRI |
  PROC5 %in% codes_fMRI |
  PROC6 %in% codes_fMRI |
  PROC7 %in% codes_fMRI |
  PROC8 %in% codes_fMRI |
  PROC9 %in% codes_fMRI |
  PROC10 %in% codes_fMRI |
  PROC11 %in% codes_fMRI |
  PROC12 %in% codes_fMRI |
  PROC13 %in% codes_fMRI |  
  PROC14 %in% codes_fMRI |
  PROC15 %in% codes_fMRI
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

fMRI2016_o <- ms_o_2016 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_fMRI
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2017#################################
fMRI2017_i <- ms_i_2017 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_fMRI |
  PROC1 %in% codes_fMRI |
  PROC2 %in% codes_fMRI |
  PROC3 %in% codes_fMRI |
  PROC4 %in% codes_fMRI |
  PROC5 %in% codes_fMRI |
  PROC6 %in% codes_fMRI |
  PROC7 %in% codes_fMRI |
  PROC8 %in% codes_fMRI |
  PROC9 %in% codes_fMRI |
  PROC10 %in% codes_fMRI |
  PROC11 %in% codes_fMRI |
  PROC12 %in% codes_fMRI |
  PROC13 %in% codes_fMRI |  
  PROC14 %in% codes_fMRI |
  PROC15 %in% codes_fMRI
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

fMRI2017_o <- ms_o_2017 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_fMRI
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2018#################################
fMRI2018_i <- ms_i_2018 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_fMRI |
  PROC1 %in% codes_fMRI |
  PROC2 %in% codes_fMRI |
  PROC3 %in% codes_fMRI |
  PROC4 %in% codes_fMRI |
  PROC5 %in% codes_fMRI |
  PROC6 %in% codes_fMRI |
  PROC7 %in% codes_fMRI |
  PROC8 %in% codes_fMRI |
  PROC9 %in% codes_fMRI |
  PROC10 %in% codes_fMRI |
  PROC11 %in% codes_fMRI |
  PROC12 %in% codes_fMRI |
  PROC13 %in% codes_fMRI |  
  PROC14 %in% codes_fMRI |
  PROC15 %in% codes_fMRI
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

fMRI2018_o <- ms_o_2018 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_fMRI
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2019#################################
fMRI2019_i <- ms_i_2019 %>% 
  select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE) %>% filter(
  PPROC %in% codes_fMRI |
  PROC1 %in% codes_fMRI |
  PROC2 %in% codes_fMRI |
  PROC3 %in% codes_fMRI |
  PROC4 %in% codes_fMRI |
  PROC5 %in% codes_fMRI |
  PROC6 %in% codes_fMRI |
  PROC7 %in% codes_fMRI |
  PROC8 %in% codes_fMRI |
  PROC9 %in% codes_fMRI |
  PROC10 %in% codes_fMRI |
  PROC11 %in% codes_fMRI |
  PROC12 %in% codes_fMRI |
  PROC13 %in% codes_fMRI |  
  PROC14 %in% codes_fMRI |
  PROC15 %in% codes_fMRI
  ) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
         ENROLID %in% !!hemispherectomy$ENROLID | 
         ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

fMRI2019_o <- ms_o_2019 %>% select(ENROLID, PROC1, SVCDATE) %>% filter(
                                     PROC1 %in% codes_fMRI
                                     ) %>% 
                                     filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID | 
                                            ENROLID %in% !!hemispherectomy$ENROLID | 
                                            ENROLID %in% !!corpus_callosotomy$ENROLID) %>%
                                     mutate(across(ENROLID, as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


# fMRI
fMRI <- bind_rows(fMRI2006_i, fMRI2006_o, fMRI2007_i, fMRI2007_o, fMRI2008_i, fMRI2008_o, fMRI2009_i, fMRI2009_o, fMRI2010_i, fMRI2010_o, fMRI2011_i, fMRI2011_o, fMRI2012_i, fMRI2012_o, fMRI2013_i, fMRI2013_o, fMRI2014_i, fMRI2014_o, fMRI2015_i, fMRI2015_o, fMRI2016_i, fMRI2016_o, fMRI2017_i, fMRI2017_o, fMRI2018_i, fMRI2018_o, fMRI2019_i, fMRI2019_o) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  arrange(SVCDATE, .by_group=TRUE) %>% 
  mutate(difference_between_procedures=SVCDATE - lag(SVCDATE, 1))

# Individual fMRI
procedure_fMRI_n <- fMRI %>% distinct(ENROLID, SVCDATE) %>% nrow()
procedure_fMRI_n 

# Individual patients with fMRI
patients_fMRI_n <- fMRI %>% distinct(ENROLID) %>% nrow()
patients_fMRI_n 

# Tally of patients with more than one fMRI
tally_fMRI <- fMRI %>% group_by(ENROLID) %>% tally(name="number_procedures")  %>% group_by(number_procedures) %>% tally(name="number_patients")
tally_fMRI

# Period between individual fMRIs in patients with repeated procedures
period_between_fMRIs <- summary(as.numeric(fMRI$difference_between_procedures))
period_between_fMRIs
```








## 4. Demographics




Demographic characteristics patients with epilepsy
```{r}
# Date of first diagnosis of epilepsy
epilepsy_year_of_first_diagnosis <- epilepsy %>% mutate(year_first_diagnosis=year(SVCDATE)) %>% arrange(ENROLID, year_first_diagnosis) %>% distinct(ENROLID, .keep_all=TRUE)


#################################2006#################################
demographics_epilepsy2006 <- ms_a_2006 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_epilepsy2006$ENROLID <- as.double(demographics_epilepsy2006$ENROLID)
demographics_epilepsy2006$SEX <- as.integer(demographics_epilepsy2006$SEX)


#################################2007#################################
demographics_epilepsy2007 <- ms_a_2007 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_epilepsy2007$ENROLID <- as.double(demographics_epilepsy2007$ENROLID)
demographics_epilepsy2007$SEX <- as.integer(demographics_epilepsy2007$SEX)


#################################2008#################################
demographics_epilepsy2008 <- ms_a_2008 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_epilepsy2008$ENROLID <- as.double(demographics_epilepsy2008$ENROLID)
demographics_epilepsy2008$SEX <- as.integer(demographics_epilepsy2008$SEX)


#################################2009#################################
demographics_epilepsy2009 <- ms_a_2009 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_epilepsy2009$ENROLID <- as.double(demographics_epilepsy2009$ENROLID)
demographics_epilepsy2009$SEX <- as.integer(demographics_epilepsy2009$SEX)


#################################2010#################################
demographics_epilepsy2010 <- ms_a_2010 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_epilepsy2010$ENROLID <- as.double(demographics_epilepsy2010$ENROLID)
demographics_epilepsy2010$SEX <- as.integer(demographics_epilepsy2010$SEX)


#################################2011#################################
demographics_epilepsy2011 <- ms_a_2011 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_epilepsy2011$ENROLID <- as.double(demographics_epilepsy2011$ENROLID)
demographics_epilepsy2011$SEX <- as.integer(demographics_epilepsy2011$SEX)


#################################2012#################################
demographics_epilepsy2012 <- ms_a_2012 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_epilepsy2012$ENROLID <- as.double(demographics_epilepsy2012$ENROLID)
demographics_epilepsy2012$SEX <- as.integer(demographics_epilepsy2012$SEX)


#################################2013#################################
demographics_epilepsy2013 <- ms_a_2013 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_epilepsy2013$ENROLID <- as.double(demographics_epilepsy2013$ENROLID)
demographics_epilepsy2013$SEX <- as.integer(demographics_epilepsy2013$SEX)


#################################2014#################################
demographics_epilepsy2014 <- ms_a_2014 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_epilepsy2014$ENROLID <- as.double(demographics_epilepsy2014$ENROLID)
demographics_epilepsy2014$SEX <- as.integer(demographics_epilepsy2014$SEX)


#################################2015#################################
demographics_epilepsy2015 <- ms_a_2015 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_epilepsy2015$ENROLID <- as.double(demographics_epilepsy2015$ENROLID)
demographics_epilepsy2015$SEX <- as.integer(demographics_epilepsy2015$SEX)


#################################2016#################################
demographics_epilepsy2016 <- ms_a_2016 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_epilepsy2016$ENROLID <- as.double(demographics_epilepsy2016$ENROLID)
demographics_epilepsy2016$SEX <- as.integer(demographics_epilepsy2016$SEX)


#################################2017#################################
demographics_epilepsy2017 <- ms_a_2017 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_epilepsy2017$ENROLID <- as.double(demographics_epilepsy2017$ENROLID)
demographics_epilepsy2017$SEX <- as.integer(demographics_epilepsy2017$SEX)


#################################2018#################################
demographics_epilepsy2018 <- ms_a_2018 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_epilepsy2018$ENROLID <- as.double(demographics_epilepsy2018$ENROLID)
demographics_epilepsy2018$SEX <- as.integer(demographics_epilepsy2018$SEX)


#################################2019#################################
demographics_epilepsy2019 <- ms_a_2019 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_epilepsy2019$ENROLID <- as.double(demographics_epilepsy2019$ENROLID)
demographics_epilepsy2019$SEX <- as.integer(demographics_epilepsy2019$SEX)


# Demographics epilepsy
demographics_epilepsy <- bind_rows(demographics_epilepsy2006, demographics_epilepsy2007, demographics_epilepsy2008, demographics_epilepsy2009, demographics_epilepsy2010, demographics_epilepsy2011, demographics_epilepsy2012, demographics_epilepsy2013, demographics_epilepsy2014, demographics_epilepsy2015, demographics_epilepsy2016, demographics_epilepsy2017, demographics_epilepsy2018, demographics_epilepsy2019) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  distinct(ENROLID, .keep_all=TRUE) %>% 
  left_join(epilepsy_year_of_first_diagnosis, by="ENROLID") %>% 
  mutate(age_first_diagnosis = year_first_diagnosis - DOBYR) %>% 
  collect()

summary(demographics_epilepsy$age_first_diagnosis)
sd(demographics_epilepsy$age_first_diagnosis)
CrossTable(demographics_epilepsy$SEX)
```




Demographic characteristics patients with refractory epilepsy
```{r}
# Date of first diagnosis of refractory epilepsy
refractory_epilepsy_year_of_first_diagnosis <- refractory_epilepsy %>% mutate(year_first_diagnosis=year(SVCDATE)) %>% arrange(ENROLID, year_first_diagnosis) %>% distinct(ENROLID, .keep_all=TRUE)


#################################2006#################################
demographics_refractory_epilepsy2006 <- ms_a_2006 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_epilepsy2006$ENROLID <- as.double(demographics_refractory_epilepsy2006$ENROLID)
demographics_refractory_epilepsy2006$SEX <- as.integer(demographics_refractory_epilepsy2006$SEX)


#################################2007#################################
demographics_refractory_epilepsy2007 <- ms_a_2007 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_epilepsy2007$ENROLID <- as.double(demographics_refractory_epilepsy2007$ENROLID)
demographics_refractory_epilepsy2007$SEX <- as.integer(demographics_refractory_epilepsy2007$SEX)


#################################2008#################################
demographics_refractory_epilepsy2008 <- ms_a_2008 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_epilepsy2008$ENROLID <- as.double(demographics_refractory_epilepsy2008$ENROLID)
demographics_refractory_epilepsy2008$SEX <- as.integer(demographics_refractory_epilepsy2008$SEX)


#################################2009#################################
demographics_refractory_epilepsy2009 <- ms_a_2009 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_epilepsy2009$ENROLID <- as.double(demographics_refractory_epilepsy2009$ENROLID)
demographics_refractory_epilepsy2009$SEX <- as.integer(demographics_refractory_epilepsy2009$SEX)


#################################2010#################################
demographics_refractory_epilepsy2010 <- ms_a_2010 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_epilepsy2010$ENROLID <- as.double(demographics_refractory_epilepsy2010$ENROLID)
demographics_refractory_epilepsy2010$SEX <- as.integer(demographics_refractory_epilepsy2010$SEX)


#################################2011#################################
demographics_refractory_epilepsy2011 <- ms_a_2011 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_epilepsy2011$ENROLID <- as.double(demographics_refractory_epilepsy2011$ENROLID)
demographics_refractory_epilepsy2011$SEX <- as.integer(demographics_refractory_epilepsy2011$SEX)


#################################2012#################################
demographics_refractory_epilepsy2012 <- ms_a_2012 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_epilepsy2012$ENROLID <- as.double(demographics_refractory_epilepsy2012$ENROLID)
demographics_refractory_epilepsy2012$SEX <- as.integer(demographics_refractory_epilepsy2012$SEX)


#################################2013#################################
demographics_refractory_epilepsy2013 <- ms_a_2013 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_epilepsy2013$ENROLID <- as.double(demographics_refractory_epilepsy2013$ENROLID)
demographics_refractory_epilepsy2013$SEX <- as.integer(demographics_refractory_epilepsy2013$SEX)


#################################2014#################################
demographics_refractory_epilepsy2014 <- ms_a_2014 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_epilepsy2014$ENROLID <- as.double(demographics_refractory_epilepsy2014$ENROLID)
demographics_refractory_epilepsy2014$SEX <- as.integer(demographics_refractory_epilepsy2014$SEX)


#################################2015#################################
demographics_refractory_epilepsy2015 <- ms_a_2015 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_epilepsy2015$ENROLID <- as.double(demographics_refractory_epilepsy2015$ENROLID)
demographics_refractory_epilepsy2015$SEX <- as.integer(demographics_refractory_epilepsy2015$SEX)


#################################2016#################################
demographics_refractory_epilepsy2016 <- ms_a_2016 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_epilepsy2016$ENROLID <- as.double(demographics_refractory_epilepsy2016$ENROLID)
demographics_refractory_epilepsy2016$SEX <- as.integer(demographics_refractory_epilepsy2016$SEX)


#################################2017#################################
demographics_refractory_epilepsy2017 <- ms_a_2017 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_epilepsy2017$ENROLID <- as.double(demographics_refractory_epilepsy2017$ENROLID)
demographics_refractory_epilepsy2017$SEX <- as.integer(demographics_refractory_epilepsy2017$SEX)


#################################2018#################################
demographics_refractory_epilepsy2018 <- ms_a_2018 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_epilepsy2018$ENROLID <- as.double(demographics_refractory_epilepsy2018$ENROLID)
demographics_refractory_epilepsy2018$SEX <- as.integer(demographics_refractory_epilepsy2018$SEX)


#################################2019#################################
demographics_refractory_epilepsy2019 <- ms_a_2019 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_epilepsy2019$ENROLID <- as.double(demographics_refractory_epilepsy2019$ENROLID)
demographics_refractory_epilepsy2019$SEX <- as.integer(demographics_refractory_epilepsy2019$SEX)


# Demographics refractory epilepsy
demographics_refractory_epilepsy <- bind_rows(demographics_refractory_epilepsy2006, demographics_refractory_epilepsy2007, demographics_refractory_epilepsy2008, demographics_refractory_epilepsy2009, demographics_refractory_epilepsy2010, demographics_refractory_epilepsy2011, demographics_refractory_epilepsy2012, demographics_refractory_epilepsy2013, demographics_refractory_epilepsy2014, demographics_refractory_epilepsy2015, demographics_refractory_epilepsy2016, demographics_refractory_epilepsy2017, demographics_refractory_epilepsy2018, demographics_refractory_epilepsy2019) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  distinct(ENROLID, .keep_all=TRUE) %>% 
  left_join(refractory_epilepsy_year_of_first_diagnosis, by="ENROLID") %>% 
  mutate(age_first_diagnosis = year_first_diagnosis - DOBYR) %>% 
  collect()

summary(demographics_refractory_epilepsy$age_first_diagnosis)
sd(demographics_refractory_epilepsy$age_first_diagnosis)
CrossTable(demographics_refractory_epilepsy$SEX)
```




Demographic characteristics patients with focal epilepsy
```{r}
# Date of first diagnosis of focal epilepsy
focal_epilepsy_year_of_first_diagnosis <- focal_epilepsy %>% mutate(year_first_diagnosis=year(SVCDATE)) %>% arrange(ENROLID, year_first_diagnosis) %>% distinct(ENROLID, .keep_all=TRUE)


#################################2006#################################
demographics_focal_epilepsy2006 <- ms_a_2006 %>% filter(ENROLID %in% !!focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_focal_epilepsy2006$ENROLID <- as.double(demographics_focal_epilepsy2006$ENROLID)
demographics_focal_epilepsy2006$SEX <- as.integer(demographics_focal_epilepsy2006$SEX)


#################################2007#################################
demographics_focal_epilepsy2007 <- ms_a_2007 %>% filter(ENROLID %in% !!focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_focal_epilepsy2007$ENROLID <- as.double(demographics_focal_epilepsy2007$ENROLID)
demographics_focal_epilepsy2007$SEX <- as.integer(demographics_focal_epilepsy2007$SEX)


#################################2008#################################
demographics_focal_epilepsy2008 <- ms_a_2008 %>% filter(ENROLID %in% !!focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_focal_epilepsy2008$ENROLID <- as.double(demographics_focal_epilepsy2008$ENROLID)
demographics_focal_epilepsy2008$SEX <- as.integer(demographics_focal_epilepsy2008$SEX)


#################################2009#################################
demographics_focal_epilepsy2009 <- ms_a_2009 %>% filter(ENROLID %in% !!focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_focal_epilepsy2009$ENROLID <- as.double(demographics_focal_epilepsy2009$ENROLID)
demographics_focal_epilepsy2009$SEX <- as.integer(demographics_focal_epilepsy2009$SEX)


#################################2010#################################
demographics_focal_epilepsy2010 <- ms_a_2010 %>% filter(ENROLID %in% !!focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_focal_epilepsy2010$ENROLID <- as.double(demographics_focal_epilepsy2010$ENROLID)
demographics_focal_epilepsy2010$SEX <- as.integer(demographics_focal_epilepsy2010$SEX)


#################################2011#################################
demographics_focal_epilepsy2011 <- ms_a_2011 %>% filter(ENROLID %in% !!focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_focal_epilepsy2011$ENROLID <- as.double(demographics_focal_epilepsy2011$ENROLID)
demographics_focal_epilepsy2011$SEX <- as.integer(demographics_focal_epilepsy2011$SEX)


#################################2012#################################
demographics_focal_epilepsy2012 <- ms_a_2012 %>% filter(ENROLID %in% !!focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_focal_epilepsy2012$ENROLID <- as.double(demographics_focal_epilepsy2012$ENROLID)
demographics_focal_epilepsy2012$SEX <- as.integer(demographics_focal_epilepsy2012$SEX)


#################################2013#################################
demographics_focal_epilepsy2013 <- ms_a_2013 %>% filter(ENROLID %in% !!focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_focal_epilepsy2013$ENROLID <- as.double(demographics_focal_epilepsy2013$ENROLID)
demographics_focal_epilepsy2013$SEX <- as.integer(demographics_focal_epilepsy2013$SEX)


#################################2014#################################
demographics_focal_epilepsy2014 <- ms_a_2014 %>% filter(ENROLID %in% !!focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_focal_epilepsy2014$ENROLID <- as.double(demographics_focal_epilepsy2014$ENROLID)
demographics_focal_epilepsy2014$SEX <- as.integer(demographics_focal_epilepsy2014$SEX)


#################################2015#################################
demographics_focal_epilepsy2015 <- ms_a_2015 %>% filter(ENROLID %in% !!focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_focal_epilepsy2015$ENROLID <- as.double(demographics_focal_epilepsy2015$ENROLID)
demographics_focal_epilepsy2015$SEX <- as.integer(demographics_focal_epilepsy2015$SEX)


#################################2016#################################
demographics_focal_epilepsy2016 <- ms_a_2016 %>% filter(ENROLID %in% !!focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_focal_epilepsy2016$ENROLID <- as.double(demographics_focal_epilepsy2016$ENROLID)
demographics_focal_epilepsy2016$SEX <- as.integer(demographics_focal_epilepsy2016$SEX)


#################################2017#################################
demographics_focal_epilepsy2017 <- ms_a_2017 %>% filter(ENROLID %in% !!focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_focal_epilepsy2017$ENROLID <- as.double(demographics_focal_epilepsy2017$ENROLID)
demographics_focal_epilepsy2017$SEX <- as.integer(demographics_focal_epilepsy2017$SEX)


#################################2018#################################
demographics_focal_epilepsy2018 <- ms_a_2018 %>% filter(ENROLID %in% !!focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_focal_epilepsy2018$ENROLID <- as.double(demographics_focal_epilepsy2018$ENROLID)
demographics_focal_epilepsy2018$SEX <- as.integer(demographics_focal_epilepsy2018$SEX)


#################################2019#################################
demographics_focal_epilepsy2019 <- ms_a_2019 %>% filter(ENROLID %in% !!focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_focal_epilepsy2019$ENROLID <- as.double(demographics_focal_epilepsy2019$ENROLID)
demographics_focal_epilepsy2019$SEX <- as.integer(demographics_focal_epilepsy2019$SEX)


# Demographics focal epilepsy
demographics_focal_epilepsy <- bind_rows(demographics_focal_epilepsy2006, demographics_focal_epilepsy2007, demographics_focal_epilepsy2008, demographics_focal_epilepsy2009, demographics_focal_epilepsy2010, demographics_focal_epilepsy2011, demographics_focal_epilepsy2012, demographics_focal_epilepsy2013, demographics_focal_epilepsy2014, demographics_focal_epilepsy2015, demographics_focal_epilepsy2016, demographics_focal_epilepsy2017, demographics_focal_epilepsy2018, demographics_focal_epilepsy2019) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  distinct(ENROLID, .keep_all=TRUE) %>% 
  left_join(focal_epilepsy_year_of_first_diagnosis, by="ENROLID") %>% 
  mutate(age_first_diagnosis = year_first_diagnosis - DOBYR) %>% 
  collect()

summary(demographics_focal_epilepsy$age_first_diagnosis)
sd(demographics_focal_epilepsy$age_first_diagnosis)
CrossTable(demographics_focal_epilepsy$SEX)
```




Demographic characteristics patients with refractory focal epilepsy
```{r}
# Date of first diagnosis of refractory focal epilepsy
refractory_focal_epilepsy_year_of_first_diagnosis <- refractory_focal_epilepsy %>% mutate(year_first_diagnosis=year(SVCDATE)) %>% arrange(ENROLID, year_first_diagnosis) %>% distinct(ENROLID, .keep_all=TRUE)


#################################2006#################################
demographics_refractory_focal_epilepsy2006 <- ms_a_2006 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_focal_epilepsy2006$ENROLID <- as.double(demographics_refractory_focal_epilepsy2006$ENROLID)
demographics_refractory_focal_epilepsy2006$SEX <- as.integer(demographics_refractory_focal_epilepsy2006$SEX)


#################################2007#################################
demographics_refractory_focal_epilepsy2007 <- ms_a_2007 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_focal_epilepsy2007$ENROLID <- as.double(demographics_refractory_focal_epilepsy2007$ENROLID)
demographics_refractory_focal_epilepsy2007$SEX <- as.integer(demographics_refractory_focal_epilepsy2007$SEX)


#################################2008#################################
demographics_refractory_focal_epilepsy2008 <- ms_a_2008 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_focal_epilepsy2008$ENROLID <- as.double(demographics_refractory_focal_epilepsy2008$ENROLID)
demographics_refractory_focal_epilepsy2008$SEX <- as.integer(demographics_refractory_focal_epilepsy2008$SEX)


#################################2009#################################
demographics_refractory_focal_epilepsy2009 <- ms_a_2009 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_focal_epilepsy2009$ENROLID <- as.double(demographics_refractory_focal_epilepsy2009$ENROLID)
demographics_refractory_focal_epilepsy2009$SEX <- as.integer(demographics_refractory_focal_epilepsy2009$SEX)


#################################2010#################################
demographics_refractory_focal_epilepsy2010 <- ms_a_2010 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_focal_epilepsy2010$ENROLID <- as.double(demographics_refractory_focal_epilepsy2010$ENROLID)
demographics_refractory_focal_epilepsy2010$SEX <- as.integer(demographics_refractory_focal_epilepsy2010$SEX)


#################################2011#################################
demographics_refractory_focal_epilepsy2011 <- ms_a_2011 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_focal_epilepsy2011$ENROLID <- as.double(demographics_refractory_focal_epilepsy2011$ENROLID)
demographics_refractory_focal_epilepsy2011$SEX <- as.integer(demographics_refractory_focal_epilepsy2011$SEX)


#################################2012#################################
demographics_refractory_focal_epilepsy2012 <- ms_a_2012 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_focal_epilepsy2012$ENROLID <- as.double(demographics_refractory_focal_epilepsy2012$ENROLID)
demographics_refractory_focal_epilepsy2012$SEX <- as.integer(demographics_refractory_focal_epilepsy2012$SEX)


#################################2013#################################
demographics_refractory_focal_epilepsy2013 <- ms_a_2013 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_focal_epilepsy2013$ENROLID <- as.double(demographics_refractory_focal_epilepsy2013$ENROLID)
demographics_refractory_focal_epilepsy2013$SEX <- as.integer(demographics_refractory_focal_epilepsy2013$SEX)


#################################2014#################################
demographics_refractory_focal_epilepsy2014 <- ms_a_2014 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_focal_epilepsy2014$ENROLID <- as.double(demographics_refractory_focal_epilepsy2014$ENROLID)
demographics_refractory_focal_epilepsy2014$SEX <- as.integer(demographics_refractory_focal_epilepsy2014$SEX)


#################################2015#################################
demographics_refractory_focal_epilepsy2015 <- ms_a_2015 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_focal_epilepsy2015$ENROLID <- as.double(demographics_refractory_focal_epilepsy2015$ENROLID)
demographics_refractory_focal_epilepsy2015$SEX <- as.integer(demographics_refractory_focal_epilepsy2015$SEX)


#################################2016#################################
demographics_refractory_focal_epilepsy2016 <- ms_a_2016 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_focal_epilepsy2016$ENROLID <- as.double(demographics_refractory_focal_epilepsy2016$ENROLID)
demographics_refractory_focal_epilepsy2016$SEX <- as.integer(demographics_refractory_focal_epilepsy2016$SEX)


#################################2017#################################
demographics_refractory_focal_epilepsy2017 <- ms_a_2017 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_focal_epilepsy2017$ENROLID <- as.double(demographics_refractory_focal_epilepsy2017$ENROLID)
demographics_refractory_focal_epilepsy2017$SEX <- as.integer(demographics_refractory_focal_epilepsy2017$SEX)


#################################2018#################################
demographics_refractory_focal_epilepsy2018 <- ms_a_2018 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_focal_epilepsy2018$ENROLID <- as.double(demographics_refractory_focal_epilepsy2018$ENROLID)
demographics_refractory_focal_epilepsy2018$SEX <- as.integer(demographics_refractory_focal_epilepsy2018$SEX)


#################################2019#################################
demographics_refractory_focal_epilepsy2019 <- ms_a_2019 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_refractory_focal_epilepsy2019$ENROLID <- as.double(demographics_refractory_focal_epilepsy2019$ENROLID)
demographics_refractory_focal_epilepsy2019$SEX <- as.integer(demographics_refractory_focal_epilepsy2019$SEX)


# Demographics refractory_focal epilepsy
demographics_refractory_focal_epilepsy <- bind_rows(demographics_refractory_focal_epilepsy2006, demographics_refractory_focal_epilepsy2007, demographics_refractory_focal_epilepsy2008, demographics_refractory_focal_epilepsy2009, demographics_refractory_focal_epilepsy2010, demographics_refractory_focal_epilepsy2011, demographics_refractory_focal_epilepsy2012, demographics_refractory_focal_epilepsy2013, demographics_refractory_focal_epilepsy2014, demographics_refractory_focal_epilepsy2015, demographics_refractory_focal_epilepsy2016, demographics_refractory_focal_epilepsy2017, demographics_refractory_focal_epilepsy2018, demographics_refractory_focal_epilepsy2019) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  distinct(ENROLID, .keep_all=TRUE) %>% 
  left_join(refractory_focal_epilepsy_year_of_first_diagnosis, by="ENROLID") %>% 
  mutate(age_first_diagnosis = year_first_diagnosis - DOBYR) %>% 
  collect()

summary(demographics_refractory_focal_epilepsy$age_first_diagnosis)
sd(demographics_refractory_focal_epilepsy$age_first_diagnosis)
CrossTable(demographics_refractory_focal_epilepsy$SEX)
```




Person-years epilepsy, refractory epilepsy, focal epilepsy, and refractory focal epilepsy
```{r}
# A year contains 365.24219 days (https://www.britannica.com/science/time/Lengths-of-years-and-months)

# Epilepsy
person_years_epilepsy <- follow_up %>%
  filter(ENROLID %in% !!epilepsy$ENROLID) %>% 
  group_by(ENROLID) %>% 
  left_join(epilepsy_first_diagnosis, by="ENROLID") %>% 
  mutate(MEMDAYS = ifelse(first_diagnosis_epilepsy<=DTEND, MEMDAYS, NA)) %>% 
  mutate(days_follow_up = sum(MEMDAYS, na.rm=TRUE),
         person_years = days_follow_up/365.24219) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect()

total_person_years_epilepsy <- sum(person_years_epilepsy$person_years, na.rm=TRUE)
total_person_years_epilepsy


# Refractory epilepsy
person_years_refractory_epilepsy <- follow_up %>%
  filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% 
  group_by(ENROLID) %>% 
  left_join(epilepsy_first_diagnosis, by="ENROLID") %>% 
  mutate(MEMDAYS = ifelse(first_diagnosis_epilepsy<=DTEND, MEMDAYS, NA)) %>% 
  mutate(days_follow_up = sum(MEMDAYS, na.rm=TRUE),
         person_years = days_follow_up/365.24219) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect()

total_person_years_refractory_epilepsy <- sum(person_years_refractory_epilepsy$person_years, na.rm=TRUE)
total_person_years_refractory_epilepsy


# Focal epilepsy
person_years_focal_epilepsy <- follow_up %>%
  filter(ENROLID %in% !!focal_epilepsy$ENROLID) %>% 
  group_by(ENROLID) %>% 
  left_join(epilepsy_first_diagnosis, by="ENROLID") %>% 
  mutate(MEMDAYS = ifelse(first_diagnosis_epilepsy<=DTEND, MEMDAYS, NA)) %>% 
  mutate(days_follow_up = sum(MEMDAYS, na.rm=TRUE),
         person_years = days_follow_up/365.24219) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect()

total_person_years_focal_epilepsy <- sum(person_years_focal_epilepsy$person_years, na.rm=TRUE)
total_person_years_focal_epilepsy


# Refractory focal epilepsy
person_years_refractory_focal_epilepsy <- follow_up %>%
  filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% 
  group_by(ENROLID) %>% 
  left_join(epilepsy_first_diagnosis, by="ENROLID") %>% 
  mutate(MEMDAYS = ifelse(first_diagnosis_epilepsy<=DTEND, MEMDAYS, NA)) %>% 
  mutate(days_follow_up = sum(MEMDAYS, na.rm=TRUE),
         person_years = days_follow_up/365.24219) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect()

total_person_years_refractory_focal_epilepsy <- sum(person_years_refractory_focal_epilepsy$person_years, na.rm=TRUE)
total_person_years_refractory_focal_epilepsy
```




Demographic characteristics patients who underwent resective epilepsy surgery
```{r}
# Date of resective epilepsy surgery
resective_epilepsy_surgery_year_of_first_surgery <- resective_epilepsy_surgery %>% mutate(year_first_surgery=year(SVCDATE)) %>% arrange(ENROLID, year_first_surgery) %>% distinct(ENROLID, .keep_all=TRUE)


#################################2006#################################
demographics_resective_epilepsy_surgery2006 <- ms_a_2006 %>% filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_resective_epilepsy_surgery2006$ENROLID <- as.double(demographics_resective_epilepsy_surgery2006$ENROLID)
demographics_resective_epilepsy_surgery2006$SEX <- as.integer(demographics_resective_epilepsy_surgery2006$SEX)


#################################2007#################################
demographics_resective_epilepsy_surgery2007 <- ms_a_2007 %>% filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_resective_epilepsy_surgery2007$ENROLID <- as.double(demographics_resective_epilepsy_surgery2007$ENROLID)
demographics_resective_epilepsy_surgery2007$SEX <- as.integer(demographics_resective_epilepsy_surgery2007$SEX)


#################################2008#################################
demographics_resective_epilepsy_surgery2008 <- ms_a_2008 %>% filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_resective_epilepsy_surgery2008$ENROLID <- as.double(demographics_resective_epilepsy_surgery2008$ENROLID)
demographics_resective_epilepsy_surgery2008$SEX <- as.integer(demographics_resective_epilepsy_surgery2008$SEX)


#################################2009#################################
demographics_resective_epilepsy_surgery2009 <- ms_a_2009 %>% filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_resective_epilepsy_surgery2009$ENROLID <- as.double(demographics_resective_epilepsy_surgery2009$ENROLID)
demographics_resective_epilepsy_surgery2009$SEX <- as.integer(demographics_resective_epilepsy_surgery2009$SEX)


#################################2010#################################
demographics_resective_epilepsy_surgery2010 <- ms_a_2010 %>% filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_resective_epilepsy_surgery2010$ENROLID <- as.double(demographics_resective_epilepsy_surgery2010$ENROLID)
demographics_resective_epilepsy_surgery2010$SEX <- as.integer(demographics_resective_epilepsy_surgery2010$SEX)


#################################2011#################################
demographics_resective_epilepsy_surgery2011 <- ms_a_2011 %>% filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_resective_epilepsy_surgery2011$ENROLID <- as.double(demographics_resective_epilepsy_surgery2011$ENROLID)
demographics_resective_epilepsy_surgery2011$SEX <- as.integer(demographics_resective_epilepsy_surgery2011$SEX)


#################################2012#################################
demographics_resective_epilepsy_surgery2012 <- ms_a_2012 %>% filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_resective_epilepsy_surgery2012$ENROLID <- as.double(demographics_resective_epilepsy_surgery2012$ENROLID)
demographics_resective_epilepsy_surgery2012$SEX <- as.integer(demographics_resective_epilepsy_surgery2012$SEX)


#################################2013#################################
demographics_resective_epilepsy_surgery2013 <- ms_a_2013 %>% filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_resective_epilepsy_surgery2013$ENROLID <- as.double(demographics_resective_epilepsy_surgery2013$ENROLID)
demographics_resective_epilepsy_surgery2013$SEX <- as.integer(demographics_resective_epilepsy_surgery2013$SEX)


#################################2014#################################
demographics_resective_epilepsy_surgery2014 <- ms_a_2014 %>% filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_resective_epilepsy_surgery2014$ENROLID <- as.double(demographics_resective_epilepsy_surgery2014$ENROLID)
demographics_resective_epilepsy_surgery2014$SEX <- as.integer(demographics_resective_epilepsy_surgery2014$SEX)


#################################2015#################################
demographics_resective_epilepsy_surgery2015 <- ms_a_2015 %>% filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_resective_epilepsy_surgery2015$ENROLID <- as.double(demographics_resective_epilepsy_surgery2015$ENROLID)
demographics_resective_epilepsy_surgery2015$SEX <- as.integer(demographics_resective_epilepsy_surgery2015$SEX)


#################################2016#################################
demographics_resective_epilepsy_surgery2016 <- ms_a_2016 %>% filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_resective_epilepsy_surgery2016$ENROLID <- as.double(demographics_resective_epilepsy_surgery2016$ENROLID)
demographics_resective_epilepsy_surgery2016$SEX <- as.integer(demographics_resective_epilepsy_surgery2016$SEX)


#################################2017#################################
demographics_resective_epilepsy_surgery2017 <- ms_a_2017 %>% filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_resective_epilepsy_surgery2017$ENROLID <- as.double(demographics_resective_epilepsy_surgery2017$ENROLID)
demographics_resective_epilepsy_surgery2017$SEX <- as.integer(demographics_resective_epilepsy_surgery2017$SEX)


#################################2018#################################
demographics_resective_epilepsy_surgery2018 <- ms_a_2018 %>% filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_resective_epilepsy_surgery2018$ENROLID <- as.double(demographics_resective_epilepsy_surgery2018$ENROLID)
demographics_resective_epilepsy_surgery2018$SEX <- as.integer(demographics_resective_epilepsy_surgery2018$SEX)


#################################2019#################################
demographics_resective_epilepsy_surgery2019 <- ms_a_2019 %>% filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_resective_epilepsy_surgery2019$ENROLID <- as.double(demographics_resective_epilepsy_surgery2019$ENROLID)
demographics_resective_epilepsy_surgery2019$SEX <- as.integer(demographics_resective_epilepsy_surgery2019$SEX)


# Demographics resective epilepsy surgery
demographics_resective_epilepsy_surgery <- bind_rows(demographics_resective_epilepsy_surgery2006, demographics_resective_epilepsy_surgery2007, demographics_resective_epilepsy_surgery2008, demographics_resective_epilepsy_surgery2009, demographics_resective_epilepsy_surgery2010, demographics_resective_epilepsy_surgery2011, demographics_resective_epilepsy_surgery2012, demographics_resective_epilepsy_surgery2013, demographics_resective_epilepsy_surgery2014, demographics_resective_epilepsy_surgery2015, demographics_resective_epilepsy_surgery2016, demographics_resective_epilepsy_surgery2017, demographics_resective_epilepsy_surgery2018, demographics_resective_epilepsy_surgery2019) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  distinct(ENROLID, .keep_all=TRUE) %>% 
  left_join(resective_epilepsy_surgery_year_of_first_surgery, by="ENROLID") %>% 
  mutate(age_first_surgery = year_first_surgery - DOBYR) %>% 
  left_join(refractory_focal_epilepsy, by="ENROLID") %>% 
  arrange(ENROLID, SVCDATE.x, SVCDATE.y) %>% 
  distinct(ENROLID, SVCDATE.x, .keep_all=TRUE) %>% 
  mutate(years_from_diagnosis_to_surgery = as.numeric(SVCDATE.x - SVCDATE.y)/365.24219) %>% 
  collect()


summary(demographics_resective_epilepsy_surgery$age_first_surgery)
sd(demographics_resective_epilepsy_surgery$age_first_surgery)
CrossTable(demographics_resective_epilepsy_surgery$SEX)
summary(demographics_resective_epilepsy_surgery$years_from_diagnosis_to_surgery)
```




Person-years resective epilepsy surgery
```{r}
# Resective epilepsy surgery: total
person_years_resective_epilepsy_surgery <- follow_up %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  left_join(epilepsy_first_diagnosis, by="ENROLID") %>% 
  mutate(MEMDAYS = ifelse(first_diagnosis_epilepsy<=DTEND, MEMDAYS, NA)) %>% 
  mutate(days_follow_up = sum(MEMDAYS, na.rm=TRUE),
         person_years = days_follow_up/365.24219) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect()

total_person_years_resective_epilepsy_surgery <- sum(person_years_resective_epilepsy_surgery$person_years)
total_person_years_resective_epilepsy_surgery


# Patients with only the first resective epilepsy surgery
resective_epilepsy_surgery_one_surgery <- resective_epilepsy_surgery %>% arrange(ENROLID, SVCDATE) %>% distinct(ENROLID, .keep_all=TRUE)


# Resective epilepsy surgery (patients with only first surgery): total
person_years_resective_epilepsy_surgery_one_surgery <- follow_up %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  left_join(epilepsy_first_diagnosis, by="ENROLID") %>% 
  mutate(MEMDAYS = ifelse(first_diagnosis_epilepsy<=DTEND, MEMDAYS, NA)) %>% 
  mutate(days_follow_up = sum(MEMDAYS, na.rm=TRUE),
         person_years = days_follow_up/365.24219) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect()

total_person_years_resective_epilepsy_surgery_one_surgery <- sum(person_years_resective_epilepsy_surgery_one_surgery$person_years)
total_person_years_resective_epilepsy_surgery_one_surgery


# Resective epilepsy surgery (patients with only first surgery): before surgery
person_years_resective_epilepsy_surgery_one_surgery_before <- follow_up %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  left_join(resective_epilepsy_surgery_one_surgery, by="ENROLID") %>% 
  filter(DTEND <= SVCDATE) %>% 
  group_by(ENROLID) %>% 
  left_join(epilepsy_first_diagnosis, by="ENROLID") %>% 
  mutate(MEMDAYS = ifelse(first_diagnosis_epilepsy<=DTEND, MEMDAYS, NA)) %>% 
  mutate(days_follow_up = sum(MEMDAYS, na.rm=TRUE),
         person_years = days_follow_up/365.24219) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect()

total_person_years_resective_epilepsy_surgery_one_surgery_before <- sum(person_years_resective_epilepsy_surgery_one_surgery_before$person_years)
total_person_years_resective_epilepsy_surgery_one_surgery_before


# Resective epilepsy surgery (patients with only one surgery): after surgery
person_years_resective_epilepsy_surgery_one_surgery_after <- follow_up %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  left_join(resective_epilepsy_surgery_one_surgery, by="ENROLID") %>% 
  filter(DTEND > SVCDATE) %>% 
  group_by(ENROLID) %>% 
  left_join(epilepsy_first_diagnosis, by="ENROLID") %>% 
  mutate(MEMDAYS = ifelse(first_diagnosis_epilepsy<=DTEND, MEMDAYS, NA)) %>% 
  mutate(days_follow_up = sum(MEMDAYS, na.rm=TRUE),
         person_years = days_follow_up/365.24219) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect()

total_person_years_resective_epilepsy_surgery_one_surgery_after <- sum(person_years_resective_epilepsy_surgery_one_surgery_after$person_years)
total_person_years_resective_epilepsy_surgery_one_surgery_after




# Resective epilepsy surgery (patients with only first surgery): person years per year 
person_years_by_year_resective_epilepsy_surgery_one_surgery <- follow_up %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  left_join(resective_epilepsy_surgery_one_surgery, by="ENROLID") %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  left_join(epilepsy_first_diagnosis, by="ENROLID") %>% 
  mutate(MEMDAYS = ifelse(first_diagnosis_epilepsy<=DTEND, MEMDAYS, NA)) %>% 
  mutate(
    person_years_surgery_minus_10 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(129))) & (DTEND < (SVCDATE - months(117)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_minus_9 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(117))) & (DTEND < (SVCDATE - months(105)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     
    person_years_surgery_minus_8 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(105))) & (DTEND < (SVCDATE - months(93)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_minus_7 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(93))) & (DTEND < (SVCDATE - months(81)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_minus_6 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(81))) & (DTEND < (SVCDATE - months(69)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_minus_5 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(69))) & (DTEND < (SVCDATE - months(57)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_minus_4 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(57))) & (DTEND < (SVCDATE - months(45)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_minus_3 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(45))) & (DTEND < (SVCDATE - months(33)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_minus_2 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(33))) & (DTEND < (SVCDATE - months(21)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_minus_1 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(21))) & (DTEND < (SVCDATE - months(9)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_0 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(9))) & (DTEND < (SVCDATE + months(3)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,      person_years_surgery_1 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(3))) & (DTEND < (SVCDATE + months(15)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_2 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(15))) & (DTEND < (SVCDATE + months(27)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_3 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(27))) & (DTEND < (SVCDATE + months(39)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_4 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(39))) & (DTEND < (SVCDATE + months(51)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_5 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(51))) & (DTEND < (SVCDATE + months(63)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_6 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(63))) & (DTEND < (SVCDATE + months(75)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_7 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(75))) & (DTEND < (SVCDATE + months(87)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_8 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(87))) & (DTEND < (SVCDATE + months(99)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_9 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(99))) & (DTEND < (SVCDATE + months(111)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_10 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(111))) & (DTEND < (SVCDATE + months(123)))), MEMDAYS, NA), na.rm=TRUE)/365.24219
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, person_years_surgery_minus_10, person_years_surgery_minus_9, person_years_surgery_minus_8, person_years_surgery_minus_7, person_years_surgery_minus_6, person_years_surgery_minus_5, person_years_surgery_minus_4, person_years_surgery_minus_3, person_years_surgery_minus_2, person_years_surgery_minus_1, person_years_surgery_0, person_years_surgery_1, person_years_surgery_2, person_years_surgery_3, person_years_surgery_4, person_years_surgery_5, person_years_surgery_6, person_years_surgery_7, person_years_surgery_8, person_years_surgery_9, person_years_surgery_10) %>% 
  collect()

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_10 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_10, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_10

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_9 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_9, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_9

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_8 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_8, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_8

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_7 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_7, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_7

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_6 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_6, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_6

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_5 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_5, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_5

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_4 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_4, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_4

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_3 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_3, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_3

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_2 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_2, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_2

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_1, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_0, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_1, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_2 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_2, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_2

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_3 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_3, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_3

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_4 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_4, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_4

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_5 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_5, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_5

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_6 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_6, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_6

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_7 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_7, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_7

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_8 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_8, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_8

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_9 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_9, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_9

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_10 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_10, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_10




# Resective epilepsy surgery (patients with only first surgery): person years per year minus 1-5 versus 1-5
person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 <- follow_up %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  left_join(resective_epilepsy_surgery_one_surgery, by="ENROLID") %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  left_join(epilepsy_first_diagnosis, by="ENROLID") %>% 
  mutate(MEMDAYS = ifelse(first_diagnosis_epilepsy<=DTEND, MEMDAYS, NA)) %>% 
  mutate(
    person_years_surgery_minus_1_5 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(69))) & (DTEND < (SVCDATE - months(9)))), MEMDAYS, NA), na.rm=TRUE)/(365.24219*5),
    person_years_surgery_0_1_5 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(9))) & (DTEND < (SVCDATE + months(3)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,      
    person_years_surgery_1_5 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(3))) & (DTEND < (SVCDATE + months(63)))), MEMDAYS, NA), na.rm=TRUE)/(365.24219*5)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, person_years_surgery_minus_1_5, person_years_surgery_0_1_5, person_years_surgery_1_5) %>% 
  collect()

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1_5 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_minus_1_5, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1_5

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0_1_5 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_0_1_5, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0_1_5

total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 <- sum(person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_1_5, na.rm=TRUE)
total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5
```




Demographic characteristics pediatric patients who underwent resective epilepsy surgery
```{r}
pediatric_patients_resective_epilepsy_surgery <- demographics_resective_epilepsy_surgery %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  filter(age_first_surgery <= 18) %>% 
  select(ENROLID, SEX, age_first_surgery) %>% 
  left_join(person_years_resective_epilepsy_surgery_one_surgery, by="ENROLID") %>% 
  select(ENROLID, SEX, age_first_surgery, person_years)

 
# Basic demographics of pediatric patients
pediatric_patients_resective_epilepsy_surgery_n <- pediatric_patients_resective_epilepsy_surgery %>% nrow()
pediatric_patients_resective_epilepsy_surgery_n

CrossTable(pediatric_patients_resective_epilepsy_surgery$SEX)

summary(pediatric_patients_resective_epilepsy_surgery$age_first_surgery)
sd(pediatric_patients_resective_epilepsy_surgery$age_first_surgery)




# Pediatric person-years
pediatric_person_years_resective_epilepsy_surgery <- person_years_resective_epilepsy_surgery %>% filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID)

pediatric_total_person_years_resective_epilepsy_surgery <- sum(pediatric_person_years_resective_epilepsy_surgery$person_years)
pediatric_total_person_years_resective_epilepsy_surgery




pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery <- person_years_by_year_resective_epilepsy_surgery_one_surgery %>% filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID)
pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_10 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_10, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_10

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_9 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_9, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_9

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_8 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_8, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_8

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_7 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_7, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_7

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_6 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_6, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_6

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_5 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_5, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_5

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_4 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_4, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_4

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_3 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_3, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_3

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_2 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_2, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_2

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_1, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_0, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_1, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_2 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_2, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_2

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_3 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_3, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_3

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_4 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_4, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_4

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_5 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_5, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_5

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_6 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_6, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_6

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_7 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_7, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_7

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_8 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_8, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_8

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_9 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_9, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_9

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_10 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_10, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_10




pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 <- person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID)
pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1_5 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_minus_1_5, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1_5

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0_1_5 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_0_1_5, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0_1_5

pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 <- sum(pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_1_5, na.rm=TRUE)
pediatric_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5
```




Demographic characteristics adult patients who underwent resective epilepsy surgery
```{r}
adult_patients_resective_epilepsy_surgery <- demographics_resective_epilepsy_surgery %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  filter(age_first_surgery > 18) %>% 
  select(ENROLID, SEX, age_first_surgery) %>% 
  left_join(person_years_resective_epilepsy_surgery_one_surgery, by="ENROLID") %>% 
  select(ENROLID, SEX, age_first_surgery, person_years)

 
# Basic demographics of adult patients
adult_patients_resective_epilepsy_surgery_n <- adult_patients_resective_epilepsy_surgery %>% nrow()
adult_patients_resective_epilepsy_surgery_n

CrossTable(adult_patients_resective_epilepsy_surgery$SEX)

summary(adult_patients_resective_epilepsy_surgery$age_first_surgery)
sd(adult_patients_resective_epilepsy_surgery$age_first_surgery)




# Adult person-years
adult_person_years_resective_epilepsy_surgery <- person_years_resective_epilepsy_surgery %>% filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID)

adult_total_person_years_resective_epilepsy_surgery <- sum(adult_person_years_resective_epilepsy_surgery$person_years)
adult_total_person_years_resective_epilepsy_surgery




adult_person_years_by_year_resective_epilepsy_surgery_one_surgery <- person_years_by_year_resective_epilepsy_surgery_one_surgery %>% filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID)
adult_person_years_by_year_resective_epilepsy_surgery_one_surgery

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_10 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_10, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_10

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_9 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_9, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_9

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_8 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_8, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_8

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_7 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_7, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_7

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_6 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_6, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_6

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_5 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_5, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_5

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_4 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_4, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_4

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_3 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_3, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_3

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_2 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_2, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_2

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_1, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_0, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_1, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_2 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_2, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_2

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_3 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_3, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_3

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_4 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_4, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_4

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_5 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_5, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_5

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_6 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_6, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_6

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_7 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_7, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_7

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_8 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_8, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_8

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_9 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_9, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_9

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_10 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_10, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_10




adult_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 <- person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID)
adult_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1_5 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_minus_1_5, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1_5

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0_1_5 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_0_1_5, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0_1_5

adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 <- sum(adult_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_1_5, na.rm=TRUE)
adult_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5
```




Demographic characteristics patients who underwent temporal resective epilepsy surgery
```{r}
# Date of temporal resective epilepsy surgery
temporal_resective_epilepsy_surgery_year_of_first_surgery <- temporal_resective_epilepsy_surgery %>% mutate(year_first_surgery=year(SVCDATE)) %>% arrange(ENROLID, year_first_surgery) %>% distinct(ENROLID, .keep_all=TRUE)


#################################2006#################################
demographics_temporal_resective_epilepsy_surgery2006 <- ms_a_2006 %>% filter(ENROLID %in% !!temporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_temporal_resective_epilepsy_surgery2006$ENROLID <- as.double(demographics_temporal_resective_epilepsy_surgery2006$ENROLID)
demographics_temporal_resective_epilepsy_surgery2006$SEX <- as.integer(demographics_temporal_resective_epilepsy_surgery2006$SEX)


#################################2007#################################
demographics_temporal_resective_epilepsy_surgery2007 <- ms_a_2007 %>% filter(ENROLID %in% !!temporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_temporal_resective_epilepsy_surgery2007$ENROLID <- as.double(demographics_temporal_resective_epilepsy_surgery2007$ENROLID)
demographics_temporal_resective_epilepsy_surgery2007$SEX <- as.integer(demographics_temporal_resective_epilepsy_surgery2007$SEX)


#################################2008#################################
demographics_temporal_resective_epilepsy_surgery2008 <- ms_a_2008 %>% filter(ENROLID %in% !!temporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_temporal_resective_epilepsy_surgery2008$ENROLID <- as.double(demographics_temporal_resective_epilepsy_surgery2008$ENROLID)
demographics_temporal_resective_epilepsy_surgery2008$SEX <- as.integer(demographics_temporal_resective_epilepsy_surgery2008$SEX)


#################################2009#################################
demographics_temporal_resective_epilepsy_surgery2009 <- ms_a_2009 %>% filter(ENROLID %in% !!temporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_temporal_resective_epilepsy_surgery2009$ENROLID <- as.double(demographics_temporal_resective_epilepsy_surgery2009$ENROLID)
demographics_temporal_resective_epilepsy_surgery2009$SEX <- as.integer(demographics_temporal_resective_epilepsy_surgery2009$SEX)


#################################2010#################################
demographics_temporal_resective_epilepsy_surgery2010 <- ms_a_2010 %>% filter(ENROLID %in% !!temporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_temporal_resective_epilepsy_surgery2010$ENROLID <- as.double(demographics_temporal_resective_epilepsy_surgery2010$ENROLID)
demographics_temporal_resective_epilepsy_surgery2010$SEX <- as.integer(demographics_temporal_resective_epilepsy_surgery2010$SEX)


#################################2011#################################
demographics_temporal_resective_epilepsy_surgery2011 <- ms_a_2011 %>% filter(ENROLID %in% !!temporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_temporal_resective_epilepsy_surgery2011$ENROLID <- as.double(demographics_temporal_resective_epilepsy_surgery2011$ENROLID)
demographics_temporal_resective_epilepsy_surgery2011$SEX <- as.integer(demographics_temporal_resective_epilepsy_surgery2011$SEX)


#################################2012#################################
demographics_temporal_resective_epilepsy_surgery2012 <- ms_a_2012 %>% filter(ENROLID %in% !!temporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_temporal_resective_epilepsy_surgery2012$ENROLID <- as.double(demographics_temporal_resective_epilepsy_surgery2012$ENROLID)
demographics_temporal_resective_epilepsy_surgery2012$SEX <- as.integer(demographics_temporal_resective_epilepsy_surgery2012$SEX)


#################################2013#################################
demographics_temporal_resective_epilepsy_surgery2013 <- ms_a_2013 %>% filter(ENROLID %in% !!temporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_temporal_resective_epilepsy_surgery2013$ENROLID <- as.double(demographics_temporal_resective_epilepsy_surgery2013$ENROLID)
demographics_temporal_resective_epilepsy_surgery2013$SEX <- as.integer(demographics_temporal_resective_epilepsy_surgery2013$SEX)


#################################2014#################################
demographics_temporal_resective_epilepsy_surgery2014 <- ms_a_2014 %>% filter(ENROLID %in% !!temporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_temporal_resective_epilepsy_surgery2014$ENROLID <- as.double(demographics_temporal_resective_epilepsy_surgery2014$ENROLID)
demographics_temporal_resective_epilepsy_surgery2014$SEX <- as.integer(demographics_temporal_resective_epilepsy_surgery2014$SEX)


#################################2015#################################
demographics_temporal_resective_epilepsy_surgery2015 <- ms_a_2015 %>% filter(ENROLID %in% !!temporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_temporal_resective_epilepsy_surgery2015$ENROLID <- as.double(demographics_temporal_resective_epilepsy_surgery2015$ENROLID)
demographics_temporal_resective_epilepsy_surgery2015$SEX <- as.integer(demographics_temporal_resective_epilepsy_surgery2015$SEX)


#################################2016#################################
demographics_temporal_resective_epilepsy_surgery2016 <- ms_a_2016 %>% filter(ENROLID %in% !!temporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_temporal_resective_epilepsy_surgery2016$ENROLID <- as.double(demographics_temporal_resective_epilepsy_surgery2016$ENROLID)
demographics_temporal_resective_epilepsy_surgery2016$SEX <- as.integer(demographics_temporal_resective_epilepsy_surgery2016$SEX)


#################################2017#################################
demographics_temporal_resective_epilepsy_surgery2017 <- ms_a_2017 %>% filter(ENROLID %in% !!temporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_temporal_resective_epilepsy_surgery2017$ENROLID <- as.double(demographics_temporal_resective_epilepsy_surgery2017$ENROLID)
demographics_temporal_resective_epilepsy_surgery2017$SEX <- as.integer(demographics_temporal_resective_epilepsy_surgery2017$SEX)


#################################2018#################################
demographics_temporal_resective_epilepsy_surgery2018 <- ms_a_2018 %>% filter(ENROLID %in% !!temporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_temporal_resective_epilepsy_surgery2018$ENROLID <- as.double(demographics_temporal_resective_epilepsy_surgery2018$ENROLID)
demographics_temporal_resective_epilepsy_surgery2018$SEX <- as.integer(demographics_temporal_resective_epilepsy_surgery2018$SEX)


#################################2019#################################
demographics_temporal_resective_epilepsy_surgery2019 <- ms_a_2019 %>% filter(ENROLID %in% !!temporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_temporal_resective_epilepsy_surgery2019$ENROLID <- as.double(demographics_temporal_resective_epilepsy_surgery2019$ENROLID)
demographics_temporal_resective_epilepsy_surgery2019$SEX <- as.integer(demographics_temporal_resective_epilepsy_surgery2019$SEX)


# Demographics temporal resective epilepsy surgery
demographics_temporal_resective_epilepsy_surgery <- bind_rows(demographics_temporal_resective_epilepsy_surgery2006, demographics_temporal_resective_epilepsy_surgery2007, demographics_temporal_resective_epilepsy_surgery2008, demographics_temporal_resective_epilepsy_surgery2009, demographics_temporal_resective_epilepsy_surgery2010, demographics_temporal_resective_epilepsy_surgery2011, demographics_temporal_resective_epilepsy_surgery2012, demographics_temporal_resective_epilepsy_surgery2013, demographics_temporal_resective_epilepsy_surgery2014, demographics_temporal_resective_epilepsy_surgery2015, demographics_temporal_resective_epilepsy_surgery2016, demographics_temporal_resective_epilepsy_surgery2017, demographics_temporal_resective_epilepsy_surgery2018, demographics_temporal_resective_epilepsy_surgery2019) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  distinct(ENROLID, .keep_all=TRUE) %>% 
  left_join(temporal_resective_epilepsy_surgery_year_of_first_surgery, by="ENROLID") %>% 
  mutate(age_first_surgery = year_first_surgery - DOBYR) %>% 
  left_join(refractory_focal_epilepsy, by="ENROLID") %>% 
  arrange(ENROLID, SVCDATE.x, SVCDATE.y) %>% 
  distinct(ENROLID, SVCDATE.x, .keep_all=TRUE) %>% 
  mutate(years_from_diagnosis_to_surgery = as.numeric(SVCDATE.x - SVCDATE.y)/365.24219) %>% 
  collect()


summary(demographics_temporal_resective_epilepsy_surgery$age_first_surgery)
sd(demographics_temporal_resective_epilepsy_surgery$age_first_surgery)
CrossTable(demographics_temporal_resective_epilepsy_surgery$SEX)
summary(demographics_temporal_resective_epilepsy_surgery$years_from_diagnosis_to_surgery)




# Person-years temporal epilepsy
temporal_patients_resective_epilepsy_surgery <- demographics_temporal_resective_epilepsy_surgery %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, SEX, age_first_surgery) %>% 
  left_join(person_years_resective_epilepsy_surgery_one_surgery, by="ENROLID") %>% 
  select(ENROLID, SEX, age_first_surgery, person_years)

 
# Basic demographics of  patients
temporal_patients_resective_epilepsy_surgery_n <- temporal_patients_resective_epilepsy_surgery %>% nrow()
temporal_patients_resective_epilepsy_surgery_n

CrossTable(temporal_patients_resective_epilepsy_surgery$SEX)

summary(temporal_patients_resective_epilepsy_surgery$age_first_surgery)
sd(temporal_patients_resective_epilepsy_surgery$age_first_surgery)




# Temporal person-years
temporal_person_years_resective_epilepsy_surgery <- person_years_resective_epilepsy_surgery %>% filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID)

temporal_total_person_years_resective_epilepsy_surgery <- sum(temporal_person_years_resective_epilepsy_surgery$person_years)
temporal_total_person_years_resective_epilepsy_surgery




temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery <- person_years_by_year_resective_epilepsy_surgery_one_surgery %>% filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID)
temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_10 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_10, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_10

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_9 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_9, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_9

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_8 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_8, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_8

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_7 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_7, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_7

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_6 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_6, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_6

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_5 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_5, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_5

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_4 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_4, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_4

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_3 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_3, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_3

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_2 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_2, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_2

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_1, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_0, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_1, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_2 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_2, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_2

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_3 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_3, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_3

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_4 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_4, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_4

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_5 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_5, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_5

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_6 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_6, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_6

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_7 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_7, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_7

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_8 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_8, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_8

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_9 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_9, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_9

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_10 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_10, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_10




temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 <- person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID)
temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1_5 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_minus_1_5, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1_5

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0_1_5 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_0_1_5, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0_1_5

temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 <- sum(temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_1_5, na.rm=TRUE)
temporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5
```




Demographic characteristics patients who underwent extratemporal resective epilepsy surgery
```{r}
# Date of extratemporal resective epilepsy surgery
extratemporal_resective_epilepsy_surgery_year_of_first_surgery <- extratemporal_resective_epilepsy_surgery %>% mutate(year_first_surgery=year(SVCDATE)) %>% arrange(ENROLID, year_first_surgery) %>% distinct(ENROLID, .keep_all=TRUE)


#################################2006#################################
demographics_extratemporal_resective_epilepsy_surgery2006 <- ms_a_2006 %>% filter(ENROLID %in% !!extratemporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_extratemporal_resective_epilepsy_surgery2006$ENROLID <- as.double(demographics_extratemporal_resective_epilepsy_surgery2006$ENROLID)
demographics_extratemporal_resective_epilepsy_surgery2006$SEX <- as.integer(demographics_extratemporal_resective_epilepsy_surgery2006$SEX)


#################################2007#################################
demographics_extratemporal_resective_epilepsy_surgery2007 <- ms_a_2007 %>% filter(ENROLID %in% !!extratemporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_extratemporal_resective_epilepsy_surgery2007$ENROLID <- as.double(demographics_extratemporal_resective_epilepsy_surgery2007$ENROLID)
demographics_extratemporal_resective_epilepsy_surgery2007$SEX <- as.integer(demographics_extratemporal_resective_epilepsy_surgery2007$SEX)


#################################2008#################################
demographics_extratemporal_resective_epilepsy_surgery2008 <- ms_a_2008 %>% filter(ENROLID %in% !!extratemporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_extratemporal_resective_epilepsy_surgery2008$ENROLID <- as.double(demographics_extratemporal_resective_epilepsy_surgery2008$ENROLID)
demographics_extratemporal_resective_epilepsy_surgery2008$SEX <- as.integer(demographics_extratemporal_resective_epilepsy_surgery2008$SEX)


#################################2009#################################
demographics_extratemporal_resective_epilepsy_surgery2009 <- ms_a_2009 %>% filter(ENROLID %in% !!extratemporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_extratemporal_resective_epilepsy_surgery2009$ENROLID <- as.double(demographics_extratemporal_resective_epilepsy_surgery2009$ENROLID)
demographics_extratemporal_resective_epilepsy_surgery2009$SEX <- as.integer(demographics_extratemporal_resective_epilepsy_surgery2009$SEX)


#################################2010#################################
demographics_extratemporal_resective_epilepsy_surgery2010 <- ms_a_2010 %>% filter(ENROLID %in% !!extratemporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_extratemporal_resective_epilepsy_surgery2010$ENROLID <- as.double(demographics_extratemporal_resective_epilepsy_surgery2010$ENROLID)
demographics_extratemporal_resective_epilepsy_surgery2010$SEX <- as.integer(demographics_extratemporal_resective_epilepsy_surgery2010$SEX)


#################################2011#################################
demographics_extratemporal_resective_epilepsy_surgery2011 <- ms_a_2011 %>% filter(ENROLID %in% !!extratemporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_extratemporal_resective_epilepsy_surgery2011$ENROLID <- as.double(demographics_extratemporal_resective_epilepsy_surgery2011$ENROLID)
demographics_extratemporal_resective_epilepsy_surgery2011$SEX <- as.integer(demographics_extratemporal_resective_epilepsy_surgery2011$SEX)


#################################2012#################################
demographics_extratemporal_resective_epilepsy_surgery2012 <- ms_a_2012 %>% filter(ENROLID %in% !!extratemporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_extratemporal_resective_epilepsy_surgery2012$ENROLID <- as.double(demographics_extratemporal_resective_epilepsy_surgery2012$ENROLID)
demographics_extratemporal_resective_epilepsy_surgery2012$SEX <- as.integer(demographics_extratemporal_resective_epilepsy_surgery2012$SEX)


#################################2013#################################
demographics_extratemporal_resective_epilepsy_surgery2013 <- ms_a_2013 %>% filter(ENROLID %in% !!extratemporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_extratemporal_resective_epilepsy_surgery2013$ENROLID <- as.double(demographics_extratemporal_resective_epilepsy_surgery2013$ENROLID)
demographics_extratemporal_resective_epilepsy_surgery2013$SEX <- as.integer(demographics_extratemporal_resective_epilepsy_surgery2013$SEX)


#################################2014#################################
demographics_extratemporal_resective_epilepsy_surgery2014 <- ms_a_2014 %>% filter(ENROLID %in% !!extratemporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_extratemporal_resective_epilepsy_surgery2014$ENROLID <- as.double(demographics_extratemporal_resective_epilepsy_surgery2014$ENROLID)
demographics_extratemporal_resective_epilepsy_surgery2014$SEX <- as.integer(demographics_extratemporal_resective_epilepsy_surgery2014$SEX)


#################################2015#################################
demographics_extratemporal_resective_epilepsy_surgery2015 <- ms_a_2015 %>% filter(ENROLID %in% !!extratemporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_extratemporal_resective_epilepsy_surgery2015$ENROLID <- as.double(demographics_extratemporal_resective_epilepsy_surgery2015$ENROLID)
demographics_extratemporal_resective_epilepsy_surgery2015$SEX <- as.integer(demographics_extratemporal_resective_epilepsy_surgery2015$SEX)


#################################2016#################################
demographics_extratemporal_resective_epilepsy_surgery2016 <- ms_a_2016 %>% filter(ENROLID %in% !!extratemporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_extratemporal_resective_epilepsy_surgery2016$ENROLID <- as.double(demographics_extratemporal_resective_epilepsy_surgery2016$ENROLID)
demographics_extratemporal_resective_epilepsy_surgery2016$SEX <- as.integer(demographics_extratemporal_resective_epilepsy_surgery2016$SEX)


#################################2017#################################
demographics_extratemporal_resective_epilepsy_surgery2017 <- ms_a_2017 %>% filter(ENROLID %in% !!extratemporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_extratemporal_resective_epilepsy_surgery2017$ENROLID <- as.double(demographics_extratemporal_resective_epilepsy_surgery2017$ENROLID)
demographics_extratemporal_resective_epilepsy_surgery2017$SEX <- as.integer(demographics_extratemporal_resective_epilepsy_surgery2017$SEX)


#################################2018#################################
demographics_extratemporal_resective_epilepsy_surgery2018 <- ms_a_2018 %>% filter(ENROLID %in% !!extratemporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_extratemporal_resective_epilepsy_surgery2018$ENROLID <- as.double(demographics_extratemporal_resective_epilepsy_surgery2018$ENROLID)
demographics_extratemporal_resective_epilepsy_surgery2018$SEX <- as.integer(demographics_extratemporal_resective_epilepsy_surgery2018$SEX)


#################################2019#################################
demographics_extratemporal_resective_epilepsy_surgery2019 <- ms_a_2019 %>% filter(ENROLID %in% !!extratemporal_resective_epilepsy_surgery$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_extratemporal_resective_epilepsy_surgery2019$ENROLID <- as.double(demographics_extratemporal_resective_epilepsy_surgery2019$ENROLID)
demographics_extratemporal_resective_epilepsy_surgery2019$SEX <- as.integer(demographics_extratemporal_resective_epilepsy_surgery2019$SEX)


# Demographics extratemporal resective epilepsy surgery
demographics_extratemporal_resective_epilepsy_surgery <- bind_rows(demographics_extratemporal_resective_epilepsy_surgery2006, demographics_extratemporal_resective_epilepsy_surgery2007, demographics_extratemporal_resective_epilepsy_surgery2008, demographics_extratemporal_resective_epilepsy_surgery2009, demographics_extratemporal_resective_epilepsy_surgery2010, demographics_extratemporal_resective_epilepsy_surgery2011, demographics_extratemporal_resective_epilepsy_surgery2012, demographics_extratemporal_resective_epilepsy_surgery2013, demographics_extratemporal_resective_epilepsy_surgery2014, demographics_extratemporal_resective_epilepsy_surgery2015, demographics_extratemporal_resective_epilepsy_surgery2016, demographics_extratemporal_resective_epilepsy_surgery2017, demographics_extratemporal_resective_epilepsy_surgery2018, demographics_extratemporal_resective_epilepsy_surgery2019) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  distinct(ENROLID, .keep_all=TRUE) %>% 
  left_join(extratemporal_resective_epilepsy_surgery_year_of_first_surgery, by="ENROLID") %>% 
  mutate(age_first_surgery = year_first_surgery - DOBYR) %>% 
  left_join(refractory_focal_epilepsy, by="ENROLID") %>% 
  arrange(ENROLID, SVCDATE.x, SVCDATE.y) %>% 
  distinct(ENROLID, SVCDATE.x, .keep_all=TRUE) %>% 
  mutate(years_from_diagnosis_to_surgery = as.numeric(SVCDATE.x - SVCDATE.y)/365.24219) %>% 
  collect()


summary(demographics_extratemporal_resective_epilepsy_surgery$age_first_surgery)
sd(demographics_extratemporal_resective_epilepsy_surgery$age_first_surgery)
CrossTable(demographics_extratemporal_resective_epilepsy_surgery$SEX)
summary(demographics_extratemporal_resective_epilepsy_surgery$years_from_diagnosis_to_surgery)




# Person-years extratemporal epilepsy
extratemporal_patients_resective_epilepsy_surgery <- demographics_extratemporal_resective_epilepsy_surgery %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, SEX, age_first_surgery) %>% 
  left_join(person_years_resective_epilepsy_surgery_one_surgery, by="ENROLID") %>% 
  select(ENROLID, SEX, age_first_surgery, person_years)

 
# Basic demographics of  patients
extratemporal_patients_resective_epilepsy_surgery_n <- extratemporal_patients_resective_epilepsy_surgery %>% nrow()
extratemporal_patients_resective_epilepsy_surgery_n

CrossTable(extratemporal_patients_resective_epilepsy_surgery$SEX)

summary(extratemporal_patients_resective_epilepsy_surgery$age_first_surgery)
sd(extratemporal_patients_resective_epilepsy_surgery$age_first_surgery)




# Extratemporal person-years
extratemporal_person_years_resective_epilepsy_surgery <- person_years_resective_epilepsy_surgery %>% filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID)

extratemporal_total_person_years_resective_epilepsy_surgery <- sum(extratemporal_person_years_resective_epilepsy_surgery$person_years)
extratemporal_total_person_years_resective_epilepsy_surgery




extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery <- person_years_by_year_resective_epilepsy_surgery_one_surgery %>% filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID)
extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_10 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_10, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_10

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_9 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_9, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_9

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_8 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_8, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_8

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_7 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_7, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_7

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_6 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_6, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_6

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_5 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_5, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_5

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_4 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_4, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_4

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_3 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_3, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_3

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_2 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_2, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_2

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_1, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_0, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_1, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_2 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_2, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_2

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_3 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_3, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_3

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_4 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_4, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_4

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_5 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_5, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_5

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_6 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_6, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_6

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_7 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_7, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_7

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_8 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_8, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_8

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_9 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_9, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_9

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_10 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_10, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_10




extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 <- person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID)
extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1_5 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_minus_1_5, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1_5

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0_1_5 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_0_1_5, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0_1_5

extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 <- sum(extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_1_5, na.rm=TRUE)
extratemporal_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5
```




Patients with resective epilepsy surgery and subdural monitoring
```{r}
# Subdural monitoring patients
subdural_patients_resective_epilepsy_surgery <- subdural_EEG %>% 
  filter(!(ENROLID %in% stereo_EEG$ENROLID)) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  left_join(demographics_resective_epilepsy_surgery, by="ENROLID") %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, SEX, age_first_surgery) %>% 
  left_join(person_years_resective_epilepsy_surgery, by="ENROLID") %>% 
  select(ENROLID, SEX, age_first_surgery, person_years)




# Basic demographics of  patients
subdural_patients_resective_epilepsy_surgery_n <- subdural_patients_resective_epilepsy_surgery %>% nrow()
subdural_patients_resective_epilepsy_surgery_n

CrossTable(subdural_patients_resective_epilepsy_surgery$SEX)

summary(subdural_patients_resective_epilepsy_surgery$age_first_surgery)
sd(subdural_patients_resective_epilepsy_surgery$age_first_surgery, na.rm=TRUE)




# Subdural person-years
subdural_person_years_resective_epilepsy_surgery <- person_years_resective_epilepsy_surgery %>% filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID)

subdural_total_person_years_resective_epilepsy_surgery <- sum(subdural_person_years_resective_epilepsy_surgery$person_years)
subdural_total_person_years_resective_epilepsy_surgery




subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery <- person_years_by_year_resective_epilepsy_surgery_one_surgery %>% filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID)
subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_10 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_10, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_10

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_9 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_9, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_9

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_8 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_8, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_8

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_7 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_7, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_7

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_6 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_6, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_6

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_5 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_5, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_5

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_4 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_4, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_4

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_3 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_3, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_3

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_2 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_2, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_2

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_1, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_0, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_1, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_2 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_2, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_2

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_3 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_3, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_3

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_4 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_4, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_4

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_5 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_5, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_5

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_6 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_6, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_6

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_7 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_7, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_7

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_8 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_8, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_8

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_9 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_9, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_9

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_10 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_10, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_10




subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 <- person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID)
subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1_5 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_minus_1_5, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1_5

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0_1_5 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_0_1_5, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0_1_5

subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 <- sum(subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_1_5, na.rm=TRUE)
subdural_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5
```




Patients with resective epilepsy surgery and stereoEEG monitoring
```{r}
# StereoEEG patients
stereo_EEG_patients_resective_epilepsy_surgery <- stereo_EEG %>% 
  filter(!(ENROLID %in% subdural_EEG$ENROLID)) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  left_join(demographics_resective_epilepsy_surgery, by="ENROLID") %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, SEX, age_first_surgery) %>% 
  left_join(person_years_resective_epilepsy_surgery, by="ENROLID") %>% 
  select(ENROLID, SEX, age_first_surgery, person_years)
 



# Basic demographics of  patients
stereo_EEG_patients_resective_epilepsy_surgery_n <- stereo_EEG_patients_resective_epilepsy_surgery %>% nrow()
stereo_EEG_patients_resective_epilepsy_surgery_n

CrossTable(stereo_EEG_patients_resective_epilepsy_surgery$SEX)

summary(stereo_EEG_patients_resective_epilepsy_surgery$age_first_surgery)
sd(stereo_EEG_patients_resective_epilepsy_surgery$age_first_surgery, na.rm=TRUE)




# Stereo EEG person-years
stereo_EEG_person_years_resective_epilepsy_surgery <- person_years_resective_epilepsy_surgery %>% filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID)

stereo_EEG_total_person_years_resective_epilepsy_surgery <- sum(stereo_EEG_person_years_resective_epilepsy_surgery$person_years)
stereo_EEG_total_person_years_resective_epilepsy_surgery




stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery <- person_years_by_year_resective_epilepsy_surgery_one_surgery %>% filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID)
stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_10 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_10, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_10

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_9 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_9, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_9

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_8 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_8, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_8

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_7 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_7, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_7

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_6 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_6, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_6

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_5 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_5, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_5

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_4 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_4, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_4

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_3 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_3, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_3

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_2 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_2, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_2

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_1, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_0, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_1, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_2 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_2, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_2

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_3 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_3, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_3

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_4 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_4, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_4

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_5 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_5, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_5

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_6 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_6, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_6

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_7 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_7, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_7

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_8 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_8, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_8

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_9 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_9, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_9

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_10 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_10, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_10




stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 <- person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID)
stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1_5 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_minus_1_5, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1_5

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0_1_5 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_0_1_5, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0_1_5

stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 <- sum(stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_1_5, na.rm=TRUE)
stereo_EEG_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5
```




Patients with resective epilepsy surgery without long-term intracranial monitoring
```{r}
# No long-term intracranial monitoring patients
no_intracranial_patients_resective_epilepsy_surgery <- resective_epilepsy_surgery_one_surgery %>% distinct(ENROLID) %>% 
  filter(!(ENROLID %in% !!subdural_EEG$ENROLID)) %>%
  filter(!(ENROLID %in% !!stereo_EEG$ENROLID)) %>% 
  left_join(demographics_resective_epilepsy_surgery, by="ENROLID") %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, SEX, age_first_surgery) %>% 
  left_join(person_years_resective_epilepsy_surgery, by="ENROLID") %>% 
  select(ENROLID, SEX, age_first_surgery, person_years)
 

# Basic demographics of  patients
no_intracranial_patients_resective_epilepsy_surgery_n <- no_intracranial_patients_resective_epilepsy_surgery %>% nrow()
no_intracranial_patients_resective_epilepsy_surgery_n

CrossTable(no_intracranial_patients_resective_epilepsy_surgery$SEX)

summary(no_intracranial_patients_resective_epilepsy_surgery$age_first_surgery)
sd(no_intracranial_patients_resective_epilepsy_surgery$age_first_surgery, na.rm=TRUE)




# No intracranial monitoring person-years
no_intracranial_person_years_resective_epilepsy_surgery <- person_years_resective_epilepsy_surgery %>% filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID)

no_intracranial_total_person_years_resective_epilepsy_surgery <- sum(no_intracranial_person_years_resective_epilepsy_surgery$person_years)
no_intracranial_total_person_years_resective_epilepsy_surgery




no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery <- person_years_by_year_resective_epilepsy_surgery_one_surgery %>% filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID)
no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_10 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_10, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_10

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_9 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_9, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_9

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_8 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_8, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_8

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_7 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_7, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_7

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_6 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_6, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_6

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_5 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_5, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_5

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_4 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_4, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_4

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_3 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_3, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_3

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_2 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_2, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_2

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_minus_1, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_0, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_1, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_2 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_2, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_2

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_3 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_3, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_3

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_4 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_4, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_4

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_5 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_5, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_5

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_6 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_6, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_6

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_7 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_7, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_7

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_8 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_8, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_8

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_9 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_9, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_9

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_10 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery$person_years_surgery_10, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_10




no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 <- person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID)
no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1_5 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_minus_1_5, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_minus_1_5

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0_1_5 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_0_1_5, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_0_1_5

no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 <- sum(no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5$person_years_surgery_1_5, na.rm=TRUE)
no_intracranial_total_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5
```




Demographic characteristics patients who underwent corpus callosotomy
```{r}
# Date of corpus callosotomy
corpus_callosotomy_year_of_first_surgery <- corpus_callosotomy %>% mutate(year_first_surgery=year(SVCDATE)) %>% arrange(ENROLID, year_first_surgery) %>% distinct(ENROLID, .keep_all=TRUE)


#################################2006#################################
demographics_corpus_callosotomy2006 <- ms_a_2006 %>% filter(ENROLID %in% !!corpus_callosotomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_corpus_callosotomy2006$ENROLID <- as.double(demographics_corpus_callosotomy2006$ENROLID)
demographics_corpus_callosotomy2006$SEX <- as.integer(demographics_corpus_callosotomy2006$SEX)


#################################2007#################################
demographics_corpus_callosotomy2007 <- ms_a_2007 %>% filter(ENROLID %in% !!corpus_callosotomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_corpus_callosotomy2007$ENROLID <- as.double(demographics_corpus_callosotomy2007$ENROLID)
demographics_corpus_callosotomy2007$SEX <- as.integer(demographics_corpus_callosotomy2007$SEX)


#################################2008#################################
demographics_corpus_callosotomy2008 <- ms_a_2008 %>% filter(ENROLID %in% !!corpus_callosotomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_corpus_callosotomy2008$ENROLID <- as.double(demographics_corpus_callosotomy2008$ENROLID)
demographics_corpus_callosotomy2008$SEX <- as.integer(demographics_corpus_callosotomy2008$SEX)


#################################2009#################################
demographics_corpus_callosotomy2009 <- ms_a_2009 %>% filter(ENROLID %in% !!corpus_callosotomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_corpus_callosotomy2009$ENROLID <- as.double(demographics_corpus_callosotomy2009$ENROLID)
demographics_corpus_callosotomy2009$SEX <- as.integer(demographics_corpus_callosotomy2009$SEX)


#################################2010#################################
demographics_corpus_callosotomy2010 <- ms_a_2010 %>% filter(ENROLID %in% !!corpus_callosotomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_corpus_callosotomy2010$ENROLID <- as.double(demographics_corpus_callosotomy2010$ENROLID)
demographics_corpus_callosotomy2010$SEX <- as.integer(demographics_corpus_callosotomy2010$SEX)


#################################2011#################################
demographics_corpus_callosotomy2011 <- ms_a_2011 %>% filter(ENROLID %in% !!corpus_callosotomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_corpus_callosotomy2011$ENROLID <- as.double(demographics_corpus_callosotomy2011$ENROLID)
demographics_corpus_callosotomy2011$SEX <- as.integer(demographics_corpus_callosotomy2011$SEX)


#################################2012#################################
demographics_corpus_callosotomy2012 <- ms_a_2012 %>% filter(ENROLID %in% !!corpus_callosotomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_corpus_callosotomy2012$ENROLID <- as.double(demographics_corpus_callosotomy2012$ENROLID)
demographics_corpus_callosotomy2012$SEX <- as.integer(demographics_corpus_callosotomy2012$SEX)


#################################2013#################################
demographics_corpus_callosotomy2013 <- ms_a_2013 %>% filter(ENROLID %in% !!corpus_callosotomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_corpus_callosotomy2013$ENROLID <- as.double(demographics_corpus_callosotomy2013$ENROLID)
demographics_corpus_callosotomy2013$SEX <- as.integer(demographics_corpus_callosotomy2013$SEX)


#################################2014#################################
demographics_corpus_callosotomy2014 <- ms_a_2014 %>% filter(ENROLID %in% !!corpus_callosotomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_corpus_callosotomy2014$ENROLID <- as.double(demographics_corpus_callosotomy2014$ENROLID)
demographics_corpus_callosotomy2014$SEX <- as.integer(demographics_corpus_callosotomy2014$SEX)


#################################2015#################################
demographics_corpus_callosotomy2015 <- ms_a_2015 %>% filter(ENROLID %in% !!corpus_callosotomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_corpus_callosotomy2015$ENROLID <- as.double(demographics_corpus_callosotomy2015$ENROLID)
demographics_corpus_callosotomy2015$SEX <- as.integer(demographics_corpus_callosotomy2015$SEX)


#################################2016#################################
demographics_corpus_callosotomy2016 <- ms_a_2016 %>% filter(ENROLID %in% !!corpus_callosotomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_corpus_callosotomy2016$ENROLID <- as.double(demographics_corpus_callosotomy2016$ENROLID)
demographics_corpus_callosotomy2016$SEX <- as.integer(demographics_corpus_callosotomy2016$SEX)


#################################2017#################################
demographics_corpus_callosotomy2017 <- ms_a_2017 %>% filter(ENROLID %in% !!corpus_callosotomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_corpus_callosotomy2017$ENROLID <- as.double(demographics_corpus_callosotomy2017$ENROLID)
demographics_corpus_callosotomy2017$SEX <- as.integer(demographics_corpus_callosotomy2017$SEX)


#################################2018#################################
demographics_corpus_callosotomy2018 <- ms_a_2018 %>% filter(ENROLID %in% !!corpus_callosotomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_corpus_callosotomy2018$ENROLID <- as.double(demographics_corpus_callosotomy2018$ENROLID)
demographics_corpus_callosotomy2018$SEX <- as.integer(demographics_corpus_callosotomy2018$SEX)


#################################2019#################################
demographics_corpus_callosotomy2019 <- ms_a_2019 %>% filter(ENROLID %in% !!corpus_callosotomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_corpus_callosotomy2019$ENROLID <- as.double(demographics_corpus_callosotomy2019$ENROLID)
demographics_corpus_callosotomy2019$SEX <- as.integer(demographics_corpus_callosotomy2019$SEX)


# Demographics corpus callosotomy
demographics_corpus_callosotomy <- bind_rows(demographics_corpus_callosotomy2006, demographics_corpus_callosotomy2007, demographics_corpus_callosotomy2008, demographics_corpus_callosotomy2009, demographics_corpus_callosotomy2010, demographics_corpus_callosotomy2011, demographics_corpus_callosotomy2012, demographics_corpus_callosotomy2013, demographics_corpus_callosotomy2014, demographics_corpus_callosotomy2015, demographics_corpus_callosotomy2016, demographics_corpus_callosotomy2017, demographics_corpus_callosotomy2018, demographics_corpus_callosotomy2019) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  distinct(ENROLID, .keep_all=TRUE) %>% 
  left_join(corpus_callosotomy_year_of_first_surgery, by="ENROLID") %>% 
  mutate(age_first_surgery = year_first_surgery - DOBYR) %>% 
  left_join(refractory_epilepsy, by="ENROLID") %>% 
  arrange(ENROLID, SVCDATE.x, SVCDATE.y) %>% 
  distinct(ENROLID, SVCDATE.x, .keep_all=TRUE) %>% 
  mutate(years_from_diagnosis_to_surgery = as.numeric(SVCDATE.x - SVCDATE.y)/365.24219) %>% 
  collect()



summary(demographics_corpus_callosotomy$age_first_surgery)
CrossTable(demographics_corpus_callosotomy$SEX)
summary(demographics_corpus_callosotomy$years_from_diagnosis_to_surgery)
```




Person-years corpus callosotomy
```{r}
# Corpus callosotmy: total
person_years_corpus_callosotomy <- follow_up %>%
  filter(ENROLID %in% !!corpus_callosotomy$ENROLID) %>% 
  group_by(ENROLID) %>% 
  left_join(epilepsy_first_diagnosis, by="ENROLID") %>% 
  mutate(MEMDAYS = ifelse(first_diagnosis_epilepsy<=DTEND, MEMDAYS, NA)) %>% 
  mutate(days_follow_up = sum(MEMDAYS, na.rm=TRUE),
         person_years = days_follow_up/365.24219) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect()

total_person_years_corpus_callosotomy <- sum(person_years_corpus_callosotomy$person_years)
total_person_years_corpus_callosotomy


# Patients with only the first corpus callosotomy
corpus_callosotomy_one_surgery <- corpus_callosotomy %>% arrange(ENROLID, SVCDATE) %>% distinct(ENROLID, .keep_all=TRUE)


# Corpus callosotomy (patients with only first surgery): total
person_years_corpus_callosotomy_one_surgery <- follow_up %>%
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  left_join(epilepsy_first_diagnosis, by="ENROLID") %>% 
  mutate(MEMDAYS = ifelse(first_diagnosis_epilepsy<=DTEND, MEMDAYS, NA)) %>% 
  mutate(days_follow_up = sum(MEMDAYS, na.rm=TRUE),
         person_years = days_follow_up/365.24219) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect()

total_person_years_corpus_callosotomy_one_surgery <- sum(person_years_corpus_callosotomy_one_surgery$person_years)
total_person_years_corpus_callosotomy_one_surgery




# Basic demographics
n_corpus_callosotomy <- demographics_corpus_callosotomy %>% distinct(ENROLID) %>% nrow()
n_corpus_callosotomy

summary(demographics_corpus_callosotomy$age_first_surgery)
sd(demographics_corpus_callosotomy$age_first_surgery)
CrossTable(demographics_corpus_callosotomy$SEX)
summary(demographics_corpus_callosotomy$years_from_diagnosis_to_surgery)




# Corpus callosotomy (patients with only first surgery): person years per year 
person_years_by_year_corpus_callosotomy_one_surgery <- follow_up %>%
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  left_join(corpus_callosotomy_one_surgery, by="ENROLID") %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  left_join(epilepsy_first_diagnosis, by="ENROLID") %>% 
  mutate(MEMDAYS = ifelse(first_diagnosis_epilepsy<=DTEND, MEMDAYS, NA)) %>% 
  mutate(
    person_years_surgery_minus_10 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(129))) & (DTEND < (SVCDATE - months(117)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_minus_9 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(117))) & (DTEND < (SVCDATE - months(105)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     
    person_years_surgery_minus_8 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(105))) & (DTEND < (SVCDATE - months(93)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_minus_7 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(93))) & (DTEND < (SVCDATE - months(81)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_minus_6 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(81))) & (DTEND < (SVCDATE - months(69)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_minus_5 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(69))) & (DTEND < (SVCDATE - months(57)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_minus_4 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(57))) & (DTEND < (SVCDATE - months(45)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_minus_3 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(45))) & (DTEND < (SVCDATE - months(33)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_minus_2 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(33))) & (DTEND < (SVCDATE - months(21)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_minus_1 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(21))) & (DTEND < (SVCDATE - months(9)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_0 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(9))) & (DTEND < (SVCDATE + months(3)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,      person_years_surgery_1 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(3))) & (DTEND < (SVCDATE + months(15)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_2 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(15))) & (DTEND < (SVCDATE + months(27)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_3 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(27))) & (DTEND < (SVCDATE + months(39)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_4 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(39))) & (DTEND < (SVCDATE + months(51)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_5 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(51))) & (DTEND < (SVCDATE + months(63)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_6 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(63))) & (DTEND < (SVCDATE + months(75)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_7 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(75))) & (DTEND < (SVCDATE + months(87)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_8 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(87))) & (DTEND < (SVCDATE + months(99)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_9 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(99))) & (DTEND < (SVCDATE + months(111)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_10 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(111))) & (DTEND < (SVCDATE + months(123)))), MEMDAYS, NA), na.rm=TRUE)/365.24219
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, person_years_surgery_minus_10, person_years_surgery_minus_9, person_years_surgery_minus_8, person_years_surgery_minus_7, person_years_surgery_minus_6, person_years_surgery_minus_5, person_years_surgery_minus_4, person_years_surgery_minus_3, person_years_surgery_minus_2, person_years_surgery_minus_1, person_years_surgery_0, person_years_surgery_1, person_years_surgery_2, person_years_surgery_3, person_years_surgery_4, person_years_surgery_5, person_years_surgery_6, person_years_surgery_7, person_years_surgery_8, person_years_surgery_9, person_years_surgery_10) %>% 
  collect()

total_person_years_by_year_corpus_callosotomy_one_surgery_minus_10 <- sum(person_years_by_year_corpus_callosotomy_one_surgery$person_years_surgery_minus_10, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_minus_10

total_person_years_by_year_corpus_callosotomy_one_surgery_minus_9 <- sum(person_years_by_year_corpus_callosotomy_one_surgery$person_years_surgery_minus_9, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_minus_9

total_person_years_by_year_corpus_callosotomy_one_surgery_minus_8 <- sum(person_years_by_year_corpus_callosotomy_one_surgery$person_years_surgery_minus_8, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_minus_8

total_person_years_by_year_corpus_callosotomy_one_surgery_minus_7 <- sum(person_years_by_year_corpus_callosotomy_one_surgery$person_years_surgery_minus_7, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_minus_7

total_person_years_by_year_corpus_callosotomy_one_surgery_minus_6 <- sum(person_years_by_year_corpus_callosotomy_one_surgery$person_years_surgery_minus_6, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_minus_6

total_person_years_by_year_corpus_callosotomy_one_surgery_minus_5 <- sum(person_years_by_year_corpus_callosotomy_one_surgery$person_years_surgery_minus_5, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_minus_5

total_person_years_by_year_corpus_callosotomy_one_surgery_minus_4 <- sum(person_years_by_year_corpus_callosotomy_one_surgery$person_years_surgery_minus_4, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_minus_4

total_person_years_by_year_corpus_callosotomy_one_surgery_minus_3 <- sum(person_years_by_year_corpus_callosotomy_one_surgery$person_years_surgery_minus_3, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_minus_3

total_person_years_by_year_corpus_callosotomy_one_surgery_minus_2 <- sum(person_years_by_year_corpus_callosotomy_one_surgery$person_years_surgery_minus_2, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_minus_2

total_person_years_by_year_corpus_callosotomy_one_surgery_minus_1 <- sum(person_years_by_year_corpus_callosotomy_one_surgery$person_years_surgery_minus_1, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_minus_1

total_person_years_by_year_corpus_callosotomy_one_surgery_0 <- sum(person_years_by_year_corpus_callosotomy_one_surgery$person_years_surgery_0, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_0

total_person_years_by_year_corpus_callosotomy_one_surgery_1 <- sum(person_years_by_year_corpus_callosotomy_one_surgery$person_years_surgery_1, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_1

total_person_years_by_year_corpus_callosotomy_one_surgery_2 <- sum(person_years_by_year_corpus_callosotomy_one_surgery$person_years_surgery_2, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_2

total_person_years_by_year_corpus_callosotomy_one_surgery_3 <- sum(person_years_by_year_corpus_callosotomy_one_surgery$person_years_surgery_3, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_3

total_person_years_by_year_corpus_callosotomy_one_surgery_4 <- sum(person_years_by_year_corpus_callosotomy_one_surgery$person_years_surgery_4, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_4

total_person_years_by_year_corpus_callosotomy_one_surgery_5 <- sum(person_years_by_year_corpus_callosotomy_one_surgery$person_years_surgery_5, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_5

total_person_years_by_year_corpus_callosotomy_one_surgery_6 <- sum(person_years_by_year_corpus_callosotomy_one_surgery$person_years_surgery_6, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_6

total_person_years_by_year_corpus_callosotomy_one_surgery_7 <- sum(person_years_by_year_corpus_callosotomy_one_surgery$person_years_surgery_7, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_7

total_person_years_by_year_corpus_callosotomy_one_surgery_8 <- sum(person_years_by_year_corpus_callosotomy_one_surgery$person_years_surgery_8, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_8

total_person_years_by_year_corpus_callosotomy_one_surgery_9 <- sum(person_years_by_year_corpus_callosotomy_one_surgery$person_years_surgery_9, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_9

total_person_years_by_year_corpus_callosotomy_one_surgery_10 <- sum(person_years_by_year_corpus_callosotomy_one_surgery$person_years_surgery_10, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_10




# Corpus callosotomy (patients with only first surgery): person years per year minus 1-5 versus 1-5
person_years_by_year_corpus_callosotomy_one_surgery_1_5 <- follow_up %>%
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  left_join(corpus_callosotomy_one_surgery, by="ENROLID") %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  left_join(epilepsy_first_diagnosis, by="ENROLID") %>% 
  mutate(MEMDAYS = ifelse(first_diagnosis_epilepsy<=DTEND, MEMDAYS, NA)) %>% 
  mutate(
    person_years_surgery_minus_1_5 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(69))) & (DTEND < (SVCDATE - months(9)))), MEMDAYS, NA), na.rm=TRUE)/(365.24219*5),
    person_years_surgery_0_1_5 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(9))) & (DTEND < (SVCDATE + months(3)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,      
    person_years_surgery_1_5 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(3))) & (DTEND < (SVCDATE + months(63)))), MEMDAYS, NA), na.rm=TRUE)/(365.24219*5)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, person_years_surgery_minus_1_5, person_years_surgery_0_1_5, person_years_surgery_1_5) %>% 
  collect()

total_person_years_by_year_corpus_callosotomy_one_surgery_minus_1_5 <- sum(person_years_by_year_corpus_callosotomy_one_surgery_1_5$person_years_surgery_minus_1_5, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_minus_1_5

total_person_years_by_year_corpus_callosotomy_one_surgery_0_1_5 <- sum(person_years_by_year_corpus_callosotomy_one_surgery_1_5$person_years_surgery_0_1_5, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_0_1_5

total_person_years_by_year_corpus_callosotomy_one_surgery_1_5 <- sum(person_years_by_year_corpus_callosotomy_one_surgery_1_5$person_years_surgery_1_5, na.rm=TRUE)
total_person_years_by_year_corpus_callosotomy_one_surgery_1_5
```




Demographic characteristics patients who underwent hemispherectomy
```{r}
# Date of hemispherectomy
hemispherectomy_year_of_first_surgery <- hemispherectomy %>% mutate(year_first_surgery=year(SVCDATE)) %>% arrange(ENROLID, year_first_surgery) %>% distinct(ENROLID, .keep_all=TRUE)


#################################2006#################################
demographics_hemispherectomy2006 <- ms_a_2006 %>% filter(ENROLID %in% !!hemispherectomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_hemispherectomy2006$ENROLID <- as.double(demographics_hemispherectomy2006$ENROLID)
demographics_hemispherectomy2006$SEX <- as.integer(demographics_hemispherectomy2006$SEX)


#################################2007#################################
demographics_hemispherectomy2007 <- ms_a_2007 %>% filter(ENROLID %in% !!hemispherectomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_hemispherectomy2007$ENROLID <- as.double(demographics_hemispherectomy2007$ENROLID)
demographics_hemispherectomy2007$SEX <- as.integer(demographics_hemispherectomy2007$SEX)


#################################2008#################################
demographics_hemispherectomy2008 <- ms_a_2008 %>% filter(ENROLID %in% !!hemispherectomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_hemispherectomy2008$ENROLID <- as.double(demographics_hemispherectomy2008$ENROLID)
demographics_hemispherectomy2008$SEX <- as.integer(demographics_hemispherectomy2008$SEX)


#################################2009#################################
demographics_hemispherectomy2009 <- ms_a_2009 %>% filter(ENROLID %in% !!hemispherectomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_hemispherectomy2009$ENROLID <- as.double(demographics_hemispherectomy2009$ENROLID)
demographics_hemispherectomy2009$SEX <- as.integer(demographics_hemispherectomy2009$SEX)


#################################2010#################################
demographics_hemispherectomy2010 <- ms_a_2010 %>% filter(ENROLID %in% !!hemispherectomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_hemispherectomy2010$ENROLID <- as.double(demographics_hemispherectomy2010$ENROLID)
demographics_hemispherectomy2010$SEX <- as.integer(demographics_hemispherectomy2010$SEX)


#################################2011#################################
demographics_hemispherectomy2011 <- ms_a_2011 %>% filter(ENROLID %in% !!hemispherectomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_hemispherectomy2011$ENROLID <- as.double(demographics_hemispherectomy2011$ENROLID)
demographics_hemispherectomy2011$SEX <- as.integer(demographics_hemispherectomy2011$SEX)


#################################2012#################################
demographics_hemispherectomy2012 <- ms_a_2012 %>% filter(ENROLID %in% !!hemispherectomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_hemispherectomy2012$ENROLID <- as.double(demographics_hemispherectomy2012$ENROLID)
demographics_hemispherectomy2012$SEX <- as.integer(demographics_hemispherectomy2012$SEX)


#################################2013#################################
demographics_hemispherectomy2013 <- ms_a_2013 %>% filter(ENROLID %in% !!hemispherectomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_hemispherectomy2013$ENROLID <- as.double(demographics_hemispherectomy2013$ENROLID)
demographics_hemispherectomy2013$SEX <- as.integer(demographics_hemispherectomy2013$SEX)


#################################2014#################################
demographics_hemispherectomy2014 <- ms_a_2014 %>% filter(ENROLID %in% !!hemispherectomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_hemispherectomy2014$ENROLID <- as.double(demographics_hemispherectomy2014$ENROLID)
demographics_hemispherectomy2014$SEX <- as.integer(demographics_hemispherectomy2014$SEX)


#################################2015#################################
demographics_hemispherectomy2015 <- ms_a_2015 %>% filter(ENROLID %in% !!hemispherectomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_hemispherectomy2015$ENROLID <- as.double(demographics_hemispherectomy2015$ENROLID)
demographics_hemispherectomy2015$SEX <- as.integer(demographics_hemispherectomy2015$SEX)


#################################2016#################################
demographics_hemispherectomy2016 <- ms_a_2016 %>% filter(ENROLID %in% !!hemispherectomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_hemispherectomy2016$ENROLID <- as.double(demographics_hemispherectomy2016$ENROLID)
demographics_hemispherectomy2016$SEX <- as.integer(demographics_hemispherectomy2016$SEX)


#################################2017#################################
demographics_hemispherectomy2017 <- ms_a_2017 %>% filter(ENROLID %in% !!hemispherectomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_hemispherectomy2017$ENROLID <- as.double(demographics_hemispherectomy2017$ENROLID)
demographics_hemispherectomy2017$SEX <- as.integer(demographics_hemispherectomy2017$SEX)


#################################2018#################################
demographics_hemispherectomy2018 <- ms_a_2018 %>% filter(ENROLID %in% !!hemispherectomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_hemispherectomy2018$ENROLID <- as.double(demographics_hemispherectomy2018$ENROLID)
demographics_hemispherectomy2018$SEX <- as.integer(demographics_hemispherectomy2018$SEX)


#################################2019#################################
demographics_hemispherectomy2019 <- ms_a_2019 %>% filter(ENROLID %in% !!hemispherectomy$ENROLID) %>% select(ENROLID, SEX, DOBYR) %>% collect()
demographics_hemispherectomy2019$ENROLID <- as.double(demographics_hemispherectomy2019$ENROLID)
demographics_hemispherectomy2019$SEX <- as.integer(demographics_hemispherectomy2019$SEX)


# Demographics hemispherectomy
demographics_hemispherectomy <- bind_rows(demographics_hemispherectomy2006, demographics_hemispherectomy2007, demographics_hemispherectomy2008, demographics_hemispherectomy2009, demographics_hemispherectomy2010, demographics_hemispherectomy2011, demographics_hemispherectomy2012, demographics_hemispherectomy2013, demographics_hemispherectomy2014, demographics_hemispherectomy2015, demographics_hemispherectomy2016, demographics_hemispherectomy2017, demographics_hemispherectomy2018, demographics_hemispherectomy2019) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  distinct(ENROLID, .keep_all=TRUE) %>% 
  left_join(hemispherectomy_year_of_first_surgery, by="ENROLID") %>% 
  mutate(age_first_surgery = year_first_surgery - DOBYR) %>% 
  left_join(refractory_epilepsy, by="ENROLID") %>% 
  arrange(ENROLID, SVCDATE.x, SVCDATE.y) %>% 
  distinct(ENROLID, SVCDATE.x, .keep_all=TRUE) %>%  
  mutate(years_from_diagnosis_to_surgery = as.numeric(SVCDATE.x - SVCDATE.y)/365.24219) %>% 
  collect()


summary(demographics_hemispherectomy$age_first_surgery)
sd(demographics_hemispherectomy$age_first_surgery)
CrossTable(demographics_hemispherectomy$SEX)
summary(demographics_hemispherectomy$years_from_diagnosis_to_surgery)
```




Person-years hemispherectomy
```{r}
# Hemispherectomy: total
person_years_hemispherectomy <- follow_up %>%
  filter(ENROLID %in% !!hemispherectomy$ENROLID) %>% 
  group_by(ENROLID) %>% 
  left_join(epilepsy_first_diagnosis, by="ENROLID") %>% 
  mutate(MEMDAYS = ifelse(first_diagnosis_epilepsy<=DTEND, MEMDAYS, NA)) %>% 
  mutate(days_follow_up = sum(MEMDAYS, na.rm=TRUE),
         person_years = days_follow_up/365.24219) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect()

total_person_years_hemispherectomy <- sum(person_years_hemispherectomy$person_years)
total_person_years_hemispherectomy


# Patients with only the first hemispherectomy
hemispherectomy_one_surgery <- hemispherectomy %>% arrange(ENROLID, SVCDATE) %>% distinct(ENROLID, .keep_all=TRUE)


# Hemispherectomy (patients with only first surgery): total
person_years_hemispherectomy_one_surgery <- follow_up %>%
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  left_join(epilepsy_first_diagnosis, by="ENROLID") %>% 
  mutate(MEMDAYS = ifelse(first_diagnosis_epilepsy<=DTEND, MEMDAYS, NA)) %>% 
  mutate(days_follow_up = sum(MEMDAYS, na.rm=TRUE),
         person_years = days_follow_up/365.24219) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect()

total_person_years_hemispherectomy_one_surgery <- sum(person_years_hemispherectomy_one_surgery$person_years)
total_person_years_hemispherectomy_one_surgery




# Basic demographics
n_hemispherectomy <- demographics_hemispherectomy %>% distinct(ENROLID) %>% nrow()
n_hemispherectomy

summary(demographics_hemispherectomy$age_first_surgery)
sd(demographics_hemispherectomy$age_first_surgery)
CrossTable(demographics_hemispherectomy$SEX)
summary(demographics_hemispherectomy$years_from_diagnosis_to_surgery)




# Hemispherectomy (patients with only first surgery): person years per year 
person_years_by_year_hemispherectomy_one_surgery <- follow_up %>%
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  left_join(hemispherectomy_one_surgery, by="ENROLID") %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  left_join(epilepsy_first_diagnosis, by="ENROLID") %>% 
  mutate(MEMDAYS = ifelse(first_diagnosis_epilepsy<=DTEND, MEMDAYS, NA)) %>% 
  mutate(
    person_years_surgery_minus_10 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(129))) & (DTEND < (SVCDATE - months(117)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_minus_9 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(117))) & (DTEND < (SVCDATE - months(105)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     
    person_years_surgery_minus_8 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(105))) & (DTEND < (SVCDATE - months(93)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_minus_7 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(93))) & (DTEND < (SVCDATE - months(81)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_minus_6 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(81))) & (DTEND < (SVCDATE - months(69)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_minus_5 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(69))) & (DTEND < (SVCDATE - months(57)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_minus_4 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(57))) & (DTEND < (SVCDATE - months(45)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_minus_3 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(45))) & (DTEND < (SVCDATE - months(33)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_minus_2 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(33))) & (DTEND < (SVCDATE - months(21)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_minus_1 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(21))) & (DTEND < (SVCDATE - months(9)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_0 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(9))) & (DTEND < (SVCDATE + months(3)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,      person_years_surgery_1 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(3))) & (DTEND < (SVCDATE + months(15)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_2 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(15))) & (DTEND < (SVCDATE + months(27)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_3 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(27))) & (DTEND < (SVCDATE + months(39)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_4 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(39))) & (DTEND < (SVCDATE + months(51)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_5 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(51))) & (DTEND < (SVCDATE + months(63)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_6 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(63))) & (DTEND < (SVCDATE + months(75)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_7 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(75))) & (DTEND < (SVCDATE + months(87)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_8 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(87))) & (DTEND < (SVCDATE + months(99)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,     person_years_surgery_9 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(99))) & (DTEND < (SVCDATE + months(111)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,
    person_years_surgery_10 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(111))) & (DTEND < (SVCDATE + months(123)))), MEMDAYS, NA), na.rm=TRUE)/365.24219
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, person_years_surgery_minus_10, person_years_surgery_minus_9, person_years_surgery_minus_8, person_years_surgery_minus_7, person_years_surgery_minus_6, person_years_surgery_minus_5, person_years_surgery_minus_4, person_years_surgery_minus_3, person_years_surgery_minus_2, person_years_surgery_minus_1, person_years_surgery_0, person_years_surgery_1, person_years_surgery_2, person_years_surgery_3, person_years_surgery_4, person_years_surgery_5, person_years_surgery_6, person_years_surgery_7, person_years_surgery_8, person_years_surgery_9, person_years_surgery_10) %>% 
  collect()

total_person_years_by_year_hemispherectomy_one_surgery_minus_10 <- sum(person_years_by_year_hemispherectomy_one_surgery$person_years_surgery_minus_10, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_minus_10

total_person_years_by_year_hemispherectomy_one_surgery_minus_9 <- sum(person_years_by_year_hemispherectomy_one_surgery$person_years_surgery_minus_9, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_minus_9

total_person_years_by_year_hemispherectomy_one_surgery_minus_8 <- sum(person_years_by_year_hemispherectomy_one_surgery$person_years_surgery_minus_8, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_minus_8

total_person_years_by_year_hemispherectomy_one_surgery_minus_7 <- sum(person_years_by_year_hemispherectomy_one_surgery$person_years_surgery_minus_7, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_minus_7

total_person_years_by_year_hemispherectomy_one_surgery_minus_6 <- sum(person_years_by_year_hemispherectomy_one_surgery$person_years_surgery_minus_6, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_minus_6

total_person_years_by_year_hemispherectomy_one_surgery_minus_5 <- sum(person_years_by_year_hemispherectomy_one_surgery$person_years_surgery_minus_5, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_minus_5

total_person_years_by_year_hemispherectomy_one_surgery_minus_4 <- sum(person_years_by_year_hemispherectomy_one_surgery$person_years_surgery_minus_4, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_minus_4

total_person_years_by_year_hemispherectomy_one_surgery_minus_3 <- sum(person_years_by_year_hemispherectomy_one_surgery$person_years_surgery_minus_3, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_minus_3

total_person_years_by_year_hemispherectomy_one_surgery_minus_2 <- sum(person_years_by_year_hemispherectomy_one_surgery$person_years_surgery_minus_2, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_minus_2

total_person_years_by_year_hemispherectomy_one_surgery_minus_1 <- sum(person_years_by_year_hemispherectomy_one_surgery$person_years_surgery_minus_1, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_minus_1

total_person_years_by_year_hemispherectomy_one_surgery_0 <- sum(person_years_by_year_hemispherectomy_one_surgery$person_years_surgery_0, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_0

total_person_years_by_year_hemispherectomy_one_surgery_1 <- sum(person_years_by_year_hemispherectomy_one_surgery$person_years_surgery_1, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_1

total_person_years_by_year_hemispherectomy_one_surgery_2 <- sum(person_years_by_year_hemispherectomy_one_surgery$person_years_surgery_2, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_2

total_person_years_by_year_hemispherectomy_one_surgery_3 <- sum(person_years_by_year_hemispherectomy_one_surgery$person_years_surgery_3, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_3

total_person_years_by_year_hemispherectomy_one_surgery_4 <- sum(person_years_by_year_hemispherectomy_one_surgery$person_years_surgery_4, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_4

total_person_years_by_year_hemispherectomy_one_surgery_5 <- sum(person_years_by_year_hemispherectomy_one_surgery$person_years_surgery_5, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_5

total_person_years_by_year_hemispherectomy_one_surgery_6 <- sum(person_years_by_year_hemispherectomy_one_surgery$person_years_surgery_6, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_6

total_person_years_by_year_hemispherectomy_one_surgery_7 <- sum(person_years_by_year_hemispherectomy_one_surgery$person_years_surgery_7, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_7

total_person_years_by_year_hemispherectomy_one_surgery_8 <- sum(person_years_by_year_hemispherectomy_one_surgery$person_years_surgery_8, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_8

total_person_years_by_year_hemispherectomy_one_surgery_9 <- sum(person_years_by_year_hemispherectomy_one_surgery$person_years_surgery_9, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_9

total_person_years_by_year_hemispherectomy_one_surgery_10 <- sum(person_years_by_year_hemispherectomy_one_surgery$person_years_surgery_10, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_10




# Hemispherectomy (patients with only first surgery): person years per year minus 1-5 versus 1-5
person_years_by_year_hemispherectomy_one_surgery_1_5 <- follow_up %>%
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  left_join(hemispherectomy_one_surgery, by="ENROLID") %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  left_join(epilepsy_first_diagnosis, by="ENROLID") %>% 
  mutate(MEMDAYS = ifelse(first_diagnosis_epilepsy<=DTEND, MEMDAYS, NA)) %>% 
  mutate(
    person_years_surgery_minus_1_5 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(69))) & (DTEND < (SVCDATE - months(9)))), MEMDAYS, NA), na.rm=TRUE)/(365.24219*5),
    person_years_surgery_0_1_5 = 
      sumNA(ifelse(((DTEND >= (SVCDATE - months(9))) & (DTEND < (SVCDATE + months(3)))), MEMDAYS, NA), na.rm=TRUE)/365.24219,      
    person_years_surgery_1_5 = 
      sumNA(ifelse(((DTEND >= (SVCDATE + months(3))) & (DTEND < (SVCDATE + months(63)))), MEMDAYS, NA), na.rm=TRUE)/(365.24219*5)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, person_years_surgery_minus_1_5, person_years_surgery_0_1_5, person_years_surgery_1_5) %>% 
  collect()

total_person_years_by_year_hemispherectomy_one_surgery_minus_1_5 <- sum(person_years_by_year_hemispherectomy_one_surgery_1_5$person_years_surgery_minus_1_5, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_minus_1_5

total_person_years_by_year_hemispherectomy_one_surgery_0_1_5 <- sum(person_years_by_year_hemispherectomy_one_surgery_1_5$person_years_surgery_0_1_5, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_0_1_5

total_person_years_by_year_hemispherectomy_one_surgery_1_5 <- sum(person_years_by_year_hemispherectomy_one_surgery_1_5$person_years_surgery_1_5, na.rm=TRUE)
total_person_years_by_year_hemispherectomy_one_surgery_1_5
```




Secular trends of epilepsy surgery
```{r}
# Proportion of resective epilepsy surgery over refractory epilepsy
refractory_epilepsy_per_year <- refractory_epilepsy_year_of_first_diagnosis %>% 
  group_by(year_first_diagnosis) %>% 
  summarize(number_refractory_epilepsy = n()) %>% 
  rename(year=year_first_diagnosis) %>% 
  collect()

resective_epilepsy_surgery_per_year <- resective_epilepsy_surgery %>% 
  mutate(year = year(SVCDATE)) %>% 
  group_by(year) %>% 
  summarize(number_resective_epilepsy_surgery_per_year = n()) %>% 
  collect()

proportion_resective_epilepsy_surgery_per_year <- resective_epilepsy_surgery_per_year %>% 
  left_join(refractory_epilepsy_per_year, by="year") %>% 
  mutate(proportion_resective_epilepsy_surgery = number_resective_epilepsy_surgery_per_year / number_refractory_epilepsy) %>% 
  collect()

evolution_refractory_epilepsy_surgery <- ggplot(data=proportion_resective_epilepsy_surgery_per_year) + 
  geom_line(aes(x=year, y=proportion_resective_epilepsy_surgery), color="purple2", lwd=1.5) + 
  geom_text(aes(x=year, y=proportion_resective_epilepsy_surgery, label=round(proportion_resective_epilepsy_surgery, 2)), color="purple2", size=5, nudge_y=0.07) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2019) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0,1))
evolution_refractory_epilepsy_surgery


# Proportion of resective epilepsy surgery over refractory focal epilepsy
refractory_focal_epilepsy_per_year <- refractory_focal_epilepsy_year_of_first_diagnosis %>% 
  group_by(year_first_diagnosis) %>% 
  summarize(number_refractory_focal_epilepsy = n()) %>% 
  rename(year=year_first_diagnosis) %>% 
  collect()

proportion_resective_epilepsy_surgery_per_year2 <- resective_epilepsy_surgery_per_year %>% 
  left_join(refractory_focal_epilepsy_per_year, by="year") %>% 
  mutate(proportion_resective_epilepsy_surgery = number_resective_epilepsy_surgery_per_year / number_refractory_focal_epilepsy) %>% 
  collect()

evolution_refractory_epilepsy_surgery2 <- ggplot(data=proportion_resective_epilepsy_surgery_per_year2) + 
  geom_line(aes(x=year, y=proportion_resective_epilepsy_surgery), color="purple2", lwd=1.5) + 
  geom_text(aes(x=year, y=proportion_resective_epilepsy_surgery, label=round(proportion_resective_epilepsy_surgery, 2)), color="purple2", size=5, nudge_y=0.07) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2019) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0,1))
evolution_refractory_epilepsy_surgery2


# Proportion of corpus callosotomy over refractory epilepsy
corpus_callosotomy_per_year <- corpus_callosotomy %>% 
  mutate(year = year(SVCDATE)) %>% 
  group_by(year) %>% 
  summarize(number_corpus_callosotomy_per_year = n()) %>% 
  collect()

proportion_corpus_callosotomy_per_year <- corpus_callosotomy_per_year %>% 
  left_join(refractory_epilepsy_per_year, by="year") %>% 
  mutate(proportion_corpus_callosotomy = number_corpus_callosotomy_per_year / number_refractory_epilepsy) %>% 
  collect()

evolution_corpus_callosotomy <- ggplot(data=proportion_corpus_callosotomy_per_year) + 
  geom_line(aes(x=year, y=proportion_corpus_callosotomy), color="purple2", lwd=1.5) + 
  geom_text(aes(x=year, y=proportion_corpus_callosotomy, label=round(proportion_corpus_callosotomy, 3)), color="purple2", size=4, nudge_y=0.07) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2019) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0,1))
evolution_corpus_callosotomy


# Proportion of hemispherectomy over refractory epilepsy
hemispherectomy_per_year <- hemispherectomy %>% 
  mutate(year = year(SVCDATE)) %>% 
  group_by(year) %>% 
  summarize(number_hemispherectomy_per_year = n()) %>% 
  collect()

proportion_hemispherectomy_per_year <- hemispherectomy_per_year %>% 
  left_join(refractory_epilepsy_per_year, by="year") %>% 
  mutate(proportion_hemispherectomy = number_hemispherectomy_per_year / number_refractory_epilepsy) %>% 
  collect()

evolution_hemispherectomy <- ggplot(data=proportion_hemispherectomy_per_year) + 
  geom_line(aes(x=year, y=proportion_hemispherectomy), color="purple2", lwd=1.5) + 
  geom_text(aes(x=year, y=proportion_hemispherectomy, label=round(proportion_hemispherectomy, 3)), color="purple2", size=4, nudge_y=0.07) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2019) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0,1))
evolution_hemispherectomy
```




Geographic distribution of epilepsy
```{r}
# Patient geolocation for epilepsy

#################################2006#################################
patient_geolocation_epilepsy2006 <- ms_a_2006 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2007#################################
patient_geolocation_epilepsy2007 <- ms_a_2007 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2008#################################
patient_geolocation_epilepsy2008 <- ms_a_2008 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2009#################################
patient_geolocation_epilepsy2009 <- ms_a_2009 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2010#################################
patient_geolocation_epilepsy2010 <- ms_a_2010 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2011#################################
patient_geolocation_epilepsy2011 <- ms_a_2011 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2012#################################
patient_geolocation_epilepsy2012 <- ms_a_2012 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2013#################################
patient_geolocation_epilepsy2013 <- ms_a_2013 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2014#################################
patient_geolocation_epilepsy2014 <- ms_a_2014 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2015#################################
patient_geolocation_epilepsy2015 <- ms_a_2015 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2016#################################
patient_geolocation_epilepsy2016 <- ms_a_2016 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2017#################################
patient_geolocation_epilepsy2017 <- ms_a_2017 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2018#################################
patient_geolocation_epilepsy2018 <- ms_a_2018 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2019#################################
patient_geolocation_epilepsy2019 <- ms_a_2019 %>% filter(ENROLID %in% !!epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


# Geolocation epilepsy
patient_geolocation_epilepsy <- bind_rows(patient_geolocation_epilepsy2006, patient_geolocation_epilepsy2007, patient_geolocation_epilepsy2008, patient_geolocation_epilepsy2009, patient_geolocation_epilepsy2010, patient_geolocation_epilepsy2011, patient_geolocation_epilepsy2012, patient_geolocation_epilepsy2013, patient_geolocation_epilepsy2014, patient_geolocation_epilepsy2015, patient_geolocation_epilepsy2016, patient_geolocation_epilepsy2017, patient_geolocation_epilepsy2018, patient_geolocation_epilepsy2019) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  distinct(ENROLID, .keep_all=TRUE) %>% 
  count(EGEOLOC) %>% 
  rename(region=EGEOLOC) %>% 
  mutate(region = case_when(
    region == 4 ~ "connecticut",
    region == 5 ~ "maine",
    region == 6 ~ "massachusetts",
    region == 7 ~ "new hampshire",
    region == 8 ~ "rhode island",
    region == 9 ~ "vermont",
    region == 11 ~ "new jersey",
    region == 12 ~ "new york",
    region == 13 ~ "pennsylvania",
    region == 16 ~ "illinois",
    region == 17 ~ "indiana",
    region == 18 ~ "michigan",
    region == 19 ~ "ohio",
    region == 20 ~ "wisconsin",
    region == 22 ~ "iowa",
    region == 23 ~ "kansas",
    region == 24 ~ "minnesota",
    region == 25 ~ "missouri",
    region == 26 ~ "nebraska",
    region == 27 ~ "north dakota",
    region == 28 ~ "south dakota",
    region == 31 ~ "district of columbia",
    region == 32 ~ "delaware",
    region == 33 ~ "florida",
    region == 34 ~ "georgia",
    region == 35 ~ "maryland",
    region == 36 ~ "north carolina",
    region == 37 ~ "south carolina",
    region == 38 ~ "virginia",
    region == 39 ~ "west virginia",
    region == 41 ~ "alabama",
    region == 42 ~ "kentucky",
    region == 43 ~ "mississippi",
    region == 44 ~ "tennessee",
    region == 46 ~ "arkansas",
    region == 47 ~ "louisiana",
    region == 48 ~ "oklahoma",
    region == 49 ~ "texas",
    region == 52 ~ "arizona",
    region == 53 ~ "colorado",
    region == 54 ~ "idaho",
    region == 55 ~ "montana",
    region == 56 ~ "nevada",
    region == 57 ~ "new mexico",
    region == 58 ~ "utah",
    region == 59 ~ "wyoming",
    region == 62 ~ "california",
    region == 64 ~ "oregon",
    region == 65 ~ "washington",
    TRUE ~ "unknown")) %>% 
  filter(region != "unknown")


sum(patient_geolocation_epilepsy$n)




# Patient geolocation for refractory epilepsy

#################################2006#################################
patient_geolocation_refractory_epilepsy2006 <- ms_a_2006 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2007#################################
patient_geolocation_refractory_epilepsy2007 <- ms_a_2007 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2008#################################
patient_geolocation_refractory_epilepsy2008 <- ms_a_2008 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2009#################################
patient_geolocation_refractory_epilepsy2009 <- ms_a_2009 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2010#################################
patient_geolocation_refractory_epilepsy2010 <- ms_a_2010 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2011#################################
patient_geolocation_refractory_epilepsy2011 <- ms_a_2011 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2012#################################
patient_geolocation_refractory_epilepsy2012 <- ms_a_2012 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2013#################################
patient_geolocation_refractory_epilepsy2013 <- ms_a_2013 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2014#################################
patient_geolocation_refractory_epilepsy2014 <- ms_a_2014 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2015#################################
patient_geolocation_refractory_epilepsy2015 <- ms_a_2015 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2016#################################
patient_geolocation_refractory_epilepsy2016 <- ms_a_2016 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2017#################################
patient_geolocation_refractory_epilepsy2017 <- ms_a_2017 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2018#################################
patient_geolocation_refractory_epilepsy2018 <- ms_a_2018 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2019#################################
patient_geolocation_refractory_epilepsy2019 <- ms_a_2019 %>% filter(ENROLID %in% !!refractory_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


# Geolocation refractory epilepsy
patient_geolocation_refractory_epilepsy <- bind_rows(patient_geolocation_refractory_epilepsy2006, patient_geolocation_refractory_epilepsy2007, patient_geolocation_refractory_epilepsy2008, patient_geolocation_refractory_epilepsy2009, patient_geolocation_refractory_epilepsy2010, patient_geolocation_refractory_epilepsy2011, patient_geolocation_refractory_epilepsy2012, patient_geolocation_refractory_epilepsy2013, patient_geolocation_refractory_epilepsy2014, patient_geolocation_refractory_epilepsy2015, patient_geolocation_refractory_epilepsy2016, patient_geolocation_refractory_epilepsy2017, patient_geolocation_refractory_epilepsy2018, patient_geolocation_refractory_epilepsy2019) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  distinct(ENROLID, .keep_all=TRUE) %>% 
  count(EGEOLOC) %>% 
  rename(region=EGEOLOC) %>% 
  mutate(region = case_when(
    region == 4 ~ "connecticut",
    region == 5 ~ "maine",
    region == 6 ~ "massachusetts",
    region == 7 ~ "new hampshire",
    region == 8 ~ "rhode island",
    region == 9 ~ "vermont",
    region == 11 ~ "new jersey",
    region == 12 ~ "new york",
    region == 13 ~ "pennsylvania",
    region == 16 ~ "illinois",
    region == 17 ~ "indiana",
    region == 18 ~ "michigan",
    region == 19 ~ "ohio",
    region == 20 ~ "wisconsin",
    region == 22 ~ "iowa",
    region == 23 ~ "kansas",
    region == 24 ~ "minnesota",
    region == 25 ~ "missouri",
    region == 26 ~ "nebraska",
    region == 27 ~ "north dakota",
    region == 28 ~ "south dakota",
    region == 31 ~ "district of columbia",
    region == 32 ~ "delaware",
    region == 33 ~ "florida",
    region == 34 ~ "georgia",
    region == 35 ~ "maryland",
    region == 36 ~ "north carolina",
    region == 37 ~ "south carolina",
    region == 38 ~ "virginia",
    region == 39 ~ "west virginia",
    region == 41 ~ "alabama",
    region == 42 ~ "kentucky",
    region == 43 ~ "mississippi",
    region == 44 ~ "tennessee",
    region == 46 ~ "arkansas",
    region == 47 ~ "louisiana",
    region == 48 ~ "oklahoma",
    region == 49 ~ "texas",
    region == 52 ~ "arizona",
    region == 53 ~ "colorado",
    region == 54 ~ "idaho",
    region == 55 ~ "montana",
    region == 56 ~ "nevada",
    region == 57 ~ "new mexico",
    region == 58 ~ "utah",
    region == 59 ~ "wyoming",
    region == 62 ~ "california",
    region == 64 ~ "oregon",
    region == 65 ~ "washington",
    TRUE ~ "unknown")) %>% 
  filter(region != "unknown")


sum(patient_geolocation_refractory_epilepsy$n)




# Patient geolocation for refractory focal epilepsy

#################################2006#################################
patient_geolocation_refractory_focal_epilepsy2006 <- ms_a_2006 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2007#################################
patient_geolocation_refractory_focal_epilepsy2007 <- ms_a_2007 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2008#################################
patient_geolocation_refractory_focal_epilepsy2008 <- ms_a_2008 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2009#################################
patient_geolocation_refractory_focal_epilepsy2009 <- ms_a_2009 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2010#################################
patient_geolocation_refractory_focal_epilepsy2010 <- ms_a_2010 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2011#################################
patient_geolocation_refractory_focal_epilepsy2011 <- ms_a_2011 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2012#################################
patient_geolocation_refractory_focal_epilepsy2012 <- ms_a_2012 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2013#################################
patient_geolocation_refractory_focal_epilepsy2013 <- ms_a_2013 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2014#################################
patient_geolocation_refractory_focal_epilepsy2014 <- ms_a_2014 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2015#################################
patient_geolocation_refractory_focal_epilepsy2015 <- ms_a_2015 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2016#################################
patient_geolocation_refractory_focal_epilepsy2016 <- ms_a_2016 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2017#################################
patient_geolocation_refractory_focal_epilepsy2017 <- ms_a_2017 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2018#################################
patient_geolocation_refractory_focal_epilepsy2018 <- ms_a_2018 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


#################################2019#################################
patient_geolocation_refractory_focal_epilepsy2019 <- ms_a_2019 %>% filter(ENROLID %in% !!refractory_focal_epilepsy$ENROLID) %>% select(ENROLID, EGEOLOC) %>% collect()


# Geolocation refractory epilepsy
patient_geolocation_refractory_focal_epilepsy <- bind_rows(patient_geolocation_refractory_focal_epilepsy2006, patient_geolocation_refractory_focal_epilepsy2007, patient_geolocation_refractory_focal_epilepsy2008, patient_geolocation_refractory_focal_epilepsy2009, patient_geolocation_refractory_focal_epilepsy2010, patient_geolocation_refractory_focal_epilepsy2011, patient_geolocation_refractory_focal_epilepsy2012, patient_geolocation_refractory_focal_epilepsy2013, patient_geolocation_refractory_focal_epilepsy2014, patient_geolocation_refractory_focal_epilepsy2015, patient_geolocation_refractory_focal_epilepsy2016, patient_geolocation_refractory_focal_epilepsy2017, patient_geolocation_refractory_focal_epilepsy2018, patient_geolocation_refractory_focal_epilepsy2019) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  distinct(ENROLID, .keep_all=TRUE) %>% 
  count(EGEOLOC) %>% 
  rename(region=EGEOLOC) %>% 
  mutate(region = case_when(
    region == 4 ~ "connecticut",
    region == 5 ~ "maine",
    region == 6 ~ "massachusetts",
    region == 7 ~ "new hampshire",
    region == 8 ~ "rhode island",
    region == 9 ~ "vermont",
    region == 11 ~ "new jersey",
    region == 12 ~ "new york",
    region == 13 ~ "pennsylvania",
    region == 16 ~ "illinois",
    region == 17 ~ "indiana",
    region == 18 ~ "michigan",
    region == 19 ~ "ohio",
    region == 20 ~ "wisconsin",
    region == 22 ~ "iowa",
    region == 23 ~ "kansas",
    region == 24 ~ "minnesota",
    region == 25 ~ "missouri",
    region == 26 ~ "nebraska",
    region == 27 ~ "north dakota",
    region == 28 ~ "south dakota",
    region == 31 ~ "district of columbia",
    region == 32 ~ "delaware",
    region == 33 ~ "florida",
    region == 34 ~ "georgia",
    region == 35 ~ "maryland",
    region == 36 ~ "north carolina",
    region == 37 ~ "south carolina",
    region == 38 ~ "virginia",
    region == 39 ~ "west virginia",
    region == 41 ~ "alabama",
    region == 42 ~ "kentucky",
    region == 43 ~ "mississippi",
    region == 44 ~ "tennessee",
    region == 46 ~ "arkansas",
    region == 47 ~ "louisiana",
    region == 48 ~ "oklahoma",
    region == 49 ~ "texas",
    region == 52 ~ "arizona",
    region == 53 ~ "colorado",
    region == 54 ~ "idaho",
    region == 55 ~ "montana",
    region == 56 ~ "nevada",
    region == 57 ~ "new mexico",
    region == 58 ~ "utah",
    region == 59 ~ "wyoming",
    region == 62 ~ "california",
    region == 64 ~ "oregon",
    region == 65 ~ "washington",
    TRUE ~ "unknown")) %>% 
  filter(region != "unknown")


sum(patient_geolocation_refractory_focal_epilepsy$n)




# Resective epilepsy surgery location (patient and hospital)

######################################2006##############################
cases_resective_epilepsy_surgery_2006 <- resective_epilepsy_surgery %>% 
  select(ENROLID, SVCDATE) %>% 
  filter(year(SVCDATE)==2006)

geolocation_resective_epilepsy_surgery_2006 <- ms_i_2006 %>% 
  select(ENROLID, ADMDATE, EGEOLOC, STATE) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  collect() %>% 
  mutate(across(ADMDATE, mdy)) %>% 
  rename(SVCDATE=ADMDATE) %>% 
  right_join(cases_resective_epilepsy_surgery_2006, by=c("ENROLID", "SVCDATE"))

  
######################################2007##############################
cases_resective_epilepsy_surgery_2007 <- resective_epilepsy_surgery %>% 
  select(ENROLID, SVCDATE) %>% 
  filter(year(SVCDATE)==2007)

geolocation_resective_epilepsy_surgery_2007 <- ms_i_2007 %>% 
  select(ENROLID, ADMDATE, EGEOLOC, STATE) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  collect() %>% 
  mutate(across(ADMDATE, mdy)) %>% 
  rename(SVCDATE=ADMDATE) %>% 
  right_join(cases_resective_epilepsy_surgery_2007, by=c("ENROLID", "SVCDATE"))


######################################2008##############################
cases_resective_epilepsy_surgery_2008 <- resective_epilepsy_surgery %>% 
  select(ENROLID, SVCDATE) %>% 
  filter(year(SVCDATE)==2008)

geolocation_resective_epilepsy_surgery_2008 <- ms_i_2008 %>% 
  select(ENROLID, ADMDATE, EGEOLOC, STATE) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  collect() %>% 
  mutate(across(ADMDATE, mdy)) %>% 
  rename(SVCDATE=ADMDATE) %>% 
  right_join(cases_resective_epilepsy_surgery_2008, by=c("ENROLID", "SVCDATE"))


######################################2009##############################
cases_resective_epilepsy_surgery_2009 <- resective_epilepsy_surgery %>% 
  select(ENROLID, SVCDATE) %>% 
  filter(year(SVCDATE)==2009)

geolocation_resective_epilepsy_surgery_2009 <- ms_i_2009 %>% 
  select(ENROLID, ADMDATE, EGEOLOC, STATE) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  collect() %>% 
  mutate(across(ADMDATE, mdy)) %>% 
  rename(SVCDATE=ADMDATE) %>% 
  right_join(cases_resective_epilepsy_surgery_2009, by=c("ENROLID", "SVCDATE"))


######################################2010##############################
cases_resective_epilepsy_surgery_2010 <- resective_epilepsy_surgery %>% 
  select(ENROLID, SVCDATE) %>% 
  filter(year(SVCDATE)==2010)

geolocation_resective_epilepsy_surgery_2010 <- ms_i_2010 %>% 
  select(ENROLID, ADMDATE, EGEOLOC, STATE) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  collect() %>% 
  mutate(across(ADMDATE, mdy)) %>% 
  rename(SVCDATE=ADMDATE) %>% 
  right_join(cases_resective_epilepsy_surgery_2010, by=c("ENROLID", "SVCDATE"))


######################################2011##############################
cases_resective_epilepsy_surgery_2011 <- resective_epilepsy_surgery %>% 
  select(ENROLID, SVCDATE) %>% 
  filter(year(SVCDATE)==2011)

geolocation_resective_epilepsy_surgery_2011 <- ms_i_2011 %>% 
  select(ENROLID, ADMDATE, EGEOLOC, STATE) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  collect() %>% 
  mutate(across(ADMDATE, mdy)) %>% 
  rename(SVCDATE=ADMDATE) %>% 
  right_join(cases_resective_epilepsy_surgery_2011, by=c("ENROLID", "SVCDATE"))


######################################2012##############################
cases_resective_epilepsy_surgery_2012 <- resective_epilepsy_surgery %>% 
  select(ENROLID, SVCDATE) %>% 
  filter(year(SVCDATE)==2012)

geolocation_resective_epilepsy_surgery_2012 <- ms_i_2012 %>% 
  select(ENROLID, ADMDATE, EGEOLOC, STATE) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  collect() %>% 
  mutate(across(ADMDATE, mdy)) %>% 
  rename(SVCDATE=ADMDATE) %>% 
  right_join(cases_resective_epilepsy_surgery_2012, by=c("ENROLID", "SVCDATE"))


######################################2013##############################
cases_resective_epilepsy_surgery_2013 <- resective_epilepsy_surgery %>% 
  select(ENROLID, SVCDATE) %>% 
  filter(year(SVCDATE)==2013)

geolocation_resective_epilepsy_surgery_2013 <- ms_i_2013 %>% 
  select(ENROLID, ADMDATE, EGEOLOC, STATE) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  collect() %>% 
  mutate(across(ADMDATE, mdy)) %>% 
  rename(SVCDATE=ADMDATE) %>% 
  right_join(cases_resective_epilepsy_surgery_2013, by=c("ENROLID", "SVCDATE"))


######################################2014##############################
cases_resective_epilepsy_surgery_2014 <- resective_epilepsy_surgery %>% 
  select(ENROLID, SVCDATE) %>% 
  filter(year(SVCDATE)==2014)

geolocation_resective_epilepsy_surgery_2014 <- ms_i_2014 %>% 
  select(ENROLID, ADMDATE, EGEOLOC, STATE) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  collect() %>% 
  mutate(across(ADMDATE, mdy)) %>% 
  rename(SVCDATE=ADMDATE) %>% 
  right_join(cases_resective_epilepsy_surgery_2014, by=c("ENROLID", "SVCDATE"))


######################################2015##############################
cases_resective_epilepsy_surgery_2015 <- resective_epilepsy_surgery %>% 
  select(ENROLID, SVCDATE) %>% 
  filter(year(SVCDATE)==2015)

geolocation_resective_epilepsy_surgery_2015 <- ms_i_2015 %>% 
  select(ENROLID, ADMDATE, EGEOLOC, STATE) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  collect() %>% 
  mutate(across(ADMDATE, mdy)) %>% 
  rename(SVCDATE=ADMDATE) %>% 
  right_join(cases_resective_epilepsy_surgery_2015, by=c("ENROLID", "SVCDATE"))


######################################2016##############################
cases_resective_epilepsy_surgery_2016 <- resective_epilepsy_surgery %>% 
  select(ENROLID, SVCDATE) %>% 
  filter(year(SVCDATE)==2016)

geolocation_resective_epilepsy_surgery_2016 <- ms_i_2016 %>% 
  select(ENROLID, ADMDATE, EGEOLOC, STATE) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  collect() %>% 
  mutate(across(ADMDATE, mdy)) %>% 
  rename(SVCDATE=ADMDATE) %>% 
  right_join(cases_resective_epilepsy_surgery_2016, by=c("ENROLID", "SVCDATE"))


######################################2017##############################
cases_resective_epilepsy_surgery_2017 <- resective_epilepsy_surgery %>% 
  select(ENROLID, SVCDATE) %>% 
  filter(year(SVCDATE)==2017)

geolocation_resective_epilepsy_surgery_2017 <- ms_i_2017 %>% 
  select(ENROLID, ADMDATE, EGEOLOC, STATE) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  collect() %>% 
  mutate(across(ADMDATE, mdy)) %>% 
  rename(SVCDATE=ADMDATE) %>% 
  right_join(cases_resective_epilepsy_surgery_2017, by=c("ENROLID", "SVCDATE"))


######################################2018##############################
cases_resective_epilepsy_surgery_2018 <- resective_epilepsy_surgery %>% 
  select(ENROLID, SVCDATE) %>% 
  filter(year(SVCDATE)==2018)

geolocation_resective_epilepsy_surgery_2018 <- ms_i_2018 %>% 
  select(ENROLID, ADMDATE, EGEOLOC, STATE) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  collect() %>% 
  mutate(across(ADMDATE, mdy)) %>% 
  rename(SVCDATE=ADMDATE) %>% 
  right_join(cases_resective_epilepsy_surgery_2018, by=c("ENROLID", "SVCDATE"))


######################################2019##############################
cases_resective_epilepsy_surgery_2019 <- resective_epilepsy_surgery %>% 
  select(ENROLID, SVCDATE) %>% 
  filter(year(SVCDATE)==2019)

geolocation_resective_epilepsy_surgery_2019 <- ms_i_2019 %>% 
  select(ENROLID, ADMDATE, EGEOLOC, STATE) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  collect() %>% 
  mutate(across(ADMDATE, mdy)) %>% 
  rename(SVCDATE=ADMDATE) %>% 
  right_join(cases_resective_epilepsy_surgery_2019, by=c("ENROLID", "SVCDATE"))


# Data for mapping resective epilepsy surgery
geolocation_resective_epilepsy_surgery <- bind_rows(geolocation_resective_epilepsy_surgery_2006, geolocation_resective_epilepsy_surgery_2007, geolocation_resective_epilepsy_surgery_2008, geolocation_resective_epilepsy_surgery_2009, geolocation_resective_epilepsy_surgery_2010, geolocation_resective_epilepsy_surgery_2011, geolocation_resective_epilepsy_surgery_2012, geolocation_resective_epilepsy_surgery_2013, geolocation_resective_epilepsy_surgery_2014, geolocation_resective_epilepsy_surgery_2015, geolocation_resective_epilepsy_surgery_2016, geolocation_resective_epilepsy_surgery_2017, geolocation_resective_epilepsy_surgery_2018, geolocation_resective_epilepsy_surgery_2019) %>% 
  select(EGEOLOC, STATE)
  

# Geolocation patient resective epilepsy surgery
patient_geolocation_resective_epilepsy_surgery <- geolocation_resective_epilepsy_surgery %>% count(EGEOLOC) %>% 
  rename(region=EGEOLOC) %>% 
  mutate(region = case_when(
    region == 4 ~ "connecticut",
    region == 5 ~ "maine",
    region == 6 ~ "massachusetts",
    region == 7 ~ "new hampshire",
    region == 8 ~ "rhode island",
    region == 9 ~ "vermont",
    region == 11 ~ "new jersey",
    region == 12 ~ "new york",
    region == 13 ~ "pennsylvania",
    region == 16 ~ "illinois",
    region == 17 ~ "indiana",
    region == 18 ~ "michigan",
    region == 19 ~ "ohio",
    region == 20 ~ "wisconsin",
    region == 22 ~ "iowa",
    region == 23 ~ "kansas",
    region == 24 ~ "minnesota",
    region == 25 ~ "missouri",
    region == 26 ~ "nebraska",
    region == 27 ~ "north dakota",
    region == 28 ~ "south dakota",
    region == 31 ~ "district of columbia",
    region == 32 ~ "delaware",
    region == 33 ~ "florida",
    region == 34 ~ "georgia",
    region == 35 ~ "maryland",
    region == 36 ~ "north carolina",
    region == 37 ~ "south carolina",
    region == 38 ~ "virginia",
    region == 39 ~ "west virginia",
    region == 41 ~ "alabama",
    region == 42 ~ "kentucky",
    region == 43 ~ "mississippi",
    region == 44 ~ "tennessee",
    region == 46 ~ "arkansas",
    region == 47 ~ "louisiana",
    region == 48 ~ "oklahoma",
    region == 49 ~ "texas",
    region == 52 ~ "arizona",
    region == 53 ~ "colorado",
    region == 54 ~ "idaho",
    region == 55 ~ "montana",
    region == 56 ~ "nevada",
    region == 57 ~ "new mexico",
    region == 58 ~ "utah",
    region == 59 ~ "wyoming",
    region == 62 ~ "california",
    region == 64 ~ "oregon",
    region == 65 ~ "washington",
    TRUE ~ "unknown")) %>% 
  filter(region != "unknown")


sum(patient_geolocation_resective_epilepsy_surgery$n)


# Geolocation hospital resective epilepsy surgery
hospital_geolocation_resective_epilepsy_surgery <- geolocation_resective_epilepsy_surgery %>% count(STATE) %>% 
  rename(region=STATE) %>% 
  mutate(region = case_when(
    region == 4 ~ "connecticut",
    region == 5 ~ "maine",
    region == 6 ~ "massachusetts",
    region == 7 ~ "new hampshire",
    region == 8 ~ "rhode island",
    region == 9 ~ "vermont",
    region == 11 ~ "new jersey",
    region == 12 ~ "new york",
    region == 13 ~ "pennsylvania",
    region == 16 ~ "illinois",
    region == 17 ~ "indiana",
    region == 18 ~ "michigan",
    region == 19 ~ "ohio",
    region == 20 ~ "wisconsin",
    region == 22 ~ "iowa",
    region == 23 ~ "kansas",
    region == 24 ~ "minnesota",
    region == 25 ~ "missouri",
    region == 26 ~ "nebraska",
    region == 27 ~ "north dakota",
    region == 28 ~ "south dakota",
    region == 31 ~ "district of columbia",
    region == 32 ~ "delaware",
    region == 33 ~ "florida",
    region == 34 ~ "georgia",
    region == 35 ~ "maryland",
    region == 36 ~ "north carolina",
    region == 37 ~ "south carolina",
    region == 38 ~ "virginia",
    region == 39 ~ "west virginia",
    region == 41 ~ "alabama",
    region == 42 ~ "kentucky",
    region == 43 ~ "mississippi",
    region == 44 ~ "tennessee",
    region == 46 ~ "arkansas",
    region == 47 ~ "louisiana",
    region == 48 ~ "oklahoma",
    region == 49 ~ "texas",
    region == 52 ~ "arizona",
    region == 53 ~ "colorado",
    region == 54 ~ "idaho",
    region == 55 ~ "montana",
    region == 56 ~ "nevada",
    region == 57 ~ "new mexico",
    region == 58 ~ "utah",
    region == 59 ~ "wyoming",
    region == 62 ~ "california",
    region == 64 ~ "oregon",
    region == 65 ~ "washington",
    TRUE ~ "unknown")) %>% 
  filter(region != "unknown")


sum(hospital_geolocation_resective_epilepsy_surgery$n)




# Data for USA states
USA_states_map <- map_data("state")


# Geolocation data for mapping
geolocation_data <- USA_states_map %>% 
  left_join(patient_geolocation_epilepsy, by="region") %>% 
  rename(epilepsy=n) %>% 
  left_join(patient_geolocation_refractory_epilepsy, by="region") %>% 
  rename(refractory_epilepsy=n) %>% 
  left_join(patient_geolocation_refractory_focal_epilepsy, by="region") %>% 
  rename(refractory_focal_epilepsy=n) %>% 
  left_join(patient_geolocation_resective_epilepsy_surgery, by="region") %>% 
  rename(patient_resective_epilepsy_surgery=n) %>% 
  left_join(hospital_geolocation_resective_epilepsy_surgery, by="region") %>% 
  rename(hospital_resective_epilepsy_surgery=n) %>%
  mutate(proportion_refractory_focal_epilepsy=refractory_focal_epilepsy/epilepsy) %>% 
  mutate(proportion_patient_resective_epilepsy_surgery_among_refractory_epilepsy=patient_resective_epilepsy_surgery/refractory_epilepsy) %>% 
  mutate(proportion_hospital_resective_epilepsy_surgery_among_refractory_epilepsy=hospital_resective_epilepsy_surgery/refractory_epilepsy) %>% 
  mutate(proportion_patient_resective_epilepsy_surgery=patient_resective_epilepsy_surgery/refractory_focal_epilepsy) %>% 
  mutate(proportion_hospital_resective_epilepsy_surgery=hospital_resective_epilepsy_surgery/refractory_focal_epilepsy)




# Map refractory focal epilepsy versus epilepsy
map_refractory_focal_epilepsy <- ggplot(geolocation_data, aes(long, lat, group=group)) +
  geom_polygon(aes(fill=proportion_refractory_focal_epilepsy), color="white") +
  scale_fill_distiller(palette="Purples", direction="horizontal", limits=c(0, 0.17), name="Proportion") +
    theme(panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(), axis.text=element_blank(), axis.title=element_blank())
map_refractory_focal_epilepsy


# Map patient resective epilepsy surgery versus refractory epilepsy
map_patient_resective_epilepsy_surgery_among_refractory_epilepsy <- ggplot(geolocation_data, aes(long, lat, group=group)) +
  geom_polygon(aes(fill=proportion_patient_resective_epilepsy_surgery_among_refractory_epilepsy), color="white") +
  scale_fill_distiller(palette="Purples", direction="horizontal", limits=c(0, 0.17), name="Proportion") +
    theme(panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(), axis.text=element_blank(), axis.title=element_blank())
map_patient_resective_epilepsy_surgery_among_refractory_epilepsy


# Map patient resective epilepsy surgery versus refractory focal epilepsy
map_patient_resective_epilepsy_surgery <- ggplot(geolocation_data, aes(long, lat, group=group)) +
  geom_polygon(aes(fill=proportion_patient_resective_epilepsy_surgery), color="white") +
  scale_fill_distiller(palette="Purples", direction="horizontal", limits=c(0, 0.17), name="Proportion") +
    theme(panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(), axis.text=element_blank(), axis.title=element_blank())
map_patient_resective_epilepsy_surgery


# Map hospital resective epilepsy surgery versus refractory focal epilepsy
map_hospital_resective_epilepsy_surgery <- ggplot(geolocation_data, aes(long, lat, group=group)) +
  geom_polygon(aes(fill=proportion_hospital_resective_epilepsy_surgery), color="white") +
  scale_fill_distiller(palette="Purples", direction="horizontal", limits=c(0, 0.17), name="Proportion") +
    theme(panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(), axis.text=element_blank(), axis.title=element_blank())
map_hospital_resective_epilepsy_surgery




# State capitals
USA_state_capitals <- us.cities %>% 
  filter(capital==2) %>% 
  filter(name != "Juneau AK") %>% 
  filter(name != "Honolulu HI") %>% 
  select(name, lat, long) %>% 
  mutate(state = case_when(
    name == "Albany NY" ~ "new york",
    name == "Annapolis MD" ~ "maryland",
    name == "Atlanta GA" ~ "georgia",
    name == "Augusta ME" ~ "maine",
    name == "Austin TX" ~ "texas",
    name == "Baton Rouge LA" ~ "louisiana",
    name == "Bismarck ND" ~ "north dakota",
    name == "Boise ID" ~ "idaho",
    name == "Boston MA" ~ "massachusetts",
    name == "Carson City NV" ~ "nevada",
    name == "Charleston WV" ~ "west virginia",
    name == "Cheyenne WY" ~ "wyoming",
    name == "Columbia SC" ~ "south carolina",
    name == "Columbus OH" ~ "ohio",
    name == "Concord NH" ~ "new hampshire",
    name == "Denver CO" ~ "colorado",
    name == "Des Moines IA" ~ "iowa",
    name == "Dover DE" ~ "delaware",
    name == "Frankfort KY" ~ "kentucky",
    name == "Harrisburg PA" ~ "pennsylvania",
    name == "Hartford CT" ~ "connecticut",
    name == "Helena MT" ~ "montana",
    name == "Indianapolis IN" ~ "indiana",
    name == "Jackson MS" ~ "mississippi",
    name == "Jefferson City MO" ~ "missouri",
    name == "Lansing MI" ~ "michigan",
    name == "Lincoln NE" ~ "nebraska",
    name == "Little Rock AR" ~ "arkansas",
    name == "Madison WI" ~ "wisconsin",
    name == "Montgomery AL" ~ "alabama",
    name == "Montpelier VT" ~ "vermont",
    name == "Nashville TN" ~ "tennessee",
    name == "Oklahoma City OK" ~ "oklahoma",
    name == "Olympia WA" ~ "washington",
    name == "Phoenix AZ" ~ "arizona",
    name == "Pierre SD" ~ "south dakota",
    name == "Providence RI" ~ "rhode island",
    name == "Raleigh NC" ~ "north carolina",
    name == "Richmond VA" ~ "virginia",
    name == "Sacramento CA" ~ "california",
    name == "Saint Paul MN" ~ "minnesota",
    name == "Salem OR" ~ "oregon",
    name == "Salt Lake City UT" ~ "utah",
    name == "Santa Fe NM" ~ "new mexico",
    name == "Springfield IL" ~ "illinois",
    name == "Tallahassee FL" ~ "florida",
    name == "Topeka KS" ~ "kansas",
    name == "Trenton NJ" ~ "new jersey"))


# Flow of patients from residence to hospital resective epilepsy surgery
flow_resective_epilepsy_surgery <- geolocation_resective_epilepsy_surgery %>% count(EGEOLOC, STATE) %>% 
  rename(home=EGEOLOC) %>% 
  rename(hospital=STATE) %>% 
  mutate(home = case_when(
    home == 4 ~ "connecticut",
    home == 5 ~ "maine",
    home == 6 ~ "massachusetts",
    home == 7 ~ "new hampshire",
    home == 8 ~ "rhode island",
    home == 9 ~ "vermont",
    home == 11 ~ "new jersey",
    home == 12 ~ "new york",
    home == 13 ~ "pennsylvania",
    home == 16 ~ "illinois",
    home == 17 ~ "indiana",
    home == 18 ~ "michigan",
    home == 19 ~ "ohio",
    home == 20 ~ "wisconsin",
    home == 22 ~ "iowa",
    home == 23 ~ "kansas",
    home == 24 ~ "minnesota",
    home == 25 ~ "missouri",
    home == 26 ~ "nebraska",
    home == 27 ~ "north dakota",
    home == 28 ~ "south dakota",
    home == 31 ~ "district of columbia",
    home == 32 ~ "delaware",
    home == 33 ~ "florida",
    home == 34 ~ "georgia",
    home == 35 ~ "maryland",
    home == 36 ~ "north carolina",
    home == 37 ~ "south carolina",
    home == 38 ~ "virginia",
    home == 39 ~ "west virginia",
    home == 41 ~ "alabama",
    home == 42 ~ "kentucky",
    home == 43 ~ "mississippi",
    home == 44 ~ "tennessee",
    home == 46 ~ "arkansas",
    home == 47 ~ "louisiana",
    home == 48 ~ "oklahoma",
    home == 49 ~ "texas",
    home == 52 ~ "arizona",
    home == 53 ~ "colorado",
    home == 54 ~ "idaho",
    home == 55 ~ "montana",
    home == 56 ~ "nevada",
    home == 57 ~ "new mexico",
    home == 58 ~ "utah",
    home == 59 ~ "wyoming",
    home == 62 ~ "california",
    home == 64 ~ "oregon",
    home == 65 ~ "washington",
    TRUE ~ "unknown")) %>% 
  filter(home != "unknown") %>% 
  mutate(hospital = case_when(
    hospital == 4 ~ "connecticut",
    hospital == 5 ~ "maine",
    hospital == 6 ~ "massachusetts",
    hospital == 7 ~ "new hampshire",
    hospital == 8 ~ "rhode island",
    hospital == 9 ~ "vermont",
    hospital == 11 ~ "new jersey",
    hospital == 12 ~ "new york",
    hospital == 13 ~ "pennsylvania",
    hospital == 16 ~ "illinois",
    hospital == 17 ~ "indiana",
    hospital == 18 ~ "michigan",
    hospital == 19 ~ "ohio",
    hospital == 20 ~ "wisconsin",
    hospital == 22 ~ "iowa",
    hospital == 23 ~ "kansas",
    hospital == 24 ~ "minnesota",
    hospital == 25 ~ "missouri",
    hospital == 26 ~ "nebraska",
    hospital == 27 ~ "north dakota",
    hospital == 28 ~ "south dakota",
    hospital == 31 ~ "district of columbia",
    hospital == 32 ~ "delaware",
    hospital == 33 ~ "florida",
    hospital == 34 ~ "georgia",
    hospital == 35 ~ "maryland",
    hospital == 36 ~ "north carolina",
    hospital == 37 ~ "south carolina",
    hospital == 38 ~ "virginia",
    hospital == 39 ~ "west virginia",
    hospital == 41 ~ "alabama",
    hospital == 42 ~ "kentucky",
    hospital == 43 ~ "mississippi",
    hospital == 44 ~ "tennessee",
    hospital == 46 ~ "arkansas",
    hospital == 47 ~ "louisiana",
    hospital == 48 ~ "oklahoma",
    hospital == 49 ~ "texas",
    hospital == 52 ~ "arizona",
    hospital == 53 ~ "colorado",
    hospital == 54 ~ "idaho",
    hospital == 55 ~ "montana",
    hospital == 56 ~ "nevada",
    hospital == 57 ~ "new mexico",
    hospital == 58 ~ "utah",
    hospital == 59 ~ "wyoming",
    hospital == 62 ~ "california",
    hospital == 64 ~ "oregon",
    hospital == 65 ~ "washington",
    TRUE ~ "unknown")) %>% 
  filter(hospital != "unknown") %>% 
  left_join(USA_state_capitals, by=c("home"="state")) %>% 
  rename(home_lat=lat) %>% 
  rename(home_long=long) %>% 
  select(home, home_long, home_lat, hospital, n) %>% 
  left_join(USA_state_capitals, by=c("hospital"="state")) %>% 
  rename(hospital_lat=lat) %>% 
  rename(hospital_long=long) %>% 
  select(home, home_long, home_lat, hospital, hospital_long, hospital_lat, n) %>% 
  filter(home != hospital)


sum(flow_resective_epilepsy_surgery$n)


# Map of the flow of patients from residence to hospital resective epilepsy surgery
map_flow_resective_epilepsy_surgery <- ggplot(USA_states_map, aes(long, lat, group=group)) +
  geom_polygon(color="white") +
  geom_point(data=USA_state_capitals, aes(x=long, y=lat), inherit.aes = FALSE, size=3, color="green") +
  geom_curve(data=flow_resective_epilepsy_surgery, aes(x=home_long, y=home_lat, xend=hospital_long, yend=hospital_lat), inherit.aes = FALSE, col="purple", curvature=0.5, arrow=arrow(), lineend = "butt", alpha=0.6, lwd=0.15*flow_resective_epilepsy_surgery$n) +
  theme(panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(), axis.text=element_blank(), axis.title=element_blank()) 
map_flow_resective_epilepsy_surgery


# Map summary resective epilepsy surgery
map_summary_resective_epilepsy_surgery <- ggplot(geolocation_data, aes(long, lat, group=group)) +
  geom_polygon(aes(fill=proportion_patient_resective_epilepsy_surgery), color="white") +
  scale_fill_distiller(palette="Purples", direction="horizontal", limits=c(0, 0.17), name="Proportion") +
  geom_point(data=USA_state_capitals, aes(x=long, y=lat), inherit.aes = FALSE, size=3, color="green") +
  geom_curve(data=flow_resective_epilepsy_surgery, aes(x=home_long, y=home_lat, xend=hospital_long, yend=hospital_lat), inherit.aes = FALSE, col="orange", curvature=0.5, arrow=arrow(), lineend = "butt", alpha=0.6, lwd=0.15*flow_resective_epilepsy_surgery$n) +
  theme(panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(), axis.text=element_blank(), axis.title=element_blank()) 
map_summary_resective_epilepsy_surgery


# Geolocation data for interactive mapping
geolocation_data_interactive <- geolocation_data %>% 
  select(long, lat, group, proportion_patient_resective_epilepsy_surgery_among_refractory_epilepsy, 
         proportion_patient_resective_epilepsy_surgery) %>% 
  rename(resective_epilepsy_surgery_over_refractory_epilepsy=proportion_patient_resective_epilepsy_surgery_among_refractory_epilepsy, resective_epilepsy_surgery_over_refractory_focal_epilepsy=proportion_patient_resective_epilepsy_surgery)

# Interactive map patient resective epilepsy surgery versus refractory epilepsy
interactive_map_resective_epilepsy_surgery_over_refractory_epilepsy <- ggplot(geolocation_data_interactive, aes(long, lat, group=group)) +
  geom_polygon(aes(fill=resective_epilepsy_surgery_over_refractory_epilepsy), color="white") +
  scale_fill_distiller(palette="Purples", direction="horizontal", limits=c(0, 0.17), name="Proportion") +
    theme(panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(), axis.text=element_blank(), axis.title=element_blank())
interactive_map_resective_epilepsy_surgery_over_refractory_epilepsy <- ggplotly(interactive_map_resective_epilepsy_surgery_over_refractory_epilepsy)
interactive_map_resective_epilepsy_surgery_over_refractory_epilepsy


# Interactive map patient resective epilepsy surgery versus refractory focal epilepsy
interactive_map_resective_epilepsy_surgery_over_refractory_focal_epilepsy <- ggplot(geolocation_data_interactive, aes(long, lat, group=group)) +
  geom_polygon(aes(fill=resective_epilepsy_surgery_over_refractory_focal_epilepsy), color="white") +
  scale_fill_distiller(palette="Purples", direction="horizontal", limits=c(0, 0.17), name="Proportion") +
    theme(panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(), axis.text=element_blank(), axis.title=element_blank())
interactive_map_resective_epilepsy_surgery_over_refractory_focal_epilepsy <- ggplotly(interactive_map_resective_epilepsy_surgery_over_refractory_focal_epilepsy)
interactive_map_resective_epilepsy_surgery_over_refractory_focal_epilepsy
```




Secular trends of presurgical work-up before resective epilepsy surgery
```{r}
# Subdural electrodes
subdural_before_surgery <- subdural_EEG %>% 
  left_join(resective_epilepsy_surgery, by="ENROLID") %>% 
  arrange(ENROLID, SVCDATE.x, SVCDATE.y) %>% 
  distinct(ENROLID, SVCDATE.x, .keep_all=TRUE) %>% 
  mutate(period_monitoring_surgery = SVCDATE.y - SVCDATE.x) %>% 
  filter(period_monitoring_surgery == 0 | period_monitoring_surgery > 0) %>% 
  collect()

summary(as.numeric(subdural_before_surgery$period_monitoring_surgery))

subdural_per_year <- subdural_before_surgery %>% 
  mutate(year = year(SVCDATE.x)) %>% 
  group_by(year) %>% 
  summarize(number_subdural_per_year = n()) %>% 
  collect()


# Stereo EEG
stereo_EEG_before_surgery <- stereo_EEG %>% 
  left_join(resective_epilepsy_surgery, by="ENROLID") %>% 
  arrange(ENROLID, SVCDATE.x, SVCDATE.y) %>% 
  distinct(ENROLID, SVCDATE.x, .keep_all=TRUE) %>% 
  mutate(period_monitoring_surgery = SVCDATE.y - SVCDATE.x) %>% 
  filter(period_monitoring_surgery == 0 | period_monitoring_surgery > 0) %>% 
  collect()

summary(as.numeric(stereo_EEG_before_surgery$period_monitoring_surgery))

stereo_EEG_per_year <- stereo_EEG_before_surgery %>% 
  mutate(year = year(SVCDATE.x)) %>% 
  group_by(year) %>% 
  summarize(number_stereo_EEG_per_year = n()) %>% 
  collect()


# ECoG
ECoG_before_surgery <- ECoG %>% 
  left_join(resective_epilepsy_surgery, by="ENROLID") %>% 
  arrange(ENROLID, SVCDATE.x, SVCDATE.y) %>% 
  distinct(ENROLID, SVCDATE.x, .keep_all=TRUE) %>% 
  mutate(period_monitoring_surgery = SVCDATE.y - SVCDATE.x) %>% 
  filter(period_monitoring_surgery == 0 | period_monitoring_surgery > 0) %>% 
  collect()

summary(as.numeric(ECoG_before_surgery$period_monitoring_surgery))

ECoG_per_year <- ECoG_before_surgery %>% 
  mutate(year = year(SVCDATE.x)) %>% 
  group_by(year) %>% 
  summarize(number_ECoG_per_year = n()) %>% 
  collect()


# PET
PET_before_surgery <- PET %>% 
  left_join(resective_epilepsy_surgery, by="ENROLID") %>% 
  arrange(ENROLID, SVCDATE.x, SVCDATE.y) %>% 
  distinct(ENROLID, SVCDATE.x, .keep_all=TRUE) %>% 
  mutate(period_monitoring_surgery = SVCDATE.y - SVCDATE.x) %>% 
  filter(period_monitoring_surgery == 0 | period_monitoring_surgery > 0) %>% 
  collect()

summary(as.numeric(PET_before_surgery$period_monitoring_surgery))

PET_per_year <- PET_before_surgery %>% 
  mutate(year = year(SVCDATE.x)) %>% 
  group_by(year) %>% 
  summarize(number_PET_per_year = n()) %>% 
  collect()


# SPECT
SPECT_before_surgery <- SPECT %>% 
  left_join(resective_epilepsy_surgery, by="ENROLID") %>% 
  arrange(ENROLID, SVCDATE.x, SVCDATE.y) %>% 
  distinct(ENROLID, SVCDATE.x, .keep_all=TRUE) %>% 
  mutate(period_monitoring_surgery = SVCDATE.y - SVCDATE.x) %>% 
  filter(period_monitoring_surgery == 0 | period_monitoring_surgery > 0) %>% 
  collect()

summary(as.numeric(SPECT_before_surgery$period_monitoring_surgery))

SPECT_per_year <- SPECT_before_surgery %>% 
  mutate(year = year(SVCDATE.x)) %>% 
  group_by(year) %>% 
  summarize(number_SPECT_per_year = n()) %>% 
  collect()


# MEG
MEG_before_surgery <- MEG %>% 
  left_join(resective_epilepsy_surgery, by="ENROLID") %>% 
  arrange(ENROLID, SVCDATE.x, SVCDATE.y) %>% 
  distinct(ENROLID, SVCDATE.x, .keep_all=TRUE) %>% 
  mutate(period_monitoring_surgery = SVCDATE.y - SVCDATE.x) %>% 
  filter(period_monitoring_surgery == 0 | period_monitoring_surgery > 0) %>% 
  collect()

summary(as.numeric(MEG_before_surgery$period_monitoring_surgery))

MEG_per_year <- MEG_before_surgery %>% 
  mutate(year = year(SVCDATE.x)) %>% 
  group_by(year) %>% 
  summarize(number_MEG_per_year = n()) %>% 
  collect()


# Wada
Wada_before_surgery <- Wada %>% 
  left_join(resective_epilepsy_surgery, by="ENROLID") %>% 
  arrange(ENROLID, SVCDATE.x, SVCDATE.y) %>% 
  distinct(ENROLID, SVCDATE.x, .keep_all=TRUE) %>% 
  mutate(period_monitoring_surgery = SVCDATE.y - SVCDATE.x) %>% 
  filter(period_monitoring_surgery == 0 | period_monitoring_surgery > 0) %>% 
  collect()

summary(as.numeric(Wada_before_surgery$period_monitoring_surgery))

Wada_per_year <- Wada_before_surgery %>% 
  mutate(year = year(SVCDATE.x)) %>% 
  group_by(year) %>% 
  summarize(number_Wada_per_year = n()) %>% 
  collect()


# Functional MRI
fMRI_before_surgery <- fMRI %>% 
  left_join(resective_epilepsy_surgery, by="ENROLID") %>% 
  arrange(ENROLID, SVCDATE.x, SVCDATE.y) %>% 
  distinct(ENROLID, SVCDATE.x, .keep_all=TRUE) %>% 
  mutate(period_monitoring_surgery = SVCDATE.y - SVCDATE.x) %>% 
  filter(period_monitoring_surgery == 0 | period_monitoring_surgery > 0) %>% 
  collect()

summary(as.numeric(fMRI_before_surgery$period_monitoring_surgery))

fMRI_per_year <- fMRI_before_surgery %>% 
  mutate(year = year(SVCDATE.x)) %>% 
  group_by(year) %>% 
  summarize(number_fMRI_per_year = n()) %>% 
  collect()


# Functional mapping
functional_mapping_before_surgery <- functional_mapping %>% 
  left_join(resective_epilepsy_surgery, by="ENROLID") %>% 
  arrange(ENROLID, SVCDATE.x, SVCDATE.y) %>% 
  distinct(ENROLID, SVCDATE.x, .keep_all=TRUE) %>% 
  mutate(period_monitoring_surgery = SVCDATE.y - SVCDATE.x) %>% 
  filter(period_monitoring_surgery == 0 | period_monitoring_surgery > 0) %>% 
  collect()

summary(as.numeric(functional_mapping_before_surgery$period_monitoring_surgery))

functional_mapping_per_year <- functional_mapping_before_surgery %>% 
  mutate(year = year(SVCDATE.x)) %>% 
  group_by(year) %>% 
  summarize(number_functional_mapping_per_year = n()) %>% 
  collect()


# Monitoring per year
monitoring_per_year <- resective_epilepsy_surgery_per_year %>% 
  left_join(subdural_per_year, by="year") %>% 
  left_join(stereo_EEG_per_year, by="year") %>% 
  left_join(ECoG_per_year, by="year") %>% 
  left_join(PET_per_year, by="year") %>% 
  left_join(SPECT_per_year, by="year") %>% 
  left_join(MEG_per_year, by="year") %>% 
  left_join(Wada_per_year, by="year") %>% 
  left_join(fMRI_per_year, by="year") %>% 
  left_join(functional_mapping_per_year, by="year") %>% 
  group_by(year) %>% 
  mutate(proportion_subdural = number_subdural_per_year / number_resective_epilepsy_surgery_per_year,
         proportion_stereo_EEG = number_stereo_EEG_per_year / number_resective_epilepsy_surgery_per_year,
         proportion_ECoG = number_ECoG_per_year / number_resective_epilepsy_surgery_per_year,
         proportion_PET = number_PET_per_year / number_resective_epilepsy_surgery_per_year,
         proportion_SPECT = number_SPECT_per_year / number_resective_epilepsy_surgery_per_year,
         proportion_MEG = number_MEG_per_year / number_resective_epilepsy_surgery_per_year,
         proportion_Wada = number_Wada_per_year / number_resective_epilepsy_surgery_per_year,
         proportion_fMRI = number_fMRI_per_year / number_resective_epilepsy_surgery_per_year,
         proportion_functional_mapping = number_functional_mapping_per_year / number_resective_epilepsy_surgery_per_year) %>% 
  arrange(year) %>% 
  collect()


# Figure evolution monitoring over time
evolution_monitoring <- ggplot(data=monitoring_per_year) + 
  geom_line(aes(x=year, y=proportion_subdural), color="red", lwd=1.5) + 
  geom_line(aes(x=year, y=proportion_stereo_EEG), color="darkgreen", lwd=1.5) + 
  geom_line(aes(x=year, y=proportion_ECoG), color="darkblue", lwd=1.5) + 
  geom_line(aes(x=year, y=proportion_PET), color="chocolate4", lwd=1.5) + 
  geom_line(aes(x=year, y=proportion_SPECT), color="darkcyan", lwd=1.5) + 
  geom_line(aes(x=year, y=proportion_MEG), color="deeppink", lwd=1.5) + 
  geom_line(aes(x=year, y=proportion_Wada), color="gray40", lwd=1.5) + 
  geom_line(aes(x=year, y=proportion_fMRI), color="darkorange", lwd=1.5) + 
  geom_line(aes(x=year, y=proportion_functional_mapping), color="sienna", lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2019) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0, 1))
evolution_monitoring


# Figure evolution intracranial monitoring over time
evolution_intracranial_monitoring <- ggplot(data=monitoring_per_year) + 
  geom_line(aes(x=year, y=proportion_subdural), color="red", lwd=1.5) + 
  geom_line(aes(x=year, y=proportion_stereo_EEG), color="darkgreen", lwd=1.5) + 
  geom_line(aes(x=year, y=proportion_ECoG), color="darkblue", lwd=1.5) + 
  geom_line(aes(x=year, y=proportion_functional_mapping), color="sienna", lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2019) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 0.8, 0.2), limits = c(0, 0.8))
evolution_intracranial_monitoring


# Subdural monitoring and no stereoEEG monitoring
sum(!(subdural_before_surgery$ENROLID %in% stereo_EEG_before_surgery$ENROLID))

# Subdural monitoring and stereoEEG monitoring
sum(subdural_before_surgery$ENROLID %in% stereo_EEG_before_surgery$ENROLID)

# StereoEEG monitoring and no subdural monitoring
sum(!(stereo_EEG_before_surgery$ENROLID %in% subdural_before_surgery$ENROLID))

# StereoEEG monitoring and subdural monitoring
sum(stereo_EEG_before_surgery$ENROLID %in% subdural_before_surgery$ENROLID)


# Subdural versus stereoEEG
subdural_per_year2 <- subdural_before_surgery %>% 
  mutate(year_monitoring = year(SVCDATE.x)) %>% 
  group_by(year_monitoring) %>% 
  summarize(number_per_year = n()) %>% 
  mutate(monitoring_type = "subdural") %>% 
  collect()

stereo_EEG_per_year2 <- stereo_EEG_before_surgery %>% 
  mutate(year_monitoring = year(SVCDATE.x)) %>% 
  group_by(year_monitoring) %>% 
  summarize(number_per_year = n()) %>% 
  mutate(monitoring_type = "stereo_EEG") %>% 
  collect()

subdural_vs_stereo_EEG_monitoring_per_year <- bind_rows(subdural_per_year2, stereo_EEG_per_year2) %>% 
  group_by(year_monitoring) %>% 
  mutate(proportion_monitorings = number_per_year / sum(number_per_year),
         monitoring_type = as_factor(monitoring_type)) %>% 
  arrange(year_monitoring, monitoring_type) %>% 
  collect()
                                       

# Figure evolution over time of subdural electrodes versus stereoEEG
subdural_vs_stereo_EEG_monitoring_evolution <- ggplot(data=subdural_vs_stereo_EEG_monitoring_per_year) + 
  geom_line(aes(x=year_monitoring, y=proportion_monitorings, group=monitoring_type, color=monitoring_type), lwd=1.5) + 
  geom_text(aes(x=year_monitoring, y=proportion_monitorings, label=round(proportion_monitorings, 2), color=monitoring_type), size=5, nudge_y=0.07) +
  scale_color_manual(values = c("subdural" = "red", "stereo_EEG"="darkgreen")) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2019) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0,1))
subdural_vs_stereo_EEG_monitoring_evolution


# Figure evolution functional neuroimaging over time
evolution_functional_monitoring <- ggplot(data=monitoring_per_year) + 
  geom_line(aes(x=year, y=proportion_PET), color="chocolate4", lwd=1.5) + 
  geom_line(aes(x=year, y=proportion_SPECT), color="darkcyan", lwd=1.5) + 
  geom_line(aes(x=year, y=proportion_MEG), color="deeppink", lwd=1.5) + 
  geom_line(aes(x=year, y=proportion_Wada), color="gray40", lwd=1.5) + 
  geom_line(aes(x=year, y=proportion_fMRI), color="darkorange", lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2019) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 0.8, 0.2), limits = c(0, 0.8))
evolution_functional_monitoring


# Wada versus fMRI
Wada_per_year2 <- Wada_before_surgery %>% 
  mutate(year_monitoring = year(SVCDATE.x)) %>% 
  group_by(year_monitoring) %>% 
  summarize(number_per_year = n()) %>% 
  mutate(monitoring_type = "Wada") %>% 
  collect()

fMRI_per_year2 <- fMRI_before_surgery %>% 
  mutate(year_monitoring = year(SVCDATE.x)) %>% 
  group_by(year_monitoring) %>% 
  summarize(number_per_year = n()) %>% 
  mutate(monitoring_type = "fMRI") %>% 
  collect()

Wada_vs_fMRI_monitoring_per_year <- bind_rows(Wada_per_year2, fMRI_per_year2) %>% 
  group_by(year_monitoring) %>% 
  mutate(proportion_monitorings = number_per_year / sum(number_per_year),
         monitoring_type = as_factor(monitoring_type)) %>% 
  arrange(year_monitoring, monitoring_type) %>% 
  collect()
                                       

# Figure evolution over time of Wada versus fMRI
Wada_vs_fMRI_monitoring_evolution <- ggplot(data=Wada_vs_fMRI_monitoring_per_year) + 
  geom_line(aes(x=year_monitoring, y=proportion_monitorings, group=monitoring_type, color=monitoring_type), lwd=1.5) + 
  geom_text(aes(x=year_monitoring, y=proportion_monitorings, label=round(proportion_monitorings, 2), color=monitoring_type), size=5, nudge_y=0.07) +
  scale_color_manual(values = c("Wada" = "gray40", "fMRI"="darkorange")) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2006:2019) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0,1))
Wada_vs_fMRI_monitoring_evolution
```








## 5. Clinical and economic outcomes in resective epilepsy surgery




Healthcare resource utilization among patients with resective epilepsy surgery
```{r}
# Resource utilization
revenue_codes_EDvisits <- c("0450", "0451", "0452", "0456", "0459", "0981")
place_of_service_codes_EDvisits <- c("20", "23", "41", "42")
CPT_codes_EDvisits <- c("99281", "99282", "99283", "99284", "99285")
service_subcategory_codes_EDvisits <- c("10120", "10220", "10320", "10420", "10520", "12220", "20120", "20220", "21120", "21220", "22120", "22320", "30120", "30220", "30320", "30420", "30520", "30620", "31120", "31220", "31320", "31420", "31520", "31620")
PROCGRP_codes_EDvisits <- c("111", "114")

revenue_codes_inpatient <- c("0100", "0101", "0110", "0111", "0112", "0113", "0114", "0115", "0116", "0117", "0118", "0119", "0120", "0121", "0122", "0123", "0124", "0125", "0126", "0127", "0128", "0129", "0130", "0131", "0132", "0133", "0134", "0135", "0136", "0137", "0138", "0139", "0140", "0141", "0142", "0143", "0144", "0145", "0146", "0147", "0148", "0149", "0150", "0151", "0152", "0153", "0154", "0155", "0156", "0157", "0158", "0159", "0160", "0161", "0162", "0164", "0166", "0167", "0168", "0169", "0170", "0171", "0172", "0173", "0174", "0175", "0179", "0180", "0182", "0183", "0184", "0185", "0189", "0190", "0191", "0192", "0193", "0194", "0199", "0200", "0201", "0202", "0203", "0204", "0206", "0207", "0208", "0209", "0210", "0211", "0212", "0213", "0214", "0219", "0720", "0721", "0722", "0723", "0724", "0729", "0760", "0761", "0762", "0769", "0800", "0801", "0802", "0803", "0804", "0809")
place_of_service_codes_inpatient <- c("21", "27", "28", "51", "61")
CPT_codes_inpatient <- c("99217", "99218", "99219", "99220", "99224", "99225", "99226", "99234", "99235", "99236")




#################################2006#################################
utilization_resective_epilepsy_surgery_2006_o <- ms_o_2006 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2006_i <- ms_i_2006 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2006_s <- ms_s_2006 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2007#################################
utilization_resective_epilepsy_surgery_2007_o <- ms_o_2007 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2007_i <- ms_i_2007 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2007_s <- ms_s_2007 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2008#################################
utilization_resective_epilepsy_surgery_2008_o <- ms_o_2008 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2008_i <- ms_i_2008 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2008_s <- ms_s_2008 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2009#################################
utilization_resective_epilepsy_surgery_2009_o <- ms_o_2009 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2009_i <- ms_i_2009 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2009_s <- ms_s_2009 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2010#################################
utilization_resective_epilepsy_surgery_2010_o <- ms_o_2010 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2010_i <- ms_i_2010 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2010_s <- ms_s_2010 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2011#################################
utilization_resective_epilepsy_surgery_2011_o <- ms_o_2011 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2011_i <- ms_i_2011 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2011_s <- ms_s_2011 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2012#################################
utilization_resective_epilepsy_surgery_2012_o <- ms_o_2012 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2012_i <- ms_i_2012 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2012_s <- ms_s_2012 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2013#################################
utilization_resective_epilepsy_surgery_2013_o <- ms_o_2013 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2013_i <- ms_i_2013 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2013_s <- ms_s_2013 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2014#################################
utilization_resective_epilepsy_surgery_2014_o <- ms_o_2014 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2014_i <- ms_i_2014 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2014_s <- ms_s_2014%>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2015#################################
utilization_resective_epilepsy_surgery_2015_o <- ms_o_2015 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2015_i <- ms_i_2015 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2015_s <- ms_s_2015%>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2016#################################
utilization_resective_epilepsy_surgery_2016_o <- ms_o_2016 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2016_i <- ms_i_2016 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2016_s <- ms_s_2016%>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2017#################################
utilization_resective_epilepsy_surgery_2017_o <- ms_o_2017 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2017_i <- ms_i_2017 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2017_s <- ms_s_2017%>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2018#################################
utilization_resective_epilepsy_surgery_2018_o <- ms_o_2018 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2018_i <- ms_i_2018 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2018_s <- ms_s_2018%>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2019#################################
utilization_resective_epilepsy_surgery_2019_o <- ms_o_2019 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2019_i <- ms_i_2019 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_resective_epilepsy_surgery_2019_s <- ms_s_2019%>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!resective_epilepsy_surgery_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)








# Utilization
utilization_resective_epilepsy_surgery <- bind_rows(utilization_resective_epilepsy_surgery_2006_o, utilization_resective_epilepsy_surgery_2006_i, utilization_resective_epilepsy_surgery_2006_s,
utilization_resective_epilepsy_surgery_2007_o, utilization_resective_epilepsy_surgery_2007_i, utilization_resective_epilepsy_surgery_2007_s, utilization_resective_epilepsy_surgery_2008_o, utilization_resective_epilepsy_surgery_2008_i, utilization_resective_epilepsy_surgery_2008_s,         utilization_resective_epilepsy_surgery_2009_o, utilization_resective_epilepsy_surgery_2009_i, utilization_resective_epilepsy_surgery_2009_s, utilization_resective_epilepsy_surgery_2010_o, utilization_resective_epilepsy_surgery_2010_i, utilization_resective_epilepsy_surgery_2010_s,        utilization_resective_epilepsy_surgery_2011_o, utilization_resective_epilepsy_surgery_2011_i, utilization_resective_epilepsy_surgery_2011_s, utilization_resective_epilepsy_surgery_2012_o, utilization_resective_epilepsy_surgery_2012_i, utilization_resective_epilepsy_surgery_2012_s,
utilization_resective_epilepsy_surgery_2013_o, utilization_resective_epilepsy_surgery_2013_i, utilization_resective_epilepsy_surgery_2013_s, utilization_resective_epilepsy_surgery_2014_o, utilization_resective_epilepsy_surgery_2014_i, utilization_resective_epilepsy_surgery_2014_s,         utilization_resective_epilepsy_surgery_2015_o, utilization_resective_epilepsy_surgery_2015_i, utilization_resective_epilepsy_surgery_2015_s, utilization_resective_epilepsy_surgery_2016_o, utilization_resective_epilepsy_surgery_2016_i, utilization_resective_epilepsy_surgery_2016_s,
utilization_resective_epilepsy_surgery_2017_o, utilization_resective_epilepsy_surgery_2017_i, utilization_resective_epilepsy_surgery_2017_s, utilization_resective_epilepsy_surgery_2018_o, utilization_resective_epilepsy_surgery_2018_i, utilization_resective_epilepsy_surgery_2018_s,
utilization_resective_epilepsy_surgery_2019_o, utilization_resective_epilepsy_surgery_2019_i, utilization_resective_epilepsy_surgery_2019_s) %>% 
  mutate(LOS = case_when(setting=="emergency" ~ 0, TRUE ~ LOS)) %>% 
  mutate(cost = ifelse(cost>0, cost, 0)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>%     
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  arrange(ENROLID, SVCDATE, setting, desc(LOS), desc(cost)) %>% 
  mutate(difference_between_healthcare_contacts = SVCDATE - lag(SVCDATE, 1)) %>% 
  collect()
```




Outpatient visits
```{r}
# Individual outpatient visits
outpatient_visit_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
outpatient_visit_resective_epilepsy_surgery_n 


# Individual patients with outpatient visits
patients_outpatient_visit_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_outpatient_visit_resective_epilepsy_surgery_n 


# Tally of patients with more than one outpatient visit
tally_outpatient_visit_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  group_by(ENROLID) %>% 
  tally(name="number_outpatient_visits")  %>% 
  group_by(number_outpatient_visits) %>% 
  tally(name="number_patients")
tally_outpatient_visit_resective_epilepsy_surgery




# Outpatient visits per patient before and after surgery
utilization_resective_epilepsy_surgery_outpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="outpatient") %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(outpatient_date = SVCDATE)

outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_resective_epilepsy_surgery_outpatient, by="ENROLID") %>%
  select(ENROLID, outpatient_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_visits_surgery_minus_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(69))) & (outpatient_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    outpatient_visits_surgery_0_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(9))) & (outpatient_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),     
    outpatient_visits_surgery_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(3))) & (outpatient_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 
   

# Outpatient visits per person-year by year
outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    outpatient_visits_per_person_year_surgery_minus_1_5 = outpatient_visits_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    outpatient_visits_per_person_year_surgery_0_1_5 = outpatient_visits_surgery_0_1_5 / person_years_surgery_0_1_5,
    outpatient_visits_per_person_year_surgery_1_5 = outpatient_visits_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5, na.rm=TRUE)


# Statistical test
Wilcoxon_test_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5)
Wilcoxon_test_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5




# Outpatient visits per patient by year in relationship to surgery
utilization_resective_epilepsy_surgery_outpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="outpatient") %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(outpatient_date = SVCDATE)

outpatient_visits_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_resective_epilepsy_surgery_outpatient, by="ENROLID") %>%
  select(ENROLID, outpatient_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_visits_surgery_minus_10 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(129))) & (outpatient_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_9 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(117))) & (outpatient_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    outpatient_visits_surgery_minus_8 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(105))) & (outpatient_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),  
    outpatient_visits_surgery_minus_7 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(93))) & (outpatient_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_6 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(81))) & (outpatient_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(69))) & (outpatient_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_4 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(57))) & (outpatient_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_3 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(45))) & (outpatient_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_2 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(33))) & (outpatient_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_1 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(21))) & (outpatient_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_0 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(9))) & (outpatient_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      outpatient_visits_surgery_1 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(3))) & (outpatient_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_2 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(15))) & (outpatient_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_3 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(27))) & (outpatient_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_4 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(39))) & (outpatient_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(51))) & (outpatient_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_6 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(63))) & (outpatient_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_7 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(75))) & (outpatient_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_8 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(87))) & (outpatient_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_9 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(99))) & (outpatient_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE), 
    outpatient_visits_surgery_10 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(111))) & (outpatient_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_visits_by_year_per_patient_resective_epilepsy_surgery  
   

# Outpatient visits per person-year by year
outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(outpatient_visits_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    outpatient_visits_per_person_year_surgery_minus_10 = outpatient_visits_surgery_minus_10 / person_years_surgery_minus_10,
    outpatient_visits_per_person_year_surgery_minus_9 = outpatient_visits_surgery_minus_9 / person_years_surgery_minus_9,
    outpatient_visits_per_person_year_surgery_minus_8 = outpatient_visits_surgery_minus_8 / person_years_surgery_minus_8,
    outpatient_visits_per_person_year_surgery_minus_7 = outpatient_visits_surgery_minus_7 / person_years_surgery_minus_7,
    outpatient_visits_per_person_year_surgery_minus_6 = outpatient_visits_surgery_minus_6 / person_years_surgery_minus_6,
    outpatient_visits_per_person_year_surgery_minus_5 = outpatient_visits_surgery_minus_5 / person_years_surgery_minus_5,
    outpatient_visits_per_person_year_surgery_minus_4 = outpatient_visits_surgery_minus_4 / person_years_surgery_minus_4,
    outpatient_visits_per_person_year_surgery_minus_3 = outpatient_visits_surgery_minus_3 / person_years_surgery_minus_3,
    outpatient_visits_per_person_year_surgery_minus_2 = outpatient_visits_surgery_minus_2 / person_years_surgery_minus_2,
    outpatient_visits_per_person_year_surgery_minus_1 = outpatient_visits_surgery_minus_1 / person_years_surgery_minus_1,
    outpatient_visits_per_person_year_surgery_0 = outpatient_visits_surgery_0 / person_years_surgery_0,
    outpatient_visits_per_person_year_surgery_1 = outpatient_visits_surgery_1 / person_years_surgery_1,
    outpatient_visits_per_person_year_surgery_2 = outpatient_visits_surgery_2 / person_years_surgery_2,
    outpatient_visits_per_person_year_surgery_3 = outpatient_visits_surgery_3 / person_years_surgery_3,
    outpatient_visits_per_person_year_surgery_4 = outpatient_visits_surgery_4 / person_years_surgery_4,
    outpatient_visits_per_person_year_surgery_5 = outpatient_visits_surgery_5 / person_years_surgery_5,
    outpatient_visits_per_person_year_surgery_6 = outpatient_visits_surgery_6 / person_years_surgery_6,
    outpatient_visits_per_person_year_surgery_7 = outpatient_visits_surgery_7 / person_years_surgery_7,
    outpatient_visits_per_person_year_surgery_8 = outpatient_visits_surgery_8 / person_years_surgery_8,
    outpatient_visits_per_person_year_surgery_9 = outpatient_visits_surgery_9 / person_years_surgery_9,
    outpatient_visits_per_person_year_surgery_10 = outpatient_visits_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_0, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_0, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_1, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_1, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_2, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_2, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_3, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_3, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_4, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_4, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_5, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_5, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_6, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_6, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_7, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_7, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_8, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_8, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_9, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_9, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_10, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_10, na.rm=TRUE)
```




Emergency department visits
```{r}
# Individual emergency department visits
ED_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
ED_resective_epilepsy_surgery_n 


# Individual patients with ED visits
patients_ED_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_ED_resective_epilepsy_surgery_n 


# Tally of patients with more than one ED visit
tally_ED_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  group_by(ENROLID) %>% 
  tally(name="number_ED_visits")  %>% 
  group_by(number_ED_visits) %>% 
  tally(name="number_patients")
tally_ED_resective_epilepsy_surgery




# Emergency visits per patient by year in relationship to surgery before and after surgery
utilization_resective_epilepsy_surgery_emergency <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="emergency") %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(ED_date = SVCDATE)

ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 <-
  resective_epilepsy_surgery_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_resective_epilepsy_surgery_emergency, by="ENROLID") %>%
  select(ENROLID, ED_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_visits_surgery_minus_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(69))) & (ED_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    ED_visits_surgery_0_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(9))) & (ED_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE), 
    ED_visits_surgery_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(3))) & (ED_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5  
   

# ED visits per person-year by year before and after surgery
ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    ED_visits_per_person_year_surgery_minus_1_5 = ED_visits_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    ED_visits_per_person_year_surgery_0_1_5 = ED_visits_surgery_0_1_5 / person_years_surgery_0_1_5,
    ED_visits_per_person_year_surgery_1_5 = ED_visits_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_ED_visits_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5)
Wilcoxon_test_ED_visits_per_person_year_resective_epilepsy_surgery_1_5




# Emergency visits per patient by year in relationship to surgery
utilization_resective_epilepsy_surgery_emergency <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="emergency") %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(ED_date = SVCDATE)

ED_visits_by_year_per_patient_resective_epilepsy_surgery <-
  resective_epilepsy_surgery_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_resective_epilepsy_surgery_emergency, by="ENROLID") %>%
  select(ENROLID, ED_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_visits_surgery_minus_10 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(129))) & (ED_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_9 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(117))) & (ED_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    ED_visits_surgery_minus_8 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(105))) & (ED_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_7 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(93))) & (ED_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_6 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(81))) & (ED_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(69))) & (ED_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_4 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(57))) & (ED_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_3 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(45))) & (ED_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_2 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(33))) & (ED_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_1 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(21))) & (ED_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_0 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(9))) & (ED_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      ED_visits_surgery_1 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(3))) & (ED_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     ED_visits_surgery_2 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(15))) & (ED_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     ED_visits_surgery_3 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(27))) & (ED_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_4 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(39))) & (ED_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     ED_visits_surgery_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(51))) & (ED_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_6 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(63))) & (ED_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     ED_visits_surgery_7 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(75))) & (ED_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     ED_visits_surgery_8 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(87))) & (ED_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     ED_visits_surgery_9 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(99))) & (ED_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_10 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(111))) & (ED_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_visits_by_year_per_patient_resective_epilepsy_surgery  
   

# ED visits per person-year by year
ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(ED_visits_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    ED_visits_per_person_year_surgery_minus_10 = ED_visits_surgery_minus_10 / person_years_surgery_minus_10,
    ED_visits_per_person_year_surgery_minus_9 = ED_visits_surgery_minus_9 / person_years_surgery_minus_9,
    ED_visits_per_person_year_surgery_minus_8 = ED_visits_surgery_minus_8 / person_years_surgery_minus_8,
    ED_visits_per_person_year_surgery_minus_7 = ED_visits_surgery_minus_7 / person_years_surgery_minus_7,
    ED_visits_per_person_year_surgery_minus_6 = ED_visits_surgery_minus_6 / person_years_surgery_minus_6,
    ED_visits_per_person_year_surgery_minus_5 = ED_visits_surgery_minus_5 / person_years_surgery_minus_5,
    ED_visits_per_person_year_surgery_minus_4 = ED_visits_surgery_minus_4 / person_years_surgery_minus_4,
    ED_visits_per_person_year_surgery_minus_3 = ED_visits_surgery_minus_3 / person_years_surgery_minus_3,
    ED_visits_per_person_year_surgery_minus_2 = ED_visits_surgery_minus_2 / person_years_surgery_minus_2,
    ED_visits_per_person_year_surgery_minus_1 = ED_visits_surgery_minus_1 / person_years_surgery_minus_1,
    ED_visits_per_person_year_surgery_0 = ED_visits_surgery_0 / person_years_surgery_0,
    ED_visits_per_person_year_surgery_1 = ED_visits_surgery_1 / person_years_surgery_1,
    ED_visits_per_person_year_surgery_2 = ED_visits_surgery_2 / person_years_surgery_2,
    ED_visits_per_person_year_surgery_3 = ED_visits_surgery_3 / person_years_surgery_3,
    ED_visits_per_person_year_surgery_4 = ED_visits_surgery_4 / person_years_surgery_4,
    ED_visits_per_person_year_surgery_5 = ED_visits_surgery_5 / person_years_surgery_5,
    ED_visits_per_person_year_surgery_6 = ED_visits_surgery_6 / person_years_surgery_6,
    ED_visits_per_person_year_surgery_7 = ED_visits_surgery_7 / person_years_surgery_7,
    ED_visits_per_person_year_surgery_8 = ED_visits_surgery_8 / person_years_surgery_8,
    ED_visits_per_person_year_surgery_9 = ED_visits_surgery_9 / person_years_surgery_9,
    ED_visits_per_person_year_surgery_10 = ED_visits_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_0, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_0, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_1, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_1, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_2, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_2, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_3, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_3, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_4, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_4, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_5, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_5, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_6, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_6, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_7, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_7, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_8, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_8, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_9, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_9, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_10, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_10, na.rm=TRUE)
```




Hospital admissions
```{r}
# Individual hospital admissions
hospital_admission_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
hospital_admission_resective_epilepsy_surgery_n 


# Individual patients with hospital admissions
patients_hospital_admission_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_hospital_admission_resective_epilepsy_surgery_n 


# Tally of patients with more than one hospital admission
tally_hospital_admission_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  group_by(ENROLID) %>% 
  tally(name="number_hospital_admissions")  %>% 
  group_by(number_hospital_admissions) %>% 
  tally(name="number_hospital_admissions")
tally_hospital_admission_resective_epilepsy_surgery




# Hospital admissions per patient before and after surgery
utilization_resective_epilepsy_surgery_inpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(hospital_admission_date = SVCDATE)

hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_resective_epilepsy_surgery_inpatient, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    hospital_admissions_surgery_minus_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    hospital_admissions_surgery_0_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Hospital admissions per person-year by year
hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    hospital_admissions_per_person_year_surgery_minus_1_5 = hospital_admissions_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    hospital_admissions_per_person_year_surgery_0_1_5 = hospital_admissions_surgery_0_1_5 / person_years_surgery_0_1_5,
    hospital_admissions_per_person_year_surgery_1_5 = hospital_admissions_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5)
Wilcoxon_test_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5




# Hospital admissions per patient by year in relationship to surgery
utilization_resective_epilepsy_surgery_inpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(hospital_admission_date = SVCDATE)

hospital_admissions_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_resective_epilepsy_surgery_inpatient, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    hospital_admissions_surgery_minus_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(129))) & (hospital_admission_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(117))) & (hospital_admission_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    hospital_admissions_surgery_minus_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(105))) & (hospital_admission_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),  
    hospital_admissions_surgery_minus_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(93))) & (hospital_admission_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(81))) & (hospital_admission_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(57))) & (hospital_admission_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(45))) & (hospital_admission_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(33))) & (hospital_admission_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(21))) & (hospital_admission_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_0 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      hospital_admissions_surgery_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(15))) & (hospital_admission_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(27))) & (hospital_admission_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(39))) & (hospital_admission_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(51))) & (hospital_admission_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(63))) & (hospital_admission_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(75))) & (hospital_admission_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(87))) & (hospital_admission_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(99))) & (hospital_admission_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE), 
    hospital_admissions_surgery_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(111))) & (hospital_admission_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
hospital_admissions_by_year_per_patient_resective_epilepsy_surgery  
   

# Hospital admissions per person-year by year
hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(hospital_admissions_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    hospital_admissions_per_person_year_surgery_minus_10 = hospital_admissions_surgery_minus_10 / person_years_surgery_minus_10,
    hospital_admissions_per_person_year_surgery_minus_9 = hospital_admissions_surgery_minus_9 / person_years_surgery_minus_9,
    hospital_admissions_per_person_year_surgery_minus_8 = hospital_admissions_surgery_minus_8 / person_years_surgery_minus_8,
    hospital_admissions_per_person_year_surgery_minus_7 = hospital_admissions_surgery_minus_7 / person_years_surgery_minus_7,
    hospital_admissions_per_person_year_surgery_minus_6 = hospital_admissions_surgery_minus_6 / person_years_surgery_minus_6,
    hospital_admissions_per_person_year_surgery_minus_5 = hospital_admissions_surgery_minus_5 / person_years_surgery_minus_5,
    hospital_admissions_per_person_year_surgery_minus_4 = hospital_admissions_surgery_minus_4 / person_years_surgery_minus_4,
    hospital_admissions_per_person_year_surgery_minus_3 = hospital_admissions_surgery_minus_3 / person_years_surgery_minus_3,
    hospital_admissions_per_person_year_surgery_minus_2 = hospital_admissions_surgery_minus_2 / person_years_surgery_minus_2,
    hospital_admissions_per_person_year_surgery_minus_1 = hospital_admissions_surgery_minus_1 / person_years_surgery_minus_1,
    hospital_admissions_per_person_year_surgery_0 = hospital_admissions_surgery_0 / person_years_surgery_0,
    hospital_admissions_per_person_year_surgery_1 = hospital_admissions_surgery_1 / person_years_surgery_1,
    hospital_admissions_per_person_year_surgery_2 = hospital_admissions_surgery_2 / person_years_surgery_2,
    hospital_admissions_per_person_year_surgery_3 = hospital_admissions_surgery_3 / person_years_surgery_3,
    hospital_admissions_per_person_year_surgery_4 = hospital_admissions_surgery_4 / person_years_surgery_4,
    hospital_admissions_per_person_year_surgery_5 = hospital_admissions_surgery_5 / person_years_surgery_5,
    hospital_admissions_per_person_year_surgery_6 = hospital_admissions_surgery_6 / person_years_surgery_6,
    hospital_admissions_per_person_year_surgery_7 = hospital_admissions_surgery_7 / person_years_surgery_7,
    hospital_admissions_per_person_year_surgery_8 = hospital_admissions_surgery_8 / person_years_surgery_8,
    hospital_admissions_per_person_year_surgery_9 = hospital_admissions_surgery_9 / person_years_surgery_9,
    hospital_admissions_per_person_year_surgery_10 = hospital_admissions_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_0, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_0, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_1, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_1, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_2, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_2, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_3, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_3, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_4, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_4, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_5, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_5, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_6, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_6, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_7, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_7, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_8, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_8, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_9, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_9, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_10, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_10, na.rm=TRUE)
```




Length of stay in hospital admissions for resective epilepsy surgery
```{r}
# Length of hospital stay in patients with resective epilepsy surgery
LOS_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  ungroup() %>% 
  summarize(total_LOS = sum(LOS))
LOS_resective_epilepsy_surgery




# Length of hospital stay per patient before and after surgery
utilization_resective_epilepsy_surgery_LOS <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  select(ENROLID, SVCDATE, LOS) %>% 
  rename(hospital_admission_date = SVCDATE)

LOS_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_resective_epilepsy_surgery_LOS, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date, LOS) %>%
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    LOS_surgery_minus_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(9)))), LOS, 0), na.rm=TRUE)/5,
    LOS_surgery_0_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(63)))), LOS, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
LOS_by_year_per_patient_resective_epilepsy_surgery_1_5  
   

# Length of stay per person-year by year before and after surgery
LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(LOS_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    LOS_per_person_year_surgery_minus_1_5 = LOS_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    LOS_per_person_year_surgery_0_1_5 = LOS_surgery_0_1_5 / person_years_surgery_0_1_5,
    LOS_per_person_year_surgery_1_5 = LOS_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_LOS_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5)
Wilcoxon_test_LOS_per_person_year_resective_epilepsy_surgery_1_5




# LOS per patient by year in relationship to surgery
utilization_resective_epilepsy_surgery_LOS <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  select(ENROLID, SVCDATE, LOS) %>% 
  rename(hospital_admission_date = SVCDATE)

LOS_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_resective_epilepsy_surgery_LOS, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date, LOS) %>%
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    LOS_surgery_minus_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(129))) & (hospital_admission_date < (surgery_date - months(117)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(117))) & (hospital_admission_date < (surgery_date - months(105)))), LOS, 0), na.rm=TRUE), 
    LOS_surgery_minus_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(105))) & (hospital_admission_date < (surgery_date - months(93)))), LOS, 0), na.rm=TRUE),  
    LOS_surgery_minus_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(93))) & (hospital_admission_date < (surgery_date - months(81)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(81))) & (hospital_admission_date < (surgery_date - months(69)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(57)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(57))) & (hospital_admission_date < (surgery_date - months(45)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(45))) & (hospital_admission_date < (surgery_date - months(33)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(33))) & (hospital_admission_date < (surgery_date - months(21)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(21))) & (hospital_admission_date < (surgery_date - months(9)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_0 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), LOS, 0), na.rm=TRUE),      LOS_surgery_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(15)))), LOS, 0), na.rm=TRUE),     LOS_surgery_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(15))) & (hospital_admission_date < (surgery_date + months(27)))), LOS, 0), na.rm=TRUE),     LOS_surgery_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(27))) & (hospital_admission_date < (surgery_date + months(39)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(39))) & (hospital_admission_date < (surgery_date + months(51)))), LOS, 0), na.rm=TRUE),     LOS_surgery_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(51))) & (hospital_admission_date < (surgery_date + months(63)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(63))) & (hospital_admission_date < (surgery_date + months(75)))), LOS, 0), na.rm=TRUE),     LOS_surgery_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(75))) & (hospital_admission_date < (surgery_date + months(87)))), LOS, 0), na.rm=TRUE),     LOS_surgery_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(87))) & (hospital_admission_date < (surgery_date + months(99)))), LOS, 0), na.rm=TRUE),     LOS_surgery_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(99))) & (hospital_admission_date < (surgery_date + months(111)))), LOS, 0), na.rm=TRUE), 
    LOS_surgery_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(111))) & (hospital_admission_date < (surgery_date + months(123)))), LOS, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
LOS_by_year_per_patient_resective_epilepsy_surgery  
   

# Length of stay per person-year by year
LOS_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(LOS_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    LOS_per_person_year_surgery_minus_10 = LOS_surgery_minus_10 / person_years_surgery_minus_10,
    LOS_per_person_year_surgery_minus_9 = LOS_surgery_minus_9 / person_years_surgery_minus_9,
    LOS_per_person_year_surgery_minus_8 = LOS_surgery_minus_8 / person_years_surgery_minus_8,
    LOS_per_person_year_surgery_minus_7 = LOS_surgery_minus_7 / person_years_surgery_minus_7,
    LOS_per_person_year_surgery_minus_6 = LOS_surgery_minus_6 / person_years_surgery_minus_6,
    LOS_per_person_year_surgery_minus_5 = LOS_surgery_minus_5 / person_years_surgery_minus_5,
    LOS_per_person_year_surgery_minus_4 = LOS_surgery_minus_4 / person_years_surgery_minus_4,
    LOS_per_person_year_surgery_minus_3 = LOS_surgery_minus_3 / person_years_surgery_minus_3,
    LOS_per_person_year_surgery_minus_2 = LOS_surgery_minus_2 / person_years_surgery_minus_2,
    LOS_per_person_year_surgery_minus_1 = LOS_surgery_minus_1 / person_years_surgery_minus_1,
    LOS_per_person_year_surgery_0 = LOS_surgery_0 / person_years_surgery_0,
    LOS_per_person_year_surgery_1 = LOS_surgery_1 / person_years_surgery_1,
    LOS_per_person_year_surgery_2 = LOS_surgery_2 / person_years_surgery_2,
    LOS_per_person_year_surgery_3 = LOS_surgery_3 / person_years_surgery_3,
    LOS_per_person_year_surgery_4 = LOS_surgery_4 / person_years_surgery_4,
    LOS_per_person_year_surgery_5 = LOS_surgery_5 / person_years_surgery_5,
    LOS_per_person_year_surgery_6 = LOS_surgery_6 / person_years_surgery_6,
    LOS_per_person_year_surgery_7 = LOS_surgery_7 / person_years_surgery_7,
    LOS_per_person_year_surgery_8 = LOS_surgery_8 / person_years_surgery_8,
    LOS_per_person_year_surgery_9 = LOS_surgery_9 / person_years_surgery_9,
    LOS_per_person_year_surgery_10 = LOS_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_0, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_0, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_1, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_1, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_2, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_2, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_3, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_3, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_4, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_4, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_5, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_5, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_6, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_6, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_7, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_7, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_8, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_8, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_9, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_9, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_10, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_10, na.rm=TRUE)
```




Cost adjustment for inflation
```{r}
# Inflation calculations (https://apps.bea.gov/iTable/iTable.cfm?reqid=19&step=2#reqid=19&step=2&isuri=1&1921=survey last accessed 12/30/2021)
# https://meps.ahrq.gov/about_meps/Price_Index.shtml
inflation_2006_Q1 <- 0.89204
inflation_2006_Q2 <- 0.89993	
inflation_2006_Q3 <- 0.90652	
inflation_2006_Q4 <- 0.90997	
inflation_2007_Q1 <- 0.91908
inflation_2007_Q2 <- 0.92491	
inflation_2007_Q3 <- 0.92882	
inflation_2007_Q4 <- 0.93332	
inflation_2008_Q1 <- 0.93735
inflation_2008_Q2 <- 0.94075	
inflation_2008_Q3 <- 0.94804	
inflation_2008_Q4 <- 0.94975
inflation_2009_Q1 <- 0.95001
inflation_2009_Q2 <- 0.94870	
inflation_2009_Q3 <- 0.94928	
inflation_2009_Q4 <- 0.95277			
inflation_2010_Q1 <- 0.95518
inflation_2010_Q2 <- 0.95963	
inflation_2010_Q3 <- 0.96312	
inflation_2010_Q4 <- 0.96864				
inflation_2011_Q1 <- 0.97339
inflation_2011_Q2 <- 0.98042	
inflation_2011_Q3 <- 0.98561	
inflation_2011_Q4 <- 0.98687		
inflation_2012_Q1 <- 0.99277
inflation_2012_Q2 <- 0.99690	
inflation_2012_Q3 <- 1.00304
inflation_2012_Q4 <- 1.00730			
inflation_2013_Q1 <- 1.01124
inflation_2013_Q2 <- 1.01428	
inflation_2013_Q3 <- 1.01973
inflation_2013_Q4 <- 1.02550				
inflation_2014_Q1 <- 1.02965
inflation_2014_Q2 <- 1.03552	
inflation_2014_Q3 <- 1.04029
inflation_2014_Q4 <- 1.04104		
inflation_2015_Q1 <- 1.04092
inflation_2015_Q2 <- 1.04683	
inflation_2015_Q3 <- 1.04939
inflation_2015_Q4 <- 1.04932
inflation_2016_Q1 <- 1.04873
inflation_2016_Q2 <- 1.05576	
inflation_2016_Q3 <- 1.05894
inflation_2016_Q4 <- 1.06470				
inflation_2017_Q1 <- 1.07007
inflation_2017_Q2 <- 1.07361		
inflation_2017_Q3 <- 1.07942
inflation_2017_Q4 <- 1.08658						
inflation_2018_Q1 <- 1.09312
inflation_2018_Q2 <- 1.10156		
inflation_2018_Q3 <- 1.10647
inflation_2018_Q4 <- 1.11191		
inflation_2019_Q1 <- 1.11502
inflation_2019_Q2 <- 1.12142		
inflation_2019_Q3 <- 1.12524
inflation_2019_Q4 <- 1.12947			
inflation_2020_Q1 <- 1.13397
inflation_2020_Q2 <- 1.12969		
inflation_2020_Q3 <- 1.13984
inflation_2020_Q4 <- 1.14611					
				
			
# Cost adjusted for inflation (to Q4 2020 year)
inflation_adjusted_utilization_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>% 
  mutate(year_quarter = quarter(SVCDATE, with_year=TRUE)) %>%
  mutate(inflation_adjusted_cost = case_when(
  year_quarter == 2006.1 ~ cost*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ cost*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ cost*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ cost*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ cost*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ cost*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ cost*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ cost*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ cost*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ cost*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ cost*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ cost*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ cost*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ cost*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ cost*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ cost*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ cost*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ cost*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ cost*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ cost*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ cost*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ cost*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ cost*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ cost*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ cost*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ cost*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ cost*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ cost*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ cost*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ cost*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ cost*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ cost*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ cost*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ cost*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ cost*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ cost*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ cost*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ cost*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ cost*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ cost*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ cost*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ cost*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ cost*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ cost*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ cost*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ cost*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ cost*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ cost*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ cost*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ cost*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ cost*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ cost*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ cost*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ cost*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ cost*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ cost*(inflation_2020_Q4/inflation_2019_Q4))) %>% 
    collect()
```




Cost in patients with resective epilepsy surgery
```{r}
# Cost in patients with resective epilepsy surgery
cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
cost_resective_epilepsy_surgery




# Cost per patient before and after surgery
utilization_resective_epilepsy_surgery_total_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


total_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_resective_epilepsy_surgery_total_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    total_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    total_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
total_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Total cost per person-year by year before and after surgery
total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(total_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    total_cost_per_person_year_surgery_minus_1_5 = total_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    total_cost_per_person_year_surgery_0_1_5 = total_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    total_cost_per_person_year_surgery_1_5 = total_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5)
Wilcoxon_test_cost_per_person_year_resective_epilepsy_surgery_1_5




# Total cost per patient by year in relationship to surgery
utilization_resective_epilepsy_surgery_total_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


total_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_resective_epilepsy_surgery_total_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    total_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    total_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    total_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      total_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    total_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
total_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Total cost per person-year by year
total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(total_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    total_cost_per_person_year_surgery_minus_10 = total_cost_surgery_minus_10 / person_years_surgery_minus_10,
    total_cost_per_person_year_surgery_minus_9 = total_cost_surgery_minus_9 / person_years_surgery_minus_9,
    total_cost_per_person_year_surgery_minus_8 = total_cost_surgery_minus_8 / person_years_surgery_minus_8,
    total_cost_per_person_year_surgery_minus_7 = total_cost_surgery_minus_7 / person_years_surgery_minus_7,
    total_cost_per_person_year_surgery_minus_6 = total_cost_surgery_minus_6 / person_years_surgery_minus_6,
    total_cost_per_person_year_surgery_minus_5 = total_cost_surgery_minus_5 / person_years_surgery_minus_5,
    total_cost_per_person_year_surgery_minus_4 = total_cost_surgery_minus_4 / person_years_surgery_minus_4,
    total_cost_per_person_year_surgery_minus_3 = total_cost_surgery_minus_3 / person_years_surgery_minus_3,
    total_cost_per_person_year_surgery_minus_2 = total_cost_surgery_minus_2 / person_years_surgery_minus_2,
    total_cost_per_person_year_surgery_minus_1 = total_cost_surgery_minus_1 / person_years_surgery_minus_1,
    total_cost_per_person_year_surgery_0 = total_cost_surgery_0 / person_years_surgery_0,
    total_cost_per_person_year_surgery_1 = total_cost_surgery_1 / person_years_surgery_1,
    total_cost_per_person_year_surgery_2 = total_cost_surgery_2 / person_years_surgery_2,
    total_cost_per_person_year_surgery_3 = total_cost_surgery_3 / person_years_surgery_3,
    total_cost_per_person_year_surgery_4 = total_cost_surgery_4 / person_years_surgery_4,
    total_cost_per_person_year_surgery_5 = total_cost_surgery_5 / person_years_surgery_5,
    total_cost_per_person_year_surgery_6 = total_cost_surgery_6 / person_years_surgery_6,
    total_cost_per_person_year_surgery_7 = total_cost_surgery_7 / person_years_surgery_7,
    total_cost_per_person_year_surgery_8 = total_cost_surgery_8 / person_years_surgery_8,
    total_cost_per_person_year_surgery_9 = total_cost_surgery_9 / person_years_surgery_9,
    total_cost_per_person_year_surgery_10 = total_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Total cost figure in patients with resective epilepsy surgery
```{r}
# Total cost figure
data_figure_total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- tibble(
  "year" = factor(c("Year -5", "Year -4", "Year -3", "Year -2", "Year -1", "Year surgery", "Year +1", "Year +2", "Year +3", "Year +4", "Year +5"), levels=c("Year -5", "Year -4", "Year -3", "Year -2", "Year -1", "Year surgery", "Year +1", "Year +2", "Year +3", "Year +4", "Year +5")),
  "median_cost" = c(summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[3]),
  "p25_cost" = c(summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[2]),  
  "p75_cost" = c(summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[5])    
  )


figure_total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- ggplot(data=data_figure_total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery) + 
  geom_point(aes(x=year, y=median_cost), color="purple2", size=5) +
  geom_point(aes(x=year, y=p25_cost), color="darkgreen", size=4) +
  geom_point(aes(x=year, y=p75_cost), color="darkgreen", size=4) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=22, face="bold")) +
  scale_x_discrete(name="Year") +
  scale_y_continuous(name="Cost ($) per person-year", breaks=seq(0, 250000, 50000), limits = c(0, 250000))
figure_total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery
ggplotly(figure_total_cost_by_year_per_person_year_individually_resective_epilepsy_surgery)
```




Outpatient cost in patients with resective epilepsy surgery
```{r}
# Outpatient cost in patients with resective epilepsy surgery
outpatient_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(setting=="outpatient") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
outpatient_cost_resective_epilepsy_surgery




# Outpatient cost per patient before and after surgery
utilization_resective_epilepsy_surgery_outpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


outpatient_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_resective_epilepsy_surgery_outpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    outpatient_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Outpatient cost per person-year by year before and after surgery
outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(outpatient_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    outpatient_cost_per_person_year_surgery_minus_1_5 = outpatient_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    outpatient_cost_per_person_year_surgery_0_1_5 = outpatient_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    outpatient_cost_per_person_year_surgery_1_5 = outpatient_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_outpatient_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5)
Wilcoxon_test_outpatient_cost_per_person_year_resective_epilepsy_surgery_1_5




# Outpatient cost per patient by year in relationship to surgery
utilization_resective_epilepsy_surgery_outpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


outpatient_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_resective_epilepsy_surgery_outpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    outpatient_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    outpatient_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      outpatient_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    outpatient_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Outpatient cost per person-year by year
outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(outpatient_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    outpatient_cost_per_person_year_surgery_minus_10 = outpatient_cost_surgery_minus_10 / person_years_surgery_minus_10,
    outpatient_cost_per_person_year_surgery_minus_9 = outpatient_cost_surgery_minus_9 / person_years_surgery_minus_9,
    outpatient_cost_per_person_year_surgery_minus_8 = outpatient_cost_surgery_minus_8 / person_years_surgery_minus_8,
    outpatient_cost_per_person_year_surgery_minus_7 = outpatient_cost_surgery_minus_7 / person_years_surgery_minus_7,
    outpatient_cost_per_person_year_surgery_minus_6 = outpatient_cost_surgery_minus_6 / person_years_surgery_minus_6,
    outpatient_cost_per_person_year_surgery_minus_5 = outpatient_cost_surgery_minus_5 / person_years_surgery_minus_5,
    outpatient_cost_per_person_year_surgery_minus_4 = outpatient_cost_surgery_minus_4 / person_years_surgery_minus_4,
    outpatient_cost_per_person_year_surgery_minus_3 = outpatient_cost_surgery_minus_3 / person_years_surgery_minus_3,
    outpatient_cost_per_person_year_surgery_minus_2 = outpatient_cost_surgery_minus_2 / person_years_surgery_minus_2,
    outpatient_cost_per_person_year_surgery_minus_1 = outpatient_cost_surgery_minus_1 / person_years_surgery_minus_1,
    outpatient_cost_per_person_year_surgery_0 = outpatient_cost_surgery_0 / person_years_surgery_0,
    outpatient_cost_per_person_year_surgery_1 = outpatient_cost_surgery_1 / person_years_surgery_1,
    outpatient_cost_per_person_year_surgery_2 = outpatient_cost_surgery_2 / person_years_surgery_2,
    outpatient_cost_per_person_year_surgery_3 = outpatient_cost_surgery_3 / person_years_surgery_3,
    outpatient_cost_per_person_year_surgery_4 = outpatient_cost_surgery_4 / person_years_surgery_4,
    outpatient_cost_per_person_year_surgery_5 = outpatient_cost_surgery_5 / person_years_surgery_5,
    outpatient_cost_per_person_year_surgery_6 = outpatient_cost_surgery_6 / person_years_surgery_6,
    outpatient_cost_per_person_year_surgery_7 = outpatient_cost_surgery_7 / person_years_surgery_7,
    outpatient_cost_per_person_year_surgery_8 = outpatient_cost_surgery_8 / person_years_surgery_8,
    outpatient_cost_per_person_year_surgery_9 = outpatient_cost_surgery_9 / person_years_surgery_9,
    outpatient_cost_per_person_year_surgery_10 = outpatient_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
```




ED cost in patients with resective epilepsy surgery
```{r}
# ED cost in patients with resective epilepsy surgery
ED_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(setting=="emergency") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
ED_cost_resective_epilepsy_surgery




# ED cost per patient before and after surgery
utilization_resective_epilepsy_surgery_ED_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


ED_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_resective_epilepsy_surgery_ED_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    ED_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# ED cost per person-year by year before and after surgery
ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(ED_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    ED_cost_per_person_year_surgery_minus_1_5 = ED_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    ED_cost_per_person_year_surgery_0_1_5 = ED_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    ED_cost_per_person_year_surgery_1_5 = ED_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_ED_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5)
Wilcoxon_test_ED_cost_per_person_year_resective_epilepsy_surgery_1_5




# ED cost per patient by year in relationship to surgery
utilization_resective_epilepsy_surgery_ED_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


ED_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_resective_epilepsy_surgery_ED_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    ED_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    ED_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      ED_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    ED_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# ED cost per person-year by year
ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(ED_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    ED_cost_per_person_year_surgery_minus_10 = ED_cost_surgery_minus_10 / person_years_surgery_minus_10,
    ED_cost_per_person_year_surgery_minus_9 = ED_cost_surgery_minus_9 / person_years_surgery_minus_9,
    ED_cost_per_person_year_surgery_minus_8 = ED_cost_surgery_minus_8 / person_years_surgery_minus_8,
    ED_cost_per_person_year_surgery_minus_7 = ED_cost_surgery_minus_7 / person_years_surgery_minus_7,
    ED_cost_per_person_year_surgery_minus_6 = ED_cost_surgery_minus_6 / person_years_surgery_minus_6,
    ED_cost_per_person_year_surgery_minus_5 = ED_cost_surgery_minus_5 / person_years_surgery_minus_5,
    ED_cost_per_person_year_surgery_minus_4 = ED_cost_surgery_minus_4 / person_years_surgery_minus_4,
    ED_cost_per_person_year_surgery_minus_3 = ED_cost_surgery_minus_3 / person_years_surgery_minus_3,
    ED_cost_per_person_year_surgery_minus_2 = ED_cost_surgery_minus_2 / person_years_surgery_minus_2,
    ED_cost_per_person_year_surgery_minus_1 = ED_cost_surgery_minus_1 / person_years_surgery_minus_1,
    ED_cost_per_person_year_surgery_0 = ED_cost_surgery_0 / person_years_surgery_0,
    ED_cost_per_person_year_surgery_1 = ED_cost_surgery_1 / person_years_surgery_1,
    ED_cost_per_person_year_surgery_2 = ED_cost_surgery_2 / person_years_surgery_2,
    ED_cost_per_person_year_surgery_3 = ED_cost_surgery_3 / person_years_surgery_3,
    ED_cost_per_person_year_surgery_4 = ED_cost_surgery_4 / person_years_surgery_4,
    ED_cost_per_person_year_surgery_5 = ED_cost_surgery_5 / person_years_surgery_5,
    ED_cost_per_person_year_surgery_6 = ED_cost_surgery_6 / person_years_surgery_6,
    ED_cost_per_person_year_surgery_7 = ED_cost_surgery_7 / person_years_surgery_7,
    ED_cost_per_person_year_surgery_8 = ED_cost_surgery_8 / person_years_surgery_8,
    ED_cost_per_person_year_surgery_9 = ED_cost_surgery_9 / person_years_surgery_9,
    ED_cost_per_person_year_surgery_10 = ED_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Inpatient cost in patients with resective epilepsy surgery
```{r}
# Inpatient cost in patients with resective epilepsy surgery
inpatient_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
inpatient_cost_resective_epilepsy_surgery




# Inpatient cost per patient before and after surgery
utilization_resective_epilepsy_surgery_inpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


inpatient_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_resective_epilepsy_surgery_inpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    inpatient_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    inpatient_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
inpatient_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Inpatient cost per person-year by year before and after surgery
inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(inpatient_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    inpatient_cost_per_person_year_surgery_minus_1_5 = inpatient_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    inpatient_cost_per_person_year_surgery_0_1_5 = inpatient_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    inpatient_cost_per_person_year_surgery_1_5 = inpatient_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_inpatient_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5)
Wilcoxon_test_inpatient_cost_per_person_year_resective_epilepsy_surgery_1_5




# Inpatient cost per patient by year in relationship to surgery
utilization_resective_epilepsy_surgery_inpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


inpatient_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_resective_epilepsy_surgery_inpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    inpatient_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    inpatient_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    inpatient_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      inpatient_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    inpatient_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
inpatient_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Inpatient cost per person-year by year
inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(inpatient_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    inpatient_cost_per_person_year_surgery_minus_10 = inpatient_cost_surgery_minus_10 / person_years_surgery_minus_10,
    inpatient_cost_per_person_year_surgery_minus_9 = inpatient_cost_surgery_minus_9 / person_years_surgery_minus_9,
    inpatient_cost_per_person_year_surgery_minus_8 = inpatient_cost_surgery_minus_8 / person_years_surgery_minus_8,
    inpatient_cost_per_person_year_surgery_minus_7 = inpatient_cost_surgery_minus_7 / person_years_surgery_minus_7,
    inpatient_cost_per_person_year_surgery_minus_6 = inpatient_cost_surgery_minus_6 / person_years_surgery_minus_6,
    inpatient_cost_per_person_year_surgery_minus_5 = inpatient_cost_surgery_minus_5 / person_years_surgery_minus_5,
    inpatient_cost_per_person_year_surgery_minus_4 = inpatient_cost_surgery_minus_4 / person_years_surgery_minus_4,
    inpatient_cost_per_person_year_surgery_minus_3 = inpatient_cost_surgery_minus_3 / person_years_surgery_minus_3,
    inpatient_cost_per_person_year_surgery_minus_2 = inpatient_cost_surgery_minus_2 / person_years_surgery_minus_2,
    inpatient_cost_per_person_year_surgery_minus_1 = inpatient_cost_surgery_minus_1 / person_years_surgery_minus_1,
    inpatient_cost_per_person_year_surgery_0 = inpatient_cost_surgery_0 / person_years_surgery_0,
    inpatient_cost_per_person_year_surgery_1 = inpatient_cost_surgery_1 / person_years_surgery_1,
    inpatient_cost_per_person_year_surgery_2 = inpatient_cost_surgery_2 / person_years_surgery_2,
    inpatient_cost_per_person_year_surgery_3 = inpatient_cost_surgery_3 / person_years_surgery_3,
    inpatient_cost_per_person_year_surgery_4 = inpatient_cost_surgery_4 / person_years_surgery_4,
    inpatient_cost_per_person_year_surgery_5 = inpatient_cost_surgery_5 / person_years_surgery_5,
    inpatient_cost_per_person_year_surgery_6 = inpatient_cost_surgery_6 / person_years_surgery_6,
    inpatient_cost_per_person_year_surgery_7 = inpatient_cost_surgery_7 / person_years_surgery_7,
    inpatient_cost_per_person_year_surgery_8 = inpatient_cost_surgery_8 / person_years_surgery_8,
    inpatient_cost_per_person_year_surgery_9 = inpatient_cost_surgery_9 / person_years_surgery_9,
    inpatient_cost_per_person_year_surgery_10 = inpatient_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
```








## 6. Clinical and economic outcomes in resective epilepsy surgery: Pediatric versus adult




Outpatient visits
```{r}
# Individual outpatient visits
pediatric_outpatient_visit_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
pediatric_outpatient_visit_resective_epilepsy_surgery_n 


# Individual patients with outpatient visits
patients_pediatric_outpatient_visit_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_pediatric_outpatient_visit_resective_epilepsy_surgery_n 


# Tally of patients with more than one outpatient visit
tally_pediatric_outpatient_visit_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  tally(name="number_outpatient_visits")  %>% 
  group_by(number_outpatient_visits) %>% 
  tally(name="number_patients")
tally_pediatric_outpatient_visit_resective_epilepsy_surgery




# Outpatient visits per patient before and after surgery
pediatric_utilization_resective_epilepsy_surgery_outpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(outpatient_date = SVCDATE)

pediatric_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(pediatric_utilization_resective_epilepsy_surgery_outpatient, by="ENROLID") %>%
  select(ENROLID, outpatient_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_visits_surgery_minus_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(69))) & (outpatient_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    outpatient_visits_surgery_0_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(9))) & (outpatient_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),     
    outpatient_visits_surgery_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(3))) & (outpatient_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
pediatric_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 
   

# Outpatient visits per person-year by year
pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(pediatric_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    outpatient_visits_per_person_year_surgery_minus_1_5 = outpatient_visits_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    outpatient_visits_per_person_year_surgery_0_1_5 = outpatient_visits_surgery_0_1_5 / person_years_surgery_0_1_5,
    outpatient_visits_per_person_year_surgery_1_5 = outpatient_visits_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5, na.rm=TRUE)


# Statistical test
Wilcoxon_test_pediatric_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5)
Wilcoxon_test_pediatric_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5




# Outpatient visits per patient by year in relationship to surgery
pediatric_utilization_resective_epilepsy_surgery_outpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(outpatient_date = SVCDATE)

pediatric_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(pediatric_utilization_resective_epilepsy_surgery_outpatient, by="ENROLID") %>%
  select(ENROLID, outpatient_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_visits_surgery_minus_10 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(129))) & (outpatient_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_9 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(117))) & (outpatient_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    outpatient_visits_surgery_minus_8 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(105))) & (outpatient_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),  
    outpatient_visits_surgery_minus_7 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(93))) & (outpatient_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_6 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(81))) & (outpatient_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(69))) & (outpatient_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_4 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(57))) & (outpatient_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_3 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(45))) & (outpatient_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_2 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(33))) & (outpatient_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_1 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(21))) & (outpatient_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_0 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(9))) & (outpatient_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      outpatient_visits_surgery_1 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(3))) & (outpatient_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_2 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(15))) & (outpatient_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_3 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(27))) & (outpatient_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_4 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(39))) & (outpatient_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(51))) & (outpatient_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_6 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(63))) & (outpatient_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_7 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(75))) & (outpatient_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_8 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(87))) & (outpatient_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_9 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(99))) & (outpatient_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE), 
    outpatient_visits_surgery_10 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(111))) & (outpatient_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
pediatric_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery  
   

# Outpatient visits per person-year by year
pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(pediatric_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    outpatient_visits_per_person_year_surgery_minus_10 = outpatient_visits_surgery_minus_10 / person_years_surgery_minus_10,
    outpatient_visits_per_person_year_surgery_minus_9 = outpatient_visits_surgery_minus_9 / person_years_surgery_minus_9,
    outpatient_visits_per_person_year_surgery_minus_8 = outpatient_visits_surgery_minus_8 / person_years_surgery_minus_8,
    outpatient_visits_per_person_year_surgery_minus_7 = outpatient_visits_surgery_minus_7 / person_years_surgery_minus_7,
    outpatient_visits_per_person_year_surgery_minus_6 = outpatient_visits_surgery_minus_6 / person_years_surgery_minus_6,
    outpatient_visits_per_person_year_surgery_minus_5 = outpatient_visits_surgery_minus_5 / person_years_surgery_minus_5,
    outpatient_visits_per_person_year_surgery_minus_4 = outpatient_visits_surgery_minus_4 / person_years_surgery_minus_4,
    outpatient_visits_per_person_year_surgery_minus_3 = outpatient_visits_surgery_minus_3 / person_years_surgery_minus_3,
    outpatient_visits_per_person_year_surgery_minus_2 = outpatient_visits_surgery_minus_2 / person_years_surgery_minus_2,
    outpatient_visits_per_person_year_surgery_minus_1 = outpatient_visits_surgery_minus_1 / person_years_surgery_minus_1,
    outpatient_visits_per_person_year_surgery_0 = outpatient_visits_surgery_0 / person_years_surgery_0,
    outpatient_visits_per_person_year_surgery_1 = outpatient_visits_surgery_1 / person_years_surgery_1,
    outpatient_visits_per_person_year_surgery_2 = outpatient_visits_surgery_2 / person_years_surgery_2,
    outpatient_visits_per_person_year_surgery_3 = outpatient_visits_surgery_3 / person_years_surgery_3,
    outpatient_visits_per_person_year_surgery_4 = outpatient_visits_surgery_4 / person_years_surgery_4,
    outpatient_visits_per_person_year_surgery_5 = outpatient_visits_surgery_5 / person_years_surgery_5,
    outpatient_visits_per_person_year_surgery_6 = outpatient_visits_surgery_6 / person_years_surgery_6,
    outpatient_visits_per_person_year_surgery_7 = outpatient_visits_surgery_7 / person_years_surgery_7,
    outpatient_visits_per_person_year_surgery_8 = outpatient_visits_surgery_8 / person_years_surgery_8,
    outpatient_visits_per_person_year_surgery_9 = outpatient_visits_surgery_9 / person_years_surgery_9,
    outpatient_visits_per_person_year_surgery_10 = outpatient_visits_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_0, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_0, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_1, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_1, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_2, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_2, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_3, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_3, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_4, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_4, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_5, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_5, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_6, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_6, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_7, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_7, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_8, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_8, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_9, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_9, na.rm=TRUE)

summary(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_10, na.rm=TRUE)
sd(pediatric_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_10, na.rm=TRUE)
```




Emergency department visits
```{r}
# Individual emergency department visits
pediatric_ED_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
pediatric_ED_resective_epilepsy_surgery_n 


# Individual patients with ED visits
patients_pediatric_ED_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_pediatric_ED_resective_epilepsy_surgery_n 


# Tally of patients with more than one ED visit
tally_pediatric_ED_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  tally(name="number_ED_visits")  %>% 
  group_by(number_ED_visits) %>% 
  tally(name="number_patients")
tally_pediatric_ED_resective_epilepsy_surgery




# Emergency visits per patient by year in relationship to surgery before and after surgery
pediatric_utilization_resective_epilepsy_surgery_emergency <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(ED_date = SVCDATE)

pediatric_ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 <-
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(pediatric_utilization_resective_epilepsy_surgery_emergency, by="ENROLID") %>%
  select(ENROLID, ED_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_visits_surgery_minus_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(69))) & (ED_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    ED_visits_surgery_0_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(9))) & (ED_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE), 
    ED_visits_surgery_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(3))) & (ED_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
pediatric_ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5  
   

# ED visits per person-year by year before and after surgery
pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(pediatric_ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    ED_visits_per_person_year_surgery_minus_1_5 = ED_visits_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    ED_visits_per_person_year_surgery_0_1_5 = ED_visits_surgery_0_1_5 / person_years_surgery_0_1_5,
    ED_visits_per_person_year_surgery_1_5 = ED_visits_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_pediatric_ED_visits_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5)
Wilcoxon_test_pediatric_ED_visits_per_person_year_resective_epilepsy_surgery_1_5




# Emergency visits per patient by year in relationship to surgery
pediatric_utilization_resective_epilepsy_surgery_emergency <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(ED_date = SVCDATE)

pediatric_ED_visits_by_year_per_patient_resective_epilepsy_surgery <-
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(pediatric_utilization_resective_epilepsy_surgery_emergency, by="ENROLID") %>%
  select(ENROLID, ED_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_visits_surgery_minus_10 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(129))) & (ED_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_9 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(117))) & (ED_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    ED_visits_surgery_minus_8 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(105))) & (ED_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_7 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(93))) & (ED_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_6 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(81))) & (ED_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(69))) & (ED_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_4 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(57))) & (ED_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_3 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(45))) & (ED_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_2 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(33))) & (ED_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_1 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(21))) & (ED_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_0 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(9))) & (ED_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      ED_visits_surgery_1 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(3))) & (ED_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     ED_visits_surgery_2 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(15))) & (ED_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     ED_visits_surgery_3 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(27))) & (ED_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_4 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(39))) & (ED_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     ED_visits_surgery_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(51))) & (ED_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_6 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(63))) & (ED_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     ED_visits_surgery_7 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(75))) & (ED_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     ED_visits_surgery_8 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(87))) & (ED_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     ED_visits_surgery_9 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(99))) & (ED_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_10 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(111))) & (ED_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
pediatric_ED_visits_by_year_per_patient_resective_epilepsy_surgery  
   

# ED visits per person-year by year
pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(pediatric_ED_visits_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    ED_visits_per_person_year_surgery_minus_10 = ED_visits_surgery_minus_10 / person_years_surgery_minus_10,
    ED_visits_per_person_year_surgery_minus_9 = ED_visits_surgery_minus_9 / person_years_surgery_minus_9,
    ED_visits_per_person_year_surgery_minus_8 = ED_visits_surgery_minus_8 / person_years_surgery_minus_8,
    ED_visits_per_person_year_surgery_minus_7 = ED_visits_surgery_minus_7 / person_years_surgery_minus_7,
    ED_visits_per_person_year_surgery_minus_6 = ED_visits_surgery_minus_6 / person_years_surgery_minus_6,
    ED_visits_per_person_year_surgery_minus_5 = ED_visits_surgery_minus_5 / person_years_surgery_minus_5,
    ED_visits_per_person_year_surgery_minus_4 = ED_visits_surgery_minus_4 / person_years_surgery_minus_4,
    ED_visits_per_person_year_surgery_minus_3 = ED_visits_surgery_minus_3 / person_years_surgery_minus_3,
    ED_visits_per_person_year_surgery_minus_2 = ED_visits_surgery_minus_2 / person_years_surgery_minus_2,
    ED_visits_per_person_year_surgery_minus_1 = ED_visits_surgery_minus_1 / person_years_surgery_minus_1,
    ED_visits_per_person_year_surgery_0 = ED_visits_surgery_0 / person_years_surgery_0,
    ED_visits_per_person_year_surgery_1 = ED_visits_surgery_1 / person_years_surgery_1,
    ED_visits_per_person_year_surgery_2 = ED_visits_surgery_2 / person_years_surgery_2,
    ED_visits_per_person_year_surgery_3 = ED_visits_surgery_3 / person_years_surgery_3,
    ED_visits_per_person_year_surgery_4 = ED_visits_surgery_4 / person_years_surgery_4,
    ED_visits_per_person_year_surgery_5 = ED_visits_surgery_5 / person_years_surgery_5,
    ED_visits_per_person_year_surgery_6 = ED_visits_surgery_6 / person_years_surgery_6,
    ED_visits_per_person_year_surgery_7 = ED_visits_surgery_7 / person_years_surgery_7,
    ED_visits_per_person_year_surgery_8 = ED_visits_surgery_8 / person_years_surgery_8,
    ED_visits_per_person_year_surgery_9 = ED_visits_surgery_9 / person_years_surgery_9,
    ED_visits_per_person_year_surgery_10 = ED_visits_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_0, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_0, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_1, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_1, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_2, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_2, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_3, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_3, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_4, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_4, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_5, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_5, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_6, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_6, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_7, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_7, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_8, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_8, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_9, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_9, na.rm=TRUE)

summary(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_10, na.rm=TRUE)
sd(pediatric_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_10, na.rm=TRUE)
```




Hospital admissions
```{r}
# Individual hospital admissions
pediatric_hospital_admission_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
pediatric_hospital_admission_resective_epilepsy_surgery_n 


# Individual patients with hospital admissions
patients_pediatric_hospital_admission_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_pediatric_hospital_admission_resective_epilepsy_surgery_n 


# Tally of patients with more than one hospital admission
tally_pediatric_hospital_admission_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  tally(name="number_hospital_admissions")  %>% 
  group_by(number_hospital_admissions) %>% 
  tally(name="number_hospital_admissions")
tally_pediatric_hospital_admission_resective_epilepsy_surgery




# Hospital admissions per patient before and after surgery
pediatric_utilization_resective_epilepsy_surgery_inpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(hospital_admission_date = SVCDATE)

pediatric_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(pediatric_utilization_resective_epilepsy_surgery_inpatient, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    hospital_admissions_surgery_minus_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    hospital_admissions_surgery_0_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
pediatric_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Hospital admissions per person-year by year
pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(pediatric_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    hospital_admissions_per_person_year_surgery_minus_1_5 = hospital_admissions_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    hospital_admissions_per_person_year_surgery_0_1_5 = hospital_admissions_surgery_0_1_5 / person_years_surgery_0_1_5,
    hospital_admissions_per_person_year_surgery_1_5 = hospital_admissions_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_pediatric_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5)
Wilcoxon_test_pediatric_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5




# Hospital admissions per patient by year in relationship to surgery
pediatric_utilization_resective_epilepsy_surgery_inpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(hospital_admission_date = SVCDATE)

pediatric_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(pediatric_utilization_resective_epilepsy_surgery_inpatient, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    hospital_admissions_surgery_minus_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(129))) & (hospital_admission_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(117))) & (hospital_admission_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    hospital_admissions_surgery_minus_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(105))) & (hospital_admission_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),  
    hospital_admissions_surgery_minus_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(93))) & (hospital_admission_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(81))) & (hospital_admission_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(57))) & (hospital_admission_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(45))) & (hospital_admission_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(33))) & (hospital_admission_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(21))) & (hospital_admission_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_0 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      hospital_admissions_surgery_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(15))) & (hospital_admission_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(27))) & (hospital_admission_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(39))) & (hospital_admission_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(51))) & (hospital_admission_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(63))) & (hospital_admission_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(75))) & (hospital_admission_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(87))) & (hospital_admission_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(99))) & (hospital_admission_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE), 
    hospital_admissions_surgery_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(111))) & (hospital_admission_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
pediatric_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery  
   

# Hospital admissions per person-year by year
pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(pediatric_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    hospital_admissions_per_person_year_surgery_minus_10 = hospital_admissions_surgery_minus_10 / person_years_surgery_minus_10,
    hospital_admissions_per_person_year_surgery_minus_9 = hospital_admissions_surgery_minus_9 / person_years_surgery_minus_9,
    hospital_admissions_per_person_year_surgery_minus_8 = hospital_admissions_surgery_minus_8 / person_years_surgery_minus_8,
    hospital_admissions_per_person_year_surgery_minus_7 = hospital_admissions_surgery_minus_7 / person_years_surgery_minus_7,
    hospital_admissions_per_person_year_surgery_minus_6 = hospital_admissions_surgery_minus_6 / person_years_surgery_minus_6,
    hospital_admissions_per_person_year_surgery_minus_5 = hospital_admissions_surgery_minus_5 / person_years_surgery_minus_5,
    hospital_admissions_per_person_year_surgery_minus_4 = hospital_admissions_surgery_minus_4 / person_years_surgery_minus_4,
    hospital_admissions_per_person_year_surgery_minus_3 = hospital_admissions_surgery_minus_3 / person_years_surgery_minus_3,
    hospital_admissions_per_person_year_surgery_minus_2 = hospital_admissions_surgery_minus_2 / person_years_surgery_minus_2,
    hospital_admissions_per_person_year_surgery_minus_1 = hospital_admissions_surgery_minus_1 / person_years_surgery_minus_1,
    hospital_admissions_per_person_year_surgery_0 = hospital_admissions_surgery_0 / person_years_surgery_0,
    hospital_admissions_per_person_year_surgery_1 = hospital_admissions_surgery_1 / person_years_surgery_1,
    hospital_admissions_per_person_year_surgery_2 = hospital_admissions_surgery_2 / person_years_surgery_2,
    hospital_admissions_per_person_year_surgery_3 = hospital_admissions_surgery_3 / person_years_surgery_3,
    hospital_admissions_per_person_year_surgery_4 = hospital_admissions_surgery_4 / person_years_surgery_4,
    hospital_admissions_per_person_year_surgery_5 = hospital_admissions_surgery_5 / person_years_surgery_5,
    hospital_admissions_per_person_year_surgery_6 = hospital_admissions_surgery_6 / person_years_surgery_6,
    hospital_admissions_per_person_year_surgery_7 = hospital_admissions_surgery_7 / person_years_surgery_7,
    hospital_admissions_per_person_year_surgery_8 = hospital_admissions_surgery_8 / person_years_surgery_8,
    hospital_admissions_per_person_year_surgery_9 = hospital_admissions_surgery_9 / person_years_surgery_9,
    hospital_admissions_per_person_year_surgery_10 = hospital_admissions_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_0, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_0, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_1, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_1, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_2, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_2, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_3, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_3, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_4, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_4, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_5, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_5, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_6, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_6, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_7, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_7, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_8, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_8, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_9, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_9, na.rm=TRUE)

summary(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_10, na.rm=TRUE)
sd(pediatric_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_10, na.rm=TRUE)
```




Length of stay in hospital admissions for resective epilepsy surgery
```{r}
# Length of hospital stay in patients with resective epilepsy surgery
pediatric_LOS_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  ungroup() %>% 
  summarize(total_LOS = sum(LOS))
pediatric_LOS_resective_epilepsy_surgery




# Length of hospital stay per patient before and after surgery
pediatric_utilization_resective_epilepsy_surgery_LOS <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE, LOS) %>% 
  rename(hospital_admission_date = SVCDATE)

pediatric_LOS_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(pediatric_utilization_resective_epilepsy_surgery_LOS, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date, LOS) %>%
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    LOS_surgery_minus_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(9)))), LOS, 0), na.rm=TRUE)/5,
    LOS_surgery_0_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(63)))), LOS, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
pediatric_LOS_by_year_per_patient_resective_epilepsy_surgery_1_5  
   

# Length of stay per person-year by year before and after surgery
pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(pediatric_LOS_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    LOS_per_person_year_surgery_minus_1_5 = LOS_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    LOS_per_person_year_surgery_0_1_5 = LOS_surgery_0_1_5 / person_years_surgery_0_1_5,
    LOS_per_person_year_surgery_1_5 = LOS_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_pediatric_LOS_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5)
Wilcoxon_test_pediatric_LOS_per_person_year_resective_epilepsy_surgery_1_5




# LOS per patient by year in relationship to surgery
pediatric_utilization_resective_epilepsy_surgery_LOS <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE, LOS) %>% 
  rename(hospital_admission_date = SVCDATE)

pediatric_LOS_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(pediatric_utilization_resective_epilepsy_surgery_LOS, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date, LOS) %>%
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    LOS_surgery_minus_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(129))) & (hospital_admission_date < (surgery_date - months(117)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(117))) & (hospital_admission_date < (surgery_date - months(105)))), LOS, 0), na.rm=TRUE), 
    LOS_surgery_minus_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(105))) & (hospital_admission_date < (surgery_date - months(93)))), LOS, 0), na.rm=TRUE),  
    LOS_surgery_minus_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(93))) & (hospital_admission_date < (surgery_date - months(81)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(81))) & (hospital_admission_date < (surgery_date - months(69)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(57)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(57))) & (hospital_admission_date < (surgery_date - months(45)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(45))) & (hospital_admission_date < (surgery_date - months(33)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(33))) & (hospital_admission_date < (surgery_date - months(21)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(21))) & (hospital_admission_date < (surgery_date - months(9)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_0 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), LOS, 0), na.rm=TRUE),      LOS_surgery_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(15)))), LOS, 0), na.rm=TRUE),     LOS_surgery_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(15))) & (hospital_admission_date < (surgery_date + months(27)))), LOS, 0), na.rm=TRUE),     LOS_surgery_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(27))) & (hospital_admission_date < (surgery_date + months(39)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(39))) & (hospital_admission_date < (surgery_date + months(51)))), LOS, 0), na.rm=TRUE),     LOS_surgery_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(51))) & (hospital_admission_date < (surgery_date + months(63)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(63))) & (hospital_admission_date < (surgery_date + months(75)))), LOS, 0), na.rm=TRUE),     LOS_surgery_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(75))) & (hospital_admission_date < (surgery_date + months(87)))), LOS, 0), na.rm=TRUE),     LOS_surgery_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(87))) & (hospital_admission_date < (surgery_date + months(99)))), LOS, 0), na.rm=TRUE),     LOS_surgery_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(99))) & (hospital_admission_date < (surgery_date + months(111)))), LOS, 0), na.rm=TRUE), 
    LOS_surgery_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(111))) & (hospital_admission_date < (surgery_date + months(123)))), LOS, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
pediatric_LOS_by_year_per_patient_resective_epilepsy_surgery  
   

# Length of stay per person-year by year
pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(pediatric_LOS_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    LOS_per_person_year_surgery_minus_10 = LOS_surgery_minus_10 / person_years_surgery_minus_10,
    LOS_per_person_year_surgery_minus_9 = LOS_surgery_minus_9 / person_years_surgery_minus_9,
    LOS_per_person_year_surgery_minus_8 = LOS_surgery_minus_8 / person_years_surgery_minus_8,
    LOS_per_person_year_surgery_minus_7 = LOS_surgery_minus_7 / person_years_surgery_minus_7,
    LOS_per_person_year_surgery_minus_6 = LOS_surgery_minus_6 / person_years_surgery_minus_6,
    LOS_per_person_year_surgery_minus_5 = LOS_surgery_minus_5 / person_years_surgery_minus_5,
    LOS_per_person_year_surgery_minus_4 = LOS_surgery_minus_4 / person_years_surgery_minus_4,
    LOS_per_person_year_surgery_minus_3 = LOS_surgery_minus_3 / person_years_surgery_minus_3,
    LOS_per_person_year_surgery_minus_2 = LOS_surgery_minus_2 / person_years_surgery_minus_2,
    LOS_per_person_year_surgery_minus_1 = LOS_surgery_minus_1 / person_years_surgery_minus_1,
    LOS_per_person_year_surgery_0 = LOS_surgery_0 / person_years_surgery_0,
    LOS_per_person_year_surgery_1 = LOS_surgery_1 / person_years_surgery_1,
    LOS_per_person_year_surgery_2 = LOS_surgery_2 / person_years_surgery_2,
    LOS_per_person_year_surgery_3 = LOS_surgery_3 / person_years_surgery_3,
    LOS_per_person_year_surgery_4 = LOS_surgery_4 / person_years_surgery_4,
    LOS_per_person_year_surgery_5 = LOS_surgery_5 / person_years_surgery_5,
    LOS_per_person_year_surgery_6 = LOS_surgery_6 / person_years_surgery_6,
    LOS_per_person_year_surgery_7 = LOS_surgery_7 / person_years_surgery_7,
    LOS_per_person_year_surgery_8 = LOS_surgery_8 / person_years_surgery_8,
    LOS_per_person_year_surgery_9 = LOS_surgery_9 / person_years_surgery_9,
    LOS_per_person_year_surgery_10 = LOS_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_0, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_0, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_1, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_1, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_2, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_2, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_3, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_3, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_4, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_4, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_5, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_5, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_6, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_6, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_7, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_7, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_8, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_8, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_9, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_9, na.rm=TRUE)

summary(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_10, na.rm=TRUE)
sd(pediatric_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_10, na.rm=TRUE)
```




Cost in patients with resective epilepsy surgery
```{r}
# Cost in patients with resective epilepsy surgery
pediatric_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
pediatric_cost_resective_epilepsy_surgery




# Cost per patient before and after surgery
pediatric_utilization_resective_epilepsy_surgery_total_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


total_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(pediatric_utilization_resective_epilepsy_surgery_total_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    total_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    total_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
total_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Total cost per person-year by year before and after surgery
total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(total_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    total_cost_per_person_year_surgery_minus_1_5 = total_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    total_cost_per_person_year_surgery_0_1_5 = total_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    total_cost_per_person_year_surgery_1_5 = total_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_pediatric_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5)
Wilcoxon_test_pediatric_cost_per_person_year_resective_epilepsy_surgery_1_5




# Total cost per patient by year in relationship to surgery
pediatric_utilization_resective_epilepsy_surgery_total_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


total_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(pediatric_utilization_resective_epilepsy_surgery_total_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    total_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    total_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    total_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      total_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    total_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
total_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Total cost per person-year by year
total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(total_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    total_cost_per_person_year_surgery_minus_10 = total_cost_surgery_minus_10 / person_years_surgery_minus_10,
    total_cost_per_person_year_surgery_minus_9 = total_cost_surgery_minus_9 / person_years_surgery_minus_9,
    total_cost_per_person_year_surgery_minus_8 = total_cost_surgery_minus_8 / person_years_surgery_minus_8,
    total_cost_per_person_year_surgery_minus_7 = total_cost_surgery_minus_7 / person_years_surgery_minus_7,
    total_cost_per_person_year_surgery_minus_6 = total_cost_surgery_minus_6 / person_years_surgery_minus_6,
    total_cost_per_person_year_surgery_minus_5 = total_cost_surgery_minus_5 / person_years_surgery_minus_5,
    total_cost_per_person_year_surgery_minus_4 = total_cost_surgery_minus_4 / person_years_surgery_minus_4,
    total_cost_per_person_year_surgery_minus_3 = total_cost_surgery_minus_3 / person_years_surgery_minus_3,
    total_cost_per_person_year_surgery_minus_2 = total_cost_surgery_minus_2 / person_years_surgery_minus_2,
    total_cost_per_person_year_surgery_minus_1 = total_cost_surgery_minus_1 / person_years_surgery_minus_1,
    total_cost_per_person_year_surgery_0 = total_cost_surgery_0 / person_years_surgery_0,
    total_cost_per_person_year_surgery_1 = total_cost_surgery_1 / person_years_surgery_1,
    total_cost_per_person_year_surgery_2 = total_cost_surgery_2 / person_years_surgery_2,
    total_cost_per_person_year_surgery_3 = total_cost_surgery_3 / person_years_surgery_3,
    total_cost_per_person_year_surgery_4 = total_cost_surgery_4 / person_years_surgery_4,
    total_cost_per_person_year_surgery_5 = total_cost_surgery_5 / person_years_surgery_5,
    total_cost_per_person_year_surgery_6 = total_cost_surgery_6 / person_years_surgery_6,
    total_cost_per_person_year_surgery_7 = total_cost_surgery_7 / person_years_surgery_7,
    total_cost_per_person_year_surgery_8 = total_cost_surgery_8 / person_years_surgery_8,
    total_cost_per_person_year_surgery_9 = total_cost_surgery_9 / person_years_surgery_9,
    total_cost_per_person_year_surgery_10 = total_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Total cost figure in patients with resective epilepsy surgery
```{r}
# Total cost figure
data_figure_total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- tibble(
  "year" = factor(c("Year -5", "Year -4", "Year -3", "Year -2", "Year -1", "Year surgery", "Year +1", "Year +2", "Year +3", "Year +4", "Year +5"), levels=c("Year -5", "Year -4", "Year -3", "Year -2", "Year -1", "Year surgery", "Year +1", "Year +2", "Year +3", "Year +4", "Year +5")),
  "median_cost" = c(summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[3],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[3],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[3],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[3],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[3],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[3],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[3],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[3],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[3],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[3],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[3]),
  "p25_cost" = c(summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[2],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[2],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[2],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[2],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[2],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[2],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[2],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[2],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[2],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[2],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[2]),  
  "p75_cost" = c(summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[5],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[5],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[5],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[5],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[5],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[5],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[5],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[5],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[5],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[5],
                  summary(total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[5])    
  )


figure_total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- ggplot(data=data_figure_total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery) + 
  geom_point(aes(x=year, y=median_cost), color="purple2", size=5) +
  geom_point(aes(x=year, y=p25_cost), color="darkgreen", size=4) +
  geom_point(aes(x=year, y=p75_cost), color="darkgreen", size=4) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=22, face="bold")) +
  scale_x_discrete(name="Year") +
  scale_y_continuous(name="Cost ($) per person-year", breaks=seq(0, 300000, 50000), limits = c(0, 300000))
figure_total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery
ggplotly(figure_total_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery)
```




Outpatient cost in patients with resective epilepsy surgery
```{r}
# Outpatient cost in patients with resective epilepsy surgery
outpatient_pediatric_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="outpatient") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
outpatient_pediatric_cost_resective_epilepsy_surgery




# Outpatient cost per patient before and after surgery
pediatric_utilization_resective_epilepsy_surgery_outpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


outpatient_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(pediatric_utilization_resective_epilepsy_surgery_outpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    outpatient_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Outpatient cost per person-year by year before and after surgery
outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(outpatient_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    outpatient_cost_per_person_year_surgery_minus_1_5 = outpatient_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    outpatient_cost_per_person_year_surgery_0_1_5 = outpatient_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    outpatient_cost_per_person_year_surgery_1_5 = outpatient_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_outpatient_pediatric_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5)
Wilcoxon_test_outpatient_pediatric_cost_per_person_year_resective_epilepsy_surgery_1_5




# Outpatient cost per patient by year in relationship to surgery
pediatric_utilization_resective_epilepsy_surgery_outpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


outpatient_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(pediatric_utilization_resective_epilepsy_surgery_outpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    outpatient_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    outpatient_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      outpatient_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    outpatient_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Outpatient cost per person-year by year
outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(outpatient_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    outpatient_cost_per_person_year_surgery_minus_10 = outpatient_cost_surgery_minus_10 / person_years_surgery_minus_10,
    outpatient_cost_per_person_year_surgery_minus_9 = outpatient_cost_surgery_minus_9 / person_years_surgery_minus_9,
    outpatient_cost_per_person_year_surgery_minus_8 = outpatient_cost_surgery_minus_8 / person_years_surgery_minus_8,
    outpatient_cost_per_person_year_surgery_minus_7 = outpatient_cost_surgery_minus_7 / person_years_surgery_minus_7,
    outpatient_cost_per_person_year_surgery_minus_6 = outpatient_cost_surgery_minus_6 / person_years_surgery_minus_6,
    outpatient_cost_per_person_year_surgery_minus_5 = outpatient_cost_surgery_minus_5 / person_years_surgery_minus_5,
    outpatient_cost_per_person_year_surgery_minus_4 = outpatient_cost_surgery_minus_4 / person_years_surgery_minus_4,
    outpatient_cost_per_person_year_surgery_minus_3 = outpatient_cost_surgery_minus_3 / person_years_surgery_minus_3,
    outpatient_cost_per_person_year_surgery_minus_2 = outpatient_cost_surgery_minus_2 / person_years_surgery_minus_2,
    outpatient_cost_per_person_year_surgery_minus_1 = outpatient_cost_surgery_minus_1 / person_years_surgery_minus_1,
    outpatient_cost_per_person_year_surgery_0 = outpatient_cost_surgery_0 / person_years_surgery_0,
    outpatient_cost_per_person_year_surgery_1 = outpatient_cost_surgery_1 / person_years_surgery_1,
    outpatient_cost_per_person_year_surgery_2 = outpatient_cost_surgery_2 / person_years_surgery_2,
    outpatient_cost_per_person_year_surgery_3 = outpatient_cost_surgery_3 / person_years_surgery_3,
    outpatient_cost_per_person_year_surgery_4 = outpatient_cost_surgery_4 / person_years_surgery_4,
    outpatient_cost_per_person_year_surgery_5 = outpatient_cost_surgery_5 / person_years_surgery_5,
    outpatient_cost_per_person_year_surgery_6 = outpatient_cost_surgery_6 / person_years_surgery_6,
    outpatient_cost_per_person_year_surgery_7 = outpatient_cost_surgery_7 / person_years_surgery_7,
    outpatient_cost_per_person_year_surgery_8 = outpatient_cost_surgery_8 / person_years_surgery_8,
    outpatient_cost_per_person_year_surgery_9 = outpatient_cost_surgery_9 / person_years_surgery_9,
    outpatient_cost_per_person_year_surgery_10 = outpatient_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(outpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
```




ED cost in patients with resective epilepsy surgery
```{r}
# ED cost in patients with resective epilepsy surgery
ED_pediatric_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="emergency") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
ED_pediatric_cost_resective_epilepsy_surgery




# ED cost per patient before and after surgery
pediatric_utilization_resective_epilepsy_surgery_ED_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="emergency") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


ED_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(pediatric_utilization_resective_epilepsy_surgery_ED_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    ED_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# ED cost per person-year by year before and after surgery
ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(ED_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    ED_cost_per_person_year_surgery_minus_1_5 = ED_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    ED_cost_per_person_year_surgery_0_1_5 = ED_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    ED_cost_per_person_year_surgery_1_5 = ED_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_ED_pediatric_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5)
Wilcoxon_test_ED_pediatric_cost_per_person_year_resective_epilepsy_surgery_1_5




# ED cost per patient by year in relationship to surgery
pediatric_utilization_resective_epilepsy_surgery_ED_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="emergency") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


ED_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(pediatric_utilization_resective_epilepsy_surgery_ED_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    ED_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    ED_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      ED_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    ED_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# ED cost per person-year by year
ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(ED_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    ED_cost_per_person_year_surgery_minus_10 = ED_cost_surgery_minus_10 / person_years_surgery_minus_10,
    ED_cost_per_person_year_surgery_minus_9 = ED_cost_surgery_minus_9 / person_years_surgery_minus_9,
    ED_cost_per_person_year_surgery_minus_8 = ED_cost_surgery_minus_8 / person_years_surgery_minus_8,
    ED_cost_per_person_year_surgery_minus_7 = ED_cost_surgery_minus_7 / person_years_surgery_minus_7,
    ED_cost_per_person_year_surgery_minus_6 = ED_cost_surgery_minus_6 / person_years_surgery_minus_6,
    ED_cost_per_person_year_surgery_minus_5 = ED_cost_surgery_minus_5 / person_years_surgery_minus_5,
    ED_cost_per_person_year_surgery_minus_4 = ED_cost_surgery_minus_4 / person_years_surgery_minus_4,
    ED_cost_per_person_year_surgery_minus_3 = ED_cost_surgery_minus_3 / person_years_surgery_minus_3,
    ED_cost_per_person_year_surgery_minus_2 = ED_cost_surgery_minus_2 / person_years_surgery_minus_2,
    ED_cost_per_person_year_surgery_minus_1 = ED_cost_surgery_minus_1 / person_years_surgery_minus_1,
    ED_cost_per_person_year_surgery_0 = ED_cost_surgery_0 / person_years_surgery_0,
    ED_cost_per_person_year_surgery_1 = ED_cost_surgery_1 / person_years_surgery_1,
    ED_cost_per_person_year_surgery_2 = ED_cost_surgery_2 / person_years_surgery_2,
    ED_cost_per_person_year_surgery_3 = ED_cost_surgery_3 / person_years_surgery_3,
    ED_cost_per_person_year_surgery_4 = ED_cost_surgery_4 / person_years_surgery_4,
    ED_cost_per_person_year_surgery_5 = ED_cost_surgery_5 / person_years_surgery_5,
    ED_cost_per_person_year_surgery_6 = ED_cost_surgery_6 / person_years_surgery_6,
    ED_cost_per_person_year_surgery_7 = ED_cost_surgery_7 / person_years_surgery_7,
    ED_cost_per_person_year_surgery_8 = ED_cost_surgery_8 / person_years_surgery_8,
    ED_cost_per_person_year_surgery_9 = ED_cost_surgery_9 / person_years_surgery_9,
    ED_cost_per_person_year_surgery_10 = ED_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(ED_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Inpatient cost in patients with resective epilepsy surgery
```{r}
# Inpatient cost in patients with resective epilepsy surgery
inpatient_pediatric_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="inpatient") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
inpatient_pediatric_cost_resective_epilepsy_surgery




# Inpatient cost per patient before and after surgery
pediatric_utilization_resective_epilepsy_surgery_inpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


inpatient_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(pediatric_utilization_resective_epilepsy_surgery_inpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    inpatient_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    inpatient_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
inpatient_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Inpatient cost per person-year by year before and after surgery
inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(inpatient_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    inpatient_cost_per_person_year_surgery_minus_1_5 = inpatient_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    inpatient_cost_per_person_year_surgery_0_1_5 = inpatient_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    inpatient_cost_per_person_year_surgery_1_5 = inpatient_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_inpatient_pediatric_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5)
Wilcoxon_test_inpatient_pediatric_cost_per_person_year_resective_epilepsy_surgery_1_5




# Inpatient cost per patient by year in relationship to surgery
pediatric_utilization_resective_epilepsy_surgery_inpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


inpatient_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% pediatric_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(pediatric_utilization_resective_epilepsy_surgery_inpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    inpatient_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    inpatient_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    inpatient_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      inpatient_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    inpatient_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
inpatient_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Inpatient cost per person-year by year
inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  pediatric_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(inpatient_pediatric_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    inpatient_cost_per_person_year_surgery_minus_10 = inpatient_cost_surgery_minus_10 / person_years_surgery_minus_10,
    inpatient_cost_per_person_year_surgery_minus_9 = inpatient_cost_surgery_minus_9 / person_years_surgery_minus_9,
    inpatient_cost_per_person_year_surgery_minus_8 = inpatient_cost_surgery_minus_8 / person_years_surgery_minus_8,
    inpatient_cost_per_person_year_surgery_minus_7 = inpatient_cost_surgery_minus_7 / person_years_surgery_minus_7,
    inpatient_cost_per_person_year_surgery_minus_6 = inpatient_cost_surgery_minus_6 / person_years_surgery_minus_6,
    inpatient_cost_per_person_year_surgery_minus_5 = inpatient_cost_surgery_minus_5 / person_years_surgery_minus_5,
    inpatient_cost_per_person_year_surgery_minus_4 = inpatient_cost_surgery_minus_4 / person_years_surgery_minus_4,
    inpatient_cost_per_person_year_surgery_minus_3 = inpatient_cost_surgery_minus_3 / person_years_surgery_minus_3,
    inpatient_cost_per_person_year_surgery_minus_2 = inpatient_cost_surgery_minus_2 / person_years_surgery_minus_2,
    inpatient_cost_per_person_year_surgery_minus_1 = inpatient_cost_surgery_minus_1 / person_years_surgery_minus_1,
    inpatient_cost_per_person_year_surgery_0 = inpatient_cost_surgery_0 / person_years_surgery_0,
    inpatient_cost_per_person_year_surgery_1 = inpatient_cost_surgery_1 / person_years_surgery_1,
    inpatient_cost_per_person_year_surgery_2 = inpatient_cost_surgery_2 / person_years_surgery_2,
    inpatient_cost_per_person_year_surgery_3 = inpatient_cost_surgery_3 / person_years_surgery_3,
    inpatient_cost_per_person_year_surgery_4 = inpatient_cost_surgery_4 / person_years_surgery_4,
    inpatient_cost_per_person_year_surgery_5 = inpatient_cost_surgery_5 / person_years_surgery_5,
    inpatient_cost_per_person_year_surgery_6 = inpatient_cost_surgery_6 / person_years_surgery_6,
    inpatient_cost_per_person_year_surgery_7 = inpatient_cost_surgery_7 / person_years_surgery_7,
    inpatient_cost_per_person_year_surgery_8 = inpatient_cost_surgery_8 / person_years_surgery_8,
    inpatient_cost_per_person_year_surgery_9 = inpatient_cost_surgery_9 / person_years_surgery_9,
    inpatient_cost_per_person_year_surgery_10 = inpatient_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(inpatient_pediatric_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Outpatient visits
```{r}
# Individual outpatient visits
adult_outpatient_visit_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
adult_outpatient_visit_resective_epilepsy_surgery_n 


# Individual patients with outpatient visits
patients_adult_outpatient_visit_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_adult_outpatient_visit_resective_epilepsy_surgery_n 


# Tally of patients with more than one outpatient visit
tally_adult_outpatient_visit_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  tally(name="number_outpatient_visits")  %>% 
  group_by(number_outpatient_visits) %>% 
  tally(name="number_patients")
tally_adult_outpatient_visit_resective_epilepsy_surgery




# Outpatient visits per patient before and after surgery
adult_utilization_resective_epilepsy_surgery_outpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(outpatient_date = SVCDATE)

adult_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(adult_utilization_resective_epilepsy_surgery_outpatient, by="ENROLID") %>%
  select(ENROLID, outpatient_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_visits_surgery_minus_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(69))) & (outpatient_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    outpatient_visits_surgery_0_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(9))) & (outpatient_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),     
    outpatient_visits_surgery_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(3))) & (outpatient_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
adult_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 
   

# Outpatient visits per person-year by year
adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  adult_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(adult_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    outpatient_visits_per_person_year_surgery_minus_1_5 = outpatient_visits_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    outpatient_visits_per_person_year_surgery_0_1_5 = outpatient_visits_surgery_0_1_5 / person_years_surgery_0_1_5,
    outpatient_visits_per_person_year_surgery_1_5 = outpatient_visits_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5, na.rm=TRUE)


# Statistical test
Wilcoxon_test_adult_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5)
Wilcoxon_test_adult_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5




# Outpatient visits per patient by year in relationship to surgery
adult_utilization_resective_epilepsy_surgery_outpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(outpatient_date = SVCDATE)

adult_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(adult_utilization_resective_epilepsy_surgery_outpatient, by="ENROLID") %>%
  select(ENROLID, outpatient_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_visits_surgery_minus_10 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(129))) & (outpatient_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_9 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(117))) & (outpatient_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    outpatient_visits_surgery_minus_8 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(105))) & (outpatient_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),  
    outpatient_visits_surgery_minus_7 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(93))) & (outpatient_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_6 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(81))) & (outpatient_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(69))) & (outpatient_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_4 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(57))) & (outpatient_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_3 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(45))) & (outpatient_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_2 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(33))) & (outpatient_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_1 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(21))) & (outpatient_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_0 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(9))) & (outpatient_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      outpatient_visits_surgery_1 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(3))) & (outpatient_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_2 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(15))) & (outpatient_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_3 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(27))) & (outpatient_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_4 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(39))) & (outpatient_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(51))) & (outpatient_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_6 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(63))) & (outpatient_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_7 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(75))) & (outpatient_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_8 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(87))) & (outpatient_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_9 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(99))) & (outpatient_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE), 
    outpatient_visits_surgery_10 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(111))) & (outpatient_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
adult_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery  
   

# Outpatient visits per person-year by year
adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  adult_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(adult_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    outpatient_visits_per_person_year_surgery_minus_10 = outpatient_visits_surgery_minus_10 / person_years_surgery_minus_10,
    outpatient_visits_per_person_year_surgery_minus_9 = outpatient_visits_surgery_minus_9 / person_years_surgery_minus_9,
    outpatient_visits_per_person_year_surgery_minus_8 = outpatient_visits_surgery_minus_8 / person_years_surgery_minus_8,
    outpatient_visits_per_person_year_surgery_minus_7 = outpatient_visits_surgery_minus_7 / person_years_surgery_minus_7,
    outpatient_visits_per_person_year_surgery_minus_6 = outpatient_visits_surgery_minus_6 / person_years_surgery_minus_6,
    outpatient_visits_per_person_year_surgery_minus_5 = outpatient_visits_surgery_minus_5 / person_years_surgery_minus_5,
    outpatient_visits_per_person_year_surgery_minus_4 = outpatient_visits_surgery_minus_4 / person_years_surgery_minus_4,
    outpatient_visits_per_person_year_surgery_minus_3 = outpatient_visits_surgery_minus_3 / person_years_surgery_minus_3,
    outpatient_visits_per_person_year_surgery_minus_2 = outpatient_visits_surgery_minus_2 / person_years_surgery_minus_2,
    outpatient_visits_per_person_year_surgery_minus_1 = outpatient_visits_surgery_minus_1 / person_years_surgery_minus_1,
    outpatient_visits_per_person_year_surgery_0 = outpatient_visits_surgery_0 / person_years_surgery_0,
    outpatient_visits_per_person_year_surgery_1 = outpatient_visits_surgery_1 / person_years_surgery_1,
    outpatient_visits_per_person_year_surgery_2 = outpatient_visits_surgery_2 / person_years_surgery_2,
    outpatient_visits_per_person_year_surgery_3 = outpatient_visits_surgery_3 / person_years_surgery_3,
    outpatient_visits_per_person_year_surgery_4 = outpatient_visits_surgery_4 / person_years_surgery_4,
    outpatient_visits_per_person_year_surgery_5 = outpatient_visits_surgery_5 / person_years_surgery_5,
    outpatient_visits_per_person_year_surgery_6 = outpatient_visits_surgery_6 / person_years_surgery_6,
    outpatient_visits_per_person_year_surgery_7 = outpatient_visits_surgery_7 / person_years_surgery_7,
    outpatient_visits_per_person_year_surgery_8 = outpatient_visits_surgery_8 / person_years_surgery_8,
    outpatient_visits_per_person_year_surgery_9 = outpatient_visits_surgery_9 / person_years_surgery_9,
    outpatient_visits_per_person_year_surgery_10 = outpatient_visits_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_0, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_0, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_1, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_1, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_2, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_2, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_3, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_3, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_4, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_4, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_5, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_5, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_6, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_6, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_7, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_7, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_8, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_8, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_9, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_9, na.rm=TRUE)

summary(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_10, na.rm=TRUE)
sd(adult_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_10, na.rm=TRUE)
```




Emergency department visits
```{r}
# Individual emergency department visits
adult_ED_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
adult_ED_resective_epilepsy_surgery_n 


# Individual patients with ED visits
patients_adult_ED_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_adult_ED_resective_epilepsy_surgery_n 


# Tally of patients with more than one ED visit
tally_adult_ED_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  tally(name="number_ED_visits")  %>% 
  group_by(number_ED_visits) %>% 
  tally(name="number_patients")
tally_adult_ED_resective_epilepsy_surgery




# Emergency visits per patient by year in relationship to surgery before and after surgery
adult_utilization_resective_epilepsy_surgery_emergency <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(ED_date = SVCDATE)

adult_ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 <-
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(adult_utilization_resective_epilepsy_surgery_emergency, by="ENROLID") %>%
  select(ENROLID, ED_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_visits_surgery_minus_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(69))) & (ED_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    ED_visits_surgery_0_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(9))) & (ED_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE), 
    ED_visits_surgery_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(3))) & (ED_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
adult_ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5  
   

# ED visits per person-year by year before and after surgery
adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  adult_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(adult_ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    ED_visits_per_person_year_surgery_minus_1_5 = ED_visits_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    ED_visits_per_person_year_surgery_0_1_5 = ED_visits_surgery_0_1_5 / person_years_surgery_0_1_5,
    ED_visits_per_person_year_surgery_1_5 = ED_visits_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_adult_ED_visits_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5)
Wilcoxon_test_adult_ED_visits_per_person_year_resective_epilepsy_surgery_1_5




# Emergency visits per patient by year in relationship to surgery
adult_utilization_resective_epilepsy_surgery_emergency <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(ED_date = SVCDATE)

adult_ED_visits_by_year_per_patient_resective_epilepsy_surgery <-
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(adult_utilization_resective_epilepsy_surgery_emergency, by="ENROLID") %>%
  select(ENROLID, ED_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_visits_surgery_minus_10 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(129))) & (ED_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_9 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(117))) & (ED_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    ED_visits_surgery_minus_8 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(105))) & (ED_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_7 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(93))) & (ED_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_6 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(81))) & (ED_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(69))) & (ED_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_4 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(57))) & (ED_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_3 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(45))) & (ED_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_2 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(33))) & (ED_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_1 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(21))) & (ED_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_0 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(9))) & (ED_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      ED_visits_surgery_1 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(3))) & (ED_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     ED_visits_surgery_2 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(15))) & (ED_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     ED_visits_surgery_3 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(27))) & (ED_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_4 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(39))) & (ED_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     ED_visits_surgery_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(51))) & (ED_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_6 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(63))) & (ED_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     ED_visits_surgery_7 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(75))) & (ED_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     ED_visits_surgery_8 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(87))) & (ED_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     ED_visits_surgery_9 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(99))) & (ED_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_10 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(111))) & (ED_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
adult_ED_visits_by_year_per_patient_resective_epilepsy_surgery  
   

# ED visits per person-year by year
adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  adult_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(adult_ED_visits_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    ED_visits_per_person_year_surgery_minus_10 = ED_visits_surgery_minus_10 / person_years_surgery_minus_10,
    ED_visits_per_person_year_surgery_minus_9 = ED_visits_surgery_minus_9 / person_years_surgery_minus_9,
    ED_visits_per_person_year_surgery_minus_8 = ED_visits_surgery_minus_8 / person_years_surgery_minus_8,
    ED_visits_per_person_year_surgery_minus_7 = ED_visits_surgery_minus_7 / person_years_surgery_minus_7,
    ED_visits_per_person_year_surgery_minus_6 = ED_visits_surgery_minus_6 / person_years_surgery_minus_6,
    ED_visits_per_person_year_surgery_minus_5 = ED_visits_surgery_minus_5 / person_years_surgery_minus_5,
    ED_visits_per_person_year_surgery_minus_4 = ED_visits_surgery_minus_4 / person_years_surgery_minus_4,
    ED_visits_per_person_year_surgery_minus_3 = ED_visits_surgery_minus_3 / person_years_surgery_minus_3,
    ED_visits_per_person_year_surgery_minus_2 = ED_visits_surgery_minus_2 / person_years_surgery_minus_2,
    ED_visits_per_person_year_surgery_minus_1 = ED_visits_surgery_minus_1 / person_years_surgery_minus_1,
    ED_visits_per_person_year_surgery_0 = ED_visits_surgery_0 / person_years_surgery_0,
    ED_visits_per_person_year_surgery_1 = ED_visits_surgery_1 / person_years_surgery_1,
    ED_visits_per_person_year_surgery_2 = ED_visits_surgery_2 / person_years_surgery_2,
    ED_visits_per_person_year_surgery_3 = ED_visits_surgery_3 / person_years_surgery_3,
    ED_visits_per_person_year_surgery_4 = ED_visits_surgery_4 / person_years_surgery_4,
    ED_visits_per_person_year_surgery_5 = ED_visits_surgery_5 / person_years_surgery_5,
    ED_visits_per_person_year_surgery_6 = ED_visits_surgery_6 / person_years_surgery_6,
    ED_visits_per_person_year_surgery_7 = ED_visits_surgery_7 / person_years_surgery_7,
    ED_visits_per_person_year_surgery_8 = ED_visits_surgery_8 / person_years_surgery_8,
    ED_visits_per_person_year_surgery_9 = ED_visits_surgery_9 / person_years_surgery_9,
    ED_visits_per_person_year_surgery_10 = ED_visits_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_0, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_0, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_1, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_1, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_2, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_2, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_3, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_3, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_4, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_4, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_5, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_5, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_6, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_6, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_7, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_7, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_8, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_8, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_9, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_9, na.rm=TRUE)

summary(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_10, na.rm=TRUE)
sd(adult_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_10, na.rm=TRUE)
```




Hospital admissions
```{r}
# Individual hospital admissions
adult_hospital_admission_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
adult_hospital_admission_resective_epilepsy_surgery_n 


# Individual patients with hospital admissions
patients_adult_hospital_admission_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_adult_hospital_admission_resective_epilepsy_surgery_n 


# Tally of patients with more than one hospital admission
tally_adult_hospital_admission_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  tally(name="number_hospital_admissions")  %>% 
  group_by(number_hospital_admissions) %>% 
  tally(name="number_hospital_admissions")
tally_adult_hospital_admission_resective_epilepsy_surgery




# Hospital admissions per patient before and after surgery
adult_utilization_resective_epilepsy_surgery_inpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(hospital_admission_date = SVCDATE)

adult_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(adult_utilization_resective_epilepsy_surgery_inpatient, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    hospital_admissions_surgery_minus_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    hospital_admissions_surgery_0_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
adult_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Hospital admissions per person-year by year
adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  adult_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(adult_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    hospital_admissions_per_person_year_surgery_minus_1_5 = hospital_admissions_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    hospital_admissions_per_person_year_surgery_0_1_5 = hospital_admissions_surgery_0_1_5 / person_years_surgery_0_1_5,
    hospital_admissions_per_person_year_surgery_1_5 = hospital_admissions_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_adult_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5)
Wilcoxon_test_adult_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5




# Hospital admissions per patient by year in relationship to surgery
adult_utilization_resective_epilepsy_surgery_inpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(hospital_admission_date = SVCDATE)

adult_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(adult_utilization_resective_epilepsy_surgery_inpatient, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    hospital_admissions_surgery_minus_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(129))) & (hospital_admission_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(117))) & (hospital_admission_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    hospital_admissions_surgery_minus_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(105))) & (hospital_admission_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),  
    hospital_admissions_surgery_minus_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(93))) & (hospital_admission_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(81))) & (hospital_admission_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(57))) & (hospital_admission_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(45))) & (hospital_admission_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(33))) & (hospital_admission_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(21))) & (hospital_admission_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_0 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      hospital_admissions_surgery_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(15))) & (hospital_admission_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(27))) & (hospital_admission_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(39))) & (hospital_admission_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(51))) & (hospital_admission_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(63))) & (hospital_admission_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(75))) & (hospital_admission_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(87))) & (hospital_admission_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(99))) & (hospital_admission_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE), 
    hospital_admissions_surgery_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(111))) & (hospital_admission_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
adult_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery  
   

# Hospital admissions per person-year by year
adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  adult_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(adult_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    hospital_admissions_per_person_year_surgery_minus_10 = hospital_admissions_surgery_minus_10 / person_years_surgery_minus_10,
    hospital_admissions_per_person_year_surgery_minus_9 = hospital_admissions_surgery_minus_9 / person_years_surgery_minus_9,
    hospital_admissions_per_person_year_surgery_minus_8 = hospital_admissions_surgery_minus_8 / person_years_surgery_minus_8,
    hospital_admissions_per_person_year_surgery_minus_7 = hospital_admissions_surgery_minus_7 / person_years_surgery_minus_7,
    hospital_admissions_per_person_year_surgery_minus_6 = hospital_admissions_surgery_minus_6 / person_years_surgery_minus_6,
    hospital_admissions_per_person_year_surgery_minus_5 = hospital_admissions_surgery_minus_5 / person_years_surgery_minus_5,
    hospital_admissions_per_person_year_surgery_minus_4 = hospital_admissions_surgery_minus_4 / person_years_surgery_minus_4,
    hospital_admissions_per_person_year_surgery_minus_3 = hospital_admissions_surgery_minus_3 / person_years_surgery_minus_3,
    hospital_admissions_per_person_year_surgery_minus_2 = hospital_admissions_surgery_minus_2 / person_years_surgery_minus_2,
    hospital_admissions_per_person_year_surgery_minus_1 = hospital_admissions_surgery_minus_1 / person_years_surgery_minus_1,
    hospital_admissions_per_person_year_surgery_0 = hospital_admissions_surgery_0 / person_years_surgery_0,
    hospital_admissions_per_person_year_surgery_1 = hospital_admissions_surgery_1 / person_years_surgery_1,
    hospital_admissions_per_person_year_surgery_2 = hospital_admissions_surgery_2 / person_years_surgery_2,
    hospital_admissions_per_person_year_surgery_3 = hospital_admissions_surgery_3 / person_years_surgery_3,
    hospital_admissions_per_person_year_surgery_4 = hospital_admissions_surgery_4 / person_years_surgery_4,
    hospital_admissions_per_person_year_surgery_5 = hospital_admissions_surgery_5 / person_years_surgery_5,
    hospital_admissions_per_person_year_surgery_6 = hospital_admissions_surgery_6 / person_years_surgery_6,
    hospital_admissions_per_person_year_surgery_7 = hospital_admissions_surgery_7 / person_years_surgery_7,
    hospital_admissions_per_person_year_surgery_8 = hospital_admissions_surgery_8 / person_years_surgery_8,
    hospital_admissions_per_person_year_surgery_9 = hospital_admissions_surgery_9 / person_years_surgery_9,
    hospital_admissions_per_person_year_surgery_10 = hospital_admissions_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_0, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_0, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_1, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_1, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_2, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_2, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_3, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_3, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_4, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_4, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_5, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_5, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_6, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_6, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_7, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_7, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_8, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_8, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_9, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_9, na.rm=TRUE)

summary(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_10, na.rm=TRUE)
sd(adult_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_10, na.rm=TRUE)
```




Length of stay in hospital admissions for resective epilepsy surgery
```{r}
# Length of hospital stay in patients with resective epilepsy surgery
adult_LOS_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  ungroup() %>% 
  summarize(total_LOS = sum(LOS))
adult_LOS_resective_epilepsy_surgery




# Length of hospital stay per patient before and after surgery
adult_utilization_resective_epilepsy_surgery_LOS <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE, LOS) %>% 
  rename(hospital_admission_date = SVCDATE)

adult_LOS_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(adult_utilization_resective_epilepsy_surgery_LOS, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date, LOS) %>%
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    LOS_surgery_minus_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(9)))), LOS, 0), na.rm=TRUE)/5,
    LOS_surgery_0_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(63)))), LOS, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
adult_LOS_by_year_per_patient_resective_epilepsy_surgery_1_5  
   

# Length of stay per person-year by year before and after surgery
adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  adult_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(adult_LOS_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    LOS_per_person_year_surgery_minus_1_5 = LOS_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    LOS_per_person_year_surgery_0_1_5 = LOS_surgery_0_1_5 / person_years_surgery_0_1_5,
    LOS_per_person_year_surgery_1_5 = LOS_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_adult_LOS_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5)
Wilcoxon_test_adult_LOS_per_person_year_resective_epilepsy_surgery_1_5




# LOS per patient by year in relationship to surgery
adult_utilization_resective_epilepsy_surgery_LOS <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE, LOS) %>% 
  rename(hospital_admission_date = SVCDATE)

adult_LOS_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(adult_utilization_resective_epilepsy_surgery_LOS, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date, LOS) %>%
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    LOS_surgery_minus_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(129))) & (hospital_admission_date < (surgery_date - months(117)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(117))) & (hospital_admission_date < (surgery_date - months(105)))), LOS, 0), na.rm=TRUE), 
    LOS_surgery_minus_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(105))) & (hospital_admission_date < (surgery_date - months(93)))), LOS, 0), na.rm=TRUE),  
    LOS_surgery_minus_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(93))) & (hospital_admission_date < (surgery_date - months(81)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(81))) & (hospital_admission_date < (surgery_date - months(69)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(57)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(57))) & (hospital_admission_date < (surgery_date - months(45)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(45))) & (hospital_admission_date < (surgery_date - months(33)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(33))) & (hospital_admission_date < (surgery_date - months(21)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(21))) & (hospital_admission_date < (surgery_date - months(9)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_0 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), LOS, 0), na.rm=TRUE),      LOS_surgery_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(15)))), LOS, 0), na.rm=TRUE),     LOS_surgery_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(15))) & (hospital_admission_date < (surgery_date + months(27)))), LOS, 0), na.rm=TRUE),     LOS_surgery_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(27))) & (hospital_admission_date < (surgery_date + months(39)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(39))) & (hospital_admission_date < (surgery_date + months(51)))), LOS, 0), na.rm=TRUE),     LOS_surgery_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(51))) & (hospital_admission_date < (surgery_date + months(63)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(63))) & (hospital_admission_date < (surgery_date + months(75)))), LOS, 0), na.rm=TRUE),     LOS_surgery_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(75))) & (hospital_admission_date < (surgery_date + months(87)))), LOS, 0), na.rm=TRUE),     LOS_surgery_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(87))) & (hospital_admission_date < (surgery_date + months(99)))), LOS, 0), na.rm=TRUE),     LOS_surgery_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(99))) & (hospital_admission_date < (surgery_date + months(111)))), LOS, 0), na.rm=TRUE), 
    LOS_surgery_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(111))) & (hospital_admission_date < (surgery_date + months(123)))), LOS, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
adult_LOS_by_year_per_patient_resective_epilepsy_surgery  
   

# Length of stay per person-year by year
adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  adult_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(adult_LOS_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    LOS_per_person_year_surgery_minus_10 = LOS_surgery_minus_10 / person_years_surgery_minus_10,
    LOS_per_person_year_surgery_minus_9 = LOS_surgery_minus_9 / person_years_surgery_minus_9,
    LOS_per_person_year_surgery_minus_8 = LOS_surgery_minus_8 / person_years_surgery_minus_8,
    LOS_per_person_year_surgery_minus_7 = LOS_surgery_minus_7 / person_years_surgery_minus_7,
    LOS_per_person_year_surgery_minus_6 = LOS_surgery_minus_6 / person_years_surgery_minus_6,
    LOS_per_person_year_surgery_minus_5 = LOS_surgery_minus_5 / person_years_surgery_minus_5,
    LOS_per_person_year_surgery_minus_4 = LOS_surgery_minus_4 / person_years_surgery_minus_4,
    LOS_per_person_year_surgery_minus_3 = LOS_surgery_minus_3 / person_years_surgery_minus_3,
    LOS_per_person_year_surgery_minus_2 = LOS_surgery_minus_2 / person_years_surgery_minus_2,
    LOS_per_person_year_surgery_minus_1 = LOS_surgery_minus_1 / person_years_surgery_minus_1,
    LOS_per_person_year_surgery_0 = LOS_surgery_0 / person_years_surgery_0,
    LOS_per_person_year_surgery_1 = LOS_surgery_1 / person_years_surgery_1,
    LOS_per_person_year_surgery_2 = LOS_surgery_2 / person_years_surgery_2,
    LOS_per_person_year_surgery_3 = LOS_surgery_3 / person_years_surgery_3,
    LOS_per_person_year_surgery_4 = LOS_surgery_4 / person_years_surgery_4,
    LOS_per_person_year_surgery_5 = LOS_surgery_5 / person_years_surgery_5,
    LOS_per_person_year_surgery_6 = LOS_surgery_6 / person_years_surgery_6,
    LOS_per_person_year_surgery_7 = LOS_surgery_7 / person_years_surgery_7,
    LOS_per_person_year_surgery_8 = LOS_surgery_8 / person_years_surgery_8,
    LOS_per_person_year_surgery_9 = LOS_surgery_9 / person_years_surgery_9,
    LOS_per_person_year_surgery_10 = LOS_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_0, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_0, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_1, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_1, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_2, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_2, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_3, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_3, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_4, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_4, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_5, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_5, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_6, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_6, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_7, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_7, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_8, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_8, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_9, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_9, na.rm=TRUE)

summary(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_10, na.rm=TRUE)
sd(adult_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_10, na.rm=TRUE)
```




Cost in patients with resective epilepsy surgery
```{r}
# Cost in patients with resective epilepsy surgery
adult_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
adult_cost_resective_epilepsy_surgery




# Cost per patient before and after surgery
adult_utilization_resective_epilepsy_surgery_total_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


total_adult_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(adult_utilization_resective_epilepsy_surgery_total_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    total_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    total_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
total_adult_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Total cost per person-year by year before and after surgery
total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  adult_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(total_adult_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    total_cost_per_person_year_surgery_minus_1_5 = total_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    total_cost_per_person_year_surgery_0_1_5 = total_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    total_cost_per_person_year_surgery_1_5 = total_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_adult_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5)
Wilcoxon_test_adult_cost_per_person_year_resective_epilepsy_surgery_1_5




# Total cost per patient by year in relationship to surgery
adult_utilization_resective_epilepsy_surgery_total_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


total_adult_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(adult_utilization_resective_epilepsy_surgery_total_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    total_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    total_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    total_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      total_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    total_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
total_adult_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Total cost per person-year by year
total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  adult_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(total_adult_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    total_cost_per_person_year_surgery_minus_10 = total_cost_surgery_minus_10 / person_years_surgery_minus_10,
    total_cost_per_person_year_surgery_minus_9 = total_cost_surgery_minus_9 / person_years_surgery_minus_9,
    total_cost_per_person_year_surgery_minus_8 = total_cost_surgery_minus_8 / person_years_surgery_minus_8,
    total_cost_per_person_year_surgery_minus_7 = total_cost_surgery_minus_7 / person_years_surgery_minus_7,
    total_cost_per_person_year_surgery_minus_6 = total_cost_surgery_minus_6 / person_years_surgery_minus_6,
    total_cost_per_person_year_surgery_minus_5 = total_cost_surgery_minus_5 / person_years_surgery_minus_5,
    total_cost_per_person_year_surgery_minus_4 = total_cost_surgery_minus_4 / person_years_surgery_minus_4,
    total_cost_per_person_year_surgery_minus_3 = total_cost_surgery_minus_3 / person_years_surgery_minus_3,
    total_cost_per_person_year_surgery_minus_2 = total_cost_surgery_minus_2 / person_years_surgery_minus_2,
    total_cost_per_person_year_surgery_minus_1 = total_cost_surgery_minus_1 / person_years_surgery_minus_1,
    total_cost_per_person_year_surgery_0 = total_cost_surgery_0 / person_years_surgery_0,
    total_cost_per_person_year_surgery_1 = total_cost_surgery_1 / person_years_surgery_1,
    total_cost_per_person_year_surgery_2 = total_cost_surgery_2 / person_years_surgery_2,
    total_cost_per_person_year_surgery_3 = total_cost_surgery_3 / person_years_surgery_3,
    total_cost_per_person_year_surgery_4 = total_cost_surgery_4 / person_years_surgery_4,
    total_cost_per_person_year_surgery_5 = total_cost_surgery_5 / person_years_surgery_5,
    total_cost_per_person_year_surgery_6 = total_cost_surgery_6 / person_years_surgery_6,
    total_cost_per_person_year_surgery_7 = total_cost_surgery_7 / person_years_surgery_7,
    total_cost_per_person_year_surgery_8 = total_cost_surgery_8 / person_years_surgery_8,
    total_cost_per_person_year_surgery_9 = total_cost_surgery_9 / person_years_surgery_9,
    total_cost_per_person_year_surgery_10 = total_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Total cost figure in patients with resective epilepsy surgery
```{r}
# Total cost figure
data_figure_total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- tibble(
  "year" = factor(c("Year -5", "Year -4", "Year -3", "Year -2", "Year -1", "Year surgery", "Year +1", "Year +2", "Year +3", "Year +4", "Year +5"), levels=c("Year -5", "Year -4", "Year -3", "Year -2", "Year -1", "Year surgery", "Year +1", "Year +2", "Year +3", "Year +4", "Year +5")),
  "median_cost" = c(summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[3],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[3],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[3],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[3],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[3],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[3],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[3],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[3],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[3],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[3],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[3]),
  "p25_cost" = c(summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[2],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[2],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[2],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[2],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[2],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[2],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[2],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[2],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[2],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[2],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[2]),  
  "p75_cost" = c(summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[5],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[5],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[5],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[5],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[5],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[5],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[5],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[5],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[5],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[5],
                  summary(total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[5])    
  )


figure_total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- ggplot(data=data_figure_total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery) + 
  geom_point(aes(x=year, y=median_cost), color="purple2", size=5) +
  geom_point(aes(x=year, y=p25_cost), color="darkgreen", size=4) +
  geom_point(aes(x=year, y=p75_cost), color="darkgreen", size=4) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=22, face="bold")) +
  scale_x_discrete(name="Year") +
  scale_y_continuous(name="Cost ($) per person-year", breaks=seq(0, 250000, 50000), limits = c(0, 250000))
figure_total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery
ggplotly(figure_total_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery)
```




Outpatient cost in patients with resective epilepsy surgery
```{r}
# Outpatient cost in patients with resective epilepsy surgery
outpatient_adult_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="outpatient") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
outpatient_adult_cost_resective_epilepsy_surgery




# Outpatient cost per patient before and after surgery
adult_utilization_resective_epilepsy_surgery_outpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


outpatient_adult_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(adult_utilization_resective_epilepsy_surgery_outpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    outpatient_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_adult_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Outpatient cost per person-year by year before and after surgery
outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  adult_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(outpatient_adult_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    outpatient_cost_per_person_year_surgery_minus_1_5 = outpatient_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    outpatient_cost_per_person_year_surgery_0_1_5 = outpatient_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    outpatient_cost_per_person_year_surgery_1_5 = outpatient_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_outpatient_adult_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5)
Wilcoxon_test_outpatient_adult_cost_per_person_year_resective_epilepsy_surgery_1_5




# Outpatient cost per patient by year in relationship to surgery
adult_utilization_resective_epilepsy_surgery_outpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


outpatient_adult_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(adult_utilization_resective_epilepsy_surgery_outpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    outpatient_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    outpatient_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      outpatient_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    outpatient_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_adult_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Outpatient cost per person-year by year
outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  adult_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(outpatient_adult_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    outpatient_cost_per_person_year_surgery_minus_10 = outpatient_cost_surgery_minus_10 / person_years_surgery_minus_10,
    outpatient_cost_per_person_year_surgery_minus_9 = outpatient_cost_surgery_minus_9 / person_years_surgery_minus_9,
    outpatient_cost_per_person_year_surgery_minus_8 = outpatient_cost_surgery_minus_8 / person_years_surgery_minus_8,
    outpatient_cost_per_person_year_surgery_minus_7 = outpatient_cost_surgery_minus_7 / person_years_surgery_minus_7,
    outpatient_cost_per_person_year_surgery_minus_6 = outpatient_cost_surgery_minus_6 / person_years_surgery_minus_6,
    outpatient_cost_per_person_year_surgery_minus_5 = outpatient_cost_surgery_minus_5 / person_years_surgery_minus_5,
    outpatient_cost_per_person_year_surgery_minus_4 = outpatient_cost_surgery_minus_4 / person_years_surgery_minus_4,
    outpatient_cost_per_person_year_surgery_minus_3 = outpatient_cost_surgery_minus_3 / person_years_surgery_minus_3,
    outpatient_cost_per_person_year_surgery_minus_2 = outpatient_cost_surgery_minus_2 / person_years_surgery_minus_2,
    outpatient_cost_per_person_year_surgery_minus_1 = outpatient_cost_surgery_minus_1 / person_years_surgery_minus_1,
    outpatient_cost_per_person_year_surgery_0 = outpatient_cost_surgery_0 / person_years_surgery_0,
    outpatient_cost_per_person_year_surgery_1 = outpatient_cost_surgery_1 / person_years_surgery_1,
    outpatient_cost_per_person_year_surgery_2 = outpatient_cost_surgery_2 / person_years_surgery_2,
    outpatient_cost_per_person_year_surgery_3 = outpatient_cost_surgery_3 / person_years_surgery_3,
    outpatient_cost_per_person_year_surgery_4 = outpatient_cost_surgery_4 / person_years_surgery_4,
    outpatient_cost_per_person_year_surgery_5 = outpatient_cost_surgery_5 / person_years_surgery_5,
    outpatient_cost_per_person_year_surgery_6 = outpatient_cost_surgery_6 / person_years_surgery_6,
    outpatient_cost_per_person_year_surgery_7 = outpatient_cost_surgery_7 / person_years_surgery_7,
    outpatient_cost_per_person_year_surgery_8 = outpatient_cost_surgery_8 / person_years_surgery_8,
    outpatient_cost_per_person_year_surgery_9 = outpatient_cost_surgery_9 / person_years_surgery_9,
    outpatient_cost_per_person_year_surgery_10 = outpatient_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(outpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
```




ED cost in patients with resective epilepsy surgery
```{r}
# ED cost in patients with resective epilepsy surgery
ED_adult_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="emergency") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
ED_adult_cost_resective_epilepsy_surgery




# ED cost per patient before and after surgery
adult_utilization_resective_epilepsy_surgery_ED_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="emergency") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


ED_adult_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(adult_utilization_resective_epilepsy_surgery_ED_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    ED_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_adult_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# ED cost per person-year by year before and after surgery
ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  adult_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(ED_adult_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    ED_cost_per_person_year_surgery_minus_1_5 = ED_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    ED_cost_per_person_year_surgery_0_1_5 = ED_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    ED_cost_per_person_year_surgery_1_5 = ED_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_ED_adult_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5)
Wilcoxon_test_ED_adult_cost_per_person_year_resective_epilepsy_surgery_1_5




# ED cost per patient by year in relationship to surgery
adult_utilization_resective_epilepsy_surgery_ED_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="emergency") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


ED_adult_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(adult_utilization_resective_epilepsy_surgery_ED_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    ED_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    ED_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      ED_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    ED_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_adult_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# ED cost per person-year by year
ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  adult_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(ED_adult_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    ED_cost_per_person_year_surgery_minus_10 = ED_cost_surgery_minus_10 / person_years_surgery_minus_10,
    ED_cost_per_person_year_surgery_minus_9 = ED_cost_surgery_minus_9 / person_years_surgery_minus_9,
    ED_cost_per_person_year_surgery_minus_8 = ED_cost_surgery_minus_8 / person_years_surgery_minus_8,
    ED_cost_per_person_year_surgery_minus_7 = ED_cost_surgery_minus_7 / person_years_surgery_minus_7,
    ED_cost_per_person_year_surgery_minus_6 = ED_cost_surgery_minus_6 / person_years_surgery_minus_6,
    ED_cost_per_person_year_surgery_minus_5 = ED_cost_surgery_minus_5 / person_years_surgery_minus_5,
    ED_cost_per_person_year_surgery_minus_4 = ED_cost_surgery_minus_4 / person_years_surgery_minus_4,
    ED_cost_per_person_year_surgery_minus_3 = ED_cost_surgery_minus_3 / person_years_surgery_minus_3,
    ED_cost_per_person_year_surgery_minus_2 = ED_cost_surgery_minus_2 / person_years_surgery_minus_2,
    ED_cost_per_person_year_surgery_minus_1 = ED_cost_surgery_minus_1 / person_years_surgery_minus_1,
    ED_cost_per_person_year_surgery_0 = ED_cost_surgery_0 / person_years_surgery_0,
    ED_cost_per_person_year_surgery_1 = ED_cost_surgery_1 / person_years_surgery_1,
    ED_cost_per_person_year_surgery_2 = ED_cost_surgery_2 / person_years_surgery_2,
    ED_cost_per_person_year_surgery_3 = ED_cost_surgery_3 / person_years_surgery_3,
    ED_cost_per_person_year_surgery_4 = ED_cost_surgery_4 / person_years_surgery_4,
    ED_cost_per_person_year_surgery_5 = ED_cost_surgery_5 / person_years_surgery_5,
    ED_cost_per_person_year_surgery_6 = ED_cost_surgery_6 / person_years_surgery_6,
    ED_cost_per_person_year_surgery_7 = ED_cost_surgery_7 / person_years_surgery_7,
    ED_cost_per_person_year_surgery_8 = ED_cost_surgery_8 / person_years_surgery_8,
    ED_cost_per_person_year_surgery_9 = ED_cost_surgery_9 / person_years_surgery_9,
    ED_cost_per_person_year_surgery_10 = ED_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(ED_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Inpatient cost in patients with resective epilepsy surgery
```{r}
# Inpatient cost in patients with resective epilepsy surgery
inpatient_adult_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="inpatient") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
inpatient_adult_cost_resective_epilepsy_surgery




# Inpatient cost per patient before and after surgery
adult_utilization_resective_epilepsy_surgery_inpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


inpatient_adult_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(adult_utilization_resective_epilepsy_surgery_inpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    inpatient_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    inpatient_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
inpatient_adult_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Inpatient cost per person-year by year before and after surgery
inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  adult_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(inpatient_adult_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    inpatient_cost_per_person_year_surgery_minus_1_5 = inpatient_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    inpatient_cost_per_person_year_surgery_0_1_5 = inpatient_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    inpatient_cost_per_person_year_surgery_1_5 = inpatient_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_inpatient_adult_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5)
Wilcoxon_test_inpatient_adult_cost_per_person_year_resective_epilepsy_surgery_1_5




# Inpatient cost per patient by year in relationship to surgery
adult_utilization_resective_epilepsy_surgery_inpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


inpatient_adult_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% adult_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(adult_utilization_resective_epilepsy_surgery_inpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    inpatient_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    inpatient_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    inpatient_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      inpatient_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    inpatient_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
inpatient_adult_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Inpatient cost per person-year by year
inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  adult_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(inpatient_adult_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    inpatient_cost_per_person_year_surgery_minus_10 = inpatient_cost_surgery_minus_10 / person_years_surgery_minus_10,
    inpatient_cost_per_person_year_surgery_minus_9 = inpatient_cost_surgery_minus_9 / person_years_surgery_minus_9,
    inpatient_cost_per_person_year_surgery_minus_8 = inpatient_cost_surgery_minus_8 / person_years_surgery_minus_8,
    inpatient_cost_per_person_year_surgery_minus_7 = inpatient_cost_surgery_minus_7 / person_years_surgery_minus_7,
    inpatient_cost_per_person_year_surgery_minus_6 = inpatient_cost_surgery_minus_6 / person_years_surgery_minus_6,
    inpatient_cost_per_person_year_surgery_minus_5 = inpatient_cost_surgery_minus_5 / person_years_surgery_minus_5,
    inpatient_cost_per_person_year_surgery_minus_4 = inpatient_cost_surgery_minus_4 / person_years_surgery_minus_4,
    inpatient_cost_per_person_year_surgery_minus_3 = inpatient_cost_surgery_minus_3 / person_years_surgery_minus_3,
    inpatient_cost_per_person_year_surgery_minus_2 = inpatient_cost_surgery_minus_2 / person_years_surgery_minus_2,
    inpatient_cost_per_person_year_surgery_minus_1 = inpatient_cost_surgery_minus_1 / person_years_surgery_minus_1,
    inpatient_cost_per_person_year_surgery_0 = inpatient_cost_surgery_0 / person_years_surgery_0,
    inpatient_cost_per_person_year_surgery_1 = inpatient_cost_surgery_1 / person_years_surgery_1,
    inpatient_cost_per_person_year_surgery_2 = inpatient_cost_surgery_2 / person_years_surgery_2,
    inpatient_cost_per_person_year_surgery_3 = inpatient_cost_surgery_3 / person_years_surgery_3,
    inpatient_cost_per_person_year_surgery_4 = inpatient_cost_surgery_4 / person_years_surgery_4,
    inpatient_cost_per_person_year_surgery_5 = inpatient_cost_surgery_5 / person_years_surgery_5,
    inpatient_cost_per_person_year_surgery_6 = inpatient_cost_surgery_6 / person_years_surgery_6,
    inpatient_cost_per_person_year_surgery_7 = inpatient_cost_surgery_7 / person_years_surgery_7,
    inpatient_cost_per_person_year_surgery_8 = inpatient_cost_surgery_8 / person_years_surgery_8,
    inpatient_cost_per_person_year_surgery_9 = inpatient_cost_surgery_9 / person_years_surgery_9,
    inpatient_cost_per_person_year_surgery_10 = inpatient_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(inpatient_adult_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
```








## 7. Clinical and economic outcomes in resective epilepsy surgery: Temporal versus extratemporal




Outpatient visits
```{r}
# Individual outpatient visits
temporal_outpatient_visit_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
temporal_outpatient_visit_resective_epilepsy_surgery_n 


# Individual patients with outpatient visits
patients_temporal_outpatient_visit_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_temporal_outpatient_visit_resective_epilepsy_surgery_n 


# Tally of patients with more than one outpatient visit
tally_temporal_outpatient_visit_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  tally(name="number_outpatient_visits")  %>% 
  group_by(number_outpatient_visits) %>% 
  tally(name="number_patients")
tally_temporal_outpatient_visit_resective_epilepsy_surgery




# Outpatient visits per patient before and after surgery
temporal_utilization_resective_epilepsy_surgery_outpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(outpatient_date = SVCDATE)

temporal_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(temporal_utilization_resective_epilepsy_surgery_outpatient, by="ENROLID") %>%
  select(ENROLID, outpatient_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_visits_surgery_minus_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(69))) & (outpatient_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    outpatient_visits_surgery_0_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(9))) & (outpatient_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),     
    outpatient_visits_surgery_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(3))) & (outpatient_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
temporal_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 
   

# Outpatient visits per person-year by year
temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(temporal_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    outpatient_visits_per_person_year_surgery_minus_1_5 = outpatient_visits_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    outpatient_visits_per_person_year_surgery_0_1_5 = outpatient_visits_surgery_0_1_5 / person_years_surgery_0_1_5,
    outpatient_visits_per_person_year_surgery_1_5 = outpatient_visits_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5, na.rm=TRUE)


# Statistical test
Wilcoxon_test_temporal_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5)
Wilcoxon_test_temporal_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5




# Outpatient visits per patient by year in relationship to surgery
temporal_utilization_resective_epilepsy_surgery_outpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(outpatient_date = SVCDATE)

temporal_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(temporal_utilization_resective_epilepsy_surgery_outpatient, by="ENROLID") %>%
  select(ENROLID, outpatient_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_visits_surgery_minus_10 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(129))) & (outpatient_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_9 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(117))) & (outpatient_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    outpatient_visits_surgery_minus_8 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(105))) & (outpatient_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),  
    outpatient_visits_surgery_minus_7 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(93))) & (outpatient_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_6 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(81))) & (outpatient_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(69))) & (outpatient_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_4 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(57))) & (outpatient_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_3 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(45))) & (outpatient_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_2 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(33))) & (outpatient_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_1 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(21))) & (outpatient_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_0 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(9))) & (outpatient_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      outpatient_visits_surgery_1 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(3))) & (outpatient_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_2 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(15))) & (outpatient_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_3 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(27))) & (outpatient_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_4 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(39))) & (outpatient_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(51))) & (outpatient_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_6 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(63))) & (outpatient_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_7 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(75))) & (outpatient_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_8 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(87))) & (outpatient_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_9 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(99))) & (outpatient_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE), 
    outpatient_visits_surgery_10 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(111))) & (outpatient_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
temporal_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery  
   

# Outpatient visits per person-year by year
temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(temporal_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    outpatient_visits_per_person_year_surgery_minus_10 = outpatient_visits_surgery_minus_10 / person_years_surgery_minus_10,
    outpatient_visits_per_person_year_surgery_minus_9 = outpatient_visits_surgery_minus_9 / person_years_surgery_minus_9,
    outpatient_visits_per_person_year_surgery_minus_8 = outpatient_visits_surgery_minus_8 / person_years_surgery_minus_8,
    outpatient_visits_per_person_year_surgery_minus_7 = outpatient_visits_surgery_minus_7 / person_years_surgery_minus_7,
    outpatient_visits_per_person_year_surgery_minus_6 = outpatient_visits_surgery_minus_6 / person_years_surgery_minus_6,
    outpatient_visits_per_person_year_surgery_minus_5 = outpatient_visits_surgery_minus_5 / person_years_surgery_minus_5,
    outpatient_visits_per_person_year_surgery_minus_4 = outpatient_visits_surgery_minus_4 / person_years_surgery_minus_4,
    outpatient_visits_per_person_year_surgery_minus_3 = outpatient_visits_surgery_minus_3 / person_years_surgery_minus_3,
    outpatient_visits_per_person_year_surgery_minus_2 = outpatient_visits_surgery_minus_2 / person_years_surgery_minus_2,
    outpatient_visits_per_person_year_surgery_minus_1 = outpatient_visits_surgery_minus_1 / person_years_surgery_minus_1,
    outpatient_visits_per_person_year_surgery_0 = outpatient_visits_surgery_0 / person_years_surgery_0,
    outpatient_visits_per_person_year_surgery_1 = outpatient_visits_surgery_1 / person_years_surgery_1,
    outpatient_visits_per_person_year_surgery_2 = outpatient_visits_surgery_2 / person_years_surgery_2,
    outpatient_visits_per_person_year_surgery_3 = outpatient_visits_surgery_3 / person_years_surgery_3,
    outpatient_visits_per_person_year_surgery_4 = outpatient_visits_surgery_4 / person_years_surgery_4,
    outpatient_visits_per_person_year_surgery_5 = outpatient_visits_surgery_5 / person_years_surgery_5,
    outpatient_visits_per_person_year_surgery_6 = outpatient_visits_surgery_6 / person_years_surgery_6,
    outpatient_visits_per_person_year_surgery_7 = outpatient_visits_surgery_7 / person_years_surgery_7,
    outpatient_visits_per_person_year_surgery_8 = outpatient_visits_surgery_8 / person_years_surgery_8,
    outpatient_visits_per_person_year_surgery_9 = outpatient_visits_surgery_9 / person_years_surgery_9,
    outpatient_visits_per_person_year_surgery_10 = outpatient_visits_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_0, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_0, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_1, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_1, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_2, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_2, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_3, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_3, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_4, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_4, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_5, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_5, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_6, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_6, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_7, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_7, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_8, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_8, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_9, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_9, na.rm=TRUE)

summary(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_10, na.rm=TRUE)
sd(temporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_10, na.rm=TRUE)
```




Emergency department visits
```{r}
# Individual emergency department visits
temporal_ED_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
temporal_ED_resective_epilepsy_surgery_n 


# Individual patients with ED visits
patients_temporal_ED_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_temporal_ED_resective_epilepsy_surgery_n 


# Tally of patients with more than one ED visit
tally_temporal_ED_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  tally(name="number_ED_visits")  %>% 
  group_by(number_ED_visits) %>% 
  tally(name="number_patients")
tally_temporal_ED_resective_epilepsy_surgery




# Emergency visits per patient by year in relationship to surgery before and after surgery
temporal_utilization_resective_epilepsy_surgery_emergency <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(ED_date = SVCDATE)

temporal_ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 <-
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(temporal_utilization_resective_epilepsy_surgery_emergency, by="ENROLID") %>%
  select(ENROLID, ED_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_visits_surgery_minus_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(69))) & (ED_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    ED_visits_surgery_0_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(9))) & (ED_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE), 
    ED_visits_surgery_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(3))) & (ED_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
temporal_ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5  
   

# ED visits per person-year by year before and after surgery
temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(temporal_ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    ED_visits_per_person_year_surgery_minus_1_5 = ED_visits_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    ED_visits_per_person_year_surgery_0_1_5 = ED_visits_surgery_0_1_5 / person_years_surgery_0_1_5,
    ED_visits_per_person_year_surgery_1_5 = ED_visits_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_temporal_ED_visits_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5)
Wilcoxon_test_temporal_ED_visits_per_person_year_resective_epilepsy_surgery_1_5




# Emergency visits per patient by year in relationship to surgery
temporal_utilization_resective_epilepsy_surgery_emergency <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(ED_date = SVCDATE)

temporal_ED_visits_by_year_per_patient_resective_epilepsy_surgery <-
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(temporal_utilization_resective_epilepsy_surgery_emergency, by="ENROLID") %>%
  select(ENROLID, ED_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_visits_surgery_minus_10 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(129))) & (ED_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_9 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(117))) & (ED_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    ED_visits_surgery_minus_8 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(105))) & (ED_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_7 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(93))) & (ED_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_6 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(81))) & (ED_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(69))) & (ED_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_4 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(57))) & (ED_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_3 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(45))) & (ED_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_2 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(33))) & (ED_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_1 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(21))) & (ED_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_0 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(9))) & (ED_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      ED_visits_surgery_1 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(3))) & (ED_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     ED_visits_surgery_2 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(15))) & (ED_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     ED_visits_surgery_3 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(27))) & (ED_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_4 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(39))) & (ED_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     ED_visits_surgery_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(51))) & (ED_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_6 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(63))) & (ED_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     ED_visits_surgery_7 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(75))) & (ED_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     ED_visits_surgery_8 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(87))) & (ED_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     ED_visits_surgery_9 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(99))) & (ED_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_10 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(111))) & (ED_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
temporal_ED_visits_by_year_per_patient_resective_epilepsy_surgery  
   

# ED visits per person-year by year
temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(temporal_ED_visits_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    ED_visits_per_person_year_surgery_minus_10 = ED_visits_surgery_minus_10 / person_years_surgery_minus_10,
    ED_visits_per_person_year_surgery_minus_9 = ED_visits_surgery_minus_9 / person_years_surgery_minus_9,
    ED_visits_per_person_year_surgery_minus_8 = ED_visits_surgery_minus_8 / person_years_surgery_minus_8,
    ED_visits_per_person_year_surgery_minus_7 = ED_visits_surgery_minus_7 / person_years_surgery_minus_7,
    ED_visits_per_person_year_surgery_minus_6 = ED_visits_surgery_minus_6 / person_years_surgery_minus_6,
    ED_visits_per_person_year_surgery_minus_5 = ED_visits_surgery_minus_5 / person_years_surgery_minus_5,
    ED_visits_per_person_year_surgery_minus_4 = ED_visits_surgery_minus_4 / person_years_surgery_minus_4,
    ED_visits_per_person_year_surgery_minus_3 = ED_visits_surgery_minus_3 / person_years_surgery_minus_3,
    ED_visits_per_person_year_surgery_minus_2 = ED_visits_surgery_minus_2 / person_years_surgery_minus_2,
    ED_visits_per_person_year_surgery_minus_1 = ED_visits_surgery_minus_1 / person_years_surgery_minus_1,
    ED_visits_per_person_year_surgery_0 = ED_visits_surgery_0 / person_years_surgery_0,
    ED_visits_per_person_year_surgery_1 = ED_visits_surgery_1 / person_years_surgery_1,
    ED_visits_per_person_year_surgery_2 = ED_visits_surgery_2 / person_years_surgery_2,
    ED_visits_per_person_year_surgery_3 = ED_visits_surgery_3 / person_years_surgery_3,
    ED_visits_per_person_year_surgery_4 = ED_visits_surgery_4 / person_years_surgery_4,
    ED_visits_per_person_year_surgery_5 = ED_visits_surgery_5 / person_years_surgery_5,
    ED_visits_per_person_year_surgery_6 = ED_visits_surgery_6 / person_years_surgery_6,
    ED_visits_per_person_year_surgery_7 = ED_visits_surgery_7 / person_years_surgery_7,
    ED_visits_per_person_year_surgery_8 = ED_visits_surgery_8 / person_years_surgery_8,
    ED_visits_per_person_year_surgery_9 = ED_visits_surgery_9 / person_years_surgery_9,
    ED_visits_per_person_year_surgery_10 = ED_visits_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_0, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_0, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_1, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_1, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_2, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_2, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_3, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_3, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_4, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_4, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_5, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_5, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_6, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_6, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_7, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_7, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_8, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_8, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_9, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_9, na.rm=TRUE)

summary(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_10, na.rm=TRUE)
sd(temporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_10, na.rm=TRUE)
```




Hospital admissions
```{r}
# Individual hospital admissions
temporal_hospital_admission_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
temporal_hospital_admission_resective_epilepsy_surgery_n 


# Individual patients with hospital admissions
patients_temporal_hospital_admission_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_temporal_hospital_admission_resective_epilepsy_surgery_n 


# Tally of patients with more than one hospital admission
tally_temporal_hospital_admission_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  tally(name="number_hospital_admissions")  %>% 
  group_by(number_hospital_admissions) %>% 
  tally(name="number_hospital_admissions")
tally_temporal_hospital_admission_resective_epilepsy_surgery




# Hospital admissions per patient before and after surgery
temporal_utilization_resective_epilepsy_surgery_inpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(hospital_admission_date = SVCDATE)

temporal_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(temporal_utilization_resective_epilepsy_surgery_inpatient, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    hospital_admissions_surgery_minus_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    hospital_admissions_surgery_0_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
temporal_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Hospital admissions per person-year by year
temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(temporal_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    hospital_admissions_per_person_year_surgery_minus_1_5 = hospital_admissions_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    hospital_admissions_per_person_year_surgery_0_1_5 = hospital_admissions_surgery_0_1_5 / person_years_surgery_0_1_5,
    hospital_admissions_per_person_year_surgery_1_5 = hospital_admissions_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_temporal_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5)
Wilcoxon_test_temporal_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5




# Hospital admissions per patient by year in relationship to surgery
temporal_utilization_resective_epilepsy_surgery_inpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(hospital_admission_date = SVCDATE)

temporal_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(temporal_utilization_resective_epilepsy_surgery_inpatient, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    hospital_admissions_surgery_minus_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(129))) & (hospital_admission_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(117))) & (hospital_admission_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    hospital_admissions_surgery_minus_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(105))) & (hospital_admission_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),  
    hospital_admissions_surgery_minus_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(93))) & (hospital_admission_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(81))) & (hospital_admission_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(57))) & (hospital_admission_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(45))) & (hospital_admission_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(33))) & (hospital_admission_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(21))) & (hospital_admission_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_0 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      hospital_admissions_surgery_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(15))) & (hospital_admission_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(27))) & (hospital_admission_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(39))) & (hospital_admission_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(51))) & (hospital_admission_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(63))) & (hospital_admission_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(75))) & (hospital_admission_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(87))) & (hospital_admission_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(99))) & (hospital_admission_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE), 
    hospital_admissions_surgery_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(111))) & (hospital_admission_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
temporal_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery  
   

# Hospital admissions per person-year by year
temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(temporal_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    hospital_admissions_per_person_year_surgery_minus_10 = hospital_admissions_surgery_minus_10 / person_years_surgery_minus_10,
    hospital_admissions_per_person_year_surgery_minus_9 = hospital_admissions_surgery_minus_9 / person_years_surgery_minus_9,
    hospital_admissions_per_person_year_surgery_minus_8 = hospital_admissions_surgery_minus_8 / person_years_surgery_minus_8,
    hospital_admissions_per_person_year_surgery_minus_7 = hospital_admissions_surgery_minus_7 / person_years_surgery_minus_7,
    hospital_admissions_per_person_year_surgery_minus_6 = hospital_admissions_surgery_minus_6 / person_years_surgery_minus_6,
    hospital_admissions_per_person_year_surgery_minus_5 = hospital_admissions_surgery_minus_5 / person_years_surgery_minus_5,
    hospital_admissions_per_person_year_surgery_minus_4 = hospital_admissions_surgery_minus_4 / person_years_surgery_minus_4,
    hospital_admissions_per_person_year_surgery_minus_3 = hospital_admissions_surgery_minus_3 / person_years_surgery_minus_3,
    hospital_admissions_per_person_year_surgery_minus_2 = hospital_admissions_surgery_minus_2 / person_years_surgery_minus_2,
    hospital_admissions_per_person_year_surgery_minus_1 = hospital_admissions_surgery_minus_1 / person_years_surgery_minus_1,
    hospital_admissions_per_person_year_surgery_0 = hospital_admissions_surgery_0 / person_years_surgery_0,
    hospital_admissions_per_person_year_surgery_1 = hospital_admissions_surgery_1 / person_years_surgery_1,
    hospital_admissions_per_person_year_surgery_2 = hospital_admissions_surgery_2 / person_years_surgery_2,
    hospital_admissions_per_person_year_surgery_3 = hospital_admissions_surgery_3 / person_years_surgery_3,
    hospital_admissions_per_person_year_surgery_4 = hospital_admissions_surgery_4 / person_years_surgery_4,
    hospital_admissions_per_person_year_surgery_5 = hospital_admissions_surgery_5 / person_years_surgery_5,
    hospital_admissions_per_person_year_surgery_6 = hospital_admissions_surgery_6 / person_years_surgery_6,
    hospital_admissions_per_person_year_surgery_7 = hospital_admissions_surgery_7 / person_years_surgery_7,
    hospital_admissions_per_person_year_surgery_8 = hospital_admissions_surgery_8 / person_years_surgery_8,
    hospital_admissions_per_person_year_surgery_9 = hospital_admissions_surgery_9 / person_years_surgery_9,
    hospital_admissions_per_person_year_surgery_10 = hospital_admissions_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_0, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_0, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_1, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_1, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_2, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_2, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_3, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_3, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_4, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_4, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_5, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_5, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_6, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_6, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_7, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_7, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_8, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_8, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_9, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_9, na.rm=TRUE)

summary(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_10, na.rm=TRUE)
sd(temporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_10, na.rm=TRUE)
```




Length of stay in hospital admissions for resective epilepsy surgery
```{r}
# Length of hospital stay in patients with resective epilepsy surgery
temporal_LOS_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  ungroup() %>% 
  summarize(total_LOS = sum(LOS))
temporal_LOS_resective_epilepsy_surgery




# Length of hospital stay per patient before and after surgery
temporal_utilization_resective_epilepsy_surgery_LOS <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE, LOS) %>% 
  rename(hospital_admission_date = SVCDATE)

temporal_LOS_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(temporal_utilization_resective_epilepsy_surgery_LOS, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date, LOS) %>%
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    LOS_surgery_minus_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(9)))), LOS, 0), na.rm=TRUE)/5,
    LOS_surgery_0_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(63)))), LOS, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
temporal_LOS_by_year_per_patient_resective_epilepsy_surgery_1_5  
   

# Length of stay per person-year by year before and after surgery
temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(temporal_LOS_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    LOS_per_person_year_surgery_minus_1_5 = LOS_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    LOS_per_person_year_surgery_0_1_5 = LOS_surgery_0_1_5 / person_years_surgery_0_1_5,
    LOS_per_person_year_surgery_1_5 = LOS_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_temporal_LOS_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5)
Wilcoxon_test_temporal_LOS_per_person_year_resective_epilepsy_surgery_1_5




# LOS per patient by year in relationship to surgery
temporal_utilization_resective_epilepsy_surgery_LOS <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE, LOS) %>% 
  rename(hospital_admission_date = SVCDATE)

temporal_LOS_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(temporal_utilization_resective_epilepsy_surgery_LOS, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date, LOS) %>%
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    LOS_surgery_minus_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(129))) & (hospital_admission_date < (surgery_date - months(117)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(117))) & (hospital_admission_date < (surgery_date - months(105)))), LOS, 0), na.rm=TRUE), 
    LOS_surgery_minus_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(105))) & (hospital_admission_date < (surgery_date - months(93)))), LOS, 0), na.rm=TRUE),  
    LOS_surgery_minus_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(93))) & (hospital_admission_date < (surgery_date - months(81)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(81))) & (hospital_admission_date < (surgery_date - months(69)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(57)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(57))) & (hospital_admission_date < (surgery_date - months(45)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(45))) & (hospital_admission_date < (surgery_date - months(33)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(33))) & (hospital_admission_date < (surgery_date - months(21)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(21))) & (hospital_admission_date < (surgery_date - months(9)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_0 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), LOS, 0), na.rm=TRUE),      LOS_surgery_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(15)))), LOS, 0), na.rm=TRUE),     LOS_surgery_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(15))) & (hospital_admission_date < (surgery_date + months(27)))), LOS, 0), na.rm=TRUE),     LOS_surgery_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(27))) & (hospital_admission_date < (surgery_date + months(39)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(39))) & (hospital_admission_date < (surgery_date + months(51)))), LOS, 0), na.rm=TRUE),     LOS_surgery_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(51))) & (hospital_admission_date < (surgery_date + months(63)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(63))) & (hospital_admission_date < (surgery_date + months(75)))), LOS, 0), na.rm=TRUE),     LOS_surgery_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(75))) & (hospital_admission_date < (surgery_date + months(87)))), LOS, 0), na.rm=TRUE),     LOS_surgery_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(87))) & (hospital_admission_date < (surgery_date + months(99)))), LOS, 0), na.rm=TRUE),     LOS_surgery_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(99))) & (hospital_admission_date < (surgery_date + months(111)))), LOS, 0), na.rm=TRUE), 
    LOS_surgery_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(111))) & (hospital_admission_date < (surgery_date + months(123)))), LOS, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
temporal_LOS_by_year_per_patient_resective_epilepsy_surgery  
   

# Length of stay per person-year by year
temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(temporal_LOS_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    LOS_per_person_year_surgery_minus_10 = LOS_surgery_minus_10 / person_years_surgery_minus_10,
    LOS_per_person_year_surgery_minus_9 = LOS_surgery_minus_9 / person_years_surgery_minus_9,
    LOS_per_person_year_surgery_minus_8 = LOS_surgery_minus_8 / person_years_surgery_minus_8,
    LOS_per_person_year_surgery_minus_7 = LOS_surgery_minus_7 / person_years_surgery_minus_7,
    LOS_per_person_year_surgery_minus_6 = LOS_surgery_minus_6 / person_years_surgery_minus_6,
    LOS_per_person_year_surgery_minus_5 = LOS_surgery_minus_5 / person_years_surgery_minus_5,
    LOS_per_person_year_surgery_minus_4 = LOS_surgery_minus_4 / person_years_surgery_minus_4,
    LOS_per_person_year_surgery_minus_3 = LOS_surgery_minus_3 / person_years_surgery_minus_3,
    LOS_per_person_year_surgery_minus_2 = LOS_surgery_minus_2 / person_years_surgery_minus_2,
    LOS_per_person_year_surgery_minus_1 = LOS_surgery_minus_1 / person_years_surgery_minus_1,
    LOS_per_person_year_surgery_0 = LOS_surgery_0 / person_years_surgery_0,
    LOS_per_person_year_surgery_1 = LOS_surgery_1 / person_years_surgery_1,
    LOS_per_person_year_surgery_2 = LOS_surgery_2 / person_years_surgery_2,
    LOS_per_person_year_surgery_3 = LOS_surgery_3 / person_years_surgery_3,
    LOS_per_person_year_surgery_4 = LOS_surgery_4 / person_years_surgery_4,
    LOS_per_person_year_surgery_5 = LOS_surgery_5 / person_years_surgery_5,
    LOS_per_person_year_surgery_6 = LOS_surgery_6 / person_years_surgery_6,
    LOS_per_person_year_surgery_7 = LOS_surgery_7 / person_years_surgery_7,
    LOS_per_person_year_surgery_8 = LOS_surgery_8 / person_years_surgery_8,
    LOS_per_person_year_surgery_9 = LOS_surgery_9 / person_years_surgery_9,
    LOS_per_person_year_surgery_10 = LOS_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_0, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_0, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_1, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_1, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_2, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_2, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_3, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_3, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_4, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_4, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_5, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_5, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_6, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_6, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_7, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_7, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_8, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_8, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_9, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_9, na.rm=TRUE)

summary(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_10, na.rm=TRUE)
sd(temporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_10, na.rm=TRUE)
```




Cost in patients with resective epilepsy surgery
```{r}
# Cost in patients with resective epilepsy surgery
temporal_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
temporal_cost_resective_epilepsy_surgery




# Cost per patient before and after surgery
temporal_utilization_resective_epilepsy_surgery_total_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


total_temporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(temporal_utilization_resective_epilepsy_surgery_total_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    total_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    total_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
total_temporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Total cost per person-year by year before and after surgery
total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(total_temporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    total_cost_per_person_year_surgery_minus_1_5 = total_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    total_cost_per_person_year_surgery_0_1_5 = total_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    total_cost_per_person_year_surgery_1_5 = total_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_temporal_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5)
Wilcoxon_test_temporal_cost_per_person_year_resective_epilepsy_surgery_1_5




# Total cost per patient by year in relationship to surgery
temporal_utilization_resective_epilepsy_surgery_total_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


total_temporal_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(temporal_utilization_resective_epilepsy_surgery_total_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    total_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    total_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    total_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      total_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    total_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
total_temporal_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Total cost per person-year by year
total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(total_temporal_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    total_cost_per_person_year_surgery_minus_10 = total_cost_surgery_minus_10 / person_years_surgery_minus_10,
    total_cost_per_person_year_surgery_minus_9 = total_cost_surgery_minus_9 / person_years_surgery_minus_9,
    total_cost_per_person_year_surgery_minus_8 = total_cost_surgery_minus_8 / person_years_surgery_minus_8,
    total_cost_per_person_year_surgery_minus_7 = total_cost_surgery_minus_7 / person_years_surgery_minus_7,
    total_cost_per_person_year_surgery_minus_6 = total_cost_surgery_minus_6 / person_years_surgery_minus_6,
    total_cost_per_person_year_surgery_minus_5 = total_cost_surgery_minus_5 / person_years_surgery_minus_5,
    total_cost_per_person_year_surgery_minus_4 = total_cost_surgery_minus_4 / person_years_surgery_minus_4,
    total_cost_per_person_year_surgery_minus_3 = total_cost_surgery_minus_3 / person_years_surgery_minus_3,
    total_cost_per_person_year_surgery_minus_2 = total_cost_surgery_minus_2 / person_years_surgery_minus_2,
    total_cost_per_person_year_surgery_minus_1 = total_cost_surgery_minus_1 / person_years_surgery_minus_1,
    total_cost_per_person_year_surgery_0 = total_cost_surgery_0 / person_years_surgery_0,
    total_cost_per_person_year_surgery_1 = total_cost_surgery_1 / person_years_surgery_1,
    total_cost_per_person_year_surgery_2 = total_cost_surgery_2 / person_years_surgery_2,
    total_cost_per_person_year_surgery_3 = total_cost_surgery_3 / person_years_surgery_3,
    total_cost_per_person_year_surgery_4 = total_cost_surgery_4 / person_years_surgery_4,
    total_cost_per_person_year_surgery_5 = total_cost_surgery_5 / person_years_surgery_5,
    total_cost_per_person_year_surgery_6 = total_cost_surgery_6 / person_years_surgery_6,
    total_cost_per_person_year_surgery_7 = total_cost_surgery_7 / person_years_surgery_7,
    total_cost_per_person_year_surgery_8 = total_cost_surgery_8 / person_years_surgery_8,
    total_cost_per_person_year_surgery_9 = total_cost_surgery_9 / person_years_surgery_9,
    total_cost_per_person_year_surgery_10 = total_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Total cost figure in patients with resective epilepsy surgery
```{r}
# Total cost figure
data_figure_total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- tibble(
  "year" = factor(c("Year -5", "Year -4", "Year -3", "Year -2", "Year -1", "Year surgery", "Year +1", "Year +2", "Year +3", "Year +4", "Year +5"), levels=c("Year -5", "Year -4", "Year -3", "Year -2", "Year -1", "Year surgery", "Year +1", "Year +2", "Year +3", "Year +4", "Year +5")),
  "median_cost" = c(summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[3],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[3],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[3],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[3],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[3],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[3],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[3],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[3],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[3],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[3],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[3]),
  "p25_cost" = c(summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[2],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[2],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[2],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[2],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[2],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[2],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[2],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[2],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[2],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[2],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[2]),  
  "p75_cost" = c(summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[5],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[5],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[5],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[5],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[5],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[5],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[5],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[5],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[5],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[5],
                  summary(total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[5])    
  )


figure_total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- ggplot(data=data_figure_total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery) + 
  geom_point(aes(x=year, y=median_cost), color="purple2", size=5) +
  geom_point(aes(x=year, y=p25_cost), color="darkgreen", size=4) +
  geom_point(aes(x=year, y=p75_cost), color="darkgreen", size=4) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=22, face="bold")) +
  scale_x_discrete(name="Year") +
  scale_y_continuous(name="Cost ($) per person-year", breaks=seq(0, 200000, 50000), limits = c(0, 200000))
figure_total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery
ggplotly(figure_total_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery)
```




Outpatient cost in patients with resective epilepsy surgery
```{r}
# Outpatient cost in patients with resective epilepsy surgery
outpatient_temporal_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="outpatient") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
outpatient_temporal_cost_resective_epilepsy_surgery




# Outpatient cost per patient before and after surgery
temporal_utilization_resective_epilepsy_surgery_outpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


outpatient_temporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(temporal_utilization_resective_epilepsy_surgery_outpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    outpatient_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_temporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Outpatient cost per person-year by year before and after surgery
outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(outpatient_temporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    outpatient_cost_per_person_year_surgery_minus_1_5 = outpatient_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    outpatient_cost_per_person_year_surgery_0_1_5 = outpatient_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    outpatient_cost_per_person_year_surgery_1_5 = outpatient_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_outpatient_temporal_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5)
Wilcoxon_test_outpatient_temporal_cost_per_person_year_resective_epilepsy_surgery_1_5




# Outpatient cost per patient by year in relationship to surgery
temporal_utilization_resective_epilepsy_surgery_outpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


outpatient_temporal_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(temporal_utilization_resective_epilepsy_surgery_outpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    outpatient_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    outpatient_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      outpatient_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    outpatient_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_temporal_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Outpatient cost per person-year by year
outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(outpatient_temporal_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    outpatient_cost_per_person_year_surgery_minus_10 = outpatient_cost_surgery_minus_10 / person_years_surgery_minus_10,
    outpatient_cost_per_person_year_surgery_minus_9 = outpatient_cost_surgery_minus_9 / person_years_surgery_minus_9,
    outpatient_cost_per_person_year_surgery_minus_8 = outpatient_cost_surgery_minus_8 / person_years_surgery_minus_8,
    outpatient_cost_per_person_year_surgery_minus_7 = outpatient_cost_surgery_minus_7 / person_years_surgery_minus_7,
    outpatient_cost_per_person_year_surgery_minus_6 = outpatient_cost_surgery_minus_6 / person_years_surgery_minus_6,
    outpatient_cost_per_person_year_surgery_minus_5 = outpatient_cost_surgery_minus_5 / person_years_surgery_minus_5,
    outpatient_cost_per_person_year_surgery_minus_4 = outpatient_cost_surgery_minus_4 / person_years_surgery_minus_4,
    outpatient_cost_per_person_year_surgery_minus_3 = outpatient_cost_surgery_minus_3 / person_years_surgery_minus_3,
    outpatient_cost_per_person_year_surgery_minus_2 = outpatient_cost_surgery_minus_2 / person_years_surgery_minus_2,
    outpatient_cost_per_person_year_surgery_minus_1 = outpatient_cost_surgery_minus_1 / person_years_surgery_minus_1,
    outpatient_cost_per_person_year_surgery_0 = outpatient_cost_surgery_0 / person_years_surgery_0,
    outpatient_cost_per_person_year_surgery_1 = outpatient_cost_surgery_1 / person_years_surgery_1,
    outpatient_cost_per_person_year_surgery_2 = outpatient_cost_surgery_2 / person_years_surgery_2,
    outpatient_cost_per_person_year_surgery_3 = outpatient_cost_surgery_3 / person_years_surgery_3,
    outpatient_cost_per_person_year_surgery_4 = outpatient_cost_surgery_4 / person_years_surgery_4,
    outpatient_cost_per_person_year_surgery_5 = outpatient_cost_surgery_5 / person_years_surgery_5,
    outpatient_cost_per_person_year_surgery_6 = outpatient_cost_surgery_6 / person_years_surgery_6,
    outpatient_cost_per_person_year_surgery_7 = outpatient_cost_surgery_7 / person_years_surgery_7,
    outpatient_cost_per_person_year_surgery_8 = outpatient_cost_surgery_8 / person_years_surgery_8,
    outpatient_cost_per_person_year_surgery_9 = outpatient_cost_surgery_9 / person_years_surgery_9,
    outpatient_cost_per_person_year_surgery_10 = outpatient_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(outpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
```




ED cost in patients with resective epilepsy surgery
```{r}
# ED cost in patients with resective epilepsy surgery
ED_temporal_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="emergency") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
ED_temporal_cost_resective_epilepsy_surgery




# ED cost per patient before and after surgery
temporal_utilization_resective_epilepsy_surgery_ED_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="emergency") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


ED_temporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(temporal_utilization_resective_epilepsy_surgery_ED_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    ED_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_temporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# ED cost per person-year by year before and after surgery
ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(ED_temporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    ED_cost_per_person_year_surgery_minus_1_5 = ED_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    ED_cost_per_person_year_surgery_0_1_5 = ED_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    ED_cost_per_person_year_surgery_1_5 = ED_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_ED_temporal_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5)
Wilcoxon_test_ED_temporal_cost_per_person_year_resective_epilepsy_surgery_1_5




# ED cost per patient by year in relationship to surgery
temporal_utilization_resective_epilepsy_surgery_ED_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="emergency") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


ED_temporal_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(temporal_utilization_resective_epilepsy_surgery_ED_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    ED_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    ED_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      ED_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    ED_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_temporal_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# ED cost per person-year by year
ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(ED_temporal_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    ED_cost_per_person_year_surgery_minus_10 = ED_cost_surgery_minus_10 / person_years_surgery_minus_10,
    ED_cost_per_person_year_surgery_minus_9 = ED_cost_surgery_minus_9 / person_years_surgery_minus_9,
    ED_cost_per_person_year_surgery_minus_8 = ED_cost_surgery_minus_8 / person_years_surgery_minus_8,
    ED_cost_per_person_year_surgery_minus_7 = ED_cost_surgery_minus_7 / person_years_surgery_minus_7,
    ED_cost_per_person_year_surgery_minus_6 = ED_cost_surgery_minus_6 / person_years_surgery_minus_6,
    ED_cost_per_person_year_surgery_minus_5 = ED_cost_surgery_minus_5 / person_years_surgery_minus_5,
    ED_cost_per_person_year_surgery_minus_4 = ED_cost_surgery_minus_4 / person_years_surgery_minus_4,
    ED_cost_per_person_year_surgery_minus_3 = ED_cost_surgery_minus_3 / person_years_surgery_minus_3,
    ED_cost_per_person_year_surgery_minus_2 = ED_cost_surgery_minus_2 / person_years_surgery_minus_2,
    ED_cost_per_person_year_surgery_minus_1 = ED_cost_surgery_minus_1 / person_years_surgery_minus_1,
    ED_cost_per_person_year_surgery_0 = ED_cost_surgery_0 / person_years_surgery_0,
    ED_cost_per_person_year_surgery_1 = ED_cost_surgery_1 / person_years_surgery_1,
    ED_cost_per_person_year_surgery_2 = ED_cost_surgery_2 / person_years_surgery_2,
    ED_cost_per_person_year_surgery_3 = ED_cost_surgery_3 / person_years_surgery_3,
    ED_cost_per_person_year_surgery_4 = ED_cost_surgery_4 / person_years_surgery_4,
    ED_cost_per_person_year_surgery_5 = ED_cost_surgery_5 / person_years_surgery_5,
    ED_cost_per_person_year_surgery_6 = ED_cost_surgery_6 / person_years_surgery_6,
    ED_cost_per_person_year_surgery_7 = ED_cost_surgery_7 / person_years_surgery_7,
    ED_cost_per_person_year_surgery_8 = ED_cost_surgery_8 / person_years_surgery_8,
    ED_cost_per_person_year_surgery_9 = ED_cost_surgery_9 / person_years_surgery_9,
    ED_cost_per_person_year_surgery_10 = ED_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(ED_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Inpatient cost in patients with resective epilepsy surgery
```{r}
# Inpatient cost in patients with resective epilepsy surgery
inpatient_temporal_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="inpatient") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
inpatient_temporal_cost_resective_epilepsy_surgery




# Inpatient cost per patient before and after surgery
temporal_utilization_resective_epilepsy_surgery_inpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


inpatient_temporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(temporal_utilization_resective_epilepsy_surgery_inpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    inpatient_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    inpatient_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
inpatient_temporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Inpatient cost per person-year by year before and after surgery
inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(inpatient_temporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    inpatient_cost_per_person_year_surgery_minus_1_5 = inpatient_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    inpatient_cost_per_person_year_surgery_0_1_5 = inpatient_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    inpatient_cost_per_person_year_surgery_1_5 = inpatient_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_inpatient_temporal_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5)
Wilcoxon_test_inpatient_temporal_cost_per_person_year_resective_epilepsy_surgery_1_5




# Inpatient cost per patient by year in relationship to surgery
temporal_utilization_resective_epilepsy_surgery_inpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


inpatient_temporal_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% temporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(temporal_utilization_resective_epilepsy_surgery_inpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    inpatient_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    inpatient_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    inpatient_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      inpatient_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    inpatient_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
inpatient_temporal_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Inpatient cost per person-year by year
inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  temporal_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(inpatient_temporal_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    inpatient_cost_per_person_year_surgery_minus_10 = inpatient_cost_surgery_minus_10 / person_years_surgery_minus_10,
    inpatient_cost_per_person_year_surgery_minus_9 = inpatient_cost_surgery_minus_9 / person_years_surgery_minus_9,
    inpatient_cost_per_person_year_surgery_minus_8 = inpatient_cost_surgery_minus_8 / person_years_surgery_minus_8,
    inpatient_cost_per_person_year_surgery_minus_7 = inpatient_cost_surgery_minus_7 / person_years_surgery_minus_7,
    inpatient_cost_per_person_year_surgery_minus_6 = inpatient_cost_surgery_minus_6 / person_years_surgery_minus_6,
    inpatient_cost_per_person_year_surgery_minus_5 = inpatient_cost_surgery_minus_5 / person_years_surgery_minus_5,
    inpatient_cost_per_person_year_surgery_minus_4 = inpatient_cost_surgery_minus_4 / person_years_surgery_minus_4,
    inpatient_cost_per_person_year_surgery_minus_3 = inpatient_cost_surgery_minus_3 / person_years_surgery_minus_3,
    inpatient_cost_per_person_year_surgery_minus_2 = inpatient_cost_surgery_minus_2 / person_years_surgery_minus_2,
    inpatient_cost_per_person_year_surgery_minus_1 = inpatient_cost_surgery_minus_1 / person_years_surgery_minus_1,
    inpatient_cost_per_person_year_surgery_0 = inpatient_cost_surgery_0 / person_years_surgery_0,
    inpatient_cost_per_person_year_surgery_1 = inpatient_cost_surgery_1 / person_years_surgery_1,
    inpatient_cost_per_person_year_surgery_2 = inpatient_cost_surgery_2 / person_years_surgery_2,
    inpatient_cost_per_person_year_surgery_3 = inpatient_cost_surgery_3 / person_years_surgery_3,
    inpatient_cost_per_person_year_surgery_4 = inpatient_cost_surgery_4 / person_years_surgery_4,
    inpatient_cost_per_person_year_surgery_5 = inpatient_cost_surgery_5 / person_years_surgery_5,
    inpatient_cost_per_person_year_surgery_6 = inpatient_cost_surgery_6 / person_years_surgery_6,
    inpatient_cost_per_person_year_surgery_7 = inpatient_cost_surgery_7 / person_years_surgery_7,
    inpatient_cost_per_person_year_surgery_8 = inpatient_cost_surgery_8 / person_years_surgery_8,
    inpatient_cost_per_person_year_surgery_9 = inpatient_cost_surgery_9 / person_years_surgery_9,
    inpatient_cost_per_person_year_surgery_10 = inpatient_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(inpatient_temporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Outpatient visits
```{r}
# Individual outpatient visits
extratemporal_outpatient_visit_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
extratemporal_outpatient_visit_resective_epilepsy_surgery_n 


# Individual patients with outpatient visits
patients_extratemporal_outpatient_visit_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_extratemporal_outpatient_visit_resective_epilepsy_surgery_n 


# Tally of patients with more than one outpatient visit
tally_extratemporal_outpatient_visit_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  tally(name="number_outpatient_visits")  %>% 
  group_by(number_outpatient_visits) %>% 
  tally(name="number_patients")
tally_extratemporal_outpatient_visit_resective_epilepsy_surgery




# Outpatient visits per patient before and after surgery
extratemporal_utilization_resective_epilepsy_surgery_outpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(outpatient_date = SVCDATE)

extratemporal_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(extratemporal_utilization_resective_epilepsy_surgery_outpatient, by="ENROLID") %>%
  select(ENROLID, outpatient_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_visits_surgery_minus_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(69))) & (outpatient_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    outpatient_visits_surgery_0_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(9))) & (outpatient_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),     
    outpatient_visits_surgery_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(3))) & (outpatient_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
extratemporal_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 
   

# Outpatient visits per person-year by year
extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(extratemporal_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    outpatient_visits_per_person_year_surgery_minus_1_5 = outpatient_visits_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    outpatient_visits_per_person_year_surgery_0_1_5 = outpatient_visits_surgery_0_1_5 / person_years_surgery_0_1_5,
    outpatient_visits_per_person_year_surgery_1_5 = outpatient_visits_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5, na.rm=TRUE)


# Statistical test
Wilcoxon_test_extratemporal_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5)
Wilcoxon_test_extratemporal_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5




# Outpatient visits per patient by year in relationship to surgery
extratemporal_utilization_resective_epilepsy_surgery_outpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(outpatient_date = SVCDATE)

extratemporal_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(extratemporal_utilization_resective_epilepsy_surgery_outpatient, by="ENROLID") %>%
  select(ENROLID, outpatient_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_visits_surgery_minus_10 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(129))) & (outpatient_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_9 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(117))) & (outpatient_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    outpatient_visits_surgery_minus_8 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(105))) & (outpatient_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),  
    outpatient_visits_surgery_minus_7 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(93))) & (outpatient_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_6 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(81))) & (outpatient_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(69))) & (outpatient_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_4 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(57))) & (outpatient_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_3 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(45))) & (outpatient_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_2 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(33))) & (outpatient_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_1 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(21))) & (outpatient_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_0 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(9))) & (outpatient_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      outpatient_visits_surgery_1 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(3))) & (outpatient_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_2 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(15))) & (outpatient_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_3 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(27))) & (outpatient_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_4 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(39))) & (outpatient_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(51))) & (outpatient_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_6 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(63))) & (outpatient_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_7 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(75))) & (outpatient_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_8 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(87))) & (outpatient_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_9 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(99))) & (outpatient_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE), 
    outpatient_visits_surgery_10 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(111))) & (outpatient_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
extratemporal_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery  
   

# Outpatient visits per person-year by year
extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(extratemporal_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    outpatient_visits_per_person_year_surgery_minus_10 = outpatient_visits_surgery_minus_10 / person_years_surgery_minus_10,
    outpatient_visits_per_person_year_surgery_minus_9 = outpatient_visits_surgery_minus_9 / person_years_surgery_minus_9,
    outpatient_visits_per_person_year_surgery_minus_8 = outpatient_visits_surgery_minus_8 / person_years_surgery_minus_8,
    outpatient_visits_per_person_year_surgery_minus_7 = outpatient_visits_surgery_minus_7 / person_years_surgery_minus_7,
    outpatient_visits_per_person_year_surgery_minus_6 = outpatient_visits_surgery_minus_6 / person_years_surgery_minus_6,
    outpatient_visits_per_person_year_surgery_minus_5 = outpatient_visits_surgery_minus_5 / person_years_surgery_minus_5,
    outpatient_visits_per_person_year_surgery_minus_4 = outpatient_visits_surgery_minus_4 / person_years_surgery_minus_4,
    outpatient_visits_per_person_year_surgery_minus_3 = outpatient_visits_surgery_minus_3 / person_years_surgery_minus_3,
    outpatient_visits_per_person_year_surgery_minus_2 = outpatient_visits_surgery_minus_2 / person_years_surgery_minus_2,
    outpatient_visits_per_person_year_surgery_minus_1 = outpatient_visits_surgery_minus_1 / person_years_surgery_minus_1,
    outpatient_visits_per_person_year_surgery_0 = outpatient_visits_surgery_0 / person_years_surgery_0,
    outpatient_visits_per_person_year_surgery_1 = outpatient_visits_surgery_1 / person_years_surgery_1,
    outpatient_visits_per_person_year_surgery_2 = outpatient_visits_surgery_2 / person_years_surgery_2,
    outpatient_visits_per_person_year_surgery_3 = outpatient_visits_surgery_3 / person_years_surgery_3,
    outpatient_visits_per_person_year_surgery_4 = outpatient_visits_surgery_4 / person_years_surgery_4,
    outpatient_visits_per_person_year_surgery_5 = outpatient_visits_surgery_5 / person_years_surgery_5,
    outpatient_visits_per_person_year_surgery_6 = outpatient_visits_surgery_6 / person_years_surgery_6,
    outpatient_visits_per_person_year_surgery_7 = outpatient_visits_surgery_7 / person_years_surgery_7,
    outpatient_visits_per_person_year_surgery_8 = outpatient_visits_surgery_8 / person_years_surgery_8,
    outpatient_visits_per_person_year_surgery_9 = outpatient_visits_surgery_9 / person_years_surgery_9,
    outpatient_visits_per_person_year_surgery_10 = outpatient_visits_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_0, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_0, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_1, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_1, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_2, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_2, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_3, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_3, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_4, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_4, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_5, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_5, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_6, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_6, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_7, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_7, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_8, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_8, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_9, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_9, na.rm=TRUE)

summary(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_10, na.rm=TRUE)
sd(extratemporal_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_10, na.rm=TRUE)
```




Emergency department visits
```{r}
# Individual emergency department visits
extratemporal_ED_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
extratemporal_ED_resective_epilepsy_surgery_n 


# Individual patients with ED visits
patients_extratemporal_ED_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_extratemporal_ED_resective_epilepsy_surgery_n 


# Tally of patients with more than one ED visit
tally_extratemporal_ED_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  tally(name="number_ED_visits")  %>% 
  group_by(number_ED_visits) %>% 
  tally(name="number_patients")
tally_extratemporal_ED_resective_epilepsy_surgery




# Emergency visits per patient by year in relationship to surgery before and after surgery
extratemporal_utilization_resective_epilepsy_surgery_emergency <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(ED_date = SVCDATE)

extratemporal_ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 <-
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(extratemporal_utilization_resective_epilepsy_surgery_emergency, by="ENROLID") %>%
  select(ENROLID, ED_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_visits_surgery_minus_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(69))) & (ED_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    ED_visits_surgery_0_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(9))) & (ED_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE), 
    ED_visits_surgery_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(3))) & (ED_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
extratemporal_ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5  
   

# ED visits per person-year by year before and after surgery
extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(extratemporal_ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    ED_visits_per_person_year_surgery_minus_1_5 = ED_visits_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    ED_visits_per_person_year_surgery_0_1_5 = ED_visits_surgery_0_1_5 / person_years_surgery_0_1_5,
    ED_visits_per_person_year_surgery_1_5 = ED_visits_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_extratemporal_ED_visits_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5)
Wilcoxon_test_extratemporal_ED_visits_per_person_year_resective_epilepsy_surgery_1_5




# Emergency visits per patient by year in relationship to surgery
extratemporal_utilization_resective_epilepsy_surgery_emergency <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(ED_date = SVCDATE)

extratemporal_ED_visits_by_year_per_patient_resective_epilepsy_surgery <-
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(extratemporal_utilization_resective_epilepsy_surgery_emergency, by="ENROLID") %>%
  select(ENROLID, ED_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_visits_surgery_minus_10 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(129))) & (ED_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_9 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(117))) & (ED_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    ED_visits_surgery_minus_8 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(105))) & (ED_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_7 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(93))) & (ED_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_6 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(81))) & (ED_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(69))) & (ED_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_4 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(57))) & (ED_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_3 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(45))) & (ED_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_2 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(33))) & (ED_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_1 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(21))) & (ED_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_0 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(9))) & (ED_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      ED_visits_surgery_1 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(3))) & (ED_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     ED_visits_surgery_2 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(15))) & (ED_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     ED_visits_surgery_3 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(27))) & (ED_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_4 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(39))) & (ED_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     ED_visits_surgery_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(51))) & (ED_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_6 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(63))) & (ED_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     ED_visits_surgery_7 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(75))) & (ED_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     ED_visits_surgery_8 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(87))) & (ED_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     ED_visits_surgery_9 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(99))) & (ED_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_10 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(111))) & (ED_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
extratemporal_ED_visits_by_year_per_patient_resective_epilepsy_surgery  
   

# ED visits per person-year by year
extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(extratemporal_ED_visits_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    ED_visits_per_person_year_surgery_minus_10 = ED_visits_surgery_minus_10 / person_years_surgery_minus_10,
    ED_visits_per_person_year_surgery_minus_9 = ED_visits_surgery_minus_9 / person_years_surgery_minus_9,
    ED_visits_per_person_year_surgery_minus_8 = ED_visits_surgery_minus_8 / person_years_surgery_minus_8,
    ED_visits_per_person_year_surgery_minus_7 = ED_visits_surgery_minus_7 / person_years_surgery_minus_7,
    ED_visits_per_person_year_surgery_minus_6 = ED_visits_surgery_minus_6 / person_years_surgery_minus_6,
    ED_visits_per_person_year_surgery_minus_5 = ED_visits_surgery_minus_5 / person_years_surgery_minus_5,
    ED_visits_per_person_year_surgery_minus_4 = ED_visits_surgery_minus_4 / person_years_surgery_minus_4,
    ED_visits_per_person_year_surgery_minus_3 = ED_visits_surgery_minus_3 / person_years_surgery_minus_3,
    ED_visits_per_person_year_surgery_minus_2 = ED_visits_surgery_minus_2 / person_years_surgery_minus_2,
    ED_visits_per_person_year_surgery_minus_1 = ED_visits_surgery_minus_1 / person_years_surgery_minus_1,
    ED_visits_per_person_year_surgery_0 = ED_visits_surgery_0 / person_years_surgery_0,
    ED_visits_per_person_year_surgery_1 = ED_visits_surgery_1 / person_years_surgery_1,
    ED_visits_per_person_year_surgery_2 = ED_visits_surgery_2 / person_years_surgery_2,
    ED_visits_per_person_year_surgery_3 = ED_visits_surgery_3 / person_years_surgery_3,
    ED_visits_per_person_year_surgery_4 = ED_visits_surgery_4 / person_years_surgery_4,
    ED_visits_per_person_year_surgery_5 = ED_visits_surgery_5 / person_years_surgery_5,
    ED_visits_per_person_year_surgery_6 = ED_visits_surgery_6 / person_years_surgery_6,
    ED_visits_per_person_year_surgery_7 = ED_visits_surgery_7 / person_years_surgery_7,
    ED_visits_per_person_year_surgery_8 = ED_visits_surgery_8 / person_years_surgery_8,
    ED_visits_per_person_year_surgery_9 = ED_visits_surgery_9 / person_years_surgery_9,
    ED_visits_per_person_year_surgery_10 = ED_visits_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_0, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_0, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_1, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_1, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_2, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_2, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_3, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_3, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_4, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_4, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_5, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_5, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_6, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_6, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_7, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_7, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_8, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_8, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_9, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_9, na.rm=TRUE)

summary(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_10, na.rm=TRUE)
sd(extratemporal_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_10, na.rm=TRUE)
```




Hospital admissions
```{r}
# Individual hospital admissions
extratemporal_hospital_admission_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
extratemporal_hospital_admission_resective_epilepsy_surgery_n 


# Individual patients with hospital admissions
patients_extratemporal_hospital_admission_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_extratemporal_hospital_admission_resective_epilepsy_surgery_n 


# Tally of patients with more than one hospital admission
tally_extratemporal_hospital_admission_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  tally(name="number_hospital_admissions")  %>% 
  group_by(number_hospital_admissions) %>% 
  tally(name="number_hospital_admissions")
tally_extratemporal_hospital_admission_resective_epilepsy_surgery




# Hospital admissions per patient before and after surgery
extratemporal_utilization_resective_epilepsy_surgery_inpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(hospital_admission_date = SVCDATE)

extratemporal_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(extratemporal_utilization_resective_epilepsy_surgery_inpatient, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    hospital_admissions_surgery_minus_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    hospital_admissions_surgery_0_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
extratemporal_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Hospital admissions per person-year by year
extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(extratemporal_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    hospital_admissions_per_person_year_surgery_minus_1_5 = hospital_admissions_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    hospital_admissions_per_person_year_surgery_0_1_5 = hospital_admissions_surgery_0_1_5 / person_years_surgery_0_1_5,
    hospital_admissions_per_person_year_surgery_1_5 = hospital_admissions_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_extratemporal_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5)
Wilcoxon_test_extratemporal_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5




# Hospital admissions per patient by year in relationship to surgery
extratemporal_utilization_resective_epilepsy_surgery_inpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(hospital_admission_date = SVCDATE)

extratemporal_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(extratemporal_utilization_resective_epilepsy_surgery_inpatient, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    hospital_admissions_surgery_minus_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(129))) & (hospital_admission_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(117))) & (hospital_admission_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    hospital_admissions_surgery_minus_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(105))) & (hospital_admission_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),  
    hospital_admissions_surgery_minus_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(93))) & (hospital_admission_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(81))) & (hospital_admission_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(57))) & (hospital_admission_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(45))) & (hospital_admission_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(33))) & (hospital_admission_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(21))) & (hospital_admission_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_0 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      hospital_admissions_surgery_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(15))) & (hospital_admission_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(27))) & (hospital_admission_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(39))) & (hospital_admission_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(51))) & (hospital_admission_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(63))) & (hospital_admission_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(75))) & (hospital_admission_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(87))) & (hospital_admission_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(99))) & (hospital_admission_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE), 
    hospital_admissions_surgery_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(111))) & (hospital_admission_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
extratemporal_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery  
   

# Hospital admissions per person-year by year
extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(extratemporal_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    hospital_admissions_per_person_year_surgery_minus_10 = hospital_admissions_surgery_minus_10 / person_years_surgery_minus_10,
    hospital_admissions_per_person_year_surgery_minus_9 = hospital_admissions_surgery_minus_9 / person_years_surgery_minus_9,
    hospital_admissions_per_person_year_surgery_minus_8 = hospital_admissions_surgery_minus_8 / person_years_surgery_minus_8,
    hospital_admissions_per_person_year_surgery_minus_7 = hospital_admissions_surgery_minus_7 / person_years_surgery_minus_7,
    hospital_admissions_per_person_year_surgery_minus_6 = hospital_admissions_surgery_minus_6 / person_years_surgery_minus_6,
    hospital_admissions_per_person_year_surgery_minus_5 = hospital_admissions_surgery_minus_5 / person_years_surgery_minus_5,
    hospital_admissions_per_person_year_surgery_minus_4 = hospital_admissions_surgery_minus_4 / person_years_surgery_minus_4,
    hospital_admissions_per_person_year_surgery_minus_3 = hospital_admissions_surgery_minus_3 / person_years_surgery_minus_3,
    hospital_admissions_per_person_year_surgery_minus_2 = hospital_admissions_surgery_minus_2 / person_years_surgery_minus_2,
    hospital_admissions_per_person_year_surgery_minus_1 = hospital_admissions_surgery_minus_1 / person_years_surgery_minus_1,
    hospital_admissions_per_person_year_surgery_0 = hospital_admissions_surgery_0 / person_years_surgery_0,
    hospital_admissions_per_person_year_surgery_1 = hospital_admissions_surgery_1 / person_years_surgery_1,
    hospital_admissions_per_person_year_surgery_2 = hospital_admissions_surgery_2 / person_years_surgery_2,
    hospital_admissions_per_person_year_surgery_3 = hospital_admissions_surgery_3 / person_years_surgery_3,
    hospital_admissions_per_person_year_surgery_4 = hospital_admissions_surgery_4 / person_years_surgery_4,
    hospital_admissions_per_person_year_surgery_5 = hospital_admissions_surgery_5 / person_years_surgery_5,
    hospital_admissions_per_person_year_surgery_6 = hospital_admissions_surgery_6 / person_years_surgery_6,
    hospital_admissions_per_person_year_surgery_7 = hospital_admissions_surgery_7 / person_years_surgery_7,
    hospital_admissions_per_person_year_surgery_8 = hospital_admissions_surgery_8 / person_years_surgery_8,
    hospital_admissions_per_person_year_surgery_9 = hospital_admissions_surgery_9 / person_years_surgery_9,
    hospital_admissions_per_person_year_surgery_10 = hospital_admissions_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_0, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_0, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_1, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_1, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_2, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_2, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_3, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_3, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_4, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_4, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_5, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_5, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_6, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_6, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_7, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_7, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_8, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_8, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_9, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_9, na.rm=TRUE)

summary(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_10, na.rm=TRUE)
sd(extratemporal_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_10, na.rm=TRUE)
```




Length of stay in hospital admissions for resective epilepsy surgery
```{r}
# Length of hospital stay in patients with resective epilepsy surgery
extratemporal_LOS_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  ungroup() %>% 
  summarize(total_LOS = sum(LOS))
extratemporal_LOS_resective_epilepsy_surgery




# Length of hospital stay per patient before and after surgery
extratemporal_utilization_resective_epilepsy_surgery_LOS <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE, LOS) %>% 
  rename(hospital_admission_date = SVCDATE)

extratemporal_LOS_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(extratemporal_utilization_resective_epilepsy_surgery_LOS, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date, LOS) %>%
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    LOS_surgery_minus_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(9)))), LOS, 0), na.rm=TRUE)/5,
    LOS_surgery_0_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(63)))), LOS, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
extratemporal_LOS_by_year_per_patient_resective_epilepsy_surgery_1_5  
   

# Length of stay per person-year by year before and after surgery
extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(extratemporal_LOS_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    LOS_per_person_year_surgery_minus_1_5 = LOS_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    LOS_per_person_year_surgery_0_1_5 = LOS_surgery_0_1_5 / person_years_surgery_0_1_5,
    LOS_per_person_year_surgery_1_5 = LOS_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_extratemporal_LOS_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5)
Wilcoxon_test_extratemporal_LOS_per_person_year_resective_epilepsy_surgery_1_5




# LOS per patient by year in relationship to surgery
extratemporal_utilization_resective_epilepsy_surgery_LOS <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE, LOS) %>% 
  rename(hospital_admission_date = SVCDATE)

extratemporal_LOS_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(extratemporal_utilization_resective_epilepsy_surgery_LOS, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date, LOS) %>%
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    LOS_surgery_minus_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(129))) & (hospital_admission_date < (surgery_date - months(117)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(117))) & (hospital_admission_date < (surgery_date - months(105)))), LOS, 0), na.rm=TRUE), 
    LOS_surgery_minus_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(105))) & (hospital_admission_date < (surgery_date - months(93)))), LOS, 0), na.rm=TRUE),  
    LOS_surgery_minus_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(93))) & (hospital_admission_date < (surgery_date - months(81)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(81))) & (hospital_admission_date < (surgery_date - months(69)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(57)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(57))) & (hospital_admission_date < (surgery_date - months(45)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(45))) & (hospital_admission_date < (surgery_date - months(33)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(33))) & (hospital_admission_date < (surgery_date - months(21)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(21))) & (hospital_admission_date < (surgery_date - months(9)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_0 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), LOS, 0), na.rm=TRUE),      LOS_surgery_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(15)))), LOS, 0), na.rm=TRUE),     LOS_surgery_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(15))) & (hospital_admission_date < (surgery_date + months(27)))), LOS, 0), na.rm=TRUE),     LOS_surgery_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(27))) & (hospital_admission_date < (surgery_date + months(39)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(39))) & (hospital_admission_date < (surgery_date + months(51)))), LOS, 0), na.rm=TRUE),     LOS_surgery_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(51))) & (hospital_admission_date < (surgery_date + months(63)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(63))) & (hospital_admission_date < (surgery_date + months(75)))), LOS, 0), na.rm=TRUE),     LOS_surgery_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(75))) & (hospital_admission_date < (surgery_date + months(87)))), LOS, 0), na.rm=TRUE),     LOS_surgery_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(87))) & (hospital_admission_date < (surgery_date + months(99)))), LOS, 0), na.rm=TRUE),     LOS_surgery_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(99))) & (hospital_admission_date < (surgery_date + months(111)))), LOS, 0), na.rm=TRUE), 
    LOS_surgery_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(111))) & (hospital_admission_date < (surgery_date + months(123)))), LOS, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
extratemporal_LOS_by_year_per_patient_resective_epilepsy_surgery  
   

# Length of stay per person-year by year
extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(extratemporal_LOS_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    LOS_per_person_year_surgery_minus_10 = LOS_surgery_minus_10 / person_years_surgery_minus_10,
    LOS_per_person_year_surgery_minus_9 = LOS_surgery_minus_9 / person_years_surgery_minus_9,
    LOS_per_person_year_surgery_minus_8 = LOS_surgery_minus_8 / person_years_surgery_minus_8,
    LOS_per_person_year_surgery_minus_7 = LOS_surgery_minus_7 / person_years_surgery_minus_7,
    LOS_per_person_year_surgery_minus_6 = LOS_surgery_minus_6 / person_years_surgery_minus_6,
    LOS_per_person_year_surgery_minus_5 = LOS_surgery_minus_5 / person_years_surgery_minus_5,
    LOS_per_person_year_surgery_minus_4 = LOS_surgery_minus_4 / person_years_surgery_minus_4,
    LOS_per_person_year_surgery_minus_3 = LOS_surgery_minus_3 / person_years_surgery_minus_3,
    LOS_per_person_year_surgery_minus_2 = LOS_surgery_minus_2 / person_years_surgery_minus_2,
    LOS_per_person_year_surgery_minus_1 = LOS_surgery_minus_1 / person_years_surgery_minus_1,
    LOS_per_person_year_surgery_0 = LOS_surgery_0 / person_years_surgery_0,
    LOS_per_person_year_surgery_1 = LOS_surgery_1 / person_years_surgery_1,
    LOS_per_person_year_surgery_2 = LOS_surgery_2 / person_years_surgery_2,
    LOS_per_person_year_surgery_3 = LOS_surgery_3 / person_years_surgery_3,
    LOS_per_person_year_surgery_4 = LOS_surgery_4 / person_years_surgery_4,
    LOS_per_person_year_surgery_5 = LOS_surgery_5 / person_years_surgery_5,
    LOS_per_person_year_surgery_6 = LOS_surgery_6 / person_years_surgery_6,
    LOS_per_person_year_surgery_7 = LOS_surgery_7 / person_years_surgery_7,
    LOS_per_person_year_surgery_8 = LOS_surgery_8 / person_years_surgery_8,
    LOS_per_person_year_surgery_9 = LOS_surgery_9 / person_years_surgery_9,
    LOS_per_person_year_surgery_10 = LOS_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_0, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_0, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_1, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_1, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_2, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_2, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_3, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_3, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_4, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_4, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_5, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_5, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_6, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_6, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_7, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_7, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_8, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_8, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_9, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_9, na.rm=TRUE)

summary(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_10, na.rm=TRUE)
sd(extratemporal_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_10, na.rm=TRUE)
```




Cost in patients with resective epilepsy surgery
```{r}
# Cost in patients with resective epilepsy surgery
extratemporal_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
extratemporal_cost_resective_epilepsy_surgery




# Cost per patient before and after surgery
extratemporal_utilization_resective_epilepsy_surgery_total_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


total_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(extratemporal_utilization_resective_epilepsy_surgery_total_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    total_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    total_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
total_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Total cost per person-year by year before and after surgery
total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(total_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    total_cost_per_person_year_surgery_minus_1_5 = total_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    total_cost_per_person_year_surgery_0_1_5 = total_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    total_cost_per_person_year_surgery_1_5 = total_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_extratemporal_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5)
Wilcoxon_test_extratemporal_cost_per_person_year_resective_epilepsy_surgery_1_5




# Total cost per patient by year in relationship to surgery
extratemporal_utilization_resective_epilepsy_surgery_total_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


total_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(extratemporal_utilization_resective_epilepsy_surgery_total_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    total_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    total_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    total_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      total_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    total_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
total_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Total cost per person-year by year
total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(total_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    total_cost_per_person_year_surgery_minus_10 = total_cost_surgery_minus_10 / person_years_surgery_minus_10,
    total_cost_per_person_year_surgery_minus_9 = total_cost_surgery_minus_9 / person_years_surgery_minus_9,
    total_cost_per_person_year_surgery_minus_8 = total_cost_surgery_minus_8 / person_years_surgery_minus_8,
    total_cost_per_person_year_surgery_minus_7 = total_cost_surgery_minus_7 / person_years_surgery_minus_7,
    total_cost_per_person_year_surgery_minus_6 = total_cost_surgery_minus_6 / person_years_surgery_minus_6,
    total_cost_per_person_year_surgery_minus_5 = total_cost_surgery_minus_5 / person_years_surgery_minus_5,
    total_cost_per_person_year_surgery_minus_4 = total_cost_surgery_minus_4 / person_years_surgery_minus_4,
    total_cost_per_person_year_surgery_minus_3 = total_cost_surgery_minus_3 / person_years_surgery_minus_3,
    total_cost_per_person_year_surgery_minus_2 = total_cost_surgery_minus_2 / person_years_surgery_minus_2,
    total_cost_per_person_year_surgery_minus_1 = total_cost_surgery_minus_1 / person_years_surgery_minus_1,
    total_cost_per_person_year_surgery_0 = total_cost_surgery_0 / person_years_surgery_0,
    total_cost_per_person_year_surgery_1 = total_cost_surgery_1 / person_years_surgery_1,
    total_cost_per_person_year_surgery_2 = total_cost_surgery_2 / person_years_surgery_2,
    total_cost_per_person_year_surgery_3 = total_cost_surgery_3 / person_years_surgery_3,
    total_cost_per_person_year_surgery_4 = total_cost_surgery_4 / person_years_surgery_4,
    total_cost_per_person_year_surgery_5 = total_cost_surgery_5 / person_years_surgery_5,
    total_cost_per_person_year_surgery_6 = total_cost_surgery_6 / person_years_surgery_6,
    total_cost_per_person_year_surgery_7 = total_cost_surgery_7 / person_years_surgery_7,
    total_cost_per_person_year_surgery_8 = total_cost_surgery_8 / person_years_surgery_8,
    total_cost_per_person_year_surgery_9 = total_cost_surgery_9 / person_years_surgery_9,
    total_cost_per_person_year_surgery_10 = total_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Total cost figure in patients with resective epilepsy surgery
```{r}
# Total cost figure
data_figure_total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- tibble(
  "year" = factor(c("Year -5", "Year -4", "Year -3", "Year -2", "Year -1", "Year surgery", "Year +1", "Year +2", "Year +3", "Year +4", "Year +5"), levels=c("Year -5", "Year -4", "Year -3", "Year -2", "Year -1", "Year surgery", "Year +1", "Year +2", "Year +3", "Year +4", "Year +5")),
  "median_cost" = c(summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[3],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[3],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[3],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[3],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[3],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[3],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[3],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[3],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[3],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[3],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[3]),
  "p25_cost" = c(summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[2],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[2],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[2],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[2],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[2],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[2],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[2],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[2],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[2],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[2],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[2]),  
  "p75_cost" = c(summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[5],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[5],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[5],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[5],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[5],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[5],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[5],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[5],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[5],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[5],
                  summary(total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[5])    
  )


figure_total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- ggplot(data=data_figure_total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery) + 
  geom_point(aes(x=year, y=median_cost), color="purple2", size=5) +
  geom_point(aes(x=year, y=p25_cost), color="darkgreen", size=4) +
  geom_point(aes(x=year, y=p75_cost), color="darkgreen", size=4) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=22, face="bold")) +
  scale_x_discrete(name="Year") +
  scale_y_continuous(name="Cost ($) per person-year", breaks=seq(0, 300000, 50000), limits = c(0, 300000))
figure_total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery
ggplotly(figure_total_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery)
```




Outpatient cost in patients with resective epilepsy surgery
```{r}
# Outpatient cost in patients with resective epilepsy surgery
outpatient_extratemporal_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="outpatient") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
outpatient_extratemporal_cost_resective_epilepsy_surgery




# Outpatient cost per patient before and after surgery
extratemporal_utilization_resective_epilepsy_surgery_outpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


outpatient_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(extratemporal_utilization_resective_epilepsy_surgery_outpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    outpatient_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Outpatient cost per person-year by year before and after surgery
outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(outpatient_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    outpatient_cost_per_person_year_surgery_minus_1_5 = outpatient_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    outpatient_cost_per_person_year_surgery_0_1_5 = outpatient_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    outpatient_cost_per_person_year_surgery_1_5 = outpatient_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_outpatient_extratemporal_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5)
Wilcoxon_test_outpatient_extratemporal_cost_per_person_year_resective_epilepsy_surgery_1_5




# Outpatient cost per patient by year in relationship to surgery
extratemporal_utilization_resective_epilepsy_surgery_outpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


outpatient_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(extratemporal_utilization_resective_epilepsy_surgery_outpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    outpatient_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    outpatient_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      outpatient_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    outpatient_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Outpatient cost per person-year by year
outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(outpatient_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    outpatient_cost_per_person_year_surgery_minus_10 = outpatient_cost_surgery_minus_10 / person_years_surgery_minus_10,
    outpatient_cost_per_person_year_surgery_minus_9 = outpatient_cost_surgery_minus_9 / person_years_surgery_minus_9,
    outpatient_cost_per_person_year_surgery_minus_8 = outpatient_cost_surgery_minus_8 / person_years_surgery_minus_8,
    outpatient_cost_per_person_year_surgery_minus_7 = outpatient_cost_surgery_minus_7 / person_years_surgery_minus_7,
    outpatient_cost_per_person_year_surgery_minus_6 = outpatient_cost_surgery_minus_6 / person_years_surgery_minus_6,
    outpatient_cost_per_person_year_surgery_minus_5 = outpatient_cost_surgery_minus_5 / person_years_surgery_minus_5,
    outpatient_cost_per_person_year_surgery_minus_4 = outpatient_cost_surgery_minus_4 / person_years_surgery_minus_4,
    outpatient_cost_per_person_year_surgery_minus_3 = outpatient_cost_surgery_minus_3 / person_years_surgery_minus_3,
    outpatient_cost_per_person_year_surgery_minus_2 = outpatient_cost_surgery_minus_2 / person_years_surgery_minus_2,
    outpatient_cost_per_person_year_surgery_minus_1 = outpatient_cost_surgery_minus_1 / person_years_surgery_minus_1,
    outpatient_cost_per_person_year_surgery_0 = outpatient_cost_surgery_0 / person_years_surgery_0,
    outpatient_cost_per_person_year_surgery_1 = outpatient_cost_surgery_1 / person_years_surgery_1,
    outpatient_cost_per_person_year_surgery_2 = outpatient_cost_surgery_2 / person_years_surgery_2,
    outpatient_cost_per_person_year_surgery_3 = outpatient_cost_surgery_3 / person_years_surgery_3,
    outpatient_cost_per_person_year_surgery_4 = outpatient_cost_surgery_4 / person_years_surgery_4,
    outpatient_cost_per_person_year_surgery_5 = outpatient_cost_surgery_5 / person_years_surgery_5,
    outpatient_cost_per_person_year_surgery_6 = outpatient_cost_surgery_6 / person_years_surgery_6,
    outpatient_cost_per_person_year_surgery_7 = outpatient_cost_surgery_7 / person_years_surgery_7,
    outpatient_cost_per_person_year_surgery_8 = outpatient_cost_surgery_8 / person_years_surgery_8,
    outpatient_cost_per_person_year_surgery_9 = outpatient_cost_surgery_9 / person_years_surgery_9,
    outpatient_cost_per_person_year_surgery_10 = outpatient_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(outpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
```




ED cost in patients with resective epilepsy surgery
```{r}
# ED cost in patients with resective epilepsy surgery
ED_extratemporal_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="emergency") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
ED_extratemporal_cost_resective_epilepsy_surgery




# ED cost per patient before and after surgery
extratemporal_utilization_resective_epilepsy_surgery_ED_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="emergency") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


ED_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(extratemporal_utilization_resective_epilepsy_surgery_ED_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    ED_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# ED cost per person-year by year before and after surgery
ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(ED_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    ED_cost_per_person_year_surgery_minus_1_5 = ED_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    ED_cost_per_person_year_surgery_0_1_5 = ED_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    ED_cost_per_person_year_surgery_1_5 = ED_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_ED_extratemporal_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5)
Wilcoxon_test_ED_extratemporal_cost_per_person_year_resective_epilepsy_surgery_1_5




# ED cost per patient by year in relationship to surgery
extratemporal_utilization_resective_epilepsy_surgery_ED_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="emergency") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


ED_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(extratemporal_utilization_resective_epilepsy_surgery_ED_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    ED_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    ED_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      ED_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    ED_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# ED cost per person-year by year
ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(ED_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    ED_cost_per_person_year_surgery_minus_10 = ED_cost_surgery_minus_10 / person_years_surgery_minus_10,
    ED_cost_per_person_year_surgery_minus_9 = ED_cost_surgery_minus_9 / person_years_surgery_minus_9,
    ED_cost_per_person_year_surgery_minus_8 = ED_cost_surgery_minus_8 / person_years_surgery_minus_8,
    ED_cost_per_person_year_surgery_minus_7 = ED_cost_surgery_minus_7 / person_years_surgery_minus_7,
    ED_cost_per_person_year_surgery_minus_6 = ED_cost_surgery_minus_6 / person_years_surgery_minus_6,
    ED_cost_per_person_year_surgery_minus_5 = ED_cost_surgery_minus_5 / person_years_surgery_minus_5,
    ED_cost_per_person_year_surgery_minus_4 = ED_cost_surgery_minus_4 / person_years_surgery_minus_4,
    ED_cost_per_person_year_surgery_minus_3 = ED_cost_surgery_minus_3 / person_years_surgery_minus_3,
    ED_cost_per_person_year_surgery_minus_2 = ED_cost_surgery_minus_2 / person_years_surgery_minus_2,
    ED_cost_per_person_year_surgery_minus_1 = ED_cost_surgery_minus_1 / person_years_surgery_minus_1,
    ED_cost_per_person_year_surgery_0 = ED_cost_surgery_0 / person_years_surgery_0,
    ED_cost_per_person_year_surgery_1 = ED_cost_surgery_1 / person_years_surgery_1,
    ED_cost_per_person_year_surgery_2 = ED_cost_surgery_2 / person_years_surgery_2,
    ED_cost_per_person_year_surgery_3 = ED_cost_surgery_3 / person_years_surgery_3,
    ED_cost_per_person_year_surgery_4 = ED_cost_surgery_4 / person_years_surgery_4,
    ED_cost_per_person_year_surgery_5 = ED_cost_surgery_5 / person_years_surgery_5,
    ED_cost_per_person_year_surgery_6 = ED_cost_surgery_6 / person_years_surgery_6,
    ED_cost_per_person_year_surgery_7 = ED_cost_surgery_7 / person_years_surgery_7,
    ED_cost_per_person_year_surgery_8 = ED_cost_surgery_8 / person_years_surgery_8,
    ED_cost_per_person_year_surgery_9 = ED_cost_surgery_9 / person_years_surgery_9,
    ED_cost_per_person_year_surgery_10 = ED_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(ED_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Inpatient cost in patients with resective epilepsy surgery
```{r}
# Inpatient cost in patients with resective epilepsy surgery
inpatient_extratemporal_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="inpatient") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
inpatient_extratemporal_cost_resective_epilepsy_surgery




# Inpatient cost per patient before and after surgery
extratemporal_utilization_resective_epilepsy_surgery_inpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


inpatient_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(extratemporal_utilization_resective_epilepsy_surgery_inpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    inpatient_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    inpatient_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
inpatient_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Inpatient cost per person-year by year before and after surgery
inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(inpatient_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    inpatient_cost_per_person_year_surgery_minus_1_5 = inpatient_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    inpatient_cost_per_person_year_surgery_0_1_5 = inpatient_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    inpatient_cost_per_person_year_surgery_1_5 = inpatient_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_inpatient_extratemporal_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5)
Wilcoxon_test_inpatient_extratemporal_cost_per_person_year_resective_epilepsy_surgery_1_5




# Inpatient cost per patient by year in relationship to surgery
extratemporal_utilization_resective_epilepsy_surgery_inpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


inpatient_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% extratemporal_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(extratemporal_utilization_resective_epilepsy_surgery_inpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    inpatient_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    inpatient_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    inpatient_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      inpatient_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    inpatient_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
inpatient_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Inpatient cost per person-year by year
inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  extratemporal_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(inpatient_extratemporal_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    inpatient_cost_per_person_year_surgery_minus_10 = inpatient_cost_surgery_minus_10 / person_years_surgery_minus_10,
    inpatient_cost_per_person_year_surgery_minus_9 = inpatient_cost_surgery_minus_9 / person_years_surgery_minus_9,
    inpatient_cost_per_person_year_surgery_minus_8 = inpatient_cost_surgery_minus_8 / person_years_surgery_minus_8,
    inpatient_cost_per_person_year_surgery_minus_7 = inpatient_cost_surgery_minus_7 / person_years_surgery_minus_7,
    inpatient_cost_per_person_year_surgery_minus_6 = inpatient_cost_surgery_minus_6 / person_years_surgery_minus_6,
    inpatient_cost_per_person_year_surgery_minus_5 = inpatient_cost_surgery_minus_5 / person_years_surgery_minus_5,
    inpatient_cost_per_person_year_surgery_minus_4 = inpatient_cost_surgery_minus_4 / person_years_surgery_minus_4,
    inpatient_cost_per_person_year_surgery_minus_3 = inpatient_cost_surgery_minus_3 / person_years_surgery_minus_3,
    inpatient_cost_per_person_year_surgery_minus_2 = inpatient_cost_surgery_minus_2 / person_years_surgery_minus_2,
    inpatient_cost_per_person_year_surgery_minus_1 = inpatient_cost_surgery_minus_1 / person_years_surgery_minus_1,
    inpatient_cost_per_person_year_surgery_0 = inpatient_cost_surgery_0 / person_years_surgery_0,
    inpatient_cost_per_person_year_surgery_1 = inpatient_cost_surgery_1 / person_years_surgery_1,
    inpatient_cost_per_person_year_surgery_2 = inpatient_cost_surgery_2 / person_years_surgery_2,
    inpatient_cost_per_person_year_surgery_3 = inpatient_cost_surgery_3 / person_years_surgery_3,
    inpatient_cost_per_person_year_surgery_4 = inpatient_cost_surgery_4 / person_years_surgery_4,
    inpatient_cost_per_person_year_surgery_5 = inpatient_cost_surgery_5 / person_years_surgery_5,
    inpatient_cost_per_person_year_surgery_6 = inpatient_cost_surgery_6 / person_years_surgery_6,
    inpatient_cost_per_person_year_surgery_7 = inpatient_cost_surgery_7 / person_years_surgery_7,
    inpatient_cost_per_person_year_surgery_8 = inpatient_cost_surgery_8 / person_years_surgery_8,
    inpatient_cost_per_person_year_surgery_9 = inpatient_cost_surgery_9 / person_years_surgery_9,
    inpatient_cost_per_person_year_surgery_10 = inpatient_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(inpatient_extratemporal_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
```








## 8. Clinical and economic outcomes in resective epilepsy surgery: Subdural monitoring versus stereoEEG monitoring versus no long-term intracranial monitoring




Outpatient visits 
```{r}
# Individual outpatient visits
subdural_outpatient_visit_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
subdural_outpatient_visit_resective_epilepsy_surgery_n 


# Individual patients with outpatient visits
patients_subdural_outpatient_visit_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_subdural_outpatient_visit_resective_epilepsy_surgery_n 


# Tally of patients with more than one outpatient visit
tally_subdural_outpatient_visit_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  tally(name="number_outpatient_visits")  %>% 
  group_by(number_outpatient_visits) %>% 
  tally(name="number_patients")
tally_subdural_outpatient_visit_resective_epilepsy_surgery




# Outpatient visits per patient before and after surgery
subdural_utilization_resective_epilepsy_surgery_outpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(outpatient_date = SVCDATE)

subdural_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(subdural_utilization_resective_epilepsy_surgery_outpatient, by="ENROLID") %>%
  select(ENROLID, outpatient_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_visits_surgery_minus_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(69))) & (outpatient_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    outpatient_visits_surgery_0_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(9))) & (outpatient_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),     
    outpatient_visits_surgery_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(3))) & (outpatient_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
subdural_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 
   

# Outpatient visits per person-year by year
subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(subdural_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    outpatient_visits_per_person_year_surgery_minus_1_5 = outpatient_visits_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    outpatient_visits_per_person_year_surgery_0_1_5 = outpatient_visits_surgery_0_1_5 / person_years_surgery_0_1_5,
    outpatient_visits_per_person_year_surgery_1_5 = outpatient_visits_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5, na.rm=TRUE)


# Statistical test
Wilcoxon_test_subdural_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5)
Wilcoxon_test_subdural_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5




# Outpatient visits per patient by year in relationship to surgery
subdural_utilization_resective_epilepsy_surgery_outpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(outpatient_date = SVCDATE)

subdural_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(subdural_utilization_resective_epilepsy_surgery_outpatient, by="ENROLID") %>%
  select(ENROLID, outpatient_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_visits_surgery_minus_10 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(129))) & (outpatient_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_9 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(117))) & (outpatient_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    outpatient_visits_surgery_minus_8 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(105))) & (outpatient_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),  
    outpatient_visits_surgery_minus_7 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(93))) & (outpatient_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_6 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(81))) & (outpatient_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(69))) & (outpatient_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_4 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(57))) & (outpatient_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_3 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(45))) & (outpatient_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_2 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(33))) & (outpatient_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_1 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(21))) & (outpatient_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_0 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(9))) & (outpatient_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      outpatient_visits_surgery_1 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(3))) & (outpatient_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_2 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(15))) & (outpatient_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_3 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(27))) & (outpatient_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_4 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(39))) & (outpatient_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(51))) & (outpatient_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_6 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(63))) & (outpatient_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_7 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(75))) & (outpatient_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_8 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(87))) & (outpatient_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_9 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(99))) & (outpatient_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE), 
    outpatient_visits_surgery_10 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(111))) & (outpatient_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
subdural_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery  
   

# Outpatient visits per person-year by year
subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(subdural_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    outpatient_visits_per_person_year_surgery_minus_10 = outpatient_visits_surgery_minus_10 / person_years_surgery_minus_10,
    outpatient_visits_per_person_year_surgery_minus_9 = outpatient_visits_surgery_minus_9 / person_years_surgery_minus_9,
    outpatient_visits_per_person_year_surgery_minus_8 = outpatient_visits_surgery_minus_8 / person_years_surgery_minus_8,
    outpatient_visits_per_person_year_surgery_minus_7 = outpatient_visits_surgery_minus_7 / person_years_surgery_minus_7,
    outpatient_visits_per_person_year_surgery_minus_6 = outpatient_visits_surgery_minus_6 / person_years_surgery_minus_6,
    outpatient_visits_per_person_year_surgery_minus_5 = outpatient_visits_surgery_minus_5 / person_years_surgery_minus_5,
    outpatient_visits_per_person_year_surgery_minus_4 = outpatient_visits_surgery_minus_4 / person_years_surgery_minus_4,
    outpatient_visits_per_person_year_surgery_minus_3 = outpatient_visits_surgery_minus_3 / person_years_surgery_minus_3,
    outpatient_visits_per_person_year_surgery_minus_2 = outpatient_visits_surgery_minus_2 / person_years_surgery_minus_2,
    outpatient_visits_per_person_year_surgery_minus_1 = outpatient_visits_surgery_minus_1 / person_years_surgery_minus_1,
    outpatient_visits_per_person_year_surgery_0 = outpatient_visits_surgery_0 / person_years_surgery_0,
    outpatient_visits_per_person_year_surgery_1 = outpatient_visits_surgery_1 / person_years_surgery_1,
    outpatient_visits_per_person_year_surgery_2 = outpatient_visits_surgery_2 / person_years_surgery_2,
    outpatient_visits_per_person_year_surgery_3 = outpatient_visits_surgery_3 / person_years_surgery_3,
    outpatient_visits_per_person_year_surgery_4 = outpatient_visits_surgery_4 / person_years_surgery_4,
    outpatient_visits_per_person_year_surgery_5 = outpatient_visits_surgery_5 / person_years_surgery_5,
    outpatient_visits_per_person_year_surgery_6 = outpatient_visits_surgery_6 / person_years_surgery_6,
    outpatient_visits_per_person_year_surgery_7 = outpatient_visits_surgery_7 / person_years_surgery_7,
    outpatient_visits_per_person_year_surgery_8 = outpatient_visits_surgery_8 / person_years_surgery_8,
    outpatient_visits_per_person_year_surgery_9 = outpatient_visits_surgery_9 / person_years_surgery_9,
    outpatient_visits_per_person_year_surgery_10 = outpatient_visits_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_0, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_0, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_1, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_1, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_2, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_2, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_3, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_3, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_4, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_4, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_5, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_5, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_6, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_6, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_7, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_7, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_8, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_8, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_9, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_9, na.rm=TRUE)

summary(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_10, na.rm=TRUE)
sd(subdural_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_10, na.rm=TRUE)
```




Emergency department visits
```{r}
# Individual emergency department visits
subdural_ED_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
subdural_ED_resective_epilepsy_surgery_n 


# Individual patients with ED visits
patients_subdural_ED_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_subdural_ED_resective_epilepsy_surgery_n 


# Tally of patients with more than one ED visit
tally_subdural_ED_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  tally(name="number_ED_visits")  %>% 
  group_by(number_ED_visits) %>% 
  tally(name="number_patients")
tally_subdural_ED_resective_epilepsy_surgery




# Emergency visits per patient by year in relationship to surgery before and after surgery
subdural_utilization_resective_epilepsy_surgery_emergency <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(ED_date = SVCDATE)

subdural_ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 <-
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(subdural_utilization_resective_epilepsy_surgery_emergency, by="ENROLID") %>%
  select(ENROLID, ED_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_visits_surgery_minus_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(69))) & (ED_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    ED_visits_surgery_0_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(9))) & (ED_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE), 
    ED_visits_surgery_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(3))) & (ED_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
subdural_ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5  
   

# ED visits per person-year by year before and after surgery
subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(subdural_ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    ED_visits_per_person_year_surgery_minus_1_5 = ED_visits_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    ED_visits_per_person_year_surgery_0_1_5 = ED_visits_surgery_0_1_5 / person_years_surgery_0_1_5,
    ED_visits_per_person_year_surgery_1_5 = ED_visits_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_subdural_ED_visits_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5)
Wilcoxon_test_subdural_ED_visits_per_person_year_resective_epilepsy_surgery_1_5




# Emergency visits per patient by year in relationship to surgery
subdural_utilization_resective_epilepsy_surgery_emergency <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(ED_date = SVCDATE)

subdural_ED_visits_by_year_per_patient_resective_epilepsy_surgery <-
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(subdural_utilization_resective_epilepsy_surgery_emergency, by="ENROLID") %>%
  select(ENROLID, ED_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_visits_surgery_minus_10 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(129))) & (ED_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_9 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(117))) & (ED_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    ED_visits_surgery_minus_8 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(105))) & (ED_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_7 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(93))) & (ED_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_6 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(81))) & (ED_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(69))) & (ED_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_4 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(57))) & (ED_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_3 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(45))) & (ED_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_2 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(33))) & (ED_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_1 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(21))) & (ED_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_0 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(9))) & (ED_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      ED_visits_surgery_1 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(3))) & (ED_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     ED_visits_surgery_2 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(15))) & (ED_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     ED_visits_surgery_3 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(27))) & (ED_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_4 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(39))) & (ED_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     ED_visits_surgery_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(51))) & (ED_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_6 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(63))) & (ED_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     ED_visits_surgery_7 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(75))) & (ED_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     ED_visits_surgery_8 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(87))) & (ED_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     ED_visits_surgery_9 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(99))) & (ED_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_10 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(111))) & (ED_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
subdural_ED_visits_by_year_per_patient_resective_epilepsy_surgery  
   

# ED visits per person-year by year
subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(subdural_ED_visits_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    ED_visits_per_person_year_surgery_minus_10 = ED_visits_surgery_minus_10 / person_years_surgery_minus_10,
    ED_visits_per_person_year_surgery_minus_9 = ED_visits_surgery_minus_9 / person_years_surgery_minus_9,
    ED_visits_per_person_year_surgery_minus_8 = ED_visits_surgery_minus_8 / person_years_surgery_minus_8,
    ED_visits_per_person_year_surgery_minus_7 = ED_visits_surgery_minus_7 / person_years_surgery_minus_7,
    ED_visits_per_person_year_surgery_minus_6 = ED_visits_surgery_minus_6 / person_years_surgery_minus_6,
    ED_visits_per_person_year_surgery_minus_5 = ED_visits_surgery_minus_5 / person_years_surgery_minus_5,
    ED_visits_per_person_year_surgery_minus_4 = ED_visits_surgery_minus_4 / person_years_surgery_minus_4,
    ED_visits_per_person_year_surgery_minus_3 = ED_visits_surgery_minus_3 / person_years_surgery_minus_3,
    ED_visits_per_person_year_surgery_minus_2 = ED_visits_surgery_minus_2 / person_years_surgery_minus_2,
    ED_visits_per_person_year_surgery_minus_1 = ED_visits_surgery_minus_1 / person_years_surgery_minus_1,
    ED_visits_per_person_year_surgery_0 = ED_visits_surgery_0 / person_years_surgery_0,
    ED_visits_per_person_year_surgery_1 = ED_visits_surgery_1 / person_years_surgery_1,
    ED_visits_per_person_year_surgery_2 = ED_visits_surgery_2 / person_years_surgery_2,
    ED_visits_per_person_year_surgery_3 = ED_visits_surgery_3 / person_years_surgery_3,
    ED_visits_per_person_year_surgery_4 = ED_visits_surgery_4 / person_years_surgery_4,
    ED_visits_per_person_year_surgery_5 = ED_visits_surgery_5 / person_years_surgery_5,
    ED_visits_per_person_year_surgery_6 = ED_visits_surgery_6 / person_years_surgery_6,
    ED_visits_per_person_year_surgery_7 = ED_visits_surgery_7 / person_years_surgery_7,
    ED_visits_per_person_year_surgery_8 = ED_visits_surgery_8 / person_years_surgery_8,
    ED_visits_per_person_year_surgery_9 = ED_visits_surgery_9 / person_years_surgery_9,
    ED_visits_per_person_year_surgery_10 = ED_visits_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_0, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_0, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_1, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_1, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_2, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_2, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_3, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_3, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_4, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_4, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_5, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_5, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_6, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_6, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_7, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_7, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_8, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_8, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_9, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_9, na.rm=TRUE)

summary(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_10, na.rm=TRUE)
sd(subdural_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_10, na.rm=TRUE)
```




Hospital admissions
```{r}
# Individual hospital admissions
subdural_hospital_admission_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
subdural_hospital_admission_resective_epilepsy_surgery_n 


# Individual patients with hospital admissions
patients_subdural_hospital_admission_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_subdural_hospital_admission_resective_epilepsy_surgery_n 


# Tally of patients with more than one hospital admission
tally_subdural_hospital_admission_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  tally(name="number_hospital_admissions")  %>% 
  group_by(number_hospital_admissions) %>% 
  tally(name="number_hospital_admissions")
tally_subdural_hospital_admission_resective_epilepsy_surgery




# Hospital admissions per patient before and after surgery
subdural_utilization_resective_epilepsy_surgery_inpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(hospital_admission_date = SVCDATE)

subdural_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(subdural_utilization_resective_epilepsy_surgery_inpatient, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    hospital_admissions_surgery_minus_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    hospital_admissions_surgery_0_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
subdural_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Hospital admissions per person-year by year
subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(subdural_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    hospital_admissions_per_person_year_surgery_minus_1_5 = hospital_admissions_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    hospital_admissions_per_person_year_surgery_0_1_5 = hospital_admissions_surgery_0_1_5 / person_years_surgery_0_1_5,
    hospital_admissions_per_person_year_surgery_1_5 = hospital_admissions_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_subdural_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5)
Wilcoxon_test_subdural_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5




# Hospital admissions per patient by year in relationship to surgery
subdural_utilization_resective_epilepsy_surgery_inpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(hospital_admission_date = SVCDATE)

subdural_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(subdural_utilization_resective_epilepsy_surgery_inpatient, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    hospital_admissions_surgery_minus_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(129))) & (hospital_admission_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(117))) & (hospital_admission_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    hospital_admissions_surgery_minus_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(105))) & (hospital_admission_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),  
    hospital_admissions_surgery_minus_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(93))) & (hospital_admission_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(81))) & (hospital_admission_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(57))) & (hospital_admission_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(45))) & (hospital_admission_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(33))) & (hospital_admission_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(21))) & (hospital_admission_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_0 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      hospital_admissions_surgery_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(15))) & (hospital_admission_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(27))) & (hospital_admission_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(39))) & (hospital_admission_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(51))) & (hospital_admission_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(63))) & (hospital_admission_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(75))) & (hospital_admission_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(87))) & (hospital_admission_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(99))) & (hospital_admission_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE), 
    hospital_admissions_surgery_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(111))) & (hospital_admission_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
subdural_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery  
   

# Hospital admissions per person-year by year
subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(subdural_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    hospital_admissions_per_person_year_surgery_minus_10 = hospital_admissions_surgery_minus_10 / person_years_surgery_minus_10,
    hospital_admissions_per_person_year_surgery_minus_9 = hospital_admissions_surgery_minus_9 / person_years_surgery_minus_9,
    hospital_admissions_per_person_year_surgery_minus_8 = hospital_admissions_surgery_minus_8 / person_years_surgery_minus_8,
    hospital_admissions_per_person_year_surgery_minus_7 = hospital_admissions_surgery_minus_7 / person_years_surgery_minus_7,
    hospital_admissions_per_person_year_surgery_minus_6 = hospital_admissions_surgery_minus_6 / person_years_surgery_minus_6,
    hospital_admissions_per_person_year_surgery_minus_5 = hospital_admissions_surgery_minus_5 / person_years_surgery_minus_5,
    hospital_admissions_per_person_year_surgery_minus_4 = hospital_admissions_surgery_minus_4 / person_years_surgery_minus_4,
    hospital_admissions_per_person_year_surgery_minus_3 = hospital_admissions_surgery_minus_3 / person_years_surgery_minus_3,
    hospital_admissions_per_person_year_surgery_minus_2 = hospital_admissions_surgery_minus_2 / person_years_surgery_minus_2,
    hospital_admissions_per_person_year_surgery_minus_1 = hospital_admissions_surgery_minus_1 / person_years_surgery_minus_1,
    hospital_admissions_per_person_year_surgery_0 = hospital_admissions_surgery_0 / person_years_surgery_0,
    hospital_admissions_per_person_year_surgery_1 = hospital_admissions_surgery_1 / person_years_surgery_1,
    hospital_admissions_per_person_year_surgery_2 = hospital_admissions_surgery_2 / person_years_surgery_2,
    hospital_admissions_per_person_year_surgery_3 = hospital_admissions_surgery_3 / person_years_surgery_3,
    hospital_admissions_per_person_year_surgery_4 = hospital_admissions_surgery_4 / person_years_surgery_4,
    hospital_admissions_per_person_year_surgery_5 = hospital_admissions_surgery_5 / person_years_surgery_5,
    hospital_admissions_per_person_year_surgery_6 = hospital_admissions_surgery_6 / person_years_surgery_6,
    hospital_admissions_per_person_year_surgery_7 = hospital_admissions_surgery_7 / person_years_surgery_7,
    hospital_admissions_per_person_year_surgery_8 = hospital_admissions_surgery_8 / person_years_surgery_8,
    hospital_admissions_per_person_year_surgery_9 = hospital_admissions_surgery_9 / person_years_surgery_9,
    hospital_admissions_per_person_year_surgery_10 = hospital_admissions_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_0, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_0, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_1, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_1, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_2, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_2, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_3, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_3, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_4, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_4, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_5, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_5, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_6, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_6, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_7, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_7, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_8, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_8, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_9, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_9, na.rm=TRUE)

summary(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_10, na.rm=TRUE)
sd(subdural_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_10, na.rm=TRUE)
```




Length of stay in hospital admissions for resective epilepsy surgery
```{r}
# Length of hospital stay in patients with resective epilepsy surgery
subdural_LOS_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  ungroup() %>% 
  summarize(total_LOS = sum(LOS))
subdural_LOS_resective_epilepsy_surgery




# Length of hospital stay per patient before and after surgery
subdural_utilization_resective_epilepsy_surgery_LOS <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE, LOS) %>% 
  rename(hospital_admission_date = SVCDATE)

subdural_LOS_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(subdural_utilization_resective_epilepsy_surgery_LOS, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date, LOS) %>%
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    LOS_surgery_minus_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(9)))), LOS, 0), na.rm=TRUE)/5,
    LOS_surgery_0_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(63)))), LOS, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
subdural_LOS_by_year_per_patient_resective_epilepsy_surgery_1_5  
   

# Length of stay per person-year by year before and after surgery
subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(subdural_LOS_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    LOS_per_person_year_surgery_minus_1_5 = LOS_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    LOS_per_person_year_surgery_0_1_5 = LOS_surgery_0_1_5 / person_years_surgery_0_1_5,
    LOS_per_person_year_surgery_1_5 = LOS_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_subdural_LOS_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5)
Wilcoxon_test_subdural_LOS_per_person_year_resective_epilepsy_surgery_1_5




# LOS per patient by year in relationship to surgery
subdural_utilization_resective_epilepsy_surgery_LOS <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE, LOS) %>% 
  rename(hospital_admission_date = SVCDATE)

subdural_LOS_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(subdural_utilization_resective_epilepsy_surgery_LOS, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date, LOS) %>%
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    LOS_surgery_minus_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(129))) & (hospital_admission_date < (surgery_date - months(117)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(117))) & (hospital_admission_date < (surgery_date - months(105)))), LOS, 0), na.rm=TRUE), 
    LOS_surgery_minus_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(105))) & (hospital_admission_date < (surgery_date - months(93)))), LOS, 0), na.rm=TRUE),  
    LOS_surgery_minus_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(93))) & (hospital_admission_date < (surgery_date - months(81)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(81))) & (hospital_admission_date < (surgery_date - months(69)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(57)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(57))) & (hospital_admission_date < (surgery_date - months(45)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(45))) & (hospital_admission_date < (surgery_date - months(33)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(33))) & (hospital_admission_date < (surgery_date - months(21)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(21))) & (hospital_admission_date < (surgery_date - months(9)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_0 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), LOS, 0), na.rm=TRUE),      LOS_surgery_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(15)))), LOS, 0), na.rm=TRUE),     LOS_surgery_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(15))) & (hospital_admission_date < (surgery_date + months(27)))), LOS, 0), na.rm=TRUE),     LOS_surgery_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(27))) & (hospital_admission_date < (surgery_date + months(39)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(39))) & (hospital_admission_date < (surgery_date + months(51)))), LOS, 0), na.rm=TRUE),     LOS_surgery_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(51))) & (hospital_admission_date < (surgery_date + months(63)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(63))) & (hospital_admission_date < (surgery_date + months(75)))), LOS, 0), na.rm=TRUE),     LOS_surgery_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(75))) & (hospital_admission_date < (surgery_date + months(87)))), LOS, 0), na.rm=TRUE),     LOS_surgery_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(87))) & (hospital_admission_date < (surgery_date + months(99)))), LOS, 0), na.rm=TRUE),     LOS_surgery_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(99))) & (hospital_admission_date < (surgery_date + months(111)))), LOS, 0), na.rm=TRUE), 
    LOS_surgery_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(111))) & (hospital_admission_date < (surgery_date + months(123)))), LOS, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
subdural_LOS_by_year_per_patient_resective_epilepsy_surgery  
   

# Length of stay per person-year by year
subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(subdural_LOS_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    LOS_per_person_year_surgery_minus_10 = LOS_surgery_minus_10 / person_years_surgery_minus_10,
    LOS_per_person_year_surgery_minus_9 = LOS_surgery_minus_9 / person_years_surgery_minus_9,
    LOS_per_person_year_surgery_minus_8 = LOS_surgery_minus_8 / person_years_surgery_minus_8,
    LOS_per_person_year_surgery_minus_7 = LOS_surgery_minus_7 / person_years_surgery_minus_7,
    LOS_per_person_year_surgery_minus_6 = LOS_surgery_minus_6 / person_years_surgery_minus_6,
    LOS_per_person_year_surgery_minus_5 = LOS_surgery_minus_5 / person_years_surgery_minus_5,
    LOS_per_person_year_surgery_minus_4 = LOS_surgery_minus_4 / person_years_surgery_minus_4,
    LOS_per_person_year_surgery_minus_3 = LOS_surgery_minus_3 / person_years_surgery_minus_3,
    LOS_per_person_year_surgery_minus_2 = LOS_surgery_minus_2 / person_years_surgery_minus_2,
    LOS_per_person_year_surgery_minus_1 = LOS_surgery_minus_1 / person_years_surgery_minus_1,
    LOS_per_person_year_surgery_0 = LOS_surgery_0 / person_years_surgery_0,
    LOS_per_person_year_surgery_1 = LOS_surgery_1 / person_years_surgery_1,
    LOS_per_person_year_surgery_2 = LOS_surgery_2 / person_years_surgery_2,
    LOS_per_person_year_surgery_3 = LOS_surgery_3 / person_years_surgery_3,
    LOS_per_person_year_surgery_4 = LOS_surgery_4 / person_years_surgery_4,
    LOS_per_person_year_surgery_5 = LOS_surgery_5 / person_years_surgery_5,
    LOS_per_person_year_surgery_6 = LOS_surgery_6 / person_years_surgery_6,
    LOS_per_person_year_surgery_7 = LOS_surgery_7 / person_years_surgery_7,
    LOS_per_person_year_surgery_8 = LOS_surgery_8 / person_years_surgery_8,
    LOS_per_person_year_surgery_9 = LOS_surgery_9 / person_years_surgery_9,
    LOS_per_person_year_surgery_10 = LOS_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_0, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_0, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_1, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_1, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_2, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_2, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_3, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_3, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_4, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_4, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_5, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_5, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_6, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_6, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_7, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_7, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_8, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_8, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_9, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_9, na.rm=TRUE)

summary(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_10, na.rm=TRUE)
sd(subdural_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_10, na.rm=TRUE)
```




Cost in patients with resective epilepsy surgery
```{r}
# Cost in patients with resective epilepsy surgery
subdural_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
subdural_cost_resective_epilepsy_surgery




# Cost per patient before and after surgery
subdural_utilization_resective_epilepsy_surgery_total_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


total_subdural_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(subdural_utilization_resective_epilepsy_surgery_total_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    total_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    total_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
total_subdural_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Total cost per person-year by year before and after surgery
total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(total_subdural_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    total_cost_per_person_year_surgery_minus_1_5 = total_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    total_cost_per_person_year_surgery_0_1_5 = total_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    total_cost_per_person_year_surgery_1_5 = total_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_subdural_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5)
Wilcoxon_test_subdural_cost_per_person_year_resective_epilepsy_surgery_1_5




# Total cost per patient by year in relationship to surgery
subdural_utilization_resective_epilepsy_surgery_total_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


total_subdural_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(subdural_utilization_resective_epilepsy_surgery_total_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    total_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    total_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    total_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      total_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    total_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
total_subdural_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Total cost per person-year by year
total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(total_subdural_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    total_cost_per_person_year_surgery_minus_10 = total_cost_surgery_minus_10 / person_years_surgery_minus_10,
    total_cost_per_person_year_surgery_minus_9 = total_cost_surgery_minus_9 / person_years_surgery_minus_9,
    total_cost_per_person_year_surgery_minus_8 = total_cost_surgery_minus_8 / person_years_surgery_minus_8,
    total_cost_per_person_year_surgery_minus_7 = total_cost_surgery_minus_7 / person_years_surgery_minus_7,
    total_cost_per_person_year_surgery_minus_6 = total_cost_surgery_minus_6 / person_years_surgery_minus_6,
    total_cost_per_person_year_surgery_minus_5 = total_cost_surgery_minus_5 / person_years_surgery_minus_5,
    total_cost_per_person_year_surgery_minus_4 = total_cost_surgery_minus_4 / person_years_surgery_minus_4,
    total_cost_per_person_year_surgery_minus_3 = total_cost_surgery_minus_3 / person_years_surgery_minus_3,
    total_cost_per_person_year_surgery_minus_2 = total_cost_surgery_minus_2 / person_years_surgery_minus_2,
    total_cost_per_person_year_surgery_minus_1 = total_cost_surgery_minus_1 / person_years_surgery_minus_1,
    total_cost_per_person_year_surgery_0 = total_cost_surgery_0 / person_years_surgery_0,
    total_cost_per_person_year_surgery_1 = total_cost_surgery_1 / person_years_surgery_1,
    total_cost_per_person_year_surgery_2 = total_cost_surgery_2 / person_years_surgery_2,
    total_cost_per_person_year_surgery_3 = total_cost_surgery_3 / person_years_surgery_3,
    total_cost_per_person_year_surgery_4 = total_cost_surgery_4 / person_years_surgery_4,
    total_cost_per_person_year_surgery_5 = total_cost_surgery_5 / person_years_surgery_5,
    total_cost_per_person_year_surgery_6 = total_cost_surgery_6 / person_years_surgery_6,
    total_cost_per_person_year_surgery_7 = total_cost_surgery_7 / person_years_surgery_7,
    total_cost_per_person_year_surgery_8 = total_cost_surgery_8 / person_years_surgery_8,
    total_cost_per_person_year_surgery_9 = total_cost_surgery_9 / person_years_surgery_9,
    total_cost_per_person_year_surgery_10 = total_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Total cost figure in patients with resective epilepsy surgery
```{r}
# Total cost figure
data_figure_total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- tibble(
  "year" = factor(c("Year -5", "Year -4", "Year -3", "Year -2", "Year -1", "Year surgery", "Year +1", "Year +2", "Year +3", "Year +4", "Year +5"), levels=c("Year -5", "Year -4", "Year -3", "Year -2", "Year -1", "Year surgery", "Year +1", "Year +2", "Year +3", "Year +4", "Year +5")),
  "median_cost" = c(summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[3],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[3],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[3],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[3],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[3],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[3],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[3],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[3],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[3],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[3],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[3]),
  "p25_cost" = c(summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[2],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[2],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[2],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[2],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[2],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[2],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[2],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[2],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[2],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[2],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[2]),  
  "p75_cost" = c(summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[5],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[5],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[5],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[5],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[5],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[5],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[5],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[5],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[5],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[5],
                  summary(total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[5])    
  )


figure_total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- ggplot(data=data_figure_total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery) + 
  geom_point(aes(x=year, y=median_cost), color="purple2", size=5) +
  geom_point(aes(x=year, y=p25_cost), color="darkgreen", size=4) +
  geom_point(aes(x=year, y=p75_cost), color="darkgreen", size=4) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=22, face="bold")) +
  scale_x_discrete(name="Year") +
  scale_y_continuous(name="Cost ($) per person-year", breaks=seq(0, 300000, 50000), limits = c(0, 300000))
figure_total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery
ggplotly(figure_total_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery)
```




Outpatient cost in patients with resective epilepsy surgery
```{r}
# Outpatient cost in patients with resective epilepsy surgery
outpatient_subdural_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="outpatient") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
outpatient_subdural_cost_resective_epilepsy_surgery




# Outpatient cost per patient before and after surgery
subdural_utilization_resective_epilepsy_surgery_outpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


outpatient_subdural_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(subdural_utilization_resective_epilepsy_surgery_outpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    outpatient_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_subdural_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Outpatient cost per person-year by year before and after surgery
outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(outpatient_subdural_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    outpatient_cost_per_person_year_surgery_minus_1_5 = outpatient_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    outpatient_cost_per_person_year_surgery_0_1_5 = outpatient_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    outpatient_cost_per_person_year_surgery_1_5 = outpatient_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_outpatient_subdural_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5)
Wilcoxon_test_outpatient_subdural_cost_per_person_year_resective_epilepsy_surgery_1_5




# Outpatient cost per patient by year in relationship to surgery
subdural_utilization_resective_epilepsy_surgery_outpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


outpatient_subdural_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(subdural_utilization_resective_epilepsy_surgery_outpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    outpatient_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    outpatient_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      outpatient_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    outpatient_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_subdural_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Outpatient cost per person-year by year
outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(outpatient_subdural_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    outpatient_cost_per_person_year_surgery_minus_10 = outpatient_cost_surgery_minus_10 / person_years_surgery_minus_10,
    outpatient_cost_per_person_year_surgery_minus_9 = outpatient_cost_surgery_minus_9 / person_years_surgery_minus_9,
    outpatient_cost_per_person_year_surgery_minus_8 = outpatient_cost_surgery_minus_8 / person_years_surgery_minus_8,
    outpatient_cost_per_person_year_surgery_minus_7 = outpatient_cost_surgery_minus_7 / person_years_surgery_minus_7,
    outpatient_cost_per_person_year_surgery_minus_6 = outpatient_cost_surgery_minus_6 / person_years_surgery_minus_6,
    outpatient_cost_per_person_year_surgery_minus_5 = outpatient_cost_surgery_minus_5 / person_years_surgery_minus_5,
    outpatient_cost_per_person_year_surgery_minus_4 = outpatient_cost_surgery_minus_4 / person_years_surgery_minus_4,
    outpatient_cost_per_person_year_surgery_minus_3 = outpatient_cost_surgery_minus_3 / person_years_surgery_minus_3,
    outpatient_cost_per_person_year_surgery_minus_2 = outpatient_cost_surgery_minus_2 / person_years_surgery_minus_2,
    outpatient_cost_per_person_year_surgery_minus_1 = outpatient_cost_surgery_minus_1 / person_years_surgery_minus_1,
    outpatient_cost_per_person_year_surgery_0 = outpatient_cost_surgery_0 / person_years_surgery_0,
    outpatient_cost_per_person_year_surgery_1 = outpatient_cost_surgery_1 / person_years_surgery_1,
    outpatient_cost_per_person_year_surgery_2 = outpatient_cost_surgery_2 / person_years_surgery_2,
    outpatient_cost_per_person_year_surgery_3 = outpatient_cost_surgery_3 / person_years_surgery_3,
    outpatient_cost_per_person_year_surgery_4 = outpatient_cost_surgery_4 / person_years_surgery_4,
    outpatient_cost_per_person_year_surgery_5 = outpatient_cost_surgery_5 / person_years_surgery_5,
    outpatient_cost_per_person_year_surgery_6 = outpatient_cost_surgery_6 / person_years_surgery_6,
    outpatient_cost_per_person_year_surgery_7 = outpatient_cost_surgery_7 / person_years_surgery_7,
    outpatient_cost_per_person_year_surgery_8 = outpatient_cost_surgery_8 / person_years_surgery_8,
    outpatient_cost_per_person_year_surgery_9 = outpatient_cost_surgery_9 / person_years_surgery_9,
    outpatient_cost_per_person_year_surgery_10 = outpatient_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(outpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
```




ED cost in patients with resective epilepsy surgery
```{r}
# ED cost in patients with resective epilepsy surgery
ED_subdural_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="emergency") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
ED_subdural_cost_resective_epilepsy_surgery




# ED cost per patient before and after surgery
subdural_utilization_resective_epilepsy_surgery_ED_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="emergency") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


ED_subdural_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(subdural_utilization_resective_epilepsy_surgery_ED_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    ED_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_subdural_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# ED cost per person-year by year before and after surgery
ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(ED_subdural_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    ED_cost_per_person_year_surgery_minus_1_5 = ED_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    ED_cost_per_person_year_surgery_0_1_5 = ED_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    ED_cost_per_person_year_surgery_1_5 = ED_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_ED_subdural_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5)
Wilcoxon_test_ED_subdural_cost_per_person_year_resective_epilepsy_surgery_1_5




# ED cost per patient by year in relationship to surgery
subdural_utilization_resective_epilepsy_surgery_ED_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="emergency") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


ED_subdural_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(subdural_utilization_resective_epilepsy_surgery_ED_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    ED_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    ED_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      ED_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    ED_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_subdural_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# ED cost per person-year by year
ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(ED_subdural_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    ED_cost_per_person_year_surgery_minus_10 = ED_cost_surgery_minus_10 / person_years_surgery_minus_10,
    ED_cost_per_person_year_surgery_minus_9 = ED_cost_surgery_minus_9 / person_years_surgery_minus_9,
    ED_cost_per_person_year_surgery_minus_8 = ED_cost_surgery_minus_8 / person_years_surgery_minus_8,
    ED_cost_per_person_year_surgery_minus_7 = ED_cost_surgery_minus_7 / person_years_surgery_minus_7,
    ED_cost_per_person_year_surgery_minus_6 = ED_cost_surgery_minus_6 / person_years_surgery_minus_6,
    ED_cost_per_person_year_surgery_minus_5 = ED_cost_surgery_minus_5 / person_years_surgery_minus_5,
    ED_cost_per_person_year_surgery_minus_4 = ED_cost_surgery_minus_4 / person_years_surgery_minus_4,
    ED_cost_per_person_year_surgery_minus_3 = ED_cost_surgery_minus_3 / person_years_surgery_minus_3,
    ED_cost_per_person_year_surgery_minus_2 = ED_cost_surgery_minus_2 / person_years_surgery_minus_2,
    ED_cost_per_person_year_surgery_minus_1 = ED_cost_surgery_minus_1 / person_years_surgery_minus_1,
    ED_cost_per_person_year_surgery_0 = ED_cost_surgery_0 / person_years_surgery_0,
    ED_cost_per_person_year_surgery_1 = ED_cost_surgery_1 / person_years_surgery_1,
    ED_cost_per_person_year_surgery_2 = ED_cost_surgery_2 / person_years_surgery_2,
    ED_cost_per_person_year_surgery_3 = ED_cost_surgery_3 / person_years_surgery_3,
    ED_cost_per_person_year_surgery_4 = ED_cost_surgery_4 / person_years_surgery_4,
    ED_cost_per_person_year_surgery_5 = ED_cost_surgery_5 / person_years_surgery_5,
    ED_cost_per_person_year_surgery_6 = ED_cost_surgery_6 / person_years_surgery_6,
    ED_cost_per_person_year_surgery_7 = ED_cost_surgery_7 / person_years_surgery_7,
    ED_cost_per_person_year_surgery_8 = ED_cost_surgery_8 / person_years_surgery_8,
    ED_cost_per_person_year_surgery_9 = ED_cost_surgery_9 / person_years_surgery_9,
    ED_cost_per_person_year_surgery_10 = ED_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(ED_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Inpatient cost in patients with resective epilepsy surgery
```{r}
# Inpatient cost in patients with resective epilepsy surgery
inpatient_subdural_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="inpatient") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
inpatient_subdural_cost_resective_epilepsy_surgery




# Inpatient cost per patient before and after surgery
subdural_utilization_resective_epilepsy_surgery_inpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


inpatient_subdural_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(subdural_utilization_resective_epilepsy_surgery_inpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    inpatient_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    inpatient_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
inpatient_subdural_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Inpatient cost per person-year by year before and after surgery
inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(inpatient_subdural_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    inpatient_cost_per_person_year_surgery_minus_1_5 = inpatient_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    inpatient_cost_per_person_year_surgery_0_1_5 = inpatient_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    inpatient_cost_per_person_year_surgery_1_5 = inpatient_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_inpatient_subdural_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5)
Wilcoxon_test_inpatient_subdural_cost_per_person_year_resective_epilepsy_surgery_1_5




# Inpatient cost per patient by year in relationship to surgery
subdural_utilization_resective_epilepsy_surgery_inpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


inpatient_subdural_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% subdural_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(subdural_utilization_resective_epilepsy_surgery_inpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    inpatient_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    inpatient_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    inpatient_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      inpatient_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    inpatient_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
inpatient_subdural_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Inpatient cost per person-year by year
inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  subdural_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(inpatient_subdural_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    inpatient_cost_per_person_year_surgery_minus_10 = inpatient_cost_surgery_minus_10 / person_years_surgery_minus_10,
    inpatient_cost_per_person_year_surgery_minus_9 = inpatient_cost_surgery_minus_9 / person_years_surgery_minus_9,
    inpatient_cost_per_person_year_surgery_minus_8 = inpatient_cost_surgery_minus_8 / person_years_surgery_minus_8,
    inpatient_cost_per_person_year_surgery_minus_7 = inpatient_cost_surgery_minus_7 / person_years_surgery_minus_7,
    inpatient_cost_per_person_year_surgery_minus_6 = inpatient_cost_surgery_minus_6 / person_years_surgery_minus_6,
    inpatient_cost_per_person_year_surgery_minus_5 = inpatient_cost_surgery_minus_5 / person_years_surgery_minus_5,
    inpatient_cost_per_person_year_surgery_minus_4 = inpatient_cost_surgery_minus_4 / person_years_surgery_minus_4,
    inpatient_cost_per_person_year_surgery_minus_3 = inpatient_cost_surgery_minus_3 / person_years_surgery_minus_3,
    inpatient_cost_per_person_year_surgery_minus_2 = inpatient_cost_surgery_minus_2 / person_years_surgery_minus_2,
    inpatient_cost_per_person_year_surgery_minus_1 = inpatient_cost_surgery_minus_1 / person_years_surgery_minus_1,
    inpatient_cost_per_person_year_surgery_0 = inpatient_cost_surgery_0 / person_years_surgery_0,
    inpatient_cost_per_person_year_surgery_1 = inpatient_cost_surgery_1 / person_years_surgery_1,
    inpatient_cost_per_person_year_surgery_2 = inpatient_cost_surgery_2 / person_years_surgery_2,
    inpatient_cost_per_person_year_surgery_3 = inpatient_cost_surgery_3 / person_years_surgery_3,
    inpatient_cost_per_person_year_surgery_4 = inpatient_cost_surgery_4 / person_years_surgery_4,
    inpatient_cost_per_person_year_surgery_5 = inpatient_cost_surgery_5 / person_years_surgery_5,
    inpatient_cost_per_person_year_surgery_6 = inpatient_cost_surgery_6 / person_years_surgery_6,
    inpatient_cost_per_person_year_surgery_7 = inpatient_cost_surgery_7 / person_years_surgery_7,
    inpatient_cost_per_person_year_surgery_8 = inpatient_cost_surgery_8 / person_years_surgery_8,
    inpatient_cost_per_person_year_surgery_9 = inpatient_cost_surgery_9 / person_years_surgery_9,
    inpatient_cost_per_person_year_surgery_10 = inpatient_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(inpatient_subdural_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Outpatient visits
```{r}
# Individual outpatient visits
stereo_EEG_outpatient_visit_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
stereo_EEG_outpatient_visit_resective_epilepsy_surgery_n 


# Individual patients with outpatient visits
patients_stereo_EEG_outpatient_visit_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_stereo_EEG_outpatient_visit_resective_epilepsy_surgery_n 


# Tally of patients with more than one outpatient visit
tally_stereo_EEG_outpatient_visit_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  tally(name="number_outpatient_visits")  %>% 
  group_by(number_outpatient_visits) %>% 
  tally(name="number_patients")
tally_stereo_EEG_outpatient_visit_resective_epilepsy_surgery




# Outpatient visits per patient before and after surgery
stereo_EEG_utilization_resective_epilepsy_surgery_outpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(outpatient_date = SVCDATE)

stereo_EEG_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(stereo_EEG_utilization_resective_epilepsy_surgery_outpatient, by="ENROLID") %>%
  select(ENROLID, outpatient_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_visits_surgery_minus_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(69))) & (outpatient_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    outpatient_visits_surgery_0_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(9))) & (outpatient_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),     
    outpatient_visits_surgery_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(3))) & (outpatient_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
stereo_EEG_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 
   

# Outpatient visits per person-year by year
stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(stereo_EEG_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    outpatient_visits_per_person_year_surgery_minus_1_5 = outpatient_visits_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    outpatient_visits_per_person_year_surgery_0_1_5 = outpatient_visits_surgery_0_1_5 / person_years_surgery_0_1_5,
    outpatient_visits_per_person_year_surgery_1_5 = outpatient_visits_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5, na.rm=TRUE)


# Statistical test
Wilcoxon_test_stereo_EEG_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5)
Wilcoxon_test_stereo_EEG_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5




# Outpatient visits per patient by year in relationship to surgery
stereo_EEG_utilization_resective_epilepsy_surgery_outpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(outpatient_date = SVCDATE)

stereo_EEG_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(stereo_EEG_utilization_resective_epilepsy_surgery_outpatient, by="ENROLID") %>%
  select(ENROLID, outpatient_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_visits_surgery_minus_10 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(129))) & (outpatient_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_9 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(117))) & (outpatient_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    outpatient_visits_surgery_minus_8 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(105))) & (outpatient_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),  
    outpatient_visits_surgery_minus_7 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(93))) & (outpatient_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_6 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(81))) & (outpatient_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(69))) & (outpatient_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_4 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(57))) & (outpatient_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_3 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(45))) & (outpatient_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_2 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(33))) & (outpatient_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_1 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(21))) & (outpatient_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_0 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(9))) & (outpatient_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      outpatient_visits_surgery_1 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(3))) & (outpatient_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_2 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(15))) & (outpatient_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_3 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(27))) & (outpatient_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_4 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(39))) & (outpatient_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(51))) & (outpatient_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_6 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(63))) & (outpatient_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_7 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(75))) & (outpatient_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_8 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(87))) & (outpatient_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_9 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(99))) & (outpatient_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE), 
    outpatient_visits_surgery_10 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(111))) & (outpatient_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
stereo_EEG_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery  
   

# Outpatient visits per person-year by year
stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(stereo_EEG_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    outpatient_visits_per_person_year_surgery_minus_10 = outpatient_visits_surgery_minus_10 / person_years_surgery_minus_10,
    outpatient_visits_per_person_year_surgery_minus_9 = outpatient_visits_surgery_minus_9 / person_years_surgery_minus_9,
    outpatient_visits_per_person_year_surgery_minus_8 = outpatient_visits_surgery_minus_8 / person_years_surgery_minus_8,
    outpatient_visits_per_person_year_surgery_minus_7 = outpatient_visits_surgery_minus_7 / person_years_surgery_minus_7,
    outpatient_visits_per_person_year_surgery_minus_6 = outpatient_visits_surgery_minus_6 / person_years_surgery_minus_6,
    outpatient_visits_per_person_year_surgery_minus_5 = outpatient_visits_surgery_minus_5 / person_years_surgery_minus_5,
    outpatient_visits_per_person_year_surgery_minus_4 = outpatient_visits_surgery_minus_4 / person_years_surgery_minus_4,
    outpatient_visits_per_person_year_surgery_minus_3 = outpatient_visits_surgery_minus_3 / person_years_surgery_minus_3,
    outpatient_visits_per_person_year_surgery_minus_2 = outpatient_visits_surgery_minus_2 / person_years_surgery_minus_2,
    outpatient_visits_per_person_year_surgery_minus_1 = outpatient_visits_surgery_minus_1 / person_years_surgery_minus_1,
    outpatient_visits_per_person_year_surgery_0 = outpatient_visits_surgery_0 / person_years_surgery_0,
    outpatient_visits_per_person_year_surgery_1 = outpatient_visits_surgery_1 / person_years_surgery_1,
    outpatient_visits_per_person_year_surgery_2 = outpatient_visits_surgery_2 / person_years_surgery_2,
    outpatient_visits_per_person_year_surgery_3 = outpatient_visits_surgery_3 / person_years_surgery_3,
    outpatient_visits_per_person_year_surgery_4 = outpatient_visits_surgery_4 / person_years_surgery_4,
    outpatient_visits_per_person_year_surgery_5 = outpatient_visits_surgery_5 / person_years_surgery_5,
    outpatient_visits_per_person_year_surgery_6 = outpatient_visits_surgery_6 / person_years_surgery_6,
    outpatient_visits_per_person_year_surgery_7 = outpatient_visits_surgery_7 / person_years_surgery_7,
    outpatient_visits_per_person_year_surgery_8 = outpatient_visits_surgery_8 / person_years_surgery_8,
    outpatient_visits_per_person_year_surgery_9 = outpatient_visits_surgery_9 / person_years_surgery_9,
    outpatient_visits_per_person_year_surgery_10 = outpatient_visits_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_0, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_0, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_1, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_1, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_2, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_2, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_3, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_3, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_4, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_4, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_5, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_5, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_6, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_6, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_7, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_7, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_8, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_8, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_9, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_9, na.rm=TRUE)

summary(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_10, na.rm=TRUE)
sd(stereo_EEG_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_10, na.rm=TRUE)
```




Emergency department visits
```{r}
# Individual emergency department visits
stereo_EEG_ED_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
stereo_EEG_ED_resective_epilepsy_surgery_n 


# Individual patients with ED visits
patients_stereo_EEG_ED_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_stereo_EEG_ED_resective_epilepsy_surgery_n 


# Tally of patients with more than one ED visit
tally_stereo_EEG_ED_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  tally(name="number_ED_visits")  %>% 
  group_by(number_ED_visits) %>% 
  tally(name="number_patients")
tally_stereo_EEG_ED_resective_epilepsy_surgery




# Emergency visits per patient by year in relationship to surgery before and after surgery
stereo_EEG_utilization_resective_epilepsy_surgery_emergency <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(ED_date = SVCDATE)

stereo_EEG_ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 <-
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(stereo_EEG_utilization_resective_epilepsy_surgery_emergency, by="ENROLID") %>%
  select(ENROLID, ED_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_visits_surgery_minus_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(69))) & (ED_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    ED_visits_surgery_0_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(9))) & (ED_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE), 
    ED_visits_surgery_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(3))) & (ED_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
stereo_EEG_ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5  
   

# ED visits per person-year by year before and after surgery
stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(stereo_EEG_ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    ED_visits_per_person_year_surgery_minus_1_5 = ED_visits_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    ED_visits_per_person_year_surgery_0_1_5 = ED_visits_surgery_0_1_5 / person_years_surgery_0_1_5,
    ED_visits_per_person_year_surgery_1_5 = ED_visits_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_stereo_EEG_ED_visits_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5)
Wilcoxon_test_stereo_EEG_ED_visits_per_person_year_resective_epilepsy_surgery_1_5




# Emergency visits per patient by year in relationship to surgery
stereo_EEG_utilization_resective_epilepsy_surgery_emergency <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(ED_date = SVCDATE)

stereo_EEG_ED_visits_by_year_per_patient_resective_epilepsy_surgery <-
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(stereo_EEG_utilization_resective_epilepsy_surgery_emergency, by="ENROLID") %>%
  select(ENROLID, ED_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_visits_surgery_minus_10 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(129))) & (ED_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_9 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(117))) & (ED_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    ED_visits_surgery_minus_8 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(105))) & (ED_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_7 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(93))) & (ED_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_6 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(81))) & (ED_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(69))) & (ED_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_4 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(57))) & (ED_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_3 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(45))) & (ED_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_2 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(33))) & (ED_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_1 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(21))) & (ED_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_0 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(9))) & (ED_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      ED_visits_surgery_1 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(3))) & (ED_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     ED_visits_surgery_2 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(15))) & (ED_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     ED_visits_surgery_3 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(27))) & (ED_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_4 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(39))) & (ED_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     ED_visits_surgery_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(51))) & (ED_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_6 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(63))) & (ED_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     ED_visits_surgery_7 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(75))) & (ED_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     ED_visits_surgery_8 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(87))) & (ED_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     ED_visits_surgery_9 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(99))) & (ED_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_10 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(111))) & (ED_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
stereo_EEG_ED_visits_by_year_per_patient_resective_epilepsy_surgery  
   

# ED visits per person-year by year
stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(stereo_EEG_ED_visits_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    ED_visits_per_person_year_surgery_minus_10 = ED_visits_surgery_minus_10 / person_years_surgery_minus_10,
    ED_visits_per_person_year_surgery_minus_9 = ED_visits_surgery_minus_9 / person_years_surgery_minus_9,
    ED_visits_per_person_year_surgery_minus_8 = ED_visits_surgery_minus_8 / person_years_surgery_minus_8,
    ED_visits_per_person_year_surgery_minus_7 = ED_visits_surgery_minus_7 / person_years_surgery_minus_7,
    ED_visits_per_person_year_surgery_minus_6 = ED_visits_surgery_minus_6 / person_years_surgery_minus_6,
    ED_visits_per_person_year_surgery_minus_5 = ED_visits_surgery_minus_5 / person_years_surgery_minus_5,
    ED_visits_per_person_year_surgery_minus_4 = ED_visits_surgery_minus_4 / person_years_surgery_minus_4,
    ED_visits_per_person_year_surgery_minus_3 = ED_visits_surgery_minus_3 / person_years_surgery_minus_3,
    ED_visits_per_person_year_surgery_minus_2 = ED_visits_surgery_minus_2 / person_years_surgery_minus_2,
    ED_visits_per_person_year_surgery_minus_1 = ED_visits_surgery_minus_1 / person_years_surgery_minus_1,
    ED_visits_per_person_year_surgery_0 = ED_visits_surgery_0 / person_years_surgery_0,
    ED_visits_per_person_year_surgery_1 = ED_visits_surgery_1 / person_years_surgery_1,
    ED_visits_per_person_year_surgery_2 = ED_visits_surgery_2 / person_years_surgery_2,
    ED_visits_per_person_year_surgery_3 = ED_visits_surgery_3 / person_years_surgery_3,
    ED_visits_per_person_year_surgery_4 = ED_visits_surgery_4 / person_years_surgery_4,
    ED_visits_per_person_year_surgery_5 = ED_visits_surgery_5 / person_years_surgery_5,
    ED_visits_per_person_year_surgery_6 = ED_visits_surgery_6 / person_years_surgery_6,
    ED_visits_per_person_year_surgery_7 = ED_visits_surgery_7 / person_years_surgery_7,
    ED_visits_per_person_year_surgery_8 = ED_visits_surgery_8 / person_years_surgery_8,
    ED_visits_per_person_year_surgery_9 = ED_visits_surgery_9 / person_years_surgery_9,
    ED_visits_per_person_year_surgery_10 = ED_visits_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_0, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_0, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_1, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_1, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_2, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_2, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_3, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_3, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_4, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_4, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_5, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_5, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_6, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_6, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_7, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_7, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_8, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_8, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_9, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_9, na.rm=TRUE)

summary(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_10, na.rm=TRUE)
sd(stereo_EEG_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_10, na.rm=TRUE)
```




Hospital admissions
```{r}
# Individual hospital admissions
stereo_EEG_hospital_admission_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
stereo_EEG_hospital_admission_resective_epilepsy_surgery_n 


# Individual patients with hospital admissions
patients_stereo_EEG_hospital_admission_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_stereo_EEG_hospital_admission_resective_epilepsy_surgery_n 


# Tally of patients with more than one hospital admission
tally_stereo_EEG_hospital_admission_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  tally(name="number_hospital_admissions")  %>% 
  group_by(number_hospital_admissions) %>% 
  tally(name="number_hospital_admissions")
tally_stereo_EEG_hospital_admission_resective_epilepsy_surgery




# Hospital admissions per patient before and after surgery
stereo_EEG_utilization_resective_epilepsy_surgery_inpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(hospital_admission_date = SVCDATE)

stereo_EEG_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(stereo_EEG_utilization_resective_epilepsy_surgery_inpatient, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    hospital_admissions_surgery_minus_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    hospital_admissions_surgery_0_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
stereo_EEG_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Hospital admissions per person-year by year
stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(stereo_EEG_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    hospital_admissions_per_person_year_surgery_minus_1_5 = hospital_admissions_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    hospital_admissions_per_person_year_surgery_0_1_5 = hospital_admissions_surgery_0_1_5 / person_years_surgery_0_1_5,
    hospital_admissions_per_person_year_surgery_1_5 = hospital_admissions_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_stereo_EEG_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5)
Wilcoxon_test_stereo_EEG_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5




# Hospital admissions per patient by year in relationship to surgery
stereo_EEG_utilization_resective_epilepsy_surgery_inpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(hospital_admission_date = SVCDATE)

stereo_EEG_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(stereo_EEG_utilization_resective_epilepsy_surgery_inpatient, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    hospital_admissions_surgery_minus_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(129))) & (hospital_admission_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(117))) & (hospital_admission_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    hospital_admissions_surgery_minus_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(105))) & (hospital_admission_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),  
    hospital_admissions_surgery_minus_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(93))) & (hospital_admission_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(81))) & (hospital_admission_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(57))) & (hospital_admission_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(45))) & (hospital_admission_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(33))) & (hospital_admission_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(21))) & (hospital_admission_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_0 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      hospital_admissions_surgery_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(15))) & (hospital_admission_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(27))) & (hospital_admission_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(39))) & (hospital_admission_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(51))) & (hospital_admission_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(63))) & (hospital_admission_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(75))) & (hospital_admission_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(87))) & (hospital_admission_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(99))) & (hospital_admission_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE), 
    hospital_admissions_surgery_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(111))) & (hospital_admission_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
stereo_EEG_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery  
   

# Hospital admissions per person-year by year
stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(stereo_EEG_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    hospital_admissions_per_person_year_surgery_minus_10 = hospital_admissions_surgery_minus_10 / person_years_surgery_minus_10,
    hospital_admissions_per_person_year_surgery_minus_9 = hospital_admissions_surgery_minus_9 / person_years_surgery_minus_9,
    hospital_admissions_per_person_year_surgery_minus_8 = hospital_admissions_surgery_minus_8 / person_years_surgery_minus_8,
    hospital_admissions_per_person_year_surgery_minus_7 = hospital_admissions_surgery_minus_7 / person_years_surgery_minus_7,
    hospital_admissions_per_person_year_surgery_minus_6 = hospital_admissions_surgery_minus_6 / person_years_surgery_minus_6,
    hospital_admissions_per_person_year_surgery_minus_5 = hospital_admissions_surgery_minus_5 / person_years_surgery_minus_5,
    hospital_admissions_per_person_year_surgery_minus_4 = hospital_admissions_surgery_minus_4 / person_years_surgery_minus_4,
    hospital_admissions_per_person_year_surgery_minus_3 = hospital_admissions_surgery_minus_3 / person_years_surgery_minus_3,
    hospital_admissions_per_person_year_surgery_minus_2 = hospital_admissions_surgery_minus_2 / person_years_surgery_minus_2,
    hospital_admissions_per_person_year_surgery_minus_1 = hospital_admissions_surgery_minus_1 / person_years_surgery_minus_1,
    hospital_admissions_per_person_year_surgery_0 = hospital_admissions_surgery_0 / person_years_surgery_0,
    hospital_admissions_per_person_year_surgery_1 = hospital_admissions_surgery_1 / person_years_surgery_1,
    hospital_admissions_per_person_year_surgery_2 = hospital_admissions_surgery_2 / person_years_surgery_2,
    hospital_admissions_per_person_year_surgery_3 = hospital_admissions_surgery_3 / person_years_surgery_3,
    hospital_admissions_per_person_year_surgery_4 = hospital_admissions_surgery_4 / person_years_surgery_4,
    hospital_admissions_per_person_year_surgery_5 = hospital_admissions_surgery_5 / person_years_surgery_5,
    hospital_admissions_per_person_year_surgery_6 = hospital_admissions_surgery_6 / person_years_surgery_6,
    hospital_admissions_per_person_year_surgery_7 = hospital_admissions_surgery_7 / person_years_surgery_7,
    hospital_admissions_per_person_year_surgery_8 = hospital_admissions_surgery_8 / person_years_surgery_8,
    hospital_admissions_per_person_year_surgery_9 = hospital_admissions_surgery_9 / person_years_surgery_9,
    hospital_admissions_per_person_year_surgery_10 = hospital_admissions_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_0, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_0, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_1, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_1, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_2, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_2, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_3, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_3, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_4, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_4, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_5, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_5, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_6, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_6, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_7, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_7, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_8, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_8, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_9, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_9, na.rm=TRUE)

summary(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_10, na.rm=TRUE)
sd(stereo_EEG_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_10, na.rm=TRUE)
```




Length of stay in hospital admissions for resective epilepsy surgery
```{r}
# Length of hospital stay in patients with resective epilepsy surgery
stereo_EEG_LOS_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  ungroup() %>% 
  summarize(total_LOS = sum(LOS))
stereo_EEG_LOS_resective_epilepsy_surgery




# Length of hospital stay per patient before and after surgery
stereo_EEG_utilization_resective_epilepsy_surgery_LOS <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE, LOS) %>% 
  rename(hospital_admission_date = SVCDATE)

stereo_EEG_LOS_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(stereo_EEG_utilization_resective_epilepsy_surgery_LOS, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date, LOS) %>%
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    LOS_surgery_minus_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(9)))), LOS, 0), na.rm=TRUE)/5,
    LOS_surgery_0_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(63)))), LOS, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
stereo_EEG_LOS_by_year_per_patient_resective_epilepsy_surgery_1_5  
   

# Length of stay per person-year by year before and after surgery
stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(stereo_EEG_LOS_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    LOS_per_person_year_surgery_minus_1_5 = LOS_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    LOS_per_person_year_surgery_0_1_5 = LOS_surgery_0_1_5 / person_years_surgery_0_1_5,
    LOS_per_person_year_surgery_1_5 = LOS_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_stereo_EEG_LOS_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5)
Wilcoxon_test_stereo_EEG_LOS_per_person_year_resective_epilepsy_surgery_1_5




# LOS per patient by year in relationship to surgery
stereo_EEG_utilization_resective_epilepsy_surgery_LOS <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE, LOS) %>% 
  rename(hospital_admission_date = SVCDATE)

stereo_EEG_LOS_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(stereo_EEG_utilization_resective_epilepsy_surgery_LOS, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date, LOS) %>%
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    LOS_surgery_minus_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(129))) & (hospital_admission_date < (surgery_date - months(117)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(117))) & (hospital_admission_date < (surgery_date - months(105)))), LOS, 0), na.rm=TRUE), 
    LOS_surgery_minus_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(105))) & (hospital_admission_date < (surgery_date - months(93)))), LOS, 0), na.rm=TRUE),  
    LOS_surgery_minus_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(93))) & (hospital_admission_date < (surgery_date - months(81)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(81))) & (hospital_admission_date < (surgery_date - months(69)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(57)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(57))) & (hospital_admission_date < (surgery_date - months(45)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(45))) & (hospital_admission_date < (surgery_date - months(33)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(33))) & (hospital_admission_date < (surgery_date - months(21)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(21))) & (hospital_admission_date < (surgery_date - months(9)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_0 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), LOS, 0), na.rm=TRUE),      LOS_surgery_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(15)))), LOS, 0), na.rm=TRUE),     LOS_surgery_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(15))) & (hospital_admission_date < (surgery_date + months(27)))), LOS, 0), na.rm=TRUE),     LOS_surgery_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(27))) & (hospital_admission_date < (surgery_date + months(39)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(39))) & (hospital_admission_date < (surgery_date + months(51)))), LOS, 0), na.rm=TRUE),     LOS_surgery_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(51))) & (hospital_admission_date < (surgery_date + months(63)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(63))) & (hospital_admission_date < (surgery_date + months(75)))), LOS, 0), na.rm=TRUE),     LOS_surgery_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(75))) & (hospital_admission_date < (surgery_date + months(87)))), LOS, 0), na.rm=TRUE),     LOS_surgery_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(87))) & (hospital_admission_date < (surgery_date + months(99)))), LOS, 0), na.rm=TRUE),     LOS_surgery_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(99))) & (hospital_admission_date < (surgery_date + months(111)))), LOS, 0), na.rm=TRUE), 
    LOS_surgery_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(111))) & (hospital_admission_date < (surgery_date + months(123)))), LOS, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
stereo_EEG_LOS_by_year_per_patient_resective_epilepsy_surgery  
   

# Length of stay per person-year by year
stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(stereo_EEG_LOS_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    LOS_per_person_year_surgery_minus_10 = LOS_surgery_minus_10 / person_years_surgery_minus_10,
    LOS_per_person_year_surgery_minus_9 = LOS_surgery_minus_9 / person_years_surgery_minus_9,
    LOS_per_person_year_surgery_minus_8 = LOS_surgery_minus_8 / person_years_surgery_minus_8,
    LOS_per_person_year_surgery_minus_7 = LOS_surgery_minus_7 / person_years_surgery_minus_7,
    LOS_per_person_year_surgery_minus_6 = LOS_surgery_minus_6 / person_years_surgery_minus_6,
    LOS_per_person_year_surgery_minus_5 = LOS_surgery_minus_5 / person_years_surgery_minus_5,
    LOS_per_person_year_surgery_minus_4 = LOS_surgery_minus_4 / person_years_surgery_minus_4,
    LOS_per_person_year_surgery_minus_3 = LOS_surgery_minus_3 / person_years_surgery_minus_3,
    LOS_per_person_year_surgery_minus_2 = LOS_surgery_minus_2 / person_years_surgery_minus_2,
    LOS_per_person_year_surgery_minus_1 = LOS_surgery_minus_1 / person_years_surgery_minus_1,
    LOS_per_person_year_surgery_0 = LOS_surgery_0 / person_years_surgery_0,
    LOS_per_person_year_surgery_1 = LOS_surgery_1 / person_years_surgery_1,
    LOS_per_person_year_surgery_2 = LOS_surgery_2 / person_years_surgery_2,
    LOS_per_person_year_surgery_3 = LOS_surgery_3 / person_years_surgery_3,
    LOS_per_person_year_surgery_4 = LOS_surgery_4 / person_years_surgery_4,
    LOS_per_person_year_surgery_5 = LOS_surgery_5 / person_years_surgery_5,
    LOS_per_person_year_surgery_6 = LOS_surgery_6 / person_years_surgery_6,
    LOS_per_person_year_surgery_7 = LOS_surgery_7 / person_years_surgery_7,
    LOS_per_person_year_surgery_8 = LOS_surgery_8 / person_years_surgery_8,
    LOS_per_person_year_surgery_9 = LOS_surgery_9 / person_years_surgery_9,
    LOS_per_person_year_surgery_10 = LOS_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_0, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_0, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_1, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_1, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_2, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_2, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_3, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_3, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_4, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_4, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_5, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_5, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_6, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_6, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_7, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_7, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_8, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_8, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_9, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_9, na.rm=TRUE)

summary(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_10, na.rm=TRUE)
sd(stereo_EEG_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_10, na.rm=TRUE)
```




Cost in patients with resective epilepsy surgery
```{r}
# Cost in patients with resective epilepsy surgery
stereo_EEG_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
stereo_EEG_cost_resective_epilepsy_surgery




# Cost per patient before and after surgery
stereo_EEG_utilization_resective_epilepsy_surgery_total_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


total_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(stereo_EEG_utilization_resective_epilepsy_surgery_total_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    total_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    total_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
total_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Total cost per person-year by year before and after surgery
total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(total_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    total_cost_per_person_year_surgery_minus_1_5 = total_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    total_cost_per_person_year_surgery_0_1_5 = total_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    total_cost_per_person_year_surgery_1_5 = total_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_stereo_EEG_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5)
Wilcoxon_test_stereo_EEG_cost_per_person_year_resective_epilepsy_surgery_1_5




# Total cost per patient by year in relationship to surgery
stereo_EEG_utilization_resective_epilepsy_surgery_total_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


total_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(stereo_EEG_utilization_resective_epilepsy_surgery_total_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    total_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    total_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    total_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      total_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    total_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
total_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Total cost per person-year by year
total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(total_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    total_cost_per_person_year_surgery_minus_10 = total_cost_surgery_minus_10 / person_years_surgery_minus_10,
    total_cost_per_person_year_surgery_minus_9 = total_cost_surgery_minus_9 / person_years_surgery_minus_9,
    total_cost_per_person_year_surgery_minus_8 = total_cost_surgery_minus_8 / person_years_surgery_minus_8,
    total_cost_per_person_year_surgery_minus_7 = total_cost_surgery_minus_7 / person_years_surgery_minus_7,
    total_cost_per_person_year_surgery_minus_6 = total_cost_surgery_minus_6 / person_years_surgery_minus_6,
    total_cost_per_person_year_surgery_minus_5 = total_cost_surgery_minus_5 / person_years_surgery_minus_5,
    total_cost_per_person_year_surgery_minus_4 = total_cost_surgery_minus_4 / person_years_surgery_minus_4,
    total_cost_per_person_year_surgery_minus_3 = total_cost_surgery_minus_3 / person_years_surgery_minus_3,
    total_cost_per_person_year_surgery_minus_2 = total_cost_surgery_minus_2 / person_years_surgery_minus_2,
    total_cost_per_person_year_surgery_minus_1 = total_cost_surgery_minus_1 / person_years_surgery_minus_1,
    total_cost_per_person_year_surgery_0 = total_cost_surgery_0 / person_years_surgery_0,
    total_cost_per_person_year_surgery_1 = total_cost_surgery_1 / person_years_surgery_1,
    total_cost_per_person_year_surgery_2 = total_cost_surgery_2 / person_years_surgery_2,
    total_cost_per_person_year_surgery_3 = total_cost_surgery_3 / person_years_surgery_3,
    total_cost_per_person_year_surgery_4 = total_cost_surgery_4 / person_years_surgery_4,
    total_cost_per_person_year_surgery_5 = total_cost_surgery_5 / person_years_surgery_5,
    total_cost_per_person_year_surgery_6 = total_cost_surgery_6 / person_years_surgery_6,
    total_cost_per_person_year_surgery_7 = total_cost_surgery_7 / person_years_surgery_7,
    total_cost_per_person_year_surgery_8 = total_cost_surgery_8 / person_years_surgery_8,
    total_cost_per_person_year_surgery_9 = total_cost_surgery_9 / person_years_surgery_9,
    total_cost_per_person_year_surgery_10 = total_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Total cost figure in patients with resective epilepsy surgery
```{r}
# Total cost figure
data_figure_total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- tibble(
  "year" = factor(c("Year -5", "Year -4", "Year -3", "Year -2", "Year -1", "Year surgery", "Year +1", "Year +2", "Year +3", "Year +4", "Year +5"), levels=c("Year -5", "Year -4", "Year -3", "Year -2", "Year -1", "Year surgery", "Year +1", "Year +2", "Year +3", "Year +4", "Year +5")),
  "median_cost" = c(summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[3],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[3],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[3],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[3],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[3],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[3],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[3],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[3],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[3],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[3],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[3]),
  "p25_cost" = c(summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[2],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[2],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[2],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[2],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[2],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[2],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[2],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[2],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[2],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[2],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[2]),  
  "p75_cost" = c(summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[5],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[5],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[5],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[5],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[5],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[5],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[5],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[5],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[5],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[5],
                  summary(total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[5])    
  )


figure_total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- ggplot(data=data_figure_total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery) + 
  geom_point(aes(x=year, y=median_cost), color="purple2", size=5) +
  geom_point(aes(x=year, y=p25_cost), color="darkgreen", size=4) +
  geom_point(aes(x=year, y=p75_cost), color="darkgreen", size=4) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=22, face="bold")) +
  scale_x_discrete(name="Year") +
  scale_y_continuous(name="Cost ($) per person-year", breaks=seq(0, 350000, 50000), limits = c(0, 350000))
figure_total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery
ggplotly(figure_total_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery)
```




Outpatient cost in patients with resective epilepsy surgery
```{r}
# Outpatient cost in patients with resective epilepsy surgery
outpatient_stereo_EEG_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="outpatient") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
outpatient_stereo_EEG_cost_resective_epilepsy_surgery




# Outpatient cost per patient before and after surgery
stereo_EEG_utilization_resective_epilepsy_surgery_outpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


outpatient_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(stereo_EEG_utilization_resective_epilepsy_surgery_outpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    outpatient_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Outpatient cost per person-year by year before and after surgery
outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(outpatient_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    outpatient_cost_per_person_year_surgery_minus_1_5 = outpatient_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    outpatient_cost_per_person_year_surgery_0_1_5 = outpatient_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    outpatient_cost_per_person_year_surgery_1_5 = outpatient_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_outpatient_stereo_EEG_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5)
Wilcoxon_test_outpatient_stereo_EEG_cost_per_person_year_resective_epilepsy_surgery_1_5




# Outpatient cost per patient by year in relationship to surgery
stereo_EEG_utilization_resective_epilepsy_surgery_outpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


outpatient_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(stereo_EEG_utilization_resective_epilepsy_surgery_outpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    outpatient_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    outpatient_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      outpatient_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    outpatient_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Outpatient cost per person-year by year
outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(outpatient_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    outpatient_cost_per_person_year_surgery_minus_10 = outpatient_cost_surgery_minus_10 / person_years_surgery_minus_10,
    outpatient_cost_per_person_year_surgery_minus_9 = outpatient_cost_surgery_minus_9 / person_years_surgery_minus_9,
    outpatient_cost_per_person_year_surgery_minus_8 = outpatient_cost_surgery_minus_8 / person_years_surgery_minus_8,
    outpatient_cost_per_person_year_surgery_minus_7 = outpatient_cost_surgery_minus_7 / person_years_surgery_minus_7,
    outpatient_cost_per_person_year_surgery_minus_6 = outpatient_cost_surgery_minus_6 / person_years_surgery_minus_6,
    outpatient_cost_per_person_year_surgery_minus_5 = outpatient_cost_surgery_minus_5 / person_years_surgery_minus_5,
    outpatient_cost_per_person_year_surgery_minus_4 = outpatient_cost_surgery_minus_4 / person_years_surgery_minus_4,
    outpatient_cost_per_person_year_surgery_minus_3 = outpatient_cost_surgery_minus_3 / person_years_surgery_minus_3,
    outpatient_cost_per_person_year_surgery_minus_2 = outpatient_cost_surgery_minus_2 / person_years_surgery_minus_2,
    outpatient_cost_per_person_year_surgery_minus_1 = outpatient_cost_surgery_minus_1 / person_years_surgery_minus_1,
    outpatient_cost_per_person_year_surgery_0 = outpatient_cost_surgery_0 / person_years_surgery_0,
    outpatient_cost_per_person_year_surgery_1 = outpatient_cost_surgery_1 / person_years_surgery_1,
    outpatient_cost_per_person_year_surgery_2 = outpatient_cost_surgery_2 / person_years_surgery_2,
    outpatient_cost_per_person_year_surgery_3 = outpatient_cost_surgery_3 / person_years_surgery_3,
    outpatient_cost_per_person_year_surgery_4 = outpatient_cost_surgery_4 / person_years_surgery_4,
    outpatient_cost_per_person_year_surgery_5 = outpatient_cost_surgery_5 / person_years_surgery_5,
    outpatient_cost_per_person_year_surgery_6 = outpatient_cost_surgery_6 / person_years_surgery_6,
    outpatient_cost_per_person_year_surgery_7 = outpatient_cost_surgery_7 / person_years_surgery_7,
    outpatient_cost_per_person_year_surgery_8 = outpatient_cost_surgery_8 / person_years_surgery_8,
    outpatient_cost_per_person_year_surgery_9 = outpatient_cost_surgery_9 / person_years_surgery_9,
    outpatient_cost_per_person_year_surgery_10 = outpatient_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(outpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
```




ED cost in patients with resective epilepsy surgery
```{r}
# ED cost in patients with resective epilepsy surgery
ED_stereo_EEG_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="emergency") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
ED_stereo_EEG_cost_resective_epilepsy_surgery




# ED cost per patient before and after surgery
stereo_EEG_utilization_resective_epilepsy_surgery_ED_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="emergency") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


ED_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(stereo_EEG_utilization_resective_epilepsy_surgery_ED_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    ED_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# ED cost per person-year by year before and after surgery
ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(ED_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    ED_cost_per_person_year_surgery_minus_1_5 = ED_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    ED_cost_per_person_year_surgery_0_1_5 = ED_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    ED_cost_per_person_year_surgery_1_5 = ED_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_ED_stereo_EEG_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5)
Wilcoxon_test_ED_stereo_EEG_cost_per_person_year_resective_epilepsy_surgery_1_5




# ED cost per patient by year in relationship to surgery
stereo_EEG_utilization_resective_epilepsy_surgery_ED_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="emergency") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


ED_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(stereo_EEG_utilization_resective_epilepsy_surgery_ED_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    ED_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    ED_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      ED_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    ED_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# ED cost per person-year by year
ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(ED_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    ED_cost_per_person_year_surgery_minus_10 = ED_cost_surgery_minus_10 / person_years_surgery_minus_10,
    ED_cost_per_person_year_surgery_minus_9 = ED_cost_surgery_minus_9 / person_years_surgery_minus_9,
    ED_cost_per_person_year_surgery_minus_8 = ED_cost_surgery_minus_8 / person_years_surgery_minus_8,
    ED_cost_per_person_year_surgery_minus_7 = ED_cost_surgery_minus_7 / person_years_surgery_minus_7,
    ED_cost_per_person_year_surgery_minus_6 = ED_cost_surgery_minus_6 / person_years_surgery_minus_6,
    ED_cost_per_person_year_surgery_minus_5 = ED_cost_surgery_minus_5 / person_years_surgery_minus_5,
    ED_cost_per_person_year_surgery_minus_4 = ED_cost_surgery_minus_4 / person_years_surgery_minus_4,
    ED_cost_per_person_year_surgery_minus_3 = ED_cost_surgery_minus_3 / person_years_surgery_minus_3,
    ED_cost_per_person_year_surgery_minus_2 = ED_cost_surgery_minus_2 / person_years_surgery_minus_2,
    ED_cost_per_person_year_surgery_minus_1 = ED_cost_surgery_minus_1 / person_years_surgery_minus_1,
    ED_cost_per_person_year_surgery_0 = ED_cost_surgery_0 / person_years_surgery_0,
    ED_cost_per_person_year_surgery_1 = ED_cost_surgery_1 / person_years_surgery_1,
    ED_cost_per_person_year_surgery_2 = ED_cost_surgery_2 / person_years_surgery_2,
    ED_cost_per_person_year_surgery_3 = ED_cost_surgery_3 / person_years_surgery_3,
    ED_cost_per_person_year_surgery_4 = ED_cost_surgery_4 / person_years_surgery_4,
    ED_cost_per_person_year_surgery_5 = ED_cost_surgery_5 / person_years_surgery_5,
    ED_cost_per_person_year_surgery_6 = ED_cost_surgery_6 / person_years_surgery_6,
    ED_cost_per_person_year_surgery_7 = ED_cost_surgery_7 / person_years_surgery_7,
    ED_cost_per_person_year_surgery_8 = ED_cost_surgery_8 / person_years_surgery_8,
    ED_cost_per_person_year_surgery_9 = ED_cost_surgery_9 / person_years_surgery_9,
    ED_cost_per_person_year_surgery_10 = ED_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(ED_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Inpatient cost in patients with resective epilepsy surgery
```{r}
# Inpatient cost in patients with resective epilepsy surgery
inpatient_stereo_EEG_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="inpatient") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
inpatient_stereo_EEG_cost_resective_epilepsy_surgery




# Inpatient cost per patient before and after surgery
stereo_EEG_utilization_resective_epilepsy_surgery_inpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


inpatient_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(stereo_EEG_utilization_resective_epilepsy_surgery_inpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    inpatient_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    inpatient_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
inpatient_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Inpatient cost per person-year by year before and after surgery
inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(inpatient_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    inpatient_cost_per_person_year_surgery_minus_1_5 = inpatient_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    inpatient_cost_per_person_year_surgery_0_1_5 = inpatient_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    inpatient_cost_per_person_year_surgery_1_5 = inpatient_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_inpatient_stereo_EEG_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5)
Wilcoxon_test_inpatient_stereo_EEG_cost_per_person_year_resective_epilepsy_surgery_1_5




# Inpatient cost per patient by year in relationship to surgery
stereo_EEG_utilization_resective_epilepsy_surgery_inpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


inpatient_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% stereo_EEG_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(stereo_EEG_utilization_resective_epilepsy_surgery_inpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    inpatient_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    inpatient_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    inpatient_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      inpatient_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    inpatient_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
inpatient_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Inpatient cost per person-year by year
inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  stereo_EEG_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(inpatient_stereo_EEG_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    inpatient_cost_per_person_year_surgery_minus_10 = inpatient_cost_surgery_minus_10 / person_years_surgery_minus_10,
    inpatient_cost_per_person_year_surgery_minus_9 = inpatient_cost_surgery_minus_9 / person_years_surgery_minus_9,
    inpatient_cost_per_person_year_surgery_minus_8 = inpatient_cost_surgery_minus_8 / person_years_surgery_minus_8,
    inpatient_cost_per_person_year_surgery_minus_7 = inpatient_cost_surgery_minus_7 / person_years_surgery_minus_7,
    inpatient_cost_per_person_year_surgery_minus_6 = inpatient_cost_surgery_minus_6 / person_years_surgery_minus_6,
    inpatient_cost_per_person_year_surgery_minus_5 = inpatient_cost_surgery_minus_5 / person_years_surgery_minus_5,
    inpatient_cost_per_person_year_surgery_minus_4 = inpatient_cost_surgery_minus_4 / person_years_surgery_minus_4,
    inpatient_cost_per_person_year_surgery_minus_3 = inpatient_cost_surgery_minus_3 / person_years_surgery_minus_3,
    inpatient_cost_per_person_year_surgery_minus_2 = inpatient_cost_surgery_minus_2 / person_years_surgery_minus_2,
    inpatient_cost_per_person_year_surgery_minus_1 = inpatient_cost_surgery_minus_1 / person_years_surgery_minus_1,
    inpatient_cost_per_person_year_surgery_0 = inpatient_cost_surgery_0 / person_years_surgery_0,
    inpatient_cost_per_person_year_surgery_1 = inpatient_cost_surgery_1 / person_years_surgery_1,
    inpatient_cost_per_person_year_surgery_2 = inpatient_cost_surgery_2 / person_years_surgery_2,
    inpatient_cost_per_person_year_surgery_3 = inpatient_cost_surgery_3 / person_years_surgery_3,
    inpatient_cost_per_person_year_surgery_4 = inpatient_cost_surgery_4 / person_years_surgery_4,
    inpatient_cost_per_person_year_surgery_5 = inpatient_cost_surgery_5 / person_years_surgery_5,
    inpatient_cost_per_person_year_surgery_6 = inpatient_cost_surgery_6 / person_years_surgery_6,
    inpatient_cost_per_person_year_surgery_7 = inpatient_cost_surgery_7 / person_years_surgery_7,
    inpatient_cost_per_person_year_surgery_8 = inpatient_cost_surgery_8 / person_years_surgery_8,
    inpatient_cost_per_person_year_surgery_9 = inpatient_cost_surgery_9 / person_years_surgery_9,
    inpatient_cost_per_person_year_surgery_10 = inpatient_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(inpatient_stereo_EEG_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Outpatient visits
```{r}
# Individual outpatient visits
no_intracranial_outpatient_visit_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
no_intracranial_outpatient_visit_resective_epilepsy_surgery_n 


# Individual patients with outpatient visits
patients_no_intracranial_outpatient_visit_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_no_intracranial_outpatient_visit_resective_epilepsy_surgery_n 


# Tally of patients with more than one outpatient visit
tally_no_intracranial_outpatient_visit_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  tally(name="number_outpatient_visits")  %>% 
  group_by(number_outpatient_visits) %>% 
  tally(name="number_patients")
tally_no_intracranial_outpatient_visit_resective_epilepsy_surgery




# Outpatient visits per patient before and after surgery
no_intracranial_utilization_resective_epilepsy_surgery_outpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(outpatient_date = SVCDATE)

no_intracranial_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(no_intracranial_utilization_resective_epilepsy_surgery_outpatient, by="ENROLID") %>%
  select(ENROLID, outpatient_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_visits_surgery_minus_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(69))) & (outpatient_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    outpatient_visits_surgery_0_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(9))) & (outpatient_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),     
    outpatient_visits_surgery_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(3))) & (outpatient_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
no_intracranial_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 
   

# Outpatient visits per person-year by year
no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(no_intracranial_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    outpatient_visits_per_person_year_surgery_minus_1_5 = outpatient_visits_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    outpatient_visits_per_person_year_surgery_0_1_5 = outpatient_visits_surgery_0_1_5 / person_years_surgery_0_1_5,
    outpatient_visits_per_person_year_surgery_1_5 = outpatient_visits_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5, na.rm=TRUE)


# Statistical test
Wilcoxon_test_no_intracranial_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_visits_per_person_year_surgery_1_5)
Wilcoxon_test_no_intracranial_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5




# Outpatient visits per patient by year in relationship to surgery
no_intracranial_utilization_resective_epilepsy_surgery_outpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="outpatient") %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(outpatient_date = SVCDATE)

no_intracranial_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(no_intracranial_utilization_resective_epilepsy_surgery_outpatient, by="ENROLID") %>%
  select(ENROLID, outpatient_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_visits_surgery_minus_10 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(129))) & (outpatient_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_9 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(117))) & (outpatient_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    outpatient_visits_surgery_minus_8 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(105))) & (outpatient_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),  
    outpatient_visits_surgery_minus_7 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(93))) & (outpatient_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_6 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(81))) & (outpatient_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(69))) & (outpatient_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_4 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(57))) & (outpatient_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_3 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(45))) & (outpatient_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_2 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(33))) & (outpatient_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_1 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(21))) & (outpatient_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_0 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(9))) & (outpatient_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      outpatient_visits_surgery_1 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(3))) & (outpatient_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_2 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(15))) & (outpatient_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_3 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(27))) & (outpatient_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_4 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(39))) & (outpatient_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(51))) & (outpatient_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_6 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(63))) & (outpatient_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_7 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(75))) & (outpatient_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_8 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(87))) & (outpatient_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_9 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(99))) & (outpatient_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE), 
    outpatient_visits_surgery_10 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(111))) & (outpatient_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
no_intracranial_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery  
   

# Outpatient visits per person-year by year
no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(no_intracranial_outpatient_visits_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    outpatient_visits_per_person_year_surgery_minus_10 = outpatient_visits_surgery_minus_10 / person_years_surgery_minus_10,
    outpatient_visits_per_person_year_surgery_minus_9 = outpatient_visits_surgery_minus_9 / person_years_surgery_minus_9,
    outpatient_visits_per_person_year_surgery_minus_8 = outpatient_visits_surgery_minus_8 / person_years_surgery_minus_8,
    outpatient_visits_per_person_year_surgery_minus_7 = outpatient_visits_surgery_minus_7 / person_years_surgery_minus_7,
    outpatient_visits_per_person_year_surgery_minus_6 = outpatient_visits_surgery_minus_6 / person_years_surgery_minus_6,
    outpatient_visits_per_person_year_surgery_minus_5 = outpatient_visits_surgery_minus_5 / person_years_surgery_minus_5,
    outpatient_visits_per_person_year_surgery_minus_4 = outpatient_visits_surgery_minus_4 / person_years_surgery_minus_4,
    outpatient_visits_per_person_year_surgery_minus_3 = outpatient_visits_surgery_minus_3 / person_years_surgery_minus_3,
    outpatient_visits_per_person_year_surgery_minus_2 = outpatient_visits_surgery_minus_2 / person_years_surgery_minus_2,
    outpatient_visits_per_person_year_surgery_minus_1 = outpatient_visits_surgery_minus_1 / person_years_surgery_minus_1,
    outpatient_visits_per_person_year_surgery_0 = outpatient_visits_surgery_0 / person_years_surgery_0,
    outpatient_visits_per_person_year_surgery_1 = outpatient_visits_surgery_1 / person_years_surgery_1,
    outpatient_visits_per_person_year_surgery_2 = outpatient_visits_surgery_2 / person_years_surgery_2,
    outpatient_visits_per_person_year_surgery_3 = outpatient_visits_surgery_3 / person_years_surgery_3,
    outpatient_visits_per_person_year_surgery_4 = outpatient_visits_surgery_4 / person_years_surgery_4,
    outpatient_visits_per_person_year_surgery_5 = outpatient_visits_surgery_5 / person_years_surgery_5,
    outpatient_visits_per_person_year_surgery_6 = outpatient_visits_surgery_6 / person_years_surgery_6,
    outpatient_visits_per_person_year_surgery_7 = outpatient_visits_surgery_7 / person_years_surgery_7,
    outpatient_visits_per_person_year_surgery_8 = outpatient_visits_surgery_8 / person_years_surgery_8,
    outpatient_visits_per_person_year_surgery_9 = outpatient_visits_surgery_9 / person_years_surgery_9,
    outpatient_visits_per_person_year_surgery_10 = outpatient_visits_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_0, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_0, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_1, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_1, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_2, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_2, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_3, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_3, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_4, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_4, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_5, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_5, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_6, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_6, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_7, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_7, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_8, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_8, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_9, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_9, na.rm=TRUE)

summary(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_10, na.rm=TRUE)
sd(no_intracranial_outpatient_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_visits_per_person_year_surgery_10, na.rm=TRUE)
```




Emergency department visits
```{r}
# Individual emergency department visits
no_intracranial_ED_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
no_intracranial_ED_resective_epilepsy_surgery_n 


# Individual patients with ED visits
patients_no_intracranial_ED_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_no_intracranial_ED_resective_epilepsy_surgery_n 


# Tally of patients with more than one ED visit
tally_no_intracranial_ED_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  tally(name="number_ED_visits")  %>% 
  group_by(number_ED_visits) %>% 
  tally(name="number_patients")
tally_no_intracranial_ED_resective_epilepsy_surgery




# Emergency visits per patient by year in relationship to surgery before and after surgery
no_intracranial_utilization_resective_epilepsy_surgery_emergency <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(ED_date = SVCDATE)

no_intracranial_ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5 <-
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(no_intracranial_utilization_resective_epilepsy_surgery_emergency, by="ENROLID") %>%
  select(ENROLID, ED_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_visits_surgery_minus_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(69))) & (ED_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    ED_visits_surgery_0_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(9))) & (ED_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE), 
    ED_visits_surgery_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(3))) & (ED_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
no_intracranial_ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5  
   

# ED visits per person-year by year before and after surgery
no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(no_intracranial_ED_visits_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    ED_visits_per_person_year_surgery_minus_1_5 = ED_visits_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    ED_visits_per_person_year_surgery_0_1_5 = ED_visits_surgery_0_1_5 / person_years_surgery_0_1_5,
    ED_visits_per_person_year_surgery_1_5 = ED_visits_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_no_intracranial_ED_visits_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_minus_1_5, no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_visits_per_person_year_surgery_1_5)
Wilcoxon_test_no_intracranial_ED_visits_per_person_year_resective_epilepsy_surgery_1_5




# Emergency visits per patient by year in relationship to surgery
no_intracranial_utilization_resective_epilepsy_surgery_emergency <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="emergency") %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(ED_date = SVCDATE)

no_intracranial_ED_visits_by_year_per_patient_resective_epilepsy_surgery <-
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(no_intracranial_utilization_resective_epilepsy_surgery_emergency, by="ENROLID") %>%
  select(ENROLID, ED_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_visits_surgery_minus_10 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(129))) & (ED_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_9 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(117))) & (ED_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    ED_visits_surgery_minus_8 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(105))) & (ED_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_7 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(93))) & (ED_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_6 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(81))) & (ED_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(69))) & (ED_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_4 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(57))) & (ED_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_3 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(45))) & (ED_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_2 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(33))) & (ED_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_1 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(21))) & (ED_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_0 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(9))) & (ED_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      ED_visits_surgery_1 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(3))) & (ED_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     ED_visits_surgery_2 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(15))) & (ED_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     ED_visits_surgery_3 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(27))) & (ED_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_4 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(39))) & (ED_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     ED_visits_surgery_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(51))) & (ED_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_6 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(63))) & (ED_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     ED_visits_surgery_7 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(75))) & (ED_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     ED_visits_surgery_8 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(87))) & (ED_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     ED_visits_surgery_9 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(99))) & (ED_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_10 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(111))) & (ED_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
no_intracranial_ED_visits_by_year_per_patient_resective_epilepsy_surgery  
   

# ED visits per person-year by year
no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(no_intracranial_ED_visits_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    ED_visits_per_person_year_surgery_minus_10 = ED_visits_surgery_minus_10 / person_years_surgery_minus_10,
    ED_visits_per_person_year_surgery_minus_9 = ED_visits_surgery_minus_9 / person_years_surgery_minus_9,
    ED_visits_per_person_year_surgery_minus_8 = ED_visits_surgery_minus_8 / person_years_surgery_minus_8,
    ED_visits_per_person_year_surgery_minus_7 = ED_visits_surgery_minus_7 / person_years_surgery_minus_7,
    ED_visits_per_person_year_surgery_minus_6 = ED_visits_surgery_minus_6 / person_years_surgery_minus_6,
    ED_visits_per_person_year_surgery_minus_5 = ED_visits_surgery_minus_5 / person_years_surgery_minus_5,
    ED_visits_per_person_year_surgery_minus_4 = ED_visits_surgery_minus_4 / person_years_surgery_minus_4,
    ED_visits_per_person_year_surgery_minus_3 = ED_visits_surgery_minus_3 / person_years_surgery_minus_3,
    ED_visits_per_person_year_surgery_minus_2 = ED_visits_surgery_minus_2 / person_years_surgery_minus_2,
    ED_visits_per_person_year_surgery_minus_1 = ED_visits_surgery_minus_1 / person_years_surgery_minus_1,
    ED_visits_per_person_year_surgery_0 = ED_visits_surgery_0 / person_years_surgery_0,
    ED_visits_per_person_year_surgery_1 = ED_visits_surgery_1 / person_years_surgery_1,
    ED_visits_per_person_year_surgery_2 = ED_visits_surgery_2 / person_years_surgery_2,
    ED_visits_per_person_year_surgery_3 = ED_visits_surgery_3 / person_years_surgery_3,
    ED_visits_per_person_year_surgery_4 = ED_visits_surgery_4 / person_years_surgery_4,
    ED_visits_per_person_year_surgery_5 = ED_visits_surgery_5 / person_years_surgery_5,
    ED_visits_per_person_year_surgery_6 = ED_visits_surgery_6 / person_years_surgery_6,
    ED_visits_per_person_year_surgery_7 = ED_visits_surgery_7 / person_years_surgery_7,
    ED_visits_per_person_year_surgery_8 = ED_visits_surgery_8 / person_years_surgery_8,
    ED_visits_per_person_year_surgery_9 = ED_visits_surgery_9 / person_years_surgery_9,
    ED_visits_per_person_year_surgery_10 = ED_visits_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_0, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_0, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_1, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_1, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_2, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_2, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_3, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_3, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_4, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_4, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_5, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_5, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_6, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_6, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_7, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_7, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_8, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_8, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_9, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_9, na.rm=TRUE)

summary(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_10, na.rm=TRUE)
sd(no_intracranial_ED_visits_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_visits_per_person_year_surgery_10, na.rm=TRUE)
```




Hospital admissions
```{r}
# Individual hospital admissions
no_intracranial_hospital_admission_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
no_intracranial_hospital_admission_resective_epilepsy_surgery_n 


# Individual patients with hospital admissions
patients_no_intracranial_hospital_admission_resective_epilepsy_surgery_n <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_no_intracranial_hospital_admission_resective_epilepsy_surgery_n 


# Tally of patients with more than one hospital admission
tally_no_intracranial_hospital_admission_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>%
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  group_by(ENROLID) %>% 
  tally(name="number_hospital_admissions")  %>% 
  group_by(number_hospital_admissions) %>% 
  tally(name="number_hospital_admissions")
tally_no_intracranial_hospital_admission_resective_epilepsy_surgery




# Hospital admissions per patient before and after surgery
no_intracranial_utilization_resective_epilepsy_surgery_inpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(hospital_admission_date = SVCDATE)

no_intracranial_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(no_intracranial_utilization_resective_epilepsy_surgery_inpatient, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    hospital_admissions_surgery_minus_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    hospital_admissions_surgery_0_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
no_intracranial_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Hospital admissions per person-year by year
no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(no_intracranial_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    hospital_admissions_per_person_year_surgery_minus_1_5 = hospital_admissions_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    hospital_admissions_per_person_year_surgery_0_1_5 = hospital_admissions_surgery_0_1_5 / person_years_surgery_0_1_5,
    hospital_admissions_per_person_year_surgery_1_5 = hospital_admissions_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_no_intracranial_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$hospital_admissions_per_person_year_surgery_1_5)
Wilcoxon_test_no_intracranial_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5




# Hospital admissions per patient by year in relationship to surgery
no_intracranial_utilization_resective_epilepsy_surgery_inpatient <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(hospital_admission_date = SVCDATE)

no_intracranial_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(no_intracranial_utilization_resective_epilepsy_surgery_inpatient, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    hospital_admissions_surgery_minus_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(129))) & (hospital_admission_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(117))) & (hospital_admission_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    hospital_admissions_surgery_minus_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(105))) & (hospital_admission_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),  
    hospital_admissions_surgery_minus_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(93))) & (hospital_admission_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(81))) & (hospital_admission_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(57))) & (hospital_admission_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(45))) & (hospital_admission_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(33))) & (hospital_admission_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(21))) & (hospital_admission_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_0 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      hospital_admissions_surgery_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(15))) & (hospital_admission_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(27))) & (hospital_admission_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(39))) & (hospital_admission_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(51))) & (hospital_admission_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(63))) & (hospital_admission_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(75))) & (hospital_admission_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(87))) & (hospital_admission_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(99))) & (hospital_admission_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE), 
    hospital_admissions_surgery_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(111))) & (hospital_admission_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
no_intracranial_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery  
   

# Hospital admissions per person-year by year
no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(no_intracranial_hospital_admissions_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    hospital_admissions_per_person_year_surgery_minus_10 = hospital_admissions_surgery_minus_10 / person_years_surgery_minus_10,
    hospital_admissions_per_person_year_surgery_minus_9 = hospital_admissions_surgery_minus_9 / person_years_surgery_minus_9,
    hospital_admissions_per_person_year_surgery_minus_8 = hospital_admissions_surgery_minus_8 / person_years_surgery_minus_8,
    hospital_admissions_per_person_year_surgery_minus_7 = hospital_admissions_surgery_minus_7 / person_years_surgery_minus_7,
    hospital_admissions_per_person_year_surgery_minus_6 = hospital_admissions_surgery_minus_6 / person_years_surgery_minus_6,
    hospital_admissions_per_person_year_surgery_minus_5 = hospital_admissions_surgery_minus_5 / person_years_surgery_minus_5,
    hospital_admissions_per_person_year_surgery_minus_4 = hospital_admissions_surgery_minus_4 / person_years_surgery_minus_4,
    hospital_admissions_per_person_year_surgery_minus_3 = hospital_admissions_surgery_minus_3 / person_years_surgery_minus_3,
    hospital_admissions_per_person_year_surgery_minus_2 = hospital_admissions_surgery_minus_2 / person_years_surgery_minus_2,
    hospital_admissions_per_person_year_surgery_minus_1 = hospital_admissions_surgery_minus_1 / person_years_surgery_minus_1,
    hospital_admissions_per_person_year_surgery_0 = hospital_admissions_surgery_0 / person_years_surgery_0,
    hospital_admissions_per_person_year_surgery_1 = hospital_admissions_surgery_1 / person_years_surgery_1,
    hospital_admissions_per_person_year_surgery_2 = hospital_admissions_surgery_2 / person_years_surgery_2,
    hospital_admissions_per_person_year_surgery_3 = hospital_admissions_surgery_3 / person_years_surgery_3,
    hospital_admissions_per_person_year_surgery_4 = hospital_admissions_surgery_4 / person_years_surgery_4,
    hospital_admissions_per_person_year_surgery_5 = hospital_admissions_surgery_5 / person_years_surgery_5,
    hospital_admissions_per_person_year_surgery_6 = hospital_admissions_surgery_6 / person_years_surgery_6,
    hospital_admissions_per_person_year_surgery_7 = hospital_admissions_surgery_7 / person_years_surgery_7,
    hospital_admissions_per_person_year_surgery_8 = hospital_admissions_surgery_8 / person_years_surgery_8,
    hospital_admissions_per_person_year_surgery_9 = hospital_admissions_surgery_9 / person_years_surgery_9,
    hospital_admissions_per_person_year_surgery_10 = hospital_admissions_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_0, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_0, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_1, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_1, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_2, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_2, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_3, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_3, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_4, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_4, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_5, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_5, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_6, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_6, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_7, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_7, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_8, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_8, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_9, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_9, na.rm=TRUE)

summary(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_10, na.rm=TRUE)
sd(no_intracranial_hospital_admissions_by_year_per_person_year_individually_resective_epilepsy_surgery$hospital_admissions_per_person_year_surgery_10, na.rm=TRUE)
```




Length of stay in hospital admissions for resective epilepsy surgery
```{r}
# Length of hospital stay in patients with resective epilepsy surgery
no_intracranial_LOS_resective_epilepsy_surgery <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  ungroup() %>% 
  summarize(total_LOS = sum(LOS))
no_intracranial_LOS_resective_epilepsy_surgery




# Length of hospital stay per patient before and after surgery
no_intracranial_utilization_resective_epilepsy_surgery_LOS <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE, LOS) %>% 
  rename(hospital_admission_date = SVCDATE)

no_intracranial_LOS_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(no_intracranial_utilization_resective_epilepsy_surgery_LOS, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date, LOS) %>%
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    LOS_surgery_minus_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(9)))), LOS, 0), na.rm=TRUE)/5,
    LOS_surgery_0_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(63)))), LOS, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
no_intracranial_LOS_by_year_per_patient_resective_epilepsy_surgery_1_5  
   

# Length of stay per person-year by year before and after surgery
no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(no_intracranial_LOS_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    LOS_per_person_year_surgery_minus_1_5 = LOS_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    LOS_per_person_year_surgery_0_1_5 = LOS_surgery_0_1_5 / person_years_surgery_0_1_5,
    LOS_per_person_year_surgery_1_5 = LOS_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_no_intracranial_LOS_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_minus_1_5, no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$LOS_per_person_year_surgery_1_5)
Wilcoxon_test_no_intracranial_LOS_per_person_year_resective_epilepsy_surgery_1_5




# LOS per patient by year in relationship to surgery
no_intracranial_utilization_resective_epilepsy_surgery_LOS <- utilization_resective_epilepsy_surgery %>% 
  filter(setting=="inpatient") %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  select(ENROLID, SVCDATE, LOS) %>% 
  rename(hospital_admission_date = SVCDATE)

no_intracranial_LOS_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(no_intracranial_utilization_resective_epilepsy_surgery_LOS, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date, LOS) %>%
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    LOS_surgery_minus_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(129))) & (hospital_admission_date < (surgery_date - months(117)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(117))) & (hospital_admission_date < (surgery_date - months(105)))), LOS, 0), na.rm=TRUE), 
    LOS_surgery_minus_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(105))) & (hospital_admission_date < (surgery_date - months(93)))), LOS, 0), na.rm=TRUE),  
    LOS_surgery_minus_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(93))) & (hospital_admission_date < (surgery_date - months(81)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(81))) & (hospital_admission_date < (surgery_date - months(69)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(57)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(57))) & (hospital_admission_date < (surgery_date - months(45)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(45))) & (hospital_admission_date < (surgery_date - months(33)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(33))) & (hospital_admission_date < (surgery_date - months(21)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(21))) & (hospital_admission_date < (surgery_date - months(9)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_0 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), LOS, 0), na.rm=TRUE),      LOS_surgery_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(15)))), LOS, 0), na.rm=TRUE),     LOS_surgery_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(15))) & (hospital_admission_date < (surgery_date + months(27)))), LOS, 0), na.rm=TRUE),     LOS_surgery_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(27))) & (hospital_admission_date < (surgery_date + months(39)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(39))) & (hospital_admission_date < (surgery_date + months(51)))), LOS, 0), na.rm=TRUE),     LOS_surgery_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(51))) & (hospital_admission_date < (surgery_date + months(63)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(63))) & (hospital_admission_date < (surgery_date + months(75)))), LOS, 0), na.rm=TRUE),     LOS_surgery_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(75))) & (hospital_admission_date < (surgery_date + months(87)))), LOS, 0), na.rm=TRUE),     LOS_surgery_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(87))) & (hospital_admission_date < (surgery_date + months(99)))), LOS, 0), na.rm=TRUE),     LOS_surgery_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(99))) & (hospital_admission_date < (surgery_date + months(111)))), LOS, 0), na.rm=TRUE), 
    LOS_surgery_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(111))) & (hospital_admission_date < (surgery_date + months(123)))), LOS, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
no_intracranial_LOS_by_year_per_patient_resective_epilepsy_surgery  
   

# Length of stay per person-year by year
no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(no_intracranial_LOS_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    LOS_per_person_year_surgery_minus_10 = LOS_surgery_minus_10 / person_years_surgery_minus_10,
    LOS_per_person_year_surgery_minus_9 = LOS_surgery_minus_9 / person_years_surgery_minus_9,
    LOS_per_person_year_surgery_minus_8 = LOS_surgery_minus_8 / person_years_surgery_minus_8,
    LOS_per_person_year_surgery_minus_7 = LOS_surgery_minus_7 / person_years_surgery_minus_7,
    LOS_per_person_year_surgery_minus_6 = LOS_surgery_minus_6 / person_years_surgery_minus_6,
    LOS_per_person_year_surgery_minus_5 = LOS_surgery_minus_5 / person_years_surgery_minus_5,
    LOS_per_person_year_surgery_minus_4 = LOS_surgery_minus_4 / person_years_surgery_minus_4,
    LOS_per_person_year_surgery_minus_3 = LOS_surgery_minus_3 / person_years_surgery_minus_3,
    LOS_per_person_year_surgery_minus_2 = LOS_surgery_minus_2 / person_years_surgery_minus_2,
    LOS_per_person_year_surgery_minus_1 = LOS_surgery_minus_1 / person_years_surgery_minus_1,
    LOS_per_person_year_surgery_0 = LOS_surgery_0 / person_years_surgery_0,
    LOS_per_person_year_surgery_1 = LOS_surgery_1 / person_years_surgery_1,
    LOS_per_person_year_surgery_2 = LOS_surgery_2 / person_years_surgery_2,
    LOS_per_person_year_surgery_3 = LOS_surgery_3 / person_years_surgery_3,
    LOS_per_person_year_surgery_4 = LOS_surgery_4 / person_years_surgery_4,
    LOS_per_person_year_surgery_5 = LOS_surgery_5 / person_years_surgery_5,
    LOS_per_person_year_surgery_6 = LOS_surgery_6 / person_years_surgery_6,
    LOS_per_person_year_surgery_7 = LOS_surgery_7 / person_years_surgery_7,
    LOS_per_person_year_surgery_8 = LOS_surgery_8 / person_years_surgery_8,
    LOS_per_person_year_surgery_9 = LOS_surgery_9 / person_years_surgery_9,
    LOS_per_person_year_surgery_10 = LOS_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_0, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_0, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_1, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_1, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_2, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_2, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_3, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_3, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_4, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_4, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_5, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_5, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_6, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_6, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_7, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_7, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_8, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_8, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_9, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_9, na.rm=TRUE)

summary(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_10, na.rm=TRUE)
sd(no_intracranial_LOS_by_year_per_person_year_individually_resective_epilepsy_surgery$LOS_per_person_year_surgery_10, na.rm=TRUE)
```




Cost in patients with resective epilepsy surgery
```{r}
# Cost in patients with resective epilepsy surgery
no_intracranial_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
no_intracranial_cost_resective_epilepsy_surgery




# Cost per patient before and after surgery
no_intracranial_utilization_resective_epilepsy_surgery_total_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


total_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(no_intracranial_utilization_resective_epilepsy_surgery_total_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    total_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    total_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
total_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Total cost per person-year by year before and after surgery
total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(total_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    total_cost_per_person_year_surgery_minus_1_5 = total_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    total_cost_per_person_year_surgery_0_1_5 = total_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    total_cost_per_person_year_surgery_1_5 = total_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_no_intracranial_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_minus_1_5, total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$total_cost_per_person_year_surgery_1_5)
Wilcoxon_test_no_intracranial_cost_per_person_year_resective_epilepsy_surgery_1_5




# Total cost per patient by year in relationship to surgery
no_intracranial_utilization_resective_epilepsy_surgery_total_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


total_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(no_intracranial_utilization_resective_epilepsy_surgery_total_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    total_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    total_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    total_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      total_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    total_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
total_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Total cost per person-year by year
total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(total_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    total_cost_per_person_year_surgery_minus_10 = total_cost_surgery_minus_10 / person_years_surgery_minus_10,
    total_cost_per_person_year_surgery_minus_9 = total_cost_surgery_minus_9 / person_years_surgery_minus_9,
    total_cost_per_person_year_surgery_minus_8 = total_cost_surgery_minus_8 / person_years_surgery_minus_8,
    total_cost_per_person_year_surgery_minus_7 = total_cost_surgery_minus_7 / person_years_surgery_minus_7,
    total_cost_per_person_year_surgery_minus_6 = total_cost_surgery_minus_6 / person_years_surgery_minus_6,
    total_cost_per_person_year_surgery_minus_5 = total_cost_surgery_minus_5 / person_years_surgery_minus_5,
    total_cost_per_person_year_surgery_minus_4 = total_cost_surgery_minus_4 / person_years_surgery_minus_4,
    total_cost_per_person_year_surgery_minus_3 = total_cost_surgery_minus_3 / person_years_surgery_minus_3,
    total_cost_per_person_year_surgery_minus_2 = total_cost_surgery_minus_2 / person_years_surgery_minus_2,
    total_cost_per_person_year_surgery_minus_1 = total_cost_surgery_minus_1 / person_years_surgery_minus_1,
    total_cost_per_person_year_surgery_0 = total_cost_surgery_0 / person_years_surgery_0,
    total_cost_per_person_year_surgery_1 = total_cost_surgery_1 / person_years_surgery_1,
    total_cost_per_person_year_surgery_2 = total_cost_surgery_2 / person_years_surgery_2,
    total_cost_per_person_year_surgery_3 = total_cost_surgery_3 / person_years_surgery_3,
    total_cost_per_person_year_surgery_4 = total_cost_surgery_4 / person_years_surgery_4,
    total_cost_per_person_year_surgery_5 = total_cost_surgery_5 / person_years_surgery_5,
    total_cost_per_person_year_surgery_6 = total_cost_surgery_6 / person_years_surgery_6,
    total_cost_per_person_year_surgery_7 = total_cost_surgery_7 / person_years_surgery_7,
    total_cost_per_person_year_surgery_8 = total_cost_surgery_8 / person_years_surgery_8,
    total_cost_per_person_year_surgery_9 = total_cost_surgery_9 / person_years_surgery_9,
    total_cost_per_person_year_surgery_10 = total_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Total cost figure in patients with resective epilepsy surgery
```{r}
# Total cost figure
data_figure_total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- tibble(
  "year" = factor(c("Year -5", "Year -4", "Year -3", "Year -2", "Year -1", "Year surgery", "Year +1", "Year +2", "Year +3", "Year +4", "Year +5"), levels=c("Year -5", "Year -4", "Year -3", "Year -2", "Year -1", "Year surgery", "Year +1", "Year +2", "Year +3", "Year +4", "Year +5")),
  "median_cost" = c(summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[3],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[3],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[3],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[3],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[3],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[3],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[3],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[3],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[3],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[3],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[3]),
  "p25_cost" = c(summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[2],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[2],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[2],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[2],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[2],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[2],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[2],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[2],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[2],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[2],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[2]),  
  "p75_cost" = c(summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[5],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[5],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[5],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[5],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[5],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_0, na.rm=TRUE)[5],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_1, na.rm=TRUE)[5],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_2, na.rm=TRUE)[5],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_3, na.rm=TRUE)[5],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_4, na.rm=TRUE)[5],
                  summary(total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$total_cost_per_person_year_surgery_5, na.rm=TRUE)[5])    
  )


figure_total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- ggplot(data=data_figure_total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery) + 
  geom_point(aes(x=year, y=median_cost), color="purple2", size=5) +
  geom_point(aes(x=year, y=p25_cost), color="darkgreen", size=4) +
  geom_point(aes(x=year, y=p75_cost), color="darkgreen", size=4) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=22, face="bold")) +
  scale_x_discrete(name="Year") +
  scale_y_continuous(name="Cost ($) per person-year", breaks=seq(0, 200000, 50000), limits = c(0, 200000))
figure_total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery
ggplotly(figure_total_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery)
```




Outpatient cost in patients with resective epilepsy surgery
```{r}
# Outpatient cost in patients with resective epilepsy surgery
outpatient_no_intracranial_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="outpatient") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
outpatient_no_intracranial_cost_resective_epilepsy_surgery




# Outpatient cost per patient before and after surgery
no_intracranial_utilization_resective_epilepsy_surgery_outpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


outpatient_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(no_intracranial_utilization_resective_epilepsy_surgery_outpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    outpatient_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Outpatient cost per person-year by year before and after surgery
outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(outpatient_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    outpatient_cost_per_person_year_surgery_minus_1_5 = outpatient_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    outpatient_cost_per_person_year_surgery_0_1_5 = outpatient_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    outpatient_cost_per_person_year_surgery_1_5 = outpatient_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_outpatient_no_intracranial_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$outpatient_cost_per_person_year_surgery_1_5)
Wilcoxon_test_outpatient_no_intracranial_cost_per_person_year_resective_epilepsy_surgery_1_5




# Outpatient cost per patient by year in relationship to surgery
no_intracranial_utilization_resective_epilepsy_surgery_outpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


outpatient_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(no_intracranial_utilization_resective_epilepsy_surgery_outpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    outpatient_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    outpatient_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      outpatient_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    outpatient_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Outpatient cost per person-year by year
outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(outpatient_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    outpatient_cost_per_person_year_surgery_minus_10 = outpatient_cost_surgery_minus_10 / person_years_surgery_minus_10,
    outpatient_cost_per_person_year_surgery_minus_9 = outpatient_cost_surgery_minus_9 / person_years_surgery_minus_9,
    outpatient_cost_per_person_year_surgery_minus_8 = outpatient_cost_surgery_minus_8 / person_years_surgery_minus_8,
    outpatient_cost_per_person_year_surgery_minus_7 = outpatient_cost_surgery_minus_7 / person_years_surgery_minus_7,
    outpatient_cost_per_person_year_surgery_minus_6 = outpatient_cost_surgery_minus_6 / person_years_surgery_minus_6,
    outpatient_cost_per_person_year_surgery_minus_5 = outpatient_cost_surgery_minus_5 / person_years_surgery_minus_5,
    outpatient_cost_per_person_year_surgery_minus_4 = outpatient_cost_surgery_minus_4 / person_years_surgery_minus_4,
    outpatient_cost_per_person_year_surgery_minus_3 = outpatient_cost_surgery_minus_3 / person_years_surgery_minus_3,
    outpatient_cost_per_person_year_surgery_minus_2 = outpatient_cost_surgery_minus_2 / person_years_surgery_minus_2,
    outpatient_cost_per_person_year_surgery_minus_1 = outpatient_cost_surgery_minus_1 / person_years_surgery_minus_1,
    outpatient_cost_per_person_year_surgery_0 = outpatient_cost_surgery_0 / person_years_surgery_0,
    outpatient_cost_per_person_year_surgery_1 = outpatient_cost_surgery_1 / person_years_surgery_1,
    outpatient_cost_per_person_year_surgery_2 = outpatient_cost_surgery_2 / person_years_surgery_2,
    outpatient_cost_per_person_year_surgery_3 = outpatient_cost_surgery_3 / person_years_surgery_3,
    outpatient_cost_per_person_year_surgery_4 = outpatient_cost_surgery_4 / person_years_surgery_4,
    outpatient_cost_per_person_year_surgery_5 = outpatient_cost_surgery_5 / person_years_surgery_5,
    outpatient_cost_per_person_year_surgery_6 = outpatient_cost_surgery_6 / person_years_surgery_6,
    outpatient_cost_per_person_year_surgery_7 = outpatient_cost_surgery_7 / person_years_surgery_7,
    outpatient_cost_per_person_year_surgery_8 = outpatient_cost_surgery_8 / person_years_surgery_8,
    outpatient_cost_per_person_year_surgery_9 = outpatient_cost_surgery_9 / person_years_surgery_9,
    outpatient_cost_per_person_year_surgery_10 = outpatient_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(outpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$outpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
```




ED cost in patients with resective epilepsy surgery
```{r}
# ED cost in patients with resective epilepsy surgery
ED_no_intracranial_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="emergency") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
ED_no_intracranial_cost_resective_epilepsy_surgery




# ED cost per patient before and after surgery
no_intracranial_utilization_resective_epilepsy_surgery_ED_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="emergency") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


ED_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(no_intracranial_utilization_resective_epilepsy_surgery_ED_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    ED_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# ED cost per person-year by year before and after surgery
ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(ED_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    ED_cost_per_person_year_surgery_minus_1_5 = ED_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    ED_cost_per_person_year_surgery_0_1_5 = ED_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    ED_cost_per_person_year_surgery_1_5 = ED_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_ED_no_intracranial_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_minus_1_5, ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$ED_cost_per_person_year_surgery_1_5)
Wilcoxon_test_ED_no_intracranial_cost_per_person_year_resective_epilepsy_surgery_1_5




# ED cost per patient by year in relationship to surgery
no_intracranial_utilization_resective_epilepsy_surgery_ED_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="emergency") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


ED_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(no_intracranial_utilization_resective_epilepsy_surgery_ED_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    ED_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    ED_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      ED_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    ED_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# ED cost per person-year by year
ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(ED_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    ED_cost_per_person_year_surgery_minus_10 = ED_cost_surgery_minus_10 / person_years_surgery_minus_10,
    ED_cost_per_person_year_surgery_minus_9 = ED_cost_surgery_minus_9 / person_years_surgery_minus_9,
    ED_cost_per_person_year_surgery_minus_8 = ED_cost_surgery_minus_8 / person_years_surgery_minus_8,
    ED_cost_per_person_year_surgery_minus_7 = ED_cost_surgery_minus_7 / person_years_surgery_minus_7,
    ED_cost_per_person_year_surgery_minus_6 = ED_cost_surgery_minus_6 / person_years_surgery_minus_6,
    ED_cost_per_person_year_surgery_minus_5 = ED_cost_surgery_minus_5 / person_years_surgery_minus_5,
    ED_cost_per_person_year_surgery_minus_4 = ED_cost_surgery_minus_4 / person_years_surgery_minus_4,
    ED_cost_per_person_year_surgery_minus_3 = ED_cost_surgery_minus_3 / person_years_surgery_minus_3,
    ED_cost_per_person_year_surgery_minus_2 = ED_cost_surgery_minus_2 / person_years_surgery_minus_2,
    ED_cost_per_person_year_surgery_minus_1 = ED_cost_surgery_minus_1 / person_years_surgery_minus_1,
    ED_cost_per_person_year_surgery_0 = ED_cost_surgery_0 / person_years_surgery_0,
    ED_cost_per_person_year_surgery_1 = ED_cost_surgery_1 / person_years_surgery_1,
    ED_cost_per_person_year_surgery_2 = ED_cost_surgery_2 / person_years_surgery_2,
    ED_cost_per_person_year_surgery_3 = ED_cost_surgery_3 / person_years_surgery_3,
    ED_cost_per_person_year_surgery_4 = ED_cost_surgery_4 / person_years_surgery_4,
    ED_cost_per_person_year_surgery_5 = ED_cost_surgery_5 / person_years_surgery_5,
    ED_cost_per_person_year_surgery_6 = ED_cost_surgery_6 / person_years_surgery_6,
    ED_cost_per_person_year_surgery_7 = ED_cost_surgery_7 / person_years_surgery_7,
    ED_cost_per_person_year_surgery_8 = ED_cost_surgery_8 / person_years_surgery_8,
    ED_cost_per_person_year_surgery_9 = ED_cost_surgery_9 / person_years_surgery_9,
    ED_cost_per_person_year_surgery_10 = ED_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(ED_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$ED_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Inpatient cost in patients with resective epilepsy surgery
```{r}
# Inpatient cost in patients with resective epilepsy surgery
inpatient_no_intracranial_cost_resective_epilepsy_surgery <- 
  inflation_adjusted_utilization_resective_epilepsy_surgery %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="inpatient") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
inpatient_no_intracranial_cost_resective_epilepsy_surgery




# Inpatient cost per patient before and after surgery
no_intracranial_utilization_resective_epilepsy_surgery_inpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


inpatient_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery_1_5 <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(no_intracranial_utilization_resective_epilepsy_surgery_inpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    inpatient_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    inpatient_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
inpatient_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery_1_5
   

# Inpatient cost per person-year by year before and after surgery
inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5 <- 
  no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery_1_5 %>% 
  left_join(inpatient_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery_1_5, by="ENROLID") %>% 
  mutate(
    inpatient_cost_per_person_year_surgery_minus_1_5 = inpatient_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    inpatient_cost_per_person_year_surgery_0_1_5 = inpatient_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    inpatient_cost_per_person_year_surgery_1_5 = inpatient_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_inpatient_no_intracranial_cost_per_person_year_resective_epilepsy_surgery_1_5 <- wilcox.test(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery_1_5$inpatient_cost_per_person_year_surgery_1_5)
Wilcoxon_test_inpatient_no_intracranial_cost_per_person_year_resective_epilepsy_surgery_1_5




# Inpatient cost per patient by year in relationship to surgery
no_intracranial_utilization_resective_epilepsy_surgery_inpatient_cost <- inflation_adjusted_utilization_resective_epilepsy_surgery %>%
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


inpatient_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery <- 
  resective_epilepsy_surgery_one_surgery %>% 
  filter(ENROLID %in% no_intracranial_patients_resective_epilepsy_surgery$ENROLID) %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(no_intracranial_utilization_resective_epilepsy_surgery_inpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    inpatient_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    inpatient_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    inpatient_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      inpatient_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    inpatient_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
inpatient_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery  
   

# Inpatient cost per person-year by year
inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery <- 
  no_intracranial_person_years_by_year_resective_epilepsy_surgery_one_surgery %>% 
  left_join(inpatient_no_intracranial_cost_by_year_per_patient_resective_epilepsy_surgery, by="ENROLID") %>% 
  mutate(
    inpatient_cost_per_person_year_surgery_minus_10 = inpatient_cost_surgery_minus_10 / person_years_surgery_minus_10,
    inpatient_cost_per_person_year_surgery_minus_9 = inpatient_cost_surgery_minus_9 / person_years_surgery_minus_9,
    inpatient_cost_per_person_year_surgery_minus_8 = inpatient_cost_surgery_minus_8 / person_years_surgery_minus_8,
    inpatient_cost_per_person_year_surgery_minus_7 = inpatient_cost_surgery_minus_7 / person_years_surgery_minus_7,
    inpatient_cost_per_person_year_surgery_minus_6 = inpatient_cost_surgery_minus_6 / person_years_surgery_minus_6,
    inpatient_cost_per_person_year_surgery_minus_5 = inpatient_cost_surgery_minus_5 / person_years_surgery_minus_5,
    inpatient_cost_per_person_year_surgery_minus_4 = inpatient_cost_surgery_minus_4 / person_years_surgery_minus_4,
    inpatient_cost_per_person_year_surgery_minus_3 = inpatient_cost_surgery_minus_3 / person_years_surgery_minus_3,
    inpatient_cost_per_person_year_surgery_minus_2 = inpatient_cost_surgery_minus_2 / person_years_surgery_minus_2,
    inpatient_cost_per_person_year_surgery_minus_1 = inpatient_cost_surgery_minus_1 / person_years_surgery_minus_1,
    inpatient_cost_per_person_year_surgery_0 = inpatient_cost_surgery_0 / person_years_surgery_0,
    inpatient_cost_per_person_year_surgery_1 = inpatient_cost_surgery_1 / person_years_surgery_1,
    inpatient_cost_per_person_year_surgery_2 = inpatient_cost_surgery_2 / person_years_surgery_2,
    inpatient_cost_per_person_year_surgery_3 = inpatient_cost_surgery_3 / person_years_surgery_3,
    inpatient_cost_per_person_year_surgery_4 = inpatient_cost_surgery_4 / person_years_surgery_4,
    inpatient_cost_per_person_year_surgery_5 = inpatient_cost_surgery_5 / person_years_surgery_5,
    inpatient_cost_per_person_year_surgery_6 = inpatient_cost_surgery_6 / person_years_surgery_6,
    inpatient_cost_per_person_year_surgery_7 = inpatient_cost_surgery_7 / person_years_surgery_7,
    inpatient_cost_per_person_year_surgery_8 = inpatient_cost_surgery_8 / person_years_surgery_8,
    inpatient_cost_per_person_year_surgery_9 = inpatient_cost_surgery_9 / person_years_surgery_9,
    inpatient_cost_per_person_year_surgery_10 = inpatient_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(inpatient_no_intracranial_cost_by_year_per_person_year_individually_resective_epilepsy_surgery$inpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
```








## 9. Clinical and economic outcomes in hemispherectomy




Healthcare resource utilization among patients with hemispherectomy
```{r}
# Resource utilization
revenue_codes_EDvisits <- c("0450", "0451", "0452", "0456", "0459", "0981")
place_of_service_codes_EDvisits <- c("20", "23", "41", "42")
CPT_codes_EDvisits <- c("99281", "99282", "99283", "99284", "99285")
service_subcategory_codes_EDvisits <- c("10120", "10220", "10320", "10420", "10520", "12220", "20120", "20220", "21120", "21220", "22120", "22320", "30120", "30220", "30320", "30420", "30520", "30620", "31120", "31220", "31320", "31420", "31520", "31620")
PROCGRP_codes_EDvisits <- c("111", "114")

revenue_codes_inpatient <- c("0100", "0101", "0110", "0111", "0112", "0113", "0114", "0115", "0116", "0117", "0118", "0119", "0120", "0121", "0122", "0123", "0124", "0125", "0126", "0127", "0128", "0129", "0130", "0131", "0132", "0133", "0134", "0135", "0136", "0137", "0138", "0139", "0140", "0141", "0142", "0143", "0144", "0145", "0146", "0147", "0148", "0149", "0150", "0151", "0152", "0153", "0154", "0155", "0156", "0157", "0158", "0159", "0160", "0161", "0162", "0164", "0166", "0167", "0168", "0169", "0170", "0171", "0172", "0173", "0174", "0175", "0179", "0180", "0182", "0183", "0184", "0185", "0189", "0190", "0191", "0192", "0193", "0194", "0199", "0200", "0201", "0202", "0203", "0204", "0206", "0207", "0208", "0209", "0210", "0211", "0212", "0213", "0214", "0219", "0720", "0721", "0722", "0723", "0724", "0729", "0760", "0761", "0762", "0769", "0800", "0801", "0802", "0803", "0804", "0809")
place_of_service_codes_inpatient <- c("21", "27", "28", "51", "61")
CPT_codes_inpatient <- c("99217", "99218", "99219", "99220", "99224", "99225", "99226", "99234", "99235", "99236")




#################################2006#################################
utilization_hemispherectomy_2006_o <- ms_o_2006 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2006_i <- ms_i_2006 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2006_s <- ms_s_2006 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2007#################################
utilization_hemispherectomy_2007_o <- ms_o_2007 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2007_i <- ms_i_2007 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2007_s <- ms_s_2007 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2008#################################
utilization_hemispherectomy_2008_o <- ms_o_2008 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2008_i <- ms_i_2008 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2008_s <- ms_s_2008 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2009#################################
utilization_hemispherectomy_2009_o <- ms_o_2009 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2009_i <- ms_i_2009 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2009_s <- ms_s_2009 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2010#################################
utilization_hemispherectomy_2010_o <- ms_o_2010 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2010_i <- ms_i_2010 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2010_s <- ms_s_2010 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2011#################################
utilization_hemispherectomy_2011_o <- ms_o_2011 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2011_i <- ms_i_2011 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2011_s <- ms_s_2011 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2012#################################
utilization_hemispherectomy_2012_o <- ms_o_2012 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2012_i <- ms_i_2012 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2012_s <- ms_s_2012 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2013#################################
utilization_hemispherectomy_2013_o <- ms_o_2013 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2013_i <- ms_i_2013 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2013_s <- ms_s_2013 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2014#################################
utilization_hemispherectomy_2014_o <- ms_o_2014 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2014_i <- ms_i_2014 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2014_s <- ms_s_2014%>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2015#################################
utilization_hemispherectomy_2015_o <- ms_o_2015 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2015_i <- ms_i_2015 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2015_s <- ms_s_2015%>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2016#################################
utilization_hemispherectomy_2016_o <- ms_o_2016 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2016_i <- ms_i_2016 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2016_s <- ms_s_2016%>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2017#################################
utilization_hemispherectomy_2017_o <- ms_o_2017 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2017_i <- ms_i_2017 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2017_s <- ms_s_2017%>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2018#################################
utilization_hemispherectomy_2018_o <- ms_o_2018 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2018_i <- ms_i_2018 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2018_s <- ms_s_2018%>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2019#################################
utilization_hemispherectomy_2019_o <- ms_o_2019 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2019_i <- ms_i_2019 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_hemispherectomy_2019_s <- ms_s_2019%>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!hemispherectomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)








# Utilization
utilization_hemispherectomy <- bind_rows(utilization_hemispherectomy_2006_o, utilization_hemispherectomy_2006_i, utilization_hemispherectomy_2006_s,
utilization_hemispherectomy_2007_o, utilization_hemispherectomy_2007_i, utilization_hemispherectomy_2007_s, utilization_hemispherectomy_2008_o, utilization_hemispherectomy_2008_i, utilization_hemispherectomy_2008_s,         utilization_hemispherectomy_2009_o, utilization_hemispherectomy_2009_i, utilization_hemispherectomy_2009_s, utilization_hemispherectomy_2010_o, utilization_hemispherectomy_2010_i, utilization_hemispherectomy_2010_s,        utilization_hemispherectomy_2011_o, utilization_hemispherectomy_2011_i, utilization_hemispherectomy_2011_s, utilization_hemispherectomy_2012_o, utilization_hemispherectomy_2012_i, utilization_hemispherectomy_2012_s,
utilization_hemispherectomy_2013_o, utilization_hemispherectomy_2013_i, utilization_hemispherectomy_2013_s, utilization_hemispherectomy_2014_o, utilization_hemispherectomy_2014_i, utilization_hemispherectomy_2014_s,         utilization_hemispherectomy_2015_o, utilization_hemispherectomy_2015_i, utilization_hemispherectomy_2015_s, utilization_hemispherectomy_2016_o, utilization_hemispherectomy_2016_i, utilization_hemispherectomy_2016_s,
utilization_hemispherectomy_2017_o, utilization_hemispherectomy_2017_i, utilization_hemispherectomy_2017_s, utilization_hemispherectomy_2018_o, utilization_hemispherectomy_2018_i, utilization_hemispherectomy_2018_s,
utilization_hemispherectomy_2019_o, utilization_hemispherectomy_2019_i, utilization_hemispherectomy_2019_s) %>% 
  mutate(LOS = case_when(setting=="emergency" ~ 0, TRUE ~ LOS)) %>% 
  mutate(cost = ifelse(cost>0, cost, 0)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>%     
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  arrange(ENROLID, SVCDATE, setting, desc(LOS), desc(cost)) %>% 
  mutate(difference_between_healthcare_contacts = SVCDATE - lag(SVCDATE, 1)) %>% 
  collect()
```




Outpatient visits
```{r}
# Individual outpatient visits
outpatient_visit_hemispherectomy_n <- utilization_hemispherectomy %>%
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
outpatient_visit_hemispherectomy_n 


# Individual patients with outpatient visits
patients_outpatient_visit_hemispherectomy_n <- utilization_hemispherectomy %>%
  filter(setting=="outpatient") %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_outpatient_visit_hemispherectomy_n 


# Tally of patients with more than one outpatient visit
tally_outpatient_visit_hemispherectomy <- utilization_hemispherectomy %>%
  filter(setting=="outpatient") %>% 
  group_by(ENROLID) %>% 
  tally(name="number_outpatient_visits")  %>% 
  group_by(number_outpatient_visits) %>% 
  tally(name="number_patients")
tally_outpatient_visit_hemispherectomy




# Outpatient visits per patient before and after surgery
utilization_hemispherectomy_outpatient <- utilization_hemispherectomy %>% 
  filter(setting=="outpatient") %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(outpatient_date = SVCDATE)

outpatient_visits_by_year_per_patient_hemispherectomy_1_5 <- 
  hemispherectomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_hemispherectomy_outpatient, by="ENROLID") %>%
  select(ENROLID, outpatient_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_visits_surgery_minus_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(69))) & (outpatient_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    outpatient_visits_surgery_0_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(9))) & (outpatient_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),     
    outpatient_visits_surgery_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(3))) & (outpatient_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_visits_by_year_per_patient_hemispherectomy_1_5 
   

# Outpatient visits per person-year by year
outpatient_visits_by_year_per_person_year_individually_hemispherectomy_1_5 <- 
  person_years_by_year_hemispherectomy_one_surgery_1_5 %>% 
  left_join(outpatient_visits_by_year_per_patient_hemispherectomy_1_5, by="ENROLID") %>% 
  mutate(
    outpatient_visits_per_person_year_surgery_minus_1_5 = outpatient_visits_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    outpatient_visits_per_person_year_surgery_0_1_5 = outpatient_visits_surgery_0_1_5 / person_years_surgery_0_1_5,
    outpatient_visits_per_person_year_surgery_1_5 = outpatient_visits_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy_1_5$outpatient_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy_1_5$outpatient_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy_1_5$outpatient_visits_per_person_year_surgery_1_5, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy_1_5$outpatient_visits_per_person_year_surgery_1_5, na.rm=TRUE)


# Statistical test
Wilcoxon_test_outpatient_visits_per_person_year_hemispherectomy_1_5 <- wilcox.test(outpatient_visits_by_year_per_person_year_individually_hemispherectomy_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, outpatient_visits_by_year_per_person_year_individually_hemispherectomy_1_5$outpatient_visits_per_person_year_surgery_1_5)
Wilcoxon_test_outpatient_visits_per_person_year_hemispherectomy_1_5




# Outpatient visits per patient by year in relationship to surgery
utilization_hemispherectomy_outpatient <- utilization_hemispherectomy %>% 
  filter(setting=="outpatient") %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(outpatient_date = SVCDATE)

outpatient_visits_by_year_per_patient_hemispherectomy <- 
  hemispherectomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_hemispherectomy_outpatient, by="ENROLID") %>%
  select(ENROLID, outpatient_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_visits_surgery_minus_10 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(129))) & (outpatient_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_9 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(117))) & (outpatient_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    outpatient_visits_surgery_minus_8 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(105))) & (outpatient_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),  
    outpatient_visits_surgery_minus_7 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(93))) & (outpatient_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_6 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(81))) & (outpatient_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(69))) & (outpatient_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_4 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(57))) & (outpatient_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_3 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(45))) & (outpatient_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_2 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(33))) & (outpatient_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_1 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(21))) & (outpatient_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_0 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(9))) & (outpatient_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      outpatient_visits_surgery_1 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(3))) & (outpatient_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_2 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(15))) & (outpatient_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_3 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(27))) & (outpatient_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_4 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(39))) & (outpatient_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(51))) & (outpatient_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_6 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(63))) & (outpatient_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_7 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(75))) & (outpatient_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_8 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(87))) & (outpatient_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_9 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(99))) & (outpatient_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE), 
    outpatient_visits_surgery_10 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(111))) & (outpatient_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_visits_by_year_per_patient_hemispherectomy  
   

# Outpatient visits per person-year by year
outpatient_visits_by_year_per_person_year_individually_hemispherectomy <- 
  person_years_by_year_hemispherectomy_one_surgery %>% 
  left_join(outpatient_visits_by_year_per_patient_hemispherectomy, by="ENROLID") %>% 
  mutate(
    outpatient_visits_per_person_year_surgery_minus_10 = outpatient_visits_surgery_minus_10 / person_years_surgery_minus_10,
    outpatient_visits_per_person_year_surgery_minus_9 = outpatient_visits_surgery_minus_9 / person_years_surgery_minus_9,
    outpatient_visits_per_person_year_surgery_minus_8 = outpatient_visits_surgery_minus_8 / person_years_surgery_minus_8,
    outpatient_visits_per_person_year_surgery_minus_7 = outpatient_visits_surgery_minus_7 / person_years_surgery_minus_7,
    outpatient_visits_per_person_year_surgery_minus_6 = outpatient_visits_surgery_minus_6 / person_years_surgery_minus_6,
    outpatient_visits_per_person_year_surgery_minus_5 = outpatient_visits_surgery_minus_5 / person_years_surgery_minus_5,
    outpatient_visits_per_person_year_surgery_minus_4 = outpatient_visits_surgery_minus_4 / person_years_surgery_minus_4,
    outpatient_visits_per_person_year_surgery_minus_3 = outpatient_visits_surgery_minus_3 / person_years_surgery_minus_3,
    outpatient_visits_per_person_year_surgery_minus_2 = outpatient_visits_surgery_minus_2 / person_years_surgery_minus_2,
    outpatient_visits_per_person_year_surgery_minus_1 = outpatient_visits_surgery_minus_1 / person_years_surgery_minus_1,
    outpatient_visits_per_person_year_surgery_0 = outpatient_visits_surgery_0 / person_years_surgery_0,
    outpatient_visits_per_person_year_surgery_1 = outpatient_visits_surgery_1 / person_years_surgery_1,
    outpatient_visits_per_person_year_surgery_2 = outpatient_visits_surgery_2 / person_years_surgery_2,
    outpatient_visits_per_person_year_surgery_3 = outpatient_visits_surgery_3 / person_years_surgery_3,
    outpatient_visits_per_person_year_surgery_4 = outpatient_visits_surgery_4 / person_years_surgery_4,
    outpatient_visits_per_person_year_surgery_5 = outpatient_visits_surgery_5 / person_years_surgery_5,
    outpatient_visits_per_person_year_surgery_6 = outpatient_visits_surgery_6 / person_years_surgery_6,
    outpatient_visits_per_person_year_surgery_7 = outpatient_visits_surgery_7 / person_years_surgery_7,
    outpatient_visits_per_person_year_surgery_8 = outpatient_visits_surgery_8 / person_years_surgery_8,
    outpatient_visits_per_person_year_surgery_9 = outpatient_visits_surgery_9 / person_years_surgery_9,
    outpatient_visits_per_person_year_surgery_10 = outpatient_visits_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_0, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_0, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_1, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_1, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_2, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_2, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_3, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_3, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_4, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_4, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_5, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_5, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_6, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_6, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_7, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_7, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_8, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_8, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_9, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_9, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_10, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_hemispherectomy$outpatient_visits_per_person_year_surgery_10, na.rm=TRUE)
```




Emergency department visits
```{r}
# Individual emergency department visits
ED_hemispherectomy_n <- utilization_hemispherectomy %>%
  filter(setting=="emergency") %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
ED_hemispherectomy_n 


# Individual patients with ED visits
patients_ED_hemispherectomy_n <- utilization_hemispherectomy %>%
  filter(setting=="emergency") %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_ED_hemispherectomy_n 


# Tally of patients with more than one ED visit
tally_ED_hemispherectomy <- utilization_hemispherectomy %>%
  filter(setting=="emergency") %>% 
  group_by(ENROLID) %>% 
  tally(name="number_ED_visits")  %>% 
  group_by(number_ED_visits) %>% 
  tally(name="number_patients")
tally_ED_hemispherectomy




# Emergency visits per patient by year in relationship to surgery before and after surgery
utilization_hemispherectomy_emergency <- utilization_hemispherectomy %>% 
  filter(setting=="emergency") %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(ED_date = SVCDATE)

ED_visits_by_year_per_patient_hemispherectomy_1_5 <-
  hemispherectomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_hemispherectomy_emergency, by="ENROLID") %>%
  select(ENROLID, ED_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_visits_surgery_minus_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(69))) & (ED_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    ED_visits_surgery_0_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(9))) & (ED_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE), 
    ED_visits_surgery_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(3))) & (ED_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_visits_by_year_per_patient_hemispherectomy_1_5  
   

# ED visits per person-year by year before and after surgery
ED_visits_by_year_per_person_year_individually_hemispherectomy_1_5 <- 
  person_years_by_year_hemispherectomy_one_surgery_1_5 %>% 
  left_join(ED_visits_by_year_per_patient_hemispherectomy_1_5, by="ENROLID") %>% 
  mutate(
    ED_visits_per_person_year_surgery_minus_1_5 = ED_visits_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    ED_visits_per_person_year_surgery_0_1_5 = ED_visits_surgery_0_1_5 / person_years_surgery_0_1_5,
    ED_visits_per_person_year_surgery_1_5 = ED_visits_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy_1_5$ED_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy_1_5$ED_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy_1_5$ED_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy_1_5$ED_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy_1_5$ED_visits_per_person_year_surgery_1_5, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy_1_5$ED_visits_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_ED_visits_per_person_year_hemispherectomy_1_5 <- wilcox.test(ED_visits_by_year_per_person_year_individually_hemispherectomy_1_5$ED_visits_per_person_year_surgery_minus_1_5, ED_visits_by_year_per_person_year_individually_hemispherectomy_1_5$ED_visits_per_person_year_surgery_1_5)
Wilcoxon_test_ED_visits_per_person_year_hemispherectomy_1_5




# Emergency visits per patient by year in relationship to surgery
utilization_hemispherectomy_emergency <- utilization_hemispherectomy %>% 
  filter(setting=="emergency") %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(ED_date = SVCDATE)

ED_visits_by_year_per_patient_hemispherectomy <-
  hemispherectomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_hemispherectomy_emergency, by="ENROLID") %>%
  select(ENROLID, ED_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_visits_surgery_minus_10 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(129))) & (ED_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_9 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(117))) & (ED_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    ED_visits_surgery_minus_8 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(105))) & (ED_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_7 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(93))) & (ED_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_6 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(81))) & (ED_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(69))) & (ED_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_4 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(57))) & (ED_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_3 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(45))) & (ED_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_2 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(33))) & (ED_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_1 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(21))) & (ED_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_0 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(9))) & (ED_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      ED_visits_surgery_1 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(3))) & (ED_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     ED_visits_surgery_2 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(15))) & (ED_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     ED_visits_surgery_3 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(27))) & (ED_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_4 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(39))) & (ED_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     ED_visits_surgery_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(51))) & (ED_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_6 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(63))) & (ED_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     ED_visits_surgery_7 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(75))) & (ED_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     ED_visits_surgery_8 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(87))) & (ED_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     ED_visits_surgery_9 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(99))) & (ED_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_10 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(111))) & (ED_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_visits_by_year_per_patient_hemispherectomy  
   

# ED visits per person-year by year
ED_visits_by_year_per_person_year_individually_hemispherectomy <- 
  person_years_by_year_hemispherectomy_one_surgery %>% 
  left_join(ED_visits_by_year_per_patient_hemispherectomy, by="ENROLID") %>% 
  mutate(
    ED_visits_per_person_year_surgery_minus_10 = ED_visits_surgery_minus_10 / person_years_surgery_minus_10,
    ED_visits_per_person_year_surgery_minus_9 = ED_visits_surgery_minus_9 / person_years_surgery_minus_9,
    ED_visits_per_person_year_surgery_minus_8 = ED_visits_surgery_minus_8 / person_years_surgery_minus_8,
    ED_visits_per_person_year_surgery_minus_7 = ED_visits_surgery_minus_7 / person_years_surgery_minus_7,
    ED_visits_per_person_year_surgery_minus_6 = ED_visits_surgery_minus_6 / person_years_surgery_minus_6,
    ED_visits_per_person_year_surgery_minus_5 = ED_visits_surgery_minus_5 / person_years_surgery_minus_5,
    ED_visits_per_person_year_surgery_minus_4 = ED_visits_surgery_minus_4 / person_years_surgery_minus_4,
    ED_visits_per_person_year_surgery_minus_3 = ED_visits_surgery_minus_3 / person_years_surgery_minus_3,
    ED_visits_per_person_year_surgery_minus_2 = ED_visits_surgery_minus_2 / person_years_surgery_minus_2,
    ED_visits_per_person_year_surgery_minus_1 = ED_visits_surgery_minus_1 / person_years_surgery_minus_1,
    ED_visits_per_person_year_surgery_0 = ED_visits_surgery_0 / person_years_surgery_0,
    ED_visits_per_person_year_surgery_1 = ED_visits_surgery_1 / person_years_surgery_1,
    ED_visits_per_person_year_surgery_2 = ED_visits_surgery_2 / person_years_surgery_2,
    ED_visits_per_person_year_surgery_3 = ED_visits_surgery_3 / person_years_surgery_3,
    ED_visits_per_person_year_surgery_4 = ED_visits_surgery_4 / person_years_surgery_4,
    ED_visits_per_person_year_surgery_5 = ED_visits_surgery_5 / person_years_surgery_5,
    ED_visits_per_person_year_surgery_6 = ED_visits_surgery_6 / person_years_surgery_6,
    ED_visits_per_person_year_surgery_7 = ED_visits_surgery_7 / person_years_surgery_7,
    ED_visits_per_person_year_surgery_8 = ED_visits_surgery_8 / person_years_surgery_8,
    ED_visits_per_person_year_surgery_9 = ED_visits_surgery_9 / person_years_surgery_9,
    ED_visits_per_person_year_surgery_10 = ED_visits_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_0, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_0, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_1, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_1, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_2, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_2, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_3, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_3, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_4, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_4, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_5, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_5, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_6, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_6, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_7, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_7, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_8, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_8, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_9, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_9, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_10, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_hemispherectomy$ED_visits_per_person_year_surgery_10, na.rm=TRUE)
```




Hospital admissions
```{r}
# Individual hospital admissions
hospital_admission_hemispherectomy_n <- utilization_hemispherectomy %>%
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
hospital_admission_hemispherectomy_n 


# Individual patients with hospital admissions
patients_hospital_admission_hemispherectomy_n <- utilization_hemispherectomy %>%
  filter(setting=="inpatient") %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_hospital_admission_hemispherectomy_n 


# Tally of patients with more than one hospital admission
tally_hospital_admission_hemispherectomy <- utilization_hemispherectomy %>%
  filter(setting=="inpatient") %>% 
  group_by(ENROLID) %>% 
  tally(name="number_hospital_admissions")  %>% 
  group_by(number_hospital_admissions) %>% 
  tally(name="number_hospital_admissions")
tally_hospital_admission_hemispherectomy




# Hospital admissions per patient before and after surgery
utilization_hemispherectomy_inpatient <- utilization_hemispherectomy %>% 
  filter(setting=="inpatient") %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(hospital_admission_date = SVCDATE)

hospital_admissions_by_year_per_patient_hemispherectomy_1_5 <- 
  hemispherectomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_hemispherectomy_inpatient, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    hospital_admissions_surgery_minus_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    hospital_admissions_surgery_0_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
hospital_admissions_by_year_per_patient_hemispherectomy_1_5
   

# Hospital admissions per person-year by year
hospital_admissions_by_year_per_person_year_individually_hemispherectomy_1_5 <- 
  person_years_by_year_hemispherectomy_one_surgery_1_5 %>% 
  left_join(hospital_admissions_by_year_per_patient_hemispherectomy_1_5, by="ENROLID") %>% 
  mutate(
    hospital_admissions_per_person_year_surgery_minus_1_5 = hospital_admissions_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    hospital_admissions_per_person_year_surgery_0_1_5 = hospital_admissions_surgery_0_1_5 / person_years_surgery_0_1_5,
    hospital_admissions_per_person_year_surgery_1_5 = hospital_admissions_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy_1_5$hospital_admissions_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy_1_5$hospital_admissions_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy_1_5$hospital_admissions_per_person_year_surgery_1_5, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy_1_5$hospital_admissions_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_hospital_admissions_per_person_year_hemispherectomy_1_5 <- wilcox.test(hospital_admissions_by_year_per_person_year_individually_hemispherectomy_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, hospital_admissions_by_year_per_person_year_individually_hemispherectomy_1_5$hospital_admissions_per_person_year_surgery_1_5)
Wilcoxon_test_hospital_admissions_per_person_year_hemispherectomy_1_5




# Hospital admissions per patient by year in relationship to surgery
utilization_hemispherectomy_inpatient <- utilization_hemispherectomy %>% 
  filter(setting=="inpatient") %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(hospital_admission_date = SVCDATE)

hospital_admissions_by_year_per_patient_hemispherectomy <- 
  hemispherectomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_hemispherectomy_inpatient, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    hospital_admissions_surgery_minus_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(129))) & (hospital_admission_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(117))) & (hospital_admission_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    hospital_admissions_surgery_minus_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(105))) & (hospital_admission_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),  
    hospital_admissions_surgery_minus_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(93))) & (hospital_admission_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(81))) & (hospital_admission_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(57))) & (hospital_admission_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(45))) & (hospital_admission_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(33))) & (hospital_admission_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(21))) & (hospital_admission_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_0 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      hospital_admissions_surgery_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(15))) & (hospital_admission_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(27))) & (hospital_admission_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(39))) & (hospital_admission_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(51))) & (hospital_admission_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(63))) & (hospital_admission_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(75))) & (hospital_admission_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(87))) & (hospital_admission_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(99))) & (hospital_admission_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE), 
    hospital_admissions_surgery_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(111))) & (hospital_admission_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
hospital_admissions_by_year_per_patient_hemispherectomy  
   

# Hospital admissions per person-year by year
hospital_admissions_by_year_per_person_year_individually_hemispherectomy <- 
  person_years_by_year_hemispherectomy_one_surgery %>% 
  left_join(hospital_admissions_by_year_per_patient_hemispherectomy, by="ENROLID") %>% 
  mutate(
    hospital_admissions_per_person_year_surgery_minus_10 = hospital_admissions_surgery_minus_10 / person_years_surgery_minus_10,
    hospital_admissions_per_person_year_surgery_minus_9 = hospital_admissions_surgery_minus_9 / person_years_surgery_minus_9,
    hospital_admissions_per_person_year_surgery_minus_8 = hospital_admissions_surgery_minus_8 / person_years_surgery_minus_8,
    hospital_admissions_per_person_year_surgery_minus_7 = hospital_admissions_surgery_minus_7 / person_years_surgery_minus_7,
    hospital_admissions_per_person_year_surgery_minus_6 = hospital_admissions_surgery_minus_6 / person_years_surgery_minus_6,
    hospital_admissions_per_person_year_surgery_minus_5 = hospital_admissions_surgery_minus_5 / person_years_surgery_minus_5,
    hospital_admissions_per_person_year_surgery_minus_4 = hospital_admissions_surgery_minus_4 / person_years_surgery_minus_4,
    hospital_admissions_per_person_year_surgery_minus_3 = hospital_admissions_surgery_minus_3 / person_years_surgery_minus_3,
    hospital_admissions_per_person_year_surgery_minus_2 = hospital_admissions_surgery_minus_2 / person_years_surgery_minus_2,
    hospital_admissions_per_person_year_surgery_minus_1 = hospital_admissions_surgery_minus_1 / person_years_surgery_minus_1,
    hospital_admissions_per_person_year_surgery_0 = hospital_admissions_surgery_0 / person_years_surgery_0,
    hospital_admissions_per_person_year_surgery_1 = hospital_admissions_surgery_1 / person_years_surgery_1,
    hospital_admissions_per_person_year_surgery_2 = hospital_admissions_surgery_2 / person_years_surgery_2,
    hospital_admissions_per_person_year_surgery_3 = hospital_admissions_surgery_3 / person_years_surgery_3,
    hospital_admissions_per_person_year_surgery_4 = hospital_admissions_surgery_4 / person_years_surgery_4,
    hospital_admissions_per_person_year_surgery_5 = hospital_admissions_surgery_5 / person_years_surgery_5,
    hospital_admissions_per_person_year_surgery_6 = hospital_admissions_surgery_6 / person_years_surgery_6,
    hospital_admissions_per_person_year_surgery_7 = hospital_admissions_surgery_7 / person_years_surgery_7,
    hospital_admissions_per_person_year_surgery_8 = hospital_admissions_surgery_8 / person_years_surgery_8,
    hospital_admissions_per_person_year_surgery_9 = hospital_admissions_surgery_9 / person_years_surgery_9,
    hospital_admissions_per_person_year_surgery_10 = hospital_admissions_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_0, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_0, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_1, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_1, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_2, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_2, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_3, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_3, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_4, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_4, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_5, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_5, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_6, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_6, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_7, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_7, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_8, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_8, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_9, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_9, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_10, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_hemispherectomy$hospital_admissions_per_person_year_surgery_10, na.rm=TRUE)
```




Length of stay in hospital admissions for hemispherectomy
```{r}
# Length of hospital stay in patients with hemispherectomy
LOS_hemispherectomy <- utilization_hemispherectomy %>% 
  filter(setting=="inpatient") %>% 
  ungroup() %>% 
  summarize(total_LOS = sum(LOS))
LOS_hemispherectomy




# Length of hospital stay per patient before and after surgery
utilization_hemispherectomy_LOS <- utilization_hemispherectomy %>% 
  filter(setting=="inpatient") %>% 
  select(ENROLID, SVCDATE, LOS) %>% 
  rename(hospital_admission_date = SVCDATE)

LOS_by_year_per_patient_hemispherectomy_1_5 <- 
  hemispherectomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_hemispherectomy_LOS, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date, LOS) %>%
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    LOS_surgery_minus_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(9)))), LOS, 0), na.rm=TRUE)/5,
    LOS_surgery_0_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(63)))), LOS, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
LOS_by_year_per_patient_hemispherectomy_1_5  
   

# Length of stay per person-year by year before and after surgery
LOS_by_year_per_person_year_individually_hemispherectomy_1_5 <- 
  person_years_by_year_hemispherectomy_one_surgery_1_5 %>% 
  left_join(LOS_by_year_per_patient_hemispherectomy_1_5, by="ENROLID") %>% 
  mutate(
    LOS_per_person_year_surgery_minus_1_5 = LOS_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    LOS_per_person_year_surgery_0_1_5 = LOS_surgery_0_1_5 / person_years_surgery_0_1_5,
    LOS_per_person_year_surgery_1_5 = LOS_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(LOS_by_year_per_person_year_individually_hemispherectomy_1_5$LOS_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy_1_5$LOS_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy_1_5$LOS_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy_1_5$LOS_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy_1_5$LOS_per_person_year_surgery_1_5, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy_1_5$LOS_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_LOS_per_person_year_hemispherectomy_1_5 <- wilcox.test(LOS_by_year_per_person_year_individually_hemispherectomy_1_5$LOS_per_person_year_surgery_minus_1_5, LOS_by_year_per_person_year_individually_hemispherectomy_1_5$LOS_per_person_year_surgery_1_5)
Wilcoxon_test_LOS_per_person_year_hemispherectomy_1_5




# LOS per patient by year in relationship to surgery
utilization_hemispherectomy_LOS <- utilization_hemispherectomy %>% 
  filter(setting=="inpatient") %>% 
  select(ENROLID, SVCDATE, LOS) %>% 
  rename(hospital_admission_date = SVCDATE)

LOS_by_year_per_patient_hemispherectomy <- 
  hemispherectomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_hemispherectomy_LOS, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date, LOS) %>%
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    LOS_surgery_minus_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(129))) & (hospital_admission_date < (surgery_date - months(117)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(117))) & (hospital_admission_date < (surgery_date - months(105)))), LOS, 0), na.rm=TRUE), 
    LOS_surgery_minus_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(105))) & (hospital_admission_date < (surgery_date - months(93)))), LOS, 0), na.rm=TRUE),  
    LOS_surgery_minus_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(93))) & (hospital_admission_date < (surgery_date - months(81)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(81))) & (hospital_admission_date < (surgery_date - months(69)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(57)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(57))) & (hospital_admission_date < (surgery_date - months(45)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(45))) & (hospital_admission_date < (surgery_date - months(33)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(33))) & (hospital_admission_date < (surgery_date - months(21)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(21))) & (hospital_admission_date < (surgery_date - months(9)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_0 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), LOS, 0), na.rm=TRUE),      LOS_surgery_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(15)))), LOS, 0), na.rm=TRUE),     LOS_surgery_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(15))) & (hospital_admission_date < (surgery_date + months(27)))), LOS, 0), na.rm=TRUE),     LOS_surgery_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(27))) & (hospital_admission_date < (surgery_date + months(39)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(39))) & (hospital_admission_date < (surgery_date + months(51)))), LOS, 0), na.rm=TRUE),     LOS_surgery_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(51))) & (hospital_admission_date < (surgery_date + months(63)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(63))) & (hospital_admission_date < (surgery_date + months(75)))), LOS, 0), na.rm=TRUE),     LOS_surgery_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(75))) & (hospital_admission_date < (surgery_date + months(87)))), LOS, 0), na.rm=TRUE),     LOS_surgery_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(87))) & (hospital_admission_date < (surgery_date + months(99)))), LOS, 0), na.rm=TRUE),     LOS_surgery_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(99))) & (hospital_admission_date < (surgery_date + months(111)))), LOS, 0), na.rm=TRUE), 
    LOS_surgery_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(111))) & (hospital_admission_date < (surgery_date + months(123)))), LOS, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
LOS_by_year_per_patient_hemispherectomy  
   

# Length of stay per person-year by year
LOS_by_year_per_person_year_individually_hemispherectomy <- 
  person_years_by_year_hemispherectomy_one_surgery %>% 
  left_join(LOS_by_year_per_patient_hemispherectomy, by="ENROLID") %>% 
  mutate(
    LOS_per_person_year_surgery_minus_10 = LOS_surgery_minus_10 / person_years_surgery_minus_10,
    LOS_per_person_year_surgery_minus_9 = LOS_surgery_minus_9 / person_years_surgery_minus_9,
    LOS_per_person_year_surgery_minus_8 = LOS_surgery_minus_8 / person_years_surgery_minus_8,
    LOS_per_person_year_surgery_minus_7 = LOS_surgery_minus_7 / person_years_surgery_minus_7,
    LOS_per_person_year_surgery_minus_6 = LOS_surgery_minus_6 / person_years_surgery_minus_6,
    LOS_per_person_year_surgery_minus_5 = LOS_surgery_minus_5 / person_years_surgery_minus_5,
    LOS_per_person_year_surgery_minus_4 = LOS_surgery_minus_4 / person_years_surgery_minus_4,
    LOS_per_person_year_surgery_minus_3 = LOS_surgery_minus_3 / person_years_surgery_minus_3,
    LOS_per_person_year_surgery_minus_2 = LOS_surgery_minus_2 / person_years_surgery_minus_2,
    LOS_per_person_year_surgery_minus_1 = LOS_surgery_minus_1 / person_years_surgery_minus_1,
    LOS_per_person_year_surgery_0 = LOS_surgery_0 / person_years_surgery_0,
    LOS_per_person_year_surgery_1 = LOS_surgery_1 / person_years_surgery_1,
    LOS_per_person_year_surgery_2 = LOS_surgery_2 / person_years_surgery_2,
    LOS_per_person_year_surgery_3 = LOS_surgery_3 / person_years_surgery_3,
    LOS_per_person_year_surgery_4 = LOS_surgery_4 / person_years_surgery_4,
    LOS_per_person_year_surgery_5 = LOS_surgery_5 / person_years_surgery_5,
    LOS_per_person_year_surgery_6 = LOS_surgery_6 / person_years_surgery_6,
    LOS_per_person_year_surgery_7 = LOS_surgery_7 / person_years_surgery_7,
    LOS_per_person_year_surgery_8 = LOS_surgery_8 / person_years_surgery_8,
    LOS_per_person_year_surgery_9 = LOS_surgery_9 / person_years_surgery_9,
    LOS_per_person_year_surgery_10 = LOS_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_0, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_0, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_1, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_1, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_2, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_2, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_3, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_3, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_4, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_4, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_5, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_5, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_6, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_6, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_7, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_7, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_8, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_8, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_9, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_9, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_10, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_hemispherectomy$LOS_per_person_year_surgery_10, na.rm=TRUE)
```




Cost adjustment for inflation
```{r}
# Inflation calculations (https://apps.bea.gov/iTable/iTable.cfm?reqid=19&step=2#reqid=19&step=2&isuri=1&1921=survey last accessed 12/30/2021)
# https://meps.ahrq.gov/about_meps/Price_Index.shtml
inflation_2006_Q1 <- 0.89204
inflation_2006_Q2 <- 0.89993	
inflation_2006_Q3 <- 0.90652	
inflation_2006_Q4 <- 0.90997	
inflation_2007_Q1 <- 0.91908
inflation_2007_Q2 <- 0.92491	
inflation_2007_Q3 <- 0.92882	
inflation_2007_Q4 <- 0.93332	
inflation_2008_Q1 <- 0.93735
inflation_2008_Q2 <- 0.94075	
inflation_2008_Q3 <- 0.94804	
inflation_2008_Q4 <- 0.94975
inflation_2009_Q1 <- 0.95001
inflation_2009_Q2 <- 0.94870	
inflation_2009_Q3 <- 0.94928	
inflation_2009_Q4 <- 0.95277			
inflation_2010_Q1 <- 0.95518
inflation_2010_Q2 <- 0.95963	
inflation_2010_Q3 <- 0.96312	
inflation_2010_Q4 <- 0.96864				
inflation_2011_Q1 <- 0.97339
inflation_2011_Q2 <- 0.98042	
inflation_2011_Q3 <- 0.98561	
inflation_2011_Q4 <- 0.98687		
inflation_2012_Q1 <- 0.99277
inflation_2012_Q2 <- 0.99690	
inflation_2012_Q3 <- 1.00304
inflation_2012_Q4 <- 1.00730			
inflation_2013_Q1 <- 1.01124
inflation_2013_Q2 <- 1.01428	
inflation_2013_Q3 <- 1.01973
inflation_2013_Q4 <- 1.02550				
inflation_2014_Q1 <- 1.02965
inflation_2014_Q2 <- 1.03552	
inflation_2014_Q3 <- 1.04029
inflation_2014_Q4 <- 1.04104		
inflation_2015_Q1 <- 1.04092
inflation_2015_Q2 <- 1.04683	
inflation_2015_Q3 <- 1.04939
inflation_2015_Q4 <- 1.04932
inflation_2016_Q1 <- 1.04873
inflation_2016_Q2 <- 1.05576	
inflation_2016_Q3 <- 1.05894
inflation_2016_Q4 <- 1.06470				
inflation_2017_Q1 <- 1.07007
inflation_2017_Q2 <- 1.07361		
inflation_2017_Q3 <- 1.07942
inflation_2017_Q4 <- 1.08658						
inflation_2018_Q1 <- 1.09312
inflation_2018_Q2 <- 1.10156		
inflation_2018_Q3 <- 1.10647
inflation_2018_Q4 <- 1.11191		
inflation_2019_Q1 <- 1.11502
inflation_2019_Q2 <- 1.12142		
inflation_2019_Q3 <- 1.12524
inflation_2019_Q4 <- 1.12947			
inflation_2020_Q1 <- 1.13397
inflation_2020_Q2 <- 1.12969		
inflation_2020_Q3 <- 1.13984
inflation_2020_Q4 <- 1.14611					
				
			
# Cost adjusted for inflation (to Q4 2020 year)
inflation_adjusted_utilization_hemispherectomy <- utilization_hemispherectomy %>% 
  mutate(year_quarter = quarter(SVCDATE, with_year=TRUE)) %>%
  mutate(inflation_adjusted_cost = case_when(
  year_quarter == 2006.1 ~ cost*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ cost*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ cost*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ cost*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ cost*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ cost*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ cost*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ cost*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ cost*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ cost*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ cost*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ cost*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ cost*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ cost*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ cost*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ cost*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ cost*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ cost*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ cost*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ cost*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ cost*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ cost*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ cost*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ cost*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ cost*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ cost*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ cost*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ cost*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ cost*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ cost*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ cost*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ cost*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ cost*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ cost*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ cost*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ cost*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ cost*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ cost*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ cost*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ cost*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ cost*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ cost*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ cost*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ cost*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ cost*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ cost*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ cost*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ cost*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ cost*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ cost*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ cost*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ cost*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ cost*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ cost*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ cost*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ cost*(inflation_2020_Q4/inflation_2019_Q4))) %>% 
    collect()
```




Cost in patients with hemispherectomy
```{r}
# Cost in patients with hemispherectomy
cost_hemispherectomy <- 
  inflation_adjusted_utilization_hemispherectomy %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
cost_hemispherectomy




# Cost per patient before and after surgery
utilization_hemispherectomy_total_cost <- inflation_adjusted_utilization_hemispherectomy %>%
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


total_cost_by_year_per_patient_hemispherectomy_1_5 <- 
  hemispherectomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_hemispherectomy_total_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    total_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    total_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
total_cost_by_year_per_patient_hemispherectomy_1_5
   

# Total cost per person-year by year before and after surgery
total_cost_by_year_per_person_year_individually_hemispherectomy_1_5 <- 
  person_years_by_year_hemispherectomy_one_surgery_1_5 %>% 
  left_join(total_cost_by_year_per_patient_hemispherectomy_1_5, by="ENROLID") %>% 
  mutate(
    total_cost_per_person_year_surgery_minus_1_5 = total_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    total_cost_per_person_year_surgery_0_1_5 = total_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    total_cost_per_person_year_surgery_1_5 = total_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(total_cost_by_year_per_person_year_individually_hemispherectomy_1_5$total_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy_1_5$total_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy_1_5$total_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy_1_5$total_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy_1_5$total_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy_1_5$total_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_cost_per_person_year_hemispherectomy_1_5 <- wilcox.test(total_cost_by_year_per_person_year_individually_hemispherectomy_1_5$total_cost_per_person_year_surgery_minus_1_5, total_cost_by_year_per_person_year_individually_hemispherectomy_1_5$total_cost_per_person_year_surgery_1_5)
Wilcoxon_test_cost_per_person_year_hemispherectomy_1_5




# Total cost per patient by year in relationship to surgery
utilization_hemispherectomy_total_cost <- inflation_adjusted_utilization_hemispherectomy %>%
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


total_cost_by_year_per_patient_hemispherectomy <- 
  hemispherectomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_hemispherectomy_total_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    total_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    total_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    total_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      total_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    total_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
total_cost_by_year_per_patient_hemispherectomy  
   

# Total cost per person-year by year
total_cost_by_year_per_person_year_individually_hemispherectomy <- 
  person_years_by_year_hemispherectomy_one_surgery %>% 
  left_join(total_cost_by_year_per_patient_hemispherectomy, by="ENROLID") %>% 
  mutate(
    total_cost_per_person_year_surgery_minus_10 = total_cost_surgery_minus_10 / person_years_surgery_minus_10,
    total_cost_per_person_year_surgery_minus_9 = total_cost_surgery_minus_9 / person_years_surgery_minus_9,
    total_cost_per_person_year_surgery_minus_8 = total_cost_surgery_minus_8 / person_years_surgery_minus_8,
    total_cost_per_person_year_surgery_minus_7 = total_cost_surgery_minus_7 / person_years_surgery_minus_7,
    total_cost_per_person_year_surgery_minus_6 = total_cost_surgery_minus_6 / person_years_surgery_minus_6,
    total_cost_per_person_year_surgery_minus_5 = total_cost_surgery_minus_5 / person_years_surgery_minus_5,
    total_cost_per_person_year_surgery_minus_4 = total_cost_surgery_minus_4 / person_years_surgery_minus_4,
    total_cost_per_person_year_surgery_minus_3 = total_cost_surgery_minus_3 / person_years_surgery_minus_3,
    total_cost_per_person_year_surgery_minus_2 = total_cost_surgery_minus_2 / person_years_surgery_minus_2,
    total_cost_per_person_year_surgery_minus_1 = total_cost_surgery_minus_1 / person_years_surgery_minus_1,
    total_cost_per_person_year_surgery_0 = total_cost_surgery_0 / person_years_surgery_0,
    total_cost_per_person_year_surgery_1 = total_cost_surgery_1 / person_years_surgery_1,
    total_cost_per_person_year_surgery_2 = total_cost_surgery_2 / person_years_surgery_2,
    total_cost_per_person_year_surgery_3 = total_cost_surgery_3 / person_years_surgery_3,
    total_cost_per_person_year_surgery_4 = total_cost_surgery_4 / person_years_surgery_4,
    total_cost_per_person_year_surgery_5 = total_cost_surgery_5 / person_years_surgery_5,
    total_cost_per_person_year_surgery_6 = total_cost_surgery_6 / person_years_surgery_6,
    total_cost_per_person_year_surgery_7 = total_cost_surgery_7 / person_years_surgery_7,
    total_cost_per_person_year_surgery_8 = total_cost_surgery_8 / person_years_surgery_8,
    total_cost_per_person_year_surgery_9 = total_cost_surgery_9 / person_years_surgery_9,
    total_cost_per_person_year_surgery_10 = total_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Total cost figure in patients with hemispherectomy
```{r}
# Total cost figure
data_figure_total_cost_by_year_per_person_year_individually_hemispherectomy <- tibble(
  "year" = factor(c("Year -5", "Year -4", "Year -3", "Year -2", "Year -1", "Year surgery", "Year +1", "Year +2", "Year +3", "Year +4", "Year +5"), levels=c("Year -5", "Year -4", "Year -3", "Year -2", "Year -1", "Year surgery", "Year +1", "Year +2", "Year +3", "Year +4", "Year +5")),
  "median_cost" = c(summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_0, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_1, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_2, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_3, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_4, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_5, na.rm=TRUE)[3]),
  "p25_cost" = c(summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_0, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_1, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_2, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_3, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_4, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_5, na.rm=TRUE)[2]),  
  "p75_cost" = c(summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_0, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_1, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_2, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_3, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_4, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_hemispherectomy$total_cost_per_person_year_surgery_5, na.rm=TRUE)[5])    
  )


figure_total_cost_by_year_per_person_year_individually_hemispherectomy <- ggplot(data=data_figure_total_cost_by_year_per_person_year_individually_hemispherectomy) + 
  geom_point(aes(x=year, y=median_cost), color="purple2", size=5) +
  geom_point(aes(x=year, y=p25_cost), color="darkgreen", size=4) +
  geom_point(aes(x=year, y=p75_cost), color="darkgreen", size=4) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=22, face="bold")) +
  scale_x_discrete(name="Year") +
  scale_y_continuous(name="Cost ($) per person-year", breaks=seq(0, 500000, 50000), limits = c(0, 500000))
figure_total_cost_by_year_per_person_year_individually_hemispherectomy
ggplotly(figure_total_cost_by_year_per_person_year_individually_hemispherectomy)
```




Outpatient cost in patients with hemispherectomy
```{r}
# Outpatient cost in patients with hemispherectomy
outpatient_cost_hemispherectomy <- 
  inflation_adjusted_utilization_hemispherectomy %>% 
  filter(setting=="outpatient") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
outpatient_cost_hemispherectomy




# Outpatient cost per patient before and after surgery
utilization_hemispherectomy_outpatient_cost <- inflation_adjusted_utilization_hemispherectomy %>%
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


outpatient_cost_by_year_per_patient_hemispherectomy_1_5 <- 
  hemispherectomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_hemispherectomy_outpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    outpatient_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_cost_by_year_per_patient_hemispherectomy_1_5
   

# Outpatient cost per person-year by year before and after surgery
outpatient_cost_by_year_per_person_year_individually_hemispherectomy_1_5 <- 
  person_years_by_year_hemispherectomy_one_surgery_1_5 %>% 
  left_join(outpatient_cost_by_year_per_patient_hemispherectomy_1_5, by="ENROLID") %>% 
  mutate(
    outpatient_cost_per_person_year_surgery_minus_1_5 = outpatient_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    outpatient_cost_per_person_year_surgery_0_1_5 = outpatient_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    outpatient_cost_per_person_year_surgery_1_5 = outpatient_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy_1_5$outpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy_1_5$outpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy_1_5$outpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy_1_5$outpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_outpatient_cost_per_person_year_hemispherectomy_1_5 <- wilcox.test(outpatient_cost_by_year_per_person_year_individually_hemispherectomy_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, outpatient_cost_by_year_per_person_year_individually_hemispherectomy_1_5$outpatient_cost_per_person_year_surgery_1_5)
Wilcoxon_test_outpatient_cost_per_person_year_hemispherectomy_1_5




# Outpatient cost per patient by year in relationship to surgery
utilization_hemispherectomy_outpatient_cost <- inflation_adjusted_utilization_hemispherectomy %>%
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


outpatient_cost_by_year_per_patient_hemispherectomy <- 
  hemispherectomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_hemispherectomy_outpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    outpatient_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    outpatient_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      outpatient_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    outpatient_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_cost_by_year_per_patient_hemispherectomy  
   

# Outpatient cost per person-year by year
outpatient_cost_by_year_per_person_year_individually_hemispherectomy <- 
  person_years_by_year_hemispherectomy_one_surgery %>% 
  left_join(outpatient_cost_by_year_per_patient_hemispherectomy, by="ENROLID") %>% 
  mutate(
    outpatient_cost_per_person_year_surgery_minus_10 = outpatient_cost_surgery_minus_10 / person_years_surgery_minus_10,
    outpatient_cost_per_person_year_surgery_minus_9 = outpatient_cost_surgery_minus_9 / person_years_surgery_minus_9,
    outpatient_cost_per_person_year_surgery_minus_8 = outpatient_cost_surgery_minus_8 / person_years_surgery_minus_8,
    outpatient_cost_per_person_year_surgery_minus_7 = outpatient_cost_surgery_minus_7 / person_years_surgery_minus_7,
    outpatient_cost_per_person_year_surgery_minus_6 = outpatient_cost_surgery_minus_6 / person_years_surgery_minus_6,
    outpatient_cost_per_person_year_surgery_minus_5 = outpatient_cost_surgery_minus_5 / person_years_surgery_minus_5,
    outpatient_cost_per_person_year_surgery_minus_4 = outpatient_cost_surgery_minus_4 / person_years_surgery_minus_4,
    outpatient_cost_per_person_year_surgery_minus_3 = outpatient_cost_surgery_minus_3 / person_years_surgery_minus_3,
    outpatient_cost_per_person_year_surgery_minus_2 = outpatient_cost_surgery_minus_2 / person_years_surgery_minus_2,
    outpatient_cost_per_person_year_surgery_minus_1 = outpatient_cost_surgery_minus_1 / person_years_surgery_minus_1,
    outpatient_cost_per_person_year_surgery_0 = outpatient_cost_surgery_0 / person_years_surgery_0,
    outpatient_cost_per_person_year_surgery_1 = outpatient_cost_surgery_1 / person_years_surgery_1,
    outpatient_cost_per_person_year_surgery_2 = outpatient_cost_surgery_2 / person_years_surgery_2,
    outpatient_cost_per_person_year_surgery_3 = outpatient_cost_surgery_3 / person_years_surgery_3,
    outpatient_cost_per_person_year_surgery_4 = outpatient_cost_surgery_4 / person_years_surgery_4,
    outpatient_cost_per_person_year_surgery_5 = outpatient_cost_surgery_5 / person_years_surgery_5,
    outpatient_cost_per_person_year_surgery_6 = outpatient_cost_surgery_6 / person_years_surgery_6,
    outpatient_cost_per_person_year_surgery_7 = outpatient_cost_surgery_7 / person_years_surgery_7,
    outpatient_cost_per_person_year_surgery_8 = outpatient_cost_surgery_8 / person_years_surgery_8,
    outpatient_cost_per_person_year_surgery_9 = outpatient_cost_surgery_9 / person_years_surgery_9,
    outpatient_cost_per_person_year_surgery_10 = outpatient_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_hemispherectomy$outpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
```




ED cost in patients with hemispherectomy
```{r}
# ED cost in patients with hemispherectomy
ED_cost_hemispherectomy <- 
  inflation_adjusted_utilization_hemispherectomy %>% 
  filter(setting=="emergency") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
ED_cost_hemispherectomy




# ED cost per patient before and after surgery
utilization_hemispherectomy_ED_cost <- inflation_adjusted_utilization_hemispherectomy %>%
  filter(setting=="emergency") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


ED_cost_by_year_per_patient_hemispherectomy_1_5 <- 
  hemispherectomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_hemispherectomy_ED_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    ED_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_cost_by_year_per_patient_hemispherectomy_1_5
   

# ED cost per person-year by year before and after surgery
ED_cost_by_year_per_person_year_individually_hemispherectomy_1_5 <- 
  person_years_by_year_hemispherectomy_one_surgery_1_5 %>% 
  left_join(ED_cost_by_year_per_patient_hemispherectomy_1_5, by="ENROLID") %>% 
  mutate(
    ED_cost_per_person_year_surgery_minus_1_5 = ED_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    ED_cost_per_person_year_surgery_0_1_5 = ED_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    ED_cost_per_person_year_surgery_1_5 = ED_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy_1_5$ED_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy_1_5$ED_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy_1_5$ED_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy_1_5$ED_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy_1_5$ED_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy_1_5$ED_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_ED_cost_per_person_year_hemispherectomy_1_5 <- wilcox.test(ED_cost_by_year_per_person_year_individually_hemispherectomy_1_5$ED_cost_per_person_year_surgery_minus_1_5, ED_cost_by_year_per_person_year_individually_hemispherectomy_1_5$ED_cost_per_person_year_surgery_1_5)
Wilcoxon_test_ED_cost_per_person_year_hemispherectomy_1_5




# ED cost per patient by year in relationship to surgery
utilization_hemispherectomy_ED_cost <- inflation_adjusted_utilization_hemispherectomy %>%
  filter(setting=="emergency") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


ED_cost_by_year_per_patient_hemispherectomy <- 
  hemispherectomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_hemispherectomy_ED_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    ED_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    ED_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      ED_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    ED_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_cost_by_year_per_patient_hemispherectomy  
   

# ED cost per person-year by year
ED_cost_by_year_per_person_year_individually_hemispherectomy <- 
  person_years_by_year_hemispherectomy_one_surgery %>% 
  left_join(ED_cost_by_year_per_patient_hemispherectomy, by="ENROLID") %>% 
  mutate(
    ED_cost_per_person_year_surgery_minus_10 = ED_cost_surgery_minus_10 / person_years_surgery_minus_10,
    ED_cost_per_person_year_surgery_minus_9 = ED_cost_surgery_minus_9 / person_years_surgery_minus_9,
    ED_cost_per_person_year_surgery_minus_8 = ED_cost_surgery_minus_8 / person_years_surgery_minus_8,
    ED_cost_per_person_year_surgery_minus_7 = ED_cost_surgery_minus_7 / person_years_surgery_minus_7,
    ED_cost_per_person_year_surgery_minus_6 = ED_cost_surgery_minus_6 / person_years_surgery_minus_6,
    ED_cost_per_person_year_surgery_minus_5 = ED_cost_surgery_minus_5 / person_years_surgery_minus_5,
    ED_cost_per_person_year_surgery_minus_4 = ED_cost_surgery_minus_4 / person_years_surgery_minus_4,
    ED_cost_per_person_year_surgery_minus_3 = ED_cost_surgery_minus_3 / person_years_surgery_minus_3,
    ED_cost_per_person_year_surgery_minus_2 = ED_cost_surgery_minus_2 / person_years_surgery_minus_2,
    ED_cost_per_person_year_surgery_minus_1 = ED_cost_surgery_minus_1 / person_years_surgery_minus_1,
    ED_cost_per_person_year_surgery_0 = ED_cost_surgery_0 / person_years_surgery_0,
    ED_cost_per_person_year_surgery_1 = ED_cost_surgery_1 / person_years_surgery_1,
    ED_cost_per_person_year_surgery_2 = ED_cost_surgery_2 / person_years_surgery_2,
    ED_cost_per_person_year_surgery_3 = ED_cost_surgery_3 / person_years_surgery_3,
    ED_cost_per_person_year_surgery_4 = ED_cost_surgery_4 / person_years_surgery_4,
    ED_cost_per_person_year_surgery_5 = ED_cost_surgery_5 / person_years_surgery_5,
    ED_cost_per_person_year_surgery_6 = ED_cost_surgery_6 / person_years_surgery_6,
    ED_cost_per_person_year_surgery_7 = ED_cost_surgery_7 / person_years_surgery_7,
    ED_cost_per_person_year_surgery_8 = ED_cost_surgery_8 / person_years_surgery_8,
    ED_cost_per_person_year_surgery_9 = ED_cost_surgery_9 / person_years_surgery_9,
    ED_cost_per_person_year_surgery_10 = ED_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_hemispherectomy$ED_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Inpatient cost in patients with hemispherectomy
```{r}
# Inpatient cost in patients with hemispherectomy
inpatient_cost_hemispherectomy <- 
  inflation_adjusted_utilization_hemispherectomy %>% 
  filter(setting=="inpatient") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
inpatient_cost_hemispherectomy




# Inpatient cost per patient before and after surgery
utilization_hemispherectomy_inpatient_cost <- inflation_adjusted_utilization_hemispherectomy %>%
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


inpatient_cost_by_year_per_patient_hemispherectomy_1_5 <- 
  hemispherectomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_hemispherectomy_inpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    inpatient_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    inpatient_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
inpatient_cost_by_year_per_patient_hemispherectomy_1_5
   

# Inpatient cost per person-year by year before and after surgery
inpatient_cost_by_year_per_person_year_individually_hemispherectomy_1_5 <- 
  person_years_by_year_hemispherectomy_one_surgery_1_5 %>% 
  left_join(inpatient_cost_by_year_per_patient_hemispherectomy_1_5, by="ENROLID") %>% 
  mutate(
    inpatient_cost_per_person_year_surgery_minus_1_5 = inpatient_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    inpatient_cost_per_person_year_surgery_0_1_5 = inpatient_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    inpatient_cost_per_person_year_surgery_1_5 = inpatient_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy_1_5$inpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy_1_5$inpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy_1_5$inpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy_1_5$inpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_inpatient_cost_per_person_year_hemispherectomy_1_5 <- wilcox.test(inpatient_cost_by_year_per_person_year_individually_hemispherectomy_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, inpatient_cost_by_year_per_person_year_individually_hemispherectomy_1_5$inpatient_cost_per_person_year_surgery_1_5)
Wilcoxon_test_inpatient_cost_per_person_year_hemispherectomy_1_5




# Inpatient cost per patient by year in relationship to surgery
utilization_hemispherectomy_inpatient_cost <- inflation_adjusted_utilization_hemispherectomy %>%
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


inpatient_cost_by_year_per_patient_hemispherectomy <- 
  hemispherectomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_hemispherectomy_inpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    inpatient_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    inpatient_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    inpatient_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      inpatient_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    inpatient_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
inpatient_cost_by_year_per_patient_hemispherectomy  
   

# Inpatient cost per person-year by year
inpatient_cost_by_year_per_person_year_individually_hemispherectomy <- 
  person_years_by_year_hemispherectomy_one_surgery %>% 
  left_join(inpatient_cost_by_year_per_patient_hemispherectomy, by="ENROLID") %>% 
  mutate(
    inpatient_cost_per_person_year_surgery_minus_10 = inpatient_cost_surgery_minus_10 / person_years_surgery_minus_10,
    inpatient_cost_per_person_year_surgery_minus_9 = inpatient_cost_surgery_minus_9 / person_years_surgery_minus_9,
    inpatient_cost_per_person_year_surgery_minus_8 = inpatient_cost_surgery_minus_8 / person_years_surgery_minus_8,
    inpatient_cost_per_person_year_surgery_minus_7 = inpatient_cost_surgery_minus_7 / person_years_surgery_minus_7,
    inpatient_cost_per_person_year_surgery_minus_6 = inpatient_cost_surgery_minus_6 / person_years_surgery_minus_6,
    inpatient_cost_per_person_year_surgery_minus_5 = inpatient_cost_surgery_minus_5 / person_years_surgery_minus_5,
    inpatient_cost_per_person_year_surgery_minus_4 = inpatient_cost_surgery_minus_4 / person_years_surgery_minus_4,
    inpatient_cost_per_person_year_surgery_minus_3 = inpatient_cost_surgery_minus_3 / person_years_surgery_minus_3,
    inpatient_cost_per_person_year_surgery_minus_2 = inpatient_cost_surgery_minus_2 / person_years_surgery_minus_2,
    inpatient_cost_per_person_year_surgery_minus_1 = inpatient_cost_surgery_minus_1 / person_years_surgery_minus_1,
    inpatient_cost_per_person_year_surgery_0 = inpatient_cost_surgery_0 / person_years_surgery_0,
    inpatient_cost_per_person_year_surgery_1 = inpatient_cost_surgery_1 / person_years_surgery_1,
    inpatient_cost_per_person_year_surgery_2 = inpatient_cost_surgery_2 / person_years_surgery_2,
    inpatient_cost_per_person_year_surgery_3 = inpatient_cost_surgery_3 / person_years_surgery_3,
    inpatient_cost_per_person_year_surgery_4 = inpatient_cost_surgery_4 / person_years_surgery_4,
    inpatient_cost_per_person_year_surgery_5 = inpatient_cost_surgery_5 / person_years_surgery_5,
    inpatient_cost_per_person_year_surgery_6 = inpatient_cost_surgery_6 / person_years_surgery_6,
    inpatient_cost_per_person_year_surgery_7 = inpatient_cost_surgery_7 / person_years_surgery_7,
    inpatient_cost_per_person_year_surgery_8 = inpatient_cost_surgery_8 / person_years_surgery_8,
    inpatient_cost_per_person_year_surgery_9 = inpatient_cost_surgery_9 / person_years_surgery_9,
    inpatient_cost_per_person_year_surgery_10 = inpatient_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_hemispherectomy$inpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
```








## 10. Clinical and economic outcomes in corpus callosotomy




Healthcare resource utilization among patients with corpus callosotomy
```{r}
# Resource utilization
revenue_codes_EDvisits <- c("0450", "0451", "0452", "0456", "0459", "0981")
place_of_service_codes_EDvisits <- c("20", "23", "41", "42")
CPT_codes_EDvisits <- c("99281", "99282", "99283", "99284", "99285")
service_subcategory_codes_EDvisits <- c("10120", "10220", "10320", "10420", "10520", "12220", "20120", "20220", "21120", "21220", "22120", "22320", "30120", "30220", "30320", "30420", "30520", "30620", "31120", "31220", "31320", "31420", "31520", "31620")
PROCGRP_codes_EDvisits <- c("111", "114")

revenue_codes_inpatient <- c("0100", "0101", "0110", "0111", "0112", "0113", "0114", "0115", "0116", "0117", "0118", "0119", "0120", "0121", "0122", "0123", "0124", "0125", "0126", "0127", "0128", "0129", "0130", "0131", "0132", "0133", "0134", "0135", "0136", "0137", "0138", "0139", "0140", "0141", "0142", "0143", "0144", "0145", "0146", "0147", "0148", "0149", "0150", "0151", "0152", "0153", "0154", "0155", "0156", "0157", "0158", "0159", "0160", "0161", "0162", "0164", "0166", "0167", "0168", "0169", "0170", "0171", "0172", "0173", "0174", "0175", "0179", "0180", "0182", "0183", "0184", "0185", "0189", "0190", "0191", "0192", "0193", "0194", "0199", "0200", "0201", "0202", "0203", "0204", "0206", "0207", "0208", "0209", "0210", "0211", "0212", "0213", "0214", "0219", "0720", "0721", "0722", "0723", "0724", "0729", "0760", "0761", "0762", "0769", "0800", "0801", "0802", "0803", "0804", "0809")
place_of_service_codes_inpatient <- c("21", "27", "28", "51", "61")
CPT_codes_inpatient <- c("99217", "99218", "99219", "99220", "99224", "99225", "99226", "99234", "99235", "99236")




#################################2006#################################
utilization_corpus_callosotomy_2006_o <- ms_o_2006 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2006_i <- ms_i_2006 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2006_s <- ms_s_2006 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2007#################################
utilization_corpus_callosotomy_2007_o <- ms_o_2007 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2007_i <- ms_i_2007 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2007_s <- ms_s_2007 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2008#################################
utilization_corpus_callosotomy_2008_o <- ms_o_2008 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2008_i <- ms_i_2008 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2008_s <- ms_s_2008 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2009#################################
utilization_corpus_callosotomy_2009_o <- ms_o_2009 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2009_i <- ms_i_2009 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2009_s <- ms_s_2009 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2010#################################
utilization_corpus_callosotomy_2010_o <- ms_o_2010 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2010_i <- ms_i_2010 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2010_s <- ms_s_2010 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2011#################################
utilization_corpus_callosotomy_2011_o <- ms_o_2011 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2011_i <- ms_i_2011 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2011_s <- ms_s_2011 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2012#################################
utilization_corpus_callosotomy_2012_o <- ms_o_2012 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2012_i <- ms_i_2012 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2012_s <- ms_s_2012 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2013#################################
utilization_corpus_callosotomy_2013_o <- ms_o_2013 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2013_i <- ms_i_2013 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2013_s <- ms_s_2013 %>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2014#################################
utilization_corpus_callosotomy_2014_o <- ms_o_2014 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2014_i <- ms_i_2014 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2014_s <- ms_s_2014%>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2015#################################
utilization_corpus_callosotomy_2015_o <- ms_o_2015 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2015_i <- ms_i_2015 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2015_s <- ms_s_2015%>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD9 ~ 1, 
                              DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2016#################################
utilization_corpus_callosotomy_2016_o <- ms_o_2016 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2016_i <- ms_i_2016 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2016_s <- ms_s_2016%>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2017#################################
utilization_corpus_callosotomy_2017_o <- ms_o_2017 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2017_i <- ms_i_2017 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2017_s <- ms_s_2017%>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2018#################################
utilization_corpus_callosotomy_2018_o <- ms_o_2018 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2018_i <- ms_i_2018 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2018_s <- ms_s_2018%>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)




#################################2019#################################
utilization_corpus_callosotomy_2019_o <- ms_o_2019 %>% select(ENROLID, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
                             REVCODE %in% revenue_codes_inpatient ~ "inpatient",
                             STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
                             PROC1 %in% CPT_codes_inpatient ~ "inpatient",
                             TRUE ~ "outpatient")
           ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(LOS = case_when(setting=="inpatient" ~ 1,
                         TRUE ~ 0)) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2019_i <- ms_i_2019 %>% select(ENROLID, PPROC, PROC1, PROC2, PROC3, PROC4, PROC5, PROC6, PROC7, PROC8, PROC9, PROC10, PROC11, PROC12, PROC13, PROC14, PROC15, ADMDATE, DAYS, TOTPAY, DX1) %>%
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(c(ENROLID, DAYS, TOTPAY), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  rename(SVCDATE=ADMDATE, LOS=DAYS) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(PPROC %in% CPT_codes_EDvisits ~ "emergency",
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC2 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC3 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC4 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC5 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC6 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC7 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC8 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC9 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC10 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC11 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC12 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC13 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC14 %in% CPT_codes_EDvisits ~ "emergency",
                             PROC15 %in% CPT_codes_EDvisits ~ "emergency",
                             TRUE ~ "inpatient")      
         ) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(cost=sum(TOTPAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)


utilization_corpus_callosotomy_2019_s <- ms_s_2019%>% select(ENROLID, PPROC, PROC1, SVCDATE, PAY, DX1, STDPLAC, REVCODE, SVCSCAT, ADMDATE, DISDATE) %>% 
  filter(ENROLID %in% !!corpus_callosotomy_one_surgery$ENROLID) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  mutate(across(PAY, as.numeric)) %>% 
  mutate(epilepsy = case_when(DX1 %in% codes_epilepsy_ICD10 ~ 1, 
                              TRUE ~ 0),
         setting = case_when(REVCODE %in% revenue_codes_EDvisits ~ "emergency",
                             STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
                             PPROC %in% CPT_codes_EDvisits ~ "emergency", 
                             PROC1 %in% CPT_codes_EDvisits ~ "emergency",
                             SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency", 
                             TRUE ~ "inpatient")) %>% 
  mutate(across(DX1, as.numeric)) %>% 
  collect() %>% 
  mutate(across(c(SVCDATE, ADMDATE, DISDATE), mdy)) %>% 
  mutate(LOS=DISDATE-ADMDATE) %>% 
  mutate(across(LOS, as.numeric)) %>% 
  group_by(ENROLID, setting, ADMDATE) %>% 
  mutate(cost=sum(PAY)) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, ADMDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>% 
  select(ENROLID, SVCDATE, LOS, cost, epilepsy, DX1, setting)








# Utilization
utilization_corpus_callosotomy <- bind_rows(utilization_corpus_callosotomy_2006_o, utilization_corpus_callosotomy_2006_i, utilization_corpus_callosotomy_2006_s,
utilization_corpus_callosotomy_2007_o, utilization_corpus_callosotomy_2007_i, utilization_corpus_callosotomy_2007_s, utilization_corpus_callosotomy_2008_o, utilization_corpus_callosotomy_2008_i, utilization_corpus_callosotomy_2008_s,         utilization_corpus_callosotomy_2009_o, utilization_corpus_callosotomy_2009_i, utilization_corpus_callosotomy_2009_s, utilization_corpus_callosotomy_2010_o, utilization_corpus_callosotomy_2010_i, utilization_corpus_callosotomy_2010_s,        utilization_corpus_callosotomy_2011_o, utilization_corpus_callosotomy_2011_i, utilization_corpus_callosotomy_2011_s, utilization_corpus_callosotomy_2012_o, utilization_corpus_callosotomy_2012_i, utilization_corpus_callosotomy_2012_s,
utilization_corpus_callosotomy_2013_o, utilization_corpus_callosotomy_2013_i, utilization_corpus_callosotomy_2013_s, utilization_corpus_callosotomy_2014_o, utilization_corpus_callosotomy_2014_i, utilization_corpus_callosotomy_2014_s,         utilization_corpus_callosotomy_2015_o, utilization_corpus_callosotomy_2015_i, utilization_corpus_callosotomy_2015_s, utilization_corpus_callosotomy_2016_o, utilization_corpus_callosotomy_2016_i, utilization_corpus_callosotomy_2016_s,
utilization_corpus_callosotomy_2017_o, utilization_corpus_callosotomy_2017_i, utilization_corpus_callosotomy_2017_s, utilization_corpus_callosotomy_2018_o, utilization_corpus_callosotomy_2018_i, utilization_corpus_callosotomy_2018_s,
utilization_corpus_callosotomy_2019_o, utilization_corpus_callosotomy_2019_i, utilization_corpus_callosotomy_2019_s) %>% 
  mutate(LOS = case_when(setting=="emergency" ~ 0, TRUE ~ LOS)) %>% 
  mutate(cost = ifelse(cost>0, cost, 0)) %>% 
  group_by(ENROLID, setting, SVCDATE) %>% 
  mutate(epilepsy=sum(epilepsy)) %>% 
  ungroup() %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  mutate(epilepsy = case_when(epilepsy>0 ~ 1, 
                              TRUE ~ 0)) %>%     
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>% 
  arrange(ENROLID, SVCDATE, setting, desc(LOS), desc(cost)) %>% 
  mutate(difference_between_healthcare_contacts = SVCDATE - lag(SVCDATE, 1)) %>% 
  collect()
```




Outpatient visits
```{r}
# Individual outpatient visits
outpatient_visit_corpus_callosotomy_n <- utilization_corpus_callosotomy %>%
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
outpatient_visit_corpus_callosotomy_n 


# Individual patients with outpatient visits
patients_outpatient_visit_corpus_callosotomy_n <- utilization_corpus_callosotomy %>%
  filter(setting=="outpatient") %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_outpatient_visit_corpus_callosotomy_n 


# Tally of patients with more than one outpatient visit
tally_outpatient_visit_corpus_callosotomy <- utilization_corpus_callosotomy %>%
  filter(setting=="outpatient") %>% 
  group_by(ENROLID) %>% 
  tally(name="number_outpatient_visits")  %>% 
  group_by(number_outpatient_visits) %>% 
  tally(name="number_patients")
tally_outpatient_visit_corpus_callosotomy




# Outpatient visits per patient before and after surgery
utilization_corpus_callosotomy_outpatient <- utilization_corpus_callosotomy %>% 
  filter(setting=="outpatient") %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(outpatient_date = SVCDATE)

outpatient_visits_by_year_per_patient_corpus_callosotomy_1_5 <- 
  corpus_callosotomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_corpus_callosotomy_outpatient, by="ENROLID") %>%
  select(ENROLID, outpatient_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_visits_surgery_minus_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(69))) & (outpatient_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    outpatient_visits_surgery_0_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(9))) & (outpatient_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),     
    outpatient_visits_surgery_1_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(3))) & (outpatient_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_visits_by_year_per_patient_corpus_callosotomy_1_5 
   

# Outpatient visits per person-year by year
outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy_1_5 <- 
  person_years_by_year_corpus_callosotomy_one_surgery_1_5 %>% 
  left_join(outpatient_visits_by_year_per_patient_corpus_callosotomy_1_5, by="ENROLID") %>% 
  mutate(
    outpatient_visits_per_person_year_surgery_minus_1_5 = outpatient_visits_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    outpatient_visits_per_person_year_surgery_0_1_5 = outpatient_visits_surgery_0_1_5 / person_years_surgery_0_1_5,
    outpatient_visits_per_person_year_surgery_1_5 = outpatient_visits_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy_1_5$outpatient_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy_1_5$outpatient_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy_1_5$outpatient_visits_per_person_year_surgery_1_5, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy_1_5$outpatient_visits_per_person_year_surgery_1_5, na.rm=TRUE)


# Statistical test
Wilcoxon_test_outpatient_visits_per_person_year_corpus_callosotomy_1_5 <- wilcox.test(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy_1_5$outpatient_visits_per_person_year_surgery_minus_1_5, outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy_1_5$outpatient_visits_per_person_year_surgery_1_5)
Wilcoxon_test_outpatient_visits_per_person_year_corpus_callosotomy_1_5




# Outpatient visits per patient by year in relationship to surgery
utilization_corpus_callosotomy_outpatient <- utilization_corpus_callosotomy %>% 
  filter(setting=="outpatient") %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(outpatient_date = SVCDATE)

outpatient_visits_by_year_per_patient_corpus_callosotomy <- 
  corpus_callosotomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_corpus_callosotomy_outpatient, by="ENROLID") %>%
  select(ENROLID, outpatient_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_visits_surgery_minus_10 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(129))) & (outpatient_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_9 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(117))) & (outpatient_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    outpatient_visits_surgery_minus_8 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(105))) & (outpatient_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),  
    outpatient_visits_surgery_minus_7 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(93))) & (outpatient_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_6 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(81))) & (outpatient_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(69))) & (outpatient_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_minus_4 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(57))) & (outpatient_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_3 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(45))) & (outpatient_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_2 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(33))) & (outpatient_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_minus_1 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(21))) & (outpatient_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_0 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date - months(9))) & (outpatient_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      outpatient_visits_surgery_1 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(3))) & (outpatient_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_2 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(15))) & (outpatient_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_3 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(27))) & (outpatient_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_4 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(39))) & (outpatient_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_5 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(51))) & (outpatient_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    outpatient_visits_surgery_6 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(63))) & (outpatient_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_7 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(75))) & (outpatient_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_8 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(87))) & (outpatient_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     outpatient_visits_surgery_9 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(99))) & (outpatient_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE), 
    outpatient_visits_surgery_10 = 
      sumNA(ifelse(((outpatient_date >= (surgery_date + months(111))) & (outpatient_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_visits_by_year_per_patient_corpus_callosotomy  
   

# Outpatient visits per person-year by year
outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy <- 
  person_years_by_year_corpus_callosotomy_one_surgery %>% 
  left_join(outpatient_visits_by_year_per_patient_corpus_callosotomy, by="ENROLID") %>% 
  mutate(
    outpatient_visits_per_person_year_surgery_minus_10 = outpatient_visits_surgery_minus_10 / person_years_surgery_minus_10,
    outpatient_visits_per_person_year_surgery_minus_9 = outpatient_visits_surgery_minus_9 / person_years_surgery_minus_9,
    outpatient_visits_per_person_year_surgery_minus_8 = outpatient_visits_surgery_minus_8 / person_years_surgery_minus_8,
    outpatient_visits_per_person_year_surgery_minus_7 = outpatient_visits_surgery_minus_7 / person_years_surgery_minus_7,
    outpatient_visits_per_person_year_surgery_minus_6 = outpatient_visits_surgery_minus_6 / person_years_surgery_minus_6,
    outpatient_visits_per_person_year_surgery_minus_5 = outpatient_visits_surgery_minus_5 / person_years_surgery_minus_5,
    outpatient_visits_per_person_year_surgery_minus_4 = outpatient_visits_surgery_minus_4 / person_years_surgery_minus_4,
    outpatient_visits_per_person_year_surgery_minus_3 = outpatient_visits_surgery_minus_3 / person_years_surgery_minus_3,
    outpatient_visits_per_person_year_surgery_minus_2 = outpatient_visits_surgery_minus_2 / person_years_surgery_minus_2,
    outpatient_visits_per_person_year_surgery_minus_1 = outpatient_visits_surgery_minus_1 / person_years_surgery_minus_1,
    outpatient_visits_per_person_year_surgery_0 = outpatient_visits_surgery_0 / person_years_surgery_0,
    outpatient_visits_per_person_year_surgery_1 = outpatient_visits_surgery_1 / person_years_surgery_1,
    outpatient_visits_per_person_year_surgery_2 = outpatient_visits_surgery_2 / person_years_surgery_2,
    outpatient_visits_per_person_year_surgery_3 = outpatient_visits_surgery_3 / person_years_surgery_3,
    outpatient_visits_per_person_year_surgery_4 = outpatient_visits_surgery_4 / person_years_surgery_4,
    outpatient_visits_per_person_year_surgery_5 = outpatient_visits_surgery_5 / person_years_surgery_5,
    outpatient_visits_per_person_year_surgery_6 = outpatient_visits_surgery_6 / person_years_surgery_6,
    outpatient_visits_per_person_year_surgery_7 = outpatient_visits_surgery_7 / person_years_surgery_7,
    outpatient_visits_per_person_year_surgery_8 = outpatient_visits_surgery_8 / person_years_surgery_8,
    outpatient_visits_per_person_year_surgery_9 = outpatient_visits_surgery_9 / person_years_surgery_9,
    outpatient_visits_per_person_year_surgery_10 = outpatient_visits_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_0, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_0, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_1, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_1, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_2, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_2, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_3, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_3, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_4, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_4, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_5, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_5, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_6, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_6, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_7, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_7, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_8, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_8, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_9, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_9, na.rm=TRUE)

summary(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_10, na.rm=TRUE)
sd(outpatient_visits_by_year_per_person_year_individually_corpus_callosotomy$outpatient_visits_per_person_year_surgery_10, na.rm=TRUE)
```




Emergency department visits
```{r}
# Individual emergency department visits
ED_corpus_callosotomy_n <- utilization_corpus_callosotomy %>%
  filter(setting=="emergency") %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
ED_corpus_callosotomy_n 


# Individual patients with ED visits
patients_ED_corpus_callosotomy_n <- utilization_corpus_callosotomy %>%
  filter(setting=="emergency") %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_ED_corpus_callosotomy_n 


# Tally of patients with more than one ED visit
tally_ED_corpus_callosotomy <- utilization_corpus_callosotomy %>%
  filter(setting=="emergency") %>% 
  group_by(ENROLID) %>% 
  tally(name="number_ED_visits")  %>% 
  group_by(number_ED_visits) %>% 
  tally(name="number_patients")
tally_ED_corpus_callosotomy




# Emergency visits per patient by year in relationship to surgery before and after surgery
utilization_corpus_callosotomy_emergency <- utilization_corpus_callosotomy %>% 
  filter(setting=="emergency") %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(ED_date = SVCDATE)

ED_visits_by_year_per_patient_corpus_callosotomy_1_5 <-
  corpus_callosotomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_corpus_callosotomy_emergency, by="ENROLID") %>%
  select(ENROLID, ED_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_visits_surgery_minus_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(69))) & (ED_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    ED_visits_surgery_0_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(9))) & (ED_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE), 
    ED_visits_surgery_1_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(3))) & (ED_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_visits_by_year_per_patient_corpus_callosotomy_1_5  
   

# ED visits per person-year by year before and after surgery
ED_visits_by_year_per_person_year_individually_corpus_callosotomy_1_5 <- 
  person_years_by_year_corpus_callosotomy_one_surgery_1_5 %>% 
  left_join(ED_visits_by_year_per_patient_corpus_callosotomy_1_5, by="ENROLID") %>% 
  mutate(
    ED_visits_per_person_year_surgery_minus_1_5 = ED_visits_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    ED_visits_per_person_year_surgery_0_1_5 = ED_visits_surgery_0_1_5 / person_years_surgery_0_1_5,
    ED_visits_per_person_year_surgery_1_5 = ED_visits_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy_1_5$ED_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy_1_5$ED_visits_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy_1_5$ED_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy_1_5$ED_visits_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy_1_5$ED_visits_per_person_year_surgery_1_5, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy_1_5$ED_visits_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_ED_visits_per_person_year_corpus_callosotomy_1_5 <- wilcox.test(ED_visits_by_year_per_person_year_individually_corpus_callosotomy_1_5$ED_visits_per_person_year_surgery_minus_1_5, ED_visits_by_year_per_person_year_individually_corpus_callosotomy_1_5$ED_visits_per_person_year_surgery_1_5)
Wilcoxon_test_ED_visits_per_person_year_corpus_callosotomy_1_5




# Emergency visits per patient by year in relationship to surgery
utilization_corpus_callosotomy_emergency <- utilization_corpus_callosotomy %>% 
  filter(setting=="emergency") %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(ED_date = SVCDATE)

ED_visits_by_year_per_patient_corpus_callosotomy <-
  corpus_callosotomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_corpus_callosotomy_emergency, by="ENROLID") %>%
  select(ENROLID, ED_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_visits_surgery_minus_10 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(129))) & (ED_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_9 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(117))) & (ED_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    ED_visits_surgery_minus_8 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(105))) & (ED_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_7 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(93))) & (ED_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_6 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(81))) & (ED_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(69))) & (ED_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_minus_4 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(57))) & (ED_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_3 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(45))) & (ED_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_2 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(33))) & (ED_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     ED_visits_surgery_minus_1 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(21))) & (ED_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_0 = 
      sumNA(ifelse(((ED_date >= (surgery_date - months(9))) & (ED_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      ED_visits_surgery_1 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(3))) & (ED_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     ED_visits_surgery_2 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(15))) & (ED_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     ED_visits_surgery_3 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(27))) & (ED_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_4 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(39))) & (ED_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     ED_visits_surgery_5 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(51))) & (ED_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_6 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(63))) & (ED_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     ED_visits_surgery_7 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(75))) & (ED_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     ED_visits_surgery_8 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(87))) & (ED_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     ED_visits_surgery_9 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(99))) & (ED_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE),
    ED_visits_surgery_10 = 
      sumNA(ifelse(((ED_date >= (surgery_date + months(111))) & (ED_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_visits_by_year_per_patient_corpus_callosotomy  
   

# ED visits per person-year by year
ED_visits_by_year_per_person_year_individually_corpus_callosotomy <- 
  person_years_by_year_corpus_callosotomy_one_surgery %>% 
  left_join(ED_visits_by_year_per_patient_corpus_callosotomy, by="ENROLID") %>% 
  mutate(
    ED_visits_per_person_year_surgery_minus_10 = ED_visits_surgery_minus_10 / person_years_surgery_minus_10,
    ED_visits_per_person_year_surgery_minus_9 = ED_visits_surgery_minus_9 / person_years_surgery_minus_9,
    ED_visits_per_person_year_surgery_minus_8 = ED_visits_surgery_minus_8 / person_years_surgery_minus_8,
    ED_visits_per_person_year_surgery_minus_7 = ED_visits_surgery_minus_7 / person_years_surgery_minus_7,
    ED_visits_per_person_year_surgery_minus_6 = ED_visits_surgery_minus_6 / person_years_surgery_minus_6,
    ED_visits_per_person_year_surgery_minus_5 = ED_visits_surgery_minus_5 / person_years_surgery_minus_5,
    ED_visits_per_person_year_surgery_minus_4 = ED_visits_surgery_minus_4 / person_years_surgery_minus_4,
    ED_visits_per_person_year_surgery_minus_3 = ED_visits_surgery_minus_3 / person_years_surgery_minus_3,
    ED_visits_per_person_year_surgery_minus_2 = ED_visits_surgery_minus_2 / person_years_surgery_minus_2,
    ED_visits_per_person_year_surgery_minus_1 = ED_visits_surgery_minus_1 / person_years_surgery_minus_1,
    ED_visits_per_person_year_surgery_0 = ED_visits_surgery_0 / person_years_surgery_0,
    ED_visits_per_person_year_surgery_1 = ED_visits_surgery_1 / person_years_surgery_1,
    ED_visits_per_person_year_surgery_2 = ED_visits_surgery_2 / person_years_surgery_2,
    ED_visits_per_person_year_surgery_3 = ED_visits_surgery_3 / person_years_surgery_3,
    ED_visits_per_person_year_surgery_4 = ED_visits_surgery_4 / person_years_surgery_4,
    ED_visits_per_person_year_surgery_5 = ED_visits_surgery_5 / person_years_surgery_5,
    ED_visits_per_person_year_surgery_6 = ED_visits_surgery_6 / person_years_surgery_6,
    ED_visits_per_person_year_surgery_7 = ED_visits_surgery_7 / person_years_surgery_7,
    ED_visits_per_person_year_surgery_8 = ED_visits_surgery_8 / person_years_surgery_8,
    ED_visits_per_person_year_surgery_9 = ED_visits_surgery_9 / person_years_surgery_9,
    ED_visits_per_person_year_surgery_10 = ED_visits_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_0, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_0, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_1, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_1, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_2, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_2, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_3, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_3, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_4, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_4, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_5, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_5, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_6, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_6, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_7, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_7, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_8, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_8, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_9, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_9, na.rm=TRUE)

summary(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_10, na.rm=TRUE)
sd(ED_visits_by_year_per_person_year_individually_corpus_callosotomy$ED_visits_per_person_year_surgery_10, na.rm=TRUE)
```




Hospital admissions
```{r}
# Individual hospital admissions
hospital_admission_corpus_callosotomy_n <- utilization_corpus_callosotomy %>%
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, SVCDATE) %>% 
  nrow()
hospital_admission_corpus_callosotomy_n 


# Individual patients with hospital admissions
patients_hospital_admission_corpus_callosotomy_n <- utilization_corpus_callosotomy %>%
  filter(setting=="inpatient") %>% 
  distinct(ENROLID) %>% 
  nrow()
patients_hospital_admission_corpus_callosotomy_n 


# Tally of patients with more than one hospital admission
tally_hospital_admission_corpus_callosotomy <- utilization_corpus_callosotomy %>%
  filter(setting=="inpatient") %>% 
  group_by(ENROLID) %>% 
  tally(name="number_hospital_admissions")  %>% 
  group_by(number_hospital_admissions) %>% 
  tally(name="number_hospital_admissions")
tally_hospital_admission_corpus_callosotomy




# Hospital admissions per patient before and after surgery
utilization_corpus_callosotomy_inpatient <- utilization_corpus_callosotomy %>% 
  filter(setting=="inpatient") %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(hospital_admission_date = SVCDATE)

hospital_admissions_by_year_per_patient_corpus_callosotomy_1_5 <- 
  corpus_callosotomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_corpus_callosotomy_inpatient, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    hospital_admissions_surgery_minus_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE)/5,
    hospital_admissions_surgery_0_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
hospital_admissions_by_year_per_patient_corpus_callosotomy_1_5
   

# Hospital admissions per person-year by year
hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy_1_5 <- 
  person_years_by_year_corpus_callosotomy_one_surgery_1_5 %>% 
  left_join(hospital_admissions_by_year_per_patient_corpus_callosotomy_1_5, by="ENROLID") %>% 
  mutate(
    hospital_admissions_per_person_year_surgery_minus_1_5 = hospital_admissions_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    hospital_admissions_per_person_year_surgery_0_1_5 = hospital_admissions_surgery_0_1_5 / person_years_surgery_0_1_5,
    hospital_admissions_per_person_year_surgery_1_5 = hospital_admissions_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy_1_5$hospital_admissions_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy_1_5$hospital_admissions_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy_1_5$hospital_admissions_per_person_year_surgery_1_5, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy_1_5$hospital_admissions_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_hospital_admissions_per_person_year_corpus_callosotomy_1_5 <- wilcox.test(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy_1_5$hospital_admissions_per_person_year_surgery_minus_1_5, hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy_1_5$hospital_admissions_per_person_year_surgery_1_5)
Wilcoxon_test_hospital_admissions_per_person_year_corpus_callosotomy_1_5




# Hospital admissions per patient by year in relationship to surgery
utilization_corpus_callosotomy_inpatient <- utilization_corpus_callosotomy %>% 
  filter(setting=="inpatient") %>% 
  select(ENROLID, SVCDATE) %>% 
  rename(hospital_admission_date = SVCDATE)

hospital_admissions_by_year_per_patient_corpus_callosotomy <- 
  corpus_callosotomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_corpus_callosotomy_inpatient, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date) %>%
  mutate(row=1) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    hospital_admissions_surgery_minus_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(129))) & (hospital_admission_date < (surgery_date - months(117)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(117))) & (hospital_admission_date < (surgery_date - months(105)))), row, 0), na.rm=TRUE), 
    hospital_admissions_surgery_minus_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(105))) & (hospital_admission_date < (surgery_date - months(93)))), row, 0), na.rm=TRUE),  
    hospital_admissions_surgery_minus_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(93))) & (hospital_admission_date < (surgery_date - months(81)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(81))) & (hospital_admission_date < (surgery_date - months(69)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(57)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_minus_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(57))) & (hospital_admission_date < (surgery_date - months(45)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(45))) & (hospital_admission_date < (surgery_date - months(33)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(33))) & (hospital_admission_date < (surgery_date - months(21)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_minus_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(21))) & (hospital_admission_date < (surgery_date - months(9)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_0 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), row, 0), na.rm=TRUE),      hospital_admissions_surgery_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(15)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(15))) & (hospital_admission_date < (surgery_date + months(27)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(27))) & (hospital_admission_date < (surgery_date + months(39)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(39))) & (hospital_admission_date < (surgery_date + months(51)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(51))) & (hospital_admission_date < (surgery_date + months(63)))), row, 0), na.rm=TRUE),
    hospital_admissions_surgery_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(63))) & (hospital_admission_date < (surgery_date + months(75)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(75))) & (hospital_admission_date < (surgery_date + months(87)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(87))) & (hospital_admission_date < (surgery_date + months(99)))), row, 0), na.rm=TRUE),     hospital_admissions_surgery_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(99))) & (hospital_admission_date < (surgery_date + months(111)))), row, 0), na.rm=TRUE), 
    hospital_admissions_surgery_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(111))) & (hospital_admission_date < (surgery_date + months(123)))), row, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
hospital_admissions_by_year_per_patient_corpus_callosotomy  
   

# Hospital admissions per person-year by year
hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy <- 
  person_years_by_year_corpus_callosotomy_one_surgery %>% 
  left_join(hospital_admissions_by_year_per_patient_corpus_callosotomy, by="ENROLID") %>% 
  mutate(
    hospital_admissions_per_person_year_surgery_minus_10 = hospital_admissions_surgery_minus_10 / person_years_surgery_minus_10,
    hospital_admissions_per_person_year_surgery_minus_9 = hospital_admissions_surgery_minus_9 / person_years_surgery_minus_9,
    hospital_admissions_per_person_year_surgery_minus_8 = hospital_admissions_surgery_minus_8 / person_years_surgery_minus_8,
    hospital_admissions_per_person_year_surgery_minus_7 = hospital_admissions_surgery_minus_7 / person_years_surgery_minus_7,
    hospital_admissions_per_person_year_surgery_minus_6 = hospital_admissions_surgery_minus_6 / person_years_surgery_minus_6,
    hospital_admissions_per_person_year_surgery_minus_5 = hospital_admissions_surgery_minus_5 / person_years_surgery_minus_5,
    hospital_admissions_per_person_year_surgery_minus_4 = hospital_admissions_surgery_minus_4 / person_years_surgery_minus_4,
    hospital_admissions_per_person_year_surgery_minus_3 = hospital_admissions_surgery_minus_3 / person_years_surgery_minus_3,
    hospital_admissions_per_person_year_surgery_minus_2 = hospital_admissions_surgery_minus_2 / person_years_surgery_minus_2,
    hospital_admissions_per_person_year_surgery_minus_1 = hospital_admissions_surgery_minus_1 / person_years_surgery_minus_1,
    hospital_admissions_per_person_year_surgery_0 = hospital_admissions_surgery_0 / person_years_surgery_0,
    hospital_admissions_per_person_year_surgery_1 = hospital_admissions_surgery_1 / person_years_surgery_1,
    hospital_admissions_per_person_year_surgery_2 = hospital_admissions_surgery_2 / person_years_surgery_2,
    hospital_admissions_per_person_year_surgery_3 = hospital_admissions_surgery_3 / person_years_surgery_3,
    hospital_admissions_per_person_year_surgery_4 = hospital_admissions_surgery_4 / person_years_surgery_4,
    hospital_admissions_per_person_year_surgery_5 = hospital_admissions_surgery_5 / person_years_surgery_5,
    hospital_admissions_per_person_year_surgery_6 = hospital_admissions_surgery_6 / person_years_surgery_6,
    hospital_admissions_per_person_year_surgery_7 = hospital_admissions_surgery_7 / person_years_surgery_7,
    hospital_admissions_per_person_year_surgery_8 = hospital_admissions_surgery_8 / person_years_surgery_8,
    hospital_admissions_per_person_year_surgery_9 = hospital_admissions_surgery_9 / person_years_surgery_9,
    hospital_admissions_per_person_year_surgery_10 = hospital_admissions_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_0, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_0, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_1, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_1, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_2, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_2, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_3, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_3, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_4, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_4, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_5, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_5, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_6, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_6, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_7, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_7, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_8, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_8, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_9, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_9, na.rm=TRUE)

summary(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_10, na.rm=TRUE)
sd(hospital_admissions_by_year_per_person_year_individually_corpus_callosotomy$hospital_admissions_per_person_year_surgery_10, na.rm=TRUE)
```




Length of stay in hospital admissions for corpus callosotomy
```{r}
# Length of hospital stay in patients with corpus callosotomy
LOS_corpus_callosotomy <- utilization_corpus_callosotomy %>% 
  filter(setting=="inpatient") %>% 
  ungroup() %>% 
  summarize(total_LOS = sum(LOS))
LOS_corpus_callosotomy




# Length of hospital stay per patient before and after surgery
utilization_corpus_callosotomy_LOS <- utilization_corpus_callosotomy %>% 
  filter(setting=="inpatient") %>% 
  select(ENROLID, SVCDATE, LOS) %>% 
  rename(hospital_admission_date = SVCDATE)

LOS_by_year_per_patient_corpus_callosotomy_1_5 <- 
  corpus_callosotomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_corpus_callosotomy_LOS, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date, LOS) %>%
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    LOS_surgery_minus_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(9)))), LOS, 0), na.rm=TRUE)/5,
    LOS_surgery_0_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_1_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(63)))), LOS, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
LOS_by_year_per_patient_corpus_callosotomy_1_5  
   

# Length of stay per person-year by year before and after surgery
LOS_by_year_per_person_year_individually_corpus_callosotomy_1_5 <- 
  person_years_by_year_corpus_callosotomy_one_surgery_1_5 %>% 
  left_join(LOS_by_year_per_patient_corpus_callosotomy_1_5, by="ENROLID") %>% 
  mutate(
    LOS_per_person_year_surgery_minus_1_5 = LOS_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    LOS_per_person_year_surgery_0_1_5 = LOS_surgery_0_1_5 / person_years_surgery_0_1_5,
    LOS_per_person_year_surgery_1_5 = LOS_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy_1_5$LOS_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy_1_5$LOS_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy_1_5$LOS_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy_1_5$LOS_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy_1_5$LOS_per_person_year_surgery_1_5, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy_1_5$LOS_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_LOS_per_person_year_corpus_callosotomy_1_5 <- wilcox.test(LOS_by_year_per_person_year_individually_corpus_callosotomy_1_5$LOS_per_person_year_surgery_minus_1_5, LOS_by_year_per_person_year_individually_corpus_callosotomy_1_5$LOS_per_person_year_surgery_1_5)
Wilcoxon_test_LOS_per_person_year_corpus_callosotomy_1_5




# LOS per patient by year in relationship to surgery
utilization_corpus_callosotomy_LOS <- utilization_corpus_callosotomy %>% 
  filter(setting=="inpatient") %>% 
  select(ENROLID, SVCDATE, LOS) %>% 
  rename(hospital_admission_date = SVCDATE)

LOS_by_year_per_patient_corpus_callosotomy <- 
  corpus_callosotomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_corpus_callosotomy_LOS, by="ENROLID") %>%
  select(ENROLID, hospital_admission_date, surgery_date, LOS) %>%
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    LOS_surgery_minus_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(129))) & (hospital_admission_date < (surgery_date - months(117)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(117))) & (hospital_admission_date < (surgery_date - months(105)))), LOS, 0), na.rm=TRUE), 
    LOS_surgery_minus_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(105))) & (hospital_admission_date < (surgery_date - months(93)))), LOS, 0), na.rm=TRUE),  
    LOS_surgery_minus_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(93))) & (hospital_admission_date < (surgery_date - months(81)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(81))) & (hospital_admission_date < (surgery_date - months(69)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(69))) & (hospital_admission_date < (surgery_date - months(57)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_minus_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(57))) & (hospital_admission_date < (surgery_date - months(45)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(45))) & (hospital_admission_date < (surgery_date - months(33)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(33))) & (hospital_admission_date < (surgery_date - months(21)))), LOS, 0), na.rm=TRUE),     LOS_surgery_minus_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(21))) & (hospital_admission_date < (surgery_date - months(9)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_0 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date - months(9))) & (hospital_admission_date < (surgery_date + months(3)))), LOS, 0), na.rm=TRUE),      LOS_surgery_1 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(3))) & (hospital_admission_date < (surgery_date + months(15)))), LOS, 0), na.rm=TRUE),     LOS_surgery_2 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(15))) & (hospital_admission_date < (surgery_date + months(27)))), LOS, 0), na.rm=TRUE),     LOS_surgery_3 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(27))) & (hospital_admission_date < (surgery_date + months(39)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_4 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(39))) & (hospital_admission_date < (surgery_date + months(51)))), LOS, 0), na.rm=TRUE),     LOS_surgery_5 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(51))) & (hospital_admission_date < (surgery_date + months(63)))), LOS, 0), na.rm=TRUE),
    LOS_surgery_6 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(63))) & (hospital_admission_date < (surgery_date + months(75)))), LOS, 0), na.rm=TRUE),     LOS_surgery_7 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(75))) & (hospital_admission_date < (surgery_date + months(87)))), LOS, 0), na.rm=TRUE),     LOS_surgery_8 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(87))) & (hospital_admission_date < (surgery_date + months(99)))), LOS, 0), na.rm=TRUE),     LOS_surgery_9 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(99))) & (hospital_admission_date < (surgery_date + months(111)))), LOS, 0), na.rm=TRUE), 
    LOS_surgery_10 = 
      sumNA(ifelse(((hospital_admission_date >= (surgery_date + months(111))) & (hospital_admission_date < (surgery_date + months(123)))), LOS, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
LOS_by_year_per_patient_corpus_callosotomy  
   

# Length of stay per person-year by year
LOS_by_year_per_person_year_individually_corpus_callosotomy <- 
  person_years_by_year_corpus_callosotomy_one_surgery %>% 
  left_join(LOS_by_year_per_patient_corpus_callosotomy, by="ENROLID") %>% 
  mutate(
    LOS_per_person_year_surgery_minus_10 = LOS_surgery_minus_10 / person_years_surgery_minus_10,
    LOS_per_person_year_surgery_minus_9 = LOS_surgery_minus_9 / person_years_surgery_minus_9,
    LOS_per_person_year_surgery_minus_8 = LOS_surgery_minus_8 / person_years_surgery_minus_8,
    LOS_per_person_year_surgery_minus_7 = LOS_surgery_minus_7 / person_years_surgery_minus_7,
    LOS_per_person_year_surgery_minus_6 = LOS_surgery_minus_6 / person_years_surgery_minus_6,
    LOS_per_person_year_surgery_minus_5 = LOS_surgery_minus_5 / person_years_surgery_minus_5,
    LOS_per_person_year_surgery_minus_4 = LOS_surgery_minus_4 / person_years_surgery_minus_4,
    LOS_per_person_year_surgery_minus_3 = LOS_surgery_minus_3 / person_years_surgery_minus_3,
    LOS_per_person_year_surgery_minus_2 = LOS_surgery_minus_2 / person_years_surgery_minus_2,
    LOS_per_person_year_surgery_minus_1 = LOS_surgery_minus_1 / person_years_surgery_minus_1,
    LOS_per_person_year_surgery_0 = LOS_surgery_0 / person_years_surgery_0,
    LOS_per_person_year_surgery_1 = LOS_surgery_1 / person_years_surgery_1,
    LOS_per_person_year_surgery_2 = LOS_surgery_2 / person_years_surgery_2,
    LOS_per_person_year_surgery_3 = LOS_surgery_3 / person_years_surgery_3,
    LOS_per_person_year_surgery_4 = LOS_surgery_4 / person_years_surgery_4,
    LOS_per_person_year_surgery_5 = LOS_surgery_5 / person_years_surgery_5,
    LOS_per_person_year_surgery_6 = LOS_surgery_6 / person_years_surgery_6,
    LOS_per_person_year_surgery_7 = LOS_surgery_7 / person_years_surgery_7,
    LOS_per_person_year_surgery_8 = LOS_surgery_8 / person_years_surgery_8,
    LOS_per_person_year_surgery_9 = LOS_surgery_9 / person_years_surgery_9,
    LOS_per_person_year_surgery_10 = LOS_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_0, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_0, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_1, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_1, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_2, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_2, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_3, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_3, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_4, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_4, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_5, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_5, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_6, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_6, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_7, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_7, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_8, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_8, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_9, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_9, na.rm=TRUE)

summary(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_10, na.rm=TRUE)
sd(LOS_by_year_per_person_year_individually_corpus_callosotomy$LOS_per_person_year_surgery_10, na.rm=TRUE)
```




Cost adjustment for inflation
```{r}
# Inflation calculations (https://apps.bea.gov/iTable/iTable.cfm?reqid=19&step=2#reqid=19&step=2&isuri=1&1921=survey last accessed 12/30/2021)
# https://meps.ahrq.gov/about_meps/Price_Index.shtml
inflation_2006_Q1 <- 0.89204
inflation_2006_Q2 <- 0.89993	
inflation_2006_Q3 <- 0.90652	
inflation_2006_Q4 <- 0.90997	
inflation_2007_Q1 <- 0.91908
inflation_2007_Q2 <- 0.92491	
inflation_2007_Q3 <- 0.92882	
inflation_2007_Q4 <- 0.93332	
inflation_2008_Q1 <- 0.93735
inflation_2008_Q2 <- 0.94075	
inflation_2008_Q3 <- 0.94804	
inflation_2008_Q4 <- 0.94975
inflation_2009_Q1 <- 0.95001
inflation_2009_Q2 <- 0.94870	
inflation_2009_Q3 <- 0.94928	
inflation_2009_Q4 <- 0.95277			
inflation_2010_Q1 <- 0.95518
inflation_2010_Q2 <- 0.95963	
inflation_2010_Q3 <- 0.96312	
inflation_2010_Q4 <- 0.96864				
inflation_2011_Q1 <- 0.97339
inflation_2011_Q2 <- 0.98042	
inflation_2011_Q3 <- 0.98561	
inflation_2011_Q4 <- 0.98687		
inflation_2012_Q1 <- 0.99277
inflation_2012_Q2 <- 0.99690	
inflation_2012_Q3 <- 1.00304
inflation_2012_Q4 <- 1.00730			
inflation_2013_Q1 <- 1.01124
inflation_2013_Q2 <- 1.01428	
inflation_2013_Q3 <- 1.01973
inflation_2013_Q4 <- 1.02550				
inflation_2014_Q1 <- 1.02965
inflation_2014_Q2 <- 1.03552	
inflation_2014_Q3 <- 1.04029
inflation_2014_Q4 <- 1.04104		
inflation_2015_Q1 <- 1.04092
inflation_2015_Q2 <- 1.04683	
inflation_2015_Q3 <- 1.04939
inflation_2015_Q4 <- 1.04932
inflation_2016_Q1 <- 1.04873
inflation_2016_Q2 <- 1.05576	
inflation_2016_Q3 <- 1.05894
inflation_2016_Q4 <- 1.06470				
inflation_2017_Q1 <- 1.07007
inflation_2017_Q2 <- 1.07361		
inflation_2017_Q3 <- 1.07942
inflation_2017_Q4 <- 1.08658						
inflation_2018_Q1 <- 1.09312
inflation_2018_Q2 <- 1.10156		
inflation_2018_Q3 <- 1.10647
inflation_2018_Q4 <- 1.11191		
inflation_2019_Q1 <- 1.11502
inflation_2019_Q2 <- 1.12142		
inflation_2019_Q3 <- 1.12524
inflation_2019_Q4 <- 1.12947			
inflation_2020_Q1 <- 1.13397
inflation_2020_Q2 <- 1.12969		
inflation_2020_Q3 <- 1.13984
inflation_2020_Q4 <- 1.14611					
				
			
# Cost adjusted for inflation (to Q4 2020 year)
inflation_adjusted_utilization_corpus_callosotomy <- utilization_corpus_callosotomy %>% 
  mutate(year_quarter = quarter(SVCDATE, with_year=TRUE)) %>%
  mutate(inflation_adjusted_cost = case_when(
  year_quarter == 2006.1 ~ cost*(inflation_2020_Q4/inflation_2006_Q1), 
  year_quarter == 2006.2 ~ cost*(inflation_2020_Q4/inflation_2006_Q2),
  year_quarter == 2006.3 ~ cost*(inflation_2020_Q4/inflation_2006_Q3),
  year_quarter == 2006.4 ~ cost*(inflation_2020_Q4/inflation_2006_Q4),  
  year_quarter == 2007.1 ~ cost*(inflation_2020_Q4/inflation_2007_Q1), 
  year_quarter == 2007.2 ~ cost*(inflation_2020_Q4/inflation_2007_Q2),
  year_quarter == 2007.3 ~ cost*(inflation_2020_Q4/inflation_2007_Q3),
  year_quarter == 2007.4 ~ cost*(inflation_2020_Q4/inflation_2007_Q4),  
  year_quarter == 2008.1 ~ cost*(inflation_2020_Q4/inflation_2008_Q1), 
  year_quarter == 2008.2 ~ cost*(inflation_2020_Q4/inflation_2008_Q2),
  year_quarter == 2008.3 ~ cost*(inflation_2020_Q4/inflation_2008_Q3),
  year_quarter == 2008.4 ~ cost*(inflation_2020_Q4/inflation_2008_Q4), 
  year_quarter == 2009.1 ~ cost*(inflation_2020_Q4/inflation_2009_Q1), 
  year_quarter == 2009.2 ~ cost*(inflation_2020_Q4/inflation_2009_Q2),
  year_quarter == 2009.3 ~ cost*(inflation_2020_Q4/inflation_2009_Q3),
  year_quarter == 2009.4 ~ cost*(inflation_2020_Q4/inflation_2009_Q4), 
  year_quarter == 2010.1 ~ cost*(inflation_2020_Q4/inflation_2010_Q1), 
  year_quarter == 2010.2 ~ cost*(inflation_2020_Q4/inflation_2010_Q2),
  year_quarter == 2010.3 ~ cost*(inflation_2020_Q4/inflation_2010_Q3),
  year_quarter == 2010.4 ~ cost*(inflation_2020_Q4/inflation_2010_Q4), 
  year_quarter == 2011.1 ~ cost*(inflation_2020_Q4/inflation_2011_Q1), 
  year_quarter == 2011.2 ~ cost*(inflation_2020_Q4/inflation_2011_Q2),
  year_quarter == 2011.3 ~ cost*(inflation_2020_Q4/inflation_2011_Q3),
  year_quarter == 2011.4 ~ cost*(inflation_2020_Q4/inflation_2011_Q4), 
  year_quarter == 2012.1 ~ cost*(inflation_2020_Q4/inflation_2012_Q1), 
  year_quarter == 2012.2 ~ cost*(inflation_2020_Q4/inflation_2012_Q2),
  year_quarter == 2012.3 ~ cost*(inflation_2020_Q4/inflation_2012_Q3),
  year_quarter == 2012.4 ~ cost*(inflation_2020_Q4/inflation_2012_Q4), 
  year_quarter == 2013.1 ~ cost*(inflation_2020_Q4/inflation_2013_Q1), 
  year_quarter == 2013.2 ~ cost*(inflation_2020_Q4/inflation_2013_Q2),
  year_quarter == 2013.3 ~ cost*(inflation_2020_Q4/inflation_2013_Q3),
  year_quarter == 2013.4 ~ cost*(inflation_2020_Q4/inflation_2013_Q4), 
  year_quarter == 2014.1 ~ cost*(inflation_2020_Q4/inflation_2014_Q1), 
  year_quarter == 2014.2 ~ cost*(inflation_2020_Q4/inflation_2014_Q2),
  year_quarter == 2014.3 ~ cost*(inflation_2020_Q4/inflation_2014_Q3),
  year_quarter == 2014.4 ~ cost*(inflation_2020_Q4/inflation_2014_Q4),  
  year_quarter == 2015.1 ~ cost*(inflation_2020_Q4/inflation_2015_Q1), 
  year_quarter == 2015.2 ~ cost*(inflation_2020_Q4/inflation_2015_Q2),
  year_quarter == 2015.3 ~ cost*(inflation_2020_Q4/inflation_2015_Q3),
  year_quarter == 2015.4 ~ cost*(inflation_2020_Q4/inflation_2015_Q4),  
  year_quarter == 2016.1 ~ cost*(inflation_2020_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ cost*(inflation_2020_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ cost*(inflation_2020_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ cost*(inflation_2020_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ cost*(inflation_2020_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ cost*(inflation_2020_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ cost*(inflation_2020_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ cost*(inflation_2020_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ cost*(inflation_2020_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ cost*(inflation_2020_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ cost*(inflation_2020_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ cost*(inflation_2020_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ cost*(inflation_2020_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ cost*(inflation_2020_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ cost*(inflation_2020_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ cost*(inflation_2020_Q4/inflation_2019_Q4))) %>% 
    collect()
```




Cost in patients with corpus callosotomy
```{r}
# Cost in patients with corpus callosotomy
cost_corpus_callosotomy <- 
  inflation_adjusted_utilization_corpus_callosotomy %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
cost_corpus_callosotomy




# Cost per patient before and after surgery
utilization_corpus_callosotomy_total_cost <- inflation_adjusted_utilization_corpus_callosotomy %>%
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


total_cost_by_year_per_patient_corpus_callosotomy_1_5 <- 
  corpus_callosotomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_corpus_callosotomy_total_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    total_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    total_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
total_cost_by_year_per_patient_corpus_callosotomy_1_5
   

# Total cost per person-year by year before and after surgery
total_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5 <- 
  person_years_by_year_corpus_callosotomy_one_surgery_1_5 %>% 
  left_join(total_cost_by_year_per_patient_corpus_callosotomy_1_5, by="ENROLID") %>% 
  mutate(
    total_cost_per_person_year_surgery_minus_1_5 = total_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    total_cost_per_person_year_surgery_0_1_5 = total_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    total_cost_per_person_year_surgery_1_5 = total_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$total_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$total_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$total_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$total_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$total_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$total_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_cost_per_person_year_corpus_callosotomy_1_5 <- wilcox.test(total_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$total_cost_per_person_year_surgery_minus_1_5, total_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$total_cost_per_person_year_surgery_1_5)
Wilcoxon_test_cost_per_person_year_corpus_callosotomy_1_5




# Total cost per patient by year in relationship to surgery
utilization_corpus_callosotomy_total_cost <- inflation_adjusted_utilization_corpus_callosotomy %>%
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


total_cost_by_year_per_patient_corpus_callosotomy <- 
  corpus_callosotomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_corpus_callosotomy_total_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    total_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    total_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    total_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      total_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    total_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     total_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    total_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
total_cost_by_year_per_patient_corpus_callosotomy  
   

# Total cost per person-year by year
total_cost_by_year_per_person_year_individually_corpus_callosotomy <- 
  person_years_by_year_corpus_callosotomy_one_surgery %>% 
  left_join(total_cost_by_year_per_patient_corpus_callosotomy, by="ENROLID") %>% 
  mutate(
    total_cost_per_person_year_surgery_minus_10 = total_cost_surgery_minus_10 / person_years_surgery_minus_10,
    total_cost_per_person_year_surgery_minus_9 = total_cost_surgery_minus_9 / person_years_surgery_minus_9,
    total_cost_per_person_year_surgery_minus_8 = total_cost_surgery_minus_8 / person_years_surgery_minus_8,
    total_cost_per_person_year_surgery_minus_7 = total_cost_surgery_minus_7 / person_years_surgery_minus_7,
    total_cost_per_person_year_surgery_minus_6 = total_cost_surgery_minus_6 / person_years_surgery_minus_6,
    total_cost_per_person_year_surgery_minus_5 = total_cost_surgery_minus_5 / person_years_surgery_minus_5,
    total_cost_per_person_year_surgery_minus_4 = total_cost_surgery_minus_4 / person_years_surgery_minus_4,
    total_cost_per_person_year_surgery_minus_3 = total_cost_surgery_minus_3 / person_years_surgery_minus_3,
    total_cost_per_person_year_surgery_minus_2 = total_cost_surgery_minus_2 / person_years_surgery_minus_2,
    total_cost_per_person_year_surgery_minus_1 = total_cost_surgery_minus_1 / person_years_surgery_minus_1,
    total_cost_per_person_year_surgery_0 = total_cost_surgery_0 / person_years_surgery_0,
    total_cost_per_person_year_surgery_1 = total_cost_surgery_1 / person_years_surgery_1,
    total_cost_per_person_year_surgery_2 = total_cost_surgery_2 / person_years_surgery_2,
    total_cost_per_person_year_surgery_3 = total_cost_surgery_3 / person_years_surgery_3,
    total_cost_per_person_year_surgery_4 = total_cost_surgery_4 / person_years_surgery_4,
    total_cost_per_person_year_surgery_5 = total_cost_surgery_5 / person_years_surgery_5,
    total_cost_per_person_year_surgery_6 = total_cost_surgery_6 / person_years_surgery_6,
    total_cost_per_person_year_surgery_7 = total_cost_surgery_7 / person_years_surgery_7,
    total_cost_per_person_year_surgery_8 = total_cost_surgery_8 / person_years_surgery_8,
    total_cost_per_person_year_surgery_9 = total_cost_surgery_9 / person_years_surgery_9,
    total_cost_per_person_year_surgery_10 = total_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Total cost figure in patients with corpus callosotomy
```{r}
# Total cost figure
data_figure_total_cost_by_year_per_person_year_individually_corpus_callosotomy <- tibble(
  "year" = factor(c("Year -5", "Year -4", "Year -3", "Year -2", "Year -1", "Year surgery", "Year +1", "Year +2", "Year +3", "Year +4", "Year +5"), levels=c("Year -5", "Year -4", "Year -3", "Year -2", "Year -1", "Year surgery", "Year +1", "Year +2", "Year +3", "Year +4", "Year +5")),
  "median_cost" = c(summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_0, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_1, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_2, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_3, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_4, na.rm=TRUE)[3],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_5, na.rm=TRUE)[3]),
  "p25_cost" = c(summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_0, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_1, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_2, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_3, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_4, na.rm=TRUE)[2],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_5, na.rm=TRUE)[2]),  
  "p75_cost" = c(summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_5, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_4, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_3, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_2, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_minus_1, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_0, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_1, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_2, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_3, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_4, na.rm=TRUE)[5],
                  summary(total_cost_by_year_per_person_year_individually_corpus_callosotomy$total_cost_per_person_year_surgery_5, na.rm=TRUE)[5])    
  )


figure_total_cost_by_year_per_person_year_individually_corpus_callosotomy <- ggplot(data=data_figure_total_cost_by_year_per_person_year_individually_corpus_callosotomy) + 
  geom_point(aes(x=year, y=median_cost), color="purple2", size=5) +
  geom_point(aes(x=year, y=p25_cost), color="darkgreen", size=4) +
  geom_point(aes(x=year, y=p75_cost), color="darkgreen", size=4) +
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(),        panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=45, hjust=1),
        axis.title=element_text(size=22, face="bold")) +
  scale_x_discrete(name="Year") +
  scale_y_continuous(name="Cost ($) per person-year", breaks=seq(0, 300000, 50000), limits = c(0, 300000))
figure_total_cost_by_year_per_person_year_individually_corpus_callosotomy
ggplotly(figure_total_cost_by_year_per_person_year_individually_corpus_callosotomy)
```




Outpatient cost in patients with corpus callosotomy
```{r}
# Outpatient cost in patients with corpus callosotomy
outpatient_cost_corpus_callosotomy <- 
  inflation_adjusted_utilization_corpus_callosotomy %>% 
  filter(setting=="outpatient") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
outpatient_cost_corpus_callosotomy




# Outpatient cost per patient before and after surgery
utilization_corpus_callosotomy_outpatient_cost <- inflation_adjusted_utilization_corpus_callosotomy %>%
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


outpatient_cost_by_year_per_patient_corpus_callosotomy_1_5 <- 
  corpus_callosotomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_corpus_callosotomy_outpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    outpatient_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_cost_by_year_per_patient_corpus_callosotomy_1_5
   

# Outpatient cost per person-year by year before and after surgery
outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5 <- 
  person_years_by_year_corpus_callosotomy_one_surgery_1_5 %>% 
  left_join(outpatient_cost_by_year_per_patient_corpus_callosotomy_1_5, by="ENROLID") %>% 
  mutate(
    outpatient_cost_per_person_year_surgery_minus_1_5 = outpatient_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    outpatient_cost_per_person_year_surgery_0_1_5 = outpatient_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    outpatient_cost_per_person_year_surgery_1_5 = outpatient_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$outpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$outpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$outpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$outpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_outpatient_cost_per_person_year_corpus_callosotomy_1_5 <- wilcox.test(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$outpatient_cost_per_person_year_surgery_minus_1_5, outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$outpatient_cost_per_person_year_surgery_1_5)
Wilcoxon_test_outpatient_cost_per_person_year_corpus_callosotomy_1_5




# Outpatient cost per patient by year in relationship to surgery
utilization_corpus_callosotomy_outpatient_cost <- inflation_adjusted_utilization_corpus_callosotomy %>%
  filter(setting=="outpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


outpatient_cost_by_year_per_patient_corpus_callosotomy <- 
  corpus_callosotomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_corpus_callosotomy_outpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    outpatient_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    outpatient_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    outpatient_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      outpatient_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    outpatient_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     outpatient_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    outpatient_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
outpatient_cost_by_year_per_patient_corpus_callosotomy  
   

# Outpatient cost per person-year by year
outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy <- 
  person_years_by_year_corpus_callosotomy_one_surgery %>% 
  left_join(outpatient_cost_by_year_per_patient_corpus_callosotomy, by="ENROLID") %>% 
  mutate(
    outpatient_cost_per_person_year_surgery_minus_10 = outpatient_cost_surgery_minus_10 / person_years_surgery_minus_10,
    outpatient_cost_per_person_year_surgery_minus_9 = outpatient_cost_surgery_minus_9 / person_years_surgery_minus_9,
    outpatient_cost_per_person_year_surgery_minus_8 = outpatient_cost_surgery_minus_8 / person_years_surgery_minus_8,
    outpatient_cost_per_person_year_surgery_minus_7 = outpatient_cost_surgery_minus_7 / person_years_surgery_minus_7,
    outpatient_cost_per_person_year_surgery_minus_6 = outpatient_cost_surgery_minus_6 / person_years_surgery_minus_6,
    outpatient_cost_per_person_year_surgery_minus_5 = outpatient_cost_surgery_minus_5 / person_years_surgery_minus_5,
    outpatient_cost_per_person_year_surgery_minus_4 = outpatient_cost_surgery_minus_4 / person_years_surgery_minus_4,
    outpatient_cost_per_person_year_surgery_minus_3 = outpatient_cost_surgery_minus_3 / person_years_surgery_minus_3,
    outpatient_cost_per_person_year_surgery_minus_2 = outpatient_cost_surgery_minus_2 / person_years_surgery_minus_2,
    outpatient_cost_per_person_year_surgery_minus_1 = outpatient_cost_surgery_minus_1 / person_years_surgery_minus_1,
    outpatient_cost_per_person_year_surgery_0 = outpatient_cost_surgery_0 / person_years_surgery_0,
    outpatient_cost_per_person_year_surgery_1 = outpatient_cost_surgery_1 / person_years_surgery_1,
    outpatient_cost_per_person_year_surgery_2 = outpatient_cost_surgery_2 / person_years_surgery_2,
    outpatient_cost_per_person_year_surgery_3 = outpatient_cost_surgery_3 / person_years_surgery_3,
    outpatient_cost_per_person_year_surgery_4 = outpatient_cost_surgery_4 / person_years_surgery_4,
    outpatient_cost_per_person_year_surgery_5 = outpatient_cost_surgery_5 / person_years_surgery_5,
    outpatient_cost_per_person_year_surgery_6 = outpatient_cost_surgery_6 / person_years_surgery_6,
    outpatient_cost_per_person_year_surgery_7 = outpatient_cost_surgery_7 / person_years_surgery_7,
    outpatient_cost_per_person_year_surgery_8 = outpatient_cost_surgery_8 / person_years_surgery_8,
    outpatient_cost_per_person_year_surgery_9 = outpatient_cost_surgery_9 / person_years_surgery_9,
    outpatient_cost_per_person_year_surgery_10 = outpatient_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(outpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$outpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
```




ED cost in patients with corpus callosotomy
```{r}
# ED cost in patients with corpus callosotomy
ED_cost_corpus_callosotomy <- 
  inflation_adjusted_utilization_corpus_callosotomy %>% 
  filter(setting=="emergency") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
ED_cost_corpus_callosotomy




# ED cost per patient before and after surgery
utilization_corpus_callosotomy_ED_cost <- inflation_adjusted_utilization_corpus_callosotomy %>%
  filter(setting=="emergency") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


ED_cost_by_year_per_patient_corpus_callosotomy_1_5 <- 
  corpus_callosotomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_corpus_callosotomy_ED_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    ED_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_cost_by_year_per_patient_corpus_callosotomy_1_5
   

# ED cost per person-year by year before and after surgery
ED_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5 <- 
  person_years_by_year_corpus_callosotomy_one_surgery_1_5 %>% 
  left_join(ED_cost_by_year_per_patient_corpus_callosotomy_1_5, by="ENROLID") %>% 
  mutate(
    ED_cost_per_person_year_surgery_minus_1_5 = ED_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    ED_cost_per_person_year_surgery_0_1_5 = ED_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    ED_cost_per_person_year_surgery_1_5 = ED_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$ED_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$ED_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$ED_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$ED_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$ED_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$ED_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_ED_cost_per_person_year_corpus_callosotomy_1_5 <- wilcox.test(ED_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$ED_cost_per_person_year_surgery_minus_1_5, ED_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$ED_cost_per_person_year_surgery_1_5)
Wilcoxon_test_ED_cost_per_person_year_corpus_callosotomy_1_5




# ED cost per patient by year in relationship to surgery
utilization_corpus_callosotomy_ED_cost <- inflation_adjusted_utilization_corpus_callosotomy %>%
  filter(setting=="emergency") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


ED_cost_by_year_per_patient_corpus_callosotomy <- 
  corpus_callosotomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_corpus_callosotomy_ED_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    ED_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    ED_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    ED_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      ED_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    ED_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     ED_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    ED_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
ED_cost_by_year_per_patient_corpus_callosotomy  
   

# ED cost per person-year by year
ED_cost_by_year_per_person_year_individually_corpus_callosotomy <- 
  person_years_by_year_corpus_callosotomy_one_surgery %>% 
  left_join(ED_cost_by_year_per_patient_corpus_callosotomy, by="ENROLID") %>% 
  mutate(
    ED_cost_per_person_year_surgery_minus_10 = ED_cost_surgery_minus_10 / person_years_surgery_minus_10,
    ED_cost_per_person_year_surgery_minus_9 = ED_cost_surgery_minus_9 / person_years_surgery_minus_9,
    ED_cost_per_person_year_surgery_minus_8 = ED_cost_surgery_minus_8 / person_years_surgery_minus_8,
    ED_cost_per_person_year_surgery_minus_7 = ED_cost_surgery_minus_7 / person_years_surgery_minus_7,
    ED_cost_per_person_year_surgery_minus_6 = ED_cost_surgery_minus_6 / person_years_surgery_minus_6,
    ED_cost_per_person_year_surgery_minus_5 = ED_cost_surgery_minus_5 / person_years_surgery_minus_5,
    ED_cost_per_person_year_surgery_minus_4 = ED_cost_surgery_minus_4 / person_years_surgery_minus_4,
    ED_cost_per_person_year_surgery_minus_3 = ED_cost_surgery_minus_3 / person_years_surgery_minus_3,
    ED_cost_per_person_year_surgery_minus_2 = ED_cost_surgery_minus_2 / person_years_surgery_minus_2,
    ED_cost_per_person_year_surgery_minus_1 = ED_cost_surgery_minus_1 / person_years_surgery_minus_1,
    ED_cost_per_person_year_surgery_0 = ED_cost_surgery_0 / person_years_surgery_0,
    ED_cost_per_person_year_surgery_1 = ED_cost_surgery_1 / person_years_surgery_1,
    ED_cost_per_person_year_surgery_2 = ED_cost_surgery_2 / person_years_surgery_2,
    ED_cost_per_person_year_surgery_3 = ED_cost_surgery_3 / person_years_surgery_3,
    ED_cost_per_person_year_surgery_4 = ED_cost_surgery_4 / person_years_surgery_4,
    ED_cost_per_person_year_surgery_5 = ED_cost_surgery_5 / person_years_surgery_5,
    ED_cost_per_person_year_surgery_6 = ED_cost_surgery_6 / person_years_surgery_6,
    ED_cost_per_person_year_surgery_7 = ED_cost_surgery_7 / person_years_surgery_7,
    ED_cost_per_person_year_surgery_8 = ED_cost_surgery_8 / person_years_surgery_8,
    ED_cost_per_person_year_surgery_9 = ED_cost_surgery_9 / person_years_surgery_9,
    ED_cost_per_person_year_surgery_10 = ED_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(ED_cost_by_year_per_person_year_individually_corpus_callosotomy$ED_cost_per_person_year_surgery_10, na.rm=TRUE)
```




Inpatient cost in patients with corpus callosotomy
```{r}
# Inpatient cost in patients with corpus callosotomy
inpatient_cost_corpus_callosotomy <- 
  inflation_adjusted_utilization_corpus_callosotomy %>% 
  filter(setting=="inpatient") %>% 
  ungroup() %>% 
  summarize(total_cost = sum(inflation_adjusted_cost))
inpatient_cost_corpus_callosotomy




# Inpatient cost per patient before and after surgery
utilization_corpus_callosotomy_inpatient_cost <- inflation_adjusted_utilization_corpus_callosotomy %>%
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


inpatient_cost_by_year_per_patient_corpus_callosotomy_1_5 <- 
  corpus_callosotomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_corpus_callosotomy_inpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    inpatient_cost_surgery_minus_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5,
    inpatient_cost_surgery_0_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_1_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE)/5
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
inpatient_cost_by_year_per_patient_corpus_callosotomy_1_5
   

# Inpatient cost per person-year by year before and after surgery
inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5 <- 
  person_years_by_year_corpus_callosotomy_one_surgery_1_5 %>% 
  left_join(inpatient_cost_by_year_per_patient_corpus_callosotomy_1_5, by="ENROLID") %>% 
  mutate(
    inpatient_cost_per_person_year_surgery_minus_1_5 = inpatient_cost_surgery_minus_1_5 / person_years_surgery_minus_1_5,
    inpatient_cost_per_person_year_surgery_0_1_5 = inpatient_cost_surgery_0_1_5 / person_years_surgery_0_1_5,
    inpatient_cost_per_person_year_surgery_1_5 = inpatient_cost_surgery_1_5 / person_years_surgery_1_5
         ) %>% 
  collect()
  

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$inpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$inpatient_cost_per_person_year_surgery_0_1_5, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$inpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$inpatient_cost_per_person_year_surgery_1_5, na.rm=TRUE)




# Statistical test
Wilcoxon_test_inpatient_cost_per_person_year_corpus_callosotomy_1_5 <- wilcox.test(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$inpatient_cost_per_person_year_surgery_minus_1_5, inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy_1_5$inpatient_cost_per_person_year_surgery_1_5)
Wilcoxon_test_inpatient_cost_per_person_year_corpus_callosotomy_1_5




# Inpatient cost per patient by year in relationship to surgery
utilization_corpus_callosotomy_inpatient_cost <- inflation_adjusted_utilization_corpus_callosotomy %>%
  filter(setting=="inpatient") %>% 
  distinct(ENROLID, setting, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, inflation_adjusted_cost) %>% 
  rename(service_date = SVCDATE) 


inpatient_cost_by_year_per_patient_corpus_callosotomy <- 
  corpus_callosotomy_one_surgery %>% 
  rename(surgery_date = SVCDATE) %>% 
  left_join(utilization_corpus_callosotomy_inpatient_cost, by="ENROLID") %>%
  select(ENROLID, service_date, surgery_date, inflation_adjusted_cost) %>% 
  arrange(ENROLID) %>% 
  group_by(ENROLID) %>% 
  mutate(
    inpatient_cost_surgery_minus_10 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(129))) & (service_date < (surgery_date - months(117)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_9 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(117))) & (service_date < (surgery_date - months(105)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    inpatient_cost_surgery_minus_8 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(105))) & (service_date < (surgery_date - months(93)))), inflation_adjusted_cost, 0), na.rm=TRUE),  
    inpatient_cost_surgery_minus_7 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(93))) & (service_date < (surgery_date - months(81)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_6 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(81))) & (service_date < (surgery_date - months(69)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_5 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(69))) & (service_date < (surgery_date - months(57)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_minus_4 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(57))) & (service_date < (surgery_date - months(45)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_3 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(45))) & (service_date < (surgery_date - months(33)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_2 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(33))) & (service_date < (surgery_date - months(21)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_minus_1 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(21))) & (service_date < (surgery_date - months(9)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_0 = 
      sumNA(ifelse(((service_date >= (surgery_date - months(9))) & (service_date < (surgery_date + months(3)))), inflation_adjusted_cost, 0), na.rm=TRUE),      inpatient_cost_surgery_1 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(3))) & (service_date < (surgery_date + months(15)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_2 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(15))) & (service_date < (surgery_date + months(27)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_3 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(27))) & (service_date < (surgery_date + months(39)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_4 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(39))) & (service_date < (surgery_date + months(51)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_5 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(51))) & (service_date < (surgery_date + months(63)))), inflation_adjusted_cost, 0), na.rm=TRUE),
    inpatient_cost_surgery_6 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(63))) & (service_date < (surgery_date + months(75)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_7 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(75))) & (service_date < (surgery_date + months(87)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_8 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(87))) & (service_date < (surgery_date + months(99)))), inflation_adjusted_cost, 0), na.rm=TRUE),     inpatient_cost_surgery_9 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(99))) & (service_date < (surgery_date + months(111)))), inflation_adjusted_cost, 0), na.rm=TRUE), 
    inpatient_cost_surgery_10 = 
      sumNA(ifelse(((service_date >= (surgery_date + months(111))) & (service_date < (surgery_date + months(123)))), inflation_adjusted_cost, 0), na.rm=TRUE)
) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() 
inpatient_cost_by_year_per_patient_corpus_callosotomy  
   

# Inpatient cost per person-year by year
inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy <- 
  person_years_by_year_corpus_callosotomy_one_surgery %>% 
  left_join(inpatient_cost_by_year_per_patient_corpus_callosotomy, by="ENROLID") %>% 
  mutate(
    inpatient_cost_per_person_year_surgery_minus_10 = inpatient_cost_surgery_minus_10 / person_years_surgery_minus_10,
    inpatient_cost_per_person_year_surgery_minus_9 = inpatient_cost_surgery_minus_9 / person_years_surgery_minus_9,
    inpatient_cost_per_person_year_surgery_minus_8 = inpatient_cost_surgery_minus_8 / person_years_surgery_minus_8,
    inpatient_cost_per_person_year_surgery_minus_7 = inpatient_cost_surgery_minus_7 / person_years_surgery_minus_7,
    inpatient_cost_per_person_year_surgery_minus_6 = inpatient_cost_surgery_minus_6 / person_years_surgery_minus_6,
    inpatient_cost_per_person_year_surgery_minus_5 = inpatient_cost_surgery_minus_5 / person_years_surgery_minus_5,
    inpatient_cost_per_person_year_surgery_minus_4 = inpatient_cost_surgery_minus_4 / person_years_surgery_minus_4,
    inpatient_cost_per_person_year_surgery_minus_3 = inpatient_cost_surgery_minus_3 / person_years_surgery_minus_3,
    inpatient_cost_per_person_year_surgery_minus_2 = inpatient_cost_surgery_minus_2 / person_years_surgery_minus_2,
    inpatient_cost_per_person_year_surgery_minus_1 = inpatient_cost_surgery_minus_1 / person_years_surgery_minus_1,
    inpatient_cost_per_person_year_surgery_0 = inpatient_cost_surgery_0 / person_years_surgery_0,
    inpatient_cost_per_person_year_surgery_1 = inpatient_cost_surgery_1 / person_years_surgery_1,
    inpatient_cost_per_person_year_surgery_2 = inpatient_cost_surgery_2 / person_years_surgery_2,
    inpatient_cost_per_person_year_surgery_3 = inpatient_cost_surgery_3 / person_years_surgery_3,
    inpatient_cost_per_person_year_surgery_4 = inpatient_cost_surgery_4 / person_years_surgery_4,
    inpatient_cost_per_person_year_surgery_5 = inpatient_cost_surgery_5 / person_years_surgery_5,
    inpatient_cost_per_person_year_surgery_6 = inpatient_cost_surgery_6 / person_years_surgery_6,
    inpatient_cost_per_person_year_surgery_7 = inpatient_cost_surgery_7 / person_years_surgery_7,
    inpatient_cost_per_person_year_surgery_8 = inpatient_cost_surgery_8 / person_years_surgery_8,
    inpatient_cost_per_person_year_surgery_9 = inpatient_cost_surgery_9 / person_years_surgery_9,
    inpatient_cost_per_person_year_surgery_10 = inpatient_cost_surgery_10 / person_years_surgery_10
         ) %>% 
  collect()
  

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_minus_10, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_minus_9, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_minus_8, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_minus_7, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_minus_6, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_minus_5, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_minus_4, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_minus_3, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_minus_2, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_minus_1, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_0, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_0, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_1, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_1, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_2, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_2, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_3, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_3, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_4, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_4, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_5, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_5, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_6, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_6, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_7, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_7, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_8, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_8, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_9, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_9, na.rm=TRUE)

summary(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
sd(inpatient_cost_by_year_per_person_year_individually_corpus_callosotomy$inpatient_cost_per_person_year_surgery_10, na.rm=TRUE)
```








## 11. Adjustment for multiple comparisons




Adjustment for multiple comparison with Benjamini and Hochberg false discovery rate
```{r}
p.adjust(c(Wilcoxon_test_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_ED_visits_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_LOS_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_outpatient_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_ED_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value, 
           Wilcoxon_test_inpatient_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_pediatric_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_pediatric_ED_visits_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_pediatric_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_pediatric_LOS_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_pediatric_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_outpatient_pediatric_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_ED_pediatric_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value, 
           Wilcoxon_test_inpatient_pediatric_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_adult_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_adult_ED_visits_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_adult_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_adult_LOS_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_adult_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_outpatient_adult_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_ED_adult_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value, 
           Wilcoxon_test_inpatient_adult_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_temporal_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_temporal_ED_visits_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_temporal_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_temporal_LOS_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_temporal_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_outpatient_temporal_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_ED_temporal_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value, 
           Wilcoxon_test_inpatient_temporal_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_extratemporal_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_extratemporal_ED_visits_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_extratemporal_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_extratemporal_LOS_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_extratemporal_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_outpatient_extratemporal_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_ED_extratemporal_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value, 
           Wilcoxon_test_inpatient_extratemporal_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_subdural_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_subdural_ED_visits_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_subdural_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_subdural_LOS_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_subdural_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_outpatient_subdural_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_ED_subdural_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value, 
           Wilcoxon_test_inpatient_subdural_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_stereo_EEG_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_stereo_EEG_ED_visits_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_stereo_EEG_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_stereo_EEG_LOS_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_stereo_EEG_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_outpatient_stereo_EEG_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_ED_stereo_EEG_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value, 
           Wilcoxon_test_inpatient_stereo_EEG_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_no_intracranial_outpatient_visits_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_no_intracranial_ED_visits_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_no_intracranial_hospital_admissions_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_no_intracranial_LOS_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_no_intracranial_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_outpatient_no_intracranial_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_ED_no_intracranial_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value, 
           Wilcoxon_test_inpatient_no_intracranial_cost_per_person_year_resective_epilepsy_surgery_1_5$p.value,
           Wilcoxon_test_outpatient_visits_per_person_year_hemispherectomy_1_5$p.value,
           Wilcoxon_test_ED_visits_per_person_year_hemispherectomy_1_5$p.value,
           Wilcoxon_test_hospital_admissions_per_person_year_hemispherectomy_1_5$p.value,
           Wilcoxon_test_LOS_per_person_year_hemispherectomy_1_5$p.value,
           Wilcoxon_test_cost_per_person_year_hemispherectomy_1_5$p.value,
           Wilcoxon_test_outpatient_cost_per_person_year_hemispherectomy_1_5$p.value,
           Wilcoxon_test_ED_cost_per_person_year_hemispherectomy_1_5$p.value, 
           Wilcoxon_test_inpatient_cost_per_person_year_hemispherectomy_1_5$p.value,
           Wilcoxon_test_outpatient_visits_per_person_year_corpus_callosotomy_1_5$p.value,
           Wilcoxon_test_ED_visits_per_person_year_corpus_callosotomy_1_5$p.value,
           Wilcoxon_test_hospital_admissions_per_person_year_corpus_callosotomy_1_5$p.value,
           Wilcoxon_test_LOS_per_person_year_corpus_callosotomy_1_5$p.value,
           Wilcoxon_test_cost_per_person_year_corpus_callosotomy_1_5$p.value,
           Wilcoxon_test_outpatient_cost_per_person_year_corpus_callosotomy_1_5$p.value,
           Wilcoxon_test_ED_cost_per_person_year_corpus_callosotomy_1_5$p.value, 
           Wilcoxon_test_inpatient_cost_per_person_year_corpus_callosotomy_1_5$p.value), "BH")
```








## 12. Disconnect from the database




Disconnect from the database
```{r}
# Disconnect
dbDisconnect(MarketScan)
```

